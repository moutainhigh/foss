/**
 *  initial comments.
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 */
/*******************************************************************************
 * Copyright 2013 TFR TEAM
 *  
 *  Licensed under the DEPPON License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *  
 *     http://www.deppon.com/licenses/LICENSE-2.0
 *  
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *  Contributors:
 *  038300-foss-pengzhen - initial API and implementation
 * 
 *  PROJECT NAME  : tfr-management
 *  
 *  FILE PATH     : src/main/java/com/deppon/foss/module/transfer/management/server/service/impl/FocusSignBillService.java
 *  
 *  FILE NAME          :FocusSignBillService.java
 * 
 *  AUTHOR  : FOSS中转系统开发组
 *  
 *  TIME              : 
 *  
 *  HOME PAGE    :  http://www.deppon.com
 * 
 *  COPYRIGHT    : Copyright (c) 2013  Deppon All Rights Reserved.
 ******************************************************************************/
package com.deppon.foss.module.transfer.management.server.service.impl;

import java.io.InputStream;
import java.math.BigDecimal;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import org.apache.commons.lang.StringUtils;
import org.apache.poi.hssf.usermodel.HSSFCell;
import org.apache.poi.hssf.usermodel.HSSFCellStyle;
import org.apache.poi.hssf.usermodel.HSSFRow;
import org.apache.poi.hssf.usermodel.HSSFSheet;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.ss.util.CellRangeAddress;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.transaction.annotation.Transactional;

import com.deppon.foss.base.util.define.BizTypeConstants;
import com.deppon.foss.framework.server.components.export.excel.ExcelExport;
import com.deppon.foss.module.base.baseinfo.api.server.service.complex.IOrgAdministrativeInfoComplexService;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.OrgAdministrativeInfoEntity;
import com.deppon.foss.module.frameworkimpl.server.context.FossUserContext;
import com.deppon.foss.module.frameworkimpl.shared.domain.CurrentInfo;
import com.deppon.foss.module.pickup.waybill.api.server.service.IWaybillManagerService;
import com.deppon.foss.module.pickup.waybill.shared.domain.WaybillEntity;
import com.deppon.foss.module.transfer.common.api.shared.exception.TfrBusinessException;
import com.deppon.foss.module.transfer.management.api.server.dao.IFocusSignBillDao;
import com.deppon.foss.module.transfer.management.api.server.service.IFocusSignBillService;
import com.deppon.foss.module.transfer.management.api.shared.define.SignBillConstants;
import com.deppon.foss.module.transfer.management.api.shared.domain.FocusSignBillEntity;
import com.deppon.foss.module.transfer.management.api.shared.domain.WaybillFeeDetailEntity;
import com.deppon.foss.module.transfer.management.api.shared.dto.FocusSignBillDto;
import com.deppon.foss.module.transfer.management.api.shared.dto.SignBillTotalDto;
import com.deppon.foss.module.transfer.scheduling.api.shared.util.ConstantsNumberSonar;
import com.deppon.foss.util.UUIDUtils;
import com.deppon.foss.util.define.FossConstants;
/**
 * 集中接货签单service
 * @author 038300-foss-pengzhen
 * @date 2012-11-30 上午11:29:56
 */
public class FocusSignBillService implements IFocusSignBillService {
	/**注入集中接货签单dao*/
	private IFocusSignBillDao focusSignBillDao;
	/**注入服务service*/
	private IWaybillManagerService waybillManagerService;
	/**
	 *  综合管理 组织信息 Service
	 */
	private IOrgAdministrativeInfoComplexService orgAdministrativeInfoComplexService;
		
	private static final Logger LOGGER=LoggerFactory.getLogger(FocusSignBillService.class);

	private static final  BigDecimal BIGFEE = new BigDecimal(100);
	
	public void setFocusSignBillDao(IFocusSignBillDao focusSignBillDao) {
		this.focusSignBillDao = focusSignBillDao;
	}

	public void setWaybillManagerService(
			IWaybillManagerService waybillManagerService) {
		this.waybillManagerService = waybillManagerService;
	}
	
	/**
	 * @Title: querySuperiorOrgByOrgCode 
	 * @Description: 根据部门code找顶级组织 
	 * @param orgCode
	 * @return    
	 * @return OrgAdministrativeInfoEntity    返回类型 
	 * querySuperiorOrgByOrgCode
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-4-28下午4:46:59
	 */
	public OrgAdministrativeInfoEntity querySuperiorOrgByOrgCode(String orgCode) {
		
		//设置查询参数
		List<String> bizTypesList = new ArrayList<String>();
		//顶级车队
		bizTypesList.add(BizTypeConstants.ORG_TRANS_DEPARTMENT);
		//查询上级部门
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = orgAdministrativeInfoComplexService.
				queryOrgAdministrativeInfoIncludeSelfByCode(orgCode, bizTypesList);
		if(orgAdministrativeInfoEntity != null){
			//返回部门
			return orgAdministrativeInfoEntity;
		}else{
			//获取上级部门失败
			LOGGER.error("################查询组织（code：" + orgCode + "）所属的事业部！##########");
			throw new TfrBusinessException("获取上级部门失败, 无上级部门");
		}
	}
	
	/**
	 * @Title: queryChildDept 
	 * @Description: 根据部门编号找到该部门下所有子部门 
	 * @return    
	 * @return String    返回类型 
	 * queryChildDept
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-5-2下午2:28:32
	 */
	public List<String> queryChildDept(String orgCode) {
		//根据部门编码获取所属及下属部门信息 此部门及下属的所有部门。
		List<OrgAdministrativeInfoEntity> orgAdministrativeInfos = orgAdministrativeInfoComplexService.
				queryOrgAdministrativeInfoEntityAllSubByCode(orgCode);
		List<String> orgCodes = new ArrayList<String>(orgAdministrativeInfos.size());
		for(OrgAdministrativeInfoEntity orgAdministrativeInfo : orgAdministrativeInfos) {
			orgCodes.add(orgAdministrativeInfo.getCode());
		}
		//返回部门code
		return orgCodes;
	}

	/**
	 * 获取集中接货签单信息
	 * @author 038300-foss-pengzhen
	 * @date 2012-11-29 下午2:45:48
	 * @see com.deppon.foss.module.transfer.management.api.server.service.IFocusSignBillService#queryFocusSignBill(com.deppon.foss.module.transfer.management.api.shared.dto.FocusSignBillDto)
	 */
	@Override
	public List<FocusSignBillDto> queryFocusSignBill(FocusSignBillDto dto, int start, int limit) {
		String currentDeptCode = FossUserContext.getCurrentDeptCode();
		//当前部门顶级组织
		OrgAdministrativeInfoEntity administrativeInfo = querySuperiorOrgByOrgCode(currentDeptCode);
		//当前部门顶级组织code
		String orgCode = administrativeInfo.getCode();
		List<String> orgCodes = queryChildDept(orgCode);
		dto.setOrgCodes(orgCodes);
		//获取集中接货签单信息
		return focusSignBillDao.queryFocusSignBill(dto, start, limit);
	}
	
	/**
	 * 获取集中接货签单信息数量
	 * @author 038300-foss-pengzhen
	 * @date 2012-12-15 上午10:48:38
	 * @see com.deppon.foss.module.transfer.management.api.server.service.IFocusSignBillService#queryFocusSignBillCount(com.deppon.foss.module.transfer.management.api.shared.dto.FocusSignBillDto)
	 */
	@Override
	public Long queryFocusSignBillCount(FocusSignBillDto dto) {
		String currentDeptCode = FossUserContext.getCurrentDeptCode();
		//当前部门顶级组织
		OrgAdministrativeInfoEntity administrativeInfo = querySuperiorOrgByOrgCode(currentDeptCode);
		//当前部门顶级组织code
		String orgCode = administrativeInfo.getCode();
		List<String> orgCodes = queryChildDept(orgCode);
		dto.setOrgCodes(orgCodes);
		//获取集中接货签单信息数量
		return focusSignBillDao.queryFocusSignBillCount(dto);
	}
	
	/**
	 * 查询集中接货签单合计信息
	 * @author 038300-foss-pengzhen
	 * @date 2012-12-26 下午3:01:42
	 * @see com.deppon.foss.module.transfer.management.api.server.service.IFocusSignBillService#queryFocusSignBillTotal(com.deppon.foss.module.transfer.management.api.shared.dto.FocusSignBillDto)
	 */
	@Override
	public SignBillTotalDto queryFocusSignBillTotal(FocusSignBillDto dto) {
		String currentDeptCode = FossUserContext.getCurrentDeptCode();
		//当前部门顶级组织
		OrgAdministrativeInfoEntity administrativeInfo = querySuperiorOrgByOrgCode(currentDeptCode);
		//当前部门顶级组织code
		String orgCode = administrativeInfo.getCode();
		List<String> orgCodes = queryChildDept(orgCode);
		dto.setOrgCodes(orgCodes);
		//查询集中接货签单合计信息
		return focusSignBillDao.queryFocusSignBillTotal(dto);
	}

	/**
	 * 获取运单信息
	 * @author 038300-foss-pengzhen
	 * @date 2012-11-30 上午10:11:27
	 * @param waybillNo  运单号
	 * @see com.deppon.foss.module.transfer.management.api.server.service.IFocusSignBillService#queryWayBill(java.lang.String)
	 */
	@Override
	public WaybillEntity queryWayBill(String waybillNo) {
		LOGGER.info("运单号:"+waybillNo);
		//获取运单信息
		return waybillManagerService.queryWaybillBasicByNo(waybillNo);
	}

	/**
	 * 保存集中接货签单信息及明细信息
	 * @author 038300-foss-pengzhen
	 * @param entity 集中接货签单信息
	 * @param addList 增加的明细列表
	 * @param updateList 更新的明细列表
	 * @param deleteIdList 删除的明细列表
	 * @param userInfo 当前用户信息
	 * @param operType 操作类型：新增or修改
	 * @date 2012-12-4 上午10:56:36
	 * @see com.deppon.foss.module.transfer.management.api.server.service.IFocusSignBillService#saveFocusSignBill(com.deppon.foss.module.transfer.management.api.shared.domain.FocusSignBillEntity, java.util.List, java.util.List, java.util.List)
	 */
	@Transactional
	@Override
	public void saveFocusSignBill(FocusSignBillEntity entity,
			List<WaybillFeeDetailEntity> addList,
			List<WaybillFeeDetailEntity> updateList, List<String> deleteIdList, CurrentInfo userInfo,boolean operType) {
		
		//如果为更新操作，则调用更新方法，否则为新增操作
		if(!operType){
			//如果用户信息不为空则进行填充,否则抛出异常
			if(userInfo != null){
				Date date = new Date();
				//修改人
				entity.setModifyUser(userInfo.getEmpName());
				//修改日期
				entity.setModifyDate(date);
				//更新操作
				updateFocusSignBill(entity, addList, updateList, deleteIdList);
			}else{
				//获取用户信息失败异常
				throw new TfrBusinessException(TfrBusinessException.GET_CURRENTUSERINFO_FAILURE);
			}
		}else{
			//如果用户信息不为空则进行填充,否则抛出异常
			if(userInfo != null){
				FocusSignBillEntity focusSignBill = queryFocusSignBillByNo(entity.getSignBillNo());
				//签单号唯一性校验
				if(focusSignBill != null) {
					//签单号唯一性校验失败异常
					throw new TfrBusinessException("签单号重复, 请重新输入!");
				}
				Date date = new Date();
				//创建人
				entity.setCreateUser(userInfo.getEmpCode());
				//创建日期
				entity.setCreateDate(date);
				//修改人
				entity.setModifyUser(userInfo.getEmpName());
				//修改日期
				entity.setModifyDate(date);
				//新增操作
				addFocusSignBill(entity, addList);
			}else{
				//获取用户信息失败异常
				throw new TfrBusinessException(TfrBusinessException.GET_CURRENTUSERINFO_FAILURE);
			}
		}
	}
	
	/**
	 * 新增集中接货签单信息
	 * @param 集中接货签单信息
	 * @param 增加的明细列表
	 * @param userInfo 当前用户信息
	 * @author 038300-foss-pengzhen
	 * @date 2012-12-4 上午10:58:52
	 */
	@Transactional
	public void addFocusSignBill(FocusSignBillEntity entity, List<WaybillFeeDetailEntity> addList){
		//设置新增的签单ID
		entity.setId(UUIDUtils.getUUID());
		//新增部门
		entity.setOrgCode(FossUserContext.getCurrentDeptCode());
		//新增部门
		entity.setOrgName(FossUserContext.getCurrentDept().getName());
		//设置司机姓名  
		if(StringUtils.isNotBlank(entity.getDriverName())){
			entity.setDriverName(entity.getDriverName());
		}else{
			entity.setDriverName(entity.getDriverCode());
		}
		//调用DAO进行新增
		focusSignBillDao.addFocusSignBill(entity);
		//设置签单明细对应的签单号
		for(WaybillFeeDetailEntity e : addList){
			//设置明细ID
			e.setId(UUIDUtils.getUUID());
			//设置明细对应的签单号
			e.setSignBillNo(entity.getSignBillNo());
			e.setUseTruckFee(e.getUseTruckFee().multiply(BIGFEE));
			e.setDriverRoyalty(e.getDriverRoyalty().multiply(BIGFEE));
			//设置币种
			e.setCurrencyCode(FossConstants.CURRENCY_CODE_RMB);
		}
		focusSignBillDao.addWaybillFeeDetail(addList);
	}
	
	/**
	 * 更新集中接货签单信息包括其明细的变动
	 * @author 038300-foss-pengzhen
	 * @date 2012-12-4 下午3:52:43
	 */
	@Transactional
	public void updateFocusSignBill(FocusSignBillEntity entity,
			List<WaybillFeeDetailEntity> addList,
			List<WaybillFeeDetailEntity> updateList, List<String> deleteIdList){
		//设置司机姓名  
		if(StringUtils.isNotBlank(entity.getDriverName())){
			entity.setDriverName(entity.getDriverName());
		}else{
			entity.setDriverName(entity.getDriverCode());
		}
		//更新签单主信息
		focusSignBillDao.updateFocusSignBill(entity);
		//更新签单费用明细信息
		if(addList != null && addList.size() != 0){
			for(WaybillFeeDetailEntity e : addList){
				//设置明细ID
				e.setId(UUIDUtils.getUUID());
				//设置明细对应的签单号
				e.setSignBillNo(entity.getSignBillNo());
				e.setUseTruckFee(e.getUseTruckFee().multiply(BIGFEE));
				e.setDriverRoyalty(e.getDriverRoyalty().multiply(BIGFEE));
				//设置币种
				e.setCurrencyCode(FossConstants.CURRENCY_CODE_RMB);
			}
			focusSignBillDao.addWaybillFeeDetail(addList);
		}else{
			//空操作
		}
		if(updateList !=null && updateList.size() != 0){
			for(WaybillFeeDetailEntity e : updateList){
				e.setSignBillNo(entity.getSignBillNo());
				e.setUseTruckFee(e.getUseTruckFee().multiply(BIGFEE));
				e.setDriverRoyalty(e.getDriverRoyalty().multiply(BIGFEE));
			}
			focusSignBillDao.updateWaybillFeeDetail(updateList);
		}else{
			//空操作
		}
		if(deleteIdList !=null && deleteIdList.size() != 0){
			focusSignBillDao.deleteWaybillFeeDetail(deleteIdList);
		}else{
			//空操作
		}
		
	}
	/**
	 * 根据签单号删除集中接货签单信息
	 * @param 签单号
	 * @author 038300-foss-pengzhen
	 * @date 2012-12-15 下午5:30:58
	 * @see com.deppon.foss.module.transfer.management.api.server.service.IFocusSignBillService#deleteFocusSignBill(java.lang.String)
	 */
	@Transactional
	@Override
	public void deleteFocusSignBill(String signBillNumber) {
		//根据签单号删除集中接货签单信息
		focusSignBillDao.deleteFocusSignBill(signBillNumber);
		//根据签单号删除集中接货签单信息
		focusSignBillDao.deleteWaybillFeeDetail(signBillNumber);
	}
	/**
	 * 通过签单号查询签单信息
	 * @author 038300-foss-pengzhen
	 * @date 2012-12-18 上午8:44:01
	 * @see com.deppon.foss.module.transfer.management.api.server.service.IFocusSignBillService#queryFocusSignBillByNo(java.lang.String)
	 */
	@Override
	public FocusSignBillEntity queryFocusSignBillByNo(String signBillNumber) {
		//通过签单号查询签单信息
		return focusSignBillDao.queryFocusSignBillByNo(signBillNumber);
	}
	/**
	 * 通过签单号查询签单费用明细
	 * @author 038300-foss-pengzhen
	 * @date 2012-12-18 上午8:46:24
	 * @see com.deppon.foss.module.transfer.management.api.server.service.IFocusSignBillService#queryWaybillFeeDetailByNo(java.lang.String)
	 */
	@Override
	public List<WaybillFeeDetailEntity> queryWaybillFeeDetailByNo(
			String signBillNumber) {
		//通过签单号查询签单费用明细
		return focusSignBillDao.queryWaybillFeeDetailByNo(signBillNumber);
	}
	
	/**
	 * 创建cell
	 * @author 099197-foss-liming
	 * @date 2012-12-26 下午2:36:20
	 */
	private HSSFCell createHSSFCell(HSSFRow row, int columnIndex, String value) {
		//创建cell
		HSSFCell cell = row.createCell(columnIndex);
		cell.setCellValue(value);
		cell.setCellType(HSSFCell.CELL_TYPE_STRING);
		//创建cell
		return cell;
	}
	
	
	private HSSFRow createDataRow(HSSFSheet sheet, int rowIndex, FocusSignBillDto result) {
		HSSFRow row = sheet.createRow(rowIndex);
		int columnIndex = 0;
		SimpleDateFormat format = new SimpleDateFormat("yyyy-MM-dd");
		//派送单号
		createHSSFCell(row, columnIndex, result.getSignBillNo());		//派送单号
		columnIndex ++;
		
		//部门
		createHSSFCell(row, columnIndex, result.getUseTruckOrgCode());//部门
		columnIndex ++;
		
		//司机姓名
		createHSSFCell(row, columnIndex, result.getDriverCode());//司机姓名
		columnIndex ++;	
		
		//司机姓名
		createHSSFCell(row, columnIndex, result.getDriverName());//司机姓名
		columnIndex ++;		
		
		//日期
		createHSSFCell(row, columnIndex, format.format(result.getSignBillDate()));//日期
		columnIndex ++;
		
		//车牌号
		createHSSFCell(row, columnIndex, result.getVehicleNo());//车牌号
		columnIndex ++;
		
		//车型
		createHSSFCell(row, columnIndex, result.getVehicleTypeLength());//车型
		columnIndex ++;		
		
		//行驶公里
		BigDecimal runKm = result.getRunKm() == null ? BigDecimal.ZERO : result.getRunKm();
		createHSSFCell(row, columnIndex, runKm + "");
		columnIndex ++;
		
		createHSSFCell(row, columnIndex, result.getWaybillQtyTotal() + "");
		columnIndex ++;
		
		BigDecimal volume = result.getVolume() == null ? BigDecimal.ZERO : result.getVolume();
		createHSSFCell(row, columnIndex, volume + "");
		columnIndex ++;
		
		BigDecimal weight = result.getWeight() == null ? BigDecimal.ZERO : result.getWeight();
		createHSSFCell(row, columnIndex, weight + "");
		columnIndex ++;
			
		//单独接货票数
		createHSSFCell(row, columnIndex, result.getUpstairsBillQty()+"");	 /**单独接货票数*/	
		columnIndex ++;	   
	   
		createHSSFCell(row, columnIndex, result.getSingleReceiveBillQty()+"");
	
		return row;
	}
	
	@Override
	public InputStream queryExportFocusSignBill(FocusSignBillDto dto) {
		InputStream excelStream = null;
		String currentDeptCode = FossUserContext.getCurrentDeptCode();
		//当前部门顶级组织
		OrgAdministrativeInfoEntity administrativeInfo = querySuperiorOrgByOrgCode(currentDeptCode);
		//当前部门顶级组织code
		String orgCode = administrativeInfo.getCode();
		List<String> orgCodes = queryChildDept(orgCode);
		dto.setOrgCodes(orgCodes);
		List<FocusSignBillDto> list = focusSignBillDao.queryFocusSignBill(dto);
		 int dataSize = list.size();//总条数
		double sheetNo = Math.ceil(dataSize / SignBillConstants.SHEET_SIZE);
		LOGGER.info("开始统计=");
		ExcelExport excelExportUtil = new ExcelExport();
		HSSFWorkbook workbook = excelExportUtil.createWorkBook();
	    HSSFCellStyle style = workbook.createCellStyle(); // 样式对象      
        style.setVerticalAlignment(HSSFCellStyle.VERTICAL_CENTER);// 垂直      
        style.setAlignment(HSSFCellStyle.ALIGN_CENTER);// 水平     
        for(int index = 0; index <= sheetNo; index++) {
  			int rowIndex = 0;
  			HSSFSheet sheet = excelExportUtil.createSheet(workbook, "签单" + index);
            sheet.setDefaultColumnWidth(ConstantsNumberSonar.SONAR_NUMBER_25);            
			// 标题
     		HSSFRow titleRow2 = sheet.createRow(rowIndex);
     		HSSFCell titleCell2 = createHSSFCell(titleRow2, 0, SignBillConstants.FOCUS_SHEET_NAME);
     		titleCell2.setCellStyle(style);
     		CellRangeAddress cellRangeAddress = new CellRangeAddress(0, 0, 0, ConstantsNumberSonar.SONAR_NUMBER_8);
			sheet.addMergedRegion(cellRangeAddress);
			rowIndex ++;
     		     		
			// head 2
			HSSFRow headRow2 = sheet.createRow(rowIndex);			
     		for(int i = 0, len = SignBillConstants.FOCUS_ROW_HEADS.length; i<len; i++) {
     			createHSSFCell(headRow2, i, SignBillConstants.FOCUS_ROW_HEADS[i]);
     		}
     		rowIndex++; 
    		/**
    		 * 司机个数
    		 */
    		 Integer  driverCount=0;     		 
    		  /**
     	     * 总体积
     	     */
     	     BigDecimal volumeTotal = new BigDecimal(0);
     	    /**
     	     * 总重量
     	     */
     	    BigDecimal weightTotal=  new BigDecimal(0);
			/**
			 * 总票数
			 */
			 Integer billQtyCount=0; 

			 /**接货票数*/
			 Integer waybillQtyTotal=0;
				/**上楼票数 */
			 Integer upstairsBillQty=0;
			    /**单独接货票数*/
			 Integer singleReceiveBillQty=0;			
    		int startNo = index * (SignBillConstants.SHEET_SIZE - 1);
            int endNo = Math.min(startNo + SignBillConstants.SHEET_SIZE - 1, dataSize);
            Set<String> set=new HashSet<String>();//司机
            List<String>  listCount=new ArrayList<String>();//新增所有的司机
            for (int i = startNo; i < endNo; i++) {
            	FocusSignBillDto result = list.get(i);       
     			createDataRow(sheet, rowIndex, list.get(i));
     			rowIndex++;
     			// 累计    			
    			// 毛重累加
     			weightTotal = weightTotal.add(result.getWeight());
    			// 设置计费重量
    			volumeTotal =volumeTotal.add(result.getVolume());
    		 	 /**接货票数*/
   			   waybillQtyTotal=waybillQtyTotal+result.getWaybillQtyTotal();
   				/**上楼票数 */
   			   upstairsBillQty=upstairsBillQty+result.getUpstairsBillQty();
   			    /**单独接货票数*/
   			   singleReceiveBillQty=singleReceiveBillQty+result.getSingleReceiveBillQty();
   			   listCount.add(result.getDriverCode());
            }
            set.addAll(listCount);            
            billQtyCount= endNo; 
            driverCount = set.size();
            //合计行
            HSSFRow totalRow = sheet.createRow(rowIndex);
            //合计
            createHSSFCell(totalRow, 0, "合计");
            //司机数:  
            createHSSFCell(totalRow, 1, "司机数:  "+String.valueOf(driverCount));
            //票数合计
            createHSSFCell(totalRow, 2, " 票数合计: "+String.valueOf(billQtyCount));
            //体积合计
            createHSSFCell(totalRow, ConstantsNumberSonar.SONAR_NUMBER_3, "体积合计: "+String.valueOf(volumeTotal)); 
            //重量合计: 
            createHSSFCell(totalRow, ConstantsNumberSonar.SONAR_NUMBER_4, "重量合计: "+String.valueOf(weightTotal));
            //接货票数合计: 
            createHSSFCell(totalRow, ConstantsNumberSonar.SONAR_NUMBER_5, "接货票数合计: "+String.valueOf(waybillQtyTotal));
            // 上楼票数合计: 
            createHSSFCell(totalRow, ConstantsNumberSonar.SONAR_NUMBER_6, " 上楼票数合计: "+String.valueOf(upstairsBillQty));   
            //单独接货票数合计: 
            createHSSFCell(totalRow, ConstantsNumberSonar.SONAR_NUMBER_7, "单独接货票数合计: "+String.valueOf(singleReceiveBillQty));
            rowIndex ++;            
          
         }

		excelStream = excelExportUtil.inputToClient(workbook);
	
        return excelStream;
	}

	/** 
	 * @Title: getOrgNameByCode 
	 * @Description: 根据部门code查name
	 * @param useTruckOrgCode
	 * @return    
	 * @see com.deppon.foss.module.transfer.management.api.server.service.IFocusSignBillService#getOrgNameByCode(java.lang.String)
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-3-25上午10:25:28
	 */ 
	@Override
	public String getOrgNameByCode(String useTruckOrgCode) {
		return focusSignBillDao.getOrgNameByCode(useTruckOrgCode);
	}
	
	/**
	 * 编辑时通过签单ID查询签单信息 
	 * @author Administrator
	 * @date 2013-10-18 上午11:05:01
	 * @param id
	 * @return 
	 * @see com.deppon.foss.module.transfer.management.api.server.service.IFocusSignBillService#queryFocusSignBillById(java.lang.String)
	 */
	@Override
	public FocusSignBillEntity queryFocusSignBillById(String id) {
		return focusSignBillDao.queryFocusSignBillById(id);
	}
	
	/**   
	 * @param orgAdministrativeInfoComplexService the orgAdministrativeInfoComplexService to set
	 * Date:2013-5-2下午2:24:13
	 */
	public void setOrgAdministrativeInfoComplexService(
			IOrgAdministrativeInfoComplexService orgAdministrativeInfoComplexService) {
		this.orgAdministrativeInfoComplexService = orgAdministrativeInfoComplexService;
	}
}