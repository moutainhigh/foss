/**
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 *  initial comments.
 */
/*******************************************************************************
 * Copyright 2013 TFR TEAM
 *  
 *  Licensed under the DEPPON License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *  
 *     http://www.deppon.com/licenses/LICENSE-2.0
 *  
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *  Contributors:
 *  038300-foss-pengzhen - initial API and implementation
 * 
 *  PROJECT NAME  : tfr-management
 *  
 *  FILE PATH     : src/main/java/com/deppon/foss/module/transfer/management/server/service/impl/FuelConsumptionService.java
 *  
 *  FILE NAME          :FuelConsumptionService.java
 * 
 *  AUTHOR  : FOSS中转系统开发组
 *  
 *  TIME              : 
 *  
 *  HOME PAGE    :  http://www.deppon.com
 * 
 *  COPYRIGHT    : Copyright (c) 2013  Deppon All Rights Reserved.
 ******************************************************************************/
package com.deppon.foss.module.transfer.management.server.service.impl;

import java.math.BigDecimal;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import org.apache.commons.lang.StringUtils;
import org.springframework.transaction.annotation.Transactional;

import com.deppon.foss.base.util.define.BizTypeConstants;
import com.deppon.foss.framework.exception.BusinessException;
import com.deppon.foss.module.base.baseinfo.api.server.service.IExpressVehiclesService;
import com.deppon.foss.module.base.baseinfo.api.server.service.IMotorcadeService;
import com.deppon.foss.module.base.baseinfo.api.server.service.IOrgAdministrativeInfoService;
import com.deppon.foss.module.base.baseinfo.api.server.service.complex.IOrgAdministrativeInfoComplexService;
import com.deppon.foss.module.base.baseinfo.api.server.service.complex.IVehicleService;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.ExpressVehiclesEntity;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.MotorcadeEntity;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.OrgAdministrativeInfoEntity;
import com.deppon.foss.module.base.baseinfo.api.shared.dto.VehicleAssociationDto;
import com.deppon.foss.module.frameworkimpl.server.context.FossUserContext;
import com.deppon.foss.module.transfer.common.api.shared.exception.TfrBusinessException;
import com.deppon.foss.module.transfer.load.api.server.service.IVehicleAssembleBillService;
import com.deppon.foss.module.transfer.load.api.shared.domain.VehicleAssembleBillEntity;
import com.deppon.foss.module.transfer.load.api.shared.dto.QueryVehicleAssembleBillDto;
import com.deppon.foss.module.transfer.management.api.server.dao.IFuelConsumptionDao;
import com.deppon.foss.module.transfer.management.api.server.service.IFuelConsumptionService;
import com.deppon.foss.module.transfer.management.api.shared.domain.FuelConsumptionEntity;
import com.deppon.foss.module.transfer.management.api.shared.domain.FuelDepartureEntity;
import com.deppon.foss.module.transfer.management.api.shared.domain.FuelDetailEntity;
import com.deppon.foss.module.transfer.management.api.shared.domain.FuelRoadTollEntity;
import com.deppon.foss.module.transfer.management.api.shared.domain.FuelVehicleEntity;
import com.deppon.foss.module.transfer.management.api.shared.dto.FuelConsonptionForExportDto;
import com.deppon.foss.module.transfer.management.api.shared.dto.FuelConsumptionDto;
import com.deppon.foss.module.transfer.management.api.shared.dto.FuelConsumptionTotalDto;
import com.deppon.foss.module.transfer.management.api.shared.dto.FuelStandardExcelDto;
import com.deppon.foss.module.transfer.scheduling.api.shared.util.ConstantsNumberSonar;
import com.deppon.foss.util.UUIDUtils;

/**
 * 车辆油耗相关操作
 * @author foss-liuxue(for IBM)
 * @date 2012-12-20 下午3:01:09
 */
public class FuelConsumptionService implements IFuelConsumptionService {

	/**
	 * 查询车辆信息的接口
	 */
	private IVehicleService vehicleService;  
	
	/**
	 * LMS接口
	 */
	//private IFOSSToLMSService fossToLMSService;  
	
	/**
	 * 油耗dao
	 */
	private IFuelConsumptionDao fuelConsumptionDao;
	
	/**
	 * 部门 复杂查询 service
	 */
	private IOrgAdministrativeInfoComplexService orgAdministrativeInfoComplexService;
	
	/**
	 * 组织信息 service
	 */
	private IOrgAdministrativeInfoService orgAdministrativeInfoService;
	
	/**
	 * 数据字典Service
	 */
	//private IDataDictionaryService dataDictionaryService;
	
	//配载单service
	private IVehicleAssembleBillService vehicleAssembleBillService;
	//快递车辆service
	private IExpressVehiclesService expressVehiclesService;

	IMotorcadeService motorcadeService;
	
	/**
	 * @param motorcadeService the motorcadeService to set
	 */
	public void setMotorcadeService(IMotorcadeService motorcadeService) {
		this.motorcadeService = motorcadeService;
	}

	/**
	 * @param expressVehiclesService the expressVehiclesService to set
	 */
	public void setExpressVehiclesService(
			IExpressVehiclesService expressVehiclesService) {
		this.expressVehiclesService = expressVehiclesService;
	}

	/**
	 * @return the vehicleAssembleBillService
	 */
	public IVehicleAssembleBillService getVehicleAssembleBillService() {
		return vehicleAssembleBillService;
	}

	/**
	 * @param vehicleAssembleBillService the vehicleAssembleBillService to set
	 */
	public void setVehicleAssembleBillService(
			IVehicleAssembleBillService vehicleAssembleBillService) {
		this.vehicleAssembleBillService = vehicleAssembleBillService;
	}

	/**
	 * 设置 组织信息 Service.
	 *
	 * @param IOrgAdministrativeInfoComplexService the new 组织信息 Service
	 */
	public void setOrgAdministrativeInfoComplexService(
			IOrgAdministrativeInfoComplexService orgAdministrativeInfoComplexService) {
		this.orgAdministrativeInfoComplexService = orgAdministrativeInfoComplexService;
	}
	/**
	 * 设置 组织信息 Service.
	 * 
	 * @param orgAdministrativeInfoService
	 */
	public void setOrgAdministrativeInfoService(
			IOrgAdministrativeInfoService orgAdministrativeInfoService) {
		this.orgAdministrativeInfoService = orgAdministrativeInfoService;
	}

	/**
	 * 设置 lMS接口.
	 *
	 * @param fossToLMSService the new lMS接口
	 */
	/*public void setFossToLMSService(IFOSSToLMSService fossToLMSService) {
		this.fossToLMSService = fossToLMSService;
	}*/

	/**
	 * 设置 查询车辆信息的接口.
	 *
	 * @param vehicleService the new 查询车辆信息的接口
	 */
	public void setVehicleService(IVehicleService vehicleService) {
		this.vehicleService = vehicleService;
	}

	/**
	 * 设置 油耗dao.
	 *
	 * @param fuelConsumptionDao the new 油耗dao
	 */
	public void setFuelConsumptionDao(IFuelConsumptionDao fuelConsumptionDao) {
		this.fuelConsumptionDao = fuelConsumptionDao;
	}

	/**
	 * 设置 数据字典Service.
	 *
	 * @param dataDictionaryService the new 数据字典Service
	 */
	/*public void setDataDictionaryService(
			IDataDictionaryService dataDictionaryService) {
		this.dataDictionaryService = dataDictionaryService;
	}*/

	/**
	 * 根据车牌号获取车辆信息
	 * @author foss-liuxue(for IBM)
	 * @date 2012-12-21 下午4:12:26
	 */
	@Override
	@Transactional(readOnly = true)
	public FuelVehicleEntity queryVehicleInfo(FuelConsumptionDto fuelConsumptionDto){
		//根据车牌号获取相关信息
		VehicleAssociationDto associationDto = vehicleService.queryVehicleAssociationDtoByVehicleNo(fuelConsumptionDto.getVehicleNo());
		//油耗实体
		FuelVehicleEntity fuelVehicleEntity = new FuelVehicleEntity();
		//如果为null
		if(associationDto == null){
			//没有查到公司车或外请车时，查询快递车辆
			ExpressVehiclesEntity entity = new ExpressVehiclesEntity();
			entity.setVehicleNo(fuelConsumptionDto.getVehicleNo());
			List<ExpressVehiclesEntity> expressList  =  expressVehiclesService.queryExpressVehiclesList(entity, 0, 1);
			if(expressList == null || expressList.size() == 0) {
				//抛出异常
				throw new TfrBusinessException("根据当前车牌号没有找到相应车辆信息","");
			} else {
				entity =  expressList.get(0);
				fuelVehicleEntity.setVehicleType(entity.getVehicleLengthName()); 
				//出车性质为快递
				fuelVehicleEntity.setDepartureTypeCode("EXPRESS");
				//fuelVehicleEntity.setDepartureTypeCode("EXPRESS");
			}
		} else {
			
			//油耗实体
			//FuelVehicleEntity fuelVehicleEntity = new FuelVehicleEntity();
			//车型
			fuelVehicleEntity.setVehicleType(associationDto.getVehicleLengthName());  
			//车辆品牌
			fuelVehicleEntity.setVehicleBrand(associationDto.getVehicleBrandName());
			//车队
			fuelVehicleEntity.setTransDepartmentName(associationDto.getVehicleMotorcadeName());  
			//小组
			fuelVehicleEntity.setGroupOrgName(associationDto.getVehicleOrganizationName()); 
			//出车性质
			if(StringUtils.isNotEmpty(associationDto.getVehicleUsedTypeCode())) {
				//长途车
				if("used_type_coach".equals(associationDto.getVehicleUsedTypeCode())) {
					fuelVehicleEntity.setDepartureTypeCode("LONG_DISTANCE");
					//fuelVehicleEntity.setDepartureTypeCode("长途");
				} else if("used_type_bus".equals(associationDto.getVehicleUsedTypeCode())) {
					fuelVehicleEntity.setDepartureTypeCode("SHORT_BUS");
					//fuelVehicleEntity.setDepartureTypeCode("短途班车");
				} else if("used_type_pkp".equals(associationDto.getVehicleUsedTypeCode())) {
					fuelVehicleEntity.setDepartureTypeCode("SHORT_DISTANCE");
					//fuelVehicleEntity.setDepartureTypeCode("短途接送货");
				} else if("used_type_service".equals(associationDto.getVehicleUsedTypeCode())) {
					fuelVehicleEntity.setDepartureTypeCode("LOGISTICS_VEHICLE");
					//fuelVehicleEntity.setDepartureTypeCode("后勤车");
				}
			}
			
			//百公里油耗
			//fuelVehicleEntity.(associationDto.getConsumeFuel()); 
			//事业部
			String divisionOrgName = "";
			//大区
			String regionOrgName = "";
			//获取事业部，所属大区
			if(StringUtils.isNotBlank(associationDto.getVehicleMotorcadeCode())){
				
				List<String> bizType=new ArrayList<String>(1);
				bizType.add(BizTypeConstants.ORG_BIG_REGION);
				//根据所属车队编码获取组织信息
				OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = orgAdministrativeInfoComplexService.getTopFleetByCode(associationDto.getVehicleMotorcadeCode());
				//大区赋值
				if(null != orgAdministrativeInfoEntity){
					regionOrgName = orgAdministrativeInfoEntity.getName();
				}
				
				bizType.clear();
				bizType.add(BizTypeConstants.ORG_DIVISION);
				//根据所属车队编码获取组织信息
				orgAdministrativeInfoEntity = orgAdministrativeInfoComplexService.queryOrgAdministrativeInfoByCode(associationDto.getVehicleMotorcadeCode(),bizType);
				//事业部赋值
				if(null != orgAdministrativeInfoEntity){
					divisionOrgName = orgAdministrativeInfoEntity.getName();
				}
			}
			//设置事业部
			fuelVehicleEntity.setDivisionOrgName(divisionOrgName);
			//设置大区
			fuelVehicleEntity.setRegionOrgName(regionOrgName);
		}
		return fuelVehicleEntity;
	}

	/**
	 * @author niuly
	 * @date 2013-12-9下午2:02:58
	 * @function 获取操作人
	 * @return
	 */
	private String getUser() {
		String userCode = "";
		String userName = "";
		if(FossUserContext.getCurrentInfo() != null) {
			userCode = FossUserContext.getCurrentInfo().getEmpCode();
			userName = FossUserContext.getCurrentInfo().getEmpName();
		}
		StringBuffer user = new StringBuffer("");
		user = user.append(userCode).append(",").append(new StringBuffer(userName));
		return user.toString();
	}
	/**
	 * 新增油耗信息
	 * @author foss-liuxue(for IBM)
	 * @date 2012-12-24 下午8:59:27
	 */
	@Override
	@Transactional
	public int saveOrUpdateFuelConsumption(FuelVehicleEntity fuelVehicleEntity,List<FuelDepartureEntity> fuelDepartureList) {
		
		//车辆信息
		String vehicleId = UUIDUtils.getUUID();
		fuelVehicleEntity.setId(vehicleId);
		Date createDate = new Date();
		//创建时间
		fuelVehicleEntity.setCreateDate(createDate);
		String user = this.getUser();
		fuelVehicleEntity.setCreateUser(user);
		
		//加油信息list
		List<FuelDetailEntity> fuelDetailTotalList = new ArrayList<FuelDetailEntity>();
		//路桥费信息list
		List<FuelRoadTollEntity> fuelRoadTollTotalList = new ArrayList<FuelRoadTollEntity>();
		
		//发车信息list
		for(FuelDepartureEntity entity : fuelDepartureList) {
			String departureId = UUIDUtils.getUUID();
			entity.setId(departureId);
			entity.setVehicleId(vehicleId);
			entity.setCreateDate(createDate);
			
			//加油信息
			List<FuelDetailEntity> fuelDetailList = entity.getFuelDetailList();
			for(FuelDetailEntity detailEntity : fuelDetailList) {
				String detailId = detailEntity.getId();
				if(StringUtils.isBlank(detailId)) {
					detailId = UUIDUtils.getUUID();
					detailEntity.setId(detailId);
					detailEntity.setDepartureId(departureId);
					detailEntity.setCreateDate(createDate);
					detailEntity.setCreateUser(user);
				}
				fuelDetailTotalList.add(detailEntity);
			}
			
			//路桥费信息
			List<FuelRoadTollEntity> fuelRoadTollList = entity.getFuelRoadTollList();
			for(FuelRoadTollEntity roadTollEntity : fuelRoadTollList) {
				String roadTollId = roadTollEntity.getId();
				if(StringUtils.isBlank(roadTollId)) {
					roadTollId = UUIDUtils.getUUID();
					roadTollEntity.setId(roadTollId);
					roadTollEntity.setDepartureId(departureId);
					roadTollEntity.setCreateDate(createDate);
					roadTollEntity.setCreateUser(user);
				}
				
				fuelRoadTollTotalList.add(roadTollEntity);
			}
		}
		
		
			//调用LMS接口同步油耗信息
//			updateVehicleState(fuelConsumptionEntity.getVehicleNo(),fuelConsumptionEntity.getDepartureTypeCode(),fuelConsumptionEntity.getContainerNo(),
//						fuelConsumptionEntity.getStartKm(),fuelConsumptionEntity.getArriveKm(),id,FuelConsonptionConstants.OPERATOR_STATE_ADD);
			//添加加油信息
			fuelConsumptionDao.addFuelDetail(fuelDetailTotalList);
			//添加路桥费信息
			fuelConsumptionDao.addFuelRoadToll(fuelRoadTollTotalList);
			//添加发车信息
			fuelConsumptionDao.addDeparture(fuelDepartureList);
			//添加车辆信息
			return fuelConsumptionDao.addVehicle(fuelVehicleEntity);
	}

	/**
	 * 查询油耗信息
	 * @author foss-liuxue(for IBM)
	 * @date 2012-12-25 下午8:02:32
	 */
	@Override
	@Transactional(readOnly = true)
	public List<FuelConsumptionDto> queryFuelConsumption(
			FuelConsumptionDto fuelConsumptionDto, int start, int limit) {
		String transDepartment = this.isTransDepartment();
		//若当前部门为车队调度组，获取其配置的所属车队及其下属所有车队小组
		String currentDeptCode = FossUserContext.getCurrentDeptCode();
		MotorcadeEntity org = motorcadeService.queryMotorcadeByCode(currentDeptCode);
		if(null != org && StringUtils.equals("Y", org.getDispatchTeam())){
			//把所有车队名称放入dto
			this.transDepartmentNameList(org, fuelConsumptionDto);
		} else{
			//若是车队，则获取当前组织名称
			if ("YES".equals(transDepartment)) {
				String currentDeptName = "";
				if(FossUserContext.getCurrentInfo() != null) {
					currentDeptName = FossUserContext.getCurrentInfo().getCurrentDeptName();
				}
				fuelConsumptionDto.setCurrentDeptName(currentDeptName);
			}
			fuelConsumptionDto.setTransDepartment(transDepartment);
		}
		//查询油耗信息
		return fuelConsumptionDao.queryFuelConsumption(fuelConsumptionDto, start, limit);
	}
	/**
	 * @author sunjianbo
	 * @date 2014-5-9
	 * @function 批量处理多个车队的油耗信息查询
	 * @return
	 */
	public void transDepartmentNameList(MotorcadeEntity org,FuelConsumptionDto fuelConsumptionDto){
		String parentOrgCode = "";
		List<String> transDepartmentNameList = new ArrayList<String>();
		//获取车队调度组所属车队
		parentOrgCode = org.getParentOrgCode();
	
		if(null != parentOrgCode){
			String parentOrgName = orgAdministrativeInfoService.queryOrgAdministrativeInfoNameByCode(parentOrgCode);
			if(StringUtils.isNotEmpty(parentOrgName)) {
				//查询条件车队加入顶级车队名称
				transDepartmentNameList.add(orgAdministrativeInfoService.queryOrgAdministrativeInfoNameByCode(parentOrgCode));
			}
		}else{
			// 如果获取不到车队调度组所属车队，则获取登陆部门所属的顶级车队
			OrgAdministrativeInfoEntity topFleet = orgAdministrativeInfoComplexService.getTopFleetByCode(FossUserContext.getCurrentDeptCode());
			if(null != topFleet){
				parentOrgCode = topFleet.getCode();
				
				if(StringUtils.isNotEmpty(topFleet.getName())){
					//查询条件车队加入顶级车队名称
					transDepartmentNameList.add(topFleet.getName());
				}
			}
		}
		//获取顶级车队下属所有车队
		List<OrgAdministrativeInfoEntity> transTeamList = orgAdministrativeInfoComplexService.queryOrgAdministrativeInfoSubByBizType(parentOrgCode, BizTypeConstants.ORG_TRANS_DEPARTMENT);
		if(null != transTeamList){
			for(OrgAdministrativeInfoEntity tranTeam : transTeamList){
				if(StringUtils.isNotEmpty(tranTeam.getName())) {
					//查询条件车队加入每一个下属车队名称
					transDepartmentNameList.add(tranTeam.getName());
				}
			}
		}
		fuelConsumptionDto.setTransDepartmentNameList(transDepartmentNameList);
		//忽略车队过滤条件
		fuelConsumptionDto.setTransDepartment("NO");
	}
	/**
	 * @author niuly
	 * @date 2013-12-5上午11:10:55
	 * @function 判断所在部门是否为车队
	 * @return
	 */
	@Override
	public String isTransDepartment() {
		String transDepartment = "NO";
		String deptCode = "";
		if(FossUserContext.getCurrentInfo() != null) {
			deptCode = FossUserContext.getCurrentInfo().getCurrentDeptCode();
		}
		//调用综合接口进行判断,若此部门是车队
		MotorcadeEntity  entity = motorcadeService.queryMotorcadeByCode(deptCode);
		if(entity != null) {
			transDepartment = "YES";
		}
		return transDepartment;
	}
	/**
	 * 查询油耗信息总条数
	 * @author foss-liuxue(for IBM)
	 * @date 2012-12-25 下午8:02:32
	 */
	@Override
	@Transactional(readOnly = true)
	public Long getCount(FuelConsumptionDto fuelConsumptionDto) {
		//查询油耗信息总条数
		return fuelConsumptionDao.getCount(fuelConsumptionDto);
	}

	/**
	 * 删除油耗信息
	 * @author foss-liuxue(for IBM)
	 * @date 2012-12-25 下午8:19:59
	 */
	@Override
	@Transactional
	public int deleteFuelConsumption(FuelConsumptionDto fuelConsumptionDto) {
		//如果前台传入的ID为空
		if(StringUtils.isBlank(fuelConsumptionDto.getId()) || StringUtils.isBlank(fuelConsumptionDto.getVehicleId())){
			//则抛出异常
			throw new TfrBusinessException("异常错误，请重新查询再操作！","");
		}
		//根据ID获取油耗信息用于同步
		//FuelConsumptionEntity fuelConsumptionEntity = fuelConsumptionDao.queryFuelConsumptionById(fuelConsumptionDto).get(0);
		//删除加油明细
		fuelConsumptionDao.deleteFuelDetail(fuelConsumptionDto.getId());
		//删除路桥费明细
		fuelConsumptionDao.deleteFuelRoadToll(fuelConsumptionDto.getId());
		
		//根据车辆id查询该车辆对应的发车信息，sql中结果应减去1
		Long departureCount = fuelConsumptionDao.queryDepartureCount(fuelConsumptionDto.getVehicleId());
		//若不再对应任何发车信息，则删除车辆信息，否则不应当删除
		if(departureCount.compareTo(Long.valueOf(0)) <= 0) {
			fuelConsumptionDao.deleteVehicle(fuelConsumptionDto.getVehicleId());
		}
		//调用LMS接口同步油耗信息
		/*if(null != fuelConsumptionEntity){
			updateVehicleState(fuelConsumptionEntity.getVehicleNo(),fuelConsumptionEntity.getDepartureTypeCode(),fuelConsumptionEntity.getContainerNo(),
					fuelConsumptionEntity.getStartKm(),fuelConsumptionEntity.getArriveKm(),fuelConsumptionDto.getId(),FuelConsonptionConstants.OPERATOR_STATE_DELETE);	
		}*/
		 //删除发车信息
		return	fuelConsumptionDao.deleteDeparture(fuelConsumptionDto.getId());
	}

	/**
	 * 点击编辑/查看时load油耗信息
	 * @author foss-liuxue(for IBM)
	 * @date 2012-12-27 下午6:15:59
	 */
	@Override
	@Transactional(readOnly = true)
	public FuelConsumptionEntity loadFuelConsumption(
			FuelConsumptionDto fuelConsumptionDto) {
		//load油耗信息
		List<FuelConsumptionEntity> fuelConsumptionList = fuelConsumptionDao.queryFuelConsumptionById(fuelConsumptionDto);
		//如果没有查到
		if(fuelConsumptionList.size() < 1){
			//则抛出异常
			throw new TfrBusinessException("未找到此条油耗信息，请重新查询再操作","");
		}
		//查询油耗明细
		List<FuelDetailEntity> fuelDetailList = fuelConsumptionDao.queryFuelDetailById(fuelConsumptionDto);
		//添加到dto
		fuelConsumptionDto.setFuelDetailList(fuelDetailList);
		return fuelConsumptionList.get(0);
	}

	/**
	 * 查询需要导出的车辆油耗信息
	 * 
	 * @author 099995-foss-wujiangtao
	 * @date 2012-12-27 下午3:27:47
	 * @param fuelConsumptionDto
	 * @param start
	 * @param limit
	 * @return
	 */
	@Transactional(readOnly = true)
	public List<FuelConsonptionForExportDto> queryFuelConsumptionForExport(
			FuelConsumptionDto fuelConsumptionDto, int start, int limit) {
		//如果传入查询参数为空
		if(fuelConsumptionDto==null){
			//则抛出异常
			throw new TfrBusinessException("查询需要导出的车辆油耗信息参数不能为空","");
		}
		String transDepartment = this.isTransDepartment();
		//若当前部门为车队调度组，获取其配置的所属车队及其下属所有车队小组
		String currentDeptCode = FossUserContext.getCurrentDeptCode();
		MotorcadeEntity org = motorcadeService.queryMotorcadeByCode(currentDeptCode);
		if(null != org && StringUtils.equals("Y", org.getDispatchTeam())){
			this.transDepartmentNameList(org, fuelConsumptionDto);
		} else{
			//若是车队，则获取当前组织名称
			if ("YES".equals(transDepartment)) {
				String currentDeptName = "";
				if(FossUserContext.getCurrentInfo() != null) {
					currentDeptName = FossUserContext.getCurrentInfo().getCurrentDeptName();
				}
				fuelConsumptionDto.setCurrentDeptName(currentDeptName);
			}
			fuelConsumptionDto.setTransDepartment(transDepartment);
		}
		//查询需要导出的车辆油耗信息
		return fuelConsumptionDao.queryFuelConsumptionForExport(fuelConsumptionDto, start, limit);
	}


	/**
	 * @author niuly
	 * @date 2013-11-21下午1:48:07
	 * @function 根据发车记录ID查询对应的加油信息
	 * @return
	 */
	@Override
	public List<FuelDetailEntity> queryFuelDetailById(String id) {
		return fuelConsumptionDao.queryFuelDetailById(id);
	}

	/**
	 * @author niuly
	 * @date 2013-11-21下午3:26:52
	 * @function 根据发车记录id查询路桥费信息
	 * @param id
	 * @return
	 */
	@Override
	public List<FuelRoadTollEntity> queryFuelRoadTollById(String id) {
		return fuelConsumptionDao.queryFuelRoadTollById(id);
	}

	/**
	 * @author niuly
	 * @date 2013-11-23上午11:23:02
	 * @function 更新记录
	 * @param fuelVehicleEntity
	 * @param fuelConsumptionDto
	 * @param fuelDetailList
	 * @param fuelRoadTollList
	 */
	@Override
	@Transactional
	public void updateFuelConsumption(FuelVehicleEntity fuelVehicleEntity,
			FuelConsumptionDto fuelConsumptionDto,
			List<FuelDetailEntity> fuelDetailList,
			List<FuelRoadTollEntity> fuelRoadTollList) {
		//若为空，则抛出异常
		if(StringUtils.isBlank(fuelConsumptionDto.getId()) || StringUtils.isBlank(fuelConsumptionDto.getVehicleId())) {
			throw new TfrBusinessException("异常错误，请重新查询再操作！","");
		}
		
		List<FuelDetailEntity> detailAddlList = new ArrayList<FuelDetailEntity>();
		List<FuelDetailEntity> detailUpdateList = new ArrayList<FuelDetailEntity>();
		List<String> detailDeleteIdList = new ArrayList<String>();
		//查询出发车信息对应的加油信息
		List<FuelDetailEntity> dbDetailList = fuelConsumptionDao.queryFuelDetailById(fuelConsumptionDto.getId());
		//数据库中全部的油耗id
		for(FuelDetailEntity dbDetailEntiy:dbDetailList){
			detailDeleteIdList.add(dbDetailEntiy.getId());
		}
		Date createDate = new Date();
		String user = this.getUser();
		for(FuelDetailEntity detailEntity:fuelDetailList) {
			//若为新增加油信息，则插入数据
				String detailId = detailEntity.getId();
				if(StringUtils.isBlank(detailId)) {
					detailId = UUIDUtils.getUUID();
					detailEntity.setId(detailId);
					detailEntity.setDepartureId(fuelConsumptionDto.getId());
					detailEntity.setCreateDate(createDate);
					detailEntity.setCreateUser(user);
					
					detailAddlList.add(detailEntity);
				} else {
					detailUpdateList.add(detailEntity);
					if(detailDeleteIdList.contains(detailId)) {
						detailDeleteIdList.remove(detailId);
					}
				}
		}
		
		
		List<FuelRoadTollEntity> roadTollAddlList = new ArrayList<FuelRoadTollEntity>();
		List<FuelRoadTollEntity> roadTollUpdateList = new ArrayList<FuelRoadTollEntity>();
		List<String> roadTollDeleteIdList = new ArrayList<String>();
		//查询出发车信息对应的加油信息
		List<FuelRoadTollEntity> rollTollList = fuelConsumptionDao.queryFuelRoadTollById(fuelConsumptionDto.getId());
		//数据库中全部的油耗id
		for(FuelRoadTollEntity dbRoadTollEntiy:rollTollList){
			roadTollDeleteIdList.add(dbRoadTollEntiy.getId());
		}		
		
		for(FuelRoadTollEntity roadTollEntity:fuelRoadTollList) {
			String roadTollId = roadTollEntity.getId();
			if(StringUtils.isBlank(roadTollId)) {
				roadTollId =  UUIDUtils.getUUID();
				roadTollEntity.setId(roadTollId);
				roadTollEntity.setDepartureId(fuelConsumptionDto.getId());
				roadTollEntity.setCreateDate(createDate);
				roadTollEntity.setCreateUser(user);
				
				roadTollAddlList.add(roadTollEntity);
			}else {
				roadTollUpdateList.add(roadTollEntity);
				if(roadTollDeleteIdList.contains(roadTollId)) {
					roadTollDeleteIdList.remove(roadTollId);
				}
			}
		}
		
		//更新加油信息
		if(detailAddlList.size() > 0) {
			fuelConsumptionDao.addFuelDetail(detailAddlList);
		}
		if(detailUpdateList.size() > 0) {
			fuelConsumptionDao.updateFuelDetail(detailUpdateList);
		}
		if(detailDeleteIdList.size() > 0) {
			fuelConsumptionDao.deleteFuelDetailByIds(detailDeleteIdList);
		}
		//更新路桥费信息
		if(roadTollAddlList.size() > 0) {
			fuelConsumptionDao.addFuelRoadToll(roadTollAddlList);
		}
		if(roadTollUpdateList.size() > 0) {
			fuelConsumptionDao.updateRoadToll(roadTollUpdateList);
		}
		if(roadTollDeleteIdList.size() > 0) {
			fuelConsumptionDao.deleteRoadTollByIds(roadTollDeleteIdList);
		}
		
		//更新发车信息
		fuelConsumptionDao.updateDeparture(fuelConsumptionDto);
		//更新车辆信息
		fuelVehicleEntity.setId(fuelConsumptionDto.getVehicleId());
		fuelConsumptionDao.updateVehicle(fuelVehicleEntity);
	}

	/**
	 * @author niuly
	 * @date 2013-11-26下午7:45:27
	 * @function 根据查询条件查询信息总计
	 * @param fuelConsumptionDto
	 * @return
	 */
	@Override
	public FuelConsumptionTotalDto queryTotalInfo(FuelConsumptionDto fuelConsumptionDto) {
		return fuelConsumptionDao.queryTotalInfo(fuelConsumptionDto);
	}

	/**
	 * @author niuly
	 * @date 2013-11-27上午9:36:14
	 * @function 根据配载车次号查询配载信息
	 * @param assemblyNo
	 * @return
	 */
	@Override
	public FuelConsumptionDto queryAssemblyList(String assemblyNo) {
		List<VehicleAssembleBillEntity> assemblyList = vehicleAssembleBillService.queryVehicleAssembleBillByNo(assemblyNo);
		QueryVehicleAssembleBillDto dto = vehicleAssembleBillService.queryVehicleAssembleBillInfoByBillNo(assemblyNo);
		VehicleAssembleBillEntity entity = new VehicleAssembleBillEntity();
		if(assemblyList != null && assemblyList.size() > 0) {
			entity = assemblyList.get(0);
		}
		FuelConsumptionDto fuelConsumptionDto = new FuelConsumptionDto();
		fuelConsumptionDto.setAssemblyNo(entity.getVehicleAssembleNo());
		fuelConsumptionDto.setDepartureDate(dto.getDepartTime());
		fuelConsumptionDto.setDeptRegionCode(entity.getOrigOrgCode());
		fuelConsumptionDto.setDeptRegionName(entity.getOrigOrgName());
		fuelConsumptionDto.setArrvRegionCode(entity.getDestOrgCode());
		fuelConsumptionDto.setArrvRegionName(entity.getDestOrgName());
		fuelConsumptionDto.setLineName(dto.getLine());
		fuelConsumptionDto.setActualLoad(dto.getWeightTotal());
		fuelConsumptionDto.setVolume(dto.getVolumeTotal());
		fuelConsumptionDto.setDriver1Code(entity.getDriverCode());
		fuelConsumptionDto.setDriver1Name(entity.getDriverName());
		return fuelConsumptionDto;
	}

	/**
	 * @author niuly
	 * @date 2013-11-28上午10:02:05
	 * @function 校验excel数据是否满足标准
	 * @param excelDtos
	 */
	private void valiedate(List<FuelStandardExcelDto> excelDtos) {
		Set<String> set = new HashSet<String>();
		int size = 0;
		//Collection 
		//判断年月和车牌号是否重复，若重复则抛出异常
		for(FuelStandardExcelDto dto : excelDtos) {
			Date time = dto.getFuelTime();
			SimpleDateFormat  sf = new SimpleDateFormat ("yyyy-MM");
			String vehicleNo = dto.getVehicleNo();
			String value = vehicleNo + sf.format(time);
			size++;
			set.add(value);
			//有重复数据
			if(size > set.size()) {
				throw new BusinessException("时间："+ sf.format(time) + "，车牌号："+ vehicleNo +"重复，请检查导入数据","");
			}
		}
	}
	/**
	 * @author niuly
	 * @date 2013-11-30上午10:15:26
	 * @function 判断是否闰年
	 * @param year
	 * @return
	 */
	 private boolean isLeapYear(int year) {
	        boolean isLeapYear = false;
	        if ((year % ConstantsNumberSonar.SONAR_NUMBER_4 == 0 && year % ConstantsNumberSonar.SONAR_NUMBER_100 != 0) || year % ConstantsNumberSonar.SONAR_NUMBER_400 == 0) {
	        	isLeapYear = true;
	        }else{
	        	isLeapYear = false;
	        }
	        return isLeapYear;
	    }
	/**
	 * @author niuly
	 * @date 2013-11-30上午9:59:17
	 * @function 获取一个月的天数
	 * @return
	 */
	private int getDaysOfMonth(Date date) {
		Calendar cal=Calendar.getInstance();
		cal.setTime(date);
		System.out.println(date);
		System.out.println(cal.get(Calendar.YEAR));
		System.out.println(cal.get(Calendar.MONTH ) + 1);
		System.out.println(cal.get(Calendar.DATE));
		int day = 0;
		int year = cal.get(Calendar.YEAR);
		boolean isLeapYear = false;
		isLeapYear = this.isLeapYear(year);
		int month = cal.get(Calendar.MONTH) + 1;
		switch(month) 
		{ 
		   case 1: 
		   case ConstantsNumberSonar.SONAR_NUMBER_3: 
		   case ConstantsNumberSonar.SONAR_NUMBER_5: 
		   case ConstantsNumberSonar.SONAR_NUMBER_7: 
		   case ConstantsNumberSonar.SONAR_NUMBER_8: 
		   case ConstantsNumberSonar.SONAR_NUMBER_10: 
		   case ConstantsNumberSonar.SONAR_NUMBER_12: 
		         day = ConstantsNumberSonar.SONAR_NUMBER_31; 
		         break; 
		   case 2: 
			    if(!isLeapYear) {
			    	day = ConstantsNumberSonar.SONAR_NUMBER_28; 
			    } else {
			    	day = ConstantsNumberSonar.SONAR_NUMBER_29;
			    }
		         break; 
		   case ConstantsNumberSonar.SONAR_NUMBER_4: 
		   case ConstantsNumberSonar.SONAR_NUMBER_6: 
		   case ConstantsNumberSonar.SONAR_NUMBER_9: 
		   case ConstantsNumberSonar.SONAR_NUMBER_11: 
		          day = ConstantsNumberSonar.SONAR_NUMBER_30; 
		          break; 
		} 
		return day;
	}
	/**
	 * @author niuly
	 * @date 2013-11-28上午8:40:07
	 * @function  批量导入油耗标准
	 * @param excelDtos
	 * @return int
	 */
	@Override
	@Transactional
	public int batchImportFuleList(List<FuelStandardExcelDto> excelDtos) {
		//校验数据是否重复
		valiedate(excelDtos);
		
		FuelStandardExcelDto dto = excelDtos.get(0);
		Date date = dto.getFuelTime();
		int days = this.getDaysOfMonth(date);
		
		for (int i =0;i < excelDtos.size();i++)  {
			FuelStandardExcelDto dto1 = excelDtos.get(i);
			//删除该月该车已有数据
			fuelConsumptionDao.delFuelStdByDateAndVehiNo(dto1);
		}
		//对每个月每一条油耗标准进行再次分解，分解至每一天
		return fuelConsumptionDao.batchImportFuleList(excelDtos,days);
	}

	/**
	 * @author niuly
	 * @date 2013-11-28下午3:06:55
	 * @function 分页查询油耗标准
	 * @param fuelStandardEntity
	 * @param start
	 * @param limit
	 * @return
	 */
	@Override
	public List<FuelStandardExcelDto> queryFuelStandard(FuelStandardExcelDto fuelStandardExcelDto, int start, int limit) {
		//查询油耗标准信息
		return fuelConsumptionDao.queryFuelStandard(fuelStandardExcelDto, start, limit);
	}

	/**
	 * @author niuly
	 * @date 2013-11-28下午3:07:12
	 * @function 查询油耗标准总条数，用于分页
	 * @param fuelStandardEntity
	 * @return
	 */
	@Override
	public Long getFuelStandardCount(FuelStandardExcelDto fuelStandardExcelDto) {
		//查询油耗标准信息总条数
		return fuelConsumptionDao.getFuelStandardCount(fuelStandardExcelDto);
	}

	/**
	 * @author niuly
	 * @date 2013-11-28下午5:32:36
	 * @function 删除油耗标准
	 * @param id
	 */
	@Override
	public int deleteFuelStandard(String id) {
		return fuelConsumptionDao.deleteFuelStandard(id);
	}

	/**
	 * @author niuly
	 * @date 2013-11-28下午5:33:13
	 * @function  更新油耗标准
	 * @param fuelStandardExcelDto
	 */
	@Override
	public int updateFuelStandard(FuelStandardExcelDto fuelStandardExcelDto) {
		return fuelConsumptionDao.updateFuelStandard(fuelStandardExcelDto);
	}

	/**
	 * @author niuly
	 * @date 2013-11-28下午5:49:35
	 * @function 新增油耗标准
	 * @param fuelStandardExcelDto
	 */
	/*@Override
	public int addFuelStandard(FuelStandardExcelDto fuelStandardExcelDto) {
		String id = UUIDUtils.getUUID();
		String userCode = "";
		String userName = "";
		if(FossUserContext.getCurrentInfo() != null) {
			userCode = FossUserContext.getCurrentInfo().getEmpCode();
			userName = FossUserContext.getCurrentInfo().getEmpName();
		}
		String user = new StringBuffer(userCode).append(",").append(new StringBuffer(userName)).toString();
		fuelStandardExcelDto.setId(id);
		fuelStandardExcelDto.setCreateUser(user);
		return fuelConsumptionDao.addFuelStandard(fuelStandardExcelDto);
	}*/

	/**
	 * @author niuly
	 * @date 2013-11-30下午12:56:52
	 * @function 查询该月车牌号记录条数
	 * @param fuelStandardExcelDto
	 * @return
	 */
	@Override
	public Long queryFuelStandardCount(FuelStandardExcelDto dto) {
		return fuelConsumptionDao.queryFuelStandardCount(dto);
	}

	/**
	 * @author niuly
	 * @date 2013-12-4下午7:03:53
	 * @function 根据车牌号和发车日期查询油耗标准值
	 * @paramfuelConsumptionDto
	 * @return
	 */
	@Override
	public BigDecimal queryFuelStandardValue(FuelConsumptionDto fuelConsumptionDto) {
		BigDecimal standard = null;
		List<BigDecimal> standardList = fuelConsumptionDao.queryFuelStandardValue(fuelConsumptionDto);
		if(standardList != null && standardList.size() > 0) {
			standard = standardList.get(0);
		}
		return standard;
	}
	
}