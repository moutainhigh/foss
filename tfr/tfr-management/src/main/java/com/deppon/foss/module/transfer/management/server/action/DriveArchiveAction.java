/**
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 *  initial comments.
 */
/*******************************************************************************
 * Copyright 2013 TFR TEAM
 *  
 *  Licensed under the DEPPON License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *  
 *     http://www.deppon.com/licenses/LICENSE-2.0
 *  
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *  Contributors:
 *  038300-foss-pengzhen - initial API and implementation
 * 
 *  PROJECT NAME  : tfr-management
 *  
 *  FILE PATH     : src/main/java/com/deppon/foss/module/transfer/management/server/action/DriveArchiveAction.java
 *  
 *  FILE NAME          :DriveArchiveAction.java
 * 
 *  AUTHOR  : FOSS中转系统开发组
 *  
 *  TIME              : 
 *  
 *  HOME PAGE    :  http://www.deppon.com
 * 
 *  COPYRIGHT    : Copyright (c) 2013  Deppon All Rights Reserved.
 ******************************************************************************/
package com.deppon.foss.module.transfer.management.server.action;

import java.util.List;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;

import com.deppon.foss.framework.exception.BusinessException;
import com.deppon.foss.framework.server.web.action.AbstractAction;
import com.deppon.foss.framework.server.web.result.json.annotation.JSON;
import com.deppon.foss.module.transfer.common.api.shared.exception.TfrBusinessException;
import com.deppon.foss.module.transfer.management.api.server.service.IDriveArchiveService;
import com.deppon.foss.module.transfer.management.api.shared.define.FuelConsonptionConstants;
import com.deppon.foss.module.transfer.management.api.shared.domain.DriveArchiveEntity;
import com.deppon.foss.module.transfer.management.api.shared.dto.DriveArchiveDto;
import com.deppon.foss.module.transfer.management.api.shared.dto.DriveArchiveLineInfoDto;
import com.deppon.foss.module.transfer.management.api.shared.dto.DriveArchiveVehicleInfoDto;
import com.deppon.foss.module.transfer.management.api.shared.vo.DriveArchiveVo;
import com.deppon.foss.module.transfer.scheduling.api.shared.util.ConstantsNumberSonar;

/**
 * 车辆行驶档案相关操作
 * @author foss-liuxue(for IBM)
 * @date 2012-11-8 上午10:51:06
 */
public class DriveArchiveAction extends AbstractAction {
	
	/**
	 * 日志
	 */
	private static final Logger LOGGER = LogManager.getLogger(DriveArchiveAction.class);

	/**
	 * 序列化
	 */
	private static final long serialVersionUID = -2266790599224268926L;

	/**
	 * spring注入
	 */
	private IDriveArchiveService driveArchiveService;
	
	/**
	 * 行驶档案vo
	 */
	private DriveArchiveVo driveArchiveVo = new DriveArchiveVo();

	/**
	 * 获取 行驶档案vo.
	 *
	 * @return the 行驶档案vo
	 */
	public DriveArchiveVo getDriveArchiveVo() {
		return driveArchiveVo;
	}
	
	/**
	 * 设置 行驶档案vo.
	 *
	 * @param driveArchiveVo the new 行驶档案vo
	 */
	public void setDriveArchiveVo(DriveArchiveVo driveArchiveVo) {
		this.driveArchiveVo = driveArchiveVo;
	}
	
	/**
	 * 设置 spring注入.
	 *
	 * @param driveArchiveService the new spring注入
	 */
	public void setDriveArchiveService(IDriveArchiveService driveArchiveService) {
		this.driveArchiveService = driveArchiveService;
	}
	/**
	 * 根据查询条件查询行驶档案
	 * @author foss-liuxue(for IBM)
	 * @date 2012-10-29 15:51:17
	 */
	@JSON
	public String queryDriveArchive(){
		try{
			DriveArchiveDto driveArchiveDto = driveArchiveVo.getDriveArchiveDto();
			//如果是否晚到两个都勾选了，则替换为空
			if(StringUtils.equals(driveArchiveDto.getIsLateArrive(), FuelConsonptionConstants.YES_AND_NO)){
				driveArchiveDto.setIsLateArrive("");
			}
			//如果是否晚发两个都勾选了，则替换为空
			if(StringUtils.equals(driveArchiveDto.getIsLateDeparture(), FuelConsonptionConstants.YES_AND_NO)){
				driveArchiveDto.setIsLateDeparture("");
			}
			//如果是否对发两个都勾选了，则替换为空
			if(StringUtils.equals(driveArchiveDto.getIsMutual(), FuelConsonptionConstants.YES_AND_NO)){
				driveArchiveDto.setIsMutual("");
			}
			
			this.check(driveArchiveDto);
			
			//查询行驶档案
			List<DriveArchiveEntity> driveArchiveList = driveArchiveService.queryDriveArchive(driveArchiveDto,this.getStart(),this.getLimit());
			//获取总条数
			Long totalCount = driveArchiveService.getCount(driveArchiveDto);
			driveArchiveVo.setDriveArchiveList(driveArchiveList);
			//设置总条数
			this.setTotalCount(totalCount);
			return returnSuccess();
		}catch(BusinessException e){
			//打印异常日志
			LOGGER.error(e);
			return returnError(e);
		}
	}
	
	/**
	 * 根据ID查询行驶档案
	 * @author foss-liuxue(for IBM)
	 * @date 2012-10-29 15:52:23
	 */
	@JSON
	public String displayDriveArchiveDetail(){
		try{
			//根据ID查询行驶档案
			DriveArchiveEntity driveArchiveEntity = driveArchiveService.displayDriveArchiveDetail(driveArchiveVo.getId());
			driveArchiveVo.setDriveArchiveEntity(driveArchiveEntity);
			return returnSuccess();
		}catch(BusinessException e){
			//打印异常日志
			LOGGER.error(e);
			return returnError(e);
		}
	}
	/**
	 * 执行sava/update操作
	 * @author foss-liuxue(for IBM)
	 * @date 2012-10-29 15:53:19
	 */
	@JSON
	public String saveOrUpdate(){
		try{
			
			this.check(driveArchiveVo.getDriveArchiveDto());
			//执行sava/update操作
			driveArchiveService.saveOrUpdate(driveArchiveVo.getDriveArchiveDto());
			return returnSuccess();
		}catch(BusinessException e){
			//打印异常日志
			LOGGER.error(e);
			return returnError(e);
		}
	}
	/**
	 * 删除选中的记录
	 * @author foss-liuxue(for IBM)
	 * @date 2012-10-29 15:53:53
	 */
	@JSON
	public String delete(){
		try{
			//删除选中的记录
			driveArchiveService.deleteByPrimaryKey(driveArchiveVo.getId());
			return returnSuccess();
		}catch(BusinessException e){
			//打印异常日志
			LOGGER.error(e);
			return returnError(e);
		}
	}
	/**
	 * 根据车牌号获取车辆信息
	 * @author foss-liuxue(for IBM)
	 * @date 2012-12-21 下午4:12:26
	 */
	@JSON
	public String queryVehicleInfo(){
		try{
			//根据车牌号获取车辆信息
			DriveArchiveEntity driveArchiveEntity = driveArchiveService.queryVehicleInfo(driveArchiveVo.getDriveArchiveDto());
			driveArchiveVo.setDriveArchiveEntity(driveArchiveEntity);
			return returnSuccess();
		}catch(BusinessException e){
			//打印异常日志
			LOGGER.error(e);
			return returnError(e);
		}
	}
	
	/**
	 * 根据配载号查询车辆信息
	 * @author foss-liuxue(for IBM)
	 * @date 2012-12-29 下午4:29:43
	 */
	@JSON
	public String queryVehicleNoByVehicleAssembleNo(){
		try{
			//根据配载号查询车辆信息
			DriveArchiveVehicleInfoDto driveArchiveVehicleInfoDto = driveArchiveService.queryVehicleNoByVehicleAssembleNo(driveArchiveVo.getDriveArchiveDto());
			driveArchiveVo.setArchiveVehicleInfoDto(driveArchiveVehicleInfoDto);
			return returnSuccess();
		}catch(BusinessException e){
			//打印异常日志
			LOGGER.error(e);
			return returnError(e);
		}
	}
	
	/**
	 * 根据班次号和线路带出预计发车日期，预计到达日期，标准时效
	 * @author foss-liuxue(for IBM)
	 * @date 2013-1-4 下午3:59:44
	 */
	public String queryLineInfoByLineSequence(){
		try{
			//根据班次号和线路带出预计发车日期，预计到达日期，标准时效
			DriveArchiveLineInfoDto driveArchiveLineInfoDto = driveArchiveService.queryLineInfoByLineSequence(driveArchiveVo.getDriveArchiveDto());
			driveArchiveVo.setDriveArchiveLineInfoDto(driveArchiveLineInfoDto);
			return returnSuccess();
		}catch(BusinessException e){
			//打印异常日志
			LOGGER.error(e);
			return returnError(e);
		}
	}
	
	private void check(DriveArchiveDto driveArchiveDto){
		// check
		// 长度已超过最大限制!
		if (StringUtils.isNotBlank(driveArchiveDto.getVehicleBrand())) {
			if (driveArchiveDto.getVehicleBrand().getBytes().length > ConstantsNumberSonar.SONAR_NUMBER_200) {
				throw new TfrBusinessException("长度已超过最大限制!");
			}
		} else if (StringUtils.isNotBlank(driveArchiveDto.getFineType())) {
			if (driveArchiveDto.getFineType().getBytes().length > ConstantsNumberSonar.SONAR_NUMBER_200) {
				throw new TfrBusinessException("长度已超过最大限制!");
			}
		}
	}
	
}