/**
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 *  initial comments.
 */
/*******************************************************************************
 * Copyright 2013 TFR TEAM
 *  
 *  Licensed under the DEPPON License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *  
 *     http://www.deppon.com/licenses/LICENSE-2.0
 *  
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *  Contributors:
 *  038300-foss-pengzhen - initial API and implementation
 * 
 *  PROJECT NAME  : tfr-airfreight
 *  
 * package_name  : 
 *  
 *  FILE PATH          :/AirHandOverBillAction.java
 * 
 *  FILE NAME          :AirHandOverBillAction.java
 *  
 *  AUTHOR  : FOSS中转系统开发组
 *  
 *  TIME              : 
 *  
 *  HOME PAGE    :  http://www.deppon.com
 *  
 *  COPYRIGHT    : Copyright (c) 2013  Deppon All Rights Reserved.
 ******************************************************************************/
package com.deppon.foss.module.transfer.airfreight.server.action;

import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.deppon.foss.framework.exception.BusinessException;
import com.deppon.foss.framework.server.web.action.AbstractAction;
import com.deppon.foss.framework.server.web.result.json.annotation.JSON;
import com.deppon.foss.framework.shared.util.string.StringUtil;
import com.deppon.foss.module.base.baseinfo.api.server.service.IOrgAdministrativeInfoService;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.OrgAdministrativeInfoEntity;
import com.deppon.foss.module.transfer.airfreight.api.server.service.IAirHandOverBillService;
import com.deppon.foss.module.transfer.airfreight.api.shared.domain.AirHandOverBillDetailEntity;
import com.deppon.foss.module.transfer.airfreight.api.shared.domain.AirHandOverBillEntity;
import com.deppon.foss.module.transfer.airfreight.api.shared.dto.AirHandOverBillDto;
import com.deppon.foss.module.transfer.airfreight.api.shared.vo.AirHandOverBillVO;
import com.deppon.foss.module.transfer.common.api.shared.exception.TfrBusinessException;

/**
 * 正单交接单相关操作.
 * @author foss-liuxue(for IBM)
 * @date 2012-10-24 16:10:14
 */

public class AirHandOverBillAction extends AbstractAction {
	
	/** 序列化. */
	private static final long serialVersionUID = -5890601928617043287L;
	
	/** 日志. */
	private static final Logger LOGGER = LoggerFactory.getLogger(AirHandOverBillAction.class);
	
	/** 正单交接单服务. */
	private IAirHandOverBillService airHandOverBillService;
	
	/** 航空正单VO. */
	private AirHandOverBillVO airHandOverBillVO = new AirHandOverBillVO();
	
	/** 综合接口 **/
	private IOrgAdministrativeInfoService orgAdministrativeInfoService;
	
	/**
	 * Gets the air hand over bill vo.
	 *
	 * @return the air hand over bill vo
	 */
	public AirHandOverBillVO getAirHandOverBillVO() {
		return airHandOverBillVO;
	}

	/**
	 * Sets the air hand over bill vo.
	 *
	 * @param airHandOverBillVO the new air hand over bill vo
	 */
	public void setAirHandOverBillVO(AirHandOverBillVO airHandOverBillVO) {
		this.airHandOverBillVO = airHandOverBillVO;
	}

	
	public void setOrgAdministrativeInfoService(
			IOrgAdministrativeInfoService orgAdministrativeInfoService) {
		this.orgAdministrativeInfoService = orgAdministrativeInfoService;
	}

	/**
	 * Sets the air hand over bill service.
	 *
	 * @param airHandOverBillService the new air hand over bill service
	 */
	public void setAirHandOverBillService(
			//定义空余交接单服务
			IAirHandOverBillService airHandOverBillService) {
		//返回交接单service
		this.airHandOverBillService = airHandOverBillService;
	}

	/**
	 * 查询所有航空正单交接单信息.
	 * @return the string
	 * @author foss-liuxue(for IBM)
	 * @date 2012-10-31 9:48:44
	 */
	@JSON
	public String queryAirHandOverBill(){
		//异常处理
		try{
			AirHandOverBillDto airHandOverBillDto = airHandOverBillVO.getAirHandOverBillDto();
			//查询所有未作废的航空正单交接单信息
			List<AirHandOverBillEntity> airHandOverBillList = airHandOverBillService.queryAirHandOverBillNew(airHandOverBillDto,this.getStart(),this.getLimit());
			//获取总记录条数,用于分页
			Long totalCount = airHandOverBillService.getCount(airHandOverBillDto);
			//填充到VO用于界面显示列表
			airHandOverBillVO.setAirHandOverBillList(airHandOverBillList);
			//分页总数
			this.setTotalCount(totalCount);
			//返回成功信息
			return returnSuccess();
		}catch(BusinessException e){
			//抛出异常
			//写入日志
			LOGGER.error(e.getMessage(), e);
			//返回错误信息
			return returnError(e);
		}
	}
	
	/**
	 * 出库操作.
	 *
	 * @return the string
	 * @author foss-liuxue(for IBM)
	 * @date 2012-10-31 10:03:01
	 */
	@JSON
	public String outStockAirHandOverBill(){
		//异常处理
		try{
			//出库正单交接单中明细
			airHandOverBillService.outStockAirHandOverBill(airHandOverBillVO.getAirHandOverBillDtos());
			//返回成功信息
			return returnSuccess();
		}catch(BusinessException e){
			//出错日志
			//写入错误信息
			LOGGER.error(e.getMessage(), e);
			//返回错误信息
			return returnError(e);
		}
	}
	
	/**
	 * 查询航空正单交接单明细.
	 *
	 * @return the string
	 * @author foss-liuxue(for IBM)
	 * @date 2012-11-5 10:21:00
	 */
	@JSON
	public String queryHandOverAirWaybill(){
		try{
			//从界面获取airHandOverBillDto
			AirHandOverBillDto airHandOverBillDto = airHandOverBillVO.getAirHandOverBillDto();
			//根据条件查询航空正单交接单明细，带分页
			List<AirHandOverBillDetailEntity> airHandOverBillDetailList = airHandOverBillService.queryHandOverAirWaybill(airHandOverBillDto,this.getStart(),this.getLimit());
			//设定VO
			airHandOverBillVO.setAirHandOverBillDetailList(airHandOverBillDetailList);
			//返回成功信息
			return returnSuccess();
		}catch(BusinessException e){
			//抛出异常
			//出错日志
			LOGGER.error(e.getMessage(), e);
			//返回错误信息
			return returnError(e);
		}
	}
	
	/**
	 * 生成或修改航空正单交接单.
	 *
	 * @return the string
	 * @author foss-liuxue(for IBM)
	 * @date 2012-11-6 10:33:39
	 */
	@JSON
	public String saveOrUpdateAirHandOverBill(){
		//异常处理
		try{
			//获取交接单dto
			AirHandOverBillDto airHandOverBillDto = airHandOverBillVO.getAirHandOverBillDto();
			//service中判断是保存或更新操作
			airHandOverBillService.saveOrUpdateAirHandOverBill(airHandOverBillDto);
			return returnSuccess();
		}catch(BusinessException e){
			//出错日志
			//错误信息写入
			LOGGER.error(e.getMessage(), e);
			//返回错误信息
			return returnError(e);
		}
	}
	
	/**
	 * 根据正单号单个添加正单到正单明细列表.
	 *
	 * @return the string
	 * @author foss-liuxue(for IBM)
	 * @date 2012-11-6 17:17:01
	 */
	@JSON
	public String querySingleAirWaybill(){
		//异常处理
		try{
			//从界面获取airHandOverBillDto
			AirHandOverBillDto airHandOverBillDto = airHandOverBillVO.getAirHandOverBillDto();
			//查询单个正单信息
			AirHandOverBillDetailEntity airHandOverBillDetailEntity = airHandOverBillService.querySingleAirWaybill(airHandOverBillDto);
			//设置 航空正单明细的实体到界面
			airHandOverBillVO.setAirHandOverBillDetailEntity(airHandOverBillDetailEntity);
			return returnSuccess();
		}catch(BusinessException e){
			//出错日志
			LOGGER.error(e.getMessage(), e);
			return returnError(e);
		}
	}
	
	/**
	 * 根据交接单ID查询交接单及明细信息用于load在修改页面.
	 *
	 * @return the string
	 * @author foss-liuxue(for IBM)
	 * @date 2012-11-7 16:33:41
	 */
	@JSON
	public String loadAirHandOverBillInfo(){
		//异常处理
		try{
			//通过交接单ID获取交接单信息
			AirHandOverBillDto airHandOverBillDto = airHandOverBillService.loadAirHandOverBillInfo(airHandOverBillVO.getAirHandOverBillDto().getId());
			//设置 航空正单明细到界面
			airHandOverBillVO.setAirHandOverBillDto(airHandOverBillDto);
			return returnSuccess();
		}catch(BusinessException e){
			//出错日志
			//写入日志报错信息
			LOGGER.error(e.getMessage(), e);
			//返回错误信息
			return returnError(e);
		}
	}
	
	/**
	 * 查询起飞时间.
	 *
	 * @return the string
	 * @author foss-liuxue(for IBM)
	 * @date 2012-12-7 下午3:06:25
	 */
	@JSON
	public String queryTakeOffTime(){
		//异常处理
		try{
			AirHandOverBillDto airHandOverBillDto = airHandOverBillVO.getAirHandOverBillDto();
			//查询起飞时间
			String takeOffTime = airHandOverBillService.queryTakeOffTime(airHandOverBillDto);
			//设置起飞时间
			airHandOverBillDto.setTakeOffTime(takeOffTime);
			//返回成功信息
			return returnSuccess();
		}catch(BusinessException e){
			//出错日志
			//写入错误信息
			LOGGER.error(e.getMessage(), e);
			//返回错误信息
			return returnError(e);
		}
	}
	
	/**
	 * 生成航空正单交接单单号.
	 *
	 * @return the air hand over bill no
	 * @author foss-liuxue(for IBM)
	 * @date 2013-1-10 下午4:43:23
	 */
	@JSON
	public String getAirHandOverBillNo(){
		//异常处理
		try{
			//获取生成交接单号
			airHandOverBillVO.setAirHandOverBillNo(airHandOverBillService.getAirHandOverBillNo());
			//返回成功信息
			return returnSuccess();
		}catch(BusinessException e){
			//出错日志
			//写入错误信息
			LOGGER.error(e.getMessage(), e);
			//返回错误信息
			return returnError(e);
		}
	}
	
	/**
	 * @desc 判断快递货中的目的站与当前交接单中的下一个外场是否同属一个城市
	 * @author wqh
	 * @date 2015-08-22
	 * */
	@JSON
	public String judgeExpressAddress(){
		//异常处理
		try{
			//获取交接单dto
			AirHandOverBillDto airHandOverBillDto = airHandOverBillVO.getAirHandOverBillDto();
			//获取航空正单明细
			List<AirHandOverBillDetailEntity> airHandOverBillDetailList = airHandOverBillDto.getAirHandOverBillDetailList();

			//获取下一部门  code

			String nextOrgCode=airHandOverBillDto.getExpressArriveCode();
			//在根据部门code查找部门所属的城市
			
			OrgAdministrativeInfoEntity orgAdministrativeInfoEntity=orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(nextOrgCode);
			
			if(orgAdministrativeInfoEntity!=null&&StringUtil.isNotEmpty( orgAdministrativeInfoEntity.getCityName())){
				String destCityName=orgAdministrativeInfoEntity.getCityName();
				for(AirHandOverBillDetailEntity detail:airHandOverBillDetailList){
					
					if(!destCityName.contains(detail.getArrvRegionName())){
						throw new TfrBusinessException("单号:【"+detail.getAirWaybillNo()+"】 到达城市与所选目的站到达城市不一致!");
					}
					
				}
				
				
			}
			return returnSuccess();
		}catch(TfrBusinessException e){
			//出错日志
			//错误信息写入
			LOGGER.error(e.getMessage(), e);
			//返回错误信息
			return returnError(e);
		}

	}
	
}