/**
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 *  initial comments.
 */
/*******************************************************************************
 * Copyright 2013 TFR TEAM
 *  
 *  Licensed under the DEPPON License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *  
 *     http://www.deppon.com/licenses/LICENSE-2.0
 *  
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *  Contributors:
 *  038300-foss-pengzhen - initial API and implementation
 * 
 *  PROJECT NAME  : tfr-airfreight
 *  
 *  FILE PATH     : src/main/java/com/deppon/foss/module/transfer/airfreight/server/service/impl/AirHandOverBillService.java
 *  
 *  FILE NAME          :AirHandOverBillService.java
 * 
 *  AUTHOR  : FOSS中转系统开发组
 *  
 *  TIME              : 
 *  
 *  HOME PAGE    :  http://www.deppon.com
 * 
 *  COPYRIGHT    : Copyright (c) 2013  Deppon All Rights Reserved.
 ******************************************************************************/
package com.deppon.foss.module.transfer.airfreight.server.service.impl;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.transaction.annotation.Transactional;

import com.deppon.foss.framework.shared.util.string.StringUtil;
import com.deppon.foss.module.base.baseinfo.api.server.service.IGoodsAreaService;
import com.deppon.foss.module.base.baseinfo.api.server.service.IOutfieldService;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.GoodsAreaEntity;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.OrgAdministrativeInfoEntity;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.OutfieldEntity;
import com.deppon.foss.module.base.dict.api.shared.define.DictionaryValueConstants;
import com.deppon.foss.module.frameworkimpl.server.context.FossUserContext;
import com.deppon.foss.module.pickup.pricing.dubbo.api.server.service.IProductService;
import com.deppon.foss.module.pickup.waybill.api.server.service.IWaybillManagerService;
import com.deppon.foss.module.pickup.waybill.shared.domain.WaybillEntity;
import com.deppon.foss.module.transfer.airfreight.api.define.AirfreightConstants;
import com.deppon.foss.module.transfer.airfreight.api.server.dao.IAirHandOverBillDao;
import com.deppon.foss.module.transfer.airfreight.api.server.service.IAirDispatchUtilService;
import com.deppon.foss.module.transfer.airfreight.api.server.service.IAirHandOverBillService;
import com.deppon.foss.module.transfer.airfreight.api.shared.domain.AirHandOverBillDetailEntity;
import com.deppon.foss.module.transfer.airfreight.api.shared.domain.AirHandOverBillEntity;
import com.deppon.foss.module.transfer.airfreight.api.shared.domain.AirUnshippedSerialNoEntity;
import com.deppon.foss.module.transfer.airfreight.api.shared.dto.AirHandOverBillDto;
import com.deppon.foss.module.transfer.airfreight.api.shared.dto.AirHandOverBillGetSerialNoDto;
import com.deppon.foss.module.transfer.airfreight.api.shared.dto.AirHandOverStateDto;
import com.deppon.foss.module.transfer.common.api.server.service.ITfrCommonService;
import com.deppon.foss.module.transfer.common.api.shared.define.TfrSerialNumberRuleEnum;
import com.deppon.foss.module.transfer.common.api.shared.exception.TfrBusinessException;
import com.deppon.foss.module.transfer.scheduling.api.define.TransportPathConstants;
import com.deppon.foss.module.transfer.scheduling.api.server.service.ICalculateTransportPathService;
import com.deppon.foss.module.transfer.stock.api.define.StockConstants;
import com.deppon.foss.module.transfer.stock.api.server.service.IStockService;
import com.deppon.foss.module.transfer.stock.api.shared.domain.InOutStockEntity;
import com.deppon.foss.util.CollectionUtils;
import com.deppon.foss.util.DateUtils;
import com.deppon.foss.util.UUIDUtils;

/**
 * 正单交接单相关操作
 * @author foss-liuxue(for IBM)
 * @date 2012-10-24 16:10:14
 */
public class AirHandOverBillService implements IAirHandOverBillService {
	
	/** 日志. */
	private static final Logger LOGGER = LoggerFactory.getLogger(AirHandOverBillService.class);
	
	/**
	 * 正单交接单dao
	 */
	private IAirHandOverBillDao airHandOverBillDao;
	/**
	 * 中转公共类，用于生成正单交接单号
	 */
	private ITfrCommonService tfrCommonService; 
	/**
	 * 库存服务
	 */
	private IStockService stockService;
	
	/**
	 * 外场serive
	 */
	private IOutfieldService outfieldService;
	
	/**
	 * 货区service
	 */
	private IGoodsAreaService goodsAreaService;
	
	/**
	 * 走货路径service
	 */
	private ICalculateTransportPathService calculateTransportPathService;
	
	/**
	 * 获取上级空运总调
	 */
	private IAirDispatchUtilService airDispatchUtilService;
	
	private IWaybillManagerService  waybillManagerService;
	
	@Resource
	private IProductService  productService4Dubbo; 
	
	/**
	 * 设置 获取上级空运总调.
	 *
	 * @param airDispatchUtilService the new 获取上级空运总调
	 */
	public void setAirDispatchUtilService(
			IAirDispatchUtilService airDispatchUtilService) {
		this.airDispatchUtilService = airDispatchUtilService;
	}

	/**
	 * 设置 走货路径service.
	 *
	 * @param calculateTransportPathService the new 走货路径service
	 */
	public void setCalculateTransportPathService(
			ICalculateTransportPathService calculateTransportPathService) {
		this.calculateTransportPathService = calculateTransportPathService;
	}
	
	//设置库存service
	/**
	 * 设置 库存服务.
	 *
	 * @param stockService the new 库存服务
	 */
	public void setStockService(IStockService stockService) {
		//返回service
		this.stockService = stockService;
	}
	//设置交接单dao
	/**
	 * 设置 正单交接单dao.
	 *
	 * @param airHandOverBillDao the new 正单交接单dao
	 */
	public void setAirHandOverBillDao(IAirHandOverBillDao airHandOverBillDao) {
		//获取交接单dao
		this.airHandOverBillDao = airHandOverBillDao;
	}
	//设置中转一般service
	/**
	 * 设置 中转公共类，用于生成正单交接单号.
	 *
	 * @param tfrCommonService the new 中转公共类，用于生成正单交接单号
	 */
	public void setTfrCommonService(ITfrCommonService tfrCommonService) {
		//获取tfrCommonService
		this.tfrCommonService = tfrCommonService;
	}
	//设置外场service
	/**
	 * 设置 外场serive.
	 *
	 * @param outfieldService the new 外场serive
	 */
	public void setOutfieldService(IOutfieldService outfieldService) {
		//获取service
		this.outfieldService = outfieldService;
	}
	//设置货区service
	/**
	 * 设置 货区service.
	 *
	 * @param goodsAreaService the new 货区service
	 */
	public void setGoodsAreaService(IGoodsAreaService goodsAreaService) {
		//获取service
		this.goodsAreaService = goodsAreaService;
	}

	/**
	 * 查询所有未作废的航空正单交接单信息次方法供综合查询使用
	 * @author foss-liuxue(for IBM)
	 * @date 2012-10-31 9:46:08
	 * @param airHandOverBillDto 交接单DTO
	 * @param start 分页开始
	 * @param limit 分页结束
	 */
	@Override
	@Transactional(readOnly = true)
	//查询交接单实体
	public List<AirHandOverBillEntity> queryAirHandOverBill(AirHandOverBillDto airHandOverBillDto,int start,int limit){
		
		//获取查询总调交接单dto 此供综合查询使用
		return  airHandOverBillDao.queryAirHandOverBill(airHandOverBillDto,start,limit);
		
	}

	
	
	/**
	 * 获取总记录条数
	 * @author foss-liuxue(for IBM)
	 * @date 2012-10-31 9:46:53
	 */
	@Override
	@Transactional(readOnly = true)
	//货区总记录
	public Long getCount(AirHandOverBillDto airHandOverBillDto) {
		//获取交接单总记录数dto
		return airHandOverBillDao.getCount(airHandOverBillDto);
	}

	/**
	 * 出库操作
	 * @author foss-liuxue(for IBM)
	 * @date 2012-10-31 10:00:46
	 * update by @author wqh
	 * @date:2015-08-20
	 */
	@Override
	@Transactional
	public int outStockAirHandOverBill(List<AirHandOverBillDto> airHandOverBillDtos) {
		//如果没有选择
		if(null == airHandOverBillDtos || airHandOverBillDtos.size() < 1){
			//抛出异常
			throw new TfrBusinessException("请选择一条数据进行操作","");
		}
		boolean isExpress=false;
		//根据当前部门查询到所属外场
		String outfield = outfieldService.queryTransferCenterByAirDispatchCode(getOrgAdministrative().getCode());
		//遍历交接单列表
		for(AirHandOverBillDto airHandOverBillDto : airHandOverBillDtos){
			//当前交接单ID
			String id = airHandOverBillDto.getId(); 
			//判断交接单是否已出库  
			/*if(AirfreightConstants.STOCKING_STATUS_Y.equals(airHandOverBillDto.getAirWaybillStockState())){
				//抛出异常交接单号
				throw new TfrBusinessException("交接单"+airHandOverBillDto.getAirHandoverNo()+"已出库！","");  
			}*/

			//根据交接单id查询航空正单交单
			List<AirHandOverBillEntity> airHandOverBillList = airHandOverBillDao.queryAirHandOverBillById(id);

			if(CollectionUtils.isNotEmpty(airHandOverBillList)&&airHandOverBillList.size()>0){
				AirHandOverBillEntity airHandOverBillEntity=airHandOverBillList.get(0);
				if(AirfreightConstants.AIR_HANDOVER_TYPE_PACKAGE_HANDOVER.equals(airHandOverBillEntity.getAirHandOverType())){
					isExpress=true;
				}
			}
			
			if(isExpress){
				//根据总调查询外场
				OutfieldEntity handoverOutfieldEntity=outfieldService.queryOutfieldEntityByAirDispatchCode(getOrgAdministrative().getCode());

				if(!airHandOverBillDto.getOrgCode().equals(handoverOutfieldEntity.getOrgCode())){
					throw new TfrBusinessException("不能对非本部门的交接单"+airHandOverBillDto.getAirHandoverNo()+"出库！",""); 
				}
				
				
			}//判断交接单是否为当前登陆人的部门 
			else{
				if(!airHandOverBillDto.getOrgCode().equals(getOrgAdministrative().getCode())){
					//抛出异常
					throw new TfrBusinessException("不能对非本部门的交接单"+airHandOverBillDto.getAirHandoverNo()+"出库！","");  
				}
				
			}
			
			//判断当前交接单下所有的运单号下面的流水号是否已经入库，是则进行出库操作，否则抛出异常，需要提供接口
			//根据交接单获得到所有的运单号+流水号
			List<AirHandOverBillGetSerialNoDto> airHandOverBillGetSerialNoDtos = airHandOverBillDao.queryWaybillNoAndSerialNo(id); 
			//定义一个统计查询记录的变量
			int totalCount = 0;  
			//用于接收库存表返回的值
			int stockCount = 0;  
			//用于接收出库表返回的值
			List<GoodsAreaEntity> goodsAreaList = null;
			if(CollectionUtils.isNotEmpty(airHandOverBillGetSerialNoDtos)){
				AirHandOverBillGetSerialNoDto dto = airHandOverBillGetSerialNoDtos.get(0);
				if(dto != null){					
					WaybillEntity entity = waybillManagerService.queryWaybillBasicByNo(dto.getWayBillNo());
					if(entity != null){
						//查询所有的快递产品编码
						List<String> expressCodes= productService4Dubbo.getAllLevels3ExpressProductCode();
						if(CollectionUtils.isNotEmpty(expressCodes)&&expressCodes.size()>0&&expressCodes.contains(entity.getProductCode())){
							 goodsAreaList = goodsAreaService.queryGoodsAreaListByType(outfield, DictionaryValueConstants.BSE_GOODSAREA_TYPE_EXPRESS);

						}
						/*if(LoadConstants.PRODUCT_CODE_RCP.equals(entity.getProductCode())
								||LoadConstants.PRODUCT_CODE_PACKAGE.equals(entity.getProductCode())
								||LoadConstants.PRODUCT_CODE_EPEP.equals(entity.getProductCode())){
							 goodsAreaList = goodsAreaService.queryGoodsAreaListByType(outfield, DictionaryValueConstants.BSE_GOODSAREA_TYPE_EXPRESS);
						}*/
					}
				}
			}
            //如果未匹配出快递则走零担库区
		    if(goodsAreaList == null){ 
		    	goodsAreaList = goodsAreaService.queryGoodsAreaListByType(outfield, DictionaryValueConstants.BSE_GOODSAREA_TYPE_AIRFREIGHT);
            }


			//空运货区
			String goodsAreaCode = "";  
			if(CollectionUtils.isNotEmpty(goodsAreaList)){
				//获取货区编码
				goodsAreaCode = goodsAreaList.get(0).getGoodsAreaCode();
			}
			//可出库的list
			List<AirHandOverBillGetSerialNoDto> canOutStockSerial = new ArrayList<AirHandOverBillGetSerialNoDto>();
			//遍历交接单下所有的运单号+流水号
			for(AirHandOverBillGetSerialNoDto airHandOverBillGetSerialNoDto : airHandOverBillGetSerialNoDtos){
				//添加货区编号为查询条件
				airHandOverBillGetSerialNoDto.setGoodsAreaCode(goodsAreaCode);   
				//添加所属外场为查询条件
				airHandOverBillGetSerialNoDto.setOrgCode(outfield);    
				//根据运单号和流水号查询库存表
				stockCount = airHandOverBillDao.queryStock(airHandOverBillGetSerialNoDto).intValue();
				//如果在库存表中查到了数据，则totalCount+1，否则查询出库表
				if(stockCount > 0){
					//如果在库存中，则添加到可出库的list中
					canOutStockSerial.add(airHandOverBillGetSerialNoDto);  
					//计数自加一
					totalCount++;
				}
				//放开出库条件，只要是库中的运单都可以出库
				/*else{
					//根据运单号和流水号查询出库表
					outStockCount = airHandOverBillDao.queryOutStock(airHandOverBillGetSerialNoDto).intValue();
					//如果在出库表中查到了数据，则totalCount+1
					//出库数存在
					if(outStockCount > 0){
						//总计数加1
						totalCount=totalCount+1;
					}
				}*/
				//如果在库存表和出库表中都没查询到数据，则说明当前交接单不允许出库，抛出异常
				/*if((stockCount + outStockCount) < 1){
					//抛出异常交接单号
					throw new TfrBusinessException("运单号"+airHandOverBillGetSerialNoDto.getWayBillNo()+",流水号"+airHandOverBillGetSerialNoDto.getSerialNo()+"未入库，不能出库！","");  
				}*/
			}
			//添加一个流水号集合，用于修改走货路径
			List<String> serialNos = new ArrayList<String>();
			//如果totalCount和所有运单号+流水号一致，则说明当前交接单符合出库操作
			//modify by wangwenbo at 2016年6月23日10:45:55 DN201606160004
			//因为单票入库之后不能从这里出库，所以放开了限制，只有有流水号在库存中就执行
			if(totalCount > 0/*== airHandOverBillGetSerialNoDtos.size()*/){ 
				// 执行出库
				int outStockFailure = 0;
				//只出库可出库list中的记录
				for(AirHandOverBillGetSerialNoDto airHandOverBillGetSerialNoDto : canOutStockSerial){
					//出入库实体信息
					InOutStockEntity inOutStockEntity = new InOutStockEntity();
					//运单号
					inOutStockEntity.setWaybillNO(airHandOverBillGetSerialNoDto.getWayBillNo());
					//流水号
					inOutStockEntity.setSerialNO(airHandOverBillGetSerialNoDto.getSerialNo());
					//操作员名称
					inOutStockEntity.setOperatorName(FossUserContext.getCurrentUser().getEmployee().getEmpName());
					//操作员编码
					inOutStockEntity.setOperatorCode(FossUserContext.getCurrentUser().getEmployee().getEmpCode());
					//部门编码
					inOutStockEntity.setOrgCode(outfield);
					//出库类型
					inOutStockEntity.setInOutStockType(StockConstants.AIR_HANDOVER_BILL_OUT_STOCK_TYPE);
					//出库单号
					inOutStockEntity.setInOutStockBillNO(id);
					//定义结果result
					int result = stockService.outStockPC(inOutStockEntity);
					if(result <= 0){
						//出库失败
						outStockFailure ++;
					}
					serialNos.add(airHandOverBillGetSerialNoDto.getSerialNo());
				}
				//如果出库失败的数量>0,则抛出异常
				if(outStockFailure > 0){
					//出库失败数量>0 
					//抛出异常
					throw new TfrBusinessException("交接单"+airHandOverBillDto.getAirHandoverNo()+"出库失败！","");
				}else{
					//没有出异常则修改走货路径
					if(canOutStockSerial.size() > 1){
						try{
							calculateTransportPathService.departForAirHandover(canOutStockSerial.get(0).getWayBillNo(), serialNos, getOrgAdministrative().getCode(), new Date(), "", TransportPathConstants.PATHDETAIL_STATUS_LEAVE, "");
						}catch(TfrBusinessException tbe){
							LOGGER.error(tbe.getMessage());
						}
					}
				}
			}
			//交接单dto获取出库交接单
			airHandOverBillDao.outStockAirHandOverBill(airHandOverBillDto);
		}
		return AirfreightConstants.OUT_STOCK_SUCCUSS;
	}

	/**
	 * 查询航空正单交接单明细
	 * @author foss-liuxue(for IBM)
	 * @date 2012-11-5 10:41:22
	 */
	@Override
	@Transactional(readOnly = true)
	//查询交接单明细实体list
	public List<AirHandOverBillDetailEntity> queryHandOverAirWaybill(
			//空运交接单dto
			AirHandOverBillDto airHandOverBillDto, int start, int limit) {
		//获取查询交接单至dto
		return airHandOverBillDao.queryHandOverAirWaybill(airHandOverBillDto, start, limit);
	}

	/**
	 * 生成或修改航空正单交接单
	 * @author foss-liuxue(for IBM)
	 * @date 2012-11-5 14:43:55
	 * update by @author wqh
	 * @date:2015-08-20
	 */
	@Override
	@Transactional
	//生成或修改航空正单交接单
	public int saveOrUpdateAirHandOverBill(AirHandOverBillDto airHandOverBillDto) {
		//空运交接单实体
		AirHandOverBillEntity airHandOverBillEntity = airHandOverBillDto.getAirHandOverBillEntity();
		
		airHandOverBillEntity.setAirHandOverType(airHandOverBillDto.getAirHandOverType());
		//定义空运交接单单号
		String airHandoverbillId = airHandOverBillEntity.getId();
		
		//根据总调查询外场
		OutfieldEntity outfieldEntity=outfieldService.queryOutfieldEntityByAirDispatchCode(getOrgAdministrative().getCode());
		
		//默认为零担
		boolean isExpress=false;
		if(AirfreightConstants.AIR_HANDOVER_TYPE_PACKAGE_HANDOVER.equals(airHandOverBillEntity.getAirHandOverType())){
			isExpress=true;
		}
		
		//将前台传入的航班日期和起飞时间转换为date
		airHandOverBillEntity.setFlightDate(DateUtils.convert(airHandOverBillDto.getFlightDate(), "yyyy-MM-dd"));
		airHandOverBillEntity.setTakeOffTime(DateUtils.convert(airHandOverBillDto.getTakeOffTime(), "yyyy-MM-dd hh:mm:ss"));
		List<AirHandOverBillDetailEntity> airHandOverBillDetailList = airHandOverBillDto.getAirHandOverBillDetailList();
		
		//如果为快递交接 则不能含有零担的货
		if(isExpress){
			for(AirHandOverBillDetailEntity detail:airHandOverBillDetailList){
				
				if(AirfreightConstants.PRECISION_AIR.equals(detail.getTransportType())){
					
					throw new TfrBusinessException("空运快递交接不能包含零担的货");
				}
				
			}
	
		}else{
              for(AirHandOverBillDetailEntity detail:airHandOverBillDetailList){
				
				if(AirfreightConstants.PACKAGE_AIR.equals(detail.getTransportType())){
					
					throw new TfrBusinessException("零担快递交接不能包含快递的货");
				}
				
			}
		}
		
		//对前台传入的明细信息进行处理，加入对应的交接单ID等信息
		 //总票数
		int waybillQtyTotal = airHandOverBillDetailList.size(); 
		//总件数 
		int goodsQtyTotal = 0;	
		//总毛重
		BigDecimal grossWeightTotal = BigDecimal.ZERO;	
		//计费总重量
		BigDecimal billingWeightTotal = BigDecimal.ZERO;	
		
		/**
		 * @desc 增加总体积
		 * @author wqh
		 * */
		//总体积
		BigDecimal goodsVolumeTotal=BigDecimal.ZERO;
		
		
		//如果是快递则获取总调对应的外场为交接部门
		if(isExpress){
		  
		   //交接部门编码
			airHandOverBillEntity.setOrgCode(outfieldEntity.getOrgCode()); 
			//交接部门名称
			airHandOverBillEntity.setOrgName(outfieldEntity.getName()==null?"":outfieldEntity.getName());  
			//查询到达部门外场
			OutfieldEntity arriveOutfieldEntity=outfieldService.queryOutfieldByOrgCode(airHandOverBillDto.getExpressArriveCode());
			if(arriveOutfieldEntity ==null){
				//到达部门编码
				airHandOverBillEntity.setExpressArriveCode("");
				//到达部门名称
				airHandOverBillEntity.setExpressArriveName("");
			}else{
				//到达部门编码
				airHandOverBillEntity.setExpressArriveCode(arriveOutfieldEntity.getOrgCode());
				//到达部门名称
				airHandOverBillEntity.setExpressArriveName(arriveOutfieldEntity.getName()==null?"":arriveOutfieldEntity.getName());
			}
		}else{
			//交接部门编码
			airHandOverBillEntity.setOrgCode(getOrgAdministrative().getCode()); 
			//交接部门名称
			airHandOverBillEntity.setOrgName(getOrgAdministrative().getName());  
			//到达部门编码
			airHandOverBillEntity.setExpressArriveCode("N/A");
			//到达部门名称
			airHandOverBillEntity.setExpressArriveName("N/A");
			
		}
		
		//标记本次操作时新增还是修改，0是新增，1是修改
		int status = 0; 
		//判断交接单ID是否为空，为空则是新增，不为空则为修改
		if(StringUtils.isBlank(airHandoverbillId)){
			//交接单是否为空
			//初始状态为0
			status = 0;
			//调用uuid生成交接单号
			airHandoverbillId = UUIDUtils.getUUID();
			//获取交接单实体id
			airHandOverBillEntity.setId(airHandoverbillId);
			//为航空交接单添加统计的信息
			//创建日期
			airHandOverBillEntity.setCreateTime(new Date());
			//创建人姓名
			airHandOverBillEntity.setCreateUserName(FossUserContext.getCurrentUser().getEmployee().getEmpName());  
			//创建人编码
			airHandOverBillEntity.setCreateUserCode(FossUserContext.getCurrentUser().getEmployee().getEmpCode());  
			//修改人姓名
			airHandOverBillEntity.setModifyUserName(FossUserContext.getCurrentUser().getEmployee().getEmpName());
			//修改人编码
			airHandOverBillEntity.setModifyUserCode(FossUserContext.getCurrentUser().getEmployee().getEmpCode());
			
			//库存状态，默认未出库
			airHandOverBillEntity.setAirWaybillStockState(AirfreightConstants.STOCKING_STATUS_N);  
			//修改时间
			airHandOverBillEntity.setModifyTime(new Date());
			
			//如果为快递交接
			if(isExpress){
				 //交接单号为T开头
				String airHandoverNo= "T"+airHandOverBillEntity.getAirHandoverNo();
				airHandOverBillEntity.setAirHandoverNo(airHandoverNo);
				//初始化快递卸车状态  为  未开始状态
				airHandOverBillEntity.setExpressUnloadStatus(AirfreightConstants.AIR_EXPRESS_UNLOAD_STATUS_UNSTART);
				//初始化分配状态为 未分配状态
				airHandOverBillEntity.setExpressAssignStatus(AirfreightConstants.AIR_EXPRESS_UNLOAD_ASSINGED_STATUS_UNASSIGN);
			}else{
				//初始化零担卸车状态  为  未N/A
				airHandOverBillEntity.setExpressUnloadStatus(AirfreightConstants.AIR_PRECISION_UNLOAD_STATUS);
				//初始零担分配状态为 N/A
				airHandOverBillEntity.setExpressAssignStatus(AirfreightConstants.AIR_PRECISION_UNLOAD_STATUS);
			}
		}else{
			//如果交接类型为快递，可能存在将零担交接单修改为快递交接单
			String airHandoverNo= airHandOverBillEntity.getAirHandoverNo();
			if(isExpress){
				//拿到单据分配状态
				String expressAssignStatus=airHandOverBillEntity.getExpressAssignStatus();
				if(StringUtil.isNotBlank(expressAssignStatus)
						&&expressAssignStatus.equals(AirfreightConstants.AIR_EXPRESS_UNLOAD_ASSINGED_STATUS_ASSINGED)){
					throw new TfrBusinessException("航空正单交接单：【"+airHandoverNo+"】已经分配卸车任务不能修改！");  

				}
				//拿到卸车状态
				//卸车中
				String expressUnloadStatus=airHandOverBillEntity.getExpressUnloadStatus();
				if(StringUtil.isNotBlank(expressUnloadStatus)
						&&expressUnloadStatus.equals(AirfreightConstants.AIR_EXPRESS_UNLOAD_STATUS_UNLOADING)){
					throw new TfrBusinessException("航空正单交接单：【"+airHandoverNo+"】正在卸车不能修改！");  

				}
				//卸车完成
				if(StringUtil.isNotBlank(expressUnloadStatus)
						&&expressUnloadStatus.equals(AirfreightConstants.AIR_EXPRESS_UNLOAD_STATUS_FINISHED)){
					throw new TfrBusinessException("航空正单交接单：【"+airHandoverNo+"】已卸车不能修改！");  

				}
				if(StringUtil.isNotBlank(airHandoverNo)&&!airHandoverNo.contains("T")){
					airHandoverNo="T"+airHandoverNo;
					airHandOverBillEntity.setAirHandoverNo(airHandoverNo);
					
				}

			}

			//交接类型为快递空空运时 ，如果状态为卸车中，已卸车不能进行修改
			//标记为1，表示修改
			status = 1;
			//删除全部正单明细
			airHandOverBillDao.deleteAirHandOverBillDetailByHandOverBillId(airHandoverbillId); 
			//修改时间
			airHandOverBillEntity.setModifyTime(new Date());
			//修改人姓名
			airHandOverBillEntity.setModifyUserName(FossUserContext.getCurrentUser().getEmployee().getEmpName());
			//修改人编码
			airHandOverBillEntity.setModifyUserCode(FossUserContext.getCurrentUser().getEmployee().getEmpCode());
			//将移除的正单号恢复为交接前
			for(String airWaybillNo : airHandOverBillDto.getAirWayBillNos()){
				AirHandOverBillDto handOverBillDto = new AirHandOverBillDto();
				//正单号
				handOverBillDto.setAirWaybillNo(airWaybillNo);

				handOverBillDto.setHandOverState(AirfreightConstants.AIRFREIGHT_NOTHANDOVER);
				//未交接
				//修改交接单号状态
				airHandOverBillDao.updateAirWaybillNoState(handOverBillDto);
				
				//重新入库
				List<AirUnshippedSerialNoEntity> airUnshippedSerialNoEntities = airHandOverBillDao.querySerialNoByAirWaybillNo(handOverBillDto);
				for(AirUnshippedSerialNoEntity airUnshippedSerialNoEntity : airUnshippedSerialNoEntities){
					InOutStockEntity inOutStockEntity = new InOutStockEntity();
					//运单号
					inOutStockEntity.setWaybillNO(airUnshippedSerialNoEntity.getWaybillNo());  
					//流水号
					inOutStockEntity.setSerialNO(airUnshippedSerialNoEntity.getSerialNo());   
					//部门编号
					inOutStockEntity.setOrgCode(getOrgAdministrative().getCode());  
					//操作人名称
					inOutStockEntity.setOperatorName(FossUserContext.getCurrentUser().getEmployee().getEmpName());  
					//操作人工号
					inOutStockEntity.setOperatorCode(FossUserContext.getCurrentUser().getEmployee().getEmpCode()); 
					//入库类型
					//如果为快递 则统一为少货找到
					if(isExpress){
					   inOutStockEntity.setInOutStockType(StockConstants.EXPRESS_AIR_DEL_HANDOVER_IN_STOCK); 
					}else{
					  inOutStockEntity.setInOutStockType(StockConstants.AIR_UNSHIPPED_GOODS_IN_STOCK_TYPE); 
					}
					//入库
					stockService.inStockPC(inOutStockEntity);
				}
			}
		}
		
		List<String> airWaybillIdList=new ArrayList<String>();
		//循环为正单明细赋值
		for(AirHandOverBillDetailEntity airHandOverBillDetailEntity : airHandOverBillDetailList){
		
			airWaybillIdList.add(airHandOverBillDetailEntity.getToid());
			//单号ID
			airHandOverBillDetailEntity.setId(UUIDUtils.getUUID());
			//交接单id
			airHandOverBillDetailEntity.setAirHandoverbillId(airHandoverbillId);
			//统计明细信息
			//毛重
			grossWeightTotal = grossWeightTotal.add(airHandOverBillDetailEntity.getGrossWeight());
			//运单重量
			billingWeightTotal = billingWeightTotal.add(airHandOverBillDetailEntity.getBillingWeight());
			//总体积
			goodsVolumeTotal=goodsVolumeTotal.add(airHandOverBillDetailEntity.getGoodsVolume()==null?BigDecimal.ZERO:airHandOverBillDetailEntity.getGoodsVolume());
			//总件数
			goodsQtyTotal = goodsQtyTotal + airHandOverBillDetailEntity.getGoodsQty();
			//更改当前交接单下正单的交接状态
			//航空正单运单号
			airHandOverBillDto.setAirWaybillNo(airHandOverBillDetailEntity.getAirWaybillNo());
			//已交接
			airHandOverBillDto.setHandOverState(AirfreightConstants.AIRFREIGHT_ALREADYHANDOVER);
			//修改交接单号状态
			airHandOverBillDao.updateAirWaybillNoState(airHandOverBillDto);
		}
		//添加统计信息
		//运单总票数
		airHandOverBillEntity.setWaybillQtyTotal(waybillQtyTotal);
		//商品总件数
		airHandOverBillEntity.setGoodsQtyTotal(goodsQtyTotal);
		//毛重
		airHandOverBillEntity.setGrossWeightTotal(grossWeightTotal);
		//运单总重
		airHandOverBillEntity.setBillingWeightTotal(billingWeightTotal);
		//总体积
		airHandOverBillEntity.setHandoverVolumeTotal(goodsVolumeTotal);

		
		//新增操作则生成交接单，修改则执行修改动作
		if(status == 0){
			  /**
			   * 新增时 这里需要判断对应的交接单中所有的运单是否在库
			   * */
			if(isExpress){
				if(CollectionUtils.isEmpty(airWaybillIdList)||airWaybillIdList.size()==0){
					throw new TfrBusinessException("交接单明细不能为空");
				}
				
				//找出该正单中的所有运单流水
				List<AirUnshippedSerialNoEntity>  serialList= this.queryWaybillSerialNoByAirWaybillId(airWaybillIdList); 
			
				
				
				if (CollectionUtils.isNotEmpty(serialList)) {
					//用于接收出库表返回的值
					List<GoodsAreaEntity> goodsAreaList = null;
					if(CollectionUtils.isNotEmpty(serialList)){
						//查询所有的快递产品编码
						List<String> expressCodes= productService4Dubbo.getAllLevels3CargoProductCode();
						if(CollectionUtils.isNotEmpty(expressCodes)&&expressCodes.size()>0){
							 goodsAreaList = goodsAreaService.queryGoodsAreaListByType(outfieldEntity.getOrgCode(), DictionaryValueConstants.BSE_GOODSAREA_TYPE_EXPRESS);

						}
					}
		         
					//快递货区
					String goodsAreaCode = "";  
					if(CollectionUtils.isNotEmpty(goodsAreaList)){
						//获取货区编码
						goodsAreaCode = goodsAreaList.get(0).getGoodsAreaCode();
					}
					//查询该正单库存的所有运单流水
					List<AirUnshippedSerialNoEntity> stockSerialNoList=this.queryStockSerialNoByAirWaybillId(airWaybillIdList,outfieldEntity.getOrgCode(),goodsAreaCode);
					Map<String,Object> waybillMap=new HashMap<String,Object>();
					List<String> serialNoList=null;
					for(AirUnshippedSerialNoEntity serialNoEntity:stockSerialNoList){
						String waybillNo=serialNoEntity.getWaybillNo();
						if(waybillMap.containsKey(waybillNo)){
							serialNoList=(List<String>) waybillMap.get(waybillNo);
							serialNoList.add(serialNoEntity.getSerialNo());
							
						}else{
							serialNoList=new ArrayList<String>();
							serialNoList.add(serialNoEntity.getSerialNo());
							waybillMap.put(waybillNo,serialNoList);
						}
						
					}
					//找出航空正单交接单中不在库存的运单流水号
					for(AirUnshippedSerialNoEntity serialNoDetail: serialList){
						String waybillNo=serialNoDetail.getWaybillNo();
						String serialNo=serialNoDetail.getSerialNo();
						//从map中获取该运单对应的流水号
						serialNoList= (List<String>) waybillMap.get(waybillNo);
						if(CollectionUtils.isEmpty(serialNoList)||!serialNoList.contains(serialNo)){
							throw new TfrBusinessException("运单：【"+waybillNo+"】 的流水号 【"+serialNo+"】 不在当前库存,不能生成航空正单交接单！");  
						}
						
					}
				}
			}
				
			
			//判断传入的list是否为空，为空则抛出异常
			if(airHandOverBillDetailList.size() == 0){
				throw new TfrBusinessException("交接单至少需要一条正单明细！","");  
			}
			//验证当前选择的正单号是否做过交接
			for(AirHandOverBillDetailEntity airHandOverBillDetailEntity : airHandOverBillDetailList){
				//定义count为交接单数
				Long count = airHandOverBillDao.validateIsHandoverByWaybillNo(airHandOverBillDetailEntity.getAirWaybillNo());
				if(count.intValue() > 0){
					//交接单交接数大于0
					//抛出异常交接单
					throw new TfrBusinessException("正单"+airHandOverBillDetailEntity.getAirWaybillNo()+"已经做过交接","");
				}
			}

			//新增正单明细
			airHandOverBillDao.addAirHandOverBillDetail(airHandOverBillDetailList);
			
			//将返回的ID存入dto，标记此条记录已经新增过，再次点击不会新增，只会更新
			airHandOverBillDto.setId(airHandOverBillEntity.getId());
			//将交接状态和交接部门存入dto，和ID一起用于出库
			//部门编码
			airHandOverBillDto.setOrgCode(airHandOverBillEntity.getOrgCode());
			//库存状态
			airHandOverBillDto.setAirWaybillStockState(airHandOverBillEntity.getAirWaybillStockState());
			//交接单号
			airHandOverBillDto.setAirHandoverNo(airHandOverBillEntity.getAirHandoverNo());
			//获取空运交接单信息至dao
			return airHandOverBillDao.addAirHandOverBill(airHandOverBillEntity);
		}else{
			//验证当前选择的正单号是否做过交接
	
			
			for(AirHandOverBillDetailEntity airHandOverBillDetailEntity : airHandOverBillDetailList){
				//定义count为交接单数
				Long count = airHandOverBillDao.validateIsHandoverByWaybillNo(airHandOverBillDetailEntity.getAirWaybillNo());
				if(count.intValue() > 0){
					//交接单交接数大于0
					//抛出异常交接单
					throw new TfrBusinessException("正单"+airHandOverBillDetailEntity.getAirWaybillNo()+"已经做过交接","");
				}
				
				
			}
			//判断传入的list是否不为空，不为为空则新增正单明细，为空则只更改交接单信息
			if(airHandOverBillDetailList.size() > 0){
				//新增正单明细
				airHandOverBillDao.addAirHandOverBillDetail(airHandOverBillDetailList);
			}
			//将返回的ID存入dto，标记此条记录已经新增过，再次点击不会新增，只会更新
			airHandOverBillDto.setId(airHandOverBillEntity.getId());
			//查找当前修改的交接单不包含在传进来实体中的值
			AirHandOverBillEntity info = airHandOverBillDao.queryAirHandOverBillById(airHandOverBillEntity.getId()).get(0);
			//部门编码
			airHandOverBillDto.setOrgCode(info.getOrgCode());
			//空运交接单号
			airHandOverBillDto.setAirHandoverNo(info.getAirHandoverNo());
			//库存状态
			airHandOverBillDto.setAirWaybillStockState(info.getAirWaybillStockState());
			//获取交接单修改
			return airHandOverBillDao.updateAirHandOverBill(airHandOverBillEntity);
		}
	}

	/**
	 * 根据正单号单个添加正单到正单明细列表
	 * @author foss-liuxue(for IBM)
	 * @date 2012-11-6 17:02:47
	 */
	@Override
	@Transactional(readOnly = true)
	//交接单明细实体
	public AirHandOverBillDetailEntity querySingleAirWaybill(
			//定义交接单dto
			AirHandOverBillDto airHandOverBillDto) {
		//交接单明细实体list
		List<AirHandOverBillDetailEntity> airHandOverBillDetailList = airHandOverBillDao.querySingleAirWaybill(airHandOverBillDto);
		//交接单明细表不为空
		if(null != airHandOverBillDetailList && airHandOverBillDetailList.size() > 0){
			//获取交接单明细
			return airHandOverBillDetailList.get(0);
		}else{
			//抛出异常
			throw new TfrBusinessException("没有找到正单记录！","");  
		}
	}

	/**
	 * 根据正单交接单ID查询交接单信息以及正单明细信息
	 * @author foss-liuxue(for IBM)
	 * @date 2012-11-7 16:24:38
	 */
	@Override
	@Transactional(readOnly = true)
	//获取交接单信息dto
	public AirHandOverBillDto loadAirHandOverBillInfo(String id) {
		AirHandOverBillDto airHandOverBillDto = new AirHandOverBillDto();
		//根据交接单ID查询正单交接单
		List<AirHandOverBillEntity> airHandOverBillList = airHandOverBillDao.queryAirHandOverBillById(id);
		//如果交接单为空
		if(airHandOverBillList.size() <= 0){
			throw new TfrBusinessException("未找到此交接单","");
		}
		//根据 交接单ID查询正单交接单明细
		List<AirHandOverBillDetailEntity> airHandOverDetailBillList = airHandOverBillDao.queryAirHandOverBillDetailByHandOverBillId(id);
		//返回交接单
		airHandOverBillDto.setAirHandOverBillEntity(airHandOverBillList.get(0));
		//设置交接单列表
		airHandOverBillDto.setAirHandOverBillDetailList(airHandOverDetailBillList);
		//获取交接单dto
		return airHandOverBillDto;
	}

	/**
	 * 查询起飞时间
	 * @author foss-liuxue(for IBM)
	 * @date 2012-12-7 下午3:06:25
	 */
	@Override
	@Transactional(readOnly = true)
	public String queryTakeOffTime(AirHandOverBillDto airHandOverBillDto) {
		//查询起飞时间
		String takeOffTime = airHandOverBillDao.queryTakeOffTime(airHandOverBillDto);
		//获取起飞时间
		return takeOffTime;
	}
	
	/**
	 * 获取正单交接单
	 * @author foss-liuxue(for IBM)
	 * @date 2013-1-10 下午4:39:50
	 */
	@Override
	public String getAirHandOverBillNo(){
		//生成交接单编号
		return tfrCommonService.generateSerialNumber(TfrSerialNumberRuleEnum.ZDJJD);
	}
	
	/**
	 * 接送货接口：根据运单号查询运单交接信息
	 * @author foss-liuxue(for IBM)
	 * @date 2013-1-14 上午9:30:31
	 */
	@Override
	public List<AirHandOverStateDto> queryAirHandOverBillInfo(String airWaybillNo){
		//判断正单是否为空
		if(StringUtils.isNotBlank(airWaybillNo)){
			//返回查询运单信息
			return airHandOverBillDao.queryAirHandOverBillInfo(airWaybillNo);
		}
		//返回空
		return null;
	}
	
	/**
	 * 提供给打印使用的接口
	 * @author foss-liuxue(for IBM)
	 * @date 2013-5-3 下午3:42:07
	 */
	@Override
	@Transactional(readOnly = true)
	//获取交接单信息dto
	public AirHandOverBillDto loadAirHandOverBillInfoForPrint(String id,String[] ids) {
		AirHandOverBillDto airHandOverBillDto = new AirHandOverBillDto();
		//根据交接单ID查询正单交接单
		List<AirHandOverBillEntity> airHandOverBillList = airHandOverBillDao.queryAirHandOverBillByIdForPrint(id);
		//如果交接单为空
		if(airHandOverBillList.size() <= 0){
			throw new TfrBusinessException("未找到此交接单","");
		}
		//根据 交接单ID查询正单交接单明细
		List<AirHandOverBillDetailEntity> airHandOverDetailBillList = airHandOverBillDao.queryAirHandOverBillDetailForPrintByHandOverBillId(ids);
		//返回交接单
		airHandOverBillDto.setAirHandOverBillEntity(airHandOverBillList.get(0));
		//设置交接单列表
		airHandOverBillDto.setAirHandOverBillDetailList(airHandOverDetailBillList);
		//获取交接单dto
		return airHandOverBillDto;
	} 
	
	/**
	 * 根据正单号修改交接单出库状态
	 * @author foss-liuxue(for IBM)
	 * @date 2013-5-16 下午3:05:06
	 */
	@Override
	@Transactional
	public void updateStockStatusByAirWaybillNo(String airWaybillNo){
		//正单号为空则退出方法
		if(StringUtils.isBlank(airWaybillNo)){
			return;
		}
		//创建一个dto
		AirHandOverBillDto airHandOverBillDto = new AirHandOverBillDto();
		//写入正单号
		airHandOverBillDto.setAirWaybillNo(airWaybillNo);
		//根据正单号查询交接单记录
		List<AirHandOverBillEntity> airHandOverBillList = airHandOverBillDao.queryAirHandOverBill(airHandOverBillDto, Integer.MIN_VALUE, Integer.MAX_VALUE);
		//如果没有找的记录，则退出方法
		if(airHandOverBillList.size() < 1){
			return ;
		}
		//找到记录则修改找到的交接单的出库状态
		AirHandOverBillEntity airHandOverBillEntity = new AirHandOverBillEntity();
		//写入ID
		airHandOverBillEntity.setId(airHandOverBillList.get(0).getId());
		//写入出库状态
		airHandOverBillEntity.setAirWaybillStockState(AirfreightConstants.STOCKING_STATUS_N);
		//修改时间
		airHandOverBillEntity.setModifyTime(new Date());
		//修改状态
		airHandOverBillDao.updateAirHandOverBill(airHandOverBillEntity);
	}
	
	/**
	 * 根据运单号+流水号修改交接单出库状态
	 * @author foss-liuxue(for IBM)
	 * @date 2013-7-15 下午4:00:50
	 */
	@Override
	public int updateStockStatusByWaybillNo(String waybillNo,String serialNo){
		//正单号为空则退出方法
			if(StringUtils.isBlank(waybillNo)){
				return 0;
			}
			//创建一个dto
			AirHandOverBillGetSerialNoDto airHandOverBillGetSerialNoDto = new AirHandOverBillGetSerialNoDto();
			//写入正单号
			airHandOverBillGetSerialNoDto.setWayBillNo(waybillNo);
			airHandOverBillGetSerialNoDto.setSerialNo(serialNo);
			//根据正单号查询交接单记录
			List<AirHandOverBillEntity> airHandOverBillList = airHandOverBillDao.queryAirHandoverIdByWaybillNoAndSerialNo(airHandOverBillGetSerialNoDto);
			//如果没有找的记录，则退出方法
			if(airHandOverBillList.size() < 1){
				return 0;
			}
			//找到记录则修改找到的交接单的出库状态
			AirHandOverBillEntity airHandOverBillEntity = new AirHandOverBillEntity();
			//写入ID
			airHandOverBillEntity.setId(airHandOverBillList.get(0).getId());
			//写入出库状态
			airHandOverBillEntity.setAirWaybillStockState(AirfreightConstants.STOCKING_STATUS_N);
			//修改时间
			airHandOverBillEntity.setModifyTime(new Date());
			//修改状态
			return airHandOverBillDao.updateAirHandOverBill(airHandOverBillEntity);
	}
	
	/**
	 * 获取上级空运总调组织
	 */
	public OrgAdministrativeInfoEntity getOrgAdministrative(){
		//根据当前部门取空运总调
		String deptCode = FossUserContext.getCurrentDeptCode();
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity=airDispatchUtilService.queryAirDispatchDept(deptCode);
		return orgAdministrativeInfoEntity;
	}

	

	/**
	 * @com.deppon.foss.module.transfer.airfreight.server.service.impl
	 * @desc: 根据正单id，查询该正单下面的所有运单流水号明细
	 * @param:airWaybillIdList
	 * @wqh
	 * @2015年8月21日上午11:20:12
	 */
	public List<AirUnshippedSerialNoEntity> queryWaybillSerialNoByAirWaybillId(List<String> airWaybillIdList){
		
		if(CollectionUtils.isEmpty(airWaybillIdList)||airWaybillIdList.size()==0){
		
			throw new TfrBusinessException("正单id为空");
		}
		return airHandOverBillDao.queryWaybillSerialNoByAirWaybillId(airWaybillIdList);
		
	}
	

	/**
	 * desc: 根据正单id，查询该正单下面的所有库存中运单流水号明细
	 * param:airWaybillIdList,orgCode,goodsAreaCode
	 * List<AirUnshippedSerialNoEntity>
	 * wqh
	 * 2015年8月21日下午3:27:07
	 */
	public List<AirUnshippedSerialNoEntity> queryStockSerialNoByAirWaybillId(List<String> airWaybillIdList,String orgCode,String goodsAreaCode) {
		
		if(CollectionUtils.isEmpty(airWaybillIdList)||airWaybillIdList.size()==0){
			
			throw new TfrBusinessException("正单id为空");
		}
		if(StringUtils.isEmpty(orgCode)){
			throw new TfrBusinessException("部门为空");

		}
		if(StringUtils.isEmpty(goodsAreaCode)){
			throw new TfrBusinessException("货区编码为空");

		}
		return airHandOverBillDao.queryStockSerialNoByAirWaybillId(airWaybillIdList,orgCode,goodsAreaCode);
	}
	
	/**
	 * 更改正单交接单的卸车状态
	 * @Author 263072
	 * 2015-9-15 19:41:09
	 * @param list
	 * @return
	 */
	public int updateAirWaybillUnloadStatus(List<AirHandOverBillDto> list){
		return airHandOverBillDao.updateAirWaybillUnloadStatus(list);
	}
	

	/**
	 * @com.deppon.foss.module.transfer.airfreight.server.service.impl
	 * @desc: 查询航空正单交接单new方法
	 * @param:
	 * @wqh
	 * @2015年11月24日下午4:12:31
	 */
	public List<AirHandOverBillEntity> queryAirHandOverBillNew(AirHandOverBillDto airHandOverBillDto,int start,int limit){
	
		List<AirHandOverBillEntity> resultList=new ArrayList<AirHandOverBillEntity>();
		//获取查询总调交接单dto 零担
		List<AirHandOverBillEntity> precisionList= airHandOverBillDao.queryAirHandOverBill(airHandOverBillDto,start,limit);
		
		if(CollectionUtils.isNotEmpty(precisionList)&&precisionList.size()>0){
			resultList.addAll(precisionList);
		}
		
		//根据当前空运总调查询外场
		OutfieldEntity handoverOutfieldEntity=outfieldService.queryOutfieldEntityByAirDispatchCode(getOrgAdministrative().getCode());
 
	    if(handoverOutfieldEntity!=null){
	    	//查询总调对应外场的交接单 快递
	    	airHandOverBillDto.setOrgCode(handoverOutfieldEntity.getOrgCode());
	    	List<AirHandOverBillEntity> expressList=airHandOverBillDao.queryAirHandOverBill(airHandOverBillDto,start,limit);
	    	if(CollectionUtils.isNotEmpty(expressList)&&expressList.size()>0){
	    		resultList.addAll(expressList);
	    	}
	    }
		
		return resultList;
		
	}
	
	
	
	public IWaybillManagerService getWaybillManagerService() {
		return waybillManagerService;
	}

	public void setWaybillManagerService(
			IWaybillManagerService waybillManagerService) {
		this.waybillManagerService = waybillManagerService;
	}
	
	
}