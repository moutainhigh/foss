/**
 *  initial comments.
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 * 
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 */
/*******************************************************************************
 * Copyright 2013 TFR TEAM
 *  
 *  Licensed under the DEPPON License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *  
 *     http://www.deppon.com/licenses/LICENSE-2.0
 *  
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *  Contributors:
 *  038300-foss-pengzhen - initial API and implementation
 * 
 *  PROJECT NAME  : tfr-load
 *  
 *  FILE PATH     : src/main/java/com/deppon/foss/module/transfer/load/server/service/impl/LoaderWorkloadService.java
 *  
 *  FILE NAME          :LoaderWorkloadService.java
 * 
 *  AUTHOR  : FOSS中转系统开发组
 *  
 *  TIME              : 
 *  
 *  HOME PAGE    :  http://www.deppon.com
 * 
 *  COPYRIGHT    : Copyright (c) 2013  Deppon All Rights Reserved.
 ******************************************************************************/
package com.deppon.foss.module.transfer.load.server.service.impl;

import java.io.InputStream;
import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.transaction.annotation.Transactional;

import com.deppon.foss.base.util.define.BizTypeConstants;
import com.deppon.foss.framework.server.components.export.excel.ExportResource;
import com.deppon.foss.framework.server.components.export.excel.ExportSetting;
import com.deppon.foss.framework.server.components.export.excel.ExporterExecutor;
import com.deppon.foss.module.base.baseinfo.api.server.service.complex.IOrgAdministrativeInfoComplexService;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.OrgAdministrativeInfoEntity;
import com.deppon.foss.module.transfer.common.api.shared.exception.TfrBusinessException;
import com.deppon.foss.module.transfer.load.api.server.dao.ILoaderWorkloadDao;
import com.deppon.foss.module.transfer.load.api.server.service.ICreateLoaderWorkloadService;
import com.deppon.foss.module.transfer.load.api.server.service.ILoaderWorkloadService;
import com.deppon.foss.module.transfer.load.api.shared.define.LoadConstants;
import com.deppon.foss.module.transfer.load.api.shared.domain.MakeUpWaybillEntity;
import com.deppon.foss.module.transfer.load.api.shared.dto.ErrorVolumeDeductionDto;
import com.deppon.foss.module.transfer.load.api.shared.dto.LoaderWorkloadDetailDto;
import com.deppon.foss.module.transfer.load.api.shared.dto.LoaderWorkloadDto;
import com.deppon.foss.module.transfer.stock.api.shared.exception.StockException;
import com.deppon.foss.util.DateUtils;

/**
 * 查询装卸车工作量Service
 * @author ibm-zhangyixin
 * @date 2012-11-28 下午4:24:44
 */
public class LoaderWorkloadService implements ILoaderWorkloadService {
	//日志
	private static final Logger LOGGER = LoggerFactory.getLogger(LoaderWorkloadModifyService.class);
	/**查询装卸车工作量dao**/
	private ILoaderWorkloadDao loaderWorkloadDao;
	/**
	 *  综合管理 组织信息 Service
	 */
	private IOrgAdministrativeInfoComplexService orgAdministrativeInfoComplexService;

	public void setLoaderWorkloadDao(ILoaderWorkloadDao loaderWorkloadDao) {
		this.loaderWorkloadDao = loaderWorkloadDao;
	}
	private ICreateLoaderWorkloadService createLoaderWorkloadService;
	public void setCreateLoaderWorkloadService(
			ICreateLoaderWorkloadService createLoaderWorkloadService) {
		this.createLoaderWorkloadService = createLoaderWorkloadService;
	}
	/**
	 * @Title: querySuperiorOrgByOrgCode 
	 * @Description: 根据部门code找顶级组织 
	 * @param orgCode
	 * @return    
	 * @return OrgAdministrativeInfoEntity    返回类型 
	 * querySuperiorOrgByOrgCode
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-4-28下午4:46:59
	 */
	@Override
	public OrgAdministrativeInfoEntity querySuperiorOrgByOrgCode(String orgCode) {
		
		//设置查询参数
		List<String> bizTypesList = new ArrayList<String>();
		//外场类型
		bizTypesList.add(BizTypeConstants.ORG_TRANSFER_CENTER);
		//查询上级部门
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = orgAdministrativeInfoComplexService.
				queryOrgAdministrativeInfoIncludeSelfByCode(orgCode, bizTypesList);
		if(orgAdministrativeInfoEntity != null){
			//返回部门
			return orgAdministrativeInfoEntity;
		}else{
			//获取上级部门失败
			LOGGER.error("################查询组织（code：" + orgCode + "）所属的上级部门失败(包括营业部、派送部、外场、总调)！##########");
			throw new TfrBusinessException("获取上级部门失败, 无上级部门");
		}
	}

	/**
	 * 个人统计tab 查询方法
	 * @author ibm-zhangyixin
	 * @date 2012-12-17 上午10:50:10
	 */
	@Override
	public List<LoaderWorkloadDto> queryPersonCount(
			LoaderWorkloadDto loaderWorkloadDto, int limit, int start) {
		//返回结果
		return loaderWorkloadDao.queryPersonCount(loaderWorkloadDto, limit, start);
	}
	/**
	 * 个人统计tab（快递） 查询方法
	 * @author zhangpeng
	 * @date 2015-11-26 上午10:50:10
	 */
	@Override
	public List<LoaderWorkloadDto> queryPersonCountExpress(
			LoaderWorkloadDto loaderWorkloadDto, int limit, int start) {
		return loaderWorkloadDao.queryPersonCountExpress(loaderWorkloadDto, limit, start);
	}

	/**
	 * 个人统计tab 获取查询的总记录数
	 * @author ibm-zhangyixin
	 * @date 2012-12-17 上午10:53:14
	 */
	@Override
	public Long getTotCountPersonCount(LoaderWorkloadDto loaderWorkloadDto) {
		//返回结果
		return loaderWorkloadDao.getTotCountPersonCount(loaderWorkloadDto);
	}
	
	
	/**
	 * 个人统计tab 获取查询的总记录数
	 * @author zhangpeng
	 * @date 2012-12-17 上午10:53:14
	 */
	@Override
	public Long getTotCountPersonCountExpress(LoaderWorkloadDto loaderWorkloadDto) {
		//返回结果
		return loaderWorkloadDao.getTotCountPersonCountExpress(loaderWorkloadDto);
	}


	/**
	 * 队统计tab 查询方法
	 * @author ibm-zhangyixin
	 * @date 2012-12-18 下午4:39:55
	 */
	@Override
	public List<LoaderWorkloadDto> queryTeamCount(
			LoaderWorkloadDto loaderWorkloadDto, int limit, int start) {
		//返回结果
		return loaderWorkloadDao.queryTeamCount(loaderWorkloadDto, limit, start);
	}

	/**
	 * 队统计tab 查询方法
	 * @author zhangpeng
	 * @date 2015-12-10 下午4:39:55
	 */
	@Override
	public List<LoaderWorkloadDto> queryTeamCountExpress(
			LoaderWorkloadDto loaderWorkloadDto, int limit, int start) {
		return loaderWorkloadDao.queryTeamCountExpress(loaderWorkloadDto, limit, start);
	}
	
	/**
	 * 队统计tab 获取查询的总记录数
	 * @author ibm-zhangyixin
	 * @date 2012-12-18 下午4:40:28
	 */
	@Override
	public Long getTotCountTeamCount(LoaderWorkloadDto loaderWorkloadDto) {
		//返回结果
		return loaderWorkloadDao.getTotCountTeamCount(loaderWorkloadDto);
	}
	
	/**
	 * 操作类型map
	 */
	private Map<String, String> handleTypeMap;
	/**
	 * 操作类型map
	 * @Title: getHandleTypeMap 
	 * @Description: 操作类型map 
	 * @return Map<String,String>    返回类型 
	 * getHandleTypeMap
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-3-19下午3:56:28
	 */
	private Map<String, String> getHandleTypeMap() {
		if(handleTypeMap == null) {
			handleTypeMap = new HashMap<String, String>(2) {
				private static final long serialVersionUID = 5894620534260613736L;

				@Override
				public String get(Object key) {
					if(super.get(key) != null) {
						return super.get(key);
					}
					return (String)key;
				}
			};
			handleTypeMap.put("LOAD", "装车");
			handleTypeMap.put("UNLOAD", "卸车");
		}
		return handleTypeMap;
	}
	
	//任务类型map
	private Map<String, String> taskTypeMap;
	/**
	 * 任务类型map
	 * @Title: getTaskTypeMap 
	 * @Description: 任务类型map 
	 * @return    
	 * @return Map<String,String>    返回类型 
	 * getTaskTypeMap
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-3-19下午3:56:56
	 */
	private Map<String, String> getTaskTypeMap() {
		if(taskTypeMap == null) {
			taskTypeMap = new HashMap<String, String>(2) {
				private static final long serialVersionUID = -718434400288791932L;

				@Override
				public String get(Object key) {
					if(super.get(key) != null) {
						return super.get(key);
					}
					return (String)key;
				}
			};
			taskTypeMap.put("DELIVER_LOAD", "派送装车");
			taskTypeMap.put("LONG_DISTANCE_LOAD", "长途装车");
			taskTypeMap.put("SHORT_DISTANCE_LOAD", "短途装车");
			taskTypeMap.put("PARTIALLINE_LOAD", "偏线装车");
			taskTypeMap.put("LONG_DISTANCE", "长途卸车");
			taskTypeMap.put("SHORT_DISTANCE", "短途卸车");
			taskTypeMap.put("DELIVER", "集中卸车");
		}
		return taskTypeMap;
	}

	/**
	 * 导出个人统计查询报表
	 * @author ibm-zhangyixin
	 * @date 2012-12-27 下午2:17:19
	 * @see com.deppon.foss.module.transfer.load.api.server.service.ILoaderWorkloadService#exportPersonCountExcel(com.deppon.foss.module.transfer.load.api.shared.dto.LoaderWorkloadDto)
	 */
	@Override
	public InputStream exportPersonCountExcel(
			LoaderWorkloadDto loaderWorkloadDto) {
		InputStream excelStream = null;
		if(loaderWorkloadDto!=null){
			if(CollectionUtils.isEmpty(loaderWorkloadDto.getLoaderOrgCodes())
				&&StringUtils.isBlank(loaderWorkloadDto.getLoaderCode())){
				throw new TfrBusinessException("理货员或部门必须选择一个！");
			}
	
			if(StringUtils.isBlank(loaderWorkloadDto.getBeginDate())){
				throw new TfrBusinessException("请选择任务结束时间！");
			}
			if(StringUtils.isBlank(loaderWorkloadDto.getEndDate())){
				throw new TfrBusinessException("请选择任务结束时间！");
			}
		}else{
			throw new TfrBusinessException("请选择导出的必要条件！");
		}
		List<LoaderWorkloadDto> loaderWorkloadDtos = loaderWorkloadDao.queryPersonCount(loaderWorkloadDto);
		//行List
		List<List<String>> rowList = new ArrayList<List<String>>();
		for(LoaderWorkloadDto loaderWorkload : loaderWorkloadDtos){
			//每行的列List
			List<String> columnList = new ArrayList<String>();
			//加入时间
			columnList.add(loaderWorkload.getJoinDate());
			//理货员
			columnList.add(loaderWorkload.getLoaderName());
			//理货员工号
			columnList.add(loaderWorkload.getLoaderCode());
			//理货员所属部门
			columnList.add(loaderWorkload.getLoaderOrgName());
			//装卸车队名称
			columnList.add(loaderWorkload.getLoadOrgName());
			//货物类型 272681
			columnList.add("零担货");
			
			
			//任务类型
			columnList.add(getTaskTypeMap().get(loaderWorkload.getTaskType()));
			//任务no
			columnList.add(loaderWorkload.getTaskNo());
			//单号
			columnList.add(loaderWorkload.getHandoverNo());
			//车牌号
			columnList.add(loaderWorkload.getVehicleNo());
			//任务开始时间
			if(loaderWorkload.getTaskBeginTime() != null) {
				columnList.add(DateUtils.convert(loaderWorkload.getTaskBeginTime()));
			} else {
				columnList.add(null);
			}
			//任务结束时间
			if(loaderWorkload.getTaskEndTime() != null) {
				columnList.add(DateUtils.convert(loaderWorkload.getTaskEndTime()));
			} else {
				columnList.add(null);
			}
			//加入时间
			if(loaderWorkload.getJoinTime() != null) {
				columnList.add(DateUtils.convert(loaderWorkload.getJoinTime()));
			} else {
				columnList.add(null);
			}
			//离开时间
			if(loaderWorkload.getLeaveTime() != null) {
				columnList.add(DateUtils.convert(loaderWorkload.getLeaveTime()));
			} else {
				columnList.add(null);
			}
			//重量
			if(loaderWorkload.getWeight() != null) {
				columnList.add(loaderWorkload.getWeight().toString());
			} else {
				columnList.add(null);
			}
			//总票数
			if(loaderWorkload.getWaybillQty() != null) {
				columnList.add(loaderWorkload.getWaybillQty().toString());
			} else {
				columnList.add(null);
			}
			//总件数
			if(loaderWorkload.getGoodsQty() != null) {
				columnList.add(loaderWorkload.getGoodsQty().toString());
			} else {
				columnList.add(null);
			}
			//快递件数
			if(loaderWorkload.getExpressCount()!=null){
				columnList.add(loaderWorkload.getExpressCount().toString());
			}else{
				columnList.add(null);
			}
			//快递件数
			if(loaderWorkload.getExpressCount()!=null){
				columnList.add(loaderWorkload.getExpressCount().toString());
			}else{
				columnList.add(null);
			}
			columnList.add(loaderWorkload.getNotes());
			rowList.add(columnList);
		}
		String[] rowHeads = {"日期","理货员","理货员工号","部门","队组别","货物类型","任务类型","任务号",
				"单号","车牌号","任务开始时间","任务结束时间","加入任务时间","离开任务时间",
				"重量(公斤)","票数","件数","备注"};//定义表头
		
		ExportSetting exportSetting = new ExportSetting();
		exportSetting.setSheetName("个人统计(零担)");
		exportSetting.setSize(LoadConstants.SONAR_NUMBER_5000);
		ExportResource exportResource  = new ExportResource();
		exportResource.setHeads(rowHeads);
		exportResource.setRowList(rowList);
		ExporterExecutor objExporterExecutor = new ExporterExecutor();
		excelStream = objExporterExecutor.exportSync(exportResource, exportSetting);
        return excelStream;
	}

	/**
	 * 导出队统计查询报表
	 * @Title: exportTeamCountExcel 
	 * @Description: 导出队统计查询报表 
	 * @param loaderWorkloadDto
	 * @return    
	 * @see com.deppon.foss.module.transfer.load.api.server.service.ILoaderWorkloadService#exportTeamCountExcel(com.deppon.foss.module.transfer.load.api.shared.dto.LoaderWorkloadDto)
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-3-19下午4:03:48
	 */
	@Override
	public InputStream exportTeamCountExcel(LoaderWorkloadDto loaderWorkloadDto) {
		InputStream excelStream = null;
		
		List<LoaderWorkloadDto> loaderWorkloadDtos = loaderWorkloadDao.queryTeamCount(loaderWorkloadDto);
		//行List
		List<List<String>> rowList = new ArrayList<List<String>>();
		for(LoaderWorkloadDto loaderWorkload : loaderWorkloadDtos){
			//每行的列List
			List<String> columnList = new ArrayList<String>();
			//加入时间
			columnList.add(loaderWorkload.getJoinDate());
			//出勤人数
			if(loaderWorkload.getTaskPersonCount() != null) {
				columnList.add(loaderWorkload.getTaskPersonCount().toString());
			} else {
				columnList.add(null);
			}
			//任务类型
			columnList.add(getTaskTypeMap().get(loaderWorkload.getTaskType()));
			if(loaderWorkload.getUnloadWeight() != null) {
				columnList.add(loaderWorkload.getUnloadWeight().toString());
			} else {
				columnList.add(null);
			}
			//装车重量
			if(loaderWorkload.getLoadWeight() != null) {
				columnList.add(loaderWorkload.getLoadWeight().toString());
			} else {
				columnList.add(null);
			}
			//卸车票数
			if(loaderWorkload.getUnloadWaybillQty() != null) {
				columnList.add(loaderWorkload.getUnloadWaybillQty().toString());
			} else {
				columnList.add(null);
			}
			//装车票数
			if(loaderWorkload.getLoadWaybillQty() != null) {
				columnList.add(loaderWorkload.getLoadWaybillQty().toString());
			} else {
				columnList.add(null);
			}
			//卸车件数
			if(loaderWorkload.getUnloadGoodsQty() != null) {
				columnList.add(loaderWorkload.getUnloadGoodsQty().toString());
			} else {
				columnList.add(null);
			}
			//装车件数
			if(loaderWorkload.getLoadGoodsQty() != null) {
				columnList.add(loaderWorkload.getLoadGoodsQty().toString());
			} else {
				columnList.add(null);
			}
			rowList.add(columnList);
		}
		String[] rowHeads = {"日期","出勤人数","任务类型","卸车重量(公斤)","装车重量(公斤)","卸车票数","装车票数","卸车件数","装车件数"};//定义表头
		ExportSetting exportSetting = new ExportSetting();
		exportSetting.setSheetName("个人统计");
		exportSetting.setSize(LoadConstants.SONAR_NUMBER_5000);
		ExportResource exportResource  = new ExportResource();
		exportResource.setHeads(rowHeads);
		exportResource.setRowList(rowList);
		ExporterExecutor objExporterExecutor = new ExporterExecutor();
		excelStream = objExporterExecutor.exportSync(exportResource, exportSetting);
        return excelStream;
	}

	/**
	 * 将文件名转成UTF-8编码以防止乱码
	 * @param 文件名
	 * @author 097457-foss-wangqiang
	 * @date 2012-10-26 下午2:01:05
	 */
	@Override
	public String encodeFileName(String fileName) {
		try {
			return URLEncoder.encode(fileName, "UTF-8");
		} catch (UnsupportedEncodingException e) {
			LOGGER.error("将文件名转成UTF-8编码时出错");
			throw new StockException("将文件名转成UTF-8编码时出错","");
		}
	}

	/**
	 * 个人统计查询合计
	 * @author ibm-zhangyixin
	 * @date 2012-12-27 下午3:40:00
	 * @see com.deppon.foss.module.transfer.load.api.server.service.ILoaderWorkloadService#queryPersonCountSummary(com.deppon.foss.module.transfer.load.api.shared.dto.LoaderWorkloadDto)
	 */
	@Override
	public List<LoaderWorkloadDto> queryPersonCountSummary(
			LoaderWorkloadDto loaderWorkloadDto) {
		return loaderWorkloadDao.queryPersonCountSummary(loaderWorkloadDto);
	}
	
	/**
	 * 个人统计查询合计(快递)
	 * @author zhangpeng
	 * @date 2015-11-26 下午3:40:00
	 * @see com.deppon.foss.module.transfer.load.api.server.service.ILoaderWorkloadService#queryPersonCountSummary(com.deppon.foss.module.transfer.load.api.shared.dto.LoaderWorkloadDto)
	 */
	@Override
	public List<LoaderWorkloadDto> queryPersonCountSummaryExpress(
			LoaderWorkloadDto loaderWorkloadDto) {
		return loaderWorkloadDao.queryPersonCountSummaryExpress(loaderWorkloadDto);
	}

	/**
	 * 队统计查询合计
	 * @author ibm-zhangyixin
	 * @date 2012-12-27 下午4:15:43
	 * @see com.deppon.foss.module.transfer.load.api.server.service.ILoaderWorkloadService#queryTeamCountSummary(com.deppon.foss.module.transfer.load.api.shared.dto.LoaderWorkloadDto)
	 */
	@Override
	public LoaderWorkloadDto queryTeamCountSummary(
			LoaderWorkloadDto loaderWorkloadDto) {
		return loaderWorkloadDao.queryTeamCountSummary(loaderWorkloadDto);
	}
	
	/**
	 * 队统计查询合计(快递)
	 * @author zhangpeng
	 * @date 2015-12-09 下午4:15:43
	 * @see com.deppon.foss.module.transfer.load.api.server.service.ILoaderWorkloadService#queryTeamCountSummary(com.deppon.foss.module.transfer.load.api.shared.dto.LoaderWorkloadDto)
	 */
	@Override
	public LoaderWorkloadDto queryTeamCountSummaryExpress(
			LoaderWorkloadDto loaderWorkloadDto) {
		return loaderWorkloadDao.queryTeamCountSummaryExpress(loaderWorkloadDto);
	}

	/**   
	 * @param orgAdministrativeInfoComplexService the orgAdministrativeInfoComplexService to set
	 * Date:2013-5-31上午11:03:31
	 */
	public void setOrgAdministrativeInfoComplexService(
			IOrgAdministrativeInfoComplexService orgAdministrativeInfoComplexService) {
		this.orgAdministrativeInfoComplexService = orgAdministrativeInfoComplexService;
	}
	
	/**
	 * @author foss-heyongdong
	 * @date 2014年2月20日 14:33:55
	 * @see com.deppon.foss.module.transfer.load.api.server.service.ILoaderWorkloadService#reCalculateWorkLoad(com.deppon.foss.module.transfer.load.api.shared.domain.MakeUpWaybillEntity)
	 */
	@Override
	@Transactional
	public boolean reCalculateWorkLoad(MakeUpWaybillEntity billEntity){
		LOGGER.error("=============补录运单-更新装卸车工作量-start================");
		String waybillNo = billEntity.getWaybillNo();
		if(StringUtils.isEmpty(waybillNo)){
			return true;
		}
		List<LoaderWorkloadDetailDto> loadTasks = loaderWorkloadDao.queryReCreateWorkLoadLoadTask(waybillNo);
		List<LoaderWorkloadDetailDto> unloadTasks = loaderWorkloadDao.queryReCreateWorkLoadUnLoadTask(waybillNo);
		List<LoaderWorkloadDetailDto> tasks = new ArrayList<LoaderWorkloadDetailDto>();
		if(CollectionUtils.isNotEmpty(loadTasks)){
			tasks.addAll(loadTasks);
		}
		if(CollectionUtils.isNotEmpty(unloadTasks)){
			tasks.addAll(unloadTasks);
		}
		
		for(LoaderWorkloadDetailDto task : tasks){
			String taskNo = task.getTaskNo();
			//删除原有的装卸车工作量数据
			loaderWorkloadDao.deleteOldWorkLoadLoadTask(taskNo);	
			createLoaderWorkloadService.calculateWorkLoad(task);
			
			
			
		}
		LOGGER.error("=============补录运单-更新装卸车工作量-end================");
		return true;
		
	}
	/**
	 * 新增一条货量扣除
	 * @author 257220
	 * @date 2015年10月09日 09:33:55
	 */
	public int addErrorVolumnDeduction(
			ErrorVolumeDeductionDto errorVolumeDeductionDto) {
		if(errorVolumeDeductionDto == null){
			return 0;
		}
		return loaderWorkloadDao.addErrorVolumnDeduction(errorVolumeDeductionDto);
	}
	/**
	 * 差错货量扣除查询
	 * @param errorVolumeDeductionDto
	 * @author 257220
	 * @return
	 */
	@Override
	public List<ErrorVolumeDeductionDto> queryErrorVolumeDeductionList(
			ErrorVolumeDeductionDto errorVolumeDeductionDto,int limit, int start) {
		return loaderWorkloadDao.queryErrorVolumeDeductionList(errorVolumeDeductionDto, limit, start);
	}
	
	
	
	
	
	
	
	
}