/**
 *  initial comments.
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 */
/*******************************************************************************
 * Copyright 2013 TFR TEAM
 *  
 *  Licensed under the DEPPON License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *  
 *     http://www.deppon.com/licenses/LICENSE-2.0
 *  
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *  Contributors:
 *  038300-foss-pengzhen - initial API and implementation
 * 
 *  PROJECT NAME  : tfr-load
 *  
 *  FILE PATH     : src/main/java/com/deppon/foss/module/transfer/load/server/service/impl/VehicleSealService.java
 *  
 *  FILE NAME          :VehicleSealService.java
 * 
 *  AUTHOR  : FOSS中转系统开发组
 *  
 *  TIME              : 
 *  
 *  HOME PAGE    :  http://www.deppon.com
 * 
 *  COPYRIGHT    : Copyright (c) 2013  Deppon All Rights Reserved.
 ******************************************************************************/
package com.deppon.foss.module.transfer.load.server.service.impl;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.lang.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.transaction.annotation.Transactional;

import com.deppon.foss.base.util.ComnConst;
import com.deppon.foss.base.util.define.BizTypeConstants;
import com.deppon.foss.framework.shared.util.string.StringUtil;
import com.deppon.foss.module.base.baseinfo.api.server.service.IEmployeeService;
import com.deppon.foss.module.base.baseinfo.api.server.service.IExpressBranchSalesDeptService;
import com.deppon.foss.module.base.baseinfo.api.server.service.ILeasedDriverService;
import com.deppon.foss.module.base.baseinfo.api.server.service.IMotorcadeService;
import com.deppon.foss.module.base.baseinfo.api.server.service.IOrgAdministrativeInfoService;
import com.deppon.foss.module.base.baseinfo.api.server.service.ISecurityTfrMotorcadeService;
import com.deppon.foss.module.base.baseinfo.api.server.service.complex.IOrgAdministrativeInfoComplexService;
import com.deppon.foss.module.base.baseinfo.api.server.service.complex.IVehicleService;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.EmployeeEntity;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.ExpressBranchSalesDeptEntity;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.LeasedDriverEntity;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.MotorcadeEntity;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.OrgAdministrativeInfoEntity;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.SecurityTfrMotorcadeEntity;
import com.deppon.foss.module.base.baseinfo.api.shared.dto.VehicleAssociationDto;
import com.deppon.foss.module.base.dict.api.server.service.IConfigurationParamsService;
import com.deppon.foss.module.base.dict.api.shared.define.ConfigurationParamsConstants;
import com.deppon.foss.module.base.dict.api.shared.define.DictionaryConstants;
import com.deppon.foss.module.base.dict.api.shared.domain.ConfigurationParamsEntity;
import com.deppon.foss.module.frameworkimpl.server.context.FossUserContext;
import com.deppon.foss.module.transfer.common.api.server.service.IFOSSToOAService;
import com.deppon.foss.module.transfer.common.api.server.service.ITfrCommonService;
import com.deppon.foss.module.transfer.common.api.shared.define.TfrJobBusinessTypeEnum;
import com.deppon.foss.module.transfer.common.api.shared.domain.TfrJobProcessLogEntity;
import com.deppon.foss.module.transfer.common.api.shared.dto.OaReportSlipError;
import com.deppon.foss.module.transfer.common.api.shared.dto.ResponseDto;
import com.deppon.foss.module.transfer.common.api.shared.exception.TfrBusinessException;
import com.deppon.foss.module.transfer.departure.api.server.service.IDepartureService;
import com.deppon.foss.module.transfer.departure.api.server.service.IQueryDriverByVehicleNoService;
import com.deppon.foss.module.transfer.departure.api.server.service.IWebDepartureService;
import com.deppon.foss.module.transfer.departure.api.shared.define.DepartureConstant;
import com.deppon.foss.module.transfer.departure.api.shared.dto.AutoDepartDTO;
import com.deppon.foss.module.transfer.load.api.server.dao.IVehicleSealDao;
import com.deppon.foss.module.transfer.load.api.server.service.IPDACommonService;
import com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService;
import com.deppon.foss.module.transfer.load.api.shared.define.LoadConstants;
import com.deppon.foss.module.transfer.load.api.shared.define.SealConstant;
import com.deppon.foss.module.transfer.load.api.shared.domain.RelationInfoEntity;
import com.deppon.foss.module.transfer.load.api.shared.domain.SealDestDetailEntity;
import com.deppon.foss.module.transfer.load.api.shared.domain.SealEntity;
import com.deppon.foss.module.transfer.load.api.shared.domain.SealOrigDetailEntity;
import com.deppon.foss.module.transfer.load.api.shared.domain.TruckTaskDetailEntity;
import com.deppon.foss.module.transfer.load.api.shared.domain.TruckTaskEntity;
import com.deppon.foss.module.transfer.load.api.shared.dto.BillInfoDto;
import com.deppon.foss.module.transfer.load.api.shared.dto.SealDto;
import com.deppon.foss.module.transfer.load.api.shared.dto.VehicleSealInfoDto;
import com.deppon.foss.module.transfer.pda.api.server.service.IPdaVehicleSealService;
import com.deppon.foss.module.transfer.pda.api.shared.exception.TransferPDAExceptionCode;
import com.deppon.foss.module.transfer.scheduling.api.server.service.IVehicleEntranceService;
import com.deppon.foss.module.transfer.scheduling.api.shared.domain.VehicleEntranceEntity;
import com.deppon.foss.util.NumberUtils;
import com.deppon.foss.util.UUIDUtils;
import com.deppon.foss.util.define.FossConstants;

/***
 * 封签serivce
 * 封签绑定
 * 封签校验
 * PDA接口
 * @author ibm-zhangyixin
 * @date 2013-3-14 下午4:23:59
 */
public class VehicleSealService implements IVehicleSealService, IPdaVehicleSealService {
	private IMotorcadeService motorcadeService;
	public void setMotorcadeService(IMotorcadeService motorcadeService) {
		this.motorcadeService = motorcadeService;
	}
	/**
	 * 日志
	 */
	private static final Logger LOGGER = LoggerFactory.getLogger(VehicleSealService.class);
	/***
	 * 封签Dao
	 * 绑定封签
	 * 校验封签 
	 */
	private IVehicleSealDao vehicleSealDao;
	/**
	 * 自动放行serivce
	 */
	private IWebDepartureService webDepartureService;
	/****
	 * 人员service
	 */
	private IEmployeeService employeeService;
	/**
	 * 外请司机查询Service
	 */
	private ILeasedDriverService leasedDriverService;
	/***
	 * oa接口service
	 */
	private IFOSSToOAService fossToOAService;
	/***
	 * 获取司机信息serivce
	 */
	private IQueryDriverByVehicleNoService queryDriverByVehicleNoService;
	/***
	 * 获取车辆信息service
	 */
	private IVehicleService vehicleService;
	/**
	 * 获取组织信息service
	 */
	private IOrgAdministrativeInfoService orgAdministrativeInfoService;
	
	/***
	 * 车辆放行serivce
	 */
	private IDepartureService departureService;
	
	/**
	 *  综合管理 组织信息 Service
	 */
	private IOrgAdministrativeInfoComplexService orgAdministrativeInfoComplexService;
	
	/**
	 * 配置参数service
	 */
	private IConfigurationParamsService configurationParamsService;
	
	/**
	 * ITfrCommonService
	 */
	private ITfrCommonService tfrCommonService;
	/**
	 * 保安组信息securityTfrMotorcadeService
	 */
	private ISecurityTfrMotorcadeService securityTfrMotorcadeService;

	/**
	 * 设置 * 绑定与校验装车封签Dao.
	 *
	 * @param vehicleSealDao the new * 绑定与校验装车封签Dao
	 */
	public void setVehicleSealDao(IVehicleSealDao vehicleSealDao) {
		this.vehicleSealDao = vehicleSealDao;
	}

	/**
	 * 设置 自动放行serivce.
	 *
	 * @param webDepartureService the new 自动放行serivce
	 */
	public void setWebDepartureService(IWebDepartureService webDepartureService) {
		this.webDepartureService = webDepartureService;
	}
//	private ISaleDepartmentService saleDepartmentService;
	/*public void setSaleDepartmentService(
			ISaleDepartmentService saleDepartmentService) {
		this.saleDepartmentService = saleDepartmentService;
	}*/
	/**
	 * 装卸车PDA共通service接口
	 * 
	 */
	public IPDACommonService pdaCommonService;
	/**
	 * 
	 *
	 * @param pdaCommonService 
	 */
	public void setPdaCommonService(IPDACommonService pdaCommonService) {
		this.pdaCommonService = pdaCommonService;
	}
	
	
	private IExpressBranchSalesDeptService expressBranchSalesDeptService;
	
	public final void setExpressBranchSalesDeptService(
			IExpressBranchSalesDeptService expressBranchSalesDeptService) {
		this.expressBranchSalesDeptService = expressBranchSalesDeptService;
	}
	
	
   /**入场时间*/
	private IVehicleEntranceService vehicleEntranceService;
	
	
	/**
	 * @param vehicleEntranceService the vehicleEntranceService to set
	 */
	public void setVehicleEntranceService(
			IVehicleEntranceService vehicleEntranceService) {
		this.vehicleEntranceService = vehicleEntranceService;
	}

	/**
	 * 发车计划service 200968 2016-01-11
	 */
//	private ITruckDepartPlanDetailService truckDepartPlanDetailService;

	
	/*public void setTruckDepartPlanDetailService(
			ITruckDepartPlanDetailService truckDepartPlanDetailService) {
		this.truckDepartPlanDetailService = truckDepartPlanDetailService;
	}*/
	/**
	 * @Title: querySuperiorOrgByOrgCode 
	 * @Description: 根据部门code找顶级组织 
	 * @param orgCode
	 * @return    
	 * @return OrgAdministrativeInfoEntity    返回类型 
	 * querySuperiorOrgByOrgCode
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-4-28下午4:46:59
	 */
	@Override
	public OrgAdministrativeInfoEntity querySuperiorOrgByOrgCode(String orgCode) {
		//根据当前部门编码查询保安组信息
		SecurityTfrMotorcadeEntity securityTfrMotorcadeEntity = new SecurityTfrMotorcadeEntity();
		securityTfrMotorcadeEntity.setSecurityCode(orgCode);
		securityTfrMotorcadeEntity.setActive("Y");
		List<SecurityTfrMotorcadeEntity> securityTfrMotorcadeEntityList = securityTfrMotorcadeService.querySecurityTfrMotorcadeListBySecurityCode(securityTfrMotorcadeEntity, LoadConstants.SONAR_NUMBER_10, 0);
		//如果是保安组，以保安组服务外场替换当前部门
		if(null != securityTfrMotorcadeEntityList && securityTfrMotorcadeEntityList.size() > 0 ){
			//获取保安组服务外场
			String transCenterCode = securityTfrMotorcadeEntityList.get(0).getTranscenterCode();
			if(StringUtils.isBlank(transCenterCode)){
				LOGGER.error("当前保安组服务外场未找到。");
				throw new TfrBusinessException("当前保安组服务外场未找到。", "");
			}else{
				orgCode = transCenterCode;
			}
		}
		//设置查询参数
		List<String> bizTypesList = new ArrayList<String>();
		//外场类型
		bizTypesList.add(BizTypeConstants.ORG_TRANSFER_CENTER);
		//空运总调类型
		bizTypesList.add(BizTypeConstants.ORG_AIR_DISPATCH);
		//营业部（派送部）
		bizTypesList.add(BizTypeConstants.ORG_SALES_DEPARTMENT);
		//查询上级部门
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = orgAdministrativeInfoComplexService.
				queryOrgAdministrativeInfoIncludeSelfByCode(orgCode, bizTypesList);
		if(orgAdministrativeInfoEntity != null){
			//返回部门
			return orgAdministrativeInfoEntity;
		}else{
			

			OrgAdministrativeInfoEntity fleet = orgAdministrativeInfoComplexService.getTopFleetByCode(orgCode);
			if(fleet!=null){
				MotorcadeEntity motorcadeEntity= motorcadeService.queryMotorcadeByCodeClean(fleet.getCode());
				//若查询出的上级车队是顶级车队
				if(motorcadeEntity !=null&&FossConstants.YES.equals(motorcadeEntity.getIsTopFleet())
						&& StringUtils.isNotEmpty(motorcadeEntity.getTransferCenter())){
					
					OrgAdministrativeInfoEntity orgEntity = orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(motorcadeEntity.getTransferCenter());
					if(orgEntity!=null&&StringUtils.equals(orgEntity.getTransferCenter(), FossConstants.YES)){
						return orgEntity;
					}else{
						//获取上级部门失败
						LOGGER.error("################查询组织（code：" + orgCode + "）所属的上级部门失败(包括营业部、派送部、外场、总调)！##########");
						return null;
					}
				}else{
					//获取上级部门失败
					LOGGER.error("################查询组织（code：" + orgCode + "）所属的上级部门失败(包括营业部、派送部、外场、总调)！##########");
					return null;
				}
				
			}else{
				//获取上级部门失败
				LOGGER.error("################查询组织（code：" + orgCode + "）所属的上级部门失败(包括营业部、派送部、外场、总调)！##########");
				return null;	
			}
			
		
			
		}
	}

	/**
	 * <p>查询绑定于校验装车封签</p> 
	 * @author ibm-zhangyixin
	 * @date 2012-10-12 上午11:13:40
	 * @modifier sunjianbo
	 * @mtime  2014-5-19 上午9:49:09
	 * @return
	 * @see
	 */
	@Transactional
	@Override
	public List<SealDto> queryAllvehicleSealList(SealDto params, int limit, int start) {
		List<SealDto> list = new ArrayList<SealDto>();
		//车牌号
		String vehicleNo = params.getVehicleNo();
		//到达部门
		String destOrgCode = params.getDestOrgCode();
		//出发部门
		String origOrgCode = params.getOrigOrgCode();
		//当前部门
		String currentDeptCode = FossUserContext.getCurrentDeptCode();
		String orgCode;
		
		VehicleAssociationDto vehicleDto = null;
		if(StringUtils.isNotBlank(vehicleNo)){
			vehicleDto = vehicleService.queryVehicleAssociationDtoByVehicleNo(vehicleNo);
			if(vehicleDto!=null){
				//判定是否为公司车挂牌车  通过所属车队来判定是否是公司车
				if(vehicleDto.getVehicleType().equals("vehicletype_trailer")&&StringUtils.isNotBlank(vehicleDto.getVehicleMotorcadeCode())){
					params.setTrailerNo(vehicleNo);
					params.setVehicleNo(null);
					vehicleNo= null;
				}
			}
		}
		
		//根据当前部门编码查询保安组信息
		SecurityTfrMotorcadeEntity securityTfrMotorcadeEntity = new SecurityTfrMotorcadeEntity();
		securityTfrMotorcadeEntity.setSecurityCode(currentDeptCode);
		securityTfrMotorcadeEntity.setActive("Y");
		List<SecurityTfrMotorcadeEntity> securityTfrMotorcadeEntityList = securityTfrMotorcadeService.querySecurityTfrMotorcadeListBySecurityCode(securityTfrMotorcadeEntity, LoadConstants.SONAR_NUMBER_10, 0);
		//如果是保安组，以保安组服务外场替换当前部门
		if(null != securityTfrMotorcadeEntityList && securityTfrMotorcadeEntityList.size() > 0 ){
			//获取保安组服务外场
			String transCenterCode = securityTfrMotorcadeEntityList.get(0).getTranscenterCode();
			if(StringUtils.isBlank(transCenterCode)){
				LOGGER.error("当前保安组服务外场未找到。");
				throw new TfrBusinessException("当前保安组服务外场未找到。", "");
			}else{
				orgCode = transCenterCode;
			}
		}else{
			//当前部门顶级组织
			OrgAdministrativeInfoEntity administrativeInfo = querySuperiorOrgByOrgCode(currentDeptCode);
			//当前部门顶级组织code
			orgCode = administrativeInfo.getCode();
		}
		//当车牌号不为空时, 出发部门、到达部门可以为空
		if(StringUtils.isEmpty(vehicleNo)) {
			if(StringUtils.isEmpty(origOrgCode) && StringUtils.isEmpty(destOrgCode)) {
				params.setOrigOrgCode(orgCode);
			}
		}
		int flag = 0;
		if(StringUtils.isNotEmpty(origOrgCode) && StringUtils.equals(origOrgCode, orgCode)) {
			flag ++;
		}
		if(StringUtils.isNotEmpty(destOrgCode) && StringUtils.equals(destOrgCode, orgCode)) {
			flag ++;
		}
		if(flag > 1) {
			LOGGER.error("出发部门和到达部门其中一个必须是登录人部门。");
			throw new TfrBusinessException("出发部门和到达部门其中一个必须是登录人部门。", "");
		}
		List<SealDto> list1 = vehicleSealDao.queryAllvehicleSealList(params, limit, start);
		if(CollectionUtils.isNotEmpty(list1)){
			list.addAll(list1);
		}
		//判定营业部是否有对应快递分部，若有查询出该分部的到达车辆信息
		ExpressBranchSalesDeptEntity  branchSalesDeptEntity = new ExpressBranchSalesDeptEntity();
		branchSalesDeptEntity.setSalesDeptCode(orgCode);
		ExpressBranchSalesDeptEntity branchSalesDept= expressBranchSalesDeptService.
				queryByExpressBranchSalesDeptCode(branchSalesDeptEntity);
		if(branchSalesDept !=null){
			//当车牌号不为空时, 出发部门、到达部门可以为空
			if(StringUtils.isEmpty(vehicleNo)) {
				if(StringUtils.isEmpty(origOrgCode) && StringUtils.isEmpty(destOrgCode)) {
					params.setOrigOrgCode(branchSalesDept.getExpressBranchCode());
				}
			}
			List<SealDto> list2 = vehicleSealDao.queryAllvehicleSealList(params, limit, start);
			if(CollectionUtils.isNotEmpty(list2)){
				list.addAll(list2);
			}
		}
		//查询绑定于校验装车封签
		return list;
	}

	/**
	 * <p>查询绑定于校验装车封签总记录数</p> 
	 * @author ibm-zhangyixin
	 * @date 2012-10-16 下午4:21:52
	 */
	@Override
	public Long getTotCount(SealDto params) {
		//车牌号
		String vehicleNo = params.getVehicleNo();
		//到达部门
		String destOrgCode = params.getDestOrgCode();
		//出发部门
		String origOrgCode = params.getOrigOrgCode();
		//当前部门
		String currentDeptCode = FossUserContext.getCurrentDeptCode();
		//当前部门顶级组织
		OrgAdministrativeInfoEntity administrativeInfo = querySuperiorOrgByOrgCode(currentDeptCode);
		//当前部门顶级组织code
		String orgCode = administrativeInfo.getCode();
		//当车牌号不为空时, 出发部门、到达部门可以为空
		if(StringUtils.isEmpty(vehicleNo)) {
			if(StringUtils.isEmpty(origOrgCode) && StringUtils.isEmpty(destOrgCode)) {
				params.setOrigOrgCode(orgCode);
			}
		}
		int flag = 0;
		if(StringUtils.isNotEmpty(origOrgCode) && StringUtils.equals(origOrgCode, orgCode)) {
			flag ++;
		}
		if(StringUtils.isNotEmpty(destOrgCode) && StringUtils.equals(destOrgCode, orgCode)) {
			flag ++;
		}
		if(flag > 1) {
			LOGGER.error("出发部门和到达部门其中一个必须是登录人部门。");
			throw new TfrBusinessException("出发部门和到达部门其中一个必须是登录人部门。", "");
		}
		return vehicleSealDao.getTotCount(params);
	}

	/* (non-Javadoc) 
	 * <p>Title: getTotCount</p> 
	 * <p>Description: </p> 
	 * @param params
	 * @return 
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#getTotCount(com.deppon.foss.module.transfer.load.api.shared.dto.SealDto) 
	 */ 
	@Override
	public Long getTotCount(SealDto params,int limit,int start) {
		//车牌号
		String vehicleNo = params.getVehicleNo();
		//到达部门
		String destOrgCode = params.getDestOrgCode();
		//出发部门
		String origOrgCode = params.getOrigOrgCode();
		//当前部门
		String currentDeptCode = FossUserContext.getCurrentDeptCode();
		String orgCode;
		//根据当前部门编码查询保安组信息
		SecurityTfrMotorcadeEntity securityTfrMotorcadeEntity = new SecurityTfrMotorcadeEntity();
		securityTfrMotorcadeEntity.setSecurityCode(currentDeptCode);
		securityTfrMotorcadeEntity.setActive("Y");
		List<SecurityTfrMotorcadeEntity> securityTfrMotorcadeEntityList = securityTfrMotorcadeService.querySecurityTfrMotorcadeListBySecurityCode(securityTfrMotorcadeEntity, LoadConstants.SONAR_NUMBER_10, 0);
		//如果是保安组，以保安组服务外场替换当前部门
		if(null != securityTfrMotorcadeEntityList && securityTfrMotorcadeEntityList.size() > 0 ){
			//获取保安组服务外场
			String transCenterCode = securityTfrMotorcadeEntityList.get(0).getTranscenterCode();
			if(StringUtils.isBlank(transCenterCode)){
				LOGGER.error("当前保安组服务外场未找到。");
				throw new TfrBusinessException("当前保安组服务外场未找到。", "");
			}else{
				orgCode = transCenterCode;
			}
		}else{
			//当前部门顶级组织
			OrgAdministrativeInfoEntity administrativeInfo = querySuperiorOrgByOrgCode(currentDeptCode);
			//当前部门顶级组织code
			orgCode = administrativeInfo.getCode();
		}
		//当车牌号不为空时, 出发部门、到达部门可以为空
		if(StringUtils.isEmpty(vehicleNo)) {
			if(StringUtils.isEmpty(origOrgCode) && StringUtils.isEmpty(destOrgCode)) {
				params.setOrigOrgCode(orgCode);
			}
		}
		int flag = 0;
		if(StringUtils.isNotEmpty(origOrgCode) && StringUtils.equals(origOrgCode, orgCode)) {
			flag ++;
		}
		if(StringUtils.isNotEmpty(destOrgCode) && StringUtils.equals(destOrgCode, orgCode)) {
			flag ++;
		}
		if(flag > 1) {
			LOGGER.error("出发部门和到达部门其中一个必须是登录人部门。");
			throw new TfrBusinessException("出发部门和到达部门其中一个必须是登录人部门。", "");
		}
		return vehicleSealDao.getTotCount(params);
	}
	/**
	 * 根据车辆任务id找封签
	 * 车辆出发确认有调用, 传过来的封签类型为BIND
	 * @Title: querySealByTruckTaskId 
	 * @param seal
	 * @return    
	 * @return List<SealEntity>    返回类型 
	 * querySealByTruckTaskId
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-4-27下午2:28:02
	 */
	@Override
	public List<SealEntity> querySealByTruckTaskId(SealEntity seal) {
		if(seal == null) {
			LOGGER.error("参数错误.");
			throw new TfrBusinessException("参数错误.", "");
		}
		if(!StringUtils.equals(seal.getSealType(), SealConstant.SEAL_TYPE_BIND) && !StringUtils.equals(seal.getSealType(), SealConstant.SEAL_TYPE_CHECK)) {
			LOGGER.error("参数错误.");
			throw new TfrBusinessException("参数错误, 只接受封签类型为已绑定, 已校验的类型", "");
		}
		if(StringUtils.isEmpty(seal.getTruckTaskDetailId())) {
			LOGGER.error("参数错误.");
			throw new TfrBusinessException("参数错误, 车辆任务ID为空", "");
		}
		return vehicleSealDao.querySealByTruckTaskId(seal);
	}
	
	/**
	 * @Title: queryUnDistanceHandover 
	 * @Description: 查询当前部门下未配载的交接单 
	 * @param truckTaskId
	 * @param origOrgCode
	 * @return    
	 * @return int    返回类型 
	 * queryUnDistanceHandover
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-6-20下午4:09:10
	 */
	public List<String> queryUnDistanceHandover(String truckTaskId, String origOrgCode) {
		return vehicleSealDao.queryUnDistanceHandover(truckTaskId, origOrgCode);
	}
	
	/**
	 * 新增绑定装车封签</br>
	 * 做两个操作</br>
	 * 1,新增封签</br>
	 * 2,新增封签明细
	 * @author ibm-zhangyixin
	 * @date 2012-10-31 下午6:21:42
	 */
	@Transactional
	@Override
	public int addSeal(SealEntity seal,
			List<SealOrigDetailEntity> sealOrigDetails) {
		//当前部门code
		String currentOrgCode = FossUserContext.getCurrentDeptCode();
		//组织信息
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(currentOrgCode);
		if(orgAdministrativeInfoEntity == null) {
			LOGGER.error("找不到当前部门");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_ORG_MESSAGECODE);
		}
		
//		if(StringUtils.equals(FossConstants.YES, orgAdministrativeInfoEntity.getTransferCenter())){//现在不管外场还是营业部, 司机都不允许为空
		if(StringUtils.isEmpty(seal.getDriverCode())) {
			LOGGER.error("司机不能为空!");
			throw new TfrBusinessException("司机不能为空!", "");
		} else {
			//判定车牌号是否以德开头，若是德开头不校验车辆的准确性
			if(!seal.getVehicleNo().startsWith("德")){
				//else块 2013-06-01 17:00增加
				//公司车必须为公司司机, 否则job那块上报oa差错时不能通过.
				VehicleAssociationDto vehicleAssociation = vehicleService.queryVehicleAssociationDtoByVehicleNo(seal.getVehicleNo());
				if(vehicleAssociation == null) {
					throw new TfrBusinessException("车牌号错误, 请确认系统现在还存在该车辆!");
				}
				if(StringUtils.equals(ComnConst.ASSETS_OWNERSHIP_TYPE_COMPANY, vehicleAssociation.getVehicleOwnershipType())) {
					EmployeeEntity employee = employeeService.queryEmployeeByEmpCode(seal.getDriverCode());
					if(employee == null) {
						throw new TfrBusinessException("车辆司机错误, 车辆为公司车, 但司机为外请司机!");
					}
				} else {
					//外请车必须为外请司机
					LeasedDriverEntity leasedDriverPram = new LeasedDriverEntity();
					leasedDriverPram.setIdCard(seal.getDriverCode());
					LeasedDriverEntity leasedDriver = leasedDriverService.queryLeasedDriverBySelective(leasedDriverPram);
					if(leasedDriver == null) {
						throw new TfrBusinessException("车辆司机错误, 车辆为外请车, 但司机为公司司机!");
					}
				}
			}
		}
		//当前部门顶级组织
		orgAdministrativeInfoEntity = querySuperiorOrgByOrgCode(currentOrgCode);
		currentOrgCode = orgAdministrativeInfoEntity.getCode();
		String currentOrgName = orgAdministrativeInfoEntity.getName();
		//校验封签合法性
		for(SealOrigDetailEntity sealOrigDetail : sealOrigDetails) {
			String sealNo = sealOrigDetail.getSealNo();
			if(sealNo.length() < LoadConstants.SONAR_NUMBER_7 || sealNo.length() > LoadConstants.SONAR_NUMBER_9) {
				LOGGER.error("封签号只能为7到9位的数字");
				throw new TfrBusinessException("封签号只能为7到9位的数字", "");
			}
			if(!NumberUtils.isDigits(sealNo)) {
				LOGGER.error("封签号只能为7到9位的数字");
				throw new TfrBusinessException("封签号只能为7到9位的数字", "");
			}
		}
		//根据封签中的任务车辆id找任务车辆
		TruckTaskEntity truckTask = vehicleSealDao.getTruckTaskById(seal.getTruckTaskDetailId());
		if(truckTask == null) {
			LOGGER.error("找不到相应车辆任务明细, 请刷新后操作.");
			throw new TfrBusinessException("找不到相应车辆任务明细, 请刷新后操作.", "");
		}
		
		//根据车辆任务ID, 当前部门code, 找出发部门或到达部门为当前部门的任务明细
		List<TruckTaskDetailEntity> truckTaskDetails = queryTruckTaskDetailByTruckTaskId(truckTask.getId(), currentOrgCode);
		//判定营业部是否有对应快递分部，若有查询出该分部的到达车辆信息
		ExpressBranchSalesDeptEntity  branchSalesDeptEntity = new ExpressBranchSalesDeptEntity();
		branchSalesDeptEntity.setSalesDeptCode(currentOrgCode);
		ExpressBranchSalesDeptEntity branchSalesDept= expressBranchSalesDeptService.
				queryByExpressBranchSalesDeptCode(branchSalesDeptEntity);
		//如果找不到 说明当前部门不能对该封签做绑定操作
		if(truckTaskDetails == null || truckTaskDetails.size() == 0) {
			if(branchSalesDept !=null){
				List<TruckTaskDetailEntity> truckExTaskDetails = queryTruckTaskDetailByTruckTaskIdAndCode(truckTask.getId(), branchSalesDept.getExpressBranchCode());
				if(truckExTaskDetails == null || truckExTaskDetails.size() == 0){
					LOGGER.error("当前部门非车辆任务部门, 不能绑定" + truckTask.getId() + "deptCode:" + currentOrgCode);
					throw new TfrBusinessException("当前部门非车辆任务部门, 不能绑定", "");
				}
			}else{
				LOGGER.error("当前部门非车辆任务部门, 不能绑定" + truckTask.getId() + "deptCode:" + currentOrgCode);
				throw new TfrBusinessException("当前部门非车辆任务部门, 不能绑定", "");
			}
		}
		
		//如果ID不为空, 说明前台选择的是类型为"已校验"的封签
		SealEntity sealChecked = null;
		if(StringUtils.isNotEmpty(seal.getId())) {
			sealChecked = getSealById(seal.getId());
		}
		if(sealChecked != null && StringUtils.isNotEmpty(sealChecked.getId()) && StringUtils.equals(sealChecked.getSealType(), SealConstant.SEAL_TYPE_CHECK)) {
			if(!StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_HALFWAY_ARRIVE)) {
				//当A营业部到B营业部再到外场时, 此时B营业部车辆任务状态不为中途到达.但是需要也能继续绑定封签
				//设置查询参数
//				List<String> bizTypesList = new ArrayList<String>();
				//营业部（派送部）
//				bizTypesList.add(BizTypeConstants.ORG_SALES_DEPARTMENT);
				//查询上级部门
//				OrgAdministrativeInfoEntity orgAdministrativeInfo = orgAdministrativeInfoComplexService.
//						queryOrgAdministrativeInfoIncludeSelfByCode(currentOrgCode, bizTypesList);
				//不为空则当前部门为营业部
//				if(orgAdministrativeInfo != null) {
					//当为营业部时才做该判断
				
				//2013-06-02 20:30去掉上面那些判断, 需要营业部, 外场都可以继续绑定封签
				//因为系统存在这样的数据
				//太原==>广州
				//郑州==>广州
				//车子都是同一辆车. 两地装货, 当车子到郑州时因为车辆的到达部门无郑州所以无法中途到达.以致于校验封签后无法继续绑定.
				//此处为了解决上面的问题.
				
				//2013-06-05 17:00增加在途状态下的车辆如果已被校验也可以继续绑定封签. 见SQL语句.
				//and (status = 'UNDEPART' or status = 'ONTHEWAY') 
				//车辆出发后发现有货物漏下, 返回部门后校验封签后继续绑定发现封签无法继续绑定, 因为该车辆状态已经是在途了
				//所以此处增加一个在途状态也可以继续绑定
				List<TruckTaskDetailEntity> truckTaskDetails2 = queryTruckTaskDetailByTruckTaskIdAndOrigCode(truckTask.getId(), currentOrgCode);
				
				if(truckTaskDetails2 == null || truckTaskDetails2.size() == 0) {
					if(branchSalesDept !=null){
						List<TruckTaskDetailEntity> truckExTaskDetails2 = queryTruckTaskDetailByTruckTaskIdAndCode(truckTask.getId(),branchSalesDept.getExpressBranchCode());
						if(truckExTaskDetails2 == null || truckExTaskDetails2.size() == 0){
							LOGGER.error("当前部门非车辆任务部门, 不能继续绑定");
							throw new TfrBusinessException("当前部门非车辆任务部门,不能继续绑定", "");
						}
					}else{
						LOGGER.error("当前部门非车辆任务部门, 不能绑定");
						throw new TfrBusinessException("当前部门非车辆任务部门, 不能继续绑定", "");
					}
				}
				
//				} else {
//					LOGGER.error("当前任务车辆状态错误, 不能绑定.");
//					throw new TfrBusinessException("当前任务车辆状态错误, 不能绑定, 必须为中途到达才能继续绑定, 请刷新后操作.", "");
//				}
			}
		}
		
		SealEntity sealTemp = new SealEntity();
		sealTemp.setTruckTaskDetailId(seal.getTruckTaskDetailId());
		sealTemp.setSealType(SealConstant.SEAL_TYPE_BIND);
		//根据任务车辆id找封签
		List<SealEntity> seals = querySealByTruckTaskId(sealTemp);
		//已绑定的不能有多条, 但是已校验的可以有多条, 因为A==>B==>C==>D  可能出现这样的情况
		if(seals != null) {
			if(seals.size() > 1) {
				//如果找到多条, 说明数据有问题.
				LOGGER.error("封签数据错误, sealType:1 truckTaskId:" + seal.getTruckTaskDetailId());
				throw new TfrBusinessException("封签数据错误, 请联系开发人员", "");
			} else if (seals.size() == 1) {
				//如果找到一条, 说明该任务车辆已被绑定, 不能重复绑定.
				LOGGER.error("当前任务车辆已绑定封签, 不能重复绑定, 请刷新后操作.");
				throw new TfrBusinessException("当前任务车辆已绑定封签, 不能重复绑定, 请刷新后操作.", "");
			}
		}
		
		for(SealOrigDetailEntity sealOrigDetail : sealOrigDetails) {
			String sealNo = sealOrigDetail.getSealNo();
			if(StringUtils.isNotEmpty(sealNo)) {
				List<SealOrigDetailEntity> sealOrigs = querySealOrigDetailsBySealNo(sealNo);
				if(sealOrigs != null && sealOrigs.size() > 0) {
					LOGGER.error("重复的封签.");
					throw new TfrBusinessException("录入的封签号重复：" + sealNo, "");
				}
			}
		}
		
		//根据任务车辆明细判断是否是集配交接单，集配交接单不能放行
		//2013-06-20 17:00
		List<String> handoverNos = queryUnDistanceHandover(truckTask.getId(), currentOrgCode);
		if(CollectionUtils.isNotEmpty(handoverNos)) {
			//当前部门下还有未配载的交接单
			StringBuffer handoverStr = new StringBuffer();
			for(String handoverNo : handoverNos) {
				handoverStr.append(handoverNo).append(",");
			}
			throw new TfrBusinessException("当前部门下还有未配载的交接单: " + handoverStr.toString(), "");
		}
		//end
		
		//设置id
		seal.setId(UUIDUtils.getUUID());
		//设置任务车辆id
		seal.setTruckTaskDetailId(truckTask.getId());
		//设置封签类型
		seal.setSealType(SealConstant.SEAL_TYPE_BIND);
		//设置封签状态
		seal.setSealState(SealConstant.SEAL_STATE_UNCHECK);
		//设置操作时间
		seal.setOperateTime(new Date());
		//设置封封签时间
		seal.setSealTime(new Date());
		//设置封车人Code
		seal.setSealerCode(FossUserContext.getCurrentUser().getEmployee().getEmpCode());
		//设置封车人name
		seal.setSealerName(FossUserContext.getCurrentUser().getEmployee().getEmpName());
		//设置封车部门Code
		seal.setSealdOrgCode(currentOrgCode);
		//设置封车部门name
		seal.setSealdOrgName(currentOrgName);
		//新增绑定封签类型
		seal.setBindType(SealConstant.SEAL_TYPE_FOSS);
		//封签明细
		for(SealOrigDetailEntity sealOrigDetail : sealOrigDetails) {
			//封签明细id
			sealOrigDetail.setId(UUIDUtils.getUUID());
			//封签id
			sealOrigDetail.setSealId(seal.getId());
			//封签明细操作时间
			sealOrigDetail.setOperateTime(new Date());
			//封签类型MANA-348 不分侧后门
			sealOrigDetail.setSealType(SealConstant.SEAL_TYPE_DETAIL_NONE);
			//绑定方式
			sealOrigDetail.setBindType(SealConstant.SEAL_TYPE_FOSS);
		}
		//插入封签
		vehicleSealDao.insertSeal(seal);
		//插入封签明细
		vehicleSealDao.insertSealOrigDetail(sealOrigDetails);

		if(StringUtils.isEmpty(truckTask.getDriverCode1()) || StringUtils.isEmpty(truckTask.getDriverName1())) {
			//如果车辆任务表中的司机为空的话就将其更新为绑定时选择的司机
			if(seal.getDriverName() == null) {
				seal.setDriverName("");
			}
			if(seal.getDriverCode() == null) {
				seal.setDriverCode("");
			}
			//更新任务车辆中的司机
			updateTruckTaskDriverByTruckTaskId(seal);
		}

		//车辆状态为 "未出发", "在途" -- 需更新车辆任务明细vehicle_seal_id
		updateTruckTaskDetailByTruckTaskId(seal);
		
		//外场
		if(StringUtils.equals(FossConstants.YES, orgAdministrativeInfoEntity.getTransferCenter())){
			//自动放行
			AutoDepartDTO autoDepart = new AutoDepartDTO();
			//车牌号
			autoDepart.setVehicleNo(seal.getVehicleNo());				//车牌号
			//司机code
			autoDepart.setDriverCode(seal.getDriverCode());				//司机Code
			//司机姓名
			autoDepart.setDriverName(seal.getDriverName());				//司机姓名
			//司机联系方式
			autoDepart.setDriverPhone(seal.getDriverPhone());			//司机联系方式
			//申请人Code
			autoDepart.setApplyUserCode(seal.getSealerCode());			//申请人Code
			//申请人姓名
			autoDepart.setApplyUserName(seal.getSealerName());			//申请人姓名
			//申请部门
			autoDepart.setApplyOrgCode(seal.getSealdOrgCode());			//申请部门
			//放行类型
			autoDepart.setAutoDepartType(DepartureConstant.AUTO_DEPART_TYPE_SEAL);//放行类型
			//放行事项
			autoDepart.setDepartItems(truckTask.getBusinessType());//放行事项
			//任务车辆id
			autoDepart.setTruckTaskId(truckTask.getId());
			
			//新增完毕后调用车辆放行的service自动生成放行ID
			seal.setTruckDepartId(webDepartureService.autoDepart(autoDepart));
			//更新封签中的车辆放行id
			updateSeal(seal);
		}
		return FossConstants.SUCCESS;
	}
	
	/**
	 * 根据封签号, 出发部门, 到达部门.获取车辆任务明细信息
	 * @author ibm-zhangyixin
	 * @date 2012-12-11 上午11:02:32
	 */
	private TruckTaskDetailEntity getTruckTaskDetail(String vehicleNo, String origOrgCode, String destOrgCode) {
		//封签dto
		SealDto sealDto = new SealDto();
		//车牌号
		sealDto.setVehicleNo(vehicleNo);
		//出发部门
		sealDto.setOrigOrgCode(origOrgCode);
		//到达部门
		sealDto.setDestOrgCode(destOrgCode);
		//任务车辆明细
		List<TruckTaskDetailEntity> truckTaskDetails = vehicleSealDao.getTruckTaskDetailsByVehicleNo(sealDto);
		if(truckTaskDetails.size() == 0) {
			return null;
		}
		return truckTaskDetails.get(0);
	}
	
	/**
	 * 根据车牌号查询绑定的封签明细
	 * @author ibm-zhangyixin
	 * @date 2012-10-31 下午6:22:17
	 */
	@Override
	public List<SealOrigDetailEntity> getSealOrigDetailsByVehicleNo(String vehicleNo) {
		if(StringUtils.isEmpty(vehicleNo)) {
			return new ArrayList<SealOrigDetailEntity>();
		}
		//根据车牌号查询绑定的封签明细
		return vehicleSealDao.getSealOrigDetailsBySealVehicleNo(vehicleNo);
	}

	/**
	 * 根据车牌号查询绑定的封签
	 * @author ibm-zhangyixin
	 * @date 2012-10-31 下午6:22:49
	 */
	@Override
	public SealEntity getSealByVehicleNo(String vehicleNo) {
		//根据车牌号查询绑定的封签
		SealEntity seal = vehicleSealDao.getSealByVehicleNo(vehicleNo);
		if(seal == null) {
			LOGGER.error("根据车牌号, 查询不到相应的封签记录");
			throw new TfrBusinessException("根据车牌号, 查询不到相应的封签记录", "");
		}
		return seal;
	}

	/**
	 * 根据车牌号查询绑定状态的封签
	 * @author ibm-zhangyixin
	 * @date 2012-10-31 下午6:22:49
	 */
	private SealEntity getSealByVehicleNo(String vehicleNo, Boolean flag) {
		//根据车牌号查询绑定的封签
		SealEntity seal = vehicleSealDao.getSealByVehicleNo(vehicleNo);
		if(flag && seal == null) {
			LOGGER.error("根据车牌号, 查询不到相应的封签记录");
			throw new TfrBusinessException("根据车牌号, 查询不到相应的封签记录", "");
		}
		return seal;
	}
	
	/** 
	 * @Title: queryVehicleSealInfo 
	 * @Description: 根据车牌号查询出封签的信息
	 * 	车辆任务ID, 车辆任务状态等...
	 *  提供给交接单的接口
	 * @param vehicleNo
	 * @return    
	 * @return VehicleSealInfoDto    返回类型 
	 * queryVehicleSealInfo
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-3-27下午4:46:12
	 */ 
	@Override
	public VehicleSealInfoDto queryVehicleSealInfo(String vehicleNo) {
		if(StringUtils.isEmpty(vehicleNo)) {
			throw new TfrBusinessException("调用封签接口出错, 车牌号为空", "");
		}
		//根据车牌号查询绑定的封签
		SealEntity seal = vehicleSealDao.getSealByVehicleNo(vehicleNo);
		if(seal == null) {
			return null;
		}
		
		TruckTaskEntity truckTask = vehicleSealDao.getTruckTaskById(seal.getTruckTaskDetailId());
		if(truckTask == null) {
			return null;
//			LOGGER.error("车辆任务数据错误, truckTaskId:" + seal.getTruckTaskDetailId());
//			throw new TfrBusinessException("车辆任务数据错误.", "");
		}
		VehicleSealInfoDto vehicleSealInfo = new VehicleSealInfoDto();
		vehicleSealInfo.setTruckTaskId(truckTask.getId());
		vehicleSealInfo.setStatus(truckTask.getState());
		vehicleSealInfo.setSealId(seal.getId());
		vehicleSealInfo.setSealdOrgCode(seal.getSealdOrgCode());
		vehicleSealInfo.setSealdOrgName(seal.getSealdOrgName());
		
		List<TruckTaskDetailEntity> truckTaskDetails = vehicleSealDao.getTruckTaskDetailsByTruckTaskId(truckTask.getId());
		vehicleSealInfo.setTruckTaskDetails(truckTaskDetails);
		return vehicleSealInfo;
	}

	/**
	 * 根据ID得到Seal 封签
	 * @author ibm-zhangyixin
	 * @date 2012-10-23 下午5:05:51
	 */
	@Override
	public SealEntity getSealById(String id) {
		//根据ID得到Seal 封签
		return vehicleSealDao.getSealById(id);
	}

	/**
	 * 根据SealId查询出装车封签 
	 * @author ibm-zhangyixin
	 * @date 2012-10-23 下午5:17:23
	 */
	@Override
	public List<SealOrigDetailEntity> getSealOrigDetailsBySealId(String sealId) {
		//根据SealId查询出装车封签 
		return vehicleSealDao.getSealOrigDetailsBySealId(sealId);
	}

	/**
	 * 
	 * 根据SealId查询出卸车封签
	 *  
	 * @Title: getSealDestDetailsBySealId
	 *  
	 * @Description: 根据SealId查询出卸车封签
	 *  
	 * @param sealId
	 * 
	 * @return
	 *     
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#getSealDestDetailsBySealId(java.lang.String)
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午10:08:35
	 */
	@Override
	public List<SealDestDetailEntity> getSealDestDetailsBySealId(String sealId) {
		//根据SealId查询出卸车封签 
		return vehicleSealDao.getSealDestDetailsBySealId(sealId);
	}

	/**
	 * 修改绑定装车封签数据 
	 * 
	 * 操作步骤:</br>
	 * 
	 * 	1,更新封签主表</br>
	 * 
	 * 	2,删除封签明细</br>
	 * 
	 * 	3,新增封签</br>
	 * 
	 * @Title: editSealOrig
	 *  
	 * @Description: 修改绑定装车封签数据
	 *  
	 * 操作步骤:</br>
	 * 
	 * 	1,更新封签主表</br>
	 * 
	 * 	2,删除封签明细</br>
	 * 
	 * 	3,新增封签</br>
	 * 
	 * @param sealParam
	 * 
	 * @param sealOrigDetails
	 * 
	 * @return
	 *     
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#editSealOrig(com.deppon.foss.module.transfer.load.api.shared.domain.SealEntity, java.util.List)
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午10:07:51
	 * 
	 */
	@Transactional
	@Override
	public int editSealOrig(SealEntity sealParam,
			List<SealOrigDetailEntity> sealOrigDetails){
		//根据封签id获取封签
		SealEntity seal = getSealById(sealParam.getId());
		seal.setDriverCode(sealParam.getDriverCode());
		seal.setDriverName(sealParam.getDriverName());
		seal.setDriverPhone(sealParam.getDriverPhone());
		//当前部门
		String currentOrgCode = FossUserContext.getCurrentDeptCode();
		//组织信息
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(currentOrgCode);
		if(orgAdministrativeInfoEntity == null) {
			LOGGER.error("找不到当前部门");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_ORG_MESSAGECODE);
		}
		
		//外场
//		if(StringUtils.equals(FossConstants.YES, orgAdministrativeInfoEntity.getTransferCenter())){
//			
//			//2013-06-19增加判断, 如果封签是由PDA生成的, 那么就不需要校验司机是否为空
//			if(!StringUtils.isEmpty(seal.getPdaDeviceNo())) {
//				//如果PDA设备号不为空说明是PDA生成的封签
//				if(StringUtils.isEmpty(sealParam.getDriverCode())) {
//					LOGGER.error("司机不能为空!");
//					throw new TfrBusinessException("司机不能为空!", "");
//				}
//			}
//		}
		//现在不管外场还是营业部司机都不能为空
		if(StringUtils.isEmpty(seal.getDriverCode())) {
			LOGGER.error("司机不能为空!");
			throw new TfrBusinessException("司机不能为空!", "");
		} else {
			//else块 2013-06-01 17:00增加
			//公司车必须为公司司机, 否则job那块上报oa差错时不能通过.
			VehicleAssociationDto vehicleAssociation = vehicleService.queryVehicleAssociationDtoByVehicleNo(seal.getVehicleNo());
			if(vehicleAssociation == null) {
				throw new TfrBusinessException("车牌号错误, 请确认系统现在还存在该车辆!");
			}
			if(StringUtils.equals(ComnConst.ASSETS_OWNERSHIP_TYPE_COMPANY, vehicleAssociation.getVehicleOwnershipType())) {
				EmployeeEntity employee = employeeService.queryEmployeeByEmpCode(seal.getDriverCode());
				if(employee == null) {
					throw new TfrBusinessException("车辆司机错误, 车辆为公司车, 但司机为外请司机!");
				}
			} else {
				//外请车必须为外请司机
				LeasedDriverEntity leasedDriverPram = new LeasedDriverEntity();
				leasedDriverPram.setIdCard(seal.getDriverCode());
				LeasedDriverEntity leasedDriver = leasedDriverService.queryLeasedDriverBySelective(leasedDriverPram);
				if(leasedDriver == null) {
					throw new TfrBusinessException("车辆司机错误, 车辆为外请车, 但司机为公司司机!");
				}
			}
		}
		
		//当前部门顶级组织
		orgAdministrativeInfoEntity = querySuperiorOrgByOrgCode(currentOrgCode);
		currentOrgCode = orgAdministrativeInfoEntity.getCode();
		String currentOrgName = orgAdministrativeInfoEntity.getName();
		//校验封签合法性
		for(SealOrigDetailEntity sealOrigDetail : sealOrigDetails) {
			String sealNo = sealOrigDetail.getSealNo();
			if(sealNo.length() < LoadConstants.SONAR_NUMBER_7 || sealNo.length() > LoadConstants.SONAR_NUMBER_9) {
				LOGGER.error("封签号只能为7到9位的数字");
				throw new TfrBusinessException("封签号只能为7到9位的数字", "");
			}
			if(!NumberUtils.isDigits(sealNo)) {
				LOGGER.error("封签号只能为7到9位的数字");
				throw new TfrBusinessException("封签号只能为7到9位的数字", "");
			}
		}
		
		//根据车辆任务id获取车辆任务
		TruckTaskEntity truckTask = vehicleSealDao.getTruckTaskById(seal.getTruckTaskDetailId());
		if(truckTask == null) {
			LOGGER.error("找不到相应车辆任务明细, 请刷新后操作.");
			throw new TfrBusinessException("找不到相应车辆任务明细, 请刷新后操作.", "");
		}
		
		//只有封签类型为绑定封签, 并且车辆出发状态为未到达才可以修改,删除
		if(!(StringUtils.equals(seal.getSealType(), SealConstant.SEAL_TYPE_BIND) 
				&& !StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_ARRIVED))) {
			LOGGER.error("只有封签类型为绑定封签, 并且车辆出发状态为未到达才可以修改.");
			throw new TfrBusinessException("只有封签类型为绑定封签, 并且车辆出发状态为未到达才可以修改, 请刷新后操作.", "");
		}
		
		for(SealOrigDetailEntity sealOrigDetail : sealOrigDetails) {
			String sealNo = sealOrigDetail.getSealNo();
			String id = sealOrigDetail.getId();
			if(StringUtils.isNotEmpty(sealNo)) {
				List<SealOrigDetailEntity> sealOrigs =null;
				if(StringUtils.isNotEmpty(id)){
					//如果是原来的封签号
					sealOrigs = querySealOrigDetailsBySealNoAndId(sealNo, id);
				}else{
					//如果是新添加的或修改的标签号
					sealOrigs = querySealOrigDetailsBySealNo(sealNo);
				}		
				if(sealOrigs != null && sealOrigs.size() > 0) {
					LOGGER.error("重复的封签.");
					throw new TfrBusinessException("录入的封签号重复：" + sealNo, "");
				}
			}
		}
		
		//设置车牌号
		seal.setVehicleNo(sealParam.getVehicleNo());
		//设置封车人
		seal.setSealerName(sealParam.getSealerName());
		//设置封车备注
		seal.setSealOrgMemo(sealParam.getSealOrgMemo());
		//设置操作时间
		seal.setOperateTime(new Date());
		//设置封车时间
		seal.setSealTime(new Date());
		//设置封车人code
		seal.setSealerCode(FossUserContext.getCurrentUser().getEmployee().getEmpCode());
		//设置封车部门code
		seal.setSealdOrgCode(currentOrgCode);
		//设置封车部门name
		seal.setSealdOrgName(currentOrgName);
		//新增封签绑定类型
		seal.setBindType(SealConstant.SEAL_TYPE_PDA_SCAN);
		//外场
		if(StringUtils.equals(FossConstants.YES, orgAdministrativeInfoEntity.getTransferCenter())){
			//自动放行dto
			AutoDepartDTO autoDepart = new AutoDepartDTO();
			//车牌号
			autoDepart.setVehicleNo(seal.getVehicleNo());				//车牌号
			//司机Code
			autoDepart.setDriverCode(sealParam.getDriverCode());		//司机Code
			//司机name
			autoDepart.setDriverName(sealParam.getDriverName());		//司机姓名
			//司机电话
			autoDepart.setDriverPhone(sealParam.getDriverPhone());		//司机联系方式
			//申请人code
			autoDepart.setApplyUserCode(seal.getSealerCode());			//申请人Code
			//申请人name
			autoDepart.setApplyUserName(seal.getSealerName());			//申请人姓名
			//申请部门
			autoDepart.setApplyOrgCode(seal.getSealdOrgCode());			//申请部门
			//放行类型
			autoDepart.setAutoDepartType(DepartureConstant.AUTO_DEPART_TYPE_SEAL);//放行类型
			//放行事项
			autoDepart.setDepartItems(truckTask.getBusinessType());//放行事项
			//车辆任务id
			autoDepart.setTruckTaskId(truckTask.getId());
			//修改完毕后调用车辆放行的service自动生成放行ID
			String truckDepartId = seal.getTruckDepartId();
			if(StringUtils.isNotEmpty(truckDepartId)) {
				List<String> departIds = new ArrayList<String>(1);
				departIds.add(seal.getTruckDepartId());
				//先作废再重新放行
				departureService.cancleWaitDepart(departIds);
			}
			seal.setTruckDepartId(webDepartureService.autoDepart(autoDepart));
		}
		//更新封签
		updateSeal(seal);
		
		if(StringUtils.isEmpty(truckTask.getDriverCode1()) || StringUtils.isEmpty(truckTask.getDriverName1())) {
			//如果车辆任务表中的司机为空的话就将其更新为绑定时选择的司机
			sealParam.setTruckTaskDetailId(truckTask.getId());
			//更新车辆任务中的司机信息
			updateTruckTaskDriverByTruckTaskId(sealParam);
		}

		//封签明细
		for(SealOrigDetailEntity sealOrigDetail : sealOrigDetails) {
			//封签明细id
			sealOrigDetail.setId(UUIDUtils.getUUID());
			//封签id
			sealOrigDetail.setSealId(seal.getId());
			//操作时间
			sealOrigDetail.setOperateTime(new Date());
			//封签绑定方式
			sealOrigDetail.setBindType(SealConstant.SEAL_TYPE_FOSS);
			//封签类型
			sealOrigDetail.setSealType(SealConstant.SEAL_TYPE_DETAIL_NONE);
		}
		//先删除再新增
		deleteSealOrigDetailBySealId(seal.getId());
		//插入封签明细
		insertSealOrigDetail(sealOrigDetails);
		return FossConstants.SUCCESS;
	}

	/**
	 * 更新封签操作 
	 * 
	 * @Title: updateSeal
	 *  
	 * @Description: 更新封签操作
	 *   
	 * @param seal
	 * 
	 * @return
	 *     
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#updateSeal(com.deppon.foss.module.transfer.load.api.shared.domain.SealEntity)
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午10:07:20
	 */
	@Transactional
	@Override
	public int updateSeal(SealEntity seal) {
		//更新封签操作 
		return vehicleSealDao.updateSeal(seal);
	}

	/**
	 * 根据封签ID删除出发封签明细
	 * 
	 * @Title: deleteSealOrigDetailBySealId
	 *  
	 * @Description: 根据封签ID删除出发封签明细
	 *  
	 * @param sealId
	 * 
	 * @return
	 *     
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#deleteSealOrigDetailBySealId(java.lang.String)
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午10:07:00
	 */
	@Transactional
	@Override
	public int deleteSealOrigDetailBySealId(String sealId) {
		//根据封签ID删除出发封签明细
		return vehicleSealDao.deleteSealOrigDetailBySealId(sealId);
	}
	
	/**
	 * 
	 * 新增出发封签
	 *  
	 * @Title: insertSealOrigDetail
	 *  
	 * @Description: 新增出发封签
	 *  
	 * @param sealOrigDetails
	 * 
	 * @return
	 *     
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#insertSealOrigDetail(java.util.List)
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午10:06:41
	 * 
	 */
	@Transactional
	@Override
	public int insertSealOrigDetail(List<SealOrigDetailEntity> sealOrigDetails) {
		//新增出发封签
		return vehicleSealDao.insertSealOrigDetail(sealOrigDetails);
	}
	
	/**
	 * @Title: getTruckTaskDetailByTruckId 
	 * @Description: 根据t_opt_truck_task.id找t_opt_truck_task_detail
	 * 返回 t_opt_truck_task_detail.create_time最早的一条  order by create_time asc
	 * @param truckTaskId
	 * @return    
	 * @return TruckTaskDetailEntity    返回类型 
	 * getTruckTaskDetailByTruckId
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-4-18下午2:38:14
	 */
	@Override
	public TruckTaskDetailEntity getTruckTaskDetailByTruckId(String truckTaskId) {
		return vehicleSealDao.getTruckTaskDetailByTruckId(truckTaskId);
	}

	/**
	 * @Title: queryTruckTaskDetailByTruckTaskId 
	 * @Description: 根据车辆任务ID找出所有明细 
	 * @param truckTaskId
	 * @return    
	 * @return List<TruckTaskDetailEntity>    返回类型 
	 * queryTruckTaskDetailByTruckTaskId
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-5-17下午2:38:29
	 */
	public List<TruckTaskDetailEntity> queryTruckTaskDetailByTruckTaskId(String truckTaskId, String orgCode) {
		return vehicleSealDao.queryTruckTaskDetailByTruckTaskId(truckTaskId, orgCode);
	}

	/**
	 * @Title: queryTruckTaskDetailByTruckTaskId 
	 * @Description: 查询当前部门在子任务到达部门中是否存在
	 * @author 163580
	 * @date 2014-2-24 下午2:39:53
	 * @param truckTaskId
	 * @param destCode
	 * @return
	 * @see
	 */
	public Long queryTruckTaskDetailByTruckTaskIdAndDestCode(String truckTaskId, String destOrgCode) {
		return vehicleSealDao.queryTruckTaskDetailByTruckTaskIdAndDestCode(truckTaskId, destOrgCode);
	}

	/**
	 * @Title: queryTruckTaskDetailByTruckTaskIdAndOrigCode 
	 * @Description: 根据车辆任务ID, 出发部门找出所有明细 
	 * @param truckTaskId
	 * @return    
	 * @return List<TruckTaskDetailEntity>    返回类型 
	 * queryTruckTaskDetailByTruckTaskIdAndOrigCode
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-5-17下午2:38:29
	 */
	public List<TruckTaskDetailEntity> queryTruckTaskDetailByTruckTaskIdAndOrigCode(String truckTaskId, String orgCode) {
		return vehicleSealDao.queryTruckTaskDetailByTruckTaskIdAndOrigCode(truckTaskId, orgCode);
	}
	
	/**
	 * 
	 * 更新封签, 并保存到达封签明细</br>
	 * 
	 * 操作步骤</br>
	 * 
	 * 1,更新封签
	 * 
	 * 2,保存到达封签明细
	 * 
	 * @Title: updateSeal
	 *  
	 * @Description: 更新封签, 并保存到达封签明细</br>
	 * 
	 * 操作步骤</br>
	 * 
	 * 1,更新封签
	 * 
	 * 2,保存到达封签明细
	 * 
	 * @param sealParam
	 * 
	 * @param sealDestDetails
	 * 
	 * @param isdiff
	 *     
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#updateSeal(com.deppon.foss.module.transfer.load.api.shared.domain.SealEntity, java.util.List, java.lang.Boolean)
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午10:06:04
	 * 
	 */
	@Transactional
	@Override
	public void updateSeal(SealEntity sealParam,
			List<SealDestDetailEntity> sealDestDetails, Boolean isdiff) {
		//校验封签的合法性
		for(SealDestDetailEntity sealDestDetail : sealDestDetails) {
			String sealNo = sealDestDetail.getSealNo();
			if(sealNo.length() < LoadConstants.SONAR_NUMBER_7 || sealNo.length() > LoadConstants.SONAR_NUMBER_9) {
				LOGGER.error("封签号只能为7到9位的数字");
				throw new TfrBusinessException("封签号只能为7到9位的数字", "");
			}
			if(!NumberUtils.isDigits(sealNo)) {
				LOGGER.error("封签号只能为7到9位的数字");
				throw new TfrBusinessException("封签号只能为7到9位的数字", "");
			}
		}
		//根据封签id获取封签
		SealEntity seal = getSealById(sealParam.getId());
		//封签状态校验
		if(StringUtils.equals(seal.getSealType(), SealConstant.SEAL_TYPE_CHECK)) {
			LOGGER.error("封签状态错误, 已被校验.");
			throw new TfrBusinessException("封签状态错误, 已被校验, 请刷新后操作!", "");
		}
		if(StringUtils.equals(seal.getSealType(), SealConstant.SEAL_TYPE_INVALID)) {
			LOGGER.error("封签状态错误, 已被删除.");
			throw new TfrBusinessException("封签状态错误, 已被" + seal.getSealOrgMemo() + ", 请刷新后操作!", "");
		}
		//车辆任务
		TruckTaskEntity truckTask = vehicleSealDao.getTruckTaskById(seal.getTruckTaskDetailId());
		if(truckTask == null) {
			LOGGER.error("找不到相应车辆任务明细, 请刷新后操作.");
			throw new TfrBusinessException("找不到相应车辆任务明细, 请刷新后操作.", "");
		}
		
		//当前部门
		String currentDeptCode = FossUserContext.getCurrentDeptCode();
//		TruckTaskDetailEntity truckTaskDetail = //getTruckTaskDetailByTruckId(truckTask.getId());
//		qeuryTruckTaskDetailByTaskIdAndDestOrgCode(truckTask.getId(),currentDeptCode,null);
//		//到达部门
//		String destOrgCode = "";
//		//业务类型
//		String businessType="";
//		if(truckTaskDetail!=null){
//			destOrgCode = truckTaskDetail.getDestOrgCode();
//			businessType = truckTaskDetail.getBusinessType();
//	
//		}		
		//组织信息
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(currentDeptCode);
		if(orgAdministrativeInfoEntity == null) {
			LOGGER.error("找不到当前部门");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_ORG_MESSAGECODE);
		}
		//当前部门顶级组织
		orgAdministrativeInfoEntity = querySuperiorOrgByOrgCode(currentDeptCode);
		currentDeptCode = orgAdministrativeInfoEntity.getCode();
		TruckTaskDetailEntity truckTaskDetail = //getTruckTaskDetailByTruckId(truckTask.getId());
				qeuryTruckTaskDetailByTaskIdAndDestOrgCode(truckTask.getId(),currentDeptCode,null);
				//到达部门
				String destOrgCode = "";
				//业务类型
				String businessType="";
				//sonar 218427 非空判断
//				if(truckTaskDetail==null){
//					throw new TfrBusinessException("truckTaskDetail为空");
//				}
				if(truckTaskDetail!=null){
					destOrgCode = truckTaskDetail.getDestOrgCode();
					businessType = truckTaskDetail.getBusinessType();
			
				}	
		if(StringUtils.equals(seal.getSealdOrgCode(), currentDeptCode)) {
			//ISSUE-4429
			//KDTE-5390转的ISSUE
			//在非到达部门可以校验封签的基础上，新增限制，封签绑定部门不允许校验自己已绑定封签，只允许删除自己已绑封签； 
			LOGGER.error("封签绑定部门不允许校验封签，请联系车辆到达部门。");
			throw new TfrBusinessException("封签绑定部门不允许校验封签，请联系车辆到达部门。", "");
		}
		
		//BUG-18086不能做发车确认
		//增加限制, 防止员工误操作
		//如果车辆未出发, 不允许校验封签
		if(StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_UNDEPART)) {
			LOGGER.error("车辆尚未出发, 不能校验封签, 请刷新页面后操作.");
			throw new TfrBusinessException("车辆尚未出发, 不能校验封签, 请刷新页面后操作.", "");
		}
		
		//如果当前部门为最终到达部门, 则校验车辆的状态
		//如果当前部门为最终到达部门, 只有车辆任务状态为"中途到达","已到达","已卸车"才能校验封签
		if(StringUtils.equals(currentDeptCode, destOrgCode)) {
			//车辆任务状态校验
			if(//!StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_HALFWAY_ARRIVE) && //必须当前子任务到达后才能校验封签,而中途到达不一定是子任务到达
				!StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_ARRIVED)
				//BUG-58122
				&& !StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_UNLOADED)
				//必须当前子任务到达后才能校验封签
				&& !StringUtils.equals(truckTaskDetail.getState(),SealConstant.SEAL_TRUCK_STATUS_ARRIVED)
				&& !StringUtils.equals(truckTaskDetail.getState(),SealConstant.SEAL_TRUCK_STATUS_UNLOADED)) {				
				LOGGER.error("车辆状态错误, 不能校验");
				throw new TfrBusinessException("车辆状态错误, 只有中途到达、已到达、已卸车时才能校验, 请刷新后操作.", "");
			}
		}else if((StringUtils.isNotEmpty(businessType) && StringUtils.equals(businessType, "LONG_DISTANCE"))
					||(StringUtils.isEmpty(businessType) && StringUtils.equals(orgAdministrativeInfoEntity.getTransferCenter(), FossConstants.YES))){
				throw new TfrBusinessException("只有到达本部门的车辆才可以校验封签！", "");
		}
		
		//封签类型
		seal.setSealType(SealConstant.SEAL_TYPE_CHECK);
		//封签状态
		seal.setSealState(sealParam.getSealState());
		//校验人name
		seal.setCheckerUser(FossUserContext.getCurrentUser().getEmployee().getEmpName());
		//校验人code
		seal.setCheckerCode(FossUserContext.getCurrentUser().getEmployee().getEmpCode());
		//校验部门code
		seal.setCheckOrgCode(FossUserContext.getCurrentDept().getCode());
		//校验部门name
		seal.setCheckOrgName(FossUserContext.getCurrentDept().getName());
		//校验时间
		seal.setCheckTime(new Date());
		//操作时间
		seal.setOperateTime(new Date());
		//到达封签校验类型
		seal.setCheckType(SealConstant.SEAL_TYPE_FOSS);
		
		//封签明细
		for(SealDestDetailEntity sealDestDetail : sealDestDetails) {
			//封签明细id
			sealDestDetail.setId(UUIDUtils.getUUID());
			//封签id
			sealDestDetail.setSealId(seal.getId());
			//操作时间
			sealDestDetail.setOperateTime(new Date());
			//封签类型MANA-348 不分侧后门
			sealDestDetail.setSealType(SealConstant.SEAL_TYPE_DETAIL_NONE);
			//封签方式
			sealDestDetail.setCheckType(SealConstant.SEAL_TYPE_FOSS);
		}

		//封签
		List<String> sealNos = new ArrayList<String>();
		for(SealDestDetailEntity sealDest : sealDestDetails) {
			sealNos.add(sealDest.getSealNo());
		}
		if(!seal.getVehicleNo().startsWith("德")){
			if(isdiff == null || isdiff) {
				//上报OA差错
				ConfigurationParamsEntity configurationParamsEntity = configurationParamsService.queryConfigurationParamsByOrgCode(DictionaryConstants.SYSTEM_CONFIG_PARM__TFR , ConfigurationParamsConstants.TFR_PARM__TFR_SEAL_EXC_LATEST_TIME, FossConstants.ROOT_ORG_CODE);
				Date beginReportOATime = com.deppon.foss.util.DateUtils.convert(configurationParamsEntity.getConfValue(), "yyyy-MM-dd HH:mm:ss");
				Date currentDate = new Date();
				if(currentDate.compareTo(beginReportOATime) > 0) {
					ResponseDto responseDto = reportSlipError(seal.getVehicleNo(), seal.getSealState(), seal, sealNos);
					if(responseDto == null) {
//					throw new TfrBusinessException("调用OA接口时出错, OA返回为空, 请联系相关人员!", "");
					} else {
						//设置OA差错编号
						seal.setOaErrorNo(responseDto.getErrorNo());
					}
				}
			}
		}
		//更新封签
		vehicleSealDao.updateSeal(seal);
		if(!StringUtils.equals(seal.getSealState(), SealConstant.SEAL_STATE_DAMAGED)) {
			//如果封签为破损, 就说明没有封签明细, 也就不用做明细插入操作了.
			vehicleSealDao.insertSealDestDetail(sealDestDetails);
		}
	}
	
	/**
	 * 通过任务id 和目的站查询车辆任务
	 * @author 105869
	 * @date 2014年10月23日 15:32:18
	 * @param id
	 * @param currentDeptCode
	 * @param isStatus 
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#qeuryTruckTaskDetailByTaskIdAndDestOrgCode(java.lang.String, java.lang.String, java.lang.String)
	 **/
	@Override
	public TruckTaskDetailEntity qeuryTruckTaskDetailByTaskIdAndDestOrgCode(String id,String currentDeptCode,String isStatus) {
		return vehicleSealDao.qeuryTruckTaskDetailByTaskIdAndDestOrgCode(id,currentDeptCode,isStatus);
	}

	/**
	 * 新增到达封签 
	 * 
	 * @Title: insertSealDestDetail
	 *  
	 * @Description: 新增到达封签
	 *  
	 * @param sealDestDetails
	 * 
	 * @return
	 *     
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#insertSealDestDetail(java.util.List)
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午10:05:37
	 * 
	 */
	@Override
	public int insertSealDestDetail(List<SealDestDetailEntity> sealDestDetails) {
		//新增到达封签 
		return vehicleSealDao.insertSealDestDetail(sealDestDetails);
	}
	
	/**
	* PDA接口:
	* 
	* 	录入装车封签
	* 
	* @Title: insertSealOrig
	*  
	* @Description:
	*  
	* PDA接口:
	* 
	* 	录入装车封签
	* 
	* @param vehicleNo
	* 
	* @param sealdOrgCode
	* 
	* @param backSealNos
	* 
	* @param sideSealNos
	* 
	* @param sealerCode
	* 
	* @param pdaDeviceNo
	* 
	* @param currentDept
	* 
	* @param nextDept
	* 
	* @return
	*  
	* @see com.deppon.foss.module.transfer.pda.api.server.service.IPdaVehicleSealService#insertSealOrig(java.lang.String, java.lang.String, java.util.List, java.util.List, java.lang.String, java.lang.String, java.lang.String, java.lang.String)
	* 
	* @author: ibm-zhangyixin
	* 
	* @throws
	*  
	* Date:2013-3-18下午8:09:59
	* 
	 */
	@Transactional
	@Override
	public int insertSealOrig(String vehicleNo, String sealdOrgCode, List<String> backSealNos,
			List<String> sideSealNos, String sealerCode, String pdaDeviceNo, String currentDept
			, String nextDept) {
		if(StringUtils.isEmpty(pdaDeviceNo)) {
			LOGGER.error("PDA设备号为空");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_PDANO_EMPTY, "");
		}
		if(backSealNos == null && sideSealNos == null) {
			LOGGER.error("请录入封签明细");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
		}
		if(backSealNos != null && backSealNos.size() == 0 && sideSealNos != null && sideSealNos.size() == 0) {
			LOGGER.error("请录入封签明细");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
		}
		if(StringUtils.isEmpty(currentDept)) {
			LOGGER.error("当前部门不能为空");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_CURRENTDEPT_NOTBENULL, "");
		} else {
			/**读取登录部门所属外场/营业部
			 * 2013-05-04修改
			 * */
			OrgAdministrativeInfoEntity origOrg = orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(currentDept);
			if(origOrg != null){
				//当前部门顶级组织
				origOrg = querySuperiorOrgByOrgCode(currentDept);
				currentDept = origOrg.getCode();
			}else{
				LOGGER.error("找不到当前部门");
				throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_ORG_MESSAGECODE);
			}
		}
		if(StringUtils.isEmpty(nextDept)) {
			LOGGER.error("下一部门不能为空");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_NEXTDEPT_NOTBENULL, "");
		}
		//校验封签合法性
		if(backSealNos != null) {
			for(String sealNo : backSealNos) {
				sealNo = StringUtils.trim(sealNo);
				if(StringUtils.isNotEmpty(sealNo)) {
					if(sealNo.length() < LoadConstants.SONAR_NUMBER_7 || sealNo.length() > LoadConstants.SONAR_NUMBER_9) {
						LOGGER.error("封签号只能为7到9位的数字");
						throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
					}
					if(!NumberUtils.isDigits(sealNo)) {
						LOGGER.error("封签号只能为7到9位的数字");
						throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
					}
				}
			}
		}
		//校验封签合法性
		if(sideSealNos != null) {
			for(String sealNo : sideSealNos) {
				sealNo = StringUtils.trim(sealNo);
				if(StringUtils.isNotEmpty(sealNo)) {
					if(sealNo.length() < LoadConstants.SONAR_NUMBER_7 || sealNo.length() > LoadConstants.SONAR_NUMBER_9) {
						LOGGER.error("封签号只能为7到9位的数字");
						throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
					}
					if(!(NumberUtils.isDigits(sealNo))) {
						LOGGER.error("封签号只能为7到9位的数字");
						throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
					}
				}
			}
		}
		//根据车牌号, 当前部门, 下一部门找车辆任务明细
		TruckTaskDetailEntity truckTaskDetail = getTruckTaskDetail(vehicleNo, currentDept, nextDept);
		LOGGER.error("车牌号1："+vehicleNo+",出发部门："+currentDept+",到达部门："+nextDept);
		if(truckTaskDetail == null) {
			LOGGER.error("暂不能录入封签。系统后台正在处理装车数据，请耐心等待");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_UNCREATE_TRUCKTASK_MESSAGECODE, "");
		}
		
		//根据车辆任务id获取车辆任务
		TruckTaskEntity truckTask = vehicleSealDao.getTruckTaskById(truckTaskDetail.getParentId());
		if(truckTask == null) {
			LOGGER.error("车辆任务已被作废.");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_TRUCKTASK_CANCELED, "");
		}
		
		//2013-06-07 22:30
		SealEntity sealTemp = new SealEntity();
		sealTemp.setTruckTaskDetailId(truckTaskDetail.getParentId());
		sealTemp.setSealType(SealConstant.SEAL_TYPE_BIND);
		//根据任务车辆id找封签
		List<SealEntity> seals = querySealByTruckTaskId(sealTemp);
		//已绑定的不能有多条, 但是已校验的可以有多条, 因为A==>B==>C==>D  可能出现这样的情况
		if(seals != null) {
			if(seals.size() >= 1) {
				LOGGER.error("当前任务车辆已绑定封签, 不能重复绑定, 请刷新后操作.");
				throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_SEAL_BINDED, "");
			}
		}
		
		//车辆任务状态校验
		if(StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_ARRIVED)) {
			LOGGER.error("只有车辆状态为未到达时才能绑定");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_BIND_INVALID_TRUCKTASKSTATE_MESSAGECODE, "");
		}
		
		if(backSealNos != null) {
			for(String sealNo : backSealNos) {
				if(StringUtils.isNotEmpty(sealNo)) {
					List<SealOrigDetailEntity> sealOrigs = querySealOrigDetailsBySealNo(sealNo);
					if(sealOrigs != null && sealOrigs.size() > 0) {
						LOGGER.error("重复的封签.");
						throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_REPEAT_SEALNO, "");
					}
				}
			}
		}
		if(sideSealNos != null) {
			for(String sealNo : sideSealNos) {
				if(StringUtils.isNotEmpty(sealNo)) {
					List<SealOrigDetailEntity> sealOrigs = querySealOrigDetailsBySealNo(sealNo);
					if(sealOrigs != null && sealOrigs.size() > 0) {
						LOGGER.error("重复的封签.");
						throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_REPEAT_SEALNO, "");
					}
				}
			}
		}
		
		//封签entity
		SealEntity seal = new SealEntity();
		//封签id
		seal.setId(UUIDUtils.getUUID());
		//车牌号
		seal.setVehicleNo(vehicleNo);
		//封车人
		seal.setSealerCode(sealerCode);
		//人员entity
		EmployeeEntity employee = employeeService.queryEmployeeByEmpCode(sealerCode);
		if(employee == null) {
			LOGGER.error("用户编号错误, 找不到相应用户");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_UNFIND_USER_MESSAGECODE, "");
		}
		//封车人name
		seal.setSealerName(employee.getEmpName());
		//pda机器号
		seal.setPdaDeviceNo(pdaDeviceNo);
		//封车部门code
		seal.setSealdOrgCode(sealdOrgCode);
		//封车部门name
		String orgName = getOrgNameByOrgCode(sealdOrgCode);
		//封车部门name
		seal.setSealdOrgName(orgName);
		//车辆任务id
		seal.setTruckTaskDetailId(truckTask.getId());
		//封签类型
		seal.setSealType(SealConstant.SEAL_TYPE_BIND);
		//封签状态
		seal.setSealState(SealConstant.SEAL_STATE_UNCHECK);
		//操作时间
		seal.setOperateTime(new Date());
		//封车时间
		seal.setSealTime(null);
		//新增绑定类型
		seal.setBindType(SealConstant.SEAL_TYPE_PDA_SCAN);

		//封签明细
		List<SealOrigDetailEntity> sealOrigDetails = new ArrayList<SealOrigDetailEntity>();
		if(backSealNos != null) {
			for(String sealNo : backSealNos) {
				//封签号
				sealNo = StringUtils.trim(sealNo);
				if(StringUtils.isNotEmpty(sealNo)) {
					//出发封签明细
					SealOrigDetailEntity sealOrigDetail = new SealOrigDetailEntity();
					//封签号
					sealOrigDetail.setSealNo(sealNo);
					//封签类型
					sealOrigDetail.setSealType(SealConstant.SEAL_TYPE_DETAIL_BACK);
					//封签明细id
					sealOrigDetail.setId(UUIDUtils.getUUID());
					//封签id
					sealOrigDetail.setSealId(seal.getId());
					//封签明细操作时间
					sealOrigDetail.setOperateTime(new Date());
					sealOrigDetails.add(sealOrigDetail);
				}
			}
		}
		if(sideSealNos != null) {
			for(String sealNo : sideSealNos) {
				//封签号
				sealNo = StringUtils.trim(sealNo);
				if(StringUtils.isNotEmpty(sealNo)) {
					//出发封签明细entity
					SealOrigDetailEntity sealOrigDetail = new SealOrigDetailEntity();
					//封签号
					sealOrigDetail.setSealNo(sealNo);
					//封签类型
					sealOrigDetail.setSealType(SealConstant.SEAL_TYPE_DETAIL_SIDE);
					//封签明细id
					sealOrigDetail.setId(UUIDUtils.getUUID());
					//封签id
					sealOrigDetail.setSealId(seal.getId());
					//操作时间
					sealOrigDetail.setOperateTime(new Date());
					sealOrigDetails.add(sealOrigDetail);
				}
			}
		}
		//插入封签
		vehicleSealDao.insertSeal(seal);
		//插入封签明细
		vehicleSealDao.insertSealOrigDetail(sealOrigDetails);
		
		//车辆状态为 "未出发", "在途" -- 需更新车辆任务明细vehicle_seal_id
		updateTruckTaskDetailByTruckTaskId(seal);
		
		//如果当前部门为外场, 需生成车辆放行
		OrgAdministrativeInfoEntity orgAdministrativeInfo = orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(currentDept);
		if(StringUtils.equals(FossConstants.YES, orgAdministrativeInfo.getTransferCenter())){
			//自动放行dto
			AutoDepartDTO autoDepart = new AutoDepartDTO();
			//车牌号
			autoDepart.setVehicleNo(seal.getVehicleNo());			//车牌号
			//司机code
			autoDepart.setDriverCode(truckTask.getDriverCode1());	//司机Code
			//司机姓名
			autoDepart.setDriverName(truckTask.getDriverName1());	//司机姓名
			//司机电话
			autoDepart.setDriverPhone(truckTask.getDriverPhone1());	//司机联系方式
			//申请人code
			autoDepart.setApplyUserCode(sealerCode);				//申请人Code
			//申请人name
			autoDepart.setApplyUserName(employee.getEmpName());		//申请人姓名
			//申请部门
			autoDepart.setApplyOrgCode(seal.getSealdOrgCode());		//申请部门
			//放行类型
			autoDepart.setAutoDepartType(DepartureConstant.AUTO_DEPART_TYPE_SEAL);//放行类型
			//放行事项
			autoDepart.setDepartItems(truckTask.getBusinessType());//放行事项
			//车辆任务id
			autoDepart.setTruckTaskId(truckTask.getId());
			//新增完毕后调用车辆放行的service自动生成放行ID
			seal.setTruckDepartId(webDepartureService.autoDepart(autoDepart));
		}
		//更新封签中的放行id
		updateSeal(seal);
		return FossConstants.SUCCESS;
	}

	/**
	* PDA接口, 录入到达封签
	* @Title: insertSealDest
	*  
	* @Description: PDA接口, 录入到达封签
	* 
	* @param sealState
	* 
	* @param vehicleNo
	* 
	* @param checkOrgCode
	* 
	* @param backSealNos
	* 
	* @param sideSealNos
	* 
	* @param checkOrgMemo
	* 
	* @param checkerUser
	* 
	* @param pdaDeviceNo
	* 
	* @param billNos
	* 
	* @return
	*     
	* @see com.deppon.foss.module.transfer.pda.api.server.service.IPdaVehicleSealService#insertSealDest(java.lang.String, java.lang.String, java.lang.String, java.util.List, java.util.List, java.lang.String, java.lang.String, java.lang.String, java.util.List)
	* 
	* @author: ibm-zhangyixin
	* 
	* @throws
	*  
	* Date:2013-3-19上午9:51:16
	* 
	*/
	@Transactional
	@Override
	public int insertSealDest(String sealState, String vehicleNo, String checkOrgCode,
			List<String> backSealNos, List<String> sideSealNos,
			String checkOrgMemo, String checkerUser, String pdaDeviceNo, List<String> billNos) {
		if(StringUtils.isEmpty(pdaDeviceNo)) {
			LOGGER.error("PDA设备号为空");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_PDANO_EMPTY, "");
		}
		if(billNos == null || billNos.size() <= 0) {
			LOGGER.error("请录入单号明细");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_BILLNO_NOTBENULL, "");
		}
		//封签号合法性校验
		if(backSealNos != null) {
			for(String sealNo : backSealNos) {
				sealNo = StringUtils.trim(sealNo);
				if(StringUtils.isNotEmpty(sealNo)) {
					if(sealNo.length() < LoadConstants.SONAR_NUMBER_7 || sealNo.length() > LoadConstants.SONAR_NUMBER_9) {
						LOGGER.error("封签号只能为7到9位的数字");
						throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
					}
					if(!NumberUtils.isDigits(sealNo)) {
						LOGGER.error("封签号只能为7到9位的数字");
						throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
					}
				}
			}
		}
		//封签号合法性校验
		if(sideSealNos != null) {
			for(String sealNo : sideSealNos) {
				sealNo = StringUtils.trim(sealNo);
				if(StringUtils.isNotEmpty(sealNo)) {
					if(sealNo.length() < LoadConstants.SONAR_NUMBER_7 || sealNo.length() > LoadConstants.SONAR_NUMBER_9) {
						LOGGER.error("封签号只能为7到9位的数字");
						throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
					}
					if(!NumberUtils.isDigits(sealNo)) {
						LOGGER.error("封签号只能为7到9位的数字");
						throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
					}
				}
			}
		}
		//根据车牌号找封签
		SealEntity seal = getSealByVehicleNo(vehicleNo, false);
		//封签状态校验
		if(seal == null || StringUtils.equals(seal.getSealType(), SealConstant.SEAL_TYPE_CHECK)) {
			LOGGER.error("封签状态错误, 已被校验.");
			return FossConstants.SUCCESS;
		}
		
		//组织信息
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(checkOrgCode);
		if(orgAdministrativeInfoEntity == null) {
			LOGGER.error("找不到当前部门");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_ORG_MESSAGECODE);
		}
		//当前部门顶级组织
		orgAdministrativeInfoEntity = querySuperiorOrgByOrgCode(checkOrgCode);
		checkOrgCode = orgAdministrativeInfoEntity.getCode();
		if(StringUtils.equals(seal.getSealdOrgCode(), checkOrgCode)) {
			//ISSUE-4429
			//KDTE-5390转的ISSUE
			//在非到达部门可以校验封签的基础上，新增限制，封签绑定部门不允许校验自己已绑定封签，只允许删除自己已绑封签； 
			LOGGER.error("本部门绑定的封签不能校验");
			throw new TfrBusinessException("本部门绑定的封签不能校验, 如果封签有误请做删除操作!", "");
		}
		
		//单号
		String billNo = billNos.get(0);
		//根据pda传过来的单号信息找车辆任务
		//t_truck_task_bill ==> t_truck_task_detail ==> t_truck_task
		TruckTaskEntity truckTask = vehicleSealDao.getTruckTaskByBillNo(billNo);
		if(truckTask == null) {
			LOGGER.error("找不到相应车辆任务明细, 请刷新后操作.");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_UNFIND_TRUCKTASK_MESSAGECODE, "");
		}
		//车辆任务状态校验
		if(!StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_HALFWAY_ARRIVE) 
				&& !StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_ARRIVED)) {
				//BUG-57708
				//&& !StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_UNLOADED)
			LOGGER.error("车辆状态错误, 不能校验");
			return FossConstants.SUCCESS;
		}
		
		//车牌号
		seal.setVehicleNo(vehicleNo);
		//封签类型
		seal.setSealType(SealConstant.SEAL_TYPE_CHECK);
		//封签状态
		seal.setSealState(sealState);
		//校验人
		seal.setCheckerCode(checkerUser);
		//人员信息
		EmployeeEntity employee = employeeService.queryEmployeeByEmpCode(checkerUser);
		if(employee == null) {
			LOGGER.error("用户编号错误, 找不到相应用户");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_UNFIND_USER_MESSAGECODE, "");
		}
		//校验人name
		seal.setCheckerUser(employee.getEmpName());
		//校验部门code
		seal.setCheckOrgCode(checkOrgCode);
		//校验部门name
		String checkOrgName = getOrgNameByOrgCode(checkOrgCode);
		//校验部门name
		seal.setCheckOrgName(checkOrgName);
		//校验时间
		seal.setCheckTime(new Date());
		//操作时间
		seal.setOperateTime(new Date());
		//校验备注
		seal.setCheckOrgMemo(checkOrgMemo);
		//pda设备号
		seal.setPdaDeviceNo(pdaDeviceNo);
		//封签校验类型
		seal.setCheckType(SealConstant.SEAL_TYPE_PDA_SCAN);
		//封签检查类型
		seal.setCheckType(SealConstant.SEAL_TYPE_PDA_SCAN);
		
		//到达封签明细
		List<SealDestDetailEntity> sealDestDetails = new ArrayList<SealDestDetailEntity>();
		if(backSealNos != null) {
			for(String sealNo : backSealNos) {
				sealNo = StringUtils.trim(sealNo);
				if(StringUtils.isNotEmpty(sealNo)) {
					//到达封签明细
					SealDestDetailEntity sealDestDetail = new SealDestDetailEntity();
					//封签号
					sealDestDetail.setSealNo(sealNo);
					//封签类型MANA-348 不分侧后门
					sealDestDetail.setSealType(SealConstant.SEAL_TYPE_DETAIL_NONE);
					//封签明细id
					sealDestDetail.setId(UUIDUtils.getUUID());
					//封签id
					sealDestDetail.setSealId(seal.getId());
					//操作时间
					sealDestDetail.setOperateTime(new Date());
					sealDestDetails.add(sealDestDetail);
				}
			}
		}
		if(sideSealNos != null) {
			for(String sealNo : sideSealNos) {
				//封签号
				sealNo = StringUtils.trim(sealNo);
				if(StringUtils.isNotEmpty(sealNo)) {
					//到达封签明细
					SealDestDetailEntity sealDestDetail = new SealDestDetailEntity();
					//封签号
					sealDestDetail.setSealNo(sealNo);
					//封签类型MANA-348 不分侧后门
					sealDestDetail.setSealType(SealConstant.SEAL_TYPE_DETAIL_NONE);
					//封签明细id
					sealDestDetail.setId(UUIDUtils.getUUID());
					//封签id
					sealDestDetail.setSealId(seal.getId());
					//操作时间
					sealDestDetail.setOperateTime(new Date());
					sealDestDetails.add(sealDestDetail);
				}
			}
		}
		List<String> sealNos = new ArrayList<String>(sealDestDetails.size());
		for(SealDestDetailEntity sealDest : sealDestDetails) {
			sealNos.add(sealDest.getSealNo());
		}
		//更新封签
		vehicleSealDao.updateSeal(seal);
		//插入到达封签明细
		vehicleSealDao.insertSealDestDetail(sealDestDetails);
		
		//当封签状态为异常时上报OA差错
		if(!StringUtils.equals(SealConstant.SEAL_STATE_NORMAL, sealState)) {
			ConfigurationParamsEntity configurationParamsEntity = configurationParamsService.queryConfigurationParamsByOrgCode(DictionaryConstants.SYSTEM_CONFIG_PARM__TFR , ConfigurationParamsConstants.TFR_PARM__TFR_SEAL_EXC_LATEST_TIME, FossConstants.ROOT_ORG_CODE);
			Date beginReportOATime = com.deppon.foss.util.DateUtils.convert(configurationParamsEntity.getConfValue(), "yyyy-MM-dd HH:mm:ss");
			Date currentDate = new Date();
			if(currentDate.compareTo(beginReportOATime) > 0) {
				ResponseDto responseDto = reportSlipError(vehicleNo, sealState, seal, sealNos);
				if(responseDto == null) {
//					throw new TfrBusinessException("调用OA接口时出错, OA返回为空, 请联系相关人员!", "");
				} else {
					//oa差错编号
					seal.setOaErrorNo(responseDto.getErrorNo());
					//更新封签oa差错编号
					vehicleSealDao.updateSeal(seal);
				}
			}
		}
		return FossConstants.SUCCESS;
	}
	
	
	//封签新需求2013-10-28
	/** 
	 * PDA录入封签
	 * @author Administrator
	 * @date 2013-11-7 下午4:13:38
	 * @param vehicleNo
	 * @param sealdOrgCode
	 * @param sealOrigDetails
	 * @param sealerCode
	 * @param pdaDeviceNo
	 * @param currentDept
	 * @param nextDept
	 * @param sealType
	 * @return 
	 * @see com.deppon.foss.module.transfer.pda.api.server.service.IPdaVehicleSealService#insertSealOrig(java.lang.String, java.lang.String, java.util.List, java.lang.String, java.lang.String, java.lang.String, java.lang.String, java.lang.String)
	 */
	@Transactional
	@Override
	public int insertSealOrig(String vehicleNo, String sealdOrgCode, List<com.deppon.foss.module.transfer.pda.api.shared.domain.SealOrigDetailEntity> sealOrigDetails,
			String sealerCode, String pdaDeviceNo, String currentDept
			, String nextDept, String sealType) {
		if(StringUtils.isEmpty(pdaDeviceNo)) {
			LOGGER.error("PDA设备号为空");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_PDANO_EMPTY, "");
		}

		if(CollectionUtils.isEmpty(sealOrigDetails)) {
			LOGGER.error("请录入封签明细");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
		}

		if(StringUtils.isEmpty(currentDept)) {
			LOGGER.error("当前部门不能为空");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_CURRENTDEPT_NOTBENULL, "");
		} else {
			/**读取登录部门所属外场/营业部
			 * 2013-05-04修改
			 * */
			OrgAdministrativeInfoEntity origOrg = orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(currentDept);
			if(origOrg != null){
				//当前部门顶级组织
				origOrg = querySuperiorOrgByOrgCode(currentDept);
				currentDept = origOrg.getCode();
			}else{
				LOGGER.error("找不到当前部门");
				throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_ORG_MESSAGECODE);
			}
		}

		if(StringUtils.isEmpty(nextDept)) {
			LOGGER.error("下一部门不能为空");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_NEXTDEPT_NOTBENULL, "");

		}
		if(StringUtils.isEmpty(sealType)) {
			LOGGER.error("封签绑定方式不能为空");
			throw new TfrBusinessException("封签绑定方式不能为空", "");
		}
		
		//校验封签合法性
		for(com.deppon.foss.module.transfer.pda.api.shared.domain.SealOrigDetailEntity seal : sealOrigDetails) {
			String sealNo = StringUtils.trim(seal.getSealNo());
			if(StringUtils.isNotEmpty(sealNo)) {
				if(sealNo.length() < LoadConstants.SONAR_NUMBER_7 || sealNo.length() > LoadConstants.SONAR_NUMBER_9) {
					LOGGER.error("封签号只能为7到9位的数字");
					throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
				}
				if(!NumberUtils.isDigits(sealNo)) {
					LOGGER.error("封签号只能为7到9位的数字");
					throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
				}
			}
		}

		//根据车牌号, 当前部门, 下一部门找车辆任务明细
		TruckTaskDetailEntity truckTaskDetail = getTruckTaskDetail(vehicleNo, currentDept, nextDept);
		LOGGER.error("车牌号："+vehicleNo+",出发部门："+currentDept+",到达部门："+nextDept);
		if(truckTaskDetail == null) {
			LOGGER.error("暂不能录入封签。系统后台正在处理装车数据，请耐心等待");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_UNCREATE_TRUCKTASK_MESSAGECODE, "");

		}
		
		//根据车辆任务id获取车辆任务
		TruckTaskEntity truckTask = vehicleSealDao.getTruckTaskById(truckTaskDetail.getParentId());
		if(truckTask == null) {
			LOGGER.error("车辆任务已被作废.");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_TRUCKTASK_CANCELED, "");
		}
		
		//2013-06-07 22:30
		SealEntity sealTemp = new SealEntity();
		sealTemp.setTruckTaskDetailId(truckTaskDetail.getParentId());
		sealTemp.setSealType(SealConstant.SEAL_TYPE_BIND);
		//根据任务车辆id找封签
		List<SealEntity> seals = querySealByTruckTaskId(sealTemp);
		//已绑定的不能有多条, 但是已校验的可以有多条, 因为A==>B==>C==>D  可能出现这样的情况
		if(seals != null) {
			if(seals.size() >= 1) {
				LOGGER.error("当前任务车辆已绑定封签, 不能重复绑定, 请刷新后操作.");
				throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_SEAL_BINDED, "");
			}
		}
		
		//车辆任务状态校验
		if(StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_ARRIVED)) {
			LOGGER.error("只有车辆状态为未到达时才能绑定");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_BIND_INVALID_TRUCKTASKSTATE_MESSAGECODE, "");
		}
		
		for(com.deppon.foss.module.transfer.pda.api.shared.domain.SealOrigDetailEntity seal : sealOrigDetails) {
			if(StringUtils.isNotEmpty(seal.getSealNo())) {
				String sealNo = seal.getSealNo();
				List<SealOrigDetailEntity> sealOrigDetailEntitys = querySealOrigDetailsBySealNo(sealNo);
				if(CollectionUtils.isNotEmpty(sealOrigDetailEntitys)) {
					LOGGER.error("重复的封签.");
					throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_REPEAT_SEALNO + ": " + sealNo, "");
				}
			}
		}

		//封签entity
		SealEntity seal = new SealEntity();
		//封签id
		seal.setId(UUIDUtils.getUUID());
		//车牌号
		seal.setVehicleNo(vehicleNo);
		//封车人
		seal.setSealerCode(sealerCode);
		//人员entity
		EmployeeEntity employee = employeeService.queryEmployeeByEmpCode(sealerCode);
		if(employee == null) {
			LOGGER.error("用户编号错误, 找不到相应用户");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_UNFIND_USER_MESSAGECODE, "");
		}
		//封车人name
		seal.setSealerName(employee.getEmpName());
		//pda机器号
		seal.setPdaDeviceNo(pdaDeviceNo);
		//封车部门code
		
		OrgAdministrativeInfoEntity sealOrgSupInfo = querySuperiorOrgByOrgCode(sealdOrgCode);
		if(sealOrgSupInfo != null){
			sealdOrgCode = sealOrgSupInfo.getCode();
		}
		
		seal.setSealdOrgCode(sealdOrgCode);
		//封车部门name
		String orgName = getOrgNameByOrgCode(sealdOrgCode);
		//封车部门name
		seal.setSealdOrgName(orgName);
		//车辆任务id
		seal.setTruckTaskDetailId(truckTask.getId());
		//封签类型
		seal.setSealType(SealConstant.SEAL_TYPE_BIND);
		//绑定封签的方式
		seal.setBindType(sealType);
		//封签状态
		seal.setSealState(SealConstant.SEAL_STATE_UNCHECK);
		//操作时间
		seal.setOperateTime(new Date());
		//封车时间
		seal.setSealTime(new Date());

		//封签校验时间
		seal.setCheckTime(null);
		
		//封签检查类型
		seal.setCheckType(sealType);
		//封签明细
		List<SealOrigDetailEntity> sealOrigs = new ArrayList<SealOrigDetailEntity>(sealOrigDetails.size());
		for(com.deppon.foss.module.transfer.pda.api.shared.domain.SealOrigDetailEntity s : sealOrigDetails) {
			//封签号
			String sealNo = StringUtils.trim(s.getSealNo());
			if(StringUtils.isNotEmpty(sealNo)) {
				//出发封签明细
				SealOrigDetailEntity sealOrigDetail = new SealOrigDetailEntity();
				//封签号
				sealOrigDetail.setSealNo(sealNo);
				//封签类型MANA-348 不分侧后门
				sealOrigDetail.setSealType(SealConstant.SEAL_TYPE_DETAIL_NONE);
				//绑定封签方式
				sealOrigDetail.setBindType(s.getBindType());
				//封签明细id
				sealOrigDetail.setId(UUIDUtils.getUUID());
				//封签id
				sealOrigDetail.setSealId(seal.getId());
				//封签明细操作时间
				sealOrigDetail.setOperateTime(new Date());
				sealOrigs.add(sealOrigDetail);
			}
		}

		//插入封签
		vehicleSealDao.insertSeal(seal);
		//插入封签明细
		vehicleSealDao.insertSealOrigDetail(sealOrigs);
		//车辆状态为 "未出发", "在途" -- 需更新车辆任务明细vehicle_seal_id
		updateTruckTaskDetailByTruckTaskId(seal);
		//如果当前部门为外场, 需生成车辆放行
		OrgAdministrativeInfoEntity orgAdministrativeInfo = orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(currentDept);
		if(StringUtils.equals(FossConstants.YES, orgAdministrativeInfo.getTransferCenter())){
			//自动放行dto
			AutoDepartDTO autoDepart = new AutoDepartDTO();
			//车牌号
			autoDepart.setVehicleNo(seal.getVehicleNo());			//车牌号
			//司机code
			autoDepart.setDriverCode(truckTask.getDriverCode1());	//司机Code
			//司机姓名
			autoDepart.setDriverName(truckTask.getDriverName1());	//司机姓名
			//司机电话
			autoDepart.setDriverPhone(truckTask.getDriverPhone1());	//司机联系方式
			//申请人code
			autoDepart.setApplyUserCode(sealerCode);				//申请人Code
			//申请人name
			autoDepart.setApplyUserName(employee.getEmpName());		//申请人姓名
			//申请部门
			autoDepart.setApplyOrgCode(seal.getSealdOrgCode());		//申请部门
			//放行类型
			autoDepart.setAutoDepartType(DepartureConstant.AUTO_DEPART_TYPE_SEAL);//放行类型
			//放行事项
			autoDepart.setDepartItems(truckTask.getBusinessType());//放行事项
			//车辆任务id
			autoDepart.setTruckTaskId(truckTask.getId());
			//新增完毕后调用车辆放行的service自动生成放行ID
			seal.setTruckDepartId(webDepartureService.autoDepart(autoDepart));
		}
		//更新封签中的放行id
		updateSeal(seal);
		return FossConstants.SUCCESS;
	}



	/**
	* PDA接口, 录入到达封签
	* @Title: insertSealDest
	* @Description: PDA接口, 录入到达封签
	* @param sealState 	封签状态
	* @param vehicleNo 	车牌号
	* @param checkOrgCode 	校验部门
	* @param sealDestDetails 	封签明细
	* @param checkOrgMemo 	封签破损异常备注
	* @param checkerUser 	检查人编号
	* @param pdaDeviceNo 	PDA设备号 
	* @param sealType 		校验封签方式(SCANED, BY_HAND) @see SealConstant
	* 新接口==>正在使用的
	* @see com.deppon.foss.module.transfer.pda.api.server.service.IPdaVehicleSealService#insertSealDest(java.lang.String, java.lang.String, java.lang.String, java.util.List, java.util.List, java.lang.String, java.lang.String, java.lang.String, java.util.List)
	* @author: ibm-zhangyixin
	* @throws
	* Date:2013-3-19上午9:51:16
	* 
	*/
	@Transactional
	@Override
	public int insertSealDest(String sealState, String vehicleNo, String checkOrgCode,
			List<com.deppon.foss.module.transfer.pda.api.shared.domain.SealDestDetailEntity> sealDestDetails,
			String checkOrgMemo, String checkerUser, String pdaDeviceNo, String sealType) {
		if(StringUtils.isEmpty(checkOrgCode)) {
			LOGGER.error("校验部门为空");
			throw new TfrBusinessException("校验部门为空", "");
		}
		if(StringUtils.isEmpty(checkerUser)) {
			LOGGER.error("校验用户为空");
			throw new TfrBusinessException("校验用户为空", "");
		}
		if(StringUtils.isEmpty(pdaDeviceNo)) {
			LOGGER.error("PDA设备号为空");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_PDANO_EMPTY, "");
		}
		//封签号合法性校验
		if(CollectionUtils.isNotEmpty(sealDestDetails)) {
			for(com.deppon.foss.module.transfer.pda.api.shared.domain.SealDestDetailEntity sealDestDetail : sealDestDetails) {
				String sealNo = StringUtils.trim(sealDestDetail.getSealNo());
				if(StringUtils.isNotEmpty(sealNo)) {
					if(sealNo.length() < LoadConstants.SONAR_NUMBER_7 || sealNo.length() > LoadConstants.SONAR_NUMBER_9) {
						LOGGER.error("封签号只能为7到9位的数字");
						throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
					}

					if(!NumberUtils.isDigits(sealNo)) {
						LOGGER.error("封签号只能为7到9位的数字");
						throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_SEALNO_MESSAGECODE, "");
					}
				}
			}
		}

		//根据车牌号找封签
		SealEntity seal = getSealByVehicleNo(vehicleNo, false);

		//封签状态校验
		if(seal == null || StringUtils.equals(seal.getSealType(), SealConstant.SEAL_TYPE_CHECK)) {
			LOGGER.error("封签状态错误, 已被校验.");
//			return FossConstants.SUCCESS;
			throw new TfrBusinessException("封签状态错误, 已被校验.", "");
		}
		
		//组织信息
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(checkOrgCode);
		if(orgAdministrativeInfoEntity == null) {
			LOGGER.error("找不到当前部门");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_ORG_MESSAGECODE);
		}
		//当前部门顶级组织
		orgAdministrativeInfoEntity = querySuperiorOrgByOrgCode(checkOrgCode);
		checkOrgCode = orgAdministrativeInfoEntity.getCode();
		if(StringUtils.equals(seal.getSealdOrgCode(), checkOrgCode)) {
			//ISSUE-4429
			//KDTE-5390转的ISSUE
			//在非到达部门可以校验封签的基础上，新增限制，封签绑定部门不允许校验自己已绑定封签，只允许删除自己已绑封签； 
			LOGGER.error("本部门绑定的封签不能校验");
			throw new TfrBusinessException("本部门绑定的封签不能校验, 如果封签有误请做删除操作!", "");
		}
		
		String truckTaskId = seal.getTruckTaskDetailId();
		TruckTaskEntity truckTask = getTruckTaskById(truckTaskId);
		if(truckTask == null) {
			LOGGER.error("找不到相应车辆任务明细, 请刷新后操作.");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_UNFIND_TRUCKTASK_MESSAGECODE, "");
		}
		if(StringUtils.equals(truckTask.getState(), DepartureConstant.ARRIVAL_VEHICLE_CANCLED)) {
			LOGGER.error("该任务已被作废!");
			throw new TfrBusinessException("车辆任务已被作废!", "");
		}
		TruckTaskDetailEntity truckTaskDetail =  this.qeuryTruckTaskDetailByTaskIdAndDestOrgCode(truckTask.getId(),checkOrgCode,null);
		
		
		//是否已经到达
		boolean isArrival = true;
		//如果不为空则 当前部门为车辆任务到达部门
		if(truckTaskDetail!=null){
			//车辆任务状态校验
			if(StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_UNDEPART) 
					|| StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_ONTHEWAY)
					//必须当前子任务到达后才能校验封签
					&& !StringUtils.equals(truckTaskDetail.getState(),SealConstant.SEAL_TRUCK_STATUS_ARRIVED)
					&& !StringUtils.equals(truckTaskDetail.getState(),SealConstant.SEAL_TRUCK_STATUS_UNLOADED)) {
				//车辆未到达
				isArrival = false;
					//BUG-57708
					//&& !StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_UNLOADED)
				//MANA-348 封签不分侧后门, 可以未到达先校验, 待点击到达后再生成校验结果
	//			LOGGER.error("车辆状态错误, 不能校验");
	//			throw new TfrBusinessException("请先确认到达!", "");
			}
			
	//		//如果车辆未到达
	//		if(!isArrival) {
	//			//则判断车辆是否经过当前外场
	//			//经过当前部门则属于暂存数据类型(因为该车辆之后需要做到达)
	//			//不经过当前部门, 则说明当前车辆数据两地装车(该类型不需要做到达)
	//			Long result = queryTruckTaskDetailByTruckTaskIdAndDestCode(truckTask.getId(), checkOrgCode);
	//			if(result == 0) {
	//				//为0则说明在子任务中不存在该到达部门, 属于两地装车类型,直接校验即可不需暂存数据
	//				isArrival = true;
	//			}
	//		}
		}else{
			//为空则当前不是车辆任务到达部门
			//不是当前部门且是营业部则经过当前部门则属于暂存数据类型(因为该车辆之后需要做到达)
			//不经过当前部门, 则说明当前车辆数据两地装车(该类型不需要做到达)，如果是外场则校验不成功
			if(StringUtils.equals(orgAdministrativeInfoEntity.getTransferCenter(),FossConstants.YES)){
				LOGGER.error("非车辆任务到达部门不能校验封签!");
				throw new TfrBusinessException("非车辆任务到达部门不能校验封签!", "");
			}
	
		}	
		//到达封签明细
		List<SealDestDetailEntity> sealDetails = new ArrayList<SealDestDetailEntity>(sealDestDetails.size());
		if(CollectionUtils.isNotEmpty(sealDestDetails)) {
			for(com.deppon.foss.module.transfer.pda.api.shared.domain.SealDestDetailEntity sealDestDetail : sealDestDetails) {
				String sealNo = StringUtils.trim(sealDestDetail.getSealNo());
				if(StringUtils.isNotEmpty(sealNo)) {
					//到达封签明细
					SealDestDetailEntity sealDetail = new SealDestDetailEntity();
					//封签号
					sealDetail.setSealNo(sealNo);
					//封签类型MANA-348 不分侧后门
					sealDetail.setSealType(SealConstant.SEAL_TYPE_DETAIL_NONE);
					//封签校验方式 手输 扫描
					sealDetail.setCheckType(sealDestDetail.getCheckType());
					//封签明细id
					sealDetail.setId(UUIDUtils.getUUID());
					//封签id
					sealDetail.setSealId(seal.getId());
					//操作时间
					sealDetail.setOperateTime(new Date());
					sealDetails.add(sealDetail);
				}
			}
		}
		
		List<SealOrigDetailEntity> sealOrigDetails = getSealOrigDetailsBySealId(seal.getId());
		//如果查询出来的绑定封签明细为空, 则说明有bug
		if(CollectionUtils.isEmpty(sealOrigDetails)) {
			LOGGER.error("找不到录入的封签明细");
			throw new TfrBusinessException("找不到录入的封签明细!", "");
		}
		
		if(!StringUtils.equals(SealConstant.SEAL_STATE_DAMAGED, sealState)) {
			//如果为破损就不用再继续校验封签号了
			Boolean isdiff = checkoutSeal(sealOrigDetails, sealDetails);
			//如果有差异
			if(isdiff) {
				sealState = SealConstant.SEAL_STATE_EXCEPTION;
			}
		}
		
		//车牌号
		seal.setVehicleNo(vehicleNo);
		//封签类型
		if(isArrival) {
			seal.setSealType(SealConstant.SEAL_TYPE_CHECK);
		} else {
			seal.setIsTransientState(FossConstants.YES);
			seal.setSealType(SealConstant.SEAL_TYPE_BIND);
		}
		//校验封签方式
		seal.setCheckType(sealType);
		//封签状态
		seal.setSealState(sealState);
		//校验人
		seal.setCheckerCode(checkerUser);
		//人员信息
		EmployeeEntity employee = employeeService.queryEmployeeByEmpCode(checkerUser);
		if(employee == null) {
			LOGGER.error("用户编号错误, 找不到相应用户");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_UNFIND_USER_MESSAGECODE, "");
		}
		//校验人name
		seal.setCheckerUser(employee.getEmpName());
		//校验部门code
		seal.setCheckOrgCode(checkOrgCode);
		//校验部门name
		String checkOrgName = getOrgNameByOrgCode(checkOrgCode);
		//校验部门name
		seal.setCheckOrgName(checkOrgName);
		//校验时间
		seal.setCheckTime(new Date());
		//操作时间
		seal.setOperateTime(new Date());
		//校验备注
		seal.setCheckOrgMemo(checkOrgMemo);
		//pda设备号
		seal.setPdaDeviceNo(pdaDeviceNo);
		//校验类型
		seal.setCheckType(sealType);
		//更新封签
		vehicleSealDao.updateSeal(seal);
		//插入到达封签明细
		vehicleSealDao.insertSealDestDetail(sealDetails);

		if(!isArrival) {
			//由于接口返回值改变此处代码修改
			//return null;
			return FossConstants.SUCCESS;
		}
		
		//当封签状态为异常时上报OA差错
		if(!StringUtils.equals(SealConstant.SEAL_STATE_NORMAL, sealState)) {
			ConfigurationParamsEntity configurationParamsEntity = configurationParamsService.queryConfigurationParamsByOrgCode(DictionaryConstants.SYSTEM_CONFIG_PARM__TFR , ConfigurationParamsConstants.TFR_PARM__TFR_SEAL_EXC_LATEST_TIME, FossConstants.ROOT_ORG_CODE);
			Date beginReportOATime = com.deppon.foss.util.DateUtils.convert(configurationParamsEntity.getConfValue(), "yyyy-MM-dd HH:mm:ss");
			Date currentDate = new Date();
			if(currentDate.compareTo(beginReportOATime) > 0) {
				List<String> sealNos = new ArrayList<String>();
				for(SealDestDetailEntity sealDestDetail : sealDetails) {
					sealNos.add(sealDestDetail.getSealNo());
				}
				ResponseDto responseDto = reportSlipError(vehicleNo, sealState, seal, sealNos);
				if(responseDto == null) {
//					throw new TfrBusinessException("调用OA接口时出错, OA返回为空, 请联系相关人员!", "");
				} else {
					//oa差错编号
					seal.setOaErrorNo(responseDto.getErrorNo());
					//更新封签oa差错编号
					vehicleSealDao.updateSeal(seal);
				}
			}
		}
		
		
		return FossConstants.SUCCESS;
	}
	
	
	/**
	 * 车辆到达时将暂存状态的封签更新为已校验
	 * @author 163580
	 * @date 2014-2-25 上午9:26:01
	 * @param vehicleNo
	 * @return
	 * @see
	 */
	@Override
	public int updateSealForArrival(String vehicleNo) {
		SealEntity seal = getSealByVehicleNo(vehicleNo, false);
		if(seal == null) {
			//根据车牌号找不到绑定状态的封签
			return FossConstants.FAILURE;
		}
		if(!StringUtils.equals(seal.getIsTransientState(), FossConstants.YES)) {
			//封签不是暂存状态的
			return FossConstants.FAILURE;
		}
		seal.setIsTransientState(FossConstants.NO);
		seal.setSealType(SealConstant.SEAL_TYPE_CHECK);
		String sealState = seal.getSealState();
		if(!StringUtils.equals(sealState, SealConstant.SEAL_STATE_NORMAL)) {
			List<SealDestDetailEntity> sealDestDetails = querySealDestDetailsBySealId(seal.getId());
			List<String> sealDestNos = new ArrayList<String>(sealDestDetails.size());
			for(SealDestDetailEntity sealDestDetailEntity : sealDestDetails) {
				sealDestNos.add(sealDestDetailEntity.getSealNo());
			}
			//上报OA差错
			ConfigurationParamsEntity configurationParamsEntity = configurationParamsService.queryConfigurationParamsByOrgCode(DictionaryConstants.SYSTEM_CONFIG_PARM__TFR , ConfigurationParamsConstants.TFR_PARM__TFR_SEAL_EXC_LATEST_TIME, FossConstants.ROOT_ORG_CODE);
			Date beginReportOATime = com.deppon.foss.util.DateUtils.convert(configurationParamsEntity.getConfValue(), "yyyy-MM-dd HH:mm:ss");
			Date currentDate = new Date();
			if(currentDate.compareTo(beginReportOATime) > 0) {
				ResponseDto responseDto = reportSlipError(vehicleNo, sealState, seal, sealDestNos);
				if(responseDto == null) {
//				throw new TfrBusinessException("调用OA接口时出错, OA返回为空, 请联系相关人员!", "");
				} else {
					//oa差错编号
					seal.setOaErrorNo(responseDto.getErrorNo());
				}
			}
		}
		updateSeal(seal);
		return FossConstants.SUCCESS;
	}

	/**
	 * 封签校验操作 
	 * @author ibm-zhangyixin
	 * @date 2012-10-19 下午4:41:49
	 */
	public Boolean checkoutSeal(List<SealOrigDetailEntity> sealOrigDetails, List<SealDestDetailEntity> sealDestDetails) {
		Boolean isdiff = false;
		if(sealDestDetails.size() != sealOrigDetails.size()) {
			//出发到达封签数量不一致
			//true为有差异
			return true;
		}
		for(SealDestDetailEntity sealDestDetail : sealDestDetails) {
			String destSealNo = sealDestDetail.getSealNo();
			for(SealOrigDetailEntity sealOrigDetail : sealOrigDetails) {
				//如果当前封签尚未校验
				if(!sealOrigDetail.getInspected()) {
					String origSealNo = sealOrigDetail.getSealNo();
					//如果封签类型相同并且封签号相同跳出当前循环, 继续校验下一个封签号
					if(StringUtils.equals(destSealNo, origSealNo)) {
						sealOrigDetail.setInspected(true);
						sealDestDetail.setIsdiff(false);
						sealOrigDetail.setIsdiff(false);
						break;
					}
				}
			}
		}
		for(SealDestDetailEntity sealDestDetail : sealDestDetails) {
			if(sealDestDetail.getIsdiff()) {
				isdiff = true;
				break;
			}
		}
		return isdiff;
	}
	//end	
	
	/**
	 * 封签上报OA差错
	 * 
	 * @Title: reportSlipError
	 *  
	 * @Description: 封签上报OA差错
	 * 
	 * @param vehicleNo
	 * 
	 * @param sealState
	 * 
	 * @param seal
	 * 
	 * @param backSealNos
	 * 
	 * @param sideSealNos
	 * 
	 * @return
	 *     
	 * @return ResponseDto    返回类型
	 *  
	 * reportSlipError
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午10:03:50
	 */
	private ResponseDto reportSlipError(String vehicleNo, String sealState, 
			SealEntity seal, List<String> sealDestDetails) {
		//oa封签差错entity
		OaReportSlipError oaReportSlipError = new OaReportSlipError();
		//车牌号
		oaReportSlipError.setCarNo(vehicleNo);
		//差错类型
		if(StringUtils.equals(sealState, SealConstant.SEAL_STATE_DAMAGED)) {
			oaReportSlipError.setSlipType("封签损坏");
		} else if (StringUtils.equals(sealState, SealConstant.SEAL_STATE_EXCEPTION)) {
			oaReportSlipError.setSlipType("封签号异常");
		}
		//到达部门
		String destOrgCode = getDestOrgCodeBySealId(seal.getId());
		//设置到达部门
		oaReportSlipError.setArrivedDept(destOrgCode);
		StringBuffer sealNos = new StringBuffer();
		for(String sealNo : sealDestDetails) {
			sealNos.append(sealNo).append(SealConstant.SEAL_DTO);
		}
		String sealNoStr = sealNos.toString();
		if(sealNoStr.length() > 0 && sealNoStr.lastIndexOf(SealConstant.SEAL_DTO) == sealNoStr.length() - 1) {
			//把最后一位的","号给去除
			sealNoStr = sealNoStr.substring(0, sealNoStr.length() - 1);
		}
		//封签号码
		oaReportSlipError.setSlipNo(sealNoStr);//封签号码
		//人员信息
		EmployeeEntity employee = employeeService.queryEmployeeByEmpCode(seal.getCheckerCode());
		if(employee != null) {
			//上报人code
			oaReportSlipError.setScannerUserID(employee.getEmpCode());
			//上报人name
			oaReportSlipError.setScannerUserName(employee.getEmpName());
			//上报人部门
			oaReportSlipError.setScannerUserDept(employee.getDepartment().getName());
		} else {
			//上报人code
			oaReportSlipError.setScannerUserID(seal.getCheckerCode());
			//上报人name
			oaReportSlipError.setScannerUserName(seal.getCheckerUser());
			//上报人部门
			oaReportSlipError.setScannerUserDept("");
		}
		//封签校验时间
		Date checkTime = seal.getCheckTime();
		if(checkTime == null) {
			//可能存在checkTime为空的数据, 因为有时会手工更改数据库的封签状态, 而没有手工把checkTime给修改
			//导致该时间为空
			checkTime = new Date();
		}
		oaReportSlipError.setScanTime(seal.getCheckTime());
		//车辆任务entity
		TruckTaskEntity truckTask = vehicleSealDao.getTruckTaskById(seal.getTruckTaskDetailId());
		if(truckTask == null) {
			throw new TfrBusinessException("车辆任务已被作废" + seal.getTruckTaskDetailId());
		}
		//司机信息
		oaReportSlipError.setResDriverUserID(truckTask.getDriverCode1());
		VehicleAssociationDto vehicleAssociation = vehicleService.queryVehicleAssociationDtoByVehicleNo(vehicleNo);
		if(StringUtils.equals(ComnConst.ASSETS_OWNERSHIP_TYPE_LEASED, vehicleAssociation.getVehicleOwnershipType())) {
			//为外请车
			oaReportSlipError.setCarType("外请车辆");
			//车辆所属部门
			oaReportSlipError.setResOutDriverDept(vehicleAssociation.getVehicleOrganizationName());
			//司机name
			oaReportSlipError.setResOutDriverUserName(truckTask.getDriverName1());
		} else {
			employee = employeeService.queryEmployeeByEmpCode(truckTask.getDriverCode1());
			if(employee == null) {
				if(StringUtils.isEmpty(seal.getPdaDeviceNo())) {
					//如果PDA设备号为空, 也就是该封签由FOSS生成的.
					throw new TfrBusinessException("车辆司机错误, 车辆为公司车, 但司机为外请司机!");
				} else {
					//如果为PDA生成.并且司机为空.则需要想办法找个司机.
					//司机相关信息
					com.deppon.foss.module.transfer.departure.api.shared.domain.RelationInfoEntity relationInfo = queryDriverByVehicleNoService.queryDriverInfoByVehicleNo(vehicleNo);
					if(relationInfo==null){
						return null;
					}
					employee = employeeService.queryEmployeeByEmpCode(relationInfo.getDriverCode());
				
					if(employee == null) {
						//因为综合接口默认是查bse.t_bas_employee.active = Y 的, 
						//但是有些员工可能当时封签的时候为Y, 但到上报差错这段时间内有被改为N了
						//所以该接口有可能查不到数据;
						//也就是说上面综合提供的接口, 需要默认查Y的, 查不到再查最近一条为N的;
						return null;
					}
				}
			}
			//公司车
			oaReportSlipError.setCarType("公司车辆");
			//责任司机工号
			oaReportSlipError.setResDriverUserID(employee.getEmpCode());
			//责任司机姓名
			oaReportSlipError.setResDriverUserName(employee.getEmpName());
			OrgAdministrativeInfoEntity orgAdministrativeInfo = employee.getDepartment();
			if(orgAdministrativeInfo == null) {
				//责任司机部门
				oaReportSlipError.setResDriverDept(employee.getOrgCode());
				//责任司机部门code
				oaReportSlipError.setResDriverDeptID(employee.getOrgCode());
			} else {
				//责任司机部门
				oaReportSlipError.setResDriverDept(orgAdministrativeInfo.getName());
				//责任司机部门code
				oaReportSlipError.setResDriverDeptID(orgAdministrativeInfo.getCode());
			}
		}
		
		oaReportSlipError.setEventReport("FOSS上报");
		try {
			//上报
			return fossToOAService.reportSlipError(oaReportSlipError);
		} catch (Exception e) {
			LOGGER.error("上报OA差错时出错, 请联系OA接口相关人员");
			return null;
//			throw new TfrBusinessException("上报OA差错时出错, 请联系OA接口相关人员.\n" + e.getMessage(), "");
		}
	}
	
	/** 
	 * @Title: autoReportSlipError 
	 * @Description: 自动上传封签差错到OA		JOB执行      
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#autoReportSlipError()
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-5-16下午5:20:41
	 */ 
	@Transactional
	@Override
	public void autoReportSlipError() {
		ConfigurationParamsEntity configurationParamsEntity = configurationParamsService.queryConfigurationParamsByOrgCode(DictionaryConstants.SYSTEM_CONFIG_PARM__TFR , ConfigurationParamsConstants.TFR_PARM__TFR_SEAL_EXC_LATEST_TIME, FossConstants.ROOT_ORG_CODE);
		Date beginReportOATime = com.deppon.foss.util.DateUtils.convert(configurationParamsEntity.getConfValue(), "yyyy-MM-dd HH:mm:ss");
		Date currentDate = new Date();
		if(currentDate.compareTo(beginReportOATime) < 0) {
			return;
		}
		//查询出所有未上报的封签
		List<SealEntity> seals = queryUnReportSeal();
		if(seals == null || seals.size() == 0) {
			return;
		}
		for(SealEntity seal : seals) {
			//根据封签ID查出到达封签明细
			List<SealDestDetailEntity> sealDestDetails = querySealDestDetailsBySealId(seal.getId());
			if(sealDestDetails == null) {
				sealDestDetails = new ArrayList<SealDestDetailEntity>();
			}
			//车牌号
			String vehicleNo = seal.getVehicleNo();
			//封签状态
			String sealState = seal.getSealState();
			//封签
			List<String> sealNos = new ArrayList<String>();
			for(SealDestDetailEntity sealDest : sealDestDetails) {
				sealNos.add(sealDest.getSealNo());
			}
			ResponseDto response = null;
			try {
				//调用OA上报差错的接口
				response = reportSlipError(vehicleNo, sealState, seal, sealNos);
				if(response == null) {
					//返回为空可能为OA接口返回为空, 也可能是PDA的封签没有司机返回为空
					throw new TfrBusinessException("调用OA接口时出错, OA返回为空, 请联系相关人员!", "");
				}
				//设置OA返回的差错编号
				seal.setOaErrorNo(response.getErrorNo());
				//更新封签
				updateSeal(seal);
			} catch (Exception e) {
				// 记录出错日志
				LOGGER.error("执行封签OA上报job时出错, 封签ID:" + seal.getId() + ", 异常信息:" + e.getMessage() + "response : " + response);
				TfrJobProcessLogEntity jobProcessLogEntity = new TfrJobProcessLogEntity();
				jobProcessLogEntity.setBizName(TfrJobBusinessTypeEnum.LOAD_VEHICLE_SEAL_DATA_JOB.getBizName());
				jobProcessLogEntity.setBizCode(TfrJobBusinessTypeEnum.LOAD_VEHICLE_SEAL_DATA_JOB.getBizCode());
				jobProcessLogEntity.setRemark("任务执行失败!");
				jobProcessLogEntity.setExceptionInfo("执行封签OA上报job时出错, 封签ID:" + seal.getId() + ", 异常信息:" + e.getMessage() + "response : " + response);
				jobProcessLogEntity.setCreateTime(Calendar.getInstance().getTime());
				
				tfrCommonService.addJobProcessLog(jobProcessLogEntity);
				continue;
			}
		}
	}
	
	/**
	 * @Title: queryUnReportSeal 
	 * @Description: 查询出未上报差错的封签 
	 * @return    
	 * @return List<SealEntity>    返回类型 
	 * queryUnReportSeal
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-5-16下午5:31:23
	 */
	public List<SealEntity> queryUnReportSeal() {
		return vehicleSealDao.queryUnReportSeal();
	}
	
	/**
	 * 删除封签关系
	 * 
	 * 如果封签类型为绑定封签, 并且车辆出发状态为未到达才可以修改, 删除
	 * 
	 * @Title: deleteSeal
	 *  
	 * @Description: 删除封签关系
	 * 
	 * 如果封签类型为绑定封签, 并且车辆出发状态为未到达才可以修改, 删除
	 * 
	 * @param id
	 * 
	 * @return
	 * 
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#deleteSeal(java.lang.String)
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午10:03:15
	 * 
	 */
	@Transactional
	@Override
	public int deleteSeal(String id) {
		//根据id获取封签信息
		SealEntity seal = vehicleSealDao.getSealById(id);
		//根据车辆任务id获取车辆任务信息, 包括已作废的
		TruckTaskEntity truckTask = vehicleSealDao.getTruckTaskByIdCancled(seal.getTruckTaskDetailId());
		if(truckTask == null) {
			LOGGER.error("找不到相应车辆任务明细, 请刷新后操作.");
			throw new TfrBusinessException("找不到相应车辆任务明细, 请刷新后操作.", "");
		}
		
		//当前部门code
		String currentOrgCode = FossUserContext.getCurrentDeptCode();
		//组织信息
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(currentOrgCode);
		//当前部门顶级组织
		orgAdministrativeInfoEntity = querySuperiorOrgByOrgCode(currentOrgCode);
		currentOrgCode = orgAdministrativeInfoEntity.getCode();
				
		//根据车辆任务ID, 当前部门code, 找出发部门或到达部门为当前部门的任务明细
		List<TruckTaskDetailEntity> truckTaskDetails = queryTruckTaskDetailByTruckTaskId(truckTask.getId(), currentOrgCode);
		//判定营业部是否有对应快递分部，若有查询出该分部的到达车辆信息
		ExpressBranchSalesDeptEntity  branchSalesDeptEntity = new ExpressBranchSalesDeptEntity();
		branchSalesDeptEntity.setSalesDeptCode(currentOrgCode);
		ExpressBranchSalesDeptEntity branchSalesDept= expressBranchSalesDeptService.
				queryByExpressBranchSalesDeptCode(branchSalesDeptEntity);
		//如果找不到 说明当前部门不能对该封签做删除操作
		if(truckTaskDetails == null || truckTaskDetails.size() == 0) {
			if(branchSalesDept !=null){
				List<TruckTaskDetailEntity> truckExTaskDetails = queryTruckTaskDetailByTruckTaskIdAndCode(truckTask.getId(), branchSalesDept.getExpressBranchCode());
				if(truckExTaskDetails == null || truckExTaskDetails.size() == 0){
					LOGGER.error("当前部门非车辆任务部门, 不能删除" + truckTask.getId() + "deptCode:" + currentOrgCode);
					throw new TfrBusinessException("当前部门非车辆任务部门, 不能删除", "");
				}
			}else{
				LOGGER.error("当前部门非车辆任务部门, 不能绑定" + truckTask.getId() + "deptCode:" + currentOrgCode);
				throw new TfrBusinessException("当前部门非车辆任务部门, 不能删除", "");
			}
		}
		
		//只有封签类型为绑定封签, 并且车辆出发状态为未到达才可以修改,删除
		if(!(StringUtils.equals(seal.getSealType(), SealConstant.SEAL_TYPE_BIND) 
				&& !StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_ARRIVED))) {
			LOGGER.error("只有封签类型为绑定封签, 并且车辆出发状态为未到达才可以修改.");
			throw new TfrBusinessException("只有封签类型为绑定封签, 并且车辆出发状态为未到达才可以删除, 请刷新后操作.", "");
		}

		//MANA-348 已出发的车辆不可删除
		if(!(StringUtils.equals(seal.getSealType(), SealConstant.SEAL_TYPE_BIND) 
				&& !StringUtils.equals(truckTask.getState(), SealConstant.SEAL_TRUCK_STATUS_ONTHEWAY))) {
			LOGGER.error("车辆已出发，不可删除已绑定的封签");
			throw new TfrBusinessException("车辆已出发，不可删除已绑定的封签", "");
		}
		//删除封签明细
//		vehicleSealDao.deleteSealOrigDetailBySealId(seal.getId());
		//删除封签关系
//		vehicleSealDao.deleteSealById(seal.getId());
		//改为逻辑删除
		seal.setSealType(SealConstant.SEAL_TYPE_INVALID);
		seal.setOperateTime(new Date());
		seal.setSealOrgMemo("工号:" + FossUserContext.getCurrentUser().getEmployee().getEmpCode() + "删除!");
		vehicleSealDao.updateSealToInvalid(seal);
		//车辆状态为 "未出发", "在途" -- 需更新车辆任务明细vehicle_seal_id
		seal.setId("");
		//更新任务车辆
		updateTruckTaskDetailByTruckTaskId(seal);
		//取消车辆放行
		String truckDepartId = seal.getTruckDepartId();
		if(StringUtils.isNotEmpty(truckDepartId)) {
			List<String> departureId = new ArrayList<String>(1);
			departureId.add(truckDepartId);
			try {
				departureService.cancleWaitDepart(departureId);
			} catch (Exception e) {
				throw new TfrBusinessException("取消放行任务时出错departureService.cancleWaitDepart", "");
			}
		}
		return FossConstants.SUCCESS;
	}
	private List<TruckTaskDetailEntity> queryTruckTaskDetailByTruckTaskIdAndCode(String id,String deptCode){
		List<TruckTaskDetailEntity>  temp = vehicleSealDao.queryTruckTaskDetailByTruckTaskIdAndCode(id, deptCode);
		return temp;
	}
	/**
	 * 根据封签ID获取到达部门编号
	 * 
	 * @author ibm-zhangyixin
	 * 
	 * @date 2012-12-11 上午10:37:00\
	 * 
	 */
	private String getDestOrgCodeBySealId(String id) {
		//根据封签ID获取到达部门编号
		return vehicleSealDao.getDestOrgCodeBySealId(id);
	}
	
	/**
	 * 根据封签ID获取车辆任务明细信息
	 * 
	 * @author ibm-zhangyixin
	 * 
	 * @date 2012-12-11 上午11:41:09
	 */
//	private TruckTaskDetailEntity getTruckTaskDetailBySealId(String id) {
//		return vehicleSealDao.getTruckTaskDetailBySealId(id);
//	}
	
	/**
	 * 根据部门号获取部门名称
	 * 
	 * @Title: getOrgNameByOrgCode 
	 *
	 * @Description: 根据部门号获取部门名称
	 * 
	 * @param orgCode
	 * 
	 * @return    设定文件
	 *  
	 * @return String    返回类型
	 *  
	 * @see getOrgNameByOrgCode
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午9:56:44
	 */
	private String getOrgNameByOrgCode(String orgCode) {
		//根据部门号获取部门名称
		return vehicleSealDao.getOrgNameByOrgCode(orgCode);
	}

	/**
	 * 根据车牌号查询司机信息
	 * 
	 * @Title: queryDriverNameByVehicleNo
	 *  
	 * @Description: 根据车牌号查询司机信息
	 * 
	 * @param vehicleNo
	 * 
	 * @return
	 *     
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#queryDriverNameByVehicleNo(java.lang.String)
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午9:56:29
	 */
	@Override
	public RelationInfoEntity queryDriverNameByVehicleNo(String vehicleNo) {
		//司机相关信息
		RelationInfoEntity relationInfo = new RelationInfoEntity();
		
		//司机相关信息
		com.deppon.foss.module.transfer.departure.api.shared.domain.RelationInfoEntity entity = queryDriverByVehicleNoService.queryDriverInfoByVehicleNo(vehicleNo);
		if(entity == null) {
			LOGGER.error("找不到该车辆司机相关信息");
			throw new TfrBusinessException("找不到该车辆司机相关信息", "");
		}
		//司机工号
		relationInfo.setDriverCode(entity.getDriverCode());
		//司机姓名
		relationInfo.setDriverName(entity.getDriverName());
		//司机电话
		relationInfo.setDriverPhone(entity.getDriverPhone());
		//车队部门经理电话
		relationInfo.setFleetManagerPhone(entity.getFleetManagerPhone());
		return relationInfo;
	}
	
	/**
	 * 根据车牌号查询司机信息
	 * 
	 * (先根据车牌号找到车辆任务明细ID, 再根据车辆任务明细ID关联到交接单查询)
	 * 
	 * @author ibm-zhangyixin
	 * 
	 * @date 2013-1-5 下午4:50:27
	 * 
	 */
//	@Override
//	public RelationInfoEntity queryDriverInfoByVehicleNo(String vehicleNo) {
//		List<TruckTaskDetailEntity> truckTaskDetail = getTruckTaskDetailId(vehicleNo, FossUserContext.getCurrentDeptCode());
//		if(truckTaskDetail == null || truckTaskDetail.size() == 0) {
//			LOGGER.error("根据车牌号找不到相应的任务车辆明细");
//			throw new TfrBusinessException("根据车牌号找不到相应的任务车辆明细", "");
//		}
//		return vehicleSealDao.queryDriverInfoByTaskDetailId(truckTaskDetail.getId());
//	}
	
	/**
	 * 根据车辆任务ID查询单据信息
	 * 
	 * @Title: queryBillInfoByTruckTaskId
	 *  
	 * @Description: 根据车辆任务ID查询单据信息
	 * 
	 * @param truckTaskId
	 * 
	 * @return
	 *     
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#queryBillInfoByTruckTaskId(java.lang.String)
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午9:55:45
	 * 
	 */
	@Override
	public List<BillInfoDto> queryBillInfoByTruckTaskId(String truckTaskId) {
		//根据车辆任务id查询车辆任务
		TruckTaskEntity truckTask = vehicleSealDao.getTruckTaskByIdCancled(truckTaskId);
		if(truckTask == null) {
			throw new TfrBusinessException("找不到相应的车辆任务", "");
		}
		Map<String, String> map = new HashMap<String, String>(2);
		map.put("id", truckTaskId);
		map.put("businessType", truckTask.getBusinessType());
		//根据车辆任务ID查询单据信息
		return vehicleSealDao.queryBillInfoByTruckTaskId(map);
	}
	
	/**
	 * 根据车辆任务ID更新车辆任务明细中的封签ID(vehicle_seal_id)
	 * 
	 * 绑定封签时, 车辆状态为 "未出发", "在途" 需更新车辆任务明细vehicle_seal_id
	 * 
	 * 删除绑定关系时, 同上, 更新车辆任务明细 vehicle_seal_id
	 * 
	 * @Title: updateTruckTaskDetailByTruckTaskId
	 *  
	 * @Description: 根据车辆任务ID更新车辆任务明细中的封签ID(vehicle_seal_id)
	 * 
	 * 绑定封签时, 车辆状态为 "未出发", "在途" 需更新车辆任务明细vehicle_seal_id
	 * 
	 * 删除绑定关系时, 同上, 更新车辆任务明细 vehicle_seal_id
	 * 
	 * @param seal
	 *     
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#updateTruckTaskDetailByTruckTaskId(com.deppon.foss.module.transfer.load.api.shared.domain.SealEntity)
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午9:53:58
	 * 
	 */
	@Override
	public void updateTruckTaskDetailByTruckTaskId(SealEntity seal) {
		//根据车辆任务ID更新车辆任务明细中的封签ID(vehicle_seal_id)
		//绑定封签时, 车辆状态为 "未出发", "在途" 需更新车辆任务明细vehicle_seal_id
		//删除绑定关系时, 同上, 更新车辆任务明细 vehicle_seal_id
		vehicleSealDao.updateTruckTaskDetailByTruckTaskId(seal);
	}

	/**
	 * 绑定封签后:
	 * 		如果车辆任务表中的司机为空, 就使用绑定封签时的司机 将其更新
	 * @Title: updateTruckTaskDriverByTruckTaskId 
	 * 
	 * @Description: 绑定封签后, 如果车辆任务表中的司机为空
	 *			就使用绑定封签时的司机 将其更新
	 * @param seal
	 *     
	 * @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#updateTruckTaskDriverByTruckTaskId(com.deppon.foss.module.transfer.load.api.shared.domain.SealEntity)
	 * 
	 * @author: ibm-zhangyixin
	 * 
	 * @throws
	 *  
	 * Date:2013-3-19上午9:53:37
	 * 
	 */
	@Override
	public void updateTruckTaskDriverByTruckTaskId(SealEntity seal) {
		//绑定封签后, 如果车辆任务表中的司机为空, 就使用绑定封签时的司机 将其更新
		vehicleSealDao.updateTruckTaskDriverByTruckTaskId(seal);
	}
	
	
	/**
	 * 根据truckTaskId查询出交接单中的司机信息 
	* @Title: queryDriverInfoByTruckTaskId
	*  
	* @Description: 根据truckTaskId查询出交接单中的司机信息
	*  
	* @param truckTaskId
	* 
	* @return
	*     
	* @see com.deppon.foss.module.transfer.load.api.server.service.IVehicleSealService#queryDriverInfoByTruckTaskId(java.lang.String)
	* 
	* @author: ibm-zhangyixin
	* 
	* @throws
	*  
	* Date:2013-3-19上午9:51:56
	* 
	**/
	@Override
	public SealDto queryDriverInfoByTruckTaskId(String truckTaskId) {
		//根据truckTaskId查询出交接单中的司机信息
		return vehicleSealDao.queryDriverInfoByTruckTaskId(truckTaskId);
	}
	
	/**
	 * @Title: querySealOrigDetailsBySealNo 
	 * @Description: 根据封签号查询出所有的出发封签
	 * @param sealNo
	 * @return    
	 * @return List<SealOrigDetailEntity>    返回类型 
	 * querySealOrigDetailsBySealNo
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-4-19下午5:41:34
	 */
	@Override
	public List<SealOrigDetailEntity> querySealOrigDetailsBySealNo(String sealNo) {
		return vehicleSealDao.querySealOrigDetailsBySealNo(sealNo);
	}

	/**
	 * @Title: querySealOrigDetailsBySealNoAndId 
	 * @Description: 根据封签号和封签明细ID查询出所有的出发封签
	 * @param sealNo
	 * @return    
	 * @return List<SealOrigDetailEntity>    返回类型 
	 * querySealOrigDetailsBySealNo
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-4-19下午5:41:34
	 */
	@Override
	public List<SealOrigDetailEntity> querySealOrigDetailsBySealNoAndId(String sealNo, String id) {
		return vehicleSealDao.querySealOrigDetailsBySealNoAndId(sealNo, id);
	}

	/**
	 * @Title: querySealDestDetailsBySealNo 
	 * @Description: 根据封签号查询出所有的到达封签
	 * @param sealNo
	 * @return    
	 * @return List<SealOrigDetailEntity>    返回类型 
	 * querySealDestDetailsBySealNo
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-4-19下午5:42:19
	 */
	@Override
	public List<SealDestDetailEntity> querySealDestDetailsBySealNo(String sealNo) {
		return vehicleSealDao.querySealDestDetailsBySealNo(sealNo);
	}
	
	/**
	 * @Title: querySealDestDetailsBySealId 
	 * @Description: 根据封签ID查出到达封签明细
	 * @param sealId
	 * @return    
	 * @return List<SealDestDetailEntity>    返回类型 
	 * querySealDestDetailsBySealId
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-5-16下午5:38:53
	 */
	@Override
	public List<SealDestDetailEntity> querySealDestDetailsBySealId(String sealId) {
		return vehicleSealDao.querySealDestDetailsBySealId(sealId);
	}
	
	/**
	 * 
	 * 根据车辆任务ID获取车辆任务实体(包括已作废的) 
	 * @author zhangyixin
	 * @date 2013-10-28 上午11:49:59
	 * @param id
	 * @return
	 * @see
	 */
	public TruckTaskEntity getTruckTaskById(String id) {
		//包括已作废的
		return vehicleSealDao.getTruckTaskByIdCancled(id);
	}
	
	/**
	 * 
	 * 设置 * 获取司机信息serivce.
	 *
	 * @param queryDriverByVehicleNoService the new * 获取司机信息serivce
	 */
	public void setQueryDriverByVehicleNoService(
			IQueryDriverByVehicleNoService queryDriverByVehicleNoService) {
		this.queryDriverByVehicleNoService = queryDriverByVehicleNoService;
	}
	
	/**
	 * 
	 * 设置 ** 人员service.
	 *
	 * @param employeeService the new ** 人员service
	 */
	public void setEmployeeService(IEmployeeService employeeService) {
		this.employeeService = employeeService;
	}

	/**
	 * 
	 * 设置 * oa接口service.
	 *
	 * @param fossToOAService the new * oa接口service
	 */
	public void setFossToOAService(IFOSSToOAService fossToOAService) {
		this.fossToOAService = fossToOAService;
	}

	/**
	 * 
	 * 设置 * 获取车辆信息service.
	 *
	 * @param vehicleService the new * 获取车辆信息service
	 */
	public void setVehicleService(IVehicleService vehicleService) {
		this.vehicleService = vehicleService;
	}

	/**
	 * 
	 * 设置 获取组织信息service.
	 *
	 * @param orgAdministrativeInfoService the new 获取组织信息service
	 */
	public void setOrgAdministrativeInfoService(
			IOrgAdministrativeInfoService orgAdministrativeInfoService) {
		this.orgAdministrativeInfoService = orgAdministrativeInfoService;
	}

	/**   
	 * @param departureService the departureService to set
	 * Date:2013-4-27下午1:57:34
	 */
	public void setDepartureService(IDepartureService departureService) {
		this.departureService = departureService;
	}

	/**   
	 * @param orgAdministrativeInfoComplexService the orgAdministrativeInfoComplexService to set
	 * Date:2013-4-28下午4:47:43
	 */
	public void setOrgAdministrativeInfoComplexService(
			IOrgAdministrativeInfoComplexService orgAdministrativeInfoComplexService) {
		this.orgAdministrativeInfoComplexService = orgAdministrativeInfoComplexService;
	}

	/**   
	 * @param configurationParamsService the configurationParamsService to set
	 * Date:2013-5-15下午4:05:17
	 */
	public void setConfigurationParamsService(
			IConfigurationParamsService configurationParamsService) {
		this.configurationParamsService = configurationParamsService;
	}

	/**   
	 * @param leasedDriverService the leasedDriverService to set
	 * Date:2013-6-1下午6:51:56
	 */
	public void setLeasedDriverService(ILeasedDriverService leasedDriverService) {
		this.leasedDriverService = leasedDriverService;
	}

	/**   
	 * @param commonService the commonService to set
	 * Date:2013-6-1下午9:49:51
	 */
	public void setTfrCommonService(ITfrCommonService commonService) {
		this.tfrCommonService = commonService;
	}

	/**
	 * @Title: setSecurityTfrMotorcadeService 
	 * @Description: setSecurityTfrMotorcadeService
	 * @author sunjianbo
	 * @date 2014-5-19 上午9:35:16 
	 * @param securityTfrMotorcadeService void
	 * @throws 
	 */ 
	public void setSecurityTfrMotorcadeService(
			ISecurityTfrMotorcadeService securityTfrMotorcadeService) {
		this.securityTfrMotorcadeService = securityTfrMotorcadeService;
	}

	
	/**
	 *com.deppon.foss.module.transfer.load.api.server.service  
	 *@desc 根据任务车辆ID，状态 PRE，当前校验部门顶级外场 查询预分配月台号
	 *@param 
	 *@return String
	 *@author 105795
	 *@date 2015年5月6日下午2:18:34 
	 */
	@Override
	public String queryPrePlatformCodeByTruckTaskId(String orgCode,String truckTaskId) {
		if(StringUtil.isEmpty(orgCode)||StringUtil.isEmpty(truckTaskId)){
			throw new TfrBusinessException("参数不能为空");
		}
		String platformNo=vehicleSealDao.queryPrePlatformCodeByTruckTaskId(orgCode, truckTaskId);
		if(StringUtil.isNotEmpty(platformNo)){
			return platformNo;
		}else{
			return null;
		}
	}

	/**
	 * 录入到达封签时获取预分配月台号
	 * @author wqh
	 * @date 2015-06-01 上午09:17:48
	 * @param sealState 	封签状态
	 * @param vehicleNo 	车牌号
	 * @param checkOrgCode 	校验部门
	 * @param sealDestDetails 	封签明细
	 * @param checkOrgMemo 	封签破损异常备注
	 * @param checkerUser 	检查人编号
	 * @param pdaDeviceNo 	PDA设备号 
	 * @param sealType 		校验封签方式(SCANED, BY_HAND) @see SealConstant
	 */
	@Override
	@Transactional
	public String insertSealDestNew(
			String sealState,
			String vehicleNo,
			String checkOrgCode,
			List<com.deppon.foss.module.transfer.pda.api.shared.domain.SealDestDetailEntity> sealDestDetails,
			String checkOrgMemo, String checkerUser, String pdaDeviceNo,
			String sealType) {
		//调原始接口
		//insertSealDest(sealState,vehicleNo,checkOrgCode,sealDestDetails,checkOrgMemo,checkerUser,pdaDeviceNo,sealType);
		//组织信息
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(checkOrgCode);
		if(orgAdministrativeInfoEntity == null) {
			LOGGER.error("找不到当前部门");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_ORG_MESSAGECODE);
		}
		//当前部门顶级组织
		orgAdministrativeInfoEntity = querySuperiorOrgByOrgCode(checkOrgCode);
		checkOrgCode = orgAdministrativeInfoEntity.getCode();
		//根据车牌号找封签
		//SealEntity seal = getSealByVehicleNo(vehicleNo, false);
		// 根据到达部门、车牌号查询任务车辆id 默认查询7天之内数据
		String truckTaskId=this.queryTruckTaskIdByVehicleNo(checkOrgCode,vehicleNo);
		if(StringUtil.isNotEmpty(truckTaskId)){
			/**
			 * @desc 根据任务车辆ID，状态 PRE，当前校验部门顶级外场 查询预分配月台号
			 * */
			String platformCode=vehicleSealDao.queryPrePlatformCodeByTruckTaskId(checkOrgCode, truckTaskId);
			/**
			 * @desc 保留获取预分配月台的时间时间
			 * @author 105795
			 * @date 2015-07-07
			 * */
			VehicleEntranceEntity entranceEntity=new VehicleEntranceEntity();
			//车辆任务id
			entranceEntity.setTruckTaskId(truckTaskId);
			//车牌
			if(StringUtil.isNotEmpty(vehicleNo)){
				entranceEntity.setVehicleNo(vehicleNo);
			}
			//外场编码
			entranceEntity.setTfrCtrCode(checkOrgCode);
			//外场名称
			entranceEntity.setTfrCtrName(orgAdministrativeInfoEntity.getName()==null?"":orgAdministrativeInfoEntity.getName());
			//月台号
			entranceEntity.setPlatformCode(platformCode==null?"":platformCode);
			//持久层
			vehicleEntranceService.saveVehicleEntrance(entranceEntity);
			
			if(StringUtil.isNotEmpty(platformCode)){
				return platformCode;
			}else{
				//无月台号就返回空值
				return null;
			}
			
			
		}
		return null;
	}
	
	
	/**
	 *@desc 根据到达部门、车牌号查询任务车辆id 默认查询7天之内数据
	 *@param orgCode,vehicleNo
	 *@return String
	 *@author 105795
	 *@date 2015年7月10日 下午4:32:57 
	 */
	public String queryTruckTaskIdByVehicleNo(String orgCode,String vehicleNo){
	
		if(StringUtil.isEmpty(orgCode)||StringUtil.isEmpty(vehicleNo)){
		  throw new TfrBusinessException("部门或者车牌为空");	
		}
		//当前部门顶级组织
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = orgAdministrativeInfoService.queryOrgAdministrativeInfoByCode(orgCode);
		if(orgAdministrativeInfoEntity == null) {
			LOGGER.error("找不到当前部门");
			throw new TfrBusinessException(TransferPDAExceptionCode.EXCEPTION_INVALID_ORG_MESSAGECODE);
		}
		orgAdministrativeInfoEntity = querySuperiorOrgByOrgCode(orgCode);
		orgCode = orgAdministrativeInfoEntity.getCode();
		return vehicleSealDao.queryTruckTaskIdByVehicleNo(orgCode, vehicleNo);
	}
	
}