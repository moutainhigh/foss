/**
 *  initial comments.
 */
/*******************************************************************************
 * Copyright 2013 TFR TEAM
 *  
 *  Licensed under the DEPPON License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *  
 *     http://www.deppon.com/licenses/LICENSE-2.0
 *  
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *  Contributors:
 *  038300-foss-pengzhen - initial API and implementation
 * 
 *  PROJECT NAME  : tfr-load
 *  
 *  FILE PATH     : src/main/java/com/deppon/foss/module/transfer/load/server/action/VehicleAssembleBillAction.java
 *  
 *  FILE NAME          :VehicleAssembleBillAction.java
 * 
 *  AUTHOR  : FOSS中转系统开发组
 *  
 *  TIME              : 
 *  
 *  HOME PAGE    :  http://www.deppon.com
 * 
 *  COPYRIGHT    : Copyright (c) 2013  Deppon All Rights Reserved.
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 ******************************************************************************/
package com.deppon.foss.module.transfer.load.server.action;

import java.io.InputStream;
import java.io.UnsupportedEncodingException;
import java.math.BigDecimal;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.lang.StringUtils;






import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.deppon.foss.base.util.ComnConst;
import com.deppon.foss.framework.exception.BusinessException;
import com.deppon.foss.framework.server.web.action.AbstractAction;
import com.deppon.foss.framework.server.web.result.json.annotation.JSON;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.OutfieldEntity;
import com.deppon.foss.module.base.baseinfo.api.shared.dto.VehicleAssociationDto;
import com.deppon.foss.module.base.common.api.server.service.IBusinessLockService;
import com.deppon.foss.module.base.common.api.shared.define.MutexElementType;
import com.deppon.foss.module.base.common.api.shared.dto.MutexElement;
import com.deppon.foss.module.transfer.common.api.cubcgray.model.VestResponse;
import com.deppon.foss.module.transfer.common.api.server.service.IFossToCubcService;
import com.deppon.foss.module.transfer.common.api.shared.define.CUBCGrayContants;
import com.deppon.foss.module.transfer.common.api.shared.dto.CubcValidationSourceBillNoResponse;
import com.deppon.foss.module.transfer.common.api.shared.dto.GrayParameterDto;
import com.deppon.foss.module.transfer.common.api.shared.exception.TfrBusinessException;
import com.deppon.foss.module.transfer.common.server.utils.CUBCGrayUtil;
import com.deppon.foss.module.transfer.load.api.server.service.IVehicleAssembleBillService;
import com.deppon.foss.module.transfer.load.api.shared.define.LoadConstants;
import com.deppon.foss.module.transfer.load.api.shared.domain.VehicleAssembleBillEntity;
import com.deppon.foss.module.transfer.load.api.shared.dto.GetInfoWhenVehicleNoLostFocusDto;
import com.deppon.foss.module.transfer.load.api.shared.dto.QueryHandOverBillConditionDto;
import com.deppon.foss.module.transfer.load.api.shared.dto.QueryVehicleAssembleBillConditionDto;
import com.deppon.foss.module.transfer.load.api.shared.dto.RewardOrPunishAgreementDto;
import com.deppon.foss.module.transfer.load.api.shared.dto.UpdateVehicleAssembleBillDto;
import com.deppon.foss.module.transfer.load.api.shared.vo.VehicleAssembleBillVo;
import com.deppon.foss.module.transfer.scheduling.api.server.service.IInviteVehicleService;
import com.deppon.foss.module.transfer.scheduling.api.server.service.ITruckDepartPlanDetailService;
import com.deppon.foss.module.transfer.scheduling.api.shared.domain.PassInviteApplyEntity;
import com.deppon.foss.module.transfer.scheduling.api.shared.dto.TruckDepartPlanDetailDto;
import com.deppon.foss.util.DateUtils;
import com.deppon.foss.util.define.FossConstants;

/** 
 * @className: VehicleAssembleBillAction
 * @author: ShiWei shiwei@outlook.com
 * @description: 配载单模块action类
 * @date: 2012-11-8 下午2:58:40
 * 
 */
public class VehicleAssembleBillAction extends AbstractAction {
	
	private static final long serialVersionUID = -2354715897211392077L;

	/**
	 * 本模块service
	 */
	private IVehicleAssembleBillService vehicleAssembleBillService;
	
	/**
	 * 本模块Vo
	 */
	private VehicleAssembleBillVo vehicleAssembleBillVo = new VehicleAssembleBillVo();
	
	/**
	 * 这个输入流对应上面struts.xml中配置的那个excelStream，两者必须一致
	 */
	private InputStream wayBillExcelStream;  
	
	/**
	 * 导出配载单
	 */
	private InputStream vehicleAssembleBillExcelStream;  
	
	/**
	 * 这个名称就是用来传给上面struts.xml中的${fileName}的
	 */
	private String excelFileName;  
	
	/**
	 * 业务锁service
	 */
	private IBusinessLockService businessLockService;
	
	/**
	 * 发车计划service
	 */
	private ITruckDepartPlanDetailService truckDepartPlanDetailService;
	/**
	 *  外请车约车接口，用于查询约车价格
	 */
	private IInviteVehicleService inviteVehicleService;
	
	/**
	 * 调用cubc常用同步接口
	 */
	private IFossToCubcService fossToCubcService;
	
	private CUBCGrayUtil cubcUtil;

	public void setCubcUtil(CUBCGrayUtil cubcUtil) {
		this.cubcUtil = cubcUtil;
	}

	public void setFossToCubcService(IFossToCubcService fossToCubcService) {
		this.fossToCubcService = fossToCubcService;
	}

	public void setInviteVehicleService(IInviteVehicleService inviteVehicleService) {
		this.inviteVehicleService = inviteVehicleService;
	}

	public void setTruckDepartPlanDetailService(
			ITruckDepartPlanDetailService truckDepartPlanDetailService) {
		this.truckDepartPlanDetailService = truckDepartPlanDetailService;
	}

	public void setBusinessLockService(IBusinessLockService businessLockService) {
		this.businessLockService = businessLockService;
	}

	public InputStream getWayBillExcelStream() {
		return wayBillExcelStream;
	}

	public void setWayBillExcelStream(InputStream wayBillExcelStream) {
		this.wayBillExcelStream = wayBillExcelStream;
	}

	public String getExcelFileName() {
		return excelFileName;
	}

	public void setExcelFileName(String excelFileName) {
		this.excelFileName = excelFileName;
	}

	public void setVehicleAssembleBillService(
			IVehicleAssembleBillService vehicleAssembleBillService) {
		this.vehicleAssembleBillService = vehicleAssembleBillService;
	}
	
	/**
	 * 查询配载单界面跳转，同时获取大部门code
	 * @author 045923-foss-shiwei
	 * @date 2013-4-3 下午4:36:14
	 */
	@JSON
	public String vehicleAssembleBillQueryIndex(){
		try{
			String superOrgCode = vehicleAssembleBillService.querySuperiorOrgCode();
			vehicleAssembleBillVo.setSuperOrgCode(superOrgCode);
		}catch(BusinessException e){
			vehicleAssembleBillVo.setErrorMessage(e.getMessage());
			return returnError(e);
		}
		return returnSuccess();
	}
	/**
	 * 配载单查询界面，导出配载单内运单
	 * @author 045923-foss-shiwei
	 * @throws UnsupportedEncodingException 
	 * @date 2012-10-26 下午2:23:54
	 */
	@SuppressWarnings("rawtypes")
	public String exportWayBillExcel(){
		//获取传入的配载车次号
		String vehicleAssembleNo = vehicleAssembleBillVo.getVehicleAssembleNo();
		List list = null;
		try{
			//获取文件名和输入流
			list = vehicleAssembleBillService.getWayBillExcelInputStream(vehicleAssembleNo);
		}catch(BusinessException e){
			//返回异常信息
			return returnError(e);
		}
		//文件名
		excelFileName = (String)list.get(0);
		//输入流
		wayBillExcelStream = (InputStream) list.get(1);
		return returnSuccess();
	}
	
	/**
	 * 查询配载单界面，导出配载单
	 * @author 045923-foss-shiwei
	 * @date 2013-5-29 下午5:17:29
	 */
	@SuppressWarnings("rawtypes")
	public String exportVehicleAssembleBillExcel(){
		//获取传入的查询条件
		QueryVehicleAssembleBillConditionDto conditionDto = vehicleAssembleBillVo.getQueryConditionDto();
		List list = null;
		try{
			//获取文件名和输入流
			list = vehicleAssembleBillService.getVehicleAssembleBillExcelInputStream(conditionDto);
		}catch(BusinessException e){
			//返回异常信息
			return returnError(e);
		}
		//文件名
		excelFileName = (String)list.get(0);
		//输入流
		vehicleAssembleBillExcelStream = (InputStream) list.get(1);
		return returnSuccess();
	}
	
	/**
	 * 调用交接单模块service，获取本部门待配载的集配交接单
	 * @author 045923-foss-shiwei
	 * @date 2012-11-9 下午4:48:00
	 */
	@JSON
	public String queryUnAssembledHandOverBillList(){
		//获取查询条件
		QueryHandOverBillConditionDto queryHandOverBillConditionDto = vehicleAssembleBillVo.getQueryHandOverBillConditionDto();
		//获取查询结果
		vehicleAssembleBillVo.setHandOverBillList(vehicleAssembleBillService.queryUnAssembledHandOverBillList(queryHandOverBillConditionDto));
		//返回success
		return returnSuccess();
	}
	
	
	/**
	 * 通过车牌号，出发部门到达部门判断是零担还是快递货
	 * @author gongjp
	 * @date 2015-08-19 下午14:53
	 */
	@JSON
	public String isNOrYVehicleAssembleBill(){
		//获取查询条件
		QueryHandOverBillConditionDto queryHandOverBillConditionDto = vehicleAssembleBillVo.getQueryHandOverBillConditionDto();
		//获取查询结果
		vehicleAssembleBillVo.setHandOverBillList(vehicleAssembleBillService.queryUnAssembledHandOverBillList1(queryHandOverBillConditionDto));
		//返回success
		return returnSuccess();
	}
	/**
	 * 记录日志
	 */
	protected final Logger LOGGER = LoggerFactory.getLogger(getClass());
	/**
	 * 新增时保存配载单信息
	 * @author 045923-foss-shiwei
	 * @date 2012-11-8 下午3:02:03
	 */
	@JSON
	public String saveVehicleAssembleBill(){
		MutexElement mutex = null;
		try {
			// 判空
			if (vehicleAssembleBillVo != null && vehicleAssembleBillVo.getBaseEntity() != null
					&& CollectionUtils.isNotEmpty(vehicleAssembleBillVo.getBillDetailEntityList())) {
				LOGGER.error("保存配载单：约车编码："+vehicleAssembleBillVo.getBaseEntity().getInviteNo()+";交接单号： "+vehicleAssembleBillVo.getBillDetailEntityList().get(0).getHandOverBillNo()+"************开始");
				// 出发部门，到达部门，发车日期
				String lockStr = vehicleAssembleBillService.querySuperiorOrgCode() + vehicleAssembleBillVo.getBaseEntity().getDestOrgCode()
						+ DateUtils.convert(vehicleAssembleBillVo.getBaseEntity().getLeaveTime(), DateUtils.DATE_SHORT_FORMAT);
				mutex = new MutexElement(lockStr, "新增配载单", MutexElementType.TFR_LOAD_VEHICLEASSEMBLEBILL_ADDNEW);
				// 锁定
				boolean flag = businessLockService.lock(mutex, 0);
				if (flag) {
					/*
					 * 保存配载单，同时返回生成的配载车次号
					 */
					LOGGER.error("保存配载单：约车编码："+vehicleAssembleBillVo.getBaseEntity().getInviteNo()+";交接单号： "+vehicleAssembleBillVo.getBillDetailEntityList().get(0).getHandOverBillNo()+"************锁定成功");
					String vehicleAssembleNo = vehicleAssembleBillService.saveVehicleAssembleBill(
							vehicleAssembleBillVo.getBaseEntity(), vehicleAssembleBillVo.getBillDetailEntityList(),vehicleAssembleBillVo.getRewardOrPunishDto());
					//返回配载车次号
					vehicleAssembleBillVo.setVehicleAssembleNo(vehicleAssembleNo);
					// 解锁
					businessLockService.unlock(mutex);
				} else {
					throw new TfrBusinessException("该线路配载单正在生成中，请稍候重试或者重新点击保存按钮！");
				}
			}
			// 成功
			return super.returnSuccess();
		} catch (TfrBusinessException e) {
			// 解锁
			businessLockService.unlock(mutex);
			// 返回错误信息
			return super.returnError(e);
			// 捕捉业务异常
		} catch (BusinessException e) {
			// 解锁
			businessLockService.unlock(mutex);
			// 返回错误信息
			return super.returnError(e);
		} // 捕捉异常
		
	}
	
	/**
	 * 查询配载单action
	 * @author 045923-foss-shiwei
	 * @date 2012-11-13 下午5:16:59
	 */
	@JSON
	public String queryVehicleAssembleBillList(){
		//获取查询条件
		QueryVehicleAssembleBillConditionDto conditionDto = vehicleAssembleBillVo.getQueryConditionDto();
		//获取总条数
		Long totalCount = vehicleAssembleBillService.getVehicleAssembleBillCount(conditionDto);
		//用于分页
		this.setTotalCount(totalCount);
		//返回查询结果
		vehicleAssembleBillVo.setQueriedBillList(vehicleAssembleBillService.queryVehicleAssembleBillList(conditionDto,this.getLimit(),this.getStart()));
		//返回success
		return returnSuccess();
	}
	
	/**
	 * 根据车次号获取配载单基本信息
	 * @author 045923-foss-shiwei
	 * @date 2012-11-15 下午4:39:44
	 */
	@JSON
	public String queryVehicleAssembleBillByNo(){
		//获取传入的配载单信息
		String vehicleAssembleNo = vehicleAssembleBillVo.getVehicleAssembleNo();
		try{
			//获取配载单基本信息
			VehicleAssembleBillEntity entity = vehicleAssembleBillService.queryVehicleAssembleBillByNo(vehicleAssembleNo).get(0);
			//获取到达部门code
			String destOrgCode = entity.getDestOrgCode();
			//查询挂牌号
			if(StringUtils.isNotEmpty(entity.getTruckDepartPlanDetailId())){
				TruckDepartPlanDetailDto planDetail = truckDepartPlanDetailService.queryTruckDepartPlanDetailById(entity.getTruckDepartPlanDetailId(), FossConstants.YES);
				String trialerVehicleNo=(planDetail==null?null:planDetail.getTrailerVehicleNo());
				vehicleAssembleBillVo.setTrailerVehicleNo(trialerVehicleNo);
			}
			/*
			 * 获取到达部门是否支持自动分拣
			 * 用于控制“货物类型”是否可编辑
			 */
			OutfieldEntity outfield = vehicleAssembleBillService.queryOutfieldByOrgCode(destOrgCode);
			if(outfield == null || StringUtils.equals(outfield.getSortingMachine(), FossConstants.NO)){
				//不支持自动分拣
				vehicleAssembleBillVo.setIsSupportAutoSorting(FossConstants.NO);
			}else if(StringUtils.equals(outfield.getSortingMachine(), FossConstants.YES)){
				//支持自动分拣
				vehicleAssembleBillVo.setIsSupportAutoSorting(FossConstants.YES);
			}else{
				//此处已做充分考虑，可空
			}
			//如果是外请车，则返回前台，看是否为合同车
			if(StringUtils.equals(entity.getVehicleOwnerShip(), ComnConst.ASSETS_OWNERSHIP_TYPE_LEASED)){
				//查询约车价格通过约车编号
				if(StringUtils.isNotEmpty(entity.getInviteNo())){
					try{
						BigDecimal inviteFeetotal=	inviteVehicleService.queryInviteCostByInviteNo(entity.getInviteNo());
						vehicleAssembleBillVo.setInviteFeetotal(inviteFeetotal==null?entity.getFeeTotal():inviteFeetotal);
					}catch(Exception e){
						vehicleAssembleBillVo.setInviteFeetotal(entity.getFeeTotal());
					}
					
				}else{
					vehicleAssembleBillVo.setInviteFeetotal(entity.getFeeTotal());
				}
				//获取车辆信息
				VehicleAssociationDto vehicle = vehicleAssembleBillService.queryVehicleInfoByVehicleNo(entity.getVehicleNo());
				if(vehicle != null && StringUtils.equals(vehicle.getBargainVehicle(), FossConstants.YES)){
					//合同车
					vehicleAssembleBillVo.setIsBarginCar(FossConstants.YES);
				}else{
					//非合同车
					vehicleAssembleBillVo.setIsBarginCar(FossConstants.NO);
				}
			}else{
				//如果为公司车，则获取车辆类型
				String vehicleType = vehicleAssembleBillService.queryOwnerVehicleTypeByVehicleNo(entity.getVehicleNo());
				//车辆类型，用于控制前台显示车型还是货柜号
				vehicleAssembleBillVo.setOwnerVehicleType(vehicleType);
			}
			//返回配载单基本信息实体
			vehicleAssembleBillVo.setBaseEntity(entity);
			
			//查询奖罚信息
			if(StringUtils.equals(entity.getBeTimeLiness(), FossConstants.YES)){				
				RewardOrPunishAgreementDto rewardOrPunishDto =vehicleAssembleBillService.queryRewardOrPunishAgreement(vehicleAssembleNo);
				vehicleAssembleBillVo.setRewardOrPunishDto(rewardOrPunishDto);				
			}
			
			//用于验证奖罚协议不能修改
			int result = vehicleAssembleBillService.checkCarriageContractPrinted(vehicleAssembleBillVo.getVehicleAssembleNo());
			//用于验证奖罚协议不能修改
			vehicleAssembleBillVo.setCheckCarriageContractPrinted(result);
			
			//获取前台传入的参数，是否为修改界面读取配载单信息
			String isModify = vehicleAssembleBillVo.getIsModify();
			//如果是修改界面读取，则判断可否修改司机、车牌结算信息
			if(!StringUtils.isEmpty(isModify)
					&& StringUtils.equals(isModify, FossConstants.YES)){
				
				// 封装灰度实体，类型是配载单
				GrayParameterDto parDto = new GrayParameterDto();
				parDto.setSourceBillType(CUBCGrayUtil.SBType.PZ.getName());
				parDto.setSourceBillNos(new String[] { vehicleAssembleNo });
				VestResponse vestResponse = cubcUtil.getUcbcGrayData(parDto, new Throwable());

				boolean isWriteOff = false;
				if (CUBCGrayContants.SYSTEM_CODE_FOSS
						.equals(vestResponse.getVestBatchResult().get(0).getVestSystemCode())) {
					// 是否已做出发付款确认
					isWriteOff = vehicleAssembleBillService.queryBillPayableIsWriteOff(vehicleAssembleNo);
				} else {
						Map<String, String> paramMap = new HashMap<String, String>();
						// 配载单号
						paramMap.put("sourceBillNo", vehicleAssembleNo);
						paramMap.put("isAdjust", null);

						CubcValidationSourceBillNoResponse cubcValidationVerificationResponse = fossToCubcService
								.queryBillPayableIsWriteOff(paramMap);
						if (null != cubcValidationVerificationResponse) {
							if (!cubcValidationVerificationResponse.isSuccess()) {
								throw new TfrBusinessException("根据来源单号调用cubc查询应付单是否已经核销失败:cubc"
										+ cubcValidationVerificationResponse.getExceptionMsg() + "！");
							} else if (cubcValidationVerificationResponse.isSuccess()
									&& cubcValidationVerificationResponse.isAudited()) {
								isWriteOff = true;
							}
						} else {
							throw new TfrBusinessException("根据来源单号调用cubc查询应付单是否已经核销失败！");
						}
				}
				//配载单状态
				int state = entity.getState();
				if(state == LoadConstants.VEHICLEASSEMBLEBILL_STATE_NOT_DEPART 
						&& !isWriteOff){
					//结算信息及车辆、司机信息可以修改
					vehicleAssembleBillVo.setIsStlInfoAndDriverVehicleCanBeModified(FossConstants.YES);
				}else{
					//结算信息及车辆、司机信息不可以修改
					vehicleAssembleBillVo.setIsStlInfoAndDriverVehicleCanBeModified(FossConstants.NO);
				}
			}
		}catch(BusinessException e){
			//返回业务异常信息
			return returnError(e);
		}
		//返回success
		return returnSuccess();
	}
	
	/**
	 * 根据配载车次号获取其下交接单列表
	 * @author 045923-foss-shiwei
	 * @date 2012-11-15 下午6:33:34
	 */
	@JSON
	public String queryHandOverBillListByVNo(){
		//获取前台传入的配载车次号
		String vehicleAssembleNo = vehicleAssembleBillVo.getVehicleAssembleNo();
		//返回其下的交接单列表
		vehicleAssembleBillVo.setHandOverBillList(vehicleAssembleBillService.queryHandOverBillListByVNo(vehicleAssembleNo));
		//返回success
		return returnSuccess();
	}
	
	/**
	 * 根据配载车次号读取修改日志
	 * @author 045923-foss-shiwei
	 * @date 2012-11-16 上午11:07:37
	 */
	@JSON
	public String queryVehicleAssembleBillOptLogByNo(){
		//获取传入的配载车次号
		String vehicleAssembleNo = vehicleAssembleBillVo.getVehicleAssembleNo();
		//返回总条数
		Long totalCount = vehicleAssembleBillService.queryVehicleAssembleBillOptLogCountByNo(vehicleAssembleNo);
		//分页
		this.setTotalCount(totalCount);
		//返回修改日志
		vehicleAssembleBillVo.setOptLogList(vehicleAssembleBillService.queryVehicleAssembleBillOptLogByNo(vehicleAssembleNo,this.getLimit(),this.getStart()));
		//返回success
		return returnSuccess();
	}
	
	/**
	 * 根据配载单号查询出该配置单下所有的交接单号 
	 * @author ibm-zhangyixin
	 * @date 2012-11-19 下午4:12:43
	 */
	@JSON
	public String queryHandOverBillNosByVehicleAssembleNo(){
		//根据配载单号查询出该配置单下所有的交接单号 
		List<String> handOverBillNos = vehicleAssembleBillService.queryHandOverBillNosByVehicleAssembleNo(vehicleAssembleBillVo.getVehicleAssembleNos());
		//set交接单号
		vehicleAssembleBillVo.setHandOverBillNos(handOverBillNos);
		////返回success
		return returnSuccess();
	}
	
	/**
	 * 更新配载单
	 * @author 045923-foss-shiwei
	 * @date 2012-11-20 下午12:18:26
	 */
	@JSON
	public String updateVehicleAssembleBill(){
		//获取传入的配载单修改信息
		UpdateVehicleAssembleBillDto dto = vehicleAssembleBillVo.getUpdateVehicleAssembleBillDto();
		//获取传入的奖罚修改信息
		RewardOrPunishAgreementDto rewardDto= vehicleAssembleBillVo.getRewardOrPunishDto();
		try{
			//更新配载单信息
			vehicleAssembleBillService.updateVehicleAssembleBill(dto,rewardDto);
		}catch(BusinessException e){
			//返回业务异常信息
			return returnError(e);
		}
		//返回success
		return returnSuccess();
	}
	
	/**
	 * 前台传入车牌号，获取车辆信息、包括车辆所有权、长宽载重等信息
	 * @author 045923-foss-shiwei
	 * @date 2012-11-22 下午2:41:38
	 */
	@JSON
	public String queryVehicleInfoByVehicleNo(){
		//获取车牌号
		String vehicleNo = vehicleAssembleBillVo.getVehicleNo();
		//获取到达部门code
		String destOrgCode = vehicleAssembleBillVo.getDestDeptCode();
		//获取发车日期
		Date leaveTime = vehicleAssembleBillVo.getLeaveTime();
		//获取配载类型
		String assembleType = vehicleAssembleBillVo.getAssembleType();
		//获取运输性质
		String transProperty = vehicleAssembleBillVo.getTransProperty();
		//校验是否在发车计划中
		try{
			//不为整车则校验发车计划
			GetInfoWhenVehicleNoLostFocusDto infoDto = null;
			if(!StringUtils.equals(assembleType, LoadConstants.VEHICLE_ASSEMBLE_TYPE_CAR_LOAD)){
				infoDto = vehicleAssembleBillService.validateVehicleNoFromTruckPlan(destOrgCode, leaveTime, vehicleNo,transProperty);
				//sonar优化 加入线路号判断 218427
				if(infoDto==null&&StringUtils.isEmpty(infoDto.getLineNo())){
					throw new TfrBusinessException("infoDto为空");
				}
				
				//返回主驾驶司机code，name，电话，班次
				vehicleAssembleBillVo.setDriverCode(infoDto.getDriverCode());
				//司机name
				vehicleAssembleBillVo.setDriverName(infoDto.getDriverName());
				//司机电话
				vehicleAssembleBillVo.setDriverTel(infoDto.getDriverTel());
				//卡车班次
				vehicleAssembleBillVo.setFrequencyNo(infoDto.getFrequencyNo());
				//货柜编号
				vehicleAssembleBillVo.setContainerNo(infoDto.getContainerNo());
				//挂牌号
				vehicleAssembleBillVo.setTrailerVehicleNo(infoDto.getTrailerVehicleNo());
				//运行时数
				vehicleAssembleBillVo.setRunHours(infoDto.getRunHours());
			}
			
			//获取车辆信息
			VehicleAssociationDto vehicleInfo = vehicleAssembleBillService.queryVehicleInfoByVehicleNo(vehicleNo);
			vehicleAssembleBillVo.setVehicleInfo(vehicleInfo);
			//如果是外请车，同时获取外请车约车的总运费
			if(vehicleInfo != null && ComnConst.ASSETS_OWNERSHIP_TYPE_LEASED.equals(vehicleInfo.getVehicleOwnershipType())){ 
				assembleType = vehicleAssembleBillVo.getAssembleType();
				PassInviteApplyEntity inviteEntity = (PassInviteApplyEntity)vehicleAssembleBillService.getTotalFeeFromInviteVehicleModule(vehicleNo,assembleType);
				vehicleAssembleBillVo.setVehicleFee(inviteEntity.getInviteCost());
				vehicleAssembleBillVo.setInviteNo(inviteEntity.getInviteNo());
			}else if(vehicleInfo != null){
				//如果为公司车，则获取部门距离和车辆每公里费用，计算总运费
				BigDecimal ownTotalFee = vehicleAssembleBillService.calculateFeeTotalForOwnTruck(destOrgCode,infoDto.getLineNo(),vehicleInfo.getEachKilometersFees());
				vehicleAssembleBillVo.setVehicleFee(ownTotalFee);
				//公司车有目的站是本部门且未到达的车辆任务则提示 ：“车牌号XX，配载单XX，还未到达本部门必须先做到达后，本部门才能使用此车牌号”；
				vehicleAssembleBillService.validateOntheWayTruckTask(vehicleNo);
			}
			//查询是否存在 未出发且 在途只装不卸的配载单
			String vehicleAssembleNo = vehicleAssembleBillService.queryMidleUnloadVehicleAssemByVehicleNo(vehicleNo);
			vehicleAssembleBillVo.setVehicleAssembleNo(vehicleAssembleNo);
		}catch(BusinessException e){
			//返回业务异常信息
			return returnError(e);
		}
		//返回success
		return returnSuccess();
	}
	
	/**
	 *前台传入货柜编号，获取货柜尺寸、载重净空等信息 
	 * @author 045923-foss-shiwei
	 * @date 2012-11-23 上午10:58:54
	 */
	@JSON
	public String queryContainerInfoByContainerNo(){
		//获取前台传入的货柜号
		String containerNo = vehicleAssembleBillVo.getContainerNo();
		//返回查询到的货柜信息
		vehicleAssembleBillVo.setContainerInfo(vehicleAssembleBillService.queryContainerInfoByContainerNo(containerNo));
		//返回success
		return returnSuccess();
	}
	
	/**
	 * 传入“到达部门”，返回到达部门实体
	 * 如果传入的“发车日期”、“是否为整车”不为空，则同时将生成的配载车次号返回
	 * @author 045923-foss-shiwei
	 * @date 2012-11-23 下午4:10:09
	 */
	@JSON
	public String someCmpLostFocus(){
		//获取传入的到达外场code
		String outfieldCode = vehicleAssembleBillVo.getOutfieldCode();
		//获取配载类型
		String assembleType = vehicleAssembleBillVo.getAssembleType();
		if(outfieldCode != null){
			try{
				//返回外场信息
				vehicleAssembleBillVo.setOutfield(vehicleAssembleBillService.queryOutfieldIsHasSortingMachine(outfieldCode));
			}catch(BusinessException e){
				//返回业务异常信息
				return returnError(e);
			}
		}
		//获取发车日期
		Date leaveTime = vehicleAssembleBillVo.getLeaveTime();
		//获取是否为整车
		String isCarLoad = vehicleAssembleBillVo.getIsCarLoad();
		//“发车日期”不为空，则校验发车计划中有无此部门
		if(null != leaveTime){
			try{
				//如果不为整车，则校验发车计划
				if(!StringUtils.equals(assembleType, LoadConstants.VEHICLE_ASSEMBLE_TYPE_CAR_LOAD)
						&& assembleType != null){
					vehicleAssembleBillService.validateArriveDeptFromTruckPlan(outfieldCode, leaveTime);
				}
			}catch(BusinessException e){
				//返回业务异常信息
				return this.returnError(e);
			}
			//如果“是否为整车不为空，则生成配载车次号返回”
			if(null != isCarLoad){
				try{
					//返回生成的配载车次号
					vehicleAssembleBillVo.setVehicleAssembleNo(vehicleAssembleBillService.showVehicleAssembleNo(outfieldCode,isCarLoad,leaveTime));
				}catch(BusinessException e){
					//返回业务异常信息
					return this.returnError(e);
				}
			}
		}
		//返回success
		return returnSuccess();
	}
	
	/**
	 * 作废配载单action
	 * @author 045923-foss-shiwei
	 * @date 2012-11-26 下午8:42:54
	 */
	@JSON
	public String cancelVehicleAssembleBill(){
		//获取传入的配载车次号
		String vehicleAssembleNo = vehicleAssembleBillVo.getVehicleAssembleNo();
		try{
			//已被租车标记不可删除
			String holdingState=vehicleAssembleBillService.queryHoldingState(vehicleAssembleNo);
			if(StringUtils.equals(holdingState, "Y")){
				throw new TfrBusinessException("该配载单已被租车标记不能删除！");
			}
			//作废配载单
			vehicleAssembleBillService.cancelVehicleAssembleBill(vehicleAssembleNo);
		}catch(BusinessException e){
			//返回业务异常信息
			return this.returnError(e);
		}
		//返回success
		return returnSuccess();
	}

	/**
	 * 传入到达部门code，返回获取的外场实体，若不是外场，则返回null
	 * @author 045923-foss-shiwei
	 * @date 2012-12-5 下午9:23:40
	 */
	@JSON
	public String queryOutfieldByCode(){
		//获取传入的到达部门code
		String arriveDeptCode = vehicleAssembleBillVo.getOutfieldCode();
		//返回获取的外场信息
		vehicleAssembleBillVo.setOutfield(vehicleAssembleBillService.queryOutfieldByOrgCode(arriveDeptCode));
		//返回success
		return returnSuccess();
	}
	
	/**
	 * 传入配载车次号，调用结算接口，看是否已做出发付款确认
	 * @author 045923-foss-shiwei
	 * @date 2012-12-6 下午5:13:03
	 */
	@JSON
	public String queryDepartPaymentConfirmState(){
		try{
		//获取传入的配载车次号
		String vehicleAssembleNo = vehicleAssembleBillVo.getVehicleAssembleNo();
		
		//封装灰度实体，类型是配载单
		GrayParameterDto parDto = new GrayParameterDto();
		parDto.setSourceBillType(CUBCGrayUtil.SBType.PZ.getName());
		parDto.setSourceBillNos(new String[] {vehicleAssembleNo});
		
		VestResponse vestResponse = cubcUtil.getUcbcGrayData(parDto, new Throwable());

		boolean state = false;
		if (CUBCGrayContants.SYSTEM_CODE_FOSS
				.equals(vestResponse.getVestBatchResult().get(0).getVestSystemCode())) {
			// 获取是否出发付款确认
			state = vehicleAssembleBillService.isDepartPaymentConfirm(vehicleAssembleNo);
		} else {
			Map<String, String> paramMap = new HashMap<String, String>();
			// 配载单号
			paramMap.put("sourceBillNo", vehicleAssembleNo);
			paramMap.put("isAdjust", null);

			CubcValidationSourceBillNoResponse cubcValidationVerificationResponse = fossToCubcService
					.queryBillPayableIsWriteOff(paramMap);
			if (null != cubcValidationVerificationResponse) {
				if (!cubcValidationVerificationResponse.isSuccess()) {
					throw new TfrBusinessException("根据来源单号调用cubc查询应付单是否已经核销失败:cubc"
							+ cubcValidationVerificationResponse.getExceptionMsg() + "！");
				} else if (cubcValidationVerificationResponse.isSuccess()
						&& cubcValidationVerificationResponse.isAudited()) {
					state = true;
				}
			} else {
				throw new TfrBusinessException("根据来源单号调用cubc查询应付单是否已经核销失败！");
			}
		}
		
		if(state){
			vehicleAssembleBillVo.setIsDepartPaymentConfirm(FossConstants.NO);
		}else{
			vehicleAssembleBillVo.setIsDepartPaymentConfirm(FossConstants.YES);
		}
		//检查配载单在租车标记表的预提状态，如果为预提中或者已预提则不允许修改
		String isHodingState=vehicleAssembleBillService.queryHoldingState(vehicleAssembleNo);
		vehicleAssembleBillVo.setIsHoding(isHodingState);
		//返回success
		return returnSuccess();
		}catch(BusinessException e){
			return returnError(e.toString());
		}
	}
	
	/**
	 * 修改配载单时，校验司机、车牌、结算信息是否可修改，已发车或者已做出发付款确认均不可再修改这些字段
	 * @author 045923-foss-shiwei
	 * @date 2013-1-9 上午10:31:03
	 */
	public String validateVehicleAssembleBillStlInfoAndDriverVehicleCanBeModified(){
		//获取传入的配载车次号
		String vehicleAssembleNo = vehicleAssembleBillVo.getVehicleAssembleNo();
		boolean isWriteOff=false;
		int state;
		try{
			
			// 封装灰度实体，类型是配载单
			GrayParameterDto parDto = new GrayParameterDto();
			parDto.setSourceBillType(CUBCGrayUtil.SBType.PZ.getName());
			parDto.setSourceBillNos(new String[] { vehicleAssembleNo });
			VestResponse vestResponse = cubcUtil.getUcbcGrayData(parDto, new Throwable());

			if (CUBCGrayContants.SYSTEM_CODE_FOSS
					.equals(vestResponse.getVestBatchResult().get(0).getVestSystemCode())) {
				// 调用结算接口，看是否已做出发付款确认，如果返回true，不允许修改
				isWriteOff = vehicleAssembleBillService.queryBillPayableIsWriteOff(vehicleAssembleNo);
			} else {
					Map<String, String> paramMap = new HashMap<String, String>();
					// 配载单号
					paramMap.put("sourceBillNo", vehicleAssembleNo);
					paramMap.put("isAdjust", null);
					CubcValidationSourceBillNoResponse cubcValidationVerificationResponse = fossToCubcService
							.queryBillPayableIsWriteOff(paramMap);
					if (null != cubcValidationVerificationResponse) {
						if (!cubcValidationVerificationResponse.isSuccess()) {
							throw new TfrBusinessException("根据来源单号调用cubc查询应付单是否已经核销失败:cubc"
									+ cubcValidationVerificationResponse.getExceptionMsg() + "！");
						} else if (cubcValidationVerificationResponse.isSuccess()
								&& cubcValidationVerificationResponse.isAudited()) {
							isWriteOff = true;
						}
					} else {
						throw new TfrBusinessException("根据来源单号调用cubc查询应付单是否已经核销失败！");
					}
			}
			//获取配载单状态
			state = vehicleAssembleBillService.queryVehicleAssembleBillByNo(vehicleAssembleNo).get(0).getState();
		}catch(BusinessException e){
			//返回业务异常信息
			return returnError(e);
		}
		/*
		 * 若已做出发付款确认，或者配载单已发车
		 * 则不允许修改结算信息及车牌号、司机信息
		 */
		if(state == LoadConstants.VEHICLEASSEMBLEBILL_STATE_NOT_DEPART 
				&& !isWriteOff){
			//可修改
			vehicleAssembleBillVo.setIsStlInfoAndDriverVehicleCanBeModified(FossConstants.YES);
		}else{
			//不可修改
			vehicleAssembleBillVo.setIsStlInfoAndDriverVehicleCanBeModified(FossConstants.NO);
		}
		//返回success
		return returnSuccess();
	}
	
	/**
	 * 根据“运输性质”获取运行时数
	 * @author 045923-foss-shiwei
	 * @date 2013-2-25 下午3:38:34
	 */
	@JSON
	public String queryRunHoursByTransProperty(){
		//获取到达部门code
		String destOrgCode = vehicleAssembleBillVo.getDestDeptCode();
		//获取发车日期
		Date leaveTime = vehicleAssembleBillVo.getLeaveTime();
		//获取车牌号
		String vehicleNo = vehicleAssembleBillVo.getVehicleNo();
		//获取运输性质
		String transProperty = vehicleAssembleBillVo.getTransProperty();
		//运行时数
		BigDecimal runHours = null;
		try{
			//调用综合接口，根据以上参数获取运行时数
			runHours = vehicleAssembleBillService.queryRunHoursByTransProperty(destOrgCode, leaveTime, vehicleNo, transProperty);
		}catch(BusinessException e){
			//返回业务异常信息
			return returnError(e);
		}
		//返回运行时数
		vehicleAssembleBillVo.setRunHours(runHours);
		//返回success
		return returnSuccess();
	}
	/**
	 * 修改时根据“运输性质”获取运行时数
	 * @author 105869-foss-heyongdong
	 * @date 2013-7-26 下午3:41:34
	 */
	@JSON
	public String queryModifyRunHoursByTransProperty(){
		//获取车次号
		String vehicleAssembleNo = vehicleAssembleBillVo.getVehicleAssembleNo();
		//获取运输性质
		String transProperty = vehicleAssembleBillVo.getTransProperty();
		//获取车牌号
		String vehicleNo = vehicleAssembleBillVo.getVehicleNo();
		//运行时数
		BigDecimal runHours = null;
		try{
			//调用综合接口，根据以上参数获取运行时数
			runHours = vehicleAssembleBillService.queryModifyRunHoursByTransProperty( vehicleNo,vehicleAssembleNo, transProperty);
		}catch(BusinessException e){
			//返回业务异常信息
			return returnError(e);
		}
		//返回运行时数
		vehicleAssembleBillVo.setRunHours(runHours);
		//返回success
		return returnSuccess();
	}
	/**
	 * 用于验证选择的配载单在该车牌下是否还有其他的没选择
	 * @author ibm-zhangyixin
	 * @date 2012-10-31 下午4:00:01
	 */
	@JSON
	public String checkPrintVehicleAssembleBill(){
		try{
			Long truckTaskCount = vehicleAssembleBillService.checkPrintTruckTask(vehicleAssembleBillVo);
			if(truckTaskCount > 1) {
				return returnError(new TfrBusinessException("同一车次下的配载单才能一起打印!"));
			}
			//用于验证选择的配载单在该车牌下是否还有其他的没选择
			Long result = vehicleAssembleBillService.checkPrintVehicleAssembleBill(vehicleAssembleBillVo);
			//用于验证选择的配载单在该车牌下是否还有其他的没选择
			vehicleAssembleBillVo.setCheckPrintVehicleAssembleBillRestlt(result);
		}catch(BusinessException e){
			//返回业务异常信息
			return returnError(e);
		}
		//返回success
		return returnSuccess();
	}
	
	/**
	 * 
	 * @Title: checkPrinted 
	 * @Description: 判断运输合同是否重复打印 
	 * @return    
	 * @return String    返回类型 
	 * checkPrinted
	 * @author: ibm-zhangyixin
	 * @throws 
	 * Date:2013-4-19下午3:19:14
	 */
	@JSON
	public String checkCarriageContractPrinted(){
		try{
			//用于验证选择的配载单在该车牌下是否还有其他的没选择
			int result = vehicleAssembleBillService.checkCarriageContractPrinted(vehicleAssembleBillVo.getVehicleAssembleNo());
			//用于验证选择的配载单在该车牌下是否还有其他的没选择
			vehicleAssembleBillVo.setCheckCarriageContractPrinted(result);
		}catch(BusinessException e){
			//返回业务异常信息
			return returnError(e);
		}
		//返回success
		return returnSuccess();
	}
	
	/**
	 * 
	 * @Title: checkPrinted 
	 * @Description: 返回是否是合同线路奖罚线路
	 * @return    
	 * @return String    返回类型 
	 * checkBeAgingLine
	 * @author: foss-heyongdong
	 * @throws 
	 * @Date:2013年12月17日 16:33:45
	 */
	@JSON
	public String checkBeAgingLine(){
		try{
			RewardOrPunishAgreementDto rewardOrPunishDto = 
					vehicleAssembleBillService.checkBeAgingLine(vehicleAssembleBillVo.getDestDeptCode());
			vehicleAssembleBillVo.setRewardOrPunishDto(rewardOrPunishDto);
		}catch(BusinessException e){
			return returnError(e);
		}
		return returnSuccess();
	}
	public VehicleAssembleBillVo getVehicleAssembleBillVo() {
		return vehicleAssembleBillVo;
	}

	public void setVehicleAssembleBillVo(VehicleAssembleBillVo vehicleAssembleBillVo) {
		this.vehicleAssembleBillVo = vehicleAssembleBillVo;
	}
	
	public InputStream getVehicleAssembleBillExcelStream() {
		return vehicleAssembleBillExcelStream;
	}

	public void setVehicleAssembleBillExcelStream(
			InputStream vehicleAssembleBillExcelStream) {
		this.vehicleAssembleBillExcelStream = vehicleAssembleBillExcelStream;
	}
}