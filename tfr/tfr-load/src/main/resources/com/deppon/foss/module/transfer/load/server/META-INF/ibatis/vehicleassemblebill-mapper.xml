<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
	"-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="fosss.load.vehicleassemblebill">
		<!--配载单基本信息ResultMap-->
		<resultMap id="VehicleAssembleBillResultMap" 
				   type="com.deppon.foss.module.transfer.load.api.shared.dto.QueryVehicleAssembleBillDto" >
		    <id column="id" property="id" jdbcType="VARCHAR" />
		    <result column="truckDepartPlanDetailId" property="truckDepartPlanDetailId" jdbcType="VARCHAR" />
		    <result column="vehicleAssembleNo" property="vehicleAssembleNo" jdbcType="VARCHAR" />
		    <result column="goodsType" property="goodsType" jdbcType="VARCHAR" />
		    <result column="assembleType" property="assembleType" jdbcType="VARCHAR" />
		    <result column="origOrgCode" property="origOrgCode" jdbcType="VARCHAR" />
		    <result column="origOrgName" property="origOrgName" jdbcType="VARCHAR" />
		    <result column="destOrgName" property="destOrgName" jdbcType="VARCHAR" />
		    <result column="destOrgCode" property="destOrgCode" jdbcType="VARCHAR" />
		    <result column="vehicleNo" property="vehicleNo" jdbcType="VARCHAR" />
		    <result column="vehicleModel" property="vehicleModel" jdbcType="VARCHAR" />
		    <result column="vehicleOwnerShip" property="vehicleOwnerShip" jdbcType="VARCHAR" />
		    <result column="driverName" property="driverName" jdbcType="VARCHAR" />
		    <result column="driverCode" property="driverCode" jdbcType="VARCHAR" />
		    <result column="driverMobilePhone" property="driverMobilePhone" jdbcType="VARCHAR" />
		    <result column="departTime" property="departTime" jdbcType="TIMESTAMP" />
		    <result column="leaveTime" property="leaveTime" jdbcType="TIMESTAMP" />
		    <result column="planArriveTime" property="planArriveTime" jdbcType="TIMESTAMP"/>
		    <result column="arriveTime" property="arriveTime" jdbcType="TIMESTAMP"/>
		    <result column="createDate" property="createDate" jdbcType="TIMESTAMP" />
		    <result column="modifyDate" property="modifyDate" jdbcType="TIMESTAMP" />
		    <result column="transProperty" property="transProperty" jdbcType="VARCHAR" />
		    <result column="runHours" property="runHours" jdbcType="VARCHAR" />
		    <result column="loadingRate" property="loadingRate" jdbcType="VARCHAR" />
		    <result column="containerNo" property="containerNo" jdbcType="VARCHAR" />
		    <result column="examineVolume" property="examineVolume" jdbcType="DECIMAL" />
		    <result column="ratedClearance" property="ratedClearance" jdbcType="DECIMAL" />
		    <result column="ratedLoad" property="ratedLoad" jdbcType="DECIMAL" />
		    <result column="createUserName" property="createUserName" jdbcType="VARCHAR" />
		    <result column="createUserCode" property="createUserCode" jdbcType="VARCHAR" />
		    <result column="note" property="note" jdbcType="VARCHAR" />
		    <result column="vehicleMessage" property="vehicleMessage" jdbcType="VARCHAR" />
		    <result column="frequencyNo" property="frequencyNo" jdbcType="VARCHAR" />
		    <result column="beMidWayLoad" property="beMidWayLoad" jdbcType="CHAR" />
		    <result column="beFinallyArrive" property="beFinallyArrive" jdbcType="CHAR" />
		    <result column="beInLTLCar" property="beInLTLCar" jdbcType="CHAR" />
		    <result column="midWayLoadType" property="midWayLoadType" jdbcType="CHAR" />
		    <result column="paymentType" property="paymentType" jdbcType="VARCHAR" />
		    <result column="beTimeLiness" property="beTimeLiness" jdbcType="VARCHAR" />
		    <result column="truckOwnerName" property="truckOwnerName" jdbcType="VARCHAR" />
		    <result column="applyPath" property="applyPath" jdbcType="VARCHAR" />
		    <result column="ministryinformationCode" property="ministryinformationCode" jdbcType="VARCHAR" />
		    <result column="feeTotal" property="feeTotal" jdbcType="DECIMAL" />
		    <result column="prePaidFeeTotal" property="prePaidFeeTotal" jdbcType="DECIMAL" />
		    <result column="arriveFeeTotal" property="arriveFeeTotal" jdbcType="DECIMAL" />
		    <result column="loadFeeTotal" property="loadFeeTotal" jdbcType="DECIMAL" />
		    <result column="collectionFeeTotal" property="collectionFeeTotal" jdbcType="DECIMAL" />
		    <result column="beReturnReceipt" property="beReturnReceipt" jdbcType="CHAR" />
		    <result column="goodsQtyTotal" property="goodsQtyTotal" jdbcType="DECIMAL" />
		    <result column="waybillQtyTotal" property="waybillQtyTotal" jdbcType="DECIMAL" />
		    <result column="weightTotal" property="weightTotal" jdbcType="DECIMAL" />
		    <result column="volumeTotal" property="volumeTotal" jdbcType="DECIMAL" />
		    <result column="fastWaybillQtyTotal" property="fastWaybillQtyTotal" jdbcType="DECIMAL" />
		    <result column="line" property="line" jdbcType="VARCHAR" />
		    <result column="currencyCode" property="currencyCode" jdbcType="VARCHAR" />
		    <result column="beCreateTaskTruck" property="beCreateTaskTruck" jdbcType="VARCHAR" />
		    <result column="inviteNo" property="inviteNo" jdbcType="VARCHAR" />
		    <result column="feeTotalChangeNotes" property="feeTotalChangeNotes" jdbcType="VARCHAR" />
		    <result column="beMidWayOnlyLoad" property="beMidWayOnlyLoad" jdbcType="VARCHAR"/>
		    <result column="onTheWayDestOrgCode" property="onTheWayDestOrgCode" jdbcType="VARCHAR"/>
		    <result column="onTheWayDestOrgName" property="onTheWayDestOrgName" jdbcType="VARCHAR"/>
		    <result column="driverOfWeight" property="driverOfWeight" jdbcType="DECIMAL" />
		    <result column="driverOfVolumn" property="driverOfVolumn" jdbcType="DECIMAL" />
		    <result column="applicationRatedLoad" property="applicationRatedLoad" jdbcType="DECIMAL" />
		    <result column="applicationRatedClearance" property="applicationRatedClearance" jdbcType="DECIMAL" />
		    <result property="waybillQtyAF" column="waybillQtyAF" />
			<result property="goodsWeightAF" column="goodsWeightAF" />
			<result property="goodsVolumeAF" column="goodsVolumeAF" />
			<result property="waybillQtyFLF" column="waybillQtyFLF" />
			<result property="goodsWeightFLF" column="goodsWeightFLF" />
			<result property="goodsVolumeFLF" column="goodsVolumeFLF" />
			<result property="waybillQtyFSF" column="waybillQtyFSF" />
			<result property="goodsWeightFSF" column="goodsWeightFSF" />
			<result property="goodsVolumeFSF" column="goodsVolumeFSF" />
			<result property="waybillQtyBGFLF" column="waybillQtyBGFLF" />
			<result property="goodsWeightBGFLF" column="goodsWeightBGFLF" />
			<result property="goodsVolumeBGFLF" column="goodsVolumeBGFLF" />
			<result property="waybillQtyBGFSF" column="waybillQtyBGFSF" />
			<result property="goodsWeightBGFSF" column="goodsWeightBGFSF" />
			<result property="goodsVolumeBGFSF" column="goodsVolumeBGFSF" />
  	</resultMap>

  	<!-- 用于查看配载单详情时获取交接单列表 -->
  	<resultMap id="queryHandOverBillListByVNoResultMap" 
		type="com.deppon.foss.module.transfer.load.api.shared.dto.QueryHandOverBillDto">
		<result property="id" column="id" />
		<result property="vehicleAssembleNo" column="vehicleAssembleNo" />
		<result property="handOverBillNo" column="handOverBillNo" />
		<result property="arriveDept" column="arriveDept" />
		<result property="arriveDeptCode" column="arriveDeptCode" />
		<result property="vehicleNo" column="vehicleNo" />
		<result property="goodsQtyTotal" column="totalPieces" />
		<result property="waybillQtyTotal" column="totalWaybill" />
		<result property="weightTotal" column="totalWeight" />
		<result property="codAmountTotal" column="totalCodAmount" />
		<result property="volumeTotal" column="totalCubage" />
		<result property="moneyTotal" column="totalMoney" />
		<result property="note" column="note" />
	</resultMap>
	
	<!--打印运输合同ResultMap-->
	<resultMap id="PrintCarriageContractDataResultMap" 
				   type="com.deppon.foss.module.transfer.load.api.shared.dto.PrintCarriageContractDataDto" >
	    <result column="contact" property="contact" />
	    <result column="vehicleNo" property="vehicleNo" />
	    <result column="driverCode" property="driverCode" />
	    <result column="driverName" property="driverName" />
	    <result column="idCard" property="idCard" />
	    <result column="driverLicense" property="driverLicense" />
	    <result column="engineNo" property="engineNo" />
	    <result column="vehicleFrameNo" property="vehicleFrameNo" />
	    <result column="operatingLic" property="operatingLic" />
	    <result column="drivingLicense" property="drivingLicense" />
	    <result column="origOrgName" property="origOrgName" />
	    <result column="origOrgCode" property="origOrgCode"/>
	    <result column="destOrgName" property="destOrgName" />
	    <result column="address" property="address" />
	    <result column="driverPhone" property="driverPhone" />
	    <result column="departTime" property="departTime" />
	    <result column="eta" property="eta" />
	    <result column="createUserName" property="createUserName" />
	    <result column="totQty" property="totQty" />
	    <result column="feeTotal" property="feeTotal" />
	    <result column="prePaidFeeTotal" property="prePaidFeeTotal" />
	    <result column="currencyCode" property="currencyCode" />
	    <result column="destStationContact" property="destStationContact" />
	    <result column="beReturnReceipt" property="beReturnReceipt" />
	    <result column="beTimeLiness" property="beTimeLiness"/>
	    <result column="note" property="note" />
  	</resultMap>

	<!--打印配载单_HeaderResultMap-->
	<resultMap id="PrintVehicleAssembleBillHeaderDataResultMap" 
				   type="com.deppon.foss.module.transfer.load.api.shared.dto.PrintVehicleAssembleBillHeaderDto" >
	    <result column="vehicleAssembleNo" property="vehicleAssembleNo" />
	    <result column="vehicleNo" property="vehicleNo" />
	    <result column="driverName" property="driverName" />
	    <result column="handOverBillNos" property="handOverBillNos" />
	    <result column="destOrgName" property="destOrgName" />
	    <result column="origOrgName" property="origOrgName" />
	    <result column="assembleType" property="assembleType" />
	    <result column="createUserName" property="createUserName" />
	    <result column="createTime" property="createTime" />
	    <result column="loaderName" property="loaderName" />
	    <result column="goodsQtyTotal" property="goodsQtyTotal" />
	    <result column="weightTotal" property="weightTotal" />
	    <result column="volumeTotal" property="volumeTotal" />
  	</resultMap>

	<!--配载单打印记录-->
	<resultMap id="MotorstowagebillrecordResultMap" 
				   type="com.deppon.foss.module.transfer.load.api.shared.domain.MotorstowagebillrecordEntity" >
	    <result column="id" property="id" />
	    <result column="printType" property="printType" />
	    <result column="vehicleassembleNo" property="vehicleassembleNo" />
	    <result column="printerName" property="printerName" />
	    <result column="printerCode" property="printerCode" />
	    <result column="printTime" property="printTime" />
	    <result column="orgName" property="orgName" />
	    <result column="orgCode" property="orgCode" />
  	</resultMap>
  	
	<!--打印配载单_DetailResultMap-->
	<resultMap id="PrintVehicleAssembleBillDetailDataResultMap" 
				   type="com.deppon.foss.module.transfer.load.api.shared.dto.PrintVehicleAssembleBillDetailDto" >
	    <result column="transportType" property="transportType" />
	    <result column="waybillNo" property="waybillNo" />
	    <result column="handoverNo" property="handoverNo" />
	    <result column="receiveOrgName" property="receiveOrgName" />
	    <result column="reachOrgName" property="reachOrgName" />
	    <result column="receiveCustomerName" property="receiveCustomerName" />
	    <result column="receiveCustomerMobilephone" property="receiveCustomerMobilephone" />
	    <result column="receiveCustomerPhone" property="receiveCustomerPhone" />
	    <result column="goodsName" property="goodsName" />
	    <result column="goodsPackage" property="goodsPackage" />
	    <result column="goodsQtyTotal" property="goodsQtyTotal" />
	    <result column="goodsWeightTotal" property="goodsWeightTotal" />
	    <result column="goodsVolumeTotal" property="goodsVolumeTotal" />
	    <result column="waybillNotes" property="waybillNotes" />
  	</resultMap>
  	
  	<!-- 用于查看配载单修改日志 -->
	<resultMap id="queryVehicleAssembleBillOptLogByNoResultMap" 
		type = "com.deppon.foss.module.transfer.load.api.shared.domain.VehicleAssembleBillOptLogEntity" >
		<result property="vehicleAssembleNo" column="vehicleAssembleNo" />
		<result property="optType" column="optType" />
		<result property="operatorName" column="operatorName" />
		<result property="optContent" column="optContent" />
		<result property="optTime" column="optTime" />
	</resultMap>
	
	<!--运单配载记录resultMap-->
	<resultMap id="queryVehicleAssembleRecordsByWaybillNoResultMap" 
		type = "com.deppon.foss.module.transfer.common.api.shared.dto.WayBillAssembleDto" >
		<result property="vehicleAssembleNo" column="vehicleAssembleNo" />
		<result property="leaveTime" column="leaveTime" />
		<result property="preArriveTime" column="preArriveTime" />
	</resultMap>
	<!--奖罚信息resultMap-->
	<resultMap id="queryRewardOrPunishDetailByVehicleAssembleNo" 
		type="com.deppon.foss.module.transfer.load.api.shared.domain.RewardOrPunishAgreementEntity">
		<result property="id" column="id"/>
		<result property="rewardOrPunishType" column="rewardOrPunishType"/>
		<result property="timeLimit" column="timeLimit"/>
		<result property="agreementMoney" column="agreementMoney"/>
		<result property="rewardOrPunishMaxMoney" column="rewardOrPunishMaxMoney"/>
		<result property="vehicleAssemBillNo" column="vehicleAssemBillNo"/>
	</resultMap>
	
	<!-- 新增时插入配载单基本信息 -->
	<insert id="saveVehicleAssembleBillBasicInfo"
		parameterType="com.deppon.foss.module.transfer.load.api.shared.domain.VehicleAssembleBillEntity">
			<![CDATA[
				 insert into tfr.T_OPT_VEHICLEASSEMBLEBILL(
					  ID,
					  TRUCKDEPARTPLANDETAIL_ID,
					  VEHICLEASSEMBLE_NO,
					  GOODS_TYPE,
					  ASSEMBLE_TYPE,
					  ORIG_ORG_CODE,
					  ORIG_ORG_NAME,
					  DEST_ORG_NAME,
					  DEST_ORG_CODE,
					  VEHICLE_NO,
					  VEHICLE_OWNERSHIP,
					  DRIVER_NAME,
					  DRIVER_CODE,
					  DRIVER_MOBILE_PHONE,
					  LEAVE_TIME,
					  TRANSPORT_TYPE,
					  RUN_HOURS,
					  LOADING_RATE,
					  CONTAINER_NO,
					  VEHICLE_MODEL,
					  EXAMINE_VOLUME,
					  RATED_CLEARANCE,
					  RATED_LOAD,
					  CREATE_USER_NAME,
					  CREATE_USER_CODE,
					  NOTES,
					  VEHICLE_MESSAGE,
					  FREQUENCY_NO,
					  BE_MIDWAYLOAD,
					  BEFINALLYARRIVE,
					  BE_INLTLCAR,
					  PAYMENT_TYPE,
					  FEE_TOTAL,
					  PREPAID_FEE_TOTAL,
					  ARRIVE_FEE_TOTAL,
					  BE_RETURN_RECEIPT,
					  LINE,
					  CURRENCY_CODE,
					  CREATE_TIME,
					  MODIFY_TIME,
					  MODIFY_USER_NAME,
					  MODIFY_USER_CODE,
					  BE_CREATE_TASKTRUCK,
					  STATE,
					  INVITE_NO,
					  TOTAL_FEE_CHANGE_NOTES,
					  BE_TIMELINESS,
					  MIDWAYLOADTYPE,
					  be_MidWay_OnlyLoad,
					  onTheWay_DestOrgCode,
					  onTheWay_DestOrgName,
					  driver_Weight ,
 					  driver_Volumn ,
 					  application_RatedLoad ,
 					  application_RatedClearance,
 					  be_Car_SmallUsed
				 ) values(
						#{id,jdbcType=VARCHAR},
					    #{truckDepartPlanDetailId,jdbcType=VARCHAR},
					    #{vehicleAssembleNo,jdbcType=VARCHAR},
					    #{goodsType,jdbcType=VARCHAR},
					    #{assembleType,jdbcType=VARCHAR},
					    #{origOrgCode,jdbcType=VARCHAR},
					    #{origOrgName,jdbcType=VARCHAR},
					    #{destOrgName,jdbcType=VARCHAR},
					    #{destOrgCode,jdbcType=VARCHAR},
					    #{vehicleNo,jdbcType=VARCHAR},
					    #{vehicleOwnerShip,jdbcType=VARCHAR},
					    #{driverName,jdbcType=VARCHAR},
					    #{driverCode,jdbcType=VARCHAR},
					    #{driverMobilePhone,jdbcType=VARCHAR},
					    #{leaveTime,jdbcType=TIMESTAMP},
					    #{transProperty,jdbcType=VARCHAR},
					    #{runHours,jdbcType=VARCHAR},
					    #{loadingRate,jdbcType=VARCHAR},
					    #{containerNo,jdbcType=VARCHAR},
					    #{vehicleModel,jdbcType=VARCHAR},
					    #{examineVolume,jdbcType=DECIMAL},
					    #{ratedClearance,jdbcType=DECIMAL},
					    #{ratedLoad,jdbcType=DECIMAL},
					    #{createUserName,jdbcType=VARCHAR},
					    #{createUserCode,jdbcType=VARCHAR},
					    #{note,jdbcType=VARCHAR},
					    #{vehicleMessage,jdbcType=VARCHAR},
					    #{frequencyNo,jdbcType=VARCHAR},
					    #{beMidWayLoad,jdbcType=VARCHAR},
					    #{beFinallyArrive,jdbcType=VARCHAR},
					    #{beInLTLCar,jdbcType=VARCHAR},
					    #{paymentType,jdbcType=VARCHAR},
					    #{feeTotal,jdbcType=DECIMAL}*100,
					    #{prePaidFeeTotal,jdbcType=DECIMAL}*100,
					    #{arriveFeeTotal,jdbcType=DECIMAL}*100,
					    #{beReturnReceipt,jdbcType=VARCHAR},
					    #{line,jdbcType=VARCHAR},
					    #{currencyCode,jdbcType=VARCHAR},
					    sysdate,
					    #{modifyDate,jdbcType=TIMESTAMP},
					    #{modifyUserName,jdbcType=VARCHAR},
					    #{modifyUserCode,jdbcType=VARCHAR},
					    #{beCreateTaskTruck,jdbcType=VARCHAR},
					    10,
					    #{inviteNo,jdbcType=VARCHAR},
					    #{feeTotalChangeNotes,jdbcType=VARCHAR},
					    #{beTimeLiness,jdbcType=VARCHAR},
					    #{midWayLoadType,jdbcType=VARCHAR},
					    #{beMidWayOnlyLoad,jdbcType=VARCHAR},
					    #{onTheWayDestOrgCode,jdbcType=VARCHAR},
					    #{onTheWayDestOrgName,jdbcType=VARCHAR},
					    #{driverOfWeight,jdbcType=DECIMAL},
					    #{driverOfVolumn,jdbcType=DECIMAL},
					    #{applicationRatedLoad,jdbcType=DECIMAL},
					    #{applicationRatedClearance,jdbcType=DECIMAL},
					    #{beCarSmallUsed,jdbcType=VARCHAR}
					    )
			]]>
	</insert>
	<!-- 新增配载单时，批量插入交接单信息 -->
	<insert id="saveHandOverBillList" parameterType="java.util.List">
		begin
		<foreach collection="list" item="item" separator=";">
			insert into
			tfr.T_OPT_VEHICLEASSEMBLE_DETAIL
			(ID,
			HANDOVER_NO,
			DEST_ORG_NAME,
			VEHICLEASSEMBLEBILL_ID,
			CREATE_TIME)
			values
			(#{item.id,jdbcType=VARCHAR},
			#{item.handOverBillNo,jdbcType=VARCHAR},
			#{item.arriveDept,jdbcType=VARCHAR},
			#{item.vehicleAssembleBillId,jdbcType=VARCHAR},
			#{item.createDate,jdbcType=TIMESTAMP})
		</foreach>
		;end;
	</insert>
	<!-- 查询配载单 -->
	<select id="queryVehicleAssembleBillList" resultMap="VehicleAssembleBillResultMap"
	parameterType="com.deppon.foss.module.transfer.load.api.shared.dto.QueryVehicleAssembleBillConditionDto">
		<![CDATA[
		    select 
			    max(vab.vehicleassemble_no) vehicleAssembleNo,
			    max(vab.state) state,
			    max(vab.fee_total/100) feeTotal,
			    max(vab.assemble_type) assembleType,
			    max(vab.orig_org_name) origOrgName,
			    max(vab.orig_org_code) origOrgCode,
			    max(vab.dest_org_name) destOrgName,
			    max(vab.vehicle_ownership) vehicleOwnerShip,
			    max(vehicleTaskDetail.Actual_Depart_Time) departTime,
			    max(nvl(vehicleTaskDetail.Manual_Arrive_Time,vehicleTaskDetail.Actual_Arrive_Time)) arriveTime,
			    max(vab.frequency_no) frequencyNo,
			    max(vab.vehicle_no) vehicleNo,
			    max(vab.loading_rate) loadingRate,
			    max(vab.create_time) createDate,
			    max(vab.create_user_name) createUserName,
			    max(vab.driver_name) driverName,
			    max(vab.modify_user_name) modifyUserName,
			    max(vab.modify_time) modifyDate,
			    max(vab.rated_clearance) ratedClearance,
      			max(vab.rated_load) ratedLoad,
      			max(vab.notes)   note,
      			max(vab.driver_mobile_phone) driverMobilePhone, 
      			max(vab.midWayLoadType)   midWayLoadType,
      			max(vab.driver_Weight) driverOfWeight,
      			max(vab.driver_Volumn) driverOfVolumn,
      			max(vab.application_RatedLoad) applicationRatedLoad,
      			max(vab.application_RatedClearance) applicationRatedClearance,
      			max(vab.be_Car_SmallUsed) beCarSmallUsed,
      			max(vehicleTaskDetail.PLAN_ARRIVE_TIME) planArriveTime,
      			max(lt.contact) truckOwnerName,
      			max(pia.APPLY_PATH) applyPath,   
      			max(pia.MINISTRYINFORMATION_CODE) ministryinformationCode，
      			sum(h.GOODS_QTY_TOTAL) goodsQtyTotal,
      			sum(h.WAYBILL_QTY_TOTAL) waybillQtyTotal,
      			sum(h.WEIGHT_TOTAL) weightTotal,
      			sum(h.VOLUME_TOTAL) volumeTotal,
			    sum(h.AF_GOODS_QTY) waybillQtyAF,
				sum(h.AF_GOODS_VOLUME) goodsVolumeAF,
				sum(h.AF_GOODS_WEIGHT) goodsWeightAF,
				sum(h.FLF_GOODS_QTY) waybillQtyFLF,
				sum(h.FLF_GOODS_VOLUME) goodsVolumeFLF,
				sum(h.FLF_GOODS_WEIGHT) goodsWeightFLF,
				sum(h.FSF_GOODS_QTY) waybillQtyFSF,
				sum(h.FSF_GOODS_VOLUME) goodsVolumeFSF,
				sum(h.FSF_GOODS_WEIGHT) goodsWeightFSF,
				SUM(h.bgflf_goods_qty) waybillQtyBGFLF,
        		SUM(h.bgflf_goods_volume) goodsVolumeBGFLF,
        		SUM(h.bgflf_goods_weight) goodsWeightBGFLF,
        		SUM(h.bgfsf_goods_qty) waybillQtyBGFSF, 
        		SUM(h.bgfsf_goods_volume) goodsVolumeBGFSF,
        		SUM(h.bgfsf_goods_weight) goodsWeightBGFSF 
		      from tfr.t_opt_vehicleassemblebill  vab
		     left join tfr.t_opt_TRUCK_TASK_BILL vehicleTaskBill
		         on vehicleTaskBill.Bill_No = vab.vehicleassemble_no 
		     left join tfr.t_opt_TRUCK_TASK_DETAIL vehicleTaskDetail
		         on vehicleTaskBill.Truck_Task_Detail_Id = vehicleTaskDetail.Id
		     left join tfr.t_opt_vehicleassemble_detail vd on vab.id = vd.vehicleassemblebill_id
		     left join tfr.t_opt_handoverbill h on vd.handover_no = h.handover_no
		     left join bse.t_bas_leased_truck lt on lt.vehicle_no = vab.vehicle_no  and lt.active = 'Y'
  			 left join TFR.T_OPT_PASS_INVITE_APPLY pia on pia.invite_no = vab.invite_no
		]]>
		<where>
			<!-- 出发部门或者到达部门是本部门 -->
			(vab.orig_org_code = #{currentDeptCode} 
			or vab.dest_org_code = #{currentDeptCode}) 
			and vab.create_time <![CDATA[ >=]]> #{beginCreateTime} 
			and vab.create_time <![CDATA[ <=]]> #{endCreateTime}  
			and vab.state != 90 
			<if test="vehicleAssembleNo != null and vehicleAssembleNo != ''">
				and vab.vehicleassemble_no = #{vehicleAssembleNo}
			</if>
			<if test="assembleDept != null and assembleDept != ''">
				and vab.orig_org_code = #{assembleDept}
			</if>
			<if test="assembleType != null and assembleType != '' and assembleType != 'ALL'">
				and vab.assemble_type = #{assembleType}
			</if>
			<if test="driver != null and driver != ''">
				and vab.driver_code = #{driver}
			</if>
			<if test="arriveDept != null and arriveDept != ''">
				and vab.dest_org_code = #{arriveDept}
			</if>
			<if test="vehicleNo != null and vehicleNo != ''">
				and vab.vehicle_no = #{vehicleNo}
			</if>
			<if test="vehicleType !=null and vehicleType !='' and vehicleType!='ALL'">
				and vab.vehicle_ownership = #{vehicleType}
			</if>
		</where>
		 group by vab.vehicleassemble_no
	</select>
	<!-- 获取查询到的配载单的总条数 -->
	<select id="getVehicleAssembleBillCount" resultType="Long"
	parameterType="com.deppon.foss.module.transfer.load.api.shared.dto.QueryVehicleAssembleBillConditionDto">
		<![CDATA[
		select 
			count(vab.id)  
			from tfr.t_opt_vehicleassemblebill  vab
		]]>
		<where>
			<!-- 出发部门或者到达部门是本部门 -->
			(vab.orig_org_code = #{currentDeptCode} 
			or vab.dest_org_code = #{currentDeptCode}) 
			and vab.create_time <![CDATA[ >=]]> #{beginCreateTime} 
			and vab.create_time <![CDATA[ <=]]> #{endCreateTime}  
			and vab.state != 90 
			<if test="vehicleAssembleNo != null and vehicleAssembleNo != ''">
				and vab.vehicleassemble_no = #{vehicleAssembleNo}
			</if>
			<if test="assembleDept != null and assembleDept != ''">
				and vab.orig_org_code = #{assembleDept}
			</if>
			<if test="assembleType != null and assembleType != '' and assembleType != 'ALL'">
				and vab.assemble_type = #{assembleType}
			</if>
			<if test="driver != null and driver != ''">
				and vab.driver_code = #{driver}
			</if>
			<if test="arriveDept != null and arriveDept != ''">
				and vab.dest_org_code = #{arriveDept}
			</if>
			<if test="vehicleNo != null and vehicleNo != ''">
				and vab.vehicle_no = #{vehicleNo}
			</if>
			<if test="vehicleType !=null and vehicleType !='' and vehicleType!='ALL'">
				and vab.vehicle_ownership = #{vehicleType}
			</if>
		</where>
	</select>
	<!-- 根据配载车次号获取配载单基本信息 -->
	<select id="queryVehicleAssembleBillByNo" resultMap="VehicleAssembleBillResultMap"
	parameterType="String">
		<![CDATA[
		select 
			v.id id,
			v.TRUCKDEPARTPLANDETAIL_ID truckDepartPlanDetailId,
			v.assemble_type assembleType,
			v.ORIG_ORG_NAME origOrgName,
			v.ORIG_ORG_CODE origOrgCode,
			v.dest_org_name destOrgName,
			v.dest_org_code destOrgCode,
			v.leave_time leaveTime,
			v.create_time createDate,
			v.state state,
			v.vehicleassemble_no vehicleAssembleNo,
			v.vehicle_no vehicleNo,
			v.driver_name driverName,
			v.driver_code driverCode,
			v.vehicle_ownership vehicleOwnerShip,
			v.frequency_no frequencyNo,
			v.transport_type transProperty,
			v.driver_mobile_phone driverMobilePhone,
			v.run_hours runHours,
			v.rated_load ratedLoad,
			v.vehicle_model vehicleModel,
			v.examine_volume examineVolume,
			v.rated_clearance ratedClearance,
			v.loading_rate loadingRate,
			v.create_user_name createUserName,
			v.create_user_code createUserCode,
			v.modify_user_name modifyUser,
			v.goods_type goodsType,
			v.be_midwayload beMidwayLoad,
			v.befinallyarrive beFinallyArrive,
			v.be_InLTLCar   beInLTLCar, 
			v.vehicle_message vehicleMessage,
			v.notes note,
			v.payment_type paymentType,
			v.fee_total/100 feeTotal,
			v.prepaid_fee_total/100 prePaidFeeTotal,
			v.arrive_fee_total/100 arriveFeeTotal,
			v.container_no containerNo,
			v.be_return_receipt beReturnReceipt,
			v.BE_CREATE_TASKTRUCK beCreateTaskTruck,
			v.INVITE_NO inviteNo,
			v.TOTAL_FEE_CHANGE_NOTES feeTotalChangeNotes,
			v.BE_TIMELINESS beTimeLiness,
			v.MIDWAYLOADTYPE midWayLoadType,
			v.be_midway_onlyload beMidWayOnlyLoad,
			v.ontheway_destorgcode  onTheWayDestOrgCode,
            v.ontheway_destorgname	onTheWayDestOrgName,
            v.driver_Weight driverOfWeight,
    		v.driver_Volumn driverOfVolumn,
    		v.application_RatedLoad applicationRatedLoad,
    		v.application_RatedClearance applicationRatedClearance,
    		v.be_Car_SmallUsed beCarSmallUsed
			from tfr.t_opt_vehicleassemblebill v 
		]]>
		<where>
				v.vehicleassemble_no = #{vehicleAssembleNo} 
				and v.state != 90 
		</where>
	</select>
	<!-- 根据交接单号查询快递交接单信息 -->
	<select id="queryVehicleAssembleBillByNoFromWk" resultMap="VehicleAssembleBillResultMap"
	parameterType="String">
		<![CDATA[
		select V.HANDOVERBILLNO vehicleAssembleNo,
	       Case V.HANDOVERSTATE
	         When 'HAVE_PLACED' Then
	          10
	         When 'HAVE_DEPART' Then
	          20
	         When 'HAVE_ARRIVE' Then
	          30
	         When 'HAVE_STOCK' Then
	          30
	         Else
	          90
	       END state
  		FROM tfr.t_wk_trf_bill V
 		]]>
		<where>
			V.HANDOVERBILLNO =#{vehicleAssembleNo} 
			and V.HANDOVERSTATE != 'HAVE_CANLE'
		</where>
	</select>
	<!-- 根据配载车次号获取获取其下交接单列表 -->
	<select id="queryHandOverBillListByVNo" resultMap="queryHandOverBillListByVNoResultMap"
	parameterType="String">
		<![CDATA[
		select 
			vb.vehicleassemble_no vehicleAssembleNo,
			hb.handover_no handOverBillNo,
			hb.dest_org_name arriveDept,
			hb.dest_org_code arriveDeptCode,
			hb.weight_total totalWeight,
			hb.volume_total totalCubage,
			hb.vehicle_no vehicleNo,
			hb.goods_qty_total totalPieces,
			hb.waybill_qty_total totalWaybill,
			hb.money_total/100 totalMoney,
       		hb.cod_amount_total totalCodAmount,
			hb.notes note 
			from tfr.t_opt_handoverbill hb
			left join tfr.t_opt_vehicleassemble_detail vbd
			on hb.handover_no = vbd.handover_no 
			left join tfr.t_opt_vehicleassemblebill vb
			on vb.id = vbd.vehicleassemblebill_id
		]]>
		<where>
				vb.vehicleassemble_no = #{vehicleAssembleNo}
				and vb.state != 90 
		</where>
	</select>
	
	<!-- 查询打印运输合同需要的数据_zyx -->
	<select id="queryPrintCarriageContractData" resultMap="PrintCarriageContractDataResultMap"
	parameterType="java.lang.String">
		<![CDATA[
		select
			truck.contact contact, bill.vehicle_No vehicleNo, bill.driver_code driverCode, bill.driver_name driverName,
			driver.id_card idCard, driver.driver_license driverLicense, truck.engine_no engineNo,
			truck.vehicle_frame_no vehicleFrameNo, truck.operating_lic operatingLic,
			truck.driving_license drivingLicense, bill.orig_org_name origOrgName,bill.orig_org_code origOrgCode,
			bill.dest_org_name destOrgName, driver.address address, driver.driver_phone driverPhone,
			sysdate departTime, (sysdate + bill.run_hours/24) eta, bill.create_user_name createUserName,
			sum(handoverbill.goods_qty_total) totQty,
			bill.fee_total feeTotal, bill.prepaid_fee_total prePaidFeeTotal, bill.currency_code currencyCode,
			bill.dest_org_code destStationContact, bill.be_return_receipt beReturnReceipt,
			bill.Be_TimeLiness beTimeLiness,
			bill.notes note
			from 
			tfr.t_opt_vehicleassemblebill bill
			left join bse.t_bas_leased_truck truck
			on bill.vehicle_No = truck.vehicle_No
			and truck.active = 'Y'
			left join bse.t_bas_leased_driver driver
			on driver.id_card = bill.driver_code
			and driver.active = 'Y'
			left join tfr.t_opt_vehicleassemble_detail detail
	        on bill.id = detail.vehicleassemblebill_id
	        left join tfr.t_opt_handoverbill handoverbill
	        on detail.handover_no = handoverbill.handover_no
		where bill.vehicleassemble_no = #{vehicleAssembleNo}
		group by truck.contact, bill.vehicle_no, bill.driver_code, bill.driver_name, driver.id_card, driver.driver_license,
			  truck.engine_no,truck.vehicle_frame_no,truck.operating_lic,truck.driving_license,
			  bill.orig_org_name,bill.dest_org_name,driver.address,driver.driver_phone,bill.run_hours,
			  bill.create_user_name,bill.fee_total,bill.prepaid_fee_total,bill.currency_code,
			  bill.dest_org_code,bill.be_return_receipt,bill.notes,bill.orig_org_code,bill.Be_TimeLiness
		]]>
	</select>
	<!-- 根据配载车次号获取修改日志 -->
	<select id="queryVehicleAssembleBillOptLogByNo" resultMap="queryVehicleAssembleBillOptLogByNoResultMap"
	parameterType="String">
		<![CDATA[
		select 
				optLog.Operator_Name operatorName,
				optLog.Operate_Time optTime,
				optLog.Operate_Type optType,
				optLog.Content optContent
				 from tfr.t_opt_vehicleassemble_log optLog 
		]]>
		<where>
				optLog.vehicleassemble_no = #{vehicleAssembleNo}
				order by optLog.Operate_Time
		</where>
	</select>
	<!-- 根据配载车次号获取修改日志的条数 -->
	<select id="getVehicleAssembleBillOptLogCountByNo" resultType="Long" parameterType="String">
		<![CDATA[
		select count(ID)
		from tfr.t_opt_vehicleassemble_log optLog 
		]]>
		<where>
				optLog.vehicleassemble_no = #{vehicleAssembleNo}
		</where>
	</select>
	
	<!--更新配载单基本信息-->
	<update id="updateVehicleAssembleBillBaseInfo" parameterType="com.deppon.foss.module.transfer.load.api.shared.domain.VehicleAssembleBillEntity">
		update tfr.t_opt_vehicleassemblebill v set 
			<if test="truckDepartPlanDetailId != null and truckDepartPlanDetailId != ''">
					TRUCKDEPARTPLANDETAIL_ID = #{truckDepartPlanDetailId,jdbcType=VARCHAR},
			</if>
			<if test="line != null and line != ''">
					LINE = #{line,jdbcType=VARCHAR},
			</if>
			GOODS_TYPE = #{goodsType,jdbcType=VARCHAR},                      
			VEHICLE_NO = #{vehicleNo,jdbcType=VARCHAR},                 
			VEHICLE_OWNERSHIP = #{vehicleOwnerShip,jdbcType=VARCHAR},   
			DRIVER_NAME = #{driverName,jdbcType=VARCHAR},               
			DRIVER_CODE = #{driverCode,jdbcType=VARCHAR},               
			DRIVER_MOBILE_PHONE = #{driverMobilePhone,jdbcType=VARCHAR},
			LEAVE_TIME = #{leaveTime,jdbcType=TIMESTAMP},               
			TRANSPORT_TYPE = #{transProperty,jdbcType=VARCHAR},         
			RUN_HOURS = #{runHours,jdbcType=VARCHAR},                   
			LOADING_RATE = #{loadingRate,jdbcType=VARCHAR},             
			CONTAINER_NO = #{containerNo,jdbcType=VARCHAR},             
			EXAMINE_VOLUME = #{examineVolume,jdbcType=DECIMAL},         
			RATED_CLEARANCE = #{ratedClearance,jdbcType=DECIMAL},       
			RATED_LOAD = #{ratedLoad,jdbcType=DECIMAL},                 
			NOTES = #{note,jdbcType=VARCHAR},                           
			VEHICLE_MESSAGE = #{vehicleMessage,jdbcType=VARCHAR},       
			FREQUENCY_NO = #{frequencyNo,jdbcType=VARCHAR},             
			BE_MIDWAYLOAD = #{beMidWayLoad,jdbcType=VARCHAR},
			BE_TIMELINESS = #{beTimeLiness,jdbcType=VARCHAR},           
			BEFINALLYARRIVE = #{beFinallyArrive,jdbcType=VARCHAR},
			be_midway_onlyload = #{beMidWayOnlyLoad,jdbcType=VARCHAR},
			ontheway_destorgcode =#{onTheWayDestOrgCode,jdbcType=VARCHAR}, 
			ontheway_destorgname = #{onTheWayDestOrgName,jdbcType=VARCHAR},     
			PAYMENT_TYPE = #{paymentType,jdbcType=VARCHAR},             
			FEE_TOTAL = #{feeTotal,jdbcType=DECIMAL}*100,                   
			PREPAID_FEE_TOTAL = #{prePaidFeeTotal,jdbcType=DECIMAL}*100,    
			ARRIVE_FEE_TOTAL = #{arriveFeeTotal,jdbcType=DECIMAL}*100,      
			BE_RETURN_RECEIPT = #{beReturnReceipt,jdbcType=VARCHAR},                            
			MODIFY_TIME = #{modifyDate,jdbcType=TIMESTAMP},             
			MODIFY_USER_NAME = #{modifyUserName,jdbcType=VARCHAR},      
			MODIFY_USER_CODE = #{modifyUserCode,jdbcType=VARCHAR},
		    MIDWAYLOADTYPE= #{midWayLoadType,jdbcType=VARCHAR},
		    driver_Weight = #{driverOfWeight,jdbcType=DECIMAL} ,
    		driver_Volumn = #{driverOfVolumn,jdbcType=DECIMAL} ,
    		application_RatedLoad = #{applicationRatedLoad,jdbcType=DECIMAL},
    		application_RatedClearance = #{applicationRatedClearance,jdbcType=DECIMAL},
    		be_Car_SmallUsed =#{beCarSmallUsed,jdbcType=VARCHAR}
			<where>
				v.vehicleassemble_no = #{vehicleAssembleNo,jdbcType=VARCHAR}
			</where>
	</update>
	<!--删除配载单中交接单-->
	<delete id = "deleteHandOverBillList" 
			parameterType = "com.deppon.foss.module.transfer.load.api.shared.dto.DeleteHandOverBillFromVehicleAssembleBillDto">
		delete from tfr.t_opt_vehicleassemble_detail vd 
		<where>
			vd.vehicleassemblebill_id = #{vehicleAssembleBillId,jdbcType=VARCHAR} 
			and (
				<foreach collection="handOverBillList" item="item" separator="or">
					vd.handover_no = #{item,jdbcType=VARCHAR}
				</foreach>
			)
		</where>
	</delete>
	<!--批量插入修改日志-->
	<insert id="saveOptLogList"  parameterType="java.util.List">
		begin
		<foreach collection="list" item="item" separator=";">
			insert into
			tfr.t_opt_vehicleassemble_log
			(id,
			vehicleassemblebill_id,
			vehicleassemble_no,
			operate_type,
			operator_code,
			operator_name,
			content,
			operate_time,
			billing_time
			)
			values
			(#{item.id,jdbcType=VARCHAR},
			#{item.vehicleAssembleBillId,jdbcType=VARCHAR},
			#{item.vehicleAssembleNo,jdbcType=VARCHAR},
			#{item.optType,jdbcType=VARCHAR},
			#{item.operatorCode,jdbcType=VARCHAR},
			#{item.operatorName,jdbcType=VARCHAR},
			#{item.optContent,jdbcType=VARCHAR},
			#{item.optTime,jdbcType=TIMESTAMP},
			#{item.billingTime,jdbcType=TIMESTAMP})
		</foreach>
		;end;
	</insert>
	<!-- 根据配载车次号更新配载单状态 -->
	<update id="updateVehicleAssembleBillState"  parameterType = "java.util.List">
		begin
		<foreach collection="list" item="item" separator=";">
			update
			tfr.t_opt_vehicleassemblebill t
			<set>
				  t.state = #{item.targetState,jdbcType=DECIMAL}
			</set>
			<where>
				t.vehicleassemble_no = #{item.vehicleAssembleNo,jdbcType=VARCHAR} 
			</where>
		</foreach>
		;end;
	</update>
	
	<!--根据配载车次号获取车次下的所有运单号，同车次下运单号可能重复，故做去重操作-->
	<select id="queryWaybillNoListByVehicleAssembleNo" resultType="java.lang.String" parameterType="java.lang.String">
		select distinct(hod.waybill_no) waybillNo 
		from tfr.t_opt_handoverbill_detail hod,
		     tfr.t_opt_handoverbill hob,
		     tfr.t_opt_vehicleassemble_detail vad,
		     tfr.t_opt_vehicleassemblebill vab
		<where>
			  hod.handover_no = hob.handover_no(+)
		      and hob.handover_no = vad.handover_no(+)
		      and vad.vehicleassemblebill_id = vab.id(+)
		      and vab.vehicleassemble_no = #{vehicleAssembleNo}
		      and vab.state != 90
		</where>
	</select>
	
	<!-- 查询出打印配置单中的一部分数据_zyx -->
	<select id="queryVehicleAssembleBillPrtDataSource" resultMap="PrintVehicleAssembleBillHeaderDataResultMap" parameterType="String">
		<![CDATA[
		select v.id id,
	       v.vehicleassemble_no vehicleassembleno,
	       v.vehicle_no vehicleno,
	       v.driver_name drivername,
	       Wm_concat(h.handover_no) handoverbillnos,
	       v.dest_org_name destorgname,
	       v.orig_org_name origorgname,
	       v.assemble_type assembletype,
	       v.create_user_name createusername,
	       v.create_time createtime
	  from tfr.t_opt_vehicleassemblebill    v,
	       tfr.t_opt_handoverbill           h,
	       tfr.t_opt_vehicleassemble_detail d
	 where h.handover_no = d.handover_no(+)
	   and d.vehicleassemblebill_id = v.ID(+)
	   and v.vehicleassemble_no = #{vehicleAssembleNo}
	 group by v.id,
	          v.vehicleassemble_no,
	          v.vehicle_no,
	          v.driver_name,
	          v.dest_org_name,
	          v.orig_org_name,
	          v.assemble_type,
	          v.create_user_name,
	          v.create_time
		]]>
	</select>
	<!-- 查询出打印配置单中的一部分数据_根据配载单号查询出装车人_zyx -->
	<select id="queryLoaderNameByVehicleassemblebillId" resultType="String" parameterType="String">
		<![CDATA[
		select 
			loaderName 
		from 
			(select p.LOADER_NAME loaderName, rownum row_num 
			from 
			tfr.t_opt_handoverbill h
			left join tfr.t_opt_vehicleassemble_detail d 
			on h.handover_no = d.handover_no
			left join tfr.t_opt_load_task t
			on h.load_task_no = t.task_no
			left join tfr.t_opt_loader_participation p
			on t.id = p.task_id
			where vehicleassemblebill_id = #{vehicleassemblebillId}
			order by h.create_time desc
			) 
		where 
			row_num = 1
		]]>
	</select>
	<!-- 查询出打印配置单中的一部分数据_查询出该配置单下所有交接单的汇总_zyx -->
	<select id="querySummaryHandOverBillByVehicleassemblebill" resultMap="PrintVehicleAssembleBillHeaderDataResultMap" parameterType="String">
		<![CDATA[
		select
			sum(h.goods_qty_total) goodsQtyTotal,
			sum(h.weight_total) weightTotal,
			sum(h.volume_total) volumeTotal
		from
			tfr.t_opt_handoverbill h
			left join tfr.t_opt_vehicleassemble_detail d
			on h.handover_no = d.handover_no
		where 
			d.vehicleassemblebill_id = #{vehicleassemblebillId}
		]]>
	</select>
	<!-- 查询出打印配置单中的一部分数据_查询出该配置单下运单明细数据_zyx -->
	<select id="queryVehicleAssembleBillDetailPrtDataSource" resultMap="PrintVehicleAssembleBillDetailDataResultMap" parameterType="String">
		<![CDATA[
		select 
		  hd.transport_type transportType,
		  hd.waybill_no waybillNo,
		  hd.handover_no handoverNo,
		  hd.receive_org_name receiveOrgName,
		  hd.reach_org_name reachOrgName,
		  wb.receive_customer_name receiveCustomerName,
		  wb.receive_customer_mobilephone receiveCustomerMobilephone,
		  wb.receive_customer_phone receiveCustomerPhone,
		  wb.goods_name goodsName,
		  wb.goods_package goodsPackage,
		  hd.handover_goods_qty handoverGoodsQty,
		  wb.goods_qty_total goodsQtyTotal,
		  hd.actual_weight goodsWeightTotal,
      	  hd.actual_volume goodsVolumeTotal,
		  hd.waybill_notes waybillNotes
		from 
		tfr.t_opt_handoverbill_detail hd
		left join pkp.t_srv_waybill wb
		on hd.waybill_no = wb.waybill_no
		and wb.active = 'Y'
		left join tfr.t_opt_vehicleassemble_detail vd
		on hd.handover_no = vd.handover_no
		where 
		vd.vehicleassemblebill_id = #{vehicleassemblebillId}
		order by hd.transport_type, hd.waybill_no
		]]>
	</select>
	<!-- 查询出打印配置单中的一部分数据_根据配载单ID查询出交接明细_zyx -->
	<select id="getHandOverBillSerialNoDetailsByWayBillNo" resultType="String" parameterType="HashMap">
		<![CDATA[
		select replace(wm_concat(to_number(serial_no)), ',', '/')
  		  from (select serialNo.serial_no
          from tfr.t_opt_handoverbill_serialno serialNo
         where serialNo.Handoverbill_No = #{handOverBillNo}
           and serialNo.Waybill_No = #{waybillNo}
         order by serialNo.serial_no asc)
		  ]]>
	</select>
	<!-- 查询出打印配置单中的一部分数据_根据配载单号查询出装车封签_zyx -->
	<select id="querySealNosByVehicleAssembleNo" resultType="String" parameterType="HashMap">
		
		    select replace(wm_concat(seal_no), ',', '/')
			  from (select sod.seal_no
			          from tfr.t_opt_seal_orig_detail  sod,
			               tfr.t_opt_seal              seal,
			               tfr.t_opt_truck_task        tt,
			               tfr.t_opt_truck_task_detail ttd,
			               tfr.t_opt_truck_task_bill   ttb
			         <where> 
			           sod.seal_id = seal.id
			           and tt.id = seal.t_truck_task_detail_id
			           and ttd.truck_task_id = tt.id
			           and ttb.truck_task_detail_id = ttd.id
			           <if test="sealType !=null and sealType!=''">
			           	and sod.seal_type = #{sealType}
			           </if>
			           and ttb.bill_type = 'VEHICLEASSEMBLE'
			           and ttb.bill_no = #{billNo}
			          </where>
			         order by sod.seal_no)
		 
	</select>
	<!-- 配载单打印次数记录_zyx -->
	<insert id="insertMotorstowagebillrecord" parameterType="com.deppon.foss.module.transfer.load.api.shared.domain.MotorstowagebillrecordEntity" >
    insert into TFR.t_opt_motorstowagebillrecord (id, print_type, vehicleassemble_no, 
      printer_name, printer_code, print_time, 
      org_name, org_code)
    values (#{id}, #{printType}, #{vehicleassembleNo}, 
      #{printerName}, #{printerCode}, #{printTime}, 
      #{orgName}, #{orgCode})
  </insert>
  
  	<!--根据运单号查询汽运配载记录-->
  	<select id="queryVehicleAssembleRecordsByWaybillNo" resultMap ="queryVehicleAssembleRecordsByWaybillNoResultMap" parameterType="java.lang.String">
		select 
            vab.vehicleassemble_no vehicleAssembleNo,
            ttd.actual_depart_time leaveTime,
            ttd.plan_arrive_time preArriveTime 
 		from tfr.t_opt_vehicleassemblebill vab,
            tfr.t_opt_truck_task_bill ttb,
            tfr.t_opt_truck_task_detail ttd,
            tfr.t_opt_vehicleassemble_detail vad,
            tfr.t_opt_handoverbill_detail hod
        where vab.vehicleassemble_no = ttb.bill_no(+)
	          and ttb.truck_task_detail_id = ttd.id(+)
	          and vab.id = vad.vehicleassemblebill_id(+)
	          and vad.handover_no = hod.handover_no
	          and hod.waybill_no = #{waybillNo}
	</select>
	
	<!-- 验证选择的交接单在该车牌下是否还有其他的没选择_zyx-->
	<select id="checkPrintVehicleAssembleBill" parameterType = "com.deppon.foss.module.transfer.load.api.shared.vo.VehicleAssembleBillVo" resultType="Long">
		select count(ttb.id)
	  from tfr.t_opt_truck_task_bill   ttb,
	       tfr.t_opt_truck_task_detail ttd,
	       tfr.t_opt_truck_task        tt
	 where tt.id = ttd.truck_task_id(+)
	   and ttd.id = ttb.truck_task_detail_id(+)
	   and ttb.bill_type = 'VEHICLEASSEMBLE'
	   and ttb.bill_level = '1'
	   and tt.id = (select tt.id
	                  from tfr.t_opt_truck_task        tt,
	                       tfr.t_opt_truck_task_detail ttd,
	                       tfr.t_opt_truck_task_bill   ttb
	                 where tt.id = ttd.truck_task_id
	                   and ttd.id = ttb.truck_task_detail_id
	                   and ttb.bill_type = 'VEHICLEASSEMBLE'
	                   and ttb.bill_level = '1'
	                   and ttb.bill_no in 
	                   <foreach collection="vehicleAssembleNos" open="(" close=")" separator="," index="index" item="item">
						#{item}
					   </foreach>
	                 group by tt.id)
	   and ttb.bill_no not in 
			<foreach collection="vehicleAssembleNos" open="(" close=")" separator="," index="index" item="item">
			#{item}
		    </foreach>
	</select>

	<!-- 验证选择了多少个车辆任务_zyx-->
	<select id="checkPrintTruckTask" parameterType = "com.deppon.foss.module.transfer.load.api.shared.vo.VehicleAssembleBillVo" resultType="Long">
		select count(tt.id)
          from tfr.t_opt_truck_task        tt,
               tfr.t_opt_truck_task_detail ttd,
               tfr.t_opt_truck_task_bill   ttb
         where tt.id = ttd.truck_task_id
           and ttd.id = ttb.truck_task_detail_id
           and ttb.bill_type = 'VEHICLEASSEMBLE'
           and ttb.bill_level = '1'
           and ttb.bill_no in 
           <foreach collection="vehicleAssembleNos" open="(" close=")" separator="," index="index" item="item">
			#{item}
		   </foreach>
	</select>
	<!-- 根据配置单号获取运输合同打印记录-->
	<select id="getMotorstowagebillrecordByVehicleAssembleNo" parameterType = "java.lang.String" resultMap="MotorstowagebillrecordResultMap">
		select id,
		       print_type printType,
		       vehicleassemble_no vehicleassembleNo,
		       printer_name printerName,
		       printer_code printerCode,
		       print_time printTime,
		       org_name orgName,
		       org_code orgCode
		  from tfr.t_opt_motorstowagebillrecord
		 where vehicleassemble_no = #{vehicleAssembleNo}
		   and print_type = 'CARRIAGECONTRACT'
		   and rownum = 1
	</select>
	
	<!--获取两部门之间的最大配载车次号，用于生成配载车次号时使用-->
	<select id="queryLatestVehicleAssembleNo" resultType="java.lang.String" parameterType="java.util.HashMap">
		select VEHICLEASSEMBLE_NO from (
	  	  select VEHICLEASSEMBLE_NO from TFR.T_OPT_VEHICLEASSEMBLEBILL
	  		where ORIG_ORG_CODE = #{oriOrgCode}
	  		  and (
	  		  <foreach collection="destOrgCodeList" item="item" separator="or">
					DEST_ORG_CODE = #{item,jdbcType=VARCHAR}
				</foreach>
	  		  )
   		<![CDATA[  and LEAVE_TIME >= #{leaveStartTime} and LEAVE_TIME < #{leaveEndTime} ]]>
	        order by CREATE_TIME DESC) a where ROWNUM = 1
  	</select>
  	
  	<select id="queryVehicleAssemblyBillByWaybillNo" resultMap="VehicleAssembleBillResultMap" parameterType="String">
  		select  
			vb.id id,
		     vb.TRUCKDEPARTPLANDETAIL_ID truckDepartPlanDetailId,
		     vb.assemble_type assembleType,
		     vb.ORIG_ORG_NAME origOrgName,
		     vb.ORIG_ORG_CODE origOrgCode,
		     vb.dest_org_name destOrgName,
		     vb.dest_org_code destOrgCode,
		     vb.leave_time leaveTime,
		     vb.create_time createDate,
		     vb.state state,
		     vb.vehicleassemble_no vehicleAssembleNo,
		     vb.vehicle_no vehicleNo,
		     vb.driver_name driverName,
		     vb.driver_code driverCode,
		     vb.vehicle_ownership vehicleOwnerShip,
		     vb.frequency_no frequencyNo,
		     vb.transport_type transProperty,
		     vb.driver_mobile_phone driverMobilePhone,
		     vb.run_hours runHours,
		     vb.rated_load ratedLoad,
		     vb.vehicle_model vehicleModel,
		     vb.examine_volume examineVolume,
		     vb.rated_clearance ratedClearance,
		     vb.loading_rate loadingRate,
		     vb.create_user_name createUser,
		     vb.modify_user_name modifyUser,
		     vb.goods_type goodsType,
		     vb.be_midwayload beMidwayLoad,
		     vb.befinallyarrive beFinallyArrive,
		     vb.vehicle_message vehicleMessage,
		     vb.notes note,
		     vb.payment_type paymentType,
			vb.fee_total/100 feeTotal,
			vb.prepaid_fee_total/100 prePaidFeeTotal,
			vb.arrive_fee_total/100 arriveFeeTotal,
			vb.container_no containerNo,
			vb.be_return_receipt beReturnReceipt,
			vb.BE_CREATE_TASKTRUCK beCreateTaskTruck,
			vb.INVITE_NO inviteNo,
			vb.TOTAL_FEE_CHANGE_NOTES feeTotalChangeNotes 
		from tfr.t_opt_vehicleassemblebill vb
		left join tfr.t_opt_vehicleassemble_detail vd on vd.vehicleassemblebill_id=vb.id
		left join tfr.t_opt_handoverbill  hb on hb.handover_no=vd.handover_no and hb.handoverbill_state!=90
		left join tfr.t_opt_handoverbill_detail hd on hd.handover_no=hb.handover_no
		
		<where>
			vb.state!=90
			and hd.waybill_no=#{waybillNo}
		</where>
		 
  	</select>
  	
  	<!-- 查询配载单信息 -->
	<select id="queryVehicleAssembleBillInfoByBillNo" resultMap="VehicleAssembleBillResultMap" parameterType="String">
		<![CDATA[
		    select
		    	max(vab.id) id, 
			    max(vab.vehicleassemble_no) vehicleAssembleNo,
			    max(vab.state) state,
			    max(vab.fee_total/100) feeTotal,
			    max(vab.assemble_type) assembleType,
			    max(vab.orig_org_name) origOrgName,
			    max(vab.orig_org_code) origOrgCode,
			    max(vab.dest_org_name) destOrgName,
			    max(vab.vehicle_ownership) vehicleOwnerShip,
			    max(vehicleTaskDetail.Actual_Depart_Time) departTime,
			    max(vab.vehicle_no) vehicleNo,
			    max(vab.examine_volume) examineVolume,
			    max(vab.loading_rate) loadingRate,
			    max(vab.create_time) createDate,
			    max(vab.create_user_name) createUserName,
			    max(vab.driver_name) driverName,
			    max(vab.modify_user_name) modifyUserName,
			    max(vab.modify_time) modifyDate,
			    max(vab.rated_clearance) ratedClearance,
      			max(vab.rated_load) ratedLoad,
      			max(vab.notes)   note,
      			max(vab.driver_mobile_phone) driverMobilePhone,
      			max(vehicleTaskDetail.PLAN_ARRIVE_TIME) planArriveTime,
      			max(vab.line) line,
      			sum(h.GOODS_QTY_TOTAL) goodsQtyTotal,
      			sum(h.WAYBILL_QTY_TOTAL) waybillQtyTotal,
      			sum(h.WEIGHT_TOTAL) weightTotal,
      			sum(h.VOLUME_TOTAL) volumeTotal,
			    sum(h.AF_GOODS_QTY) waybillQtyAF,
				sum(h.AF_GOODS_VOLUME) goodsVolumeAF,
				sum(h.AF_GOODS_WEIGHT) goodsWeightAF,
				sum(h.FLF_GOODS_QTY) waybillQtyFLF,
				sum(h.FLF_GOODS_VOLUME) goodsVolumeFLF,
				sum(h.FLF_GOODS_WEIGHT) goodsWeightFLF,
				sum(h.FSF_GOODS_QTY) waybillQtyFSF,
				sum(h.FSF_GOODS_VOLUME) goodsVolumeFSF,
				sum(h.FSF_GOODS_WEIGHT) goodsWeightFSF,
				SUM(h.bgflf_goods_qty) waybillQtyBGFLF,
        		SUM(h.bgflf_goods_volume) goodsVolumeBGFLF,
        		SUM(h.bgflf_goods_weight) goodsWeightBGFLF,
        		SUM(h.bgfsf_goods_qty) waybillQtyBGFSF, 
        		SUM(h.bgfsf_goods_volume) goodsVolumeBGFSF,
        		SUM(h.bgfsf_goods_weight) goodsWeightBGFSF
		      from tfr.t_opt_vehicleassemblebill  vab
		     left join tfr.t_opt_TRUCK_TASK_BILL vehicleTaskBill
		         on vehicleTaskBill.Bill_No = vab.vehicleassemble_no 
		     left join tfr.t_opt_TRUCK_TASK_DETAIL vehicleTaskDetail
		         on vehicleTaskBill.Truck_Task_Detail_Id = vehicleTaskDetail.Id
		     left join tfr.t_opt_vehicleassemble_detail vd on vab.id = vd.vehicleassemblebill_id
		     left join tfr.t_opt_handoverbill h on vd.handover_no = h.handover_no
		]]>
		<where>
			<!-- 出发部门或者到达部门是本部门 -->
			 vab.state != 90 
			and vab.vehicleassemble_no= #{vehicleAssembillNo,jdbcType=VARCHAR}
		</where>
	</select>
	
	<!-- 新增配载单时，批量插入奖罚信息 -->
	<insert id="saveVehicleRewardProt" parameterType="java.util.List">
		begin
		<foreach collection="list" item="item" separator=";">
			insert into tfr.T_Opt_RewardPunish_Agreement(
			  id ,
			  vehicleAssemble_No ,
			  rewardOrPunish_type  ,
			  timelimit ,
			  Agreement_money ,
			  rewardOrPunish_maxMoney ,
			  create_user_name ,
			  create_user_code ,
			  create_time  ,
			  modify_user_name ,
			  modify_user_code ,
			  modify_time 
			)values(
				#{item.id,jdbcType=VARCHAR},
				#{item.vehicleAssemBillNo,jdbcType=VARCHAR },
				#{item.rewardOrPunishType ,jdbcType=VARCHAR},
				#{item.timeLimit ,jdbcType=VARCHAR},
				#{item.agreementMoney ,jdbcType=DECIMAL}*100,
				#{item.rewardOrPunishMaxMoney ,jdbcType=DECIMAL}*100,
				#{item.createUserName ,jdbcType=VARCHAR},
				#{item.creatorUserCode ,jdbcType=VARCHAR},
				#{item.createTime ,jdbcType=TIMESTAMP},
				#{item.modifyUserName ,jdbcType=VARCHAR},
				#{item.modifyUserCode ,jdbcType=VARCHAR},
				#{item.modifyTime ,jdbcType=TIMESTAMP}
			)
		</foreach>
		;end;
	</insert>
	<!-- 查询奖罚信息 -->
	<select id="queryRewardOrPunishDetail" resultMap="queryRewardOrPunishDetailByVehicleAssembleNo" parameterType="String">
		<![CDATA[
			select  
			rp.id id,
			rp.vehicleassemble_no vehicleAssemBillNo,
			rp.rewardorpunish_type rewardOrPunishType,
			rp.timelimit timeLimit,
			rp.agreement_money/100 agreementMoney,
			rp.rewardorpunish_maxmoney/100 rewardOrPunishMaxMoney
			from tfr.t_opt_rewardpunish_agreement  rp 
		]]>
		<where>
			 rp.vehicleassemble_no=#{vehicleAssembleNo}
		</where>
	</select>
	<!-- 删除奖罚信息 -->
	<delete id="deletReWardOrPunishAgreement" parameterType="String">
		delete from tfr.t_Opt_Rewardpunish_Agreement rp where rp.vehicleassemble_no=#{vehicleAssembleNo} 
	</delete>
	<!-- 更新装载率 -->
	<update id="updateVehAssemForMakeUpWaybill" parameterType="java.util.HashMap" >
		update tfr.t_opt_vehicleassemblebill vb set
		 vb.loading_rate = #{loadingRate,jdbcType=VARCHAR} 
		 <where> vb.vehicleassemble_no=#{vehicleAssembleNo,jdbcType=VARCHAR} </where> 
	</update>
	
		
	<!--根据交接单号查询交接单中运单的运输性质-->
	<select id="queryProductTypeByHandoverNo" parameterType="String" resultType="String">
		select 	product_code from(
		select w.product_code product_code,
				row_number() over(partition by h.handover_no  order by w.waybill_no) rn
			from tfr.t_opt_handoverbill_detail h 
			left join pkp.t_srv_waybill w 
			on h.waybill_no = w.waybill_no and w.active='Y'
			where h.handover_no = #{handoverNo,jdbcType=VARCHAR}
			)
			where rn = 1
		
	</select>
	
	
	<select id="queryMidleUnloadVehicleAssemByVehicleNo" parameterType="String" resultType="String">
		select  vb.vehicleassemble_no
		  from tfr.t_Opt_Vehicleassemblebill vb
		 where vb.vehicle_no = #{vehicleNo,jdbcType=VARCHAR}
		   and vb.state = 10
		   and vb.be_midway_onlyload = 'Y'
		   and rownum =1
		
	</select>

	
	<select id="leasedVehicleDepartureTimes" parameterType="HashMap" resultType="Long">
		   select count(1) from tfr.t_opt_vehicleassemblebill vb 
		   where vb.vehicle_ownership='Leased' and vb.state!=90 
		   and vb.create_time<![CDATA[ >=]]>#{startDate}   
		   and vb.create_time<![CDATA[ <=]]>#{endDate}
	</select>
	<!--查询一个车辆任务下有运费的配载单  -->
	<select id="queryTruckBillByDetailId" parameterType="java.util.HashMap" resultType="String">
		select tb.bill_no from tfr.t_Opt_Truck_Task_Bill  tb
		inner join tfr.t_Opt_Vehicleassemblebill vb on vb.vehicleassemble_no=tb.bill_no
		where 
		vb.fee_total>0 
		and vb.state !=90 and vb.state != 30
		and  tb.truck_task_detail_id =#{truckTaskDetailId,jdbcType=VARCHAR}
		<if test="billNo!=null and billNo!=''">
			and  tb.bill_no!=#{billNo,jdbcType=VARCHAR}
		</if>
	</select>
	<!-- 根据运单号   查询配载单数 -->
    <select id="queryIsVehicleassembleByNo" parameterType="String" resultType="Long" >
	 select count(*) from tfr.t_opt_handoverbill hb ,
		tfr.t_opt_handoverbill_detail d
		where hb.handover_no=d.handover_no 
		and hb.handoverbill_state !=90
		and d.waybill_no =#{waybillNo,jdbcType=VARCHAR}
	</select>
	
	<!--查询一个车辆任务下有运费的配载单  -->
	<select id="queryTruckBillByDetailIdAndBillNo" parameterType="java.util.HashMap" resultType="String">
		select tb.bill_no from tfr.t_Opt_Truck_Task_Bill  tb
		inner join tfr.t_Opt_Vehicleassemblebill vb on vb.vehicleassemble_no=tb.bill_no
		where 
		vb.fee_total>0 
		and vb.state !=90 and vb.state != 30
		and  tb.truck_task_detail_id =#{truckTaskDetailId,jdbcType=VARCHAR}
		<if test="billNo!=null and billNo!=''">
			and  tb.bill_no!=#{billNo,jdbcType=VARCHAR}
		</if>
		union all
		select tb.bill_no
		  from tfr.t_Opt_Truck_Task_Bill tb
		  join tfr.t_wk_trf_bill vb
		    on vb.handoverbillno = tb.bill_no
		 where vb.totalfee > 0
		   and vb.handoverstate not in ('HAVE_ARRIVE', 'HAVE_CANCEL')
		   and tb.truck_task_detail_id = #{truckTaskDetailId,jdbcType=VARCHAR}
	</select>
	
	<!-- 根据jiaojiedan号获取配载单基本信息 -->
	<select id="queryWkHandoverBillByNo" resultMap="VehicleAssembleBillResultMap"
	parameterType="String">
		<![CDATA[
		select 
			v.departorgname origOrgName,
			v.arriveorgname destOrgName,
    		v.TRUCKLOADSTATUS assembleType
			from TFR.t_wk_trf_bill v 
		]]>
		<where>
				v.HANDOVERBILLNO = #{vehicleAssembleNo} 
				and v.handoverstate != 'HAVE_CANCEL' 
		</where>
	</select>
</mapper>