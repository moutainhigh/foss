<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
	"-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="foss.scheduling.temprentalMark">
	<!-- 租车标记数据查询的map-->
	<resultMap id="queryRentalMarkEntityMap"
		type="com.deppon.foss.module.transfer.scheduling.api.shared.domain.RentalMarkEntity">
		<result property="billNo" column="billNo"/><!--单号-->
		<result property="billType" column="billType" /><!--单据类型-->
		<result property="vehicleNo" column="vehicleNo" /><!--车牌号-->
		<result property="inviteVehicleNo" column="inviteVehicleNo" /><!--约车编号-->
		<result property="driverCode" column="driverCode" /><!--司机编码-->
		<result property="driverName" column="driverName" /><!--司机姓名-->
		<result property="origOrgCode" column="origOrgCode" /><!--出发部门编码-->
		<result property="origOrgName" column="origOrgName" /><!--出发部门名称-->
		<result property="destOrgCode" column="destOrgCode" /><!--到达部门编码-->
		<result property="destOrgName" column="destOrgName" /><!--到达部门名称-->
		<result property="weight" column="weight" /><!--重量-->
		<result property="volume" column="volume" /><!--体积-->
		<result property="billCreateTime" column="billCreateTime" /><!--单据生成时间-->
		<result property="rentalNum" column="rentalNum" /> <!--租车编号-->
		<result property="rentalUse" column="rentalUse" /> <!--租车用途-->
		<result property="createDate" column="createDate" /> <!--租车标记时间-->
		<result property="markDeptName" column="markDeptName" /> <!--租车标记部门-->
		<result property="markDeptCode" column="markDeptCode" /> <!--租车标记部门-->
		<result property="markOperator" column="markOperator" /> <!--租车标记操作人-->
		<result property="rentalAmount" column='rentalAmount'/><!--租车金额  -->
		<result property="consultPriceNo" column="consultPriceNo"/><!--询价编号-->
		<result property="driver_mobile_phone" column="driver_mobile_phone"/><!--司机电话-->
		<result property="rentalAmount" column="rentalAmount"/><!--约车金额*100-->
		
		<!--<result property="goodsName" column="goodsName" />货物名称-->
		<!--<result property="packing" column="packing" />包装-->
		<!--<result property="isDoorDeliver" column="isDoorDeliver" />是否上门接货-->
		<!--<result property="customerName" column="customerName" />发货客户名称-->
		<!--<result property="sendAddress" column="sendAddress" />发货地址-->
		<!--<result property="destination" column="destination" />目的站-->
		<!--<result property="pickUpWay" column="pickUpWay" />提货方式-->
		<!--<result property="receiptContacts" column="receiptContacts" />收货联系人-->
		<!--<result property="receiptAddress" column="receiptAddress" />收货地址-->
	</resultMap>
	<resultMap id="BaseResultMap"
		type="com.deppon.foss.module.transfer.scheduling.api.shared.domain.RentalMarkEntity">
		<result column="BILLNO" property="billNo" jdbcType="VARCHAR" /><!-- 单号 -->
		<result column="BILLTYPE" property="billType" jdbcType="VARCHAR" /><!-- 单据类型 -->
		<result column="VEHICLENO" property="vehicleNo" jdbcType="VARCHAR" /><!-- 车牌号 -->
		<result column="DRIVER" property="driverName" jdbcType="VARCHAR" /><!-- 司机姓名 -->
		<result column="DEPARTURENAME" property="origOrgName" jdbcType="VARCHAR" /><!-- 出发部门 -->
		<result column="ARRIVEORG" property="destOrgName" jdbcType="VARCHAR" /><!-- 到达部门 -->
		<result column="WEIGHT" property="weight" jdbcType="NUMERIC" /><!-- 重量 -->
		<result column="VOLUME" property="volume" jdbcType="NUMERIC" /><!-- 体积 -->
		<result column="GOODSNAME" property="goodsName" jdbcType="VARCHAR" /><!-- 货物品名 -->
		<result column="GOODSPACKAGE" property="packing" jdbcType="VARCHAR" /><!-- 包装 -->
		<result column="PICKUPTODOOR" property="isDoorDeliver" jdbcType="VARCHAR" /><!-- 是否上门接货 -->
		<result column="DELIVERYCUSTOMERNAME" property="customerName" jdbcType="VARCHAR" /><!-- 发货客户名称 -->
		<result column="DELIVERYCUSTOMERADDRESS" property="sendAddress" jdbcType="VARCHAR" /><!-- 发货地址 -->
		<result column="TARGETORGCODE" property="destination" jdbcType="VARCHAR" /><!-- 目的站 -->
		<result column="RECEIVEMETHOD" property="pickUpWay" jdbcType="VARCHAR" /><!-- 提货方式 -->
		<result column="RECEIVECUSTOMERCONTACT" property="receiptContacts" jdbcType="VARCHAR" /><!-- 收货联系人 -->
		<result column="RECEIVECUSTOMERADDRESS" property="receiptAddress" jdbcType="VARCHAR" /><!-- 收货地址 -->
		<result column="BILLGENERATETIME" property="billCreateTime" jdbcType="TIMESTAMP" /><!-- 单据生成时间 -->
		<result column="TEMPRENTALMARKNO" property="rentalNum" jdbcType="VARCHAR" /><!-- 租车编号 -->
		<result column="RENTALUSETYPE" property="rentalUse" jdbcType="VARCHAR" /><!-- 租车用途 -->
		<result column="MARKDEPARTNAME" property="markDeptName" jdbcType="VARCHAR" /><!-- 租车标记部门 -->
		<result column="MARKOPERATER" property="markOperator" jdbcType="VARCHAR" /><!-- 租车标记操作人 -->
		<result column="MARKOPERATETIME" property="createDate" jdbcType="TIMESTAMP" /><!-- 租车标记时间 -->
		<result column="RECEIVEMETHODNAME" property="pickUpWayName" jdbcType="VARCHAR" /><!-- 提货方式描述 -->
		<result column="INVITEVEHICLENO" property="inviteVehicleNo" jdbcType="VARCHAR" /><!-- 租车编号 -->
		<result column="RENTAL_AMOUNT" property="rentalAmount" jdbcType="DECIMAL" /><!-- 租车金额 -->
		<result column="consultPriceNo" property="consultPriceNo" jdbcType="VARCHAR"/><!--询价编号-->
	</resultMap>
	
	<!-- author:106162 date:2017-04-20 根据租车编码查询租车标记实体 -->
	<resultMap id="rentalTempMarkEntityResultMap"
		type="com.deppon.foss.module.transfer.scheduling.api.shared.vo.RentalTempMarkEntity">
		<result column="feesDeptCode" property="feesDeptCode" jdbcType="VARCHAR" /><!-- 费用承担部门 -->
		<result column="rentalAmount" property="rentalAmount" jdbcType="VARCHAR" /><!-- 租车金额 -->
		<result column="temprentalMarkNo" property="temprentalMarkNo" jdbcType="VARCHAR" /><!-- 租车编码 -->
		<result column="inviteVehicleno" property="inviteVehicleno" jdbcType="VARCHAR" /><!-- 约车编号 -->
		<result column="useCarDate" property="useCarDate" jdbcType="VARCHAR" /><!-- 租车用车时间 -->
	</resultMap>
	
	
	<!-- 按单号查询  -->
	<sql id="Base_Column_List_WayBills">
		W.WAYBILL_NO BILLNO,
		'waybill' BILLTYPE,
		W.RECEIVE_ORG_NAME DEPARTURENAME,
		W.CUSTOMER_PICKUP_ORG_NAME ARRIVEORG,
		W.GOODS_WEIGHT_TOTAL WEIGHT,
		W.GOODS_VOLUME_TOTAL VOLUME,
		W.GOODS_NAME GOODSNAME,
		W.GOODS_PACKAGE GOODSPACKAGE,
		W.PICKUP_TO_DOOR PICKUPTODOOR,
		W.DELIVERY_CUSTOMER_NAME DELIVERYCUSTOMERNAME,
		W.DELIVERY_CUSTOMER_ADDRESS DELIVERYCUSTOMERADDRESS,
		W.TARGET_ORG_CODE TARGETORGCODE,
		W.RECEIVE_METHOD RECEIVEMETHOD,
		W.RECEIVE_CUSTOMER_CONTACT RECEIVECUSTOMERCONTACT,
		W.RECEIVE_CUSTOMER_ADDRESS RECEIVECUSTOMERADDRESS,
		tt.VEHICLE_NO VEHICLENO,
		W.CREATE_TIME BILLGENERATETIME,
		tt.temprental_mark_no  rentalNum,
        tt.rental_car_usetype rentalUse,
        tt.create_date createDate,
        tt.mark_depart_name markDeptName,
        tt.mark_depart_code markDeptCode,
        tt.create_user_name  markOperator, 
        tt.invite_vehicleno  inviteVehicleNo,
        tt.rental_amount/100   rentalAmount,
        tm.consult_price_no consultPriceNo
	</sql>
	<!--派送单信息  -->
	<sql id="Base_Column_List_By_DeliverBill">
		D.DELIVERBILL_NO BILLNO,
		'deliverbill' BILLTYPE,
		D.VEHICLE_NO VEHICLENO,
		D.DRIVER_NAME DRIVER,
		D.OPERATE_ORG_NAME DEPARTURENAME,
		'' ARRIVEORG,
		D.WEIGHT_TOTAL WEIGHT,
		D.VOLUME_TOTAL VOLUME,
		'' GOODSNAME,
		'' GOODSPACKAGE,
		'' PICKUPTODOOR,
		'' DELIVERYCUSTOMERNAME,
		'' DELIVERYCUSTOMERADDRESS,
		'' TARGETORGCODE, 
		'' RECEIVEMETHOD,
		'' RECEIVECUSTOMERCONTACT,
		'' RECEIVECUSTOMERADDRESS,
		D.SUBMIT_TIME BILLGENERATETIME,
		'' RECEIVEMETHODNAME,
		tt.temprental_mark_no  rentalNum,
        tt.rental_car_usetype rentalUse,
        tt.create_date createDate,
        tt.mark_depart_name markDeptName,
        tt.mark_depart_code markDeptCode,
        tt.create_user_name  markOperator, 
        tt.invite_vehicleno  inviteVehicleNo,
        tt.rental_amount/100   rentalAmount,
        tm.consult_price_no consultPriceNo
	</sql>
	<sql id="Base_Column_List_By_WayBill">
		W.WAYBILL_NO BILLNO,
		'waybill' BILLTYPE,
		W.RECEIVE_ORG_NAME DEPARTURENAME,
		W.CUSTOMER_PICKUP_ORG_NAME ARRIVEORG,
		W.GOODS_WEIGHT_TOTAL WEIGHT,
		W.GOODS_VOLUME_TOTAL VOLUME,
		W.GOODS_NAME GOODSNAME,
		W.GOODS_PACKAGE GOODSPACKAGE,
		W.PICKUP_TO_DOOR PICKUPTODOOR,
		W.DELIVERY_CUSTOMER_NAME DELIVERYCUSTOMERNAME,
		W.DELIVERY_CUSTOMER_ADDRESS DELIVERYCUSTOMERADDRESS,
		W.TARGET_ORG_CODE TARGETORGCODE,
		W.RECEIVE_METHOD RECEIVEMETHOD,
		W.RECEIVE_CUSTOMER_CONTACT RECEIVECUSTOMERCONTACT,
		W.RECEIVE_CUSTOMER_ADDRESS RECEIVECUSTOMERADDRESS,
		W.CREATE_TIME BILLGENERATETIME
	</sql>
	<!-- where begin -->
	<!-- type 1：营业部 2：驻地营业部 3：车队 4:上级部门为车队 -->
	<!-- 营业部/驻地营业部：按时间段查询运单 -->
	<sql id="query_selectByWayBill_condition_date_1_2">
		<where>
			W.ACTIVE = 'Y' AND W.IS_WHOLE_VEHICLE = 'N' AND 
			(W.IS_ECS IS NULL OR W.IS_ECS = 'N') AND
			<!-- startTime -->
			<if test="startTime != null">
				<![CDATA[W.bill_time >= #{startTime,jdbcType=TIMESTAMP} AND ]]>
			</if>
			<!-- endTime -->
			<if test="endTime != null">
				<![CDATA[W.bill_time <= #{endTime,jdbcType=TIMESTAMP} AND ]]>
			</if>
			<!-- 开单部门 -->
		     <if test="createOrgCode != null">
		        W.RECEIVE_ORG_CODE = #{createOrgCode,jdbcType=VARCHAR} AND
		     </if>
			<![CDATA[
					((W.RECEIVE_ORG_CODE = #{currentOrg,jdbcType=VARCHAR} AND 
							 W.GOODS_NAME <> '待补录') 
			 		 OR  
			 		 (W.CUSTOMER_PICKUP_ORG_CODE = #{currentOrg,jdbcType=VARCHAR} 
			 		 AND
			 			exists  (SELECT 1 FROM TFR.T_OPT_IN_STOCK OPT
				         		WHERE OPT.WAYBILL_NO = W.WAYBILL_NO 
				         		AND OPT.IS_VALID = 'Y'
				         		AND OPT.ORG_CODE=W.CUSTOMER_PICKUP_ORG_CODE
				         		AND OPT.in_stock_time >= #{startTime,jdbcType=TIMESTAMP}
			                )
						AND
					    not exists (SELECT 1 FROM PKP.T_SRV_DELIVERBILL D, PKP.T_SRV_DELIVERBILL_DETAIL DT/*已做过派送单（该派送单未被作废）的运单无法查出*/
					             WHERE D.ID = DT.T_SRV_DELIVERBILL_ID
					               AND D.STATUS <> 'CANCELED'
					               AND DT.WAYBILL_NO = W.WAYBILL_NO)
					 )
			        ) 
	        ]]>
		</where>
	</sql>
	
	
	<!-- 车队：按时间段查运单 -->
	<sql id="query_selectByWayBill_condition_date_3_4">
		<where>
			W.ACTIVE = 'Y' AND W.IS_WHOLE_VEHICLE = 'N' AND 
			(W.IS_ECS IS NULL OR W.IS_ECS = 'N')
			<!-- startTime -->
			<if test="startTime != null">
				<![CDATA[W.bill_time >= #{startTime,jdbcType=TIMESTAMP} AND ]]>
			</if>
			<!-- endTime -->
			<if test="endTime != null">
				<![CDATA[W.bill_time <= #{endTime,jdbcType=TIMESTAMP} AND ]]>
			</if>
			<!-- 开单部门 -->
		     <if test="createOrgCode != null">
		        W.RECEIVE_ORG_CODE = #{createOrgCode,jdbcType=VARCHAR} AND
		      </if>
			<if test="orgs != null and orgs.size() > 0">
				((W.RECEIVE_ORG_CODE IN
				<foreach collection="orgs" open="(" close=")" separator=","	item="org">
					#{org,jdbcType=VARCHAR}
				</foreach>
				<![CDATA[AND (W.GOODS_NAME <> '待补录')) ]]>
			</if>
			<if test="orgs != null and orgs.size() > 0">
				OR (W.CUSTOMER_PICKUP_ORG_CODE IN
				<foreach collection="orgs" open="(" close=")" separator=","	item="org">
					#{org,jdbcType=VARCHAR}
				</foreach>
				<![CDATA[
			        AND
			 		exists (SELECT 1 FROM TFR.T_OPT_IN_STOCK OPT
			         		WHERE OPT.WAYBILL_NO = W.WAYBILL_NO 
			         		AND OPT.IS_VALID = 'Y'
							AND OPT.ORG_CODE = W.CUSTOMER_PICKUP_ORG_CODE
							AND OPT.in_stock_time >= #{startTime,jdbcType=TIMESTAMP}
			        		) 
					AND
					not exists (SELECT 1
					              FROM PKP.T_SRV_DELIVERBILL D, PKP.T_SRV_DELIVERBILL_DETAIL DT/* 已做过派送单（该派送单未被作废）的运单无法查出 */
					             WHERE D.ID = DT.T_SRV_DELIVERBILL_ID
					               AND D.STATUS <> 'CANCELED'
					               AND DT.WAYBILL_NO = W.WAYBILL_NO)
				
				))
				]]>
			</if>
			
		</where>
	</sql>
	
	<!-- type 1：营业部 2：驻地营业部 3：车队 4:上级部门为车队 -->
	<!-- 营业部/驻地营业部：按运单号查询运单 -->
	<sql id="query_selectByWayBill_condition_wayBill_1_2">
		<where>
			W.ACTIVE = 'Y' AND W.IS_WHOLE_VEHICLE = 'N'  AND  (W.is_ecs is null or W.is_ecs = 'N') AND 
			<if test="billList != null and billList.size()>0">
				W.WAYBILL_NO IN
				<foreach collection="billList" open="(" close=")" separator=","	item="waybillId">
					#{waybillId,jdbcType=VARCHAR}
				</foreach>
				AND
			</if>
			<![CDATA[
					((W.RECEIVE_ORG_CODE = #{currentOrg,jdbcType=VARCHAR} AND (W.GOODS_NAME <> '待补录')) 
			 		 OR  
			 		 (W.CUSTOMER_PICKUP_ORG_CODE = #{currentOrg,jdbcType=VARCHAR} AND
			 		 exists (SELECT 1 FROM TFR.T_OPT_IN_STOCK OPT
			         		WHERE OPT.WAYBILL_NO = W.WAYBILL_NO 
			         		AND OPT.IS_VALID = 'Y' 
			         		AND OPT.ORG_CODE=W.CUSTOMER_PICKUP_ORG_CODE
			         		AND OPT.in_stock_time >= W.bill_time
			         		)
					 AND  
					 not exists (SELECT 1 FROM PKP.T_SRV_DELIVERBILL D, PKP.T_SRV_DELIVERBILL_DETAIL DT/* 已做过派送单（该派送单未被作废）的运单无法查出 */
					             WHERE D.ID = DT.T_SRV_DELIVERBILL_ID
					               AND D.STATUS <> 'CANCELED'
					               AND DT.WAYBILL_NO = W.WAYBILL_NO
					               )			  
					)
			       ) 
	        	]]>
		</where>
	</sql>
	
	<!-- 车队/外场：按运单号查询运单 -->
	<sql id="query_selectByWayBill_condition_wayBill_3_4">
		<where>
			W.ACTIVE = 'Y' AND W.IS_WHOLE_VEHICLE = 'N' AND  (W.is_ecs is null or W.is_ecs = 'N') AND 
			<if test="billList != null and billList.size()>0">
				W.WAYBILL_NO IN
				<foreach collection="billList" open="(" close=")" separator=","	item="waybillId">
					#{waybillId,jdbcType=VARCHAR}
				</foreach>
				AND
			</if>
			<if test="orgs != null and orgs.size() > 0">
				((W.RECEIVE_ORG_CODE IN
				<foreach collection="orgs" open="(" close=")" separator=","	item="org">
					#{org,jdbcType=VARCHAR}
				</foreach>
				<![CDATA[AND (W.GOODS_NAME <> '待补录')) ]]>
			</if>
			<if test="orgs != null and orgs.size() > 0">
				OR (W.CUSTOMER_PICKUP_ORG_CODE IN
				<foreach collection="orgs" open="(" close=")" separator=","	item="org">
					#{org,jdbcType=VARCHAR}
				</foreach>
				<![CDATA[
			        AND
			 		exists (SELECT 1 FROM TFR.T_OPT_IN_STOCK OPT
			         		WHERE OPT.WAYBILL_NO = W.WAYBILL_NO 
			         		AND OPT.IS_VALID = 'Y'
							AND OPT.ORG_CODE = W.CUSTOMER_PICKUP_ORG_CODE
							AND OPT.in_stock_time >= w.bill_time
			        		) 
					AND
					not exists (SELECT 1
					              FROM PKP.T_SRV_DELIVERBILL D, PKP.T_SRV_DELIVERBILL_DETAIL DT/* 已做过派送单（该派送单未被作废）的运单无法查出 */
					               WHERE D.ID = DT.T_SRV_DELIVERBILL_ID
					               AND D.STATUS <> 'CANCELED'
					               AND DT.WAYBILL_NO = W.WAYBILL_NO
					               )
				))
				]]>
			</if>
		</where>
	</sql>
	
	<!-- 营业部或驻地营业部：按时间段查询派送单 -->
	<sql id="query_selectByDeliverBill_condition_date_1_2">
		<where>
			(D.STATUS = 'CONFIRMED' OR D.STATUS = 'SIGNINFO_CONFIRMED') 
			<!-- startTime -->
			<if test="startTime != null">
				<![CDATA[ AND D.OPERATE_TIME >= #{startTime,jdbcType=TIMESTAMP}]]>
			</if>
			<!-- endTime -->
			<if test="endTime != null">
				<![CDATA[ AND D.OPERATE_TIME <= #{endTime,jdbcType=TIMESTAMP}]]>
			</if>
			<!-- vehicleNo -->
			<if test="vehicleNo != null">
				 AND D.VEHICLE_NO = #{vehicleNo,jdbcType=VARCHAR}
			</if>
			<!-- 租车编号 -->
			<if test="TemprentalMarkNo != null">
				 AND tt.TEMPRENTAL_MARK_NO = #{TemprentalMarkNo,jdbcType=VARCHAR}
			</if>
			<!-- 创建部门-->
			<if test="createOrgCode != null">
				 AND D.CREATE_ORG_CODE = #{createOrgCode,jdbcType=VARCHAR}
			</if>
			<![CDATA[
				 AND (D.CREATE_ORG_CODE = #{currentOrg,jdbcType=VARCHAR} OR D.OPERATE_ORG_CODE = #{currentOrg,jdbcType=VARCHAR})
			]]>
		</where>
	</sql>
	
		<!-- 车队：按时间段查派送单 -->
	<sql id="query_selectByDeliverBill_condition_date_3_4">
		<where>
			(D.STATUS = 'CONFIRMED' OR D.STATUS = 'SIGNINFO_CONFIRMED') 
			<!-- startTime -->
			<if test="startTime != null">
				<![CDATA[AND D.OPERATE_TIME >= #{startTime,jdbcType=TIMESTAMP}]]>
			</if>
			<!-- endTime -->
			<if test="endTime != null">
				<![CDATA[AND D.OPERATE_TIME <= #{endTime,jdbcType=TIMESTAMP} ]]>
			</if>
			<!-- vehicleNo -->
			<if test="vehicleNo != null">
				 AND D.VEHICLE_NO = #{vehicleNo,jdbcType=VARCHAR} 
			</if>
			<!-- 租车编号 -->
			<if test="TemprentalMarkNo != null">
				 AND tt.TEMPRENTAL_MARK_NO = #{TemprentalMarkNo,jdbcType=VARCHAR}
			</if>
			<!-- 创建部门-->
			<if test="createOrgCode != null">
				 AND D.CREATE_ORG_CODE = #{createOrgCode,jdbcType=VARCHAR}
			</if>

			<if test="orgs != null and orgs.size() > 0">
				 AND D.CREATE_ORG_CODE IN
				<foreach collection="orgs" open="(" close=")" separator="," item="org">
					#{org,jdbcType=VARCHAR}
				</foreach>
			</if>
		</where>
	</sql>
	<!-- 营业部或驻地营业部：按派送单号查询派送单 -->
	<sql id="query_selectByDeliverBill_condition_billnos_1_2">
		<where>
			(D.STATUS = 'CONFIRMED' OR D.STATUS = 'SIGNINFO_CONFIRMED') AND 
			<if test="billList != null and billList.size()>0">
				<![CDATA[ D.DELIVERBILL_NO IN ]]>
				<foreach collection="billList" open="(" close=")" separator=","	item="deliverBillId">
					#{deliverBillId,jdbcType=VARCHAR}
				</foreach>
				AND
			</if>
			<![CDATA[
				(D.CREATE_ORG_CODE = #{currentOrg,jdbcType=VARCHAR} OR D.OPERATE_ORG_CODE = #{currentOrg,jdbcType=VARCHAR})
			]]>
		</where>
	</sql>

	<!-- 车队/外场：按派送单号查询派送单 -->
	<sql id="query_selectByDeliverBill_condition_billnos_3_4">
		<where>
			(D.STATUS = 'CONFIRMED' OR D.STATUS = 'SIGNINFO_CONFIRMED') 
			<if test="billList != null and billList.size()>0">
				<![CDATA[AND D.DELIVERBILL_NO IN ]]>
				<foreach collection="billList" open="(" close=")" separator=","	item="deliverBillId">
					#{deliverBillId,jdbcType=VARCHAR}
				</foreach>
			</if>

			<if test="orgs != null and orgs.size() > 0">
				AND D.CREATE_ORG_CODE IN
				<foreach collection="orgs" open="(" close=")" separator=","	item="org">
					#{org,jdbcType=VARCHAR}
				</foreach>
			</if>
		</where>
	</sql>
	
	<!--按快递运单号查询运单 -->
	<sql id="query_selectByExpressBill_condition_billnos1_2_3_4">
	<where>
			W.ACTIVE = 'Y' AND W.IS_WHOLE_VEHICLE = 'N' AND 
			<if test="billList != null and billList.size()>0">
				W.WAYBILL_NO IN
				<foreach collection="billList" open="(" close=")" separator=","	item="waybillId">
					#{waybillId,jdbcType=VARCHAR}
				</foreach>
				AND
			</if>
			<![CDATA[
					(((W.GOODS_NAME <> '待补录')) 
			 		 AND  
			 		 ((20>(sysdate-(w.bill_time+0))))/*距离开单日期20天之内的运单可查询到运单信息（开单日期大于20天的运单不可查询到运单信息）*/
			         AND
			 		 (
			 		exists (SELECT count(0) FROM TFR.T_OPT_IN_STOCK OPT
			         		WHERE OPT.WAYBILL_NO = W.WAYBILL_NO 
			         		AND OPT.IS_VALID = 'Y' 
			         		AND OPT.in_stock_time >= w.bill_time
			         		)
					 AND exists (SELECT 1 FROM PKP.T_SRV_ARRIVESHEET ARR/* 派送拉回的运单可以查出 */
					             WHERE ARR.STATUS = 'REFUSE'
					               AND ARR.ACTIVE = 'Y'
					               AND ARR.DESTROYED = 'N'
					               AND ARR.WAYBILL_NO = W.WAYBILL_NO) 
					 AND exists (SELECT 1 FROM PKP.T_SRV_DELIVERBILL D, PKP.T_SRV_DELIVERBILL_DETAIL DT/* 未被作废的运单可以查出 */
					             WHERE D.ID = DT.T_SRV_DELIVERBILL_ID
					               AND D.STATUS = 'CANCELED'
					               AND DT.WAYBILL_NO = W.WAYBILL_NO)			  
					)
			       ) 
	        	]]>
		</where>
	</sql>
	
	<!-- 租车标记数据查询的sql，按日期查询-->
	<select id="queryRentalMarkEntityListByDate" resultMap="queryRentalMarkEntityMap" 
		parameterType="com.deppon.foss.module.transfer.scheduling.api.shared.dto.RentalMarkDto">
		      select  
				hb.handover_no billNo,
				'handoverbill' billType,
				 nvl(tt.vehicle_no,hb.vehicle_no) vehicleNo,
				hb.driver_code driverCode,
				hb.driver_name driverName,
				hb.orig_org_code origOrgCode,
				hb.orig_org_name origOrgName,
				hb.dest_org_code destOrgCode,
				hb.dest_org_name destOrgName,
				hb.weight_total weight,
				hb.volume_total volume,
				hb.create_time billCreateTime,
                  tt.temprental_mark_no  rentalNum,
                  tt.rental_car_usetype rentalUse,
                  tt.create_date createDate,
                  tt.mark_depart_name markDeptName,
                  tt.mark_depart_code markDeptCode,
                  tt.create_user_name  markOperator, 
                  tt.invite_vehicleno  inviteVehicleNo,
                  tt.rental_amount/100   rentalAmount,
                  tm.consult_price_no consultPriceNo
			from tfr.t_opt_handoverbill hb 
			inner join bse.t_bas_leased_truck lt on lt.vehicle_no=hb.vehicle_no and lt.active='Y'
			left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
			on  tm.bill_no = hb.handover_no
			<if test="billGenerationBeginTime!=null and billGenerationBeginTime!='' ">
			  	and tm.bill_create_date<![CDATA[>=]]> #{billGenerationBeginTime}
			</if>
			<if test="billGenerationEndTime!=null and billGenerationEndTime!='' ">
			  	and tm.bill_create_date<![CDATA[<=]]> #{billGenerationEndTime}
			</if>
			left join TFR.T_OPT_TEMPRENTALMARK tt 
			on tt.temprental_mark_no=tm.temprental_mark_no 
				and tt.id=tm.temprentalmark_id 
				and tt.active='Y'
			<where>
				hb.handoverbill_state != 90
				and hb.handoverbill_state != 10
				and hb.handoverbill_state != 21
				and( (hb.handover_type='SHORT_DISTANCE_HANDOVER')
				or (hb.handover_type='PARTIALLINE_HANDOVER' and hb.ISAGENCYVISIT!='Y')
				or (hb.handover_type='LDP_HANDOVER' and hb.ISAGENCYVISIT!='Y')
				or hb.handover_type='DIVISION_HANDOVER'
				)
				 and hb.BE_CAR_LOAD='N'
				<if test="vehicleNo!=null and vehicleNo!='' ">
			  			and hb.vehicle_no = #{vehicleNo}
				</if>
				
				<if test="borrowNo!=null and borrowNo!='' ">
			  			and tt.temprental_mark_no = #{borrowNo}
				</if>
				
				<if test="billGenerationBeginTime!=null and billGenerationBeginTime!='' ">
			  			and hb.create_time<![CDATA[>=]]> #{billGenerationBeginTime}
				</if>
				
				<if test="billGenerationEndTime!=null and billGenerationEndTime!='' ">
			  			and hb.create_time<![CDATA[<=]]> #{billGenerationEndTime}
				</if>
				
				<if test="orgCode!=null and orgCode!='' and  departmentSignle=='SalesDepartment'"><!--营业部-->
					
					and hb.orig_org_code=#{orgCode}
				</if>
				<if test="orgCode!=null and orgCode!='' and  departmentSignle=='SalesDepartmentStation'"><!--派送部驻地营业部-->
					
					and hb.orig_org_code=#{orgCode}
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferCenter' and orgCodeList!=null">
					
					and (
					(hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
					or hb.orig_org_code in 
					<foreach collection="orgCodeList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
					)
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferCenter' and orgCodeList==null">					
					and (hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferChild' and orgCodeList!=null">
					
					and (
					(hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
					or hb.orig_org_code in 
					<foreach collection="orgCodeList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
					)
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferChild' and orgCodeList==null">					
					and (hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
				</if>
				<if test="departmentSignle=='Profdepartment' and orgCodeList!=null">
					and hb.orig_org_code in 
					<foreach collection="orgCodeList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
				</if>
				
				<if test="createDept != null and createDept != '' ">
			  			and hb.orig_org_code = #{createDept ,jdbcType=VARCHAR}
				</if>
				
			</where>
			
	</select>
	<!-- 租车标记数据数量量查询的sql，按日期查询-->
	<select id="queryRentalMarkEntityCountByDate" resultType="Long" 
		parameterType="com.deppon.foss.module.transfer.scheduling.api.shared.dto.RentalMarkDto">
		      select  
				count(hb.id)
				from tfr.t_opt_handoverbill hb 
				inner join bse.t_bas_leased_truck lt on lt.vehicle_no=hb.vehicle_no and lt.active='Y'
				left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
				on  tm.bill_no = hb.handover_no
			<if test="billGenerationBeginTime!=null and billGenerationBeginTime!='' ">
			  	and tm.bill_create_date<![CDATA[>=]]> #{billGenerationBeginTime}
			</if>
			<if test="billGenerationEndTime!=null and billGenerationEndTime!='' ">
			  	and tm.bill_create_date<![CDATA[<=]]> #{billGenerationEndTime}
			</if>
				left join TFR.T_OPT_TEMPRENTALMARK tt 
				on tt.temprental_mark_no=tm.temprental_mark_no 
				and tt.id=tm.temprentalmark_id 
				and tt.active='Y'
			<where>
				hb.handoverbill_state != 90
				and hb.handoverbill_state != 10
				and hb.handoverbill_state != 21
				and( (hb.handover_type='SHORT_DISTANCE_HANDOVER')
				or (hb.handover_type='PARTIALLINE_HANDOVER' and hb.ISAGENCYVISIT!='Y')
				or (hb.handover_type='LDP_HANDOVER' and hb.ISAGENCYVISIT!='Y')
				or hb.handover_type='DIVISION_HANDOVER'
				)
				 and hb.BE_CAR_LOAD='N' 
				<if test="vehicleNo != null and vehicleNo != '' ">
			  			and hb.vehicle_no = #{vehicleNo}
				</if>
				
				<if test="borrowNo!=null and borrowNo!='' ">
			  			and tt.temprental_mark_no = #{borrowNo}
				</if>
				<if test="billGenerationBeginTime != null and billGenerationBeginTime != '' ">
			  			and hb.create_time<![CDATA[>=]]> #{billGenerationBeginTime}
				</if>
				
				<if test="billGenerationEndTime != null and billGenerationEndTime != '' ">
			  			and hb.create_time<![CDATA[<=]]> #{billGenerationEndTime}
				</if>
				
				
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='SalesDepartment'">
					
					and hb.orig_org_code=#{orgCode}
				</if>
				<if test="orgCode!=null and orgCode!='' and  departmentSignle=='SalesDepartmentStation'"><!--营业部-->
					
					and hb.orig_org_code=#{orgCode}
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferCenter' and orgCodeList!=null">
					
					and (
					(hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
					or hb.orig_org_code in 
					<foreach collection="orgCodeList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
					)
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferCenter' and orgCodeList==null">					
					and (hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferChild' and orgCodeList!=null">
					
					and (
					(hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
					or hb.orig_org_code in 
					<foreach collection="orgCodeList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
					)
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferChild' and orgCodeList==null">					
					and (hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
				</if>
				<if test="departmentSignle=='Profdepartment' and orgCodeList!=null">
					and hb.orig_org_code in 
					<foreach collection="orgCodeList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
				</if>
				
				<if test="createDept != null and createDept != '' ">
			  			and hb.orig_org_code = #{createDept ,jdbcType=VARCHAR}
				</if>
			</where>
	</select>
	
	<!-- 租车标记数据查询的sql，按单号查询-->
	<select id="queryRentalMarkEntityListByBillNo" resultMap="queryRentalMarkEntityMap" 
		parameterType="com.deppon.foss.module.transfer.scheduling.api.shared.dto.RentalMarkDto">
		      
  select  
				hb.handover_no billNo,
				'handoverbill' billType,
				 nvl(tt.vehicle_no,hb.vehicle_no) vehicleNo,
				hb.driver_code driverCode,
				hb.driver_name driverName,
				hb.orig_org_code origOrgCode,
				hb.orig_org_name origOrgName,
				hb.dest_org_code destOrgCode,
				hb.dest_org_name destOrgName,
				hb.weight_total weight,
				hb.volume_total volume,
				hb.create_time billCreateTime,
                  tt.temprental_mark_no  rentalNum,
                  tt.rental_car_usetype rentalUse,
                  tt.create_date createDate,
                  tt.mark_depart_name markDeptName,
                  tt.mark_depart_code markDeptCode,
                  tt.create_user_name  markOperator, 
                  tt.invite_vehicleno  inviteVehicleNo,
                  tt.rental_amount/100   rentalAmount,
                  tm.consult_price_no consultPriceNo
                  
				from tfr.t_opt_handoverbill hb 
				inner join bse.t_bas_leased_truck lt on lt.vehicle_no=hb.vehicle_no and lt.active='Y'
				left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
				on  tm.bill_no = hb.handover_no
				left join TFR.T_OPT_TEMPRENTALMARK tt 
				on tt.temprental_mark_no=tm.temprental_mark_no 
				and tt.id=tm.temprentalmark_id 
				and tt.active='Y'
			<where>
				hb.handoverbill_state != 90
				and hb.handoverbill_state != 10
				and hb.handoverbill_state != 21
				and( (hb.handover_type='SHORT_DISTANCE_HANDOVER')
				or (hb.handover_type='PARTIALLINE_HANDOVER' and hb.ISAGENCYVISIT!='Y')
				or (hb.handover_type='LDP_HANDOVER' and hb.ISAGENCYVISIT!='Y')
				or hb.handover_type='DIVISION_HANDOVER'
				)
				 and hb.BE_CAR_LOAD='N'
				
				<if test="handoverBillNoList!=null">
					and hb.handover_no in 
					<foreach collection="handoverBillNoList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
				</if>
				
				<if test="orgCode!=null and orgCode!='' and  departmentSignle=='SalesDepartment'">
					
					and hb.orig_org_code=#{orgCode}
				</if>
				<if test="orgCode!=null and orgCode!='' and  departmentSignle=='SalesDepartmentStation'"><!--营业部-->
					
					and hb.orig_org_code=#{orgCode}
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferCenter' and orgCodeList!=null">
					
					and (
					(hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
					or hb.orig_org_code in 
					<foreach collection="orgCodeList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
					)
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferCenter' and orgCodeList==null">					
					and (hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferChild' and orgCodeList!=null">
					
					and (
					(hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
					or hb.orig_org_code in 
					<foreach collection="orgCodeList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
					)
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferChild' and orgCodeList==null">					
					and (hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
				</if>
				<if test="departmentSignle=='Profdepartment' and orgCodeList!=null">
					and hb.orig_org_code in 
					<foreach collection="orgCodeList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
				</if>
				</where>
	</select>
	
	<!-- 租车标记数据数量查询的sql，按单号查询-->
	<select id="queryRentalMarkEntityCountByBillNo" resultType="Long" 
		parameterType="com.deppon.foss.module.transfer.scheduling.api.shared.dto.RentalMarkDto">
		      
		      select  
				count(hb.id)
				from tfr.t_opt_handoverbill hb 
				inner join bse.t_bas_leased_truck lt 
				on lt.vehicle_no=hb.vehicle_no and lt.active='Y'
				left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
				on  tm.bill_no = hb.handover_no
				left join TFR.T_OPT_TEMPRENTALMARK tt 
				on tt.temprental_mark_no=tm.temprental_mark_no 
				and tt.id=tm.temprentalmark_id 
				and tt.active='Y'
			<where>
				hb.handoverbill_state != 90
				and hb.handoverbill_state != 10
				and hb.handoverbill_state != 21
				and( (hb.handover_type='SHORT_DISTANCE_HANDOVER')
				or (hb.handover_type='PARTIALLINE_HANDOVER' and hb.ISAGENCYVISIT!='Y')
				or (hb.handover_type='LDP_HANDOVER' and hb.ISAGENCYVISIT!='Y')
				or hb.handover_type='DIVISION_HANDOVER'
				)
				 and hb.BE_CAR_LOAD='N'
				<if test="handoverBillNoList!=null">
					and hb.handover_no in 
					<foreach collection="handoverBillNoList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
				</if>
				
				<if test="orgCode!=null and orgCode!='' and  departmentSignle=='SalesDepartment'">
					
					and hb.orig_org_code=#{orgCode}
				</if>
				<if test="orgCode!=null and orgCode!='' and  departmentSignle=='SalesDepartmentStation'"><!--营业部-->
					
					and hb.orig_org_code=#{orgCode}
				</if>
				
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferCenter' and orgCodeList!=null">
					
					and (
					(hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
					or hb.orig_org_code in 
					<foreach collection="orgCodeList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
					)
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferCenter' and orgCodeList==null">					
					and (hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferChild' and orgCodeList!=null">
					
					and (
					(hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
					or hb.orig_org_code in 
					<foreach collection="orgCodeList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
					)
				</if>
				<if test="orgCode !=null and orgCode!='' and  departmentSignle=='TransferChild' and orgCodeList==null">					
					and (hb.orig_org_code=#{orgCode} or hb.dest_org_code=#{orgCode})
				</if>
				<if test="departmentSignle=='Profdepartment' and orgCodeList!=null">
					and hb.orig_org_code in 
					<foreach collection="orgCodeList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
				</if>
			</where>
	</select>
	
	<!-- 租车标记配载单数据查询的sql，按单号查询-->
	<select id="queryStowageBillListByBillNo" resultMap="queryRentalMarkEntityMap"
	parameterType="com.deppon.foss.module.transfer.scheduling.api.shared.dto.RentalMarkDto">
	    select  
			tvb.vehicleassemble_no billNo,
	        'stowagebill' billType,
	        nvl(tt.vehicle_no,tvb.vehicle_no) vehicleNo,
	        tvb.driver_code driverCode,
	        tvb.driver_name driverName,
	        tvb.orig_org_code origOrgCode,
	        tvb.orig_org_name origOrgName,
	        tvb.dest_org_code destOrgCode,
	        tvb.dest_org_name destOrgName,
	        tvb.rated_load weight,
	        tvb.examine_volume volume,
	        tvb.create_time billCreateTime,
                  tt.temprental_mark_no  rentalNum,
                  tt.rental_car_usetype rentalUse,
                  tt.create_date createDate,
                  tt.mark_depart_name markDeptName,
                  tt.mark_depart_code markDeptCode,
                  tt.create_user_name  markOperator, 
                  tt.invite_vehicleno  inviteVehicleNo,
                  tt.rental_amount/100   rentalAmount,
                  tm.consult_price_no consultPriceNo

        from tfr.t_opt_vehicleassemblebill tvb 
       	inner join bse.t_bas_leased_truck lt on lt.vehicle_no=tvb.vehicle_no and lt.active='Y'
        left join tfr.t_opt_motorstowagebillrecord tom on tom.vehicleassemble_no=tvb.vehicleassemble_no and tom.print_type='CARRIAGECONTRACT'
        left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  on  tm.bill_no =  tvb.vehicleassemble_no
		left join TFR.T_OPT_TEMPRENTALMARK tt 
		   on tt.temprental_mark_no=tm.temprental_mark_no 
			and tt.id=tm.temprentalmark_id 
			and tt.active='Y'
	       <where>
		        tvb.state != 90
		        and tom.id is null
		        and tvb.assemble_type='OWNER_LINE'
		        and tvb.fee_total='0'
		        <if test="stowageBillNoList">
					and tvb.vehicleassemble_no in 
					<foreach collection="stowageBillNoList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
				</if>
		        <if test="orgCode !=null and orgCode!='' " >
		        	 and (tvb.orig_org_code=#{orgCode} or tvb.dest_org_code=#{orgCode})
		        </if>
		        
	   	</where>
	</select>
	<!-- 租车标记配载单数据查询的sql，按日期-->
	<select id="queryStowageBillListByDate" resultMap="queryRentalMarkEntityMap" 
	parameterType="com.deppon.foss.module.transfer.scheduling.api.shared.dto.RentalMarkDto">
	    select  
			tvb.vehicleassemble_no billNo,
	        'stowagebill' billType,
	        nvl(tt.vehicle_no,tvb.vehicle_no) vehicleNo,
	        tvb.driver_code driverCode,
	        tvb.driver_name driverName,
	        tvb.orig_org_code origOrgCode,
	        tvb.orig_org_name origOrgName,
	        tvb.dest_org_code destOrgCode,
	        tvb.dest_org_name destOrgName,
	        tvb.rated_load weight,
	        tvb.examine_volume volume,
	        tvb.create_time billCreateTime,
            tt.temprental_mark_no  rentalNum,
            tt.rental_car_usetype rentalUse,
            tt.create_date createDate,
            tt.mark_depart_name markDeptName,
            tt.mark_depart_code markDeptCode,
            tt.create_user_name  markOperator, 
            tt.invite_vehicleno  inviteVehicleNo,
            tt.rental_amount/100   rentalAmount,
            tm.consult_price_no consultPriceNo
        from tfr.t_opt_vehicleassemblebill tvb 
       	inner join bse.t_bas_leased_truck lt on lt.vehicle_no=tvb.vehicle_no and lt.active='Y'
        left join tfr.t_opt_motorstowagebillrecord tom on tom.vehicleassemble_no=tvb.vehicleassemble_no and tom.print_type='CARRIAGECONTRACT'

        left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  on  tm.bill_no =  tvb.vehicleassemble_no
		 <if test="billGenerationBeginTime!=null and billGenerationBeginTime!='' ">
			  	and tm.bill_create_date<![CDATA[>=]]> #{billGenerationBeginTime}
		</if>
		<if test="billGenerationEndTime!=null and billGenerationEndTime!='' ">
			  	and tm.bill_create_date<![CDATA[<=]]> #{billGenerationEndTime}
		</if>
		left join TFR.T_OPT_TEMPRENTALMARK tt 
		   on tt.temprental_mark_no=tm.temprental_mark_no 
			and tt.id=tm.temprentalmark_id 
			and tt.active='Y'
	       <where>
		        tvb.state != 90
		        and tom.id is null
		        and tvb.assemble_type='OWNER_LINE'
		        and tvb.fee_total='0'
		        <if test="vehicleNo != null and vehicleNo != '' ">
			  			and tvb.vehicle_no = #{vehicleNo}
				</if>
				
				<if test="borrowNo!=null and borrowNo!='' ">
			  			and tt.temprental_mark_no = #{borrowNo}
				</if>
				<if test="billGenerationBeginTime != null and billGenerationBeginTime != '' ">
			  			and tvb.create_time<![CDATA[>=]]> #{billGenerationBeginTime}
				</if>
				
				<if test="billGenerationEndTime != null and billGenerationEndTime != '' ">
			  			and tvb.create_time<![CDATA[<=]]> #{billGenerationEndTime}
				</if>
		        <if test="orgCode !=null and orgCode!='' " >
		        	 and (tvb.orig_org_code=#{orgCode} or tvb.dest_org_code=#{orgCode})
		        </if>
		        
		        <if test="createDept !=null and createDept!='' " >
		        	 and tvb.orig_org_code=#{createDept,jdbcType=VARCHAR}
		        </if>
	   	</where>
	</select>
	
	<!-- 租车标记配载单数据数量查询的sql，按单号查询-->
	<select id="queryStowageBillCountByBillNo" resultType="Long" 
	parameterType="com.deppon.foss.module.transfer.scheduling.api.shared.dto.RentalMarkDto">
	    select  
			count(tvb.id)
	        from tfr.t_opt_vehicleassemblebill tvb 
	       	inner join bse.t_bas_leased_truck lt on lt.vehicle_no=tvb.vehicle_no and lt.active='Y'
	        left join tfr.t_opt_motorstowagebillrecord tom 
	        on tom.vehicleassemble_no=tvb.vehicleassemble_no and tom.print_type='CARRIAGECONTRACT'
	        left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  	on  tm.bill_no =  tvb.vehicleassemble_no
			left join TFR.T_OPT_TEMPRENTALMARK tt 
		  	 on tt.temprental_mark_no=tm.temprental_mark_no 
			 and tt.id=tm.temprentalmark_id 
			 and tt.active='Y'
	       <where>
		        tvb.state != 90
		        and tom.id is null
		        and tvb.assemble_type='OWNER_LINE'
		       and tvb.fee_total='0'
		        <if test="stowageBillNoList">
					and tvb.vehicleassemble_no in 
					<foreach collection="stowageBillNoList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
				</if>
		        <if test="orgCode !=null and orgCode!='' " >
		        	 and (tvb.orig_org_code=#{orgCode} or tvb.dest_org_code=#{orgCode})
		        </if>
		        
		        
	   	</where>
	</select>
	
	<!-- 租车标记配载单数据数量查询的sql，按日期-->
	<select id="queryStowageBillCountByDate" resultType="Long" 
	parameterType="com.deppon.foss.module.transfer.scheduling.api.shared.dto.RentalMarkDto">
	    select  
			count(tvb.id)
	        from tfr.t_opt_vehicleassemblebill tvb 
	       	inner join bse.t_bas_leased_truck lt on lt.vehicle_no=tvb.vehicle_no and lt.active='Y'
	        left join tfr.t_opt_motorstowagebillrecord tom 
	        on tom.vehicleassemble_no=tvb.vehicleassemble_no and tom.print_type='CARRIAGECONTRACT'
	        left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  	 on  tm.bill_no =  tvb.vehicleassemble_no
		  <if test="billGenerationBeginTime!=null and billGenerationBeginTime!='' ">
			  	and tm.bill_create_date<![CDATA[>=]]> #{billGenerationBeginTime}
		</if>
		<if test="billGenerationEndTime!=null and billGenerationEndTime!='' ">
			  	and tm.bill_create_date<![CDATA[<=]]> #{billGenerationEndTime}
		</if>
			left join TFR.T_OPT_TEMPRENTALMARK tt 
		  	 on tt.temprental_mark_no=tm.temprental_mark_no 
			 and tt.id=tm.temprentalmark_id 
			 and tt.active='Y'
	       <where>
		        tvb.state != 90
		        and tom.id is null
		        and tvb.assemble_type='OWNER_LINE'
		        and tvb.fee_total='0'
		        <if test="vehicleNo != null and vehicleNo != '' ">
			  			and tvb.vehicle_no = #{vehicleNo}
				</if>
				
				<if test="borrowNo!=null and borrowNo!='' ">
			  			and tt.temprental_mark_no = #{borrowNo}
				</if>
				<if test="billGenerationBeginTime != null and billGenerationBeginTime != '' ">
			  			and tvb.create_time<![CDATA[>=]]> #{billGenerationBeginTime}
				</if>
				
				<if test="billGenerationEndTime != null and billGenerationEndTime != '' ">
			  			and tvb.create_time<![CDATA[<=]]> #{billGenerationEndTime}
				</if>
		        
		        <if test="orgCode !=null and orgCode!='' " >
		        	 and (tvb.orig_org_code=#{orgCode} or tvb.dest_org_code=#{orgCode})
		        </if>	 
		        
		         <if test="createDept !=null and createDept!='' " >
		        	 and tvb.orig_org_code=#{createDept,jdbcType=VARCHAR}
		        </if>
		           
	   	</where>
	</select>
	
	
	<!-- 约车编号数据查询的map-->
	<resultMap id="queryInviteVehicleNoMap"
		type="com.deppon.foss.module.transfer.scheduling.api.shared.vo.RentalMarkVo">
		<result property="inviteVehicleNo" column="inviteVehicleNo"/><!--约车编号-->
		<result property="inviteState" column="inviteState"/><!--约车状态-->
		<result property="acceptPerson" column="acceptPerson" /><!--约车受理人-->
		<result property="acceptPersonCode" column="acceptPersonCode" /><!--约车受理编号-->
	    <result property="rentalAmount" column="rentalAmount" /><!--租车金额-->
	</resultMap>
	<!-- 约车编号数据查询的sql1-->
	<select id="queryInviteVehicleNo1" resultMap="queryInviteVehicleNoMap" 
		parameterType="String">
				
			select 
				ov.order_no inviteVehicleNo,
				oa.status inviteState,
				oa.audit_emp_code acceptPersonCode, 
				oa.audit_emp_name acceptPerson
				  from tfr.t_Opt_Order_Vehicle ov
				 inner join tfr.t_opt_audit_order_apply oa
				    on oa.order_no = ov.order_no
			<where> 
				 oa.status=ov.status
				 AND oa.order_no=#{inviteVehicleNo}
			</where>
	</select>
	<!-- 约车编号数据查询的sql2-->
	<select id="queryInviteVehicleNo2" resultMap="queryInviteVehicleNoMap" 
		parameterType="String">
			select 
				iv.invite_no inviteVehicleNo,
				ia.status inviteState,
				iv.apply_fees rentalAmount,
				ia.audit_emp_code acceptPersonCode, 
				ia.audit_emp_name acceptPerson
				  from tfr.t_opt_invite_vehicle iv
				 	INNER JOIN tfr.t_opt_audit_invite_apply ia
				    ON ia.invite_no=iv.invite_no
			<where> 
					 ia.status=iv.status
				   AND iv.invite_no=#{inviteVehicleNo}
			</where>
	</select>
	<!--交接单和派送单号的list共用一个handoverBillNoList-->
	<!-- 判断小票单号是否可见数据查询，派送单号单号-->
	<select id="smallTicketValidateDeliverBill" resultType="Long" 
		parameterType="com.deppon.foss.module.transfer.scheduling.api.shared.dto.RentalMarkDto">
		      
		     select count(1) 
	     		from pkp.t_srv_deliverbill_detail dd
				inner join pkp.t_srv_deliverbill db on dd.t_srv_deliverbill_id=db.id
				inner join pkp.t_srv_waybill wb on wb.waybill_no=dd.waybill_no
			<where>
				wb.active='Y'
				and db.status!='CANCELED'
				and wb.receive_method  in ('SELF_PICKUP','AIRPORT_PICKUP','SELF_PICKUP_AIR','INNER_PICKUP','SELF_PICKUP_FREE_AIR')
				and wb.pickup_to_door='N'
				and db.deliverbill_no in
					<foreach collection="handoverBillNoList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
			</where>
	</select>
	
	<resultMap id="smallTicketEntityMap"
		type="com.deppon.foss.module.transfer.scheduling.api.shared.domain.SmallTicketEntity">
		<result property="smallTicketNum" column="smallTicketNum"/><!--小票单号-->
		<result property="wayBillNo" column="wayBillNo" /><!--运单号-->
	</resultMap>
	<!--检查小票单号的合法性-->
	<select id="querysmallTicketNum" resultMap="smallTicketEntityMap" 
		parameterType="com.deppon.foss.module.transfer.scheduling.api.shared.dto.RentalMarkDto">
		     select 
		     		r.other_revenue_no smallTicketNum,
					r.wayBill_no  wayBillNo
                    from stl.t_stl_other_revenue r
			<where>
				r.active='Y'
				<if test="rentalUse=='SH'">
					and r.income_categories='PD'
				</if>
				
				<if test="rentalUse=='JH'">
					and r.income_categories='F'
				</if>
				
				<if test="rentalUse=='JSH'">
					and (r.income_categories='PD' or r.income_categories='F')
					
				</if>
					and r.other_revenue_no in 
					<foreach collection="smallTicketList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
			</where>
	</select>
	
	<!--查询正确的小票  -->
	
	<select id="querySmallTicketForWayBill" resultMap="smallTicketEntityMap" 
		parameterType="Map">
		     select 
		     		r.other_revenue_no smallTicketNum,
					r.wayBill_no  wayBillNo
                    from stl.t_stl_other_revenue r
			<where>
				r.active='Y'
				<if test="rentalUse=='SH'">
					and r.income_categories='PD'
				</if>
				
				<if test="rentalUse=='JH'">
					and r.income_categories='F'
				</if>
				
				<if test="rentalUse=='JSH'">
					and (r.income_categories='PD' or r.income_categories='F')
					
				</if>
					and r.wayBill_no=#{wayBillNo}
					and not exists (select * from TFR.T_OPT_TEMPRENTALMARK_SMTICKS ts
					    inner join TFR.T_OPT_TEMPRENTALMARK  tt on tt.id=ts.temprentalmark_id
					    where tt.active='Y' 
					    and r.other_revenue_no=ts.small_tick_num)
				 	and rownum=1
				 	order by r.create_time
			</where>
	</select>
	<!--检查小票单号是否已经被标记-->
	<resultMap id="smallTicketReMap"
		type="java.lang.String">
		<result property="smallTicketNum" column="smallTicketNum"/><!--小票单号-->
	</resultMap>
	<select id="querySmallTicketRe" resultMap="smallTicketReMap" 
		parameterType="java.util.List">
		     select 
		     		ts.small_tick_num smallTicketNum
				  	from TFR.T_OPT_TEMPRENTALMARK_SMTICKS ts
				  	inner join TFR.T_OPT_TEMPRENTALMARK tt on tt.id=ts.TEMPRENTALMARK_ID and tt.TEMPRENTAL_MARK_NO=ts.TEMPRENTAL_MARK_NO
			<where>
					tt.active='Y'
					 and ts.small_tick_num in 
					<foreach collection="list" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
			</where>
	</select>
	
	
	<!--派送单或交接单查询租车表记录判断是否多次标记-->
	<select id="queryHandOverBillRepeatMark" resultType="Long" 
		parameterType="java.util.List">
		     select count(1)
        		from TFR.T_OPT_TEMPRENTALMARK_DETAIL td
        		inner join TFR.T_OPT_TEMPRENTALMARK tt on tt.temprental_mark_no=td.temprental_mark_no and tt.active='Y'
			<where>
			
				td.bill_no in 
					<foreach collection="list" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
				
			</where>
	</select>
	<!--派送单或交接单查询租车表记录判断是否多次标记-->
	<select id="queryWayBillRepeatMark" resultType="Long" 
		parameterType="com.deppon.foss.module.transfer.scheduling.api.shared.dto.RentalMarkDto">
		     select count(1)
        		from TFR.T_OPT_TEMPRENTALMARK_DETAIL td
        		inner join TFR.T_OPT_TEMPRENTALMARK tt on tt.temprental_mark_no=td.temprental_mark_no and tt.active='Y'
			<where>
			
				td.mark_depart_code=#{orgCode}
				and td.bill_no in 
					<foreach collection="wayBillNoList" item="item" separator="," close=")" open="(">
                    	#{item}
					</foreach>
				
			</where>
	</select>
	<!--查询交接单和派送单对应的运单号-->
	<resultMap id="wayBillNoMap"
		type="String">
		<result property="wayBillNo" column="wayBillNo" /><!--运单号-->
	</resultMap>
	<!--查询交接单的运单号-->
	<select id="queryWayBillNoForHandoverBillNo" resultMap="wayBillNoMap">
		
			select 
				hd.waybill_no wayBillNo
	  			from tfr.t_opt_handoverbill_detail hd
  		<where>
  			hd.handover_no in 
			<foreach collection="list" item="item" separator="," close=")" open="(">
	                	#{item}
			</foreach>
  		</where>
	</select>
	<!--查询派送单的运单  -->
	<select id="queryWayBillForDeliverBill"  parameterType="java.util.List"  resultType="Long">
		
			select 
				count(1)
				from pkp.t_srv_deliverbill_detail dd 
				inner join pkp.t_srv_deliverbill d on d.id=dd.t_srv_deliverbill_id
				inner join pkp.t_srv_waybill wb on wb.waybill_no=dd.waybill_no
				
  		<where>
  		        wb.active='Y'
  		        and d.status!='CANCELED'
  			    and d.deliverbill_no in 
			<foreach collection="list" item="item" separator="," close=")" open="(">
	                	#{item,jdbcType=VARCHAR}
			</foreach>
  		</where>
	</select>
	<!--查询派送单的运单号,需要做小票的-->
	<select id="queryWayBillNoForDeliverBillNo" resultMap="wayBillNoMap">
		
			select 
				dd.waybill_no wayBillNo
				from pkp.t_srv_deliverbill_detail dd 
				inner join pkp.t_srv_deliverbill d on d.id=dd.t_srv_deliverbill_id
				inner join pkp.t_srv_waybill wb on wb.waybill_no=dd.waybill_no
				
  		<where>
  		        wb.active='Y'
				and d.status!='CANCELED'
				and wb.receive_method  in ('SELF_PICKUP','AIRPORT_PICKUP','SELF_PICKUP_AIR','INNER_PICKUP','SELF_PICKUP_FREE_AIR')
  			    and d.deliverbill_no in 
			<foreach collection="list" item="item" separator="," close=")" open="(">
	                	#{item,jdbcType=VARCHAR}
			</foreach>
  		</where>
	</select>
	
	<!--插入租车标记数据-->
	<insert id="addTempRentalMarkEntityList" parameterType="java.util.List">
		begin
		<foreach collection="list" item="item" separator=";" >
		insert into 
			tfr.t_opt_tempRentalMark(
				Id,TEMPRENTAL_MARK_NO,RENTAL_CAR_USETYPE,USECAR_DATE,USERCAR_REASON,
				INVITE_VEHICLENO,ACCEPT_PERSON,ACCEPT_PERSON_CODE,SMALL_TICKET_NUM,rental_amount,KMS_NUM,
				DEPARTURE_NAME,DEPARTURE_CODE,DESTINATION_NAME,DESTINATION_CODE,NOTES,MARK_DEPART_NAME,
				MARK_DEPART_CODE,CREATE_USER_NAME,CREATE_USER_CODE,CREATE_DATE,MODIFY_USER_NAME,MODIFY_USER_CODE,
				MODIFY_DATE,ACTIVE,WEIGHT_TOTAL,VOLUME_TOTAL,ACTUAL_TAKEGOODS_QYT,VEHICLE_NO,VEHICLE_LENGHT_CODE,
				SELF_VOLUME,DRIVER_CODE,DRIVER_NAME,DRIVER_POHE,ISREPEATEMARK,SALESVEHICLE_PLATFORM_NAME，USE_VEHICLEPLATFORM,
				BWAR_FEES_DEPT,BWAR_FEES_DEPT_CODE
				)
		values
		
			(
			#{item.id jdbcType=VARCHAR},#{item.tempRentalMarkNO jdbcType=VARCHAR},#{item.rentalCarUsetype jdbcType=VARCHAR},
			#{item.useCarDate jdbcType=TIMESTAMP},#{item.userCarReason jdbcType=VARCHAR},#{item.inviteVehicleNo jdbcType=VARCHAR},
			#{item.acceptPerson jdbcType=VARCHAR},#{item.acceptPersonCode jdbcType=VARCHAR},#{item.smallTicketNum jdbcType=VARCHAR},
			#{item.rentalAmount jdbcType=NUMERIC},#{item.kmsNum jdbcType=NUMERIC},#{item.departureName jdbcType=VARCHAR},
			#{item.departureCode jdbcType=VARCHAR},#{item.destinationName jdbcType=VARCHAR},#{item.destinationCode jdbcType=VARCHAR},
			#{item.notes jdbcType=VARCHAR},#{item.markDepartName jdbcType=VARCHAR},#{item.markDepartCode jdbcType=VARCHAR},
			#{item.createUserName jdbcType=VARCHAR},#{item.createUserCode jdbcType=VARCHAR},#{item.createDate jdbcType=TIMESTAMP},
			#{item.modifyUserNme jdbcType=VARCHAR},#{item.modifyUserCode jdbcType=VARCHAR},#{item.modifyDate jdbcType=TIMESTAMP},
			#{item.active jdbcType=VARCHAR},#{item.weigthTotal jdbcType=NUMERIC},#{item.volumeTotal jdbcType=NUMERIC},
			#{item.actualTakeGoodsQyt jdbcType=VARCHAR},#{item.vehicleNo jdbcType=VARCHAR},#{item.vehicleLenghtCode jdbcType=VARCHAR},
			#{item.selfVolume jdbcType=NUMERIC},#{item.driverCode jdbcType=VARCHAR},#{item.driverName jdbcType=VARCHAR},#{item.driverPhone jdbcType=VARCHAR},
			#{item.isRepeateMark jdbcType=VARCHAR},#{item.salesVehiclePlatformName jdbcType=VARCHAR},#{item.useVehiclePlatform jdbcType=VARCHAR},
			#{item.bearFeesDept jdbcType=VARCHAR},#{item.bearFeesDeptCode jdbcType=VARCHAR})
		</foreach>
		;end;
	</insert>
	
	<!--插入租车标记明细数据-->
	<insert id="addTempRentalMarkDetailEntityList" parameterType="java.util.List">
		begin
		<foreach collection="list" item="item" separator=";" >
		insert into 
			TFR.T_OPT_TEMPRENTALMARK_DETAIL(
				Id,TEMPRENTALMARK_ID,TEMPRENTAL_MARK_NO,BILL_NO,BILL_TYPE,
				WEIGHT,VOLUME,CREATE_USER_NAME,CREATE_USER_CODE,CREATE_DATE,
				RENTAL_CAR_USETYPE,MARK_DEPART_NAME,MARK_DEPART_CODE,BILL_CREATE_DATE,CONSULT_PRICE_NO
				)
		values
		
			(
			#{item.id jdbcType=VARCHAR},#{item.tempRentalMarkId jdbcType=VARCHAR},#{item.tempRentalMarkNo jdbcType=VARCHAR},
			#{item.billNo jdbcType=VARCHAR},#{item.billType jdbcType=VARCHAR},#{item.weight jdbcType=NUMERIC},
			#{item.volume jdbcType=NUMERIC},#{item.createUserName jdbcType=VARCHAR},#{item.createUserCode jdbcType=VARCHAR},
			#{item.createDate jdbcType=TIMESTAMP},#{item.rentalCarUserType jdbcType=VARCHAR},
			#{item.markDepartName jdbcType=VARCHAR},#{item.markDepartCode jdbcType=VARCHAR},
			#{item.billCreateDate jdbcType=TIMESTAMP},#{item.consultPriceNo jdbcType=VARCHAR}
			)
		</foreach>
		;end;
	</insert>
	
	<!--插入租车标记小票单号数据-->
	<insert id="addTemprentalMarkSmticksEntityList" parameterType="java.util.List">
		begin
		<foreach collection="list" item="item" separator=";" >
		insert into 
			TFR.T_OPT_TEMPRENTALMARK_SMTICKS(
				Id,TEMPRENTALMARK_ID,TEMPRENTAL_MARK_NO,SMALL_TICK_NUM,WAYBILL_NO,CREATE_USER_NAME,
				CREATE_USER_CODE,CREATE_DATE,ACTIVE
				)
		values
		
			(
			#{item.id jdbcType=VARCHAR},#{item.tempRentalMarkId jdbcType=VARCHAR},#{item.tempRentalMarkNo jdbcType=VARCHAR},
			#{item.smallTickerNum jdbcType=VARCHAR},#{item.wayBillNo jdbcType=VARCHAR},#{item.createUserName jdbcType=VARCHAR},
			#{item.createUserCode jdbcType=VARCHAR},#{item.createDate jdbcType=TIMESTAMP},#{item.active jdbcType=VARCHAR}
			)
		</foreach>
		;end;
	</insert>
	
	<!-- 查询运单开单上门接货且开单输入的工号是否是司机工号-->
	<select id="queryDriverNoOperateNo" resultType="Long" 
		parameterType="java.lang.String">
		      
		     select count(1)
				from pkp.t_srv_waybill wb 
				inner join bse.t_bas_owndriver ow  on ow.emp_code=wb.driver_code
			<where> 
					ow.active='Y'
					and wb.waybill_no=#{wayBillNo}
			</where>
	</select>
	<!--更新租车标记主表的工作流相关信息-->
	<update id="updateTemprentalMarkAccrued" parameterType="com.deppon.foss.module.transfer.scheduling.api.shared.dto.RentalMarkDto"> 
		update TFR.T_OPT_TEMPRENTALMARK tt 
		set tt.ACCRUED_STATE=#{accruedState jdbcType=VARCHAR},
			tt.ACCRUED_WORK_NO=#{accruedWorkNo jdbcType=VARCHAR},
			tt.ACCRUED_WORK_RESULT=#{accruedWorkResult jdbcType=VARCHAR}
		<where>
			tt.TEMPRENTAL_MARK_NO IN
			<foreach collection="rentCarNos" item="item" separator="," close=")" open="(">
              	#{item}
			</foreach>	
		</where>
	</update>
	<!--批量作废租车标记记录-->
	<update id="invalidRentalMark" parameterType="java.util.List"> 
		update TFR.T_OPT_TEMPRENTALMARK tt 
		set tt.active='N',
		tt.modify_user_name=#{cInfo.empCode jdbcType=VARCHAR},
		tt.modify_user_code=#{cInfo.empName jdbcType=VARCHAR},
		tt.modify_date=#{date jdbcType=TIMESTAMP}
		<where>
			tt.TEMPRENTAL_MARK_NO in
			<foreach collection="tempRentalMarkNoList" item="item" separator="," close=")" open="(">
	                	#{item}
			</foreach>
		</where>
	</update>
	
	<!-- 配合CUBC批量作废租车标记记录 date：2017-04-07 author:liping -->
	<update id="cancelRentalMark" parameterType="java.util.Map">
	  update TFR.T_OPT_TEMPRENTALMARK tt 
		set tt.active='N',
		tt.modify_user_name=#{empCode jdbcType=VARCHAR},
		tt.modify_user_code=#{empName jdbcType=VARCHAR},
		tt.modify_date=#{date jdbcType=TIMESTAMP}
		where tt.TEMPRENTAL_MARK_NO=#{hireCarCode jdbcType=VARCHAR}
	</update>
	<!-- start   author:106162 date:2017-04-18 note:CUBC取消租车编码要释放租车金额 -->
	<!-- 根据组织部门CODE获取标杆标码 -->
	<select id="queryUnifyCodeByDeptCode" parameterType="java.lang.String" resultType="java.lang.String">
	    select  o.unified_code unifyCode 
	      from bse.t_bas_org  o 
	     where o.code=#{deptCode jdbcType=VARCHAR} and o.active='Y'	   
	</select>
	<!-- 根据租车编码查询租车标记实体 -->
	<select id="queryTempMarkEntByNo" parameterType="java.lang.String" resultMap="rentalTempMarkEntityResultMap">
	    select 
			kk.bwar_fees_dept_code feesDeptCode,
			kk.rental_amount rentalAmount,
			kk.temprental_mark_no temprentalMarkNo,
			kk.invite_vehicleno inviteVehicleno,
			to_CHAR(kk.usecar_date,'yyyymm') useCarDate
		from tfr.t_opt_temprentalmark kk 
		where kk.temprental_mark_no=#{temprentalMarkNo jdbcType=VARCHAR} and kk.active='Y'
	</select>
	<!-- 根据员工工号获取对应的组织标杆标码 -->
	<select id="queryUnifyCodeByEmpCode" parameterType="java.lang.String" resultType="java.lang.String">
	   select  ee.unifield_code unifyCode 
	     from bse.t_bas_employee ee 
	    where ee.emp_code=#{empCode jdbcType=VARCHAR} and ee.active='Y'
	</select>
	<!-- end   author:106162 date:2017-04-18 note:CUBC取消租车编码要释放租车金额 -->
	
	<!--租车标记明细重复数据-->
	<resultMap id="queryRentalMarkDuplicatesMap" type="com.deppon.foss.module.transfer.scheduling.api.shared.domain.TempRentalMarkDetailEntity">
		
		<result property="id" column="id"/><!--id-->
		<result property="tempRentalMarkId" column="tempRentalMarkId"/><!--租车id-->
		<result property="tempRentalMarkNo" column="tempRentalMarkNo"/><!--租车编号-->
		<result property="billNo" column="billNo"/><!--单号-->
		<result property="billType" column="billType"/><!--单据类型-->
		<result property="weight" column="weight"/><!--重量-->
		<result property="volume" column="volume"/><!--体积-->
		<result property="createUserName" column="createUserName"/><!--创建人-->
		<result property="createUserCode" column="createUserCode"/><!--创建人编码-->
		<result property="createDate" column="createDate"/><!--创建时间-->
		<result property="rentalCarUserType" column="rentalCarUserType"/><!--租车用途-->
		<result property="markDepartCode" column="markDepartCode"/><!--标记部门编码-->
		<result property="markDepartName" column="markDepartName"/><!--标记部门-->
		<result property="vehicleNo" column="vehicleNo"/><!--车牌号-->
		<result property="payableNo" column="payableNo"/><!--应付单号-->
		<result property="notes" column="notes"/><!--备注-->
		<result property="rentCarAmount" column="rentCarAmount"/>
	</resultMap>
	<!--租车标记明细重复数据查询-->
	<select id="queryRentalMarkDuplicates"  resultMap="queryRentalMarkDuplicatesMap" parameterType="java.lang.String">
		select t2.id id,
	           t2.temprentalmark_id tempRentalMarkId,
	           t2.temprental_mark_no tempRentalMarkNo,
	           t2.bill_no billNo,
	           t2.bill_type billType,
	           t2.weight weight,
	           t2.volume volume,
	           t2.create_user_name createUserName,
	           t2.create_user_code createUserCode,
	           t2.create_date createDate,
	           t2.rental_car_usetype rentalCarUserType,
	           t2.mark_depart_code markDepartCode,
	           t2.mark_depart_name markDepartName,
	           tk2.vehicle_no vehicleNo,
	           tk2.rental_amount/100 rentCarAmount,
	           p.payable_no payableNo, 
	           tk2.notes
		  from TFR.T_OPT_TEMPRENTALMARK_DETAIL t2
		  join tfr.t_opt_temprentalmark tk2
		    on tk2.id = t2.temprentalmark_id
		   and tk2.active = 'Y'
		  join stl.t_stl_bill_payable p on p.source_bill_no = tk2.temprental_mark_no and p.active='Y'
		 where  t2.bill_no in
		       (select t1.bill_no
		          from TFR.T_OPT_TEMPRENTALMARK_DETAIL t1
		          join tfr.t_opt_temprentalmark tk
		            on tk.id = t1.temprentalmark_id
		           and tk.active = 'Y'
		         where t1.bill_no in
		               (select t.bill_no
		                  from TFR.T_OPT_TEMPRENTALMARK_DETAIL t
		                 where 
		                    t.bill_type = 'waybill'
		                   and t.temprental_mark_no = #{tempRentalMarkNo})
		           and t1.bill_type = 'waybill'
		         group by t1.bill_no
		        having count(1) > 1)
		   and tk2.active = 'Y' and t2.bill_type = 'waybill'
	</select>
	<!--检查约车编号是否以存在租车标记表中-->
	<select id="valiteInviteVehicleNo" parameterType="java.lang.String" resultType="java.lang.String">
		
		select  tt.temprental_mark_no from  TFR.T_OPT_TEMPRENTALMARK tt where tt.active='Y' 
			and tt.invite_vehicleno = #{inviteVehicleNo}
		
	</select>
	<!-- 查询配载单的运单数量 -->
	<select id="queryWayBillCountForStowageNo" parameterType="java.util.List" resultType="Long">
		
		select sum(h.waybill_qty_total) from tfr.t_Opt_Vehicleassemblebill v
		inner join tfr.t_Opt_Vehicleassemble_Detail vd on v.id=vd.vehicleassemblebill_id
		inner join tfr.t_opt_handoverbill h on h.handover_no=vd.handover_no 
		where v.state!='90'
		and v.vehicleassemble_no in 
		<foreach collection="list" item="item" separator="," close=")" open="(">
	              #{item,jdbcType=VARCHAR}
		</foreach>
	</select>
	
<!-- 营业部/驻地营业部：按时间段查询运单以及运单相关信息 -->
	<select id="selectWayBillByDate_1_2" resultMap="BaseResultMap"
		parameterType="java.util.Map">
			SELECT 
		<include refid="Base_Column_List_By_WayBill" />
		<![CDATA[
			FROM PKP.T_SRV_WAYBILL W 
			INNER JOIN  PKP.T_SRV_ACTUAL_FREIGHT AF 
			ON 
				AF.WAYBILL_NO = W.WAYBILL_NO 
				AND (AF.STATUS <> 'OBSOLETE' AND AF.STATUS <> 'ABORTED')
		]]>
		<include refid="query_selectByWayBill_condition_date_1_2" />
	</select>
	<!-- 车队：按时间段查询运单 -->
	<!-- 营业部/驻地营业部：按时间段查询运单以及运单相关信息 -->
	<select id="selectWayBillByDate_3_4" resultMap="BaseResultMap"
		parameterType="java.util.Map">
			SELECT 
		<include refid="Base_Column_List_By_WayBill" />
		<![CDATA[
			FROM PKP.T_SRV_WAYBILL W 
			INNER JOIN  PKP.T_SRV_ACTUAL_FREIGHT AF 
			ON 
				AF.WAYBILL_NO = W.WAYBILL_NO 
				AND (AF.STATUS <> 'OBSOLETE' AND AF.STATUS <> 'ABORTED')
            LEFT JOIN TFR.T_OPT_TEMPRENTALMARK_DETAIL TM
            ON    TM.bill_no = W.waybill_no
            LEFT JOIN tfr.t_opt_temprentalmark tt
            ON     tt.id = tm.temprentalmark_id
            AND    tt.active = 'Y'
			LEFT JOIN BSE.T_BAS_DATA_DICTIONARY_VALUE DIC
			   ON DIC.VALUE_CODE = W.RECEIVE_METHOD
			      AND DIC.TERMS_CODE IN ('PICKUPGOODSHIGHWAYS','PICKUPGOODSAIR')
			      AND DIC.ACTIVE='Y' 
		]]>
		<include refid="query_selectByWayBill_condition_date_3_4" />
	</select>
	
	<!--营业部/驻地营业部 按单号查询运单总数已标记和未标记数据  -->
	<select id="countTempWayBillByBillNos" resultType="Long" parameterType="java.util.Map">
		<![CDATA[	SELECT COUNT(W.ID) TOTAL 
			FROM PKP.T_SRV_WAYBILL W 
			INNER JOIN  PKP.T_SRV_ACTUAL_FREIGHT AF ON AF.WAYBILL_NO = W.WAYBILL_NO AND (AF.STATUS <> 'OBSOLETE' AND AF.STATUS <> 'ABORTED')
			left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  	on  tm.bill_no =  W.WAYBILL_NO
			left join TFR.T_OPT_TEMPRENTALMARK tt 
		  	 on tt.temprental_mark_no=tm.temprental_mark_no 
			 and tt.id=tm.temprentalmark_id 
			 and tt.active='Y' 
		]]>
		<if test="type == 1 or type == 2">
			<include refid="query_selectByWayBill_condition_wayBill_1_2" />
		</if>
		<if test="type == 3 or type == 4">
			<include refid="query_selectByWayBill_condition_wayBill_3_4" />
		</if>
	</select>
	
	<!-- 车队或者营业部  根据运单和提货方式查询租车标记数据 -->
	<select id="selectWayBillByDate" resultMap="BaseResultMap"
		parameterType="java.util.Map">
			SELECT 
				   Tt.Vehicle_No Vehicleno,
			       Tt.Driver_Name Driver,
			       Tt.Temprental_Mark_No Temprentalmarkno,
			       Tt.Rental_Car_Usetype Rentalusetype,
			       Tt.Mark_Depart_Name Markdepartname,
			       Tt.Create_User_Name Markoperater,
			       Tt.Create_Date Markoperatetime,
			       Dic.Value_Name Receivemethodname,
			       Tt.Invite_Vehicleno Invitevehicleno,
			       Tt.Rental_Amount / 100 Rental_Amount,
			       Tm.Consult_Price_No Consultpriceno
			 From Tfr.T_Opt_Temprentalmark Tt
			 Left Join Tfr.T_Opt_Temprentalmark_Detail Tm
			 On Tm.Temprentalmark_Id = Tt.Id
			  and tt.active='Y'
			 Left Join Bse.T_Bas_Data_Dictionary_Value Dic
			 On Dic.Value_Code =#{pickUpWay,jdbcType=VARCHAR}
			 AND DIC.TERMS_CODE IN ('PICKUPGOODSHIGHWAYS','PICKUPGOODSAIR')
			 AND DIC.ACTIVE='Y'       
		   WHERE
		  		 Tm.Bill_No =#{wayBillNo,jdbcType=VARCHAR}
		  		 <!-- 车牌号 -->
		      <if test="vehicleNo != null and vehicleNo != ''">
		        and TT.VEHICLE_NO = #{vehicleNo,jdbcType=VARCHAR} 
		      </if>
		      <!-- 租车编号 -->
		      <if test="TemprentalMarkNo != null and TemprentalMarkNo !=''"  >
		        AND TT.TEMPRENTAL_MARK_NO = #{TemprentalMarkNo,jdbcType=VARCHAR} 
		      </if>
		      	<!-- startTime -->
				<if test="startTime != null">
				<![CDATA[tm.bill_create_date >= #{startTime,jdbcType=TIMESTAMP} AND ]]>
				</if>
				<!-- endTime -->
				<if test="endTime != null">
				<![CDATA[tm.bill_create_date <= #{endTime,jdbcType=TIMESTAMP} AND ]]>
				</if>
	</select>
	
	<!-- 按时间段查询运单总条数 -->
	<select id="selectWayBillByDateCount" resultType="Long"
		parameterType="java.util.Map">
		SELECT COUNT(W.ID) TOTAL
		<![CDATA[
			FROM PKP.T_SRV_WAYBILL W 
			INNER JOIN  PKP.T_SRV_ACTUAL_FREIGHT AF 
			ON 
				AF.WAYBILL_NO = W.WAYBILL_NO 
				AND (AF.STATUS <> 'OBSOLETE' AND AF.STATUS <> 'ABORTED')
		]]>
		<include refid="query_selectByWayBill_condition_date_1_2" />
	</select>
	
		<!-- 按时间段查询已标记运单总条数 -->
	<select id="selectMarkedWayBillByDateCount" resultType="Long"
		parameterType="java.util.Map">
		SELECT COUNT(Tt.Id) TOTAL
			 From Tfr.T_Opt_Temprentalmark Tt
			 Left Join Tfr.T_Opt_Temprentalmark_Detail Tm
			 On Tm.Temprentalmark_Id = Tt.Id
			  and tt.active='Y'
			 and tm.bill_create_date <![CDATA[>= ]]> #{startTime,jdbcType=TIMESTAMP}
			 and tm.bill_create_date <![CDATA[ <=]]> #{endTime,jdbcType=TIMESTAMP}
			 where
			 	1=1
			 <!-- 车牌号 -->
		    <if test="vehicleNo != null and vehicleNo != ''">
		        and TT.VEHICLE_NO = #{vehicleNo,jdbcType=VARCHAR} 
		     </if>
		     <!-- 租车编号 -->
		     <if test="TemprentalMarkNo != null and TemprentalMarkNo !=''"  >
		        AND TT.TEMPRENTAL_MARK_NO = #{TemprentalMarkNo,jdbcType=VARCHAR} 
		     </if>
	</select>
	
	<!-- 车队或者营业部  查询已标记租车标记数据 -->
	<select id="queryMarkedWayBillByDate" resultMap="BaseResultMap"
		parameterType="java.util.Map">
			SELECT 
				   Tm.Bill_No billNo,
				   Tt.Vehicle_No Vehicleno,
			       Tt.Driver_Name Driver,
			       Tt.Temprental_Mark_No Temprentalmarkno,
			       Tt.Rental_Car_Usetype Rentalusetype,
			       Tt.Mark_Depart_Name Markdepartname,
			       Tt.Create_User_Name Markoperater,
			       Tt.Create_Date Markoperatetime,
			       Tt.Invite_Vehicleno Invitevehicleno,
			       Tt.Rental_Amount / 100 Rental_Amount,
			       Tm.Consult_Price_No Consultpriceno
			 From Tfr.T_Opt_Temprentalmark Tt
			 Left Join Tfr.T_Opt_Temprentalmark_Detail Tm
			 On Tm.Temprentalmark_Id = Tt.Id
			 and tt.active='Y'
			 and tm.bill_create_date <![CDATA[>= ]]> #{startTime,jdbcType=TIMESTAMP}
			 and tm.bill_create_date <![CDATA[ <=]]> #{endTime,jdbcType=TIMESTAMP}
		   WHERE
		  		1=1
		  		<!-- 车牌号 -->
		      <if test="vehicleNo != null and vehicleNo != ''">
		        and TT.VEHICLE_NO = #{vehicleNo,jdbcType=VARCHAR} 
		      </if>
		      <!-- 租车编号 -->
		      <if test="TemprentalMarkNo != null and TemprentalMarkNo !=''"  >
		        AND TT.TEMPRENTAL_MARK_NO = #{TemprentalMarkNo,jdbcType=VARCHAR} 
		      </if>
		      
	</select>
		<!-- 根据运单号 查询运单表 得到运单信息 -->
	<select id="queryMarkedWayBillInfo" resultMap="BaseResultMap"
		parameterType="java.util.Map">
		SELECT 
			W.WAYBILL_NO BILLNO,
			'waybill' BILLTYPE,
			W.RECEIVE_ORG_NAME DEPARTURENAME,
			W.CUSTOMER_PICKUP_ORG_NAME ARRIVEORG,
			W.GOODS_WEIGHT_TOTAL WEIGHT,
			W.GOODS_VOLUME_TOTAL VOLUME,
			W.GOODS_NAME GOODSNAME,
			W.GOODS_PACKAGE GOODSPACKAGE,
			W.PICKUP_TO_DOOR PICKUPTODOOR,
			W.DELIVERY_CUSTOMER_NAME DELIVERYCUSTOMERNAME,
			W.DELIVERY_CUSTOMER_ADDRESS DELIVERYCUSTOMERADDRESS,
			W.TARGET_ORG_CODE TARGETORGCODE,
			W.RECEIVE_METHOD RECEIVEMETHOD,
			W.RECEIVE_CUSTOMER_CONTACT RECEIVECUSTOMERCONTACT,
			W.RECEIVE_CUSTOMER_ADDRESS RECEIVECUSTOMERADDRESS,
			W.CREATE_TIME BILLGENERATETIME,
			Dic.Value_Name Receivemethodname
			FROM PKP.T_SRV_WAYBILL W 
			LEFT JOIN BSE.T_BAS_DATA_DICTIONARY_VALUE DIC
			   ON DIC.VALUE_CODE = W.RECEIVE_METHOD
			      AND DIC.TERMS_CODE IN ('PICKUPGOODSHIGHWAYS','PICKUPGOODSAIR')
			      AND DIC.ACTIVE='Y'
			WHERE
				W.WAYBILL_NO=#{wayBillNo,jdbcType=VARCHAR}
				AND W.ACTIVE = 'Y' 
				AND W.IS_WHOLE_VEHICLE = 'N'  
				AND  (W.is_ecs is null or W.is_ecs = 'N')
			<!-- 开单部门 -->
		     <if test="createOrgCode != null and createOrgCode !=''">
		       AND  W.RECEIVE_ORG_CODE = #{createOrgCode,jdbcType=VARCHAR}
		     </if>
		     
	</select>
	<!--获取交接单号所属的任务编号-->
	<select id="queryTaskNo" parameterType="java.lang.String" resultType="java.lang.String">
		 SELECT
		       TT.TRUCK_TASK_ID  
		 FROM  TFR.T_OPT_TRUCK_TASK_BILL t ,
 			   TFR.T_OPT_TRUCK_TASK_DETAIL tt 
		 WHERE  t.truck_task_detail_id=tt.id
  		 AND    t.bill_no=#{billNo,jdbcType=VARCHAR}
	</select>
	<!-- 获取任务编号下的所有交接单号 -->
	<select id="queryBillNo" parameterType="java.lang.String" resultType="java.lang.String">
	SELECT
           tb.bill_no  
      FROM  TFR.T_OPT_TRUCK_TASK_BILL tb ,
           TFR.T_OPT_TRUCK_TASK_DETAIL ta 
     WHERE ta.id=tb.truck_task_detail_id
       AND    ta.truck_task_id=#{id,jdbcType=VARCHAR}
       and 	  tb.BILL_TYPE='HANDOVER'
	</select>
	
	<!-- 营业部/驻地营业部：按运单号查询运单-已标记和未标记 -->
	<select id="selectWayBillByBill_1_2" resultMap="BaseResultMap"
		parameterType="java.util.Map">
			 SELECT 
			<include refid="Base_Column_List_WayBills" />
			<![CDATA[
			FROM PKP.T_SRV_WAYBILL W 
			INNER JOIN  PKP.T_SRV_ACTUAL_FREIGHT AF ON AF.WAYBILL_NO = W.WAYBILL_NO AND (AF.STATUS <> 'OBSOLETE' AND AF.STATUS <> 'ABORTED') 
			left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  	on  tm.bill_no =  W.WAYBILL_NO
			left join TFR.T_OPT_TEMPRENTALMARK tt 
		  	 on tt.temprental_mark_no=tm.temprental_mark_no 
			 and tt.id=tm.temprentalmark_id 
			 and tt.active='Y'
			LEFT JOIN BSE.T_BAS_DATA_DICTIONARY_VALUE DIC
			   ON DIC.VALUE_CODE = W.RECEIVE_METHOD
			      AND DIC.TERMS_CODE IN ('PICKUPGOODSHIGHWAYS','PICKUPGOODSAIR')
			      AND DIC.ACTIVE='Y' 
			]]>
		<include refid="query_selectByWayBill_condition_wayBill_1_2" />
	</select>
	
	<!-- 车队/营业部：按运单号查询运单-已标记和未标记 -->
	<select id="selectWayBillByBill_3_4" resultMap="BaseResultMap"
		parameterType="java.util.Map">
			 SELECT 
			<include refid="Base_Column_List_WayBills" />
			<![CDATA[
			FROM PKP.T_SRV_WAYBILL W 
			INNER JOIN  PKP.T_SRV_ACTUAL_FREIGHT AF ON AF.WAYBILL_NO = W.WAYBILL_NO AND (AF.STATUS <> 'OBSOLETE' AND AF.STATUS <> 'ABORTED') 
			left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  	on  tm.bill_no =  W.WAYBILL_NO
			left join TFR.T_OPT_TEMPRENTALMARK tt 
		  	 on tt.temprental_mark_no=tm.temprental_mark_no 
			 and tt.id=tm.temprentalmark_id 
			 and tt.active='Y'
			LEFT JOIN BSE.T_BAS_DATA_DICTIONARY_VALUE DIC
			   ON DIC.VALUE_CODE = W.RECEIVE_METHOD
			      AND DIC.TERMS_CODE IN ('PICKUPGOODSHIGHWAYS','PICKUPGOODSAIR')
			      AND DIC.ACTIVE='Y' 
			]]>
		<include refid="query_selectByWayBill_condition_wayBill_3_4" />
	</select>
	
	<!-- 营业部或驻地营业部：按时间段查询派送单 -->
	<select id="selectByDeliverByDate_1_2" resultMap="BaseResultMap"
		parameterType="java.util.Map">
			SELECT
		<include refid="Base_Column_List_By_DeliverBill" />
			 FROM PKP.T_SRV_DELIVERBILL D
			 INNER JOIN BSE.T_BAS_LEASED_TRUCK LT ON LT.VEHICLE_NO=D.VEHICLE_NO AND LT.ACTIVE='Y'
			 left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  	 on  tm.bill_no =  D.DELIVERBILL_NO 
		  	 and tm.bill_create_date <![CDATA[>= ]]> #{startTime,jdbcType=TIMESTAMP}
			 and tm.bill_create_date <![CDATA[ <=]]> #{endTime,jdbcType=TIMESTAMP}
			left join TFR.T_OPT_TEMPRENTALMARK tt 
		  	 on tt.temprental_mark_no=tm.temprental_mark_no 
			 and tt.id=tm.temprentalmark_id 
			 and tt.active='Y'
		<include refid="query_selectByDeliverBill_condition_date_1_2" />
	</select>
	
	<!-- 车队/外场：按时间段查询派送单 -->
	<select id="selectByDeliverByDate_3_4" resultMap="BaseResultMap"
		parameterType="java.util.Map">
			SELECT
		<include refid="Base_Column_List_By_DeliverBill" />
			 FROM PKP.T_SRV_DELIVERBILL D
			 INNER JOIN BSE.T_BAS_LEASED_TRUCK LT ON LT.VEHICLE_NO=D.VEHICLE_NO AND LT.ACTIVE='Y'
			 left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  	 on  tm.bill_no =  D.DELIVERBILL_NO 
			 left join TFR.T_OPT_TEMPRENTALMARK tt 
		  	 on tt.temprental_mark_no=tm.temprental_mark_no 
			 and tt.id=tm.temprentalmark_id 
			 and tt.active='Y'
		<include refid="query_selectByDeliverBill_condition_date_3_4" />
	</select>
	
	<!-- 营业部或驻地营业部：按派送单号查询派送单 -->
	<select id="selectByDeliverBills_1_2" resultMap="BaseResultMap"
		parameterType="java.util.Map">
			 SELECT
		<include refid="Base_Column_List_By_DeliverBill" />
			 FROM PKP.T_SRV_DELIVERBILL D
			 INNER JOIN BSE.T_BAS_LEASED_TRUCK LT ON LT.VEHICLE_NO=D.VEHICLE_NO AND LT.ACTIVE='Y'
			left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  	 on  tm.bill_no =  D.DELIVERBILL_NO 
			 left join TFR.T_OPT_TEMPRENTALMARK tt 
		  	 on tt.temprental_mark_no=tm.temprental_mark_no 
			 and tt.id=tm.temprentalmark_id 
			 and tt.active='Y'
		<include refid="query_selectByDeliverBill_condition_billnos_1_2" />
	</select>
	
	<!-- 车队/营业部：按派送单号查询派送单 -->
	<select id="selectByDeliverBills_3_4" resultMap="BaseResultMap"
		parameterType="java.util.Map">
			 SELECT
		<include refid="Base_Column_List_By_DeliverBill" />
			 FROM PKP.T_SRV_DELIVERBILL D
			 INNER JOIN BSE.T_BAS_LEASED_TRUCK LT ON LT.VEHICLE_NO=D.VEHICLE_NO AND LT.ACTIVE='Y'
			left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  	 on  tm.bill_no =  D.DELIVERBILL_NO 
			 left join TFR.T_OPT_TEMPRENTALMARK tt 
		  	 on tt.temprental_mark_no=tm.temprental_mark_no 
			 and tt.id=tm.temprentalmark_id 
			 and tt.active='Y'
		<include refid="query_selectByDeliverBill_condition_billnos_3_4" />
	</select>
	
		<!-- 按时间段查询派送单总数 -->
	<select id="getTotalDeliverBillByDate" resultType="Long"
		parameterType="java.util.Map">
			 SELECT COUNT(D.ID) TOTAL 
			 FROM PKP.T_SRV_DELIVERBILL D
			 INNER JOIN BSE.T_BAS_LEASED_TRUCK LT ON LT.VEHICLE_NO=D.VEHICLE_NO AND LT.ACTIVE='Y'
			left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  	 on  tm.bill_no =  D.DELIVERBILL_NO 
		  	 and tm.bill_create_date <![CDATA[>= ]]> #{startTime,jdbcType=TIMESTAMP}
			 and tm.bill_create_date <![CDATA[ <=]]> #{endTime,jdbcType=TIMESTAMP}
			 left join TFR.T_OPT_TEMPRENTALMARK tt 
		  	 on tt.temprental_mark_no=tm.temprental_mark_no 
			 and tt.id=tm.temprentalmark_id 
			 and tt.active='Y'
		<if test="type == 1 or type == 2">
			<include refid="query_selectByDeliverBill_condition_date_1_2" />
		</if>
		<if test="type == 3 or type == 4">
			<include refid="query_selectByDeliverBill_condition_date_3_4" />
		</if>
	</select>
	
	<!-- 按单号查询派送单总数 -->
	<select id="getTotalDeliverBillByBillNos" resultType="Long"
		parameterType="java.util.Map">
			 SELECT COUNT(D.ID) TOTAL 
			 FROM PKP.T_SRV_DELIVERBILL D
			 INNER JOIN BSE.T_BAS_LEASED_TRUCK LT ON LT.VEHICLE_NO=D.VEHICLE_NO AND LT.ACTIVE='Y'
			left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  	 on  tm.bill_no =  D.DELIVERBILL_NO 
			 left join TFR.T_OPT_TEMPRENTALMARK tt 
		  	 on tt.temprental_mark_no=tm.temprental_mark_no 
			 and tt.id=tm.temprentalmark_id 
			 and tt.active='Y'
		<if test="type == 1 or type == 2">
			<include refid="query_selectByDeliverBill_condition_billnos_1_2" />
		</if>
		<if test="type == 3 or type == 4">
			<include refid="query_selectByDeliverBill_condition_billnos_3_4" />
		</if>
	</select>
	
	<!-- 按快递单号查询快递运单总数 -->
	<select id="countExpressByWayBill" resultType="Long"
		parameterType="java.util.Map">
		<![CDATA[
			SELECT COUNT(W.ID) TOTAL 
			FROM PKP.T_SRV_WAYBILL W 
			INNER JOIN  PKP.T_SRV_ACTUAL_FREIGHT AF ON AF.WAYBILL_NO = W.WAYBILL_NO AND (AF.STATUS <> 'OBSOLETE' AND AF.STATUS <> 'ABORTED')
			left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  	 on  tm.bill_no =  W.WAYBILL_NO 
			 left join TFR.T_OPT_TEMPRENTALMARK tt 
		  	 on tt.temprental_mark_no=tm.temprental_mark_no 
			 and tt.id=tm.temprentalmark_id 
			 and tt.active='Y'  
		]]>
		<if test="type == 1 or type == 2 or type == 3 or type == 4">
			<include refid="query_selectByExpressBill_condition_billnos1_2_3_4" />
		</if>
	</select>
	
	<select id="queryExpressBillByBill" resultMap="BaseResultMap"
		parameterType="java.util.Map">
			 SELECT
					W.WAYBILL_NO BILLNO,
					'expressbill' BILLTYPE,
					W.RECEIVE_ORG_NAME DEPARTURENAME,
					W.CUSTOMER_PICKUP_ORG_NAME ARRIVEORG,
					W.GOODS_WEIGHT_TOTAL WEIGHT,
					W.GOODS_VOLUME_TOTAL VOLUME,
					W.GOODS_NAME GOODSNAME,
					W.GOODS_PACKAGE GOODSPACKAGE,
					W.PICKUP_TO_DOOR PICKUPTODOOR,
					W.DELIVERY_CUSTOMER_NAME DELIVERYCUSTOMERNAME,
					W.DELIVERY_CUSTOMER_ADDRESS DELIVERYCUSTOMERADDRESS,
					W.TARGET_ORG_CODE TARGETORGCODE,
					W.RECEIVE_METHOD RECEIVEMETHOD,
					W.RECEIVE_CUSTOMER_CONTACT RECEIVECUSTOMERCONTACT,
					W.RECEIVE_CUSTOMER_ADDRESS RECEIVECUSTOMERADDRESS,
					W.CREATE_TIME BILLGENERATETIME,
					DIC.VALUE_NAME RECEIVEMETHODNAME,
					TT.RENTAL_AMOUNT RENTAL_AMOUNT,
					TT.TEMPRENTAL_MARK_NO  TEMPRENTAL_MARK_NO,
		            TT.RENTAL_CAR_USETYPE RENTAL_CAR_USETYPE,
		            TT.CREATE_DATE CREATE_DATE,
		            TT.MARK_DEPART_NAME MARK_DEPART_NAME,
		            TT.MARK_DEPART_CODE MARK_DEPART_CODE,
		            TT.CREATE_USER_NAME  CREATE_USER_NAME, 
		            TT.VEHICLE_NO  VEHICLE_NO,
		            TT.DRIVER_NAME DRIVER_NAME,
		            TT.INVITE_VEHICLENO  INVITE_VEHICLENO,
		            
		(
		<![CDATA[CASE WHEN  W.PRODUCT_CODE  IN ('RCP','EPEP','PACKAGE') THEN 'Y' ELSE 'N' END) AS ISEXPRESSWAYBILL
			 FROM PKP.T_SRV_WAYBILL W 
      INNER JOIN  PKP.T_SRV_ACTUAL_FREIGHT AF ON AF.WAYBILL_NO = W.WAYBILL_NO AND (AF.STATUS <> 'OBSOLETE' AND AF.STATUS <> 'ABORTED') 
			left join TFR.T_OPT_TEMPRENTALMARK_DETAIL tm  
		  	 on  tm.bill_no =  W.WAYBILL_NO 
			 left join TFR.T_OPT_TEMPRENTALMARK tt 
		  	 on tt.temprental_mark_no=tm.temprental_mark_no 
			 and tt.id=tm.temprentalmark_id 
			 and tt.active='Y'  
			LEFT JOIN BSE.T_BAS_DATA_DICTIONARY_VALUE DIC
			   ON DIC.VALUE_CODE = W.RECEIVE_METHOD
			      AND DIC.TERMS_CODE IN ('PICKUPGOODSHIGHWAYS','PICKUPGOODSAIR')
			      AND DIC.ACTIVE='Y'
			      ]]>
		<include refid="query_selectByExpressBill_condition_billnos1_2_3_4" />
	</select>
	<!-- 获取交接单号的详细信息-->
	<select id="queryBillNoinfo" parameterType="java.lang.String" resultMap="queryRentalMarkEntityMap">
		select t.VEHICLE_NO as vehicleNo,
       t.driver_code as driverCode,
       t.driver_name as driverName,
       t.driver_mobile_phone,
       t.orig_org_code as origOrgCode,
       t.orig_org_name as origOrgName,
       t.dest_org_code as destOrgCode,
       t.dest_org_name as destOrgName,
       t.weight_total as weight,
       t.volume_total as volume，
       t.Money_Total as rentalAmount
  from tfr.t_Opt_Handoverbill t
 where t.handover_no =#{billNo,jdbcType=VARCHAR}
	</select>
	<!-- 310248查询费用承担部门名称 -->
	<select id="queryBearFeesDeptName" parameterType="java.lang.String" resultType="java.lang.String">
	select t.bear_fees_dept_name as bearFeesDeptName
      from tfr.t_Opt_Temprentalmark m
      left join tfr.t_opt_invite_vehicle t
        on m.invite_vehicleno = t.invite_no
	 where m.temprental_mark_no = #{inviteNo,jdbcType=VARCHAR}
	</select>
	<!-- 310248CUBC查询费用承担部门 -->
	<select id="queryBearFeesDept" parameterType="java.lang.String" resultType="com.deppon.foss.module.transfer.scheduling.api.shared.dto.RentCarCubcRequest">
	select t.bear_fees_dept_name as bearFeesDept, t.bear_fees_dept_code as bearFeesDeptCode
       from tfr.t_opt_invite_vehicle t
       
     where t.invite_no = #{inviteNo,jdbcType=VARCHAR}
	</select>
</mapper>