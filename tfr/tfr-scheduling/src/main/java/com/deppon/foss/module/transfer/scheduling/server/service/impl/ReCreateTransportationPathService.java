/**
 *  initial comments.
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 */
/*******************************************************************************
 * Copyright 2013 TFR TEAM
 *  
 *  Licensed under the DEPPON License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *  
 *     http://www.deppon.com/licenses/LICENSE-2.0
 *  
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *  
 *  PROJECT NAME  : tfr-scheduling
 *  
 *  PACKAGE NAME  : 
 * 
 *  DESCRIPTION   : 调度、发车计划、排班、月台、车辆管理等
 *  
 *  FILE PATH     :src/main/java/com/deppon/foss/module/transfer/scheduling/server/service/impl/ReCreateTransportationPathService.java
 * 
 *  FILE NAME     :ReCreateTransportationPathService.java
 *  
 *  AUTHOR        : FOSS中转开发组
 *  
 *  TIME          : 
 *  
 *  HOME PAGE     :  http://www.deppon.com
 *  
 *  COPYRIGHT     : Copyright (c) 2013  Deppon All Rights Reserved.
 * 
 *  VERSION       :0.1
 * 
 *  LAST MODIFY TIME:
 ******************************************************************************/
package com.deppon.foss.module.transfer.scheduling.server.service.impl;

import java.util.ArrayList;
import java.util.List;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.LogManager;
import org.apache.log4j.Logger;

import com.deppon.foss.base.util.define.BizTypeConstants;
import com.deppon.foss.framework.shared.util.string.StringUtil;
import com.deppon.foss.module.base.baseinfo.api.server.service.IOrgAdministrativeInfoService;
import com.deppon.foss.module.base.baseinfo.api.server.service.complex.IOrgAdministrativeInfoComplexService;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.OrgAdministrativeInfoEntity;
import com.deppon.foss.module.frameworkimpl.server.context.FossUserContext;
import com.deppon.foss.module.transfer.common.api.shared.define.PricingConstants;
import com.deppon.foss.module.transfer.common.api.shared.exception.TfrBusinessException;
import com.deppon.foss.module.transfer.scheduling.api.define.TransportPathConstants;
import com.deppon.foss.module.transfer.scheduling.api.server.dao.IPathDetailDao;
import com.deppon.foss.module.transfer.scheduling.api.server.dao.ITransportationPathDao;
import com.deppon.foss.module.transfer.scheduling.api.server.service.ICalculateTransportPathService;
import com.deppon.foss.module.transfer.scheduling.api.server.service.IReCreateTransportationPathService;
import com.deppon.foss.module.transfer.scheduling.api.shared.domain.PathDetailEntity;
import com.deppon.foss.module.transfer.scheduling.api.shared.domain.TransportPathEntity;
import com.deppon.foss.module.transfer.stock.api.define.StockConstants;
import com.deppon.foss.module.transfer.stock.api.server.service.IStockService;
import com.deppon.foss.module.transfer.stock.api.shared.domain.InOutStockEntity;
import com.deppon.foss.module.transfer.stock.api.shared.domain.StockEntity;
import com.deppon.foss.module.transfer.stock.api.shared.domain.WaybillStockEntity;

/**
 * 重新计算走货路径service实现
 * 
 * @author huyue
 * @date 2012-10-11 下午9:14:59
 */
public class ReCreateTransportationPathService implements IReCreateTransportationPathService {

	private IPathDetailDao pathDetailDao;

	private ICalculateTransportPathService calculateTransportPathService;

	private ITransportationPathDao transportationPathDao;

	private IOrgAdministrativeInfoService orgAdministrativeInfoService;

	private IOrgAdministrativeInfoComplexService orgAdministrativeInfoComplexService;
	
	private IStockService stockService;

	public IStockService getStockService() {
		return stockService;
	}

	public void setStockService(IStockService stockService) {
		this.stockService = stockService;
	}

	/**
	 * orgAdministrativeInfoComplexService
	 * 
	 * @return the orgAdministrativeInfoComplexService
	 * @since CodingExample Ver(编码范例查看) 1.0
	 */

	public IOrgAdministrativeInfoComplexService getOrgAdministrativeInfoComplexService() {
		return orgAdministrativeInfoComplexService;
	}

	/**
	 * @param orgAdministrativeInfoComplexService the orgAdministrativeInfoComplexService to set Date:2013-5-1上午9:41:59
	 */

	public void setOrgAdministrativeInfoComplexService(IOrgAdministrativeInfoComplexService orgAdministrativeInfoComplexService) {
		this.orgAdministrativeInfoComplexService = orgAdministrativeInfoComplexService;
	}

	//日志
	private static final Logger logger = LogManager.getLogger(ReCreateTransportationPathService.class);
	
	public IPathDetailDao getPathDetailDao() {
		return pathDetailDao;
	}

	public void setPathDetailDao(IPathDetailDao pathDetailDao) {
		this.pathDetailDao = pathDetailDao;
	}

	public ICalculateTransportPathService getCalculateTransportPathService() {
		return calculateTransportPathService;
	}

	public void setCalculateTransportPathService(ICalculateTransportPathService calculateTransportPathService) {
		this.calculateTransportPathService = calculateTransportPathService;
	}

	public ITransportationPathDao getTransportationPathDao() {
		return transportationPathDao;
	}

	public void setTransportationPathDao(ITransportationPathDao transportationPathDao) {
		this.transportationPathDao = transportationPathDao;
	}

	public IOrgAdministrativeInfoService getOrgAdministrativeInfoService() {
		return orgAdministrativeInfoService;
	}

	public void setOrgAdministrativeInfoService(IOrgAdministrativeInfoService orgAdministrativeInfoService) {
		this.orgAdministrativeInfoService = orgAdministrativeInfoService;
	}

	/**
	 * 查询走货路径LIST分页
	 * 
	 * @author huyue
	 * @date 2012-10-11 下午9:15:18
	 * @see com.deppon.foss.module.transfer.scheduling.api.server.service.IReCreateTransportationPathService#queryTransportPath(com.deppon.foss.module.transfer.scheduling.api.shared.domain.TransportPathEntity,
	 *      int, int)
	 */
	@Override
	public List<TransportPathEntity> queryTransportPathforPage(TransportPathEntity transportPathEntity, int limit, int start) throws TfrBusinessException {

		// modify by liangfuxiang 2013-5-1上午10:27:48 begin BUG-8196
		reInitTransportPathEntity(transportPathEntity);
		// modify by liangfuxiang 2013-5-1上午10:28:00 end;
		
		List<TransportPathEntity> list = transportationPathDao.queryTransportPathforPage(transportPathEntity, limit, start);
		for (int q = 0; q < list.size(); q++) {
			list.get(q).setBillingOrgCodeName(getNameByCode(list.get(q).getBillingOrgCode()));
			list.get(q).setCurrentOrgCodeName(getNameByCode(list.get(q).getCurrentOrgCode()));
			list.get(q).setDestOrgCodeName(getNameByCode(list.get(q).getDestOrgCode()));
			list.get(q).setNextOrgCodeName(getNameByCode(list.get(q).getNextOrgCode()));
			list.get(q).setPackingOrgCodeName(getNameByCode(list.get(q).getPackingOrgCode()));
			
			// modify by liangfuxiang 2013-3-25上午10:58:33 begin BUG-5858 重新计算走货路径界面，运输性质，现状态，走货路径显示为编码
			//解决方式：将对应的编码转换为中文
			//将货物状态转换为中文
			list.get(q).setAction(getChineseMeaningAction(list.get(q).getAction()));
			//将运出类型转换为中文
			list.get(q).setTransportModel(getChineseMeaningTransportModel(list.get(q).getTransportModel()));
			//将路径转换中文
			list.get(q).setTransportPath(getChineseMeaningTransportPath(list.get(q).getTransportPath()));
			// modify by liangfuxiang 2013-3-25上午10:58:39 end;
			
		}
		return list;
	}

	/**
	 * 
	 * @Title: reInitTransportPathEntity
	 * @Description: 重新初始化走货路径信息
	 * @param transportPathEntity 设定文件
	 * @return void 返回类型
	 * @see reInitTransportPathEntity
	 * @author: liangfuxiang liangfux@cn.ibm.com
	 * @version: 2013-5-1 上午10:43:05
	 * @throws
	 */
	private void reInitTransportPathEntity(TransportPathEntity transportPathEntity) {
		if (null == transportPathEntity) {
			logger.error(TransportPathConstants.QUERY_TRANSPORTPATH_NULL);
			throw new TfrBusinessException(TransportPathConstants.QUERY_TRANSPORTPATH_NULL);
		}
		// 获取当前组织编码
		String initOrgCode = transportPathEntity.getCurrentOrgCode();
		// 若当前组织编码为空
		if (StringUtil.isEmpty(initOrgCode)) {
			logger.info(TransportPathConstants.QUERY_TRANSPORTPATH_CURRENTORGCODE_NULL);
			// 重新初始haunted当前编码
			initOrgCode = FossUserContext.getCurrentDeptCode();
		}
		// 根据当前组织编码获取组织信息
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = querySuperiorOrgByOrgCode(initOrgCode);
		// 重新配置当前组织编码
		transportPathEntity.setCurrentOrgCode(orgAdministrativeInfoEntity.getCode());
	}

	/**
	 * @Title: getChineseMeaningTransportModel
	 * @Description: 将运出类型转换为中文
	 * @param transportModel
	 * @return 设定文件
	 * @return String 返回类型
	 * @see getChineseMeaningTransportModel
	 * @author: liangfuxiang liangfux@cn.ibm.com
	 * @version: 2013-3-25 上午11:40:24
	 * @throws
	 */
	private String getChineseMeaningTransportModel(String transportModel) throws TfrBusinessException{

		// 去空
		transportModel = StringUtils.trim(transportModel);

		// 非空
		if (StringUtils.isEmpty(transportModel)) {
			// 运输类型为空
			transportModel = TransportPathConstants.PRICING_PRODUCT_AIR_FREIGHT_NULL;
		}
		else {
			// 精准卡航
			if (PricingConstants.ProductEntityConstants.PRICING_PRODUCT_LONG_DISTANCE_FAST_FREIGHT.equalsIgnoreCase(transportModel)) {
				transportModel = TransportPathConstants.PRICING_PRODUCT_LONG_DISTANCE_FAST_FREIGHT_CHINESE;
			}
			// 精准城运
			else if (PricingConstants.ProductEntityConstants.PRICING_PRODUCT_SHORT_DISTANCE_FAST_FREIGHT.equalsIgnoreCase(transportModel)) {
				transportModel = TransportPathConstants.PRICING_PRODUCT_SHORT_DISTANCE_FAST_FREIGHT_CHINESE;
			}
			// "精准汽运(长途)
			else if (PricingConstants.ProductEntityConstants.PRICING_PRODUCT_LONG_DISTANCE_ROAD_FREIGHT.equalsIgnoreCase(transportModel)) {
				transportModel = TransportPathConstants.PRICING_PRODUCT_LONG_DISTANCE_ROAD_FREIGHT_CHINESE;
			}
			// 精准汽运(短途)
			else if (PricingConstants.ProductEntityConstants.PRICING_PRODUCT_SHORT_DISTANCE_ROAD_FREIGHT.equalsIgnoreCase(transportModel)) {
				transportModel = TransportPathConstants.PRICING_PRODUCT_SHORT_DISTANCE_ROAD_FREIGHT_CHINESE;
			}
			// 汽运偏线
			else if (PricingConstants.ProductEntityConstants.PRICING_PRODUCT_PARTIAL_LINE.equalsIgnoreCase(transportModel)) {
				transportModel = TransportPathConstants.PRICING_PRODUCT_PARTIAL_LINE_CHINESE;
			}
			// 整车
			else if (PricingConstants.ProductEntityConstants.PRICING_PRODUCT_FULL_VEHICLE.equalsIgnoreCase(transportModel)) {
				transportModel = TransportPathConstants.PRICING_PRODUCT_FULL_VEHICLE_CHINESE;
			}
			// 精准空运
			else if (PricingConstants.ProductEntityConstants.PRICING_PRODUCT_AIR_FREIGHT.equalsIgnoreCase(transportModel)) {
				transportModel = TransportPathConstants.PRICING_PRODUCT_AIR_FREIGHT_CHINESE;
			}
			else {
				// 无此运输模式
				logger.error("ReCreateTransportationPathService[getChineseMeaningTransportModel()]:"+TransportPathConstants.PRICING_PRODUCT_UNEFFECTIVE+TransportPathConstants.BLANK_SPACE_STRING+transportModel);
				throw new TfrBusinessException(TransportPathConstants.PRICING_PRODUCT_UNEFFECTIVE_GLOB, new Object[] { transportModel });
			}
		}

		return transportModel;
	}

	/**
	 * @Title: getChineseMeaningTransportPath
	 * @Description: 将路径转换中文
	 * @param transportPath
	 * @return 设定文件
	 * @return String 返回类型
	 * @see getChineseMeaningTransportPath
	 * @author: liangfuxiang liangfux@cn.ibm.com
	 * @version: 2013-3-25 上午11:33:37
	 * @throws
	 */
	private String getChineseMeaningTransportPath(String transportPath) {

		// 去空
		transportPath = StringUtils.trim(transportPath);
		// N/A
		if (StringUtils.isNotEmpty(transportPath) && StringUtils.equalsIgnoreCase(TransportPathConstants.SET_NULL_STRING, transportPath)) {
			// 走货路径为空时，展示中文为：无
			transportPath = TransportPathConstants.TRANSPORTPATH_NULL_CHINESE;
		}

		return transportPath;
	}

	/**
	 * @Title: getChineseMeaningAction
	 * @Description:将货物状态转换为中文
	 * @param action
	 * @return 设定文件
	 * @return String 返回类型
	 * @see getChineseMeaningAction
	 * @author: liangfuxiang liangfux@cn.ibm.com
	 * @version: 2013-3-25 上午11:05:43
	 * @throws
	 */
	private String getChineseMeaningAction(String action) throws TfrBusinessException{

		// 去除空
		action = StringUtils.trim(action);
		// 若状态为空，则返回空
		if (StringUtils.isEmpty(action)) {
			action = TransportPathConstants.TRANSPORTPATH_STATUS_BILLING_NULL;
		}
		// 非空状态
		else {
			// 到达
			if (TransportPathConstants.TRANSPORTPATH_STATUS_ARRIVE.equalsIgnoreCase(action)) {
				// 到达 对应的中文
				action = TransportPathConstants.TRANSPORTPATH_STATUS_ARRIVE_CHINESE;
			}
			// 开单
			else if (TransportPathConstants.TRANSPORTPATH_STATUS_BILLING.equalsIgnoreCase(action)) {
				// 开单 对应的中文
				action = TransportPathConstants.TRANSPORTPATH_STATUS_BILLING_CHINESE;
			}
			// 出发
			else if (TransportPathConstants.TRANSPORTPATH_STATUS_DEPART.equalsIgnoreCase(action)) {
				// 出发 对应的中文
				action = TransportPathConstants.TRANSPORTPATH_STATUS_DEPART_CHINESE;
			}
			// 已交接
			else if (TransportPathConstants.TRANSPORTPATH_STATUS_HANDOVER.equalsIgnoreCase(action)) {
				// 已交接对应的中文
				action = TransportPathConstants.TRANSPORTPATH_STATUS_HANDOVER_CHINESE;
			}
			// 库存中
			else if (TransportPathConstants.TRANSPORTPATH_STATUS_INSTORE.equalsIgnoreCase(action)) {
				// 库存中对应的中文
				action = TransportPathConstants.TRANSPORTPATH_STATUS_INSTORE_CHINESE;
			}
			// 未入库
			else if (TransportPathConstants.TRANSPORTPATH_STATUS_NOTINSTORE.equalsIgnoreCase(action)) {
				// 未入库对应的中文
				action = TransportPathConstants.TRANSPORTPATH_STATUS_NOTINSTORE_CHINESE;
			}
			// 签收
			else if (TransportPathConstants.TRANSPORTPATH_STATUS_SIGNIN.equalsIgnoreCase(action)) {
				// 签收对应的中文
				action = TransportPathConstants.TRANSPORTPATH_STATUS_SIGNIN_CHINESE;
			}
			else {
				// 则对应的货物状态不存在，抛出异常
				logger.error("ReCreateTransportationPathService[getChineseMeaningAction()]:" + TransportPathConstants.TRANSPORTPATH_STATUS_UNEFFECTIVE + TransportPathConstants.BLANK_SPACE_STRING
						+ action);
				throw new TfrBusinessException(TransportPathConstants.TRANSPORTPATH_STATUS_UNEFFECTIVE_GLOB, new Object[] { action });
			}
		}

		logger.info("ReCreateTransportationPathService[getChineseMeaningAction()]:action:" + action);

		return action;
	}

	/**
	 * 查询走货路径LIST的行数
	 * 
	 * @author huyue
	 * @date 2012-10-11 下午9:17:16
	 * @see com.deppon.foss.module.transfer.scheduling.api.server.service.IReCreateTransportationPathService#getCount(com.deppon.foss.module.transfer.scheduling.api.shared.domain.TransportPathEntity)
	 */
	public Long getCount(TransportPathEntity transportPathEntity) throws TfrBusinessException {
		// modify by liangfuxiang 2013-5-1上午10:27:48 begin BUG-8196
		reInitTransportPathEntity(transportPathEntity);
		// modify by liangfuxiang 2013-5-1上午10:28:00 end;
		return transportationPathDao.getCount(transportPathEntity);
	}

	/**
	 * 重新计算走货路径
	 * 
	 * @author huyue
	 * @date 2012-11-2 下午1:33:08
	 */
	public int reCreateTransportPath(List<TransportPathEntity> transportPathList) throws TfrBusinessException {
		
		//将对应中文，转换为编码
		transportPathList=translateChinese2Code(transportPathList);
		
		for (int i = 0; i < transportPathList.size(); i++) {
			
			// modify by liangfuxiang 2013-6-8下午4:44:20 begin 解决重新生成走货路径后，无法做交接单的问题---添加入库
			List<String> listGoodsNo = pathDetailDao.listQueryGoodsNo(transportPathList.get(i).getWaybillNo());
			if (listGoodsNo.size() == 0) {
				logger.error("ReCreateTransportationPathService[reCreateTransportPath()]:" + TransportPathConstants.TRANSPORTPATH_RECREATE_CANTFINDSERIALNOBYWAYBILLNO
						+ transportPathList.get(i).getWaybillNo());
				throw new TfrBusinessException(TransportPathConstants.TRANSPORTPATH_RECREATE_CANTFINDSERIALNOBYWAYBILLNO, new Object[] { transportPathList.get(i).getWaybillNo() });
			}
			
			// 如果已经分批配载,则逐条计算
			if (StringUtils.equals(transportPathList.get(i).getIfPartialStowage(), TransportPathConstants.PARTIALSTOWAGE)) {
				
				// List<String> listGoodsNo = pathDetailDao.listQueryGoodsNo(transportPathList.get(i).getWaybillNo());
				// if (listGoodsNo.size() == 0) {
				// // modify by liangfuxiang 2013-5-23下午7:24:23 begin 添加日志
				// // throw new TfrBusinessException(TransportPathConstants.TRANSPORTPATH_RECREATE_CANTFINDSERIALNOBYWAYBILLNO, "");
				// logger.error("ReCreateTransportationPathService[reCreateTransportPath()]:" + TransportPathConstants.TRANSPORTPATH_RECREATE_CANTFINDSERIALNOBYWAYBILLNO+
				// transportPathList.get(i).getWaybillNo());
				// throw new TfrBusinessException(TransportPathConstants.TRANSPORTPATH_RECREATE_CANTFINDSERIALNOBYWAYBILLNO, new Object[] { transportPathList.get(i).getWaybillNo()});
				// // modify by liangfuxiang 2013-5-23下午7:24:19 end;
				//
				// } else {
				// modify by liangfuxiang 2013-6-8下午4:44:27 end 解决重新生成走货路径后，无法做交接单的问题;
				for (int j = 0; j < listGoodsNo.size(); j++) {
					PathDetailEntity pathDetailEntity = new PathDetailEntity();
					pathDetailEntity.setWaybillNo(transportPathList.get(i).getWaybillNo());
					pathDetailEntity.setGoodsNo(listGoodsNo.get(j));
					pathDetailEntity.setObjectiveOrgCode(transportPathList.get(i).getCurrentOrgCode());
					pathDetailEntity.setArriveOrLeave(TransportPathConstants.PATHDETAIL_STATUS_ARRIVE);
					// 查询是否本件货路径中有主表中当前部门 ,并且还在当前部门中(抵达状态),有则进行后序计算
					pathDetailEntity = pathDetailDao.queryPathDetail(pathDetailEntity);
					if (null != pathDetailEntity) {
						// 更新走货路径
						calculateTransportPathService.alterDetail(transportPathList.get(i).getWaybillNo(), listGoodsNo.get(j), transportPathList.get(i).getCurrentOrgCode(), transportPathList.get(i)
								.getDestOrgCode(), transportPathList.get(i).getBillingOrgCode(), transportPathList.get(i).getTransportModel());
					}
				}
				// 都成功后更新路径信息
				//BUG-50951 只显示开单时生成的走货路径 modify by songjie on 2013-08-14
				/*String path = calculateTransportPathService.getChangedPath(transportPathList.get(i).getWaybillNo());
				transportPathList.get(i).setTransportPath(path);*/
				// }
			} else {
				
				// modify by liangfuxiang 2013-5-29上午9:35:44 begin BUG-12616
				// 防止返回的值为空,强制设置一次。
				transportPathList.get(i).setIfPartialStowage(TransportPathConstants.NOTPARTIALSTOWAGE);
				// modify by liangfuxiang 2013-5-29上午9:36:24 end;
				
				// 更新走货路径
				// modify by liangfuxiang 2013-3-26上午9:47:08 begin BUG-5885
				//calculateTransportPathService.alterDetail(transportPathList.get(i).getWaybillNo(), null, transportPathList.get(i).getCurrentOrgCode(), transportPathList.get(i).getDestOrgCode(), transportPathList.get(i).getBillingOrgCode(), transportPathList.get(i).getTransportModel());
				calculateTransportPathService.alterDetailForRecreateTransportaionPath(transportPathList.get(i).getWaybillNo(), null, transportPathList.get(i).getCurrentOrgCode(), transportPathList.get(i).getDestOrgCode(), transportPathList.get(i).getBillingOrgCode(), transportPathList.get(i).getTransportModel());
				// modify by liangfuxiang 2013-3-26上午9:47:16 end;
				// 如果更改走货路径成功
				PathDetailEntity pathDetailEntity = new PathDetailEntity();
				pathDetailEntity.setWaybillNo(transportPathList.get(i).getWaybillNo());
				
				//BUG-50951 只显示开单时生成的走货路径 modify by songjie on 2013-08-14
				/*// 根据运单号找到走货路径list
				List<PathDetailEntity> pathDetailList = pathDetailDao.queryPathDetailList(pathDetailEntity);
				// 设置起始地
				StringBuffer path = new StringBuffer();
				path.append(getNameByCode(pathDetailList.get(0).getOrigOrgCode()));
				for (int j = 0; j < pathDetailList.size(); j++) {
					// 拼接走货路径全路径信息
					path.append("-");
					path.append(getNameByCode(pathDetailList.get(j).getObjectiveOrgCode()));
					// 如果明细表信息的出发部门等于现部门,则读区本条进行路径主表字段set
					if (pathDetailList.get(j).getOrigOrgCode().equals(transportPathList.get(i).getCurrentOrgCode())) {
						transportPathList.get(i).setCurrentOrgCode(pathDetailList.get(j).getOrigOrgCode());
						transportPathList.get(i).setNextOrgCode(pathDetailList.get(j).getObjectiveOrgCode());
						transportPathList.get(i).setPlanStartTime(pathDetailList.get(j).getPlanStartTime());
						transportPathList.get(i).setPlanArriveTime(pathDetailList.get(j).getPlanArriveTime());
					}
				}
				transportPathList.get(i).setTransportPath(path.toString());*/
			}
			
			// modify by liangfuxiang 2013-6-8下午4:42:51 begin 解决重新生成走货路径后，无法做交接单的问题--添加入库
			// 更改库存目的地---入库
			for (int s = 0; s < listGoodsNo.size(); s++) {
				// 新建入库实例
				InOutStockEntity inOutStockEntity = new InOutStockEntity();
				// 设置运载单号
				inOutStockEntity.setWaybillNO(transportPathList.get(i).getWaybillNo());
				// 设置序列号
				inOutStockEntity.setSerialNO(listGoodsNo.get(s));
				// 设置当前部门
				inOutStockEntity.setOrgCode(transportPathList.get(i).getCurrentOrgCode());
				// 设置操作员工工号
				inOutStockEntity.setOperatorCode(FossUserContext.getCurrentInfo().getEmpCode());
				// 设置操作员工姓名
				inOutStockEntity.setOperatorName(FossUserContext.getCurrentInfo().getEmpName());
				// 设置更改单类型
				inOutStockEntity.setInOutStockType(StockConstants.RECREATE_TRANSPATH_IN_STOCK_TYPE);
				// 入库
				stockService.inStockPC(inOutStockEntity);
			}
			// modify by liangfuxiang 2013-6-8下午4:42:57 end;
			
			
		}
		// 更新list
		return transportationPathDao.updateListTransportPath(transportPathList);
	}

	/**
	 * 
	 * @Title: querySuperiorOrgByOrgCode
	 * @Description: 根据当前部门获取查找顶级组织部门
	 * @param orgCode
	 * @return 设定文件
	 * @return OrgAdministrativeInfoEntity 返回类型
	 * @see querySuperiorOrgByOrgCode
	 * @author: liangfuxiang liangfux@cn.ibm.com
	 * @version: 2013-5-1 上午9:40:28
	 * @throws
	 */
	public OrgAdministrativeInfoEntity querySuperiorOrgByOrgCode(String orgCode) throws TfrBusinessException {

		// 设置查询参数
		List<String> bizTypesList = new ArrayList<String>();
		// 外场类型
		bizTypesList.add(BizTypeConstants.ORG_TRANSFER_CENTER);
		// 空运总调类型
		bizTypesList.add(BizTypeConstants.ORG_AIR_DISPATCH);
		// 营业部（派送部）
		bizTypesList.add(BizTypeConstants.ORG_SALES_DEPARTMENT);
		// 查询上级部门
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = orgAdministrativeInfoComplexService.queryOrgAdministrativeInfoIncludeSelfByCode(orgCode, bizTypesList);
		if (orgAdministrativeInfoEntity != null) {
			// 返回部门
			return orgAdministrativeInfoEntity;
		}
		else {
			// 获取上级部门失败
			logger.error("ReCreateTransportationPathService[querySuperiorOrgByOrgCode()]:" + TransportPathConstants.QUERY_TOP_ORG_BY_CURRENT_ORG_FAIL + orgCode);
			throw new TfrBusinessException(TransportPathConstants.QUERY_TOP_ORG_BY_CURRENT_ORG_FAIL_GLOB, new Object[] { orgCode });
		}
	}
	
	
	/** 
	* @Title: translateChinese2Code 
	* @Description: 将对应中文，转换为编码
	* @param transportPathList
	* @return  设定文件 
	* @return List<TransportPathEntity>    返回类型 
	* @see translateChinese2Code
	* @author: liangfuxiang liangfux@cn.ibm.com  
	* @version: 2013-3-25 下午2:14:12   
	* @throws 
	*/ 
	private List<TransportPathEntity> translateChinese2Code(List<TransportPathEntity> transportPathList) {
		// 建立对象列表
		List<TransportPathEntity> newTransportPathEntityList = new ArrayList<TransportPathEntity>();
		// 非空
		if (null != transportPathList && !transportPathList.isEmpty()) {
			// 遍历
			for (TransportPathEntity transportPathEntity : transportPathList) {
				//设置状态编码格式
				transportPathEntity.setAction(getActionCode(transportPathEntity.getAction()));
				//设置编码类型编码格式
				transportPathEntity.setTransportModel(getTransportModelCode(transportPathEntity.getTransportModel()));
				//设置路径
				transportPathEntity.setTransportPath(getTransportPathCode(transportPathEntity.getTransportPath()));
				//加入
				newTransportPathEntityList.add(transportPathEntity);
			}
		}
		return newTransportPathEntityList;
	}

	/**
	 * @Title: getTransportPathCode
	 * @Description: 设置路径
	 * @param transportPath
	 * @return 设定文件
	 * @return String 返回类型
	 * @see getTransportPathCode
	 * @author: liangfuxiang liangfux@cn.ibm.com
	 * @version: 2013-3-25 下午2:58:19
	 * @throws
	 */
	private String getTransportPathCode(String transportPath) {

		// 去空
		transportPath = StringUtils.trim(transportPath);

		if (StringUtils.isEmpty(transportPath) || TransportPathConstants.TRANSPORTPATH_NULL_CHINESE.equalsIgnoreCase(transportPath)) {
			transportPath = TransportPathConstants.SET_NULL_STRING;
		}

		// 记录路径
		logger.info("ReCreateTransportationPathService[getTransportPathCode()]:" + transportPath);
		return transportPath;
	}

	/**
	 * @Title: getTransportModelCode
	 * @Description:设置编码类型编码格式
	 * @param transportModel
	 * @return 设定文件
	 * @return String 返回类型
	 * @see getTransportModelCode
	 * @author: liangfuxiang liangfux@cn.ibm.com
	 * @version: 2013-3-25 下午2:23:16
	 * @throws
	 */
	private String getTransportModelCode(String transportModel) {
		// 去空
		transportModel = StringUtils.trim(transportModel);

		if (StringUtils.isEmpty(transportModel)) {
			// 设置空值
			transportModel = TransportPathConstants.PRICING_PRODUCT_AIR_FREIGHT_NULL;
		}
		else {
			// 精准空运
			if (TransportPathConstants.PRICING_PRODUCT_AIR_FREIGHT_CHINESE.equalsIgnoreCase(transportModel)) {
				transportModel = PricingConstants.ProductEntityConstants.PRICING_PRODUCT_AIR_FREIGHT;
			}
			// 整车
			else if (TransportPathConstants.PRICING_PRODUCT_FULL_VEHICLE_CHINESE.equalsIgnoreCase(transportModel)) {
				transportModel = PricingConstants.ProductEntityConstants.PRICING_PRODUCT_FULL_VEHICLE;
			}
			// 精准卡航
			else if (TransportPathConstants.PRICING_PRODUCT_LONG_DISTANCE_FAST_FREIGHT_CHINESE.equalsIgnoreCase(transportModel)) {
				transportModel = PricingConstants.ProductEntityConstants.PRICING_PRODUCT_LONG_DISTANCE_FAST_FREIGHT;
			}
			// 精准汽运(长途)
			else if (TransportPathConstants.PRICING_PRODUCT_LONG_DISTANCE_ROAD_FREIGHT_CHINESE.equalsIgnoreCase(transportModel)) {
				transportModel = PricingConstants.ProductEntityConstants.PRICING_PRODUCT_LONG_DISTANCE_ROAD_FREIGHT;
			}
			// 汽运偏线
			else if (TransportPathConstants.PRICING_PRODUCT_PARTIAL_LINE_CHINESE.equalsIgnoreCase(transportModel)) {
				transportModel = PricingConstants.ProductEntityConstants.PRICING_PRODUCT_PARTIAL_LINE;
			}
			// 精准城运
			else if (TransportPathConstants.PRICING_PRODUCT_SHORT_DISTANCE_FAST_FREIGHT_CHINESE.equalsIgnoreCase(transportModel)) {
				transportModel = PricingConstants.ProductEntityConstants.PRICING_PRODUCT_SHORT_DISTANCE_FAST_FREIGHT;
			}
			// 精准汽运(短途)
			else if (TransportPathConstants.PRICING_PRODUCT_SHORT_DISTANCE_ROAD_FREIGHT_CHINESE.equalsIgnoreCase(transportModel)) {
				transportModel = PricingConstants.ProductEntityConstants.PRICING_PRODUCT_SHORT_DISTANCE_ROAD_FREIGHT;
			}
			else {
				// 异常
				logger.error("ReCreateTransportationPathService[getTransportModelCode()]:" + TransportPathConstants.PRICING_PRODUCT_UNEFFECTIVE + TransportPathConstants.BLANK_SPACE_STRING
						+ transportModel);
				throw new TfrBusinessException(TransportPathConstants.PRICING_PRODUCT_UNEFFECTIVE_GLOB, new Object[] { transportModel });
			}
		}

		logger.info("ReCreateTransportationPathService[getTransportModelCode()]:transportModel:" + transportModel);

		return transportModel;
	}

	/**
	 * @param string
	 * @Title: getActionCode
	 * @Description: 设置状态编码格式
	 * @return 设定文件
	 * @return String 返回类型
	 * @see getActionCode
	 * @author: liangfuxiang liangfux@cn.ibm.com
	 * @version: 2013-3-25 下午2:21:13
	 * @throws
	 */
	private String getActionCode(String action) {

		action = StringUtils.trim(action);

		// 状态为空
		if (StringUtils.isEmpty(action)) {
			action = TransportPathConstants.TRANSPORTPATH_STATUS_BILLING_NULL;
		}
		else {
			// 到达
			if (TransportPathConstants.TRANSPORTPATH_STATUS_ARRIVE_CHINESE.equalsIgnoreCase(action)) {
				action = TransportPathConstants.TRANSPORTPATH_STATUS_ARRIVE;
			}
			// 开单
			else if (TransportPathConstants.TRANSPORTPATH_STATUS_BILLING_CHINESE.equalsIgnoreCase(action)) {
				action = TransportPathConstants.TRANSPORTPATH_STATUS_BILLING;
			}
			// 出发
			else if (TransportPathConstants.TRANSPORTPATH_STATUS_DEPART_CHINESE.equalsIgnoreCase(action)) {
				action = TransportPathConstants.TRANSPORTPATH_STATUS_DEPART;
			}
			// 已交接
			else if (TransportPathConstants.TRANSPORTPATH_STATUS_HANDOVER_CHINESE.equalsIgnoreCase(action)) {
				action = TransportPathConstants.TRANSPORTPATH_STATUS_HANDOVER;
			}
			// 库存中
			else if (TransportPathConstants.TRANSPORTPATH_STATUS_INSTORE_CHINESE.equalsIgnoreCase(action)) {
				action = TransportPathConstants.TRANSPORTPATH_STATUS_INSTORE;
			}
			// 未入库
			else if (TransportPathConstants.TRANSPORTPATH_STATUS_NOTINSTORE_CHINESE.equalsIgnoreCase(action)) {
				action = TransportPathConstants.TRANSPORTPATH_STATUS_NOTINSTORE;
			}
			// 签收
			else if (TransportPathConstants.TRANSPORTPATH_STATUS_SIGNIN_CHINESE.equalsIgnoreCase(action)) {
				action = TransportPathConstants.TRANSPORTPATH_STATUS_SIGNIN;
			}
			else {
				// 走货路径状态无效
				logger.error("ReCreateTransportationPathService[getActionCode()]:" + TransportPathConstants.TRANSPORTPATH_STATUS_UNEFFECTIVE + TransportPathConstants.BLANK_SPACE_STRING
						+ action);
				throw new TfrBusinessException(TransportPathConstants.TRANSPORTPATH_STATUS_UNEFFECTIVE_GLOB, new Object[] { action });
			}
		}

		logger.info("ReCreateTransportationPathService[getActionCode()] action:" + action);

		return action;
	}
	
	/**
	 * 根据组织code查询缓存获取name
	 * 
	 * @author huyue
	 * @date 2013-1-22 下午3:42:47
	 */
	public String getNameByCode(String orgCode) {
		String orgName = orgAdministrativeInfoService.queryCommonNameByCommonCodeFromCache(orgCode);
		if (StringUtils.isEmpty(orgName)) {
			return orgCode;
		} else {
			return orgName;
		}
	}
	
	/**
	 * 根据运单号、流水呈查询走货路径明细
	 * @author 038300-pengzhen
	 * @date 2013-05-29 上午10:26:32
	 */
	@Override
	public List<PathDetailEntity> queryPathDetail(String waybillNO,	String serialNO) {
		PathDetailEntity pathDetailEntity = new PathDetailEntity();
		pathDetailEntity.setWaybillNo(waybillNO);
		pathDetailEntity.setGoodsNo(serialNO);
		return pathDetailDao.querySimplePathDetailList(pathDetailEntity);
	}
	
	/**
	 * 根据运单号查询当前部门库存信息
	 * @author 038300-pengzhen
	 * @date 2013-05-29 上午10:26:32
	 */
	@Override
	public List<StockEntity> queryStock(String waybillNO, String orgCode) throws TfrBusinessException{
		if (StringUtil.isEmpty(orgCode)) {
			logger.info(TransportPathConstants.QUERY_TRANSPORTPATH_CURRENTORGCODE_NULL);
			orgCode = FossUserContext.getCurrentDeptCode();
		}
		// 根据当前组织编码获取组织信息
		OrgAdministrativeInfoEntity orgAdministrativeInfoEntity = querySuperiorOrgByOrgCode(orgCode);
		WaybillStockEntity waybillStockEntity= new WaybillStockEntity();
		waybillStockEntity.setWaybillNO(waybillNO);
		waybillStockEntity.setOrgCode(orgAdministrativeInfoEntity.getCode());
		return stockService.queryStock(waybillStockEntity);
	}
	
}