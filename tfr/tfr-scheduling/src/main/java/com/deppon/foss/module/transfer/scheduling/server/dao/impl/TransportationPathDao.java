/**
 *  initial comments.
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 *  
 */
/*******************************************************************************
 * Copyright 2013 TFR TEAM
 *  
 *  Licensed under the DEPPON License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *  
 *     http://www.deppon.com/licenses/LICENSE-2.0
 *  
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *  
 *  PROJECT NAME  : tfr-scheduling
 *  
 *  PACKAGE NAME  : 
 * 
 *  DESCRIPTION   : 调度、发车计划、排班、月台、车辆管理等
 *  
 *  FILE PATH     :src/main/java/com/deppon/foss/module/transfer/scheduling/server/dao/impl/TransportationPathDao.java
 * 
 *  FILE NAME     :TransportationPathDao.java
 *  
 *  AUTHOR        : FOSS中转开发组
 *  
 *  TIME          : 
 *  
 *  HOME PAGE     :  http://www.deppon.com
 *  
 *  COPYRIGHT     : Copyright (c) 2013  Deppon All Rights Reserved.
 * 
 *  VERSION       :0.1
 * 
 *  LAST MODIFY TIME:
 ******************************************************************************/
package com.deppon.foss.module.transfer.scheduling.server.dao.impl;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.collections.CollectionUtils;
import org.apache.cxf.common.util.StringUtils;
import org.apache.ibatis.session.RowBounds;

import com.deppon.foss.framework.server.components.dataaccess.ibatis.iBatis3DaoImpl;
import com.deppon.foss.module.transfer.common.api.shared.exception.TfrBusinessException;
import com.deppon.foss.module.transfer.scheduling.api.define.TransportPathConstants;
import com.deppon.foss.module.transfer.scheduling.api.server.dao.ITransportationPathDao;
import com.deppon.foss.module.transfer.scheduling.api.shared.domain.TransportPathEntity;
import com.deppon.foss.module.transfer.scheduling.api.shared.util.ConstantsNumberSonar;
import com.eos.system.utility.StringUtil;


/**
 * 走货路径dao实现
 * @author huyue
 * @date 2012-10-11 下午9:13:22
 */
public class TransportationPathDao extends iBatis3DaoImpl implements ITransportationPathDao{

	private static final String NAMESPACE = "Foss.transportPath.";
	
	/** 
	 * 查询货物走货路径LIST分页
	 * @author huyue
	 * @date 2012-10-11 下午9:13:58
	 * @see com.deppon.foss.module.transfer.scheduling.api.server.dao.IReCreateTransportationPathDao#queryTransportPath(com.deppon.foss.module.transfer.scheduling.api.shared.domain.TransportPathEntity, int, int)
	 */
	@SuppressWarnings("unchecked")
	@Override
	public List<TransportPathEntity> queryTransportPathforPage(TransportPathEntity transportPathEntity,
			int limit, int start) {
		
		
		RowBounds rowBounds = new RowBounds(start, limit);
		
		List<TransportPathEntity> transportPathList = this.getSqlSession().selectList(NAMESPACE + "ReCreateQuery", transportPathEntity, rowBounds);
		
		return transportPathList;
	}
	
	/** 
	 * 查询走货路径LIST的行数
	 * @author huyue
	 * @date 2012-10-11 下午9:17:45
	 * @see com.deppon.foss.module.transfer.scheduling.api.server.dao.IReCreateTransportationPathDao#getCount(com.deppon.foss.module.transfer.scheduling.api.shared.domain.TransportPathEntity)
	 */
	@Override
	public Long getCount(TransportPathEntity transportPathEntity) {
		
		return (Long)this.getSqlSession().selectOne(NAMESPACE + "getCount", transportPathEntity);
	}
	
	/**
	 * 查询走货路径LIST
	 * @author huyue
	 * @date 2012-10-18 下午3:25:06
	 */
	public List<TransportPathEntity> queryTransportPathList(TransportPathEntity transportPathEntity) {
		
		List<TransportPathEntity> transportPathList = this.getSqlSession().selectList(NAMESPACE + "transportPathQuery", transportPathEntity);
		
		return transportPathList;
	}
	
	/**
	 * 根据waybillNo查询一条走货路径信息
	 * @author huyue
	 * @date 2012-10-23 上午11:50:54
	 */
	@SuppressWarnings("unchecked")
	public TransportPathEntity queryTransportPath(String waybillNo) throws TfrBusinessException {
		// modify by liangfuxiang 2013-5-7下午5:42:44 begin 鉴于主表中同一运单有多条数据的情况，通过selectOne 方式查询会返回DAO级别的异常
		// 而无法捕获，现更改查询方式，转换为业务异常。同时，为降低业务逻辑变更的最小性，在此DAO方法中做业务逻辑处理
		// TransportPathEntity transportPathEntity = (TransportPathEntity) this.getSqlSession().selectOne(NAMESPACE + "selectByWaybillNo", waybillNo);
		// return transportPathEntity;
		List<TransportPathEntity> transportPathEntityList = this.getSqlSession().selectList(NAMESPACE + "selectByWaybillNo", waybillNo);
		// 返回多条
		if (CollectionUtils.isNotEmpty(transportPathEntityList) && transportPathEntityList.size() > 1) {
			// 抛出异常
			logger.error("TransportationPathDao[queryTransportPath()]:" + TransportPathConstants.SINGLE_WAYBILL_MULTI_TRANPORTPATH+waybillNo);
			throw new TfrBusinessException(TransportPathConstants.SINGLE_WAYBILL_MULTI_TRANPORTPATH+waybillNo);
		}
		else if (CollectionUtils.isEmpty(transportPathEntityList)) {
			// 未查询到，返回空
			return null;
		}
		else {
			return transportPathEntityList.get(0);
		}
		// modify by liangfuxiang 2013-5-7下午6:00:31 end;
	}
	
	/**
	 * 新增走货路径信息 自动筛选有值字段
	 * @author huyue
	 * @date 2012-10-18 下午2:56:21
	 */
	public int addTransportPathSelect(TransportPathEntity transportPathEntity) {
		String statement = NAMESPACE + "insertSelective";
		
		// modify by liangfuxiang 2013-6-21下午1:56:20 begin
		//验证走货路径
		transportPathEntity=verifyTransportPathEntity(transportPathEntity);
		
		return getSqlSession().insert(statement, transportPathEntity);
	}
	
	/** 
	* @Title: verifyTransportPathEntity 
	* @Description: 验证走货路径
	* @param transportPathEntity
	* @return  设定文件 
	* @return TransportPathEntity    返回类型 
	* @see verifyTransportPathEntity
	* @author: liangfuxiang liangfux@cn.ibm.com  
	* @version: 2013-6-21 下午1:28:21   
	* @throws 
	*/ 
	private TransportPathEntity verifyTransportPathEntity(TransportPathEntity transportPathEntity) {
		
		//判断运单号为空
		if(StringUtils.isEmpty(transportPathEntity.getWaybillNo())){
			logger.error("TransportationPathDao[verifyTransportPathEntity()]:"+TransportPathConstants.WAYBILL_NO_INSERT_IS_NULL);
			throw new TfrBusinessException(TransportPathConstants.WAYBILL_NO_INSERT_IS_NULL_GLOB);
		}
		
		//判断transportPath长度，超出1000个字节，共计约333个汉字，则需要截取
		transportPathEntity.setTransportPath(getValidTransportPath(transportPathEntity));
		
		return transportPathEntity;
	}

	/** 
	* @Title: getValidTransportPath 
	* @Description: 判断transportPath长度，超出1000个字节，共计约333个汉字，则需要截取
	* @param transportPath
	* @return  设定文件 
	* @return String    返回类型 
	* @see getValidTransportPath
	* @author: liangfuxiang liangfux@cn.ibm.com  
	* @version: 2013-6-21 下午1:40:58   
	* @throws 
	*/ 
	private String getValidTransportPath(TransportPathEntity transportPathEntity) {

		String transportPath = transportPathEntity.getTransportPath();
		// 为空或者长度小于1000个字节
		if (StringUtils.isEmpty(transportPath) || transportPath.getBytes().length <= ConstantsNumberSonar.SONAR_NUMBER_1000) {
			return transportPath;
		}
		else {
			//字符串截取
			String newTransportPath = transportPath.substring(0, ConstantsNumberSonar.SONAR_NUMBER_333);
			logger.info("TransportationPathDao[getValidTransportPath()]:" + TransportPathConstants.TRUNCATE_TRANSPORTPATH + transportPathEntity.getWaybillNo()
					+ TransportPathConstants.BEFORE_TRUNCATE_TRANSPORTPATH + transportPath + TransportPathConstants.AFTER_TRUNCATE_TRANSPORTPATH + newTransportPath);
			// 截取字符串
			return newTransportPath;
		}
	}

	/**
	 * 新增走货路径信息
	 * 
	 * @author huyue
	 * @date 2012-10-18 下午3:01:09
	 */
	public int addTransportPath(TransportPathEntity transportPathEntity) {
		String statement = NAMESPACE + "insert";
		// modify by liangfuxiang 2013-6-21下午1:56:02 begin
		transportPathEntity = verifyTransportPathEntity(transportPathEntity);
		return getSqlSession().insert(statement, transportPathEntity);
	}
	
	/**
	 * 批量新增走货路径信息
	 * 
	 * @author huyue
	 * @date 2012-10-18 下午4:26:42
	 */
	public int addListTransportPath(List<TransportPathEntity> transportPathList) {

		// modify by liangfuxiang 2013-6-21下午1:56:44 begin
		transportPathList = verifyTransportPathEntityList(transportPathList);

		return getSqlSession().insert(NAMESPACE + "insertList", transportPathList);
	}
	
	/** 
	* @Title: verifyTransportPathEntityList 
	* @Description: 验证走货路径
	* @param transportPathList
	* @return  设定文件 
	* @return List<TransportPathEntity>    返回类型 
	* @see verifyTransportPathEntityList
	* @author: liangfuxiang liangfux@cn.ibm.com  
	* @version: 2013-6-21 下午1:57:54   
	* @throws 
	*/ 
	private List<TransportPathEntity> verifyTransportPathEntityList(List<TransportPathEntity> transportPathList) {
		
		List<TransportPathEntity> newTransportPathList = new ArrayList<TransportPathEntity>();
		
		for(int i=0;i<transportPathList.size();i++){
			newTransportPathList.add(verifyTransportPathEntity(transportPathList.get(i)));
		}
		
		return newTransportPathList;
	}

	/**
	 * 根据PKID更新走货路径信息 自动筛选有值字段
	 * @author huyue
	 * @date 2012-10-18 下午3:01:33
	 */
	public int updateTransportPathSelect(TransportPathEntity transportPathEntity) {
		String statement = NAMESPACE + "updateByPrimaryKeySelective";

		// modify by liangfuxiang 2013-6-21下午2:01:41 begin
		transportPathEntity = verifyTransportPathEntity(transportPathEntity);

		return getSqlSession().insert(statement, transportPathEntity);
	}
	
	/**
	 * 根据PKID更新走货路径信息
	 * @author huyue
	 * @date 2012-10-18 下午3:02:37
	 */
	public int updateTransportPath(TransportPathEntity transportPathEntity) {
		String statement = NAMESPACE + "updateByPrimaryKey";
		// modify by liangfuxiang 2013-6-21下午2:01:41 begin
		transportPathEntity = verifyTransportPathEntity(transportPathEntity);
		return getSqlSession().insert(statement, transportPathEntity);
	}
	
	/**
	 * 批量更新走货路径信息
	 * @author huyue
	 * @date 2012-10-18 下午6:42:52
	 */
	public int updateListTransportPath(List<TransportPathEntity> transportPathList) {
		// modify by liangfuxiang 2013-6-21下午2:01:41 begin
		transportPathList = verifyTransportPathEntityList(transportPathList);
		return getSqlSession().insert(NAMESPACE + "updateList", transportPathList);
	}
	
	/**
	 * 批量更新走货路径信息 非空判断
	 * @author huyue
	 * @date 2012-11-2 下午2:01:58
	 */
	public int updateListTransportPathSelective(List<TransportPathEntity> transportPathList) {
		// modify by liangfuxiang 2013-6-21下午2:01:41 begin
		transportPathList = verifyTransportPathEntityList(transportPathList);
		return getSqlSession().insert(NAMESPACE + "updateListSelective", transportPathList);
	}

	/** 
	 * 删除走货路径信息
	 * @author huyue
	 * @date 2012-10-23 下午8:17:40
	 * @see com.deppon.foss.module.transfer.scheduling.api.server.dao.ITransportationPathDao#deleteTransportPath(com.deppon.foss.module.transfer.scheduling.api.shared.domain.TransportPathEntity)
	 */
	public int deleteTransportPath(TransportPathEntity transportPathEntity) {
		return getSqlSession().insert(NAMESPACE + "deleteByPrimaryKey", transportPathEntity);
	}

	  
	/*
	 * (non-Javadoc)
	 * 
	 * @see com.deppon.foss.module.transfer.scheduling.api.server.dao.ITransportationPathDao#migrateTransportPathData(java.util.Map)
	 */
	@Override
	public void migrateTransportPathData(Map<String, String> params) {
		this.getSqlSession().selectOne(NAMESPACE + "migrateTransportPathData", params);
	}

	  
	/*
	 * (non-Javadoc)
	 * 
	 * @see com.deppon.foss.module.transfer.scheduling.api.server.dao.ITransportationPathDao#queryTransportPathMigration(java.lang.String)
	 */

	@SuppressWarnings("unchecked")
	@Override
	public List<TransportPathEntity> queryTransportPathMigration(String waybillNo) {
		return this.getSqlSession().selectList(NAMESPACE+"queryTransportPathMigration", waybillNo);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see com.deppon.foss.module.transfer.scheduling.api.server.dao.ITransportationPathDao#recoverTransportPathMigration(java.lang.String)
	 */

	@Override
	public void recoverTransportPathMigration(String waybillNo) {
		this.getSqlSession().selectOne(NAMESPACE+"recoverTransportPathMigration", waybillNo);
	}

	  
	/*
	 * (non-Javadoc)
	 * 
	 * @see com.deppon.foss.module.transfer.scheduling.api.server.dao.ITransportationPathDao#getCountByWayBillNo(java.lang.String)
	 */

	@Override
	public Long getCountByWayBillNo(String waybillNo) {
		return (Long) this.getSqlSession().selectOne(NAMESPACE+"getCountByWayBillNo",waybillNo);
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see com.deppon.foss.module.transfer.scheduling.api.server.dao.ITransportationPathDao#queryLastInStockOrgCode(java.util.Map)
	 */
	@SuppressWarnings("unchecked")
	@Override
	public List<String> queryLastInStockOrgCode(Map<String, String> paramsMap) {
		return this.getSqlSession().selectList(NAMESPACE + "queryLastInStockOrgCode", paramsMap);
	}

	/**
	 * @author 106162
	 * @date 2017年3月24日 下午2:39:48
	 * @function 根据运单号、运单号流水号、当前操作部门 三个参数查询走货路径明细对应的下一站部门
	 * @param waybillNo、goodsNo、origOrgCode
	 * @return nextOrgName
	 */
	@Override
	public String queryPathByWgoDao(String waybillNo, String goodsNo,
			String origOrgCode) {
		Map<String,String> pathMap = new HashMap<String,String>();
		pathMap.put("waybillNo", waybillNo);
		pathMap.put("goodsNo", goodsNo);
		pathMap.put("origOrgCode", origOrgCode);
		//1、分批次根据流水号 
		String OrgName = (String)this.getSqlSession().selectOne(NAMESPACE+"queryObjectiveOrgNameByPath", pathMap);
		if(StringUtil.isEmpty(OrgName)){
			//2.不分批次就根据运单号获取
			OrgName = (String)this.getSqlSession().selectOne(NAMESPACE+"queryObjectiveOrgNameByPathOrg", pathMap);
		}
		return OrgName;
	}

}