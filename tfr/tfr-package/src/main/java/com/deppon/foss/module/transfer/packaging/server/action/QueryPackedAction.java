/**
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 *  initial comments.
 */
/*******************************************************************************
 * Copyright 2013 TFR TEAM
 *  
 *  Licensed under the DEPPON License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *  
 *     http://www.deppon.com/licenses/LICENSE-2.0
 *  
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *  Contributors:
 *  038300-foss-pengzhen - initial API and implementation
 * 
 *  PROJECT NAME  : tfr-package
 *  
 *  FILE PATH     : src/main/java/com/deppon/foss/module/transfer/packaging/server/action/QueryPackedAction.java
 *  
 *  FILE NAME          :QueryPackedAction.java
 * 
 *  AUTHOR  : FOSS中转系统开发组
 *  
 *  TIME              : 
 *  
 *  HOME PAGE    :  http://www.deppon.com
 * 
 *  COPYRIGHT    : Copyright (c) 2013  Deppon All Rights Reserved.
 ******************************************************************************/
/*
 * PROJECT NAME: tfr-package
 * PACKAGE NAME: com.deppon.foss.module.transfer.packaging.server.action
 * FILE    NAME: QueryPackedAction.java
 * COPYRIGHT: Copyright(c) 2012 Deppon All Rights Reserved.
 */ 
package com.deppon.foss.module.transfer.packaging.server.action;

import java.io.InputStream;
import java.io.UnsupportedEncodingException;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.List;

import org.apache.commons.lang.StringUtils;
import org.apache.struts2.ServletActionContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.deppon.foss.framework.exception.BusinessException;
import com.deppon.foss.framework.server.web.action.AbstractAction;
import com.deppon.foss.framework.server.web.result.json.annotation.JSON;
import com.deppon.foss.module.base.baseinfo.api.server.service.IEmployeeService;
import com.deppon.foss.module.base.baseinfo.api.shared.domain.EmployeeEntity;
import com.deppon.foss.module.base.common.api.server.service.IBusinessLockService;
import com.deppon.foss.module.base.common.api.shared.define.MutexElementType;
import com.deppon.foss.module.base.common.api.shared.dto.MutexElement;
import com.deppon.foss.module.base.dict.api.server.service.IDataDictionaryValueService;
import com.deppon.foss.module.base.dict.api.shared.define.DictionaryConstants;
import com.deppon.foss.module.base.dict.api.shared.domain.DataDictionaryValueEntity;
import com.deppon.foss.module.pickup.waybill.api.server.service.IWaybillManagerService;
import com.deppon.foss.module.pickup.waybill.shared.domain.WaybillEntity;
import com.deppon.foss.module.pickup.waybill.shared.dto.BarcodePrintLabelDto;
import com.deppon.foss.module.transfer.common.api.shared.exception.TfrBusinessException;
import com.deppon.foss.module.transfer.packaging.api.server.service.IPackCommonService;
import com.deppon.foss.module.transfer.packaging.api.server.service.IQueryPackedService;
import com.deppon.foss.module.transfer.packaging.api.shared.define.PackagingConstants;
import com.deppon.foss.module.transfer.packaging.api.shared.define.PackagingConstants.packing;
import com.deppon.foss.module.transfer.packaging.api.shared.domain.PackedPersonEntity;
import com.deppon.foss.module.transfer.packaging.api.shared.domain.QueryPackedResultEntity;
import com.deppon.foss.module.transfer.packaging.api.shared.domain.WaybillPackEntity;
import com.deppon.foss.module.transfer.packaging.api.shared.dto.QueryPackedDto;
import com.deppon.foss.module.transfer.packaging.api.shared.dto.ValidatePackedDto;
import com.deppon.foss.module.transfer.packaging.api.shared.exception.PackagingException;
import com.deppon.foss.module.transfer.packaging.api.shared.vo.QueryUnpackVo;
import com.deppon.foss.module.transfer.stock.api.shared.exception.StockException;

/**
 * 包装录入、查询和修改的ACTION层 
 * @author 046130-foss-xuduowei
 * @date 2012-10-17 上午8:08:10
 */
public class QueryPackedAction extends AbstractAction {
	
	/**
	 * 
	 */
	private static final long serialVersionUID = 6729005267441030243L;
	/**
	 * 日志
	 */
	private static final Logger LOGGER = LoggerFactory.getLogger(QueryPackedAction.class);

	/**
	 * SERVICE层接口
	 */
	private IQueryPackedService queryPackedService;
	/**
	 * 职员信息接口
	 */
	IEmployeeService employeeService;
	/**
	 * 数据字典
	 */
	private IDataDictionaryValueService dataDictionaryValueService;
	/**
	 * vo变量
	 */
	private QueryUnpackVo queryUnpackVo = new QueryUnpackVo();
	/**
	 * 导出Excel 文件流
	 */
	transient InputStream excelStream;
	/**
	 * 导出Excel 文件名
	 */
	private String fileName;
	/**
	 * 业务锁
	 */
	private IBusinessLockService businessLockService;
	
	/**
	 * 公用service
	 * */
	private IPackCommonService packCommonService;
	
	/**
	 * 接送货获取运单信息接口
	 */
	private IWaybillManagerService waybillManagerService;
	
	/**
	 * 
	 * 查询包装录入信息列表的ACTION层方法
	 * @author 046130-foss-xuduowei
	 * @date 2012-10-19 上午8:40:39
	 */
	@JSON
	public String queryPackedAll(){
		try {
			//根据查询条件查询所有已包装的运单信息
			List<QueryPackedResultEntity> queryPackedResultList = 
					queryPackedService.queryPackedAll(queryUnpackVo.getQueryPackedConditionEntity(), this.getLimit(), this.getStart());
			//查询符合条件的包装信息总数
			Long totalCount = queryPackedService.queryTotalCount(queryUnpackVo.getQueryPackedConditionEntity());
			//设置到vo
			this.setTotalCount(totalCount);
			//将结果集设置到vo
			queryUnpackVo.setQueryPackedResultList(queryPackedResultList);
			return returnSuccess();
		} catch (BusinessException e) {
			//如果有业务异常，则抛出
			return returnError(e);
		}
		
	}
	
	/**
	 * 
	 * 根据运单号查询运单的包装录入信息或者运单相关信息的ACTION层方法
	 * @author 046130-foss-xuduowei
	 * @date 2012-10-22 上午8:41:20
	 */
	@JSON
	public String queryWaybillInfo(){
		try {
			//根据运单编号，查询包装录入的各个信息
			if(StringUtils.isBlank(queryUnpackVo.getPackageType())){
				queryUnpackVo.setPackageType(packing.WOODEN_FRAME.getValue());
			}
			QueryPackedDto packDto = queryPackedService.queryWaybillPack(queryUnpackVo.getWaybillno(),queryUnpackVo.getPackageType());
			//分别对vo中各对象设值，便于前端获取
			//获取主信息
			//设置包装材料
			//packDto.getWaybillPackEntity().setPackedMate(queryUnpackVo.getPackageType());
			queryUnpackVo.setWaybillPackEntity(packDto.getWaybillPackEntity());
			//获取包装人员列表		
			queryUnpackVo.setPackedPersonList(packDto.getPackedPersonList());
			//获取新旧流水号关系列表		
			queryUnpackVo.setSerialRelationList(packDto.getSerialRelationList());
			//获取新流水号列表
			queryUnpackVo.setNewSerialList(packDto.getNewSerialRelationList());	
			//获取最大流水号
			queryUnpackVo.setMaxSerialNo(packDto.getMaxSerialNo());
			return returnSuccess();
		} catch (BusinessException e) {
			//如果有业务异常，则抛出
			return returnError(e);
		}
	}
	
	/**
	 * 
	 * 前端要获取递增流水号必须从服务端得到
	 * @author 046130-foss-xuduowei
	 * @date 2012-10-22 上午8:42:08
	 */
	@JSON
	public String queryMaxSerialNo(){
		//获取最大流水号，
		//前端在合并流水号的时候，获取最大流水号应从后台获取，保证信息唯一性
		//从而降低复杂度
		String maxSerialNo = queryPackedService.obtainMaxSerialNo(queryUnpackVo.getSerialNo(),1);
		//设置到vo
		queryUnpackVo.setMaxSerialNo(maxSerialNo);
		return returnSuccess();
	}
	
	/**
	 * 
	 * 包装录入的ACTION层方法
	 * @author 046130-foss-xuduowei
	 * @date 2012-10-22 上午8:43:17
	 */
	@JSON
	public String addPackageInfo(){
		MutexElement mutex = null;
		try {
			//保存包装录入信息
			//根据数据结构，可分为三部分
			//1、包装录入主信息
			//2、流水号关系信息
			//3、包装人员信息
			WaybillPackEntity waybillPackEntity  = queryUnpackVo.getWaybillPackEntity();
			String lockStr = waybillPackEntity.getWayBillNumber() + waybillPackEntity.getGoodsName() + waybillPackEntity.getPackRequire();
			mutex = new MutexElement(lockStr,PackagingConstants.PACKAGING_ADD_LOCK_DESC, MutexElementType.PACKAGING_PACKED);
			// 锁定
			boolean flag = businessLockService.lock(mutex, 0);
			if(flag){
				/**
				 * @author 105795
				 * @desc 校验加托个数是否正确
				 * @date 2014-08-20
				 * */
				validateMask();
				
				queryPackedService.addPackageInfo(waybillPackEntity,
						queryUnpackVo.getSerialRelationList(),queryUnpackVo.getNewSerialList(), queryUnpackVo.getPackedPersonList());
				
			businessLockService.unlock(mutex);
			}else {
				throw new PackagingException("已有运单在录入，请稍后......");
			}
			
			return returnSuccess();
		} catch (BusinessException e) {
			// 解锁
			businessLockService.unlock(mutex);
			//如果有业务异常，则抛出
			return returnError(e);
		}catch (Exception e) {// 捕捉异常
			// 解锁
			businessLockService.unlock(mutex);
			LOGGER.error(e.getMessage());
			// 返回错误信息
			return super.returnError(e.toString(), "");
		}

		
	}
	
	/**
	 * 还原
	 * @author 134019-foss-yuyongxiang
	 * @date 2013年12月4日 13:25:10
	 */
	@JSON
	public String deleteWaybillPack(){
		try {
			
			queryPackedService.deleteWaybillPack(queryUnpackVo.getWaybillno(),queryUnpackVo.getPackageType());
			
			return returnSuccess();
		} catch (BusinessException e) {
			//如果有业务异常，则抛出
			return returnError(e);
		}catch (Exception e) {// 捕捉异常
			LOGGER.error(e.getMessage());
			// 返回错误信息
			return super.returnError(e.toString(), "");
		}
		
		
	}
	
	/**
	 * 
	 * 获取包装材料
	 * @author 046130-foss-xuduowei
	 * @date 2012-11-9 上午10:30:37
	 */
	@JSON
	public String queryPackedMate(){
		//获取下拉框数据，参数从常量里取
		List<DataDictionaryValueEntity> packedMateList = 
				dataDictionaryValueService.queryDataDictionaryValueByTermsCode(
						DictionaryConstants.PACKAGING_PACKED_MATERIAL);
		queryUnpackVo.setPackedMateList(packedMateList);
		return returnSuccess();
		
	}
	
	/**
	 * 
	 * 选择打印新标签时，从后台获取新标签
	 * @author 046130-foss-xuduowei
	 * @date 2012-10-25 上午11:36:58
	 */
	@JSON
	public String queryNewSerialNo(){
		try {
			//获取新流水号信息，让前端查询打印
			QueryPackedDto packDto = queryPackedService.queryNewSerialNo(queryUnpackVo.getWaybillno());
			//设置新流水号到VO
			queryUnpackVo.setNewSerialList(packDto.getNewSerialRelationList());
			//设置流水号关系到VO，为何要传输流水号关系呢
			//前端需要展示新流水号由哪些旧流水号合并
			queryUnpackVo.setSerialRelationList(packDto.getSerialRelationList());
			return returnSuccess();
		} catch (BusinessException e) {
			//如果有业务异常，则抛出
			return returnError(e);
		}
	}
	
	/**
	 * 
	 * 根据姓名或工号得到姓名或工号
	 * @author 046130-foss-xuduowei
	 * @date 2012-10-30 上午10:57:47
	 */
	@JSON
	public String queryPackedPerson(){
		//new一个包装人员对象
		PackedPersonEntity packedPersonEntity = new PackedPersonEntity();
		//new一个包装人员集合
		List<PackedPersonEntity> packedPersonList = new ArrayList<PackedPersonEntity>();
		//根据员工号获取员工对象
		EmployeeEntity employee = employeeService.queryEmployeeByEmpCode(queryUnpackVo.getEmpCode());
		//如果员工号不为空，则设置到vo中
		//否则抛出错误信息
		if(employee!=null){
			//设置员工号
			packedPersonEntity.setEmpCode(employee.getEmpCode());
			//设置员工姓名
			packedPersonEntity.setEmpName(employee.getEmpName());
			//增加到集合中
			packedPersonList.add(packedPersonEntity);
			//设置到vo
			queryUnpackVo.setPackedPersonList(packedPersonList);
			return returnSuccess();
		}else{
			return returnError("未查询对应工号的包装人");
		}
		
	}
	
	/**
	 * 
	 * 打印新流水号
	 * @author 046130-foss-xuduowei
	 * @date 2012-11-6 上午11:55:50
	 */
	@JSON
	public String printNewSerialNo(){
		try {
			//获取需要打印的标签集合，因为中转的流水号有可能分批配载
			//所以每个流水号的打印信息可能不同，所以返回的是集合
			List<BarcodePrintLabelDto> barcodePrintLabelDtoList = queryPackedService.printNewSerialNo(queryUnpackVo.getWaybillno(), 
					queryUnpackVo.getNewSerialList());
			//将打印信息设置到vo中
			queryUnpackVo.setBarcodePrintLabelDtoList(barcodePrintLabelDtoList);
			return returnSuccess();
		} catch (BusinessException e) {
			//如果有业务异常，则抛出
			return returnError(e);
		}
	}
	
	/**
	 * 
	 * @author 046130-foss-xuduowei
	 * @date 2013-03-22 下午4:16:43
	 */
	public String exportExcel(){
		try {
			// 导出文件名
			fileName = this.encodeFileName(PackagingConstants.PACKAGING_EXPORT_FILE_NAME_PACKED);
			// 导出文件流
			excelStream = queryPackedService.exportExcelStream(queryUnpackVo.getQueryPackedConditionEntity());
		} catch (BusinessException e) {
			LOGGER.error(e.getErrorCode());
			return returnError(e);
		}catch (Exception e) {
			//LOGGER.error(ScheduleConstants.SCHEDULE_EXCEPTION, e);
			return super.returnError(e.toString(), "");
		}
		return returnSuccess();
	}
	/**
	 * 
	 * 将成功打印的流水号记录到数据库中
	 * @author 046130-foss-xuduowei
	 * @date 2013-6-29 上午11:55:50
	 */
	@JSON
	public String insertLabelRecord(){
		queryPackedService.insertLabelRecord(queryUnpackVo.getWaybillno(), queryUnpackVo.getSerialNo());
		return returnSuccess();
	}
	
	/**
	 * set,get方法
	 */
	
	public void setQueryPackedService(IQueryPackedService queryPackedService) {
		this.queryPackedService = queryPackedService;
	}

	/**
	 * 获取 vo变量.
	 *
	 * @return the vo变量
	 */
	public QueryUnpackVo getQueryUnpackVo() {
		return queryUnpackVo;
	}

	/**
	 * 设置 vo变量.
	 *
	 * @param queryUnpackVo the new vo变量
	 */
	public void setQueryUnpackVo(QueryUnpackVo queryUnpackVo) {
		this.queryUnpackVo = queryUnpackVo;
	}

	/**
	 * 设置 职员信息接口.
	 *
	 * @param employeeService the new 职员信息接口
	 */
	public void setEmployeeService(IEmployeeService employeeService) {
		this.employeeService = employeeService;
	}

	/**
	 * 设置 数据字典.
	 *
	 * @param dataDictionaryValueService the new 数据字典
	 */
	public void setDataDictionaryValueService(
			IDataDictionaryValueService dataDictionaryValueService) {
		this.dataDictionaryValueService = dataDictionaryValueService;
	}

	public InputStream getExcelStream() {
		return excelStream;
	}

	public String getFileName() {
		return fileName;
	}

	public void setBusinessLockService(IBusinessLockService businessLockService) {
		this.businessLockService = businessLockService;
	}
	
	/**
	 * 生成导出文件名称
	 * @author yuyongxiang
	 * @date 2013年10月11日 11:38:30
	 */
	public String encodeFileName(String fileName) throws BusinessException {
		try {
			String returnStr;
			String agent = (String) ServletActionContext.getRequest().getHeader("USER-AGENT");
			if (agent != null && agent.indexOf("MSIE") == -1) {
				returnStr = new String(fileName.getBytes("UTF-8"), "iso-8859-1");
			} else {
				returnStr = URLEncoder.encode(fileName, "UTF-8");
			}
			return returnStr;
		} catch (UnsupportedEncodingException e) {
			LOGGER.error("转换文件名编码失败", e);
			throw new BusinessException(StockException.EXPORT_FILE_ERROR_CODE, "");
		}
	}
	

	/**
	 * 
	 * @author 105795-foss-wqh
	 * @date 2014-08-19 下午4:16:43
	 * @desc 校验木托个数的正确性
	 */
	@JSON
	public String validatePackedMask(){
		
		try {
			
			validateMask();
			
			return returnSuccess();
		} catch (TfrBusinessException e) {
			// TODO: handle exception
			return returnError(e);
		}
		
	}

	/**
	 * 写个公共的方法来校验加托个数的正确性
	 * 
	 * */
	
	private void validateMask()
	{
		//获取运单信息
		String waybillNo=queryUnpackVo.getWaybillPackEntity().getWayBillNumber();
		//判断加托个数是否为整数
		int maskQty=0;
		try {
		  maskQty= Integer.parseInt(queryUnpackVo.getWaybillPackEntity().getPlusNum().toString());
			
		} catch (TfrBusinessException e) {
			throw new TfrBusinessException("加托个数只能为整数");
		}
		
		
		if(StringUtils.isEmpty(waybillNo))
		{
			throw new BusinessException("运单号为空");
		}
		WaybillEntity waybillEntity=null;
		try {
			 waybillEntity=waybillManagerService.queryWaybillBasicByNo(waybillNo);
			
		} catch (Exception e) {
			// TODO: handle exception
			
			throw new TfrBusinessException("调接送货 查询运单信息接口异常："+e.getMessage());
			
		}
		if(waybillEntity==null)
		{
			throw new TfrBusinessException("运单信息不存在");
		}
		ValidatePackedDto validatePackeddto=new ValidatePackedDto();
		validatePackeddto.setWaybillNo(waybillNo);
		validatePackeddto.setMaskQty(maskQty);
		//访问后台进行校验
		packCommonService.checkWoodMask(waybillEntity, validatePackeddto);
	}
	
	
	public void setPackCommonService(IPackCommonService packCommonService) {
		this.packCommonService = packCommonService;
	}

	public void setWaybillManagerService(
			IWaybillManagerService waybillManagerService) {
		this.waybillManagerService = waybillManagerService;
	}
	
	
}