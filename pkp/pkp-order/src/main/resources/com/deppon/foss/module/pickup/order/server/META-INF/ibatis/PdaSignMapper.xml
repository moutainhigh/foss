<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
	namespace="com.deppon.foss.module.pickup.order.api.shared.domain.PdaSignEntity">
	<resultMap id="BaseResultMap"
		type="com.deppon.foss.module.pickup.order.api.shared.domain.PdaSignEntity">
		<id column="ID" property="id" jdbcType="VARCHAR" />
		<result column="DEVICE_NO" property="deviceNo" jdbcType="VARCHAR" />
		<result column="DRIVER_NAME" property="driverName" jdbcType="VARCHAR" />
		<result column="DRIVER_CODE" property="driverCode" jdbcType="VARCHAR" />
		<result column="VEHICLE_NO" property="vehicleNo" jdbcType="VARCHAR" />
		<result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" />
		<result column="UNBUNDLER" property="unbundler" jdbcType="VARCHAR" />
		<result column="UNBUNDLER_CODE" property="unbundlerCode"
			jdbcType="VARCHAR" />
		<result column="UNBUNDLE_REASON" property="unbundleReason"
			jdbcType="VARCHAR" />
		<result column="UNBUNDLE_TIME" property="unbundleTime"
			jdbcType="TIMESTAMP" />
		<result column="STATUS" property="status" jdbcType="CHAR" />
		<result column="USER_TYPE" property="userType" jdbcType="VARCHAR" />
	</resultMap>
	<sql id="Base_Column_List">
		ID, DEVICE_NO, DRIVER_NAME, DRIVER_CODE, VEHICLE_NO,
		CREATE_TIME,
		UNBUNDLER, UNBUNDLER_CODE,
		UNBUNDLE_REASON, UNBUNDLE_TIME,
		STATUS,
		USER_TYPE
	</sql>

	<!--OwnTruckDto结果映射 -->
	<resultMap id="OwnTruckResultMap"
		type="com.deppon.foss.module.pickup.order.api.shared.dto.OwnTruckDto">
		<result column="VEHICLE_NO" property="vehicleNo" jdbcType="VARCHAR" />
		<result column="DRIVER_CODE" property="driverCode" jdbcType="VARCHAR" />
		<result column="DRIVER_NAME" property="driverName" jdbcType="VARCHAR" />
		<result column="VEHICLE_TYPE" property="vehicleType" jdbcType="VARCHAR" />
		<result column="DEVICE_NO" property="deviceNo" jdbcType="VARCHAR" />
		<result column="DRIVER_MOBILE" property="driverMobile"
			jdbcType="VARCHAR" />
		<result column="VEHICLE_LENGTH" property="vehicleType"
			jdbcType="VARCHAR" />
		<result column="SELF_VOLUME" property="netVolume" jdbcType="VARCHAR" />
		<result column="SELF_WEIGHT" property="netWeight" jdbcType="VARCHAR" />
		<result column="REMAINING_WEIGHT" property="remainingWeight"
			jdbcType="TIMESTAMP" />
		<result column="REMAINING_VOLUME" property="remainingVolume"
			jdbcType="VARCHAR" />
		<result column="ISPDABUNDLE" property="isPdaBundle" jdbcType="VARCHAR" />
		<result column="REGION_NAME" property="ownedZoneName" jdbcType="VARCHAR" />
		<result column="REGION_CODE" property="ownedZoneCode" jdbcType="VARCHAR" />
	</resultMap>

	<!-- OwnTruckSignOrSchedulingDto结果映射 -->
	<resultMap id="OwnTruckSignOrSchedulingResultMap"
		type="com.deppon.foss.module.pickup.order.api.shared.dto.OwnTruckSignOrSchedulingDto">
		<result column="VEHICLE_NO" property="vehicleNo" jdbcType="VARCHAR" />
		<result column="SIGN_DRIVER_CODE" property="signDriverCode"
			jdbcType="VARCHAR" />
		<result column="SCHEDULING_DRIVER_CODE" property="schedulingDriverCode"
			jdbcType="VARCHAR" />
		<result column="SIGN_DRIVER_NAME" property="signDriverName"
			jdbcType="VARCHAR" />
		<result column="SCHEDULING_DRIVER_NAME" property="schedulingDriverName"
			jdbcType="VARCHAR" />
		<result column="VEHICLE_LENGTH" property="vehicleType"
			jdbcType="VARCHAR" />
		<result column="DEVICE_NO" property="deviceNo" jdbcType="VARCHAR" />
		<result column="SIGN_DRIVER_MOBILE" property="signDriverMobile"
			jdbcType="VARCHAR" />
		<result column="SCHEDULING_DRIVER_MOBILE" property="schedulingDriverMobile"
			jdbcType="VARCHAR" />
		<result column="SELF_VOLUME" property="netVolume" jdbcType="VARCHAR" />
		<result column="SELF_WEIGHT" property="netWeight" jdbcType="VARCHAR" />
		<result column="REMAINING_WEIGHT" property="remainingWeight"
			jdbcType="TIMESTAMP" />
		<result column="REMAINING_VOLUME" property="remainingVolume"
			jdbcType="VARCHAR" />
		<result column="REGION_NAME" property="ownedZoneName" jdbcType="VARCHAR" />
		<result column="REGION_CODE" property="ownedZoneCode" jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="CourierResultMap"
		type="com.deppon.foss.module.pickup.order.api.shared.dto.CourierSignDto">
		<result column="VEHICLE_NO" property="vehicleNo" jdbcType="VARCHAR" />
		<result column="DRIVER_NAME" property="courierName"
			jdbcType="VARCHAR" />
		<result column="DRIVER_CODE" property="courierCode"
			jdbcType="VARCHAR" />
		<result column="COURIER_TYPE" property="courierType"
			jdbcType="VARCHAR" />
		<result column="BIG_REGION_NAME" property="bigZoneName"
			jdbcType="VARCHAR" />
		<result column="BIG_REGION_CODE" property="bigZoneCode"
			jdbcType="VARCHAR" />
		<result column="SMALL_REGION_NAME" property="smallZoneName" 
		jdbcType="VARCHAR" />
		<result column="SMALL_REGION_CODE" property="smallZoneCode"
			jdbcType="VARCHAR" />
	</resultMap>
	
	<resultMap id="DriverResultMap"
		type="com.deppon.foss.module.pickup.order.api.shared.dto.OwnTruckSignDto">
		<result column="VEHICLE_NO" property="vehicleNo" jdbcType="VARCHAR" />
		<result column="DRIVER_NAME" property="driverName"
			jdbcType="VARCHAR" />
		<result column="DRIVER_CODE" property="driverCode"
			jdbcType="VARCHAR" />
		<result column="VEHICLE_LENGTH" property="vehicleNoType"
			jdbcType="VARCHAR" />
		<result column="WORK_STATUS" property="recieveOrderStatus"
			jdbcType="VARCHAR" />
		<result column="REGION_NAME" property="regionName"
			jdbcType="VARCHAR" />
		<result column="REGION_CODE" property="regionCode"
			jdbcType="VARCHAR" />
		<result column="SIGN_WAYBILL_TOTAL" property="signWaybillTotal" jdbcType="DECIMAL"  />
		<result column="DELIVER_WAYBILL_TOTAL" property="deliverWaybillTotal" jdbcType="DECIMAL"  />
		<result column="RECEIVE_ORDER_TOTAL" property="receiveOrderTotal" jdbcType="DECIMAL"  />
		<result column="RECEIVE_WAYBILL_ORDER_TOTAL" property="receiveWaybillOrderTotal" jdbcType="DECIMAL"  />
	</resultMap>
	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.String">
		select
		<include refid="Base_Column_List" />
		from PKP.T_SRV_PDA_SIGN
		where ID = #{id,jdbcType=VARCHAR}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.String">
		delete from
		PKP.T_SRV_PDA_SIGN
		where ID = #{id,jdbcType=VARCHAR}
	</delete>
	<insert id="insert"
		parameterType="com.deppon.foss.module.pickup.order.api.shared.domain.PdaSignEntity">
		insert into /*模块：接送货-PDA签到-签到记录*/PKP.T_SRV_PDA_SIGN (ID,
		DEVICE_NO,
		DRIVER_NAME,
		DRIVER_CODE, VEHICLE_NO, CREATE_TIME,
		UNBUNDLER,
		UNBUNDLER_CODE, UNBUNDLE_REASON,
		UNBUNDLE_TIME, STATUS)
		values
		(#{id,jdbcType=VARCHAR}, #{deviceNo,jdbcType=VARCHAR},
		#{driverName,jdbcType=VARCHAR},
		#{driverCode,jdbcType=VARCHAR},
		#{vehicleNo,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP},
		#{unbundler,jdbcType=VARCHAR}, #{unbundlerCode,jdbcType=VARCHAR},
		#{unbundleReason,jdbcType=VARCHAR},
		#{unbundleTime,jdbcType=TIMESTAMP},
		#{status,jdbcType=CHAR})
	</insert>
	<insert id="insertSelective"
		parameterType="com.deppon.foss.module.pickup.order.api.shared.domain.PdaSignEntity">
		insert into /*模块：接送货-PDA签到-签到记录*/PKP.T_SRV_PDA_SIGN
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				ID,
			</if>
			<if test="deviceNo != null">
				DEVICE_NO,
			</if>
			<if test="driverName != null">
				DRIVER_NAME,
			</if>
			<if test="driverCode != null">
				DRIVER_CODE,
			</if>
			<if test="vehicleNo != null">
				VEHICLE_NO,
			</if>
			<if test="createTime != null">
				CREATE_TIME,
			</if>
			<if test="unbundler != null">
				UNBUNDLER,
			</if>
			<if test="unbundlerCode != null">
				UNBUNDLER_CODE,
			</if>
			<if test="unbundleReason != null">
				UNBUNDLE_REASON,
			</if>
			<if test="unbundleTime != null">
				UNBUNDLE_TIME,
			</if>
			<if test="status != null">
				STATUS,
			</if>
			<if test="userType != null">
				USER_TYPE,
			</if>
			<if test="orgCode != null">
				ORG_CODE
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=VARCHAR},
			</if>
			<if test="deviceNo != null">
				#{deviceNo,jdbcType=VARCHAR},
			</if>
			<if test="driverName != null">
				#{driverName,jdbcType=VARCHAR},
			</if>
			<if test="driverCode != null">
				#{driverCode,jdbcType=VARCHAR},
			</if>
			<if test="vehicleNo != null">
				#{vehicleNo,jdbcType=VARCHAR},
			</if>
			<if test="createTime != null">
				#{createTime,jdbcType=TIMESTAMP},
			</if>
			<if test="unbundler != null">
				#{unbundler,jdbcType=VARCHAR},
			</if>
			<if test="unbundlerCode != null">
				#{unbundlerCode,jdbcType=VARCHAR},
			</if>
			<if test="unbundleReason != null">
				#{unbundleReason,jdbcType=VARCHAR},
			</if>
			<if test="unbundleTime != null">
				#{unbundleTime,jdbcType=TIMESTAMP},
			</if>
			<if test="status != null">
				#{status,jdbcType=CHAR},
			</if>
			<if test="userType != null">
				#{userType,jdbcType=VARCHAR},
			</if>
			<if test="orgCode != null">
				#{orgCode,jdbcType=VARCHAR}
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective"
		parameterType="com.deppon.foss.module.pickup.order.api.shared.domain.PdaSignEntity">
		update /*模块：接送货-查询解除司机签到-更新签到记录*/PKP.T_SRV_PDA_SIGN
		<set>
			<if test="deviceNo != null">
				DEVICE_NO = #{deviceNo,jdbcType=VARCHAR},
			</if>
			<if test="driverName != null">
				DRIVER_NAME = #{driverName,jdbcType=VARCHAR},
			</if>
			<if test="driverCode != null">
				DRIVER_CODE = #{driverCode,jdbcType=VARCHAR},
			</if>
			<if test="vehicleNo != null">
				VEHICLE_NO = #{vehicleNo,jdbcType=VARCHAR},
			</if>
			<if test="createTime != null">
				CREATE_TIME = #{createTime,jdbcType=TIMESTAMP},
			</if>
			<if test="unbundler != null">
				UNBUNDLER = #{unbundler,jdbcType=VARCHAR},
			</if>
			<if test="unbundlerCode != null">
				UNBUNDLER_CODE = #{unbundlerCode,jdbcType=VARCHAR},
			</if>
			<if test="unbundleReason != null">
				UNBUNDLE_REASON = #{unbundleReason,jdbcType=VARCHAR},
			</if>
			<if test="unbundleTime != null">
				UNBUNDLE_TIME = #{unbundleTime,jdbcType=TIMESTAMP},
			</if>
			<if test="status != null">
				STATUS = #{status,jdbcType=CHAR},
			</if>
			<if test="userType != null">
				USER_TYPE = #{userType,jdbcType=CHAR},
			</if>
		</set>
		where ID = #{id,jdbcType=VARCHAR}
	</update>
	<update id="updateByPrimaryKey"
		parameterType="com.deppon.foss.module.pickup.order.api.shared.domain.PdaSignEntity">
		update PKP.T_SRV_PDA_SIGN
		set DEVICE_NO =
		#{deviceNo,jdbcType=VARCHAR},
		DRIVER_NAME =
		#{driverName,jdbcType=VARCHAR},
		DRIVER_CODE =
		#{driverCode,jdbcType=VARCHAR},
		VEHICLE_NO =
		#{vehicleNo,jdbcType=VARCHAR},
		CREATE_TIME =
		#{createTime,jdbcType=TIMESTAMP},
		UNBUNDLER =
		#{unbundler,jdbcType=VARCHAR},
		UNBUNDLER_CODE =
		#{unbundlerCode,jdbcType=VARCHAR},
		UNBUNDLE_REASON =
		#{unbundleReason,jdbcType=VARCHAR},
		UNBUNDLE_TIME =
		#{unbundleTime,jdbcType=TIMESTAMP},
		STATUS = #{status,jdbcType=CHAR}
		where ID
		= #{id,jdbcType=VARCHAR}
	</update>
	<!--liding add for NCI -->
	<update id="updatePosUnbundle">
		UPDATE /*模块：接送货-查询解除POS机签到-更新为已解绑*/pkp.t_srv_pda_sign
		<set>
			<if test="status != null">
				STATUS = #{status,jdbcType=CHAR},
			</if>
		</set>
		<where>
			<![CDATA[ CREATE_TIME > sysdate - 1
			and CREATE_TIME < sysdate ]]>
			<if test="userType != null and userType != '' ">
				AND USER_TYPE= #{userType,jdbcType=VARCHAR}
			</if>
			<if test="originStatus != null and originStatus != '' ">
				AND STATUS= #{originStatus,jdbcType=VARCHAR}
			</if>
		</where>
	</update>

	<sql id="OwnTruck_Column">
		S.DEVICE_NO,
		S.DRIVER_NAME,
		S.DRIVER_CODE,
		S.VEHICLE_NO,
		VL.VEHICLE_LENGTH_NAME VEHICLE_TYPE,
		A.REMAINING_WEIGHT,
		A.REMAINING_VOLUME,
		TK.SELF_VOLUME,
		TK.SELF_WEIGHT,
		'Y' ISPDABUNDLE,
		to_char(wmsys.wm_concat(V.REGION_NAME) over (partition BY
		S.VEHICLE_NO)) REGION_NAME,
		to_char(wmsys.wm_concat(sm.REGION_CODE) over
		(partition BY S.VEHICLE_NO)) REGION_CODE,
		D.EMP_PHONE DRIVER_MOBILE
	</sql>

	<!-- 查询签到表中所有本车队的信息 -->
	<select id="querySign" resultMap="OwnTruckResultMap">
		select /*模块：接送货-处理订单-查询签到表中所有本车队的信息*/
		<include refid="OwnTruck_Column" />
		From
		PKP.T_SRV_PDA_SIGN S
		join
		PKP.T_SRV_VEHICLE_ACTUALSITUATION A on
		S.VEHICLE_NO = A.VEHICLE_NO
		join BSE.T_BAS_OWN_TRUCK TK on
		TK.VEHICLE_NO = S.VEHICLE_NO
		join bse.t_bas_vehicle_type_length VL on TK.VEHICLE_LENGHT_CODE =
		VL.VEHICLE_LENGTH_CODE
		left join BSE.T_BAS_REGION_VEHICLE V on
		V.VEHICLE_NO = S.VEHICLE_NO
		and V.REGION_TYPE = #{regionType,jdbcType=VARCHAR}
		and V.REGION_NATURE = #{regionNature,jdbcType=VARCHAR}
		and V.ACTIVE = #{active,jdbcType=VARCHAR}
		left join bse.t_bas_service_smallzone sm /*14.7.29 gcl AUTO-212 联合接送货小区表获得小区编码 */
    	on sm.virtual_code = v.region_code and sm.region_type=v.region_type and sm.ACTIVE = #{active,jdbcType=VARCHAR}
		join BSE.T_BAS_OWNDRIVER D ON
		D.EMP_CODE = S.DRIVER_CODE and D.ACTIVE = #{active,jdbcType=VARCHAR}
		where
		S.STATUS = #{bundleStatus,jdbcType=VARCHAR}
		and TK.ACTIVE = #{active,jdbcType=VARCHAR}
		and VL.ACTIVE = #{active,jdbcType=VARCHAR}
		<choose>
			<when test="fleetCodeList != null and fleetCodeList.size() > 0">
				and TK.ORG_ID in
				<foreach collection="fleetCodeList" item="item" index="index"
					open="(" separator="," close=")">
					#{item}
				</foreach>
			</when>
			<when test="serviceFleetCode != null and serviceFleetCode != ''">
				and TK.ORG_ID = #{serviceFleetCode,jdbcType=VARCHAR}
			</when>
			<otherwise>
				<if test="orgCode != null and orgCode != ''">
					and TK.ORG_ID = #{orgCode,jdbcType=VARCHAR}
				</if>
			</otherwise>
		</choose>
	</select>

	<!-- 根据司机编码查询签到表中所有本车队的信息 -->
	<select id="querySignByDriverCode" resultMap="OwnTruckResultMap">
		select /*模块：接送货-处理订单-根据司机编码查询签到表中所有本车队的信息*/
		<include refid="OwnTruck_Column" />
		From
		PKP.T_SRV_PDA_SIGN S
		join
		PKP.T_SRV_VEHICLE_ACTUALSITUATION A on
		S.VEHICLE_NO = A.VEHICLE_NO
		join BSE.T_BAS_OWN_TRUCK TK on
		TK.VEHICLE_NO = S.VEHICLE_NO
		join bse.t_bas_vehicle_type_length VL on TK.VEHICLE_LENGHT_CODE =
		VL.VEHICLE_LENGTH_CODE
		join BSE.T_BAS_REGION_VEHICLE V on
		V.VEHICLE_NO = S.VEHICLE_NO
		and V.REGION_TYPE = #{regionType,jdbcType=VARCHAR}
		and V.REGION_NATURE = #{regionNature,jdbcType=VARCHAR}
		and V.ACTIVE = #{active,jdbcType=VARCHAR}
		left join bse.t_bas_service_smallzone sm /*14.7.29 gcl AUTO-212 联合接送货小区表获得小区编码 */
    	on sm.virtual_code = v.region_code and sm.region_type=v.region_type and sm.ACTIVE = #{active,jdbcType=VARCHAR}
		join BSE.T_BAS_OWNDRIVER D ON
		D.EMP_CODE = S.DRIVER_CODE and D.ACTIVE = #{active,jdbcType=VARCHAR}
		where
		S.STATUS = #{bundleStatus,jdbcType=VARCHAR}
		and TK.ACTIVE = #{active,jdbcType=VARCHAR}
		and VL.ACTIVE = #{active,jdbcType=VARCHAR}
		<if test="driverCode != null and driverCode != ''">
			and S.DRIVER_CODE = #{driverCode,jdbcType=VARCHAR}
		</if>
	</select>

	<select id="queryOwnTruck" resultMap="OwnTruckSignOrSchedulingResultMap">
		select /*模块：接送货-处理订单-查询自有车辆*/TK.VEHICLE_NO, /** 车牌号 **/
		VT.VEHICLE_LENGTH_NAME VEHICLE_LENGTH,/** 车型 **/
		S.DEVICE_NO,/** 设备号 **/
		D1.EMP_NAME SIGN_DRIVER_NAME,/** 签到司机姓名 **/
		D2.EMP_NAME SCHEDULING_DRIVER_NAME,/** 排班司机姓名 **/
		S.DRIVER_CODE SIGN_DRIVER_CODE,/** 签到司机编码 **/
		temp.DRIVER_CODE SCHEDULING_DRIVER_CODE,/** 排班司机编码 **/
		D1.EMP_PHONE SIGN_DRIVER_MOBILE,/** 签到司机手机 **/
		D2.EMP_PHONE SCHEDULING_DRIVER_MOBILE,/** 排班司机手机 **/
		A.REMAINING_WEIGHT,/** 剩余重量 **/
		A.REMAINING_VOLUME,/** 剩余体积 **/
		TK.SELF_VOLUME,/** 载空 **/
		TK.SELF_WEIGHT,/** 载重 **/
		to_char(LISTAGG(V.REGION_NAME,',') WITHIN GROUP(order BY S.VEHICLE_NO) over(partition BY S.VEHICLE_NO))
		REGION_NAME,/** 接货小区名称 **/
		to_char(LISTAGG(sm.REGION_CODE,',') WITHIN GROUP(order BY S.VEHICLE_NO) over(partition BY S.VEHICLE_NO))
		REGION_CODE/** 接货小区编码 **/
		From
		BSE.T_BAS_OWN_TRUCK TK
		left join PKP.T_SRV_PDA_SIGN S on TK.VEHICLE_NO = S.VEHICLE_NO
		and S.STATUS = #{bundleStatus,jdbcType=VARCHAR}
		left join (select ST.VEHICLE_NO, SD.DRIVER_CODE
		FROM TFR.T_OPT_TRUCK_SCHEDULING_TASK ST
		join TFR.T_OPT_TRUCK_SCHEDULING SD on SD.ID =
		ST.T_OPT_TRUCK_SCHEDULING_ID
		WHERE SD.SCHEDULING_DATE = TRUNC(SYSDATE)
		AND SD.SCHEDULING_STATUS = ST.TASK_STATUS
		and SD.SCHEDULING_TYPE = 'PKP'
		and SD.SCHEDULING_STATUS = 'Y'
		and SD.PLAN_TYPE = 'WORK') temp on temp.vehicle_no = TK.VEHICLE_NO
		left join PKP.T_SRV_VEHICLE_ACTUALSITUATION A on S.VEHICLE_NO =
		A.VEHICLE_NO
		left join BSE.T_BAS_REGION_VEHICLE V on V.VEHICLE_NO = S.VEHICLE_NO
		and V.REGION_TYPE = #{regionType,jdbcType=VARCHAR}
		and V.REGION_NATURE = #{regionNature,jdbcType=VARCHAR}
		and V.ACTIVE = #{active,jdbcType=VARCHAR}
		left join bse.t_bas_service_smallzone sm /*14.7.29 gcl AUTO-212 联合接送货小区表获得小区编码 */
    	on sm.virtual_code = v.region_code and sm.region_type=v.region_type and sm.ACTIVE = #{active,jdbcType=VARCHAR}
		left join BSE.T_BAS_OWNDRIVER D1 ON D1.EMP_CODE = S.DRIVER_CODE and
		D1.ACTIVE = #{active,jdbcType=VARCHAR}
		left join BSE.T_BAS_OWNDRIVER D2 ON D2.EMP_CODE = temp.DRIVER_CODE and
		D2.ACTIVE = #{active,jdbcType=VARCHAR}
		left join BSE.T_BAS_VEHICLE_TYPE_LENGTH VT on VT.VEHICLE_LENGTH_CODE =
		TK.VEHICLE_LENGHT_CODE and VT.ACTIVE = #{active,jdbcType=VARCHAR}
		<where>
			<if test="vehicleNo != null and vehicleNo != ''">
				and TK.VEHICLE_NO = #{vehicleNo,jdbcType=VARCHAR}
			</if>
			<choose>
				<when test="fleetCodeList != null and fleetCodeList.size() > 0">
					and TK.ORG_ID in
					<foreach collection="fleetCodeList" item="item" index="index"
						open="(" separator="," close=")">
						#{item}
					</foreach>
				</when>
				<when test="serviceFleetCode != null and serviceFleetCode != ''">
					and TK.ORG_ID = #{serviceFleetCode,jdbcType=VARCHAR}
				</when>
				<otherwise>
					<if test="orgCode != null and orgCode != ''">
						and TK.ORG_ID = #{orgCode,jdbcType=VARCHAR}
					</if>
				</otherwise>
			</choose>
			<if test="active != null and active != ''">
				and TK.ACTIVE = #{active,jdbcType=CHAR}
			</if>
			<if test="vehicleType != null and vehicleType != ''">
				and TK.VEHICLE_LENGHT_CODE =
				#{vehicleType,jdbcType=VARCHAR}
			</if>
		</where>
	</select>

	<select id="queryOwnTruckCount" resultType="java.lang.Long">
		select /*模块：接送货-处理订单-查询自有车辆*/count(*)
		From
		BSE.T_BAS_OWN_TRUCK TK
		left join PKP.T_SRV_PDA_SIGN S on TK.VEHICLE_NO = S.VEHICLE_NO
		and S.STATUS = #{bundleStatus,jdbcType=VARCHAR}
		left join (select ST.VEHICLE_NO, SD.DRIVER_CODE
		FROM TFR.T_OPT_TRUCK_SCHEDULING_TASK ST
		join TFR.T_OPT_TRUCK_SCHEDULING SD on SD.ID =
		ST.T_OPT_TRUCK_SCHEDULING_ID
		WHERE SD.SCHEDULING_DATE = TRUNC(SYSDATE)
		AND SD.SCHEDULING_STATUS = ST.TASK_STATUS
		and SD.SCHEDULING_TYPE = 'PKP'
		and SD.SCHEDULING_STATUS = 'Y'
		and SD.PLAN_TYPE = 'WORK') temp on temp.vehicle_no = TK.VEHICLE_NO
		left join PKP.T_SRV_VEHICLE_ACTUALSITUATION A on S.VEHICLE_NO =
		A.VEHICLE_NO
		left join BSE.T_BAS_REGION_VEHICLE V on V.VEHICLE_NO = S.VEHICLE_NO
		and V.REGION_TYPE = #{regionType,jdbcType=VARCHAR}
		and V.REGION_NATURE = #{regionNature,jdbcType=VARCHAR}
		and V.ACTIVE = #{active,jdbcType=VARCHAR}
		left join BSE.T_BAS_OWNDRIVER D1 ON D1.EMP_CODE = S.DRIVER_CODE and
		D1.ACTIVE = #{active,jdbcType=VARCHAR}
		left join BSE.T_BAS_OWNDRIVER D2 ON D2.EMP_CODE = temp.DRIVER_CODE and
		D2.ACTIVE = #{active,jdbcType=VARCHAR}
		<where>
			<if test="vehicleNo != null and vehicleNo != ''">
				and TK.VEHICLE_NO = #{vehicleNo,jdbcType=VARCHAR}
			</if>
			<choose>
				<when test="fleetCodeList != null and fleetCodeList.size() > 0">
					and TK.ORG_ID in
					<foreach collection="fleetCodeList" item="item" index="index"
						open="(" separator="," close=")">
						#{item}
					</foreach>
				</when>
				<when test="serviceFleetCode != null and serviceFleetCode != ''">
					and TK.ORG_ID = #{serviceFleetCode,jdbcType=VARCHAR}
				</when>
				<otherwise>
					<if test="orgCode != null and orgCode != ''">
						and TK.ORG_ID = #{orgCode,jdbcType=VARCHAR}
					</if>
				</otherwise>
			</choose>
			<if test="active != null and active != ''">
				and TK.ACTIVE = #{active,jdbcType=CHAR}
			</if>
			<if test="vehicleType != null and vehicleType != ''">
				and TK.VEHICLE_LENGHT_CODE =
				#{vehicleType,jdbcType=VARCHAR}
			</if>
		</where>
	</select>

	<select id="querySignByVehicleNo" resultMap="BaseResultMap">
		select /*模块：接送货-处理订单-根据车牌号、状态查询签到表信息*/
		<include refid="Base_Column_List" />
		from PKP.T_SRV_PDA_SIGN
		<where>
			<choose>
				<when test="vehicleNo != null and vehicleNo != ''">
					VEHICLE_NO = #{vehicleNo,jdbcType=VARCHAR}
				</when>
				<otherwise>
					VEHICLE_NO = ''
				</otherwise>
			</choose>
			and STATUS = #{status,jdbcType=VARCHAR}
		</where>
	</select>

	<!-- 查询车辆和司机是否已绑定 -->
	<select id="querySignedDV"
		resultType="com.deppon.foss.module.pickup.order.api.shared.domain.PdaSignEntity">
		select /*模块：接送货-查询解除司机签到-查询车辆和司机是否已绑定*/s.id id,S.VEHICLE_NO vehicleNo,
		S.DRIVER_CODE driverCode,
		s.user_type userType,
		S.DEVICE_NO deviceNo
		from PKP.T_SRV_PDA_SIGN S
		<where>
			(
			<if test="driverCode !=null and driverCode != '' ">
				S.DRIVER_CODE = #{driverCode,jdbcType=VARCHAR}
			</if>
			<if test="deviceNo !=null and deviceNo != '' ">
				or S.DEVICE_NO = #{deviceNo,jdbcType=VARCHAR}
			</if>
			<if test="vehicleNo !=null and vehicleNo != '' ">
				or S.VEHICLE_NO = #{vehicleNo,jdbcType=VARCHAR}
			</if>
			)
			and S.STATUS = #{status,jdbcType=VARCHAR}
			<!--liding add for NCI  -->
			<if test="userType !=null and userType != '' ">
				and S.USER_TYPE = #{userType,jdbcType=VARCHAR}
			</if>
			
		</where>
	</select>
	<!-- add by 329757   查询车辆和司机是否已绑定 for 外请车 -->
	<select id="querySignedByVehicle"
		resultType="com.deppon.foss.module.pickup.order.api.shared.domain.PdaSignEntity">
		select /*模块：接送货-查询解除司机签到-查询外请车车辆和司机是否已绑定*/s.id id,S.VEHICLE_NO vehicleNo,
		S.DRIVER_CODE driverCode,
		s.user_type userType,
		S.DEVICE_NO deviceNo
		from PKP.T_SRV_PDA_SIGN S
		<where>
			(
			<if test="vehicleNo !=null and vehicleNo != '' ">
				S.VEHICLE_NO = #{vehicleNo,jdbcType=VARCHAR}
			</if>
			<if test="deviceNo !=null and deviceNo != '' ">
				or S.DEVICE_NO = #{deviceNo,jdbcType=VARCHAR}
			</if>
			)
			and S.STATUS = #{status,jdbcType=VARCHAR}
			<!--liding add for NCI  -->
			<if test="userType !=null and userType != '' ">
				and S.USER_TYPE = #{userType,jdbcType=VARCHAR}
			</if>
			
		</where>
	</select>

	<sql id="where_querySignBy">
		<where>
			<if test="driverName !=null and driverName != '' ">
				AND A.DRIVER_NAME = #{driverName jdbcType=VARCHAR}
			</if>
			<if test="driverCode != null and driverCode != '' ">
				AND A.DRIVER_CODE = #{driverCode jdbcType=VARCHAR}
			</if>
			<if test="empPhone != null and empPhone != '' ">
				AND C.EMP_PHONE = #{empPhone jdbcType=VARCHAR}
			</if>
			<if test="deviceNo != null and deviceNo != '' ">
				AND A.DEVICE_NO = #{deviceNo jdbcType=VARCHAR}
			</if>
			<if test="vehicleNo != null and vehicleNo != '' ">
				AND A.VEHICLE_NO = #{vehicleNo jdbcType=VARCHAR}
			</if>
			<if test="status != null and status != '' ">
				AND A.STATUS = #{status jdbcType=VARCHAR}
			</if>
			<if test="signBeginTime != null and signBeginTime != '' ">
				<![CDATA[AND A.CREATE_TIME >= #{signBeginTime jdbcType=TIMESTAMP}]]>
			</if>
			<if test="signEndTime != null and signEndTime != '' ">
				<![CDATA[AND A.CREATE_TIME <= #{signEndTime jdbcType=TIMESTAMP}]]>
			</if>
			<if test="orgCodes!= null and orgCodes.size>0">
				and tr.org_id in
				<foreach collection="orgCodes" open="(" close=")" separator=","
					item="code">
					<if test="code!=null and code != ''">
	        	      <![CDATA[	#{code,jdbcType=VARCHAR} ]]>
					</if>
				</foreach>
			</if>
		</where>
	</sql>
	<sql id="where_querySignBy1">
		<where>
			<if test="driverName !=null and driverName != '' ">
				AND A.DRIVER_NAME = #{driverName jdbcType=VARCHAR}
			</if>
			<if test="driverCode != null and driverCode != '' ">
				AND A.DRIVER_CODE = #{driverCode jdbcType=VARCHAR}
			</if>
			<if test="empPhone != null and empPhone != '' ">
				AND C.EMP_PHONE = #{empPhone jdbcType=VARCHAR}
			</if>
			<if test="deviceNo != null and deviceNo != '' ">
				AND A.DEVICE_NO = #{deviceNo jdbcType=VARCHAR}
			</if>
			<if test="vehicleNo != null and vehicleNo != '' ">
				AND A.VEHICLE_NO = #{vehicleNo jdbcType=VARCHAR}
			</if>
			<if test="status != null and status != '' ">
				AND A.STATUS = #{status jdbcType=VARCHAR}
			</if>
			<if test="signBeginTime != null and signBeginTime != '' ">
				<![CDATA[AND A.CREATE_TIME >= #{signBeginTime jdbcType=TIMESTAMP}]]>
			</if>
			<if test="signEndTime != null and signEndTime != '' ">
				<![CDATA[AND A.CREATE_TIME <= #{signEndTime jdbcType=TIMESTAMP}]]>
			</if>
		</where>
	</sql>
	<!-- add by 329757 fro 外请车 -->
	<sql id="where_querySignBy2">
		<where>
			<if test="driverName !=null and driverName != '' ">
				AND A.DRIVER_NAME = #{driverName jdbcType=VARCHAR}
			</if>
			<if test="driverCode != null and driverCode != '' ">
				AND A.DRIVER_CODE = #{driverCode jdbcType=VARCHAR}
			</if>
			<if test="empPhone != null and empPhone != '' ">
				AND D.DRIVER_PHONE = #{empPhone jdbcType=VARCHAR}
			</if>
			<if test="deviceNo != null and deviceNo != '' ">
				AND A.DEVICE_NO = #{deviceNo jdbcType=VARCHAR}
			</if>
			<if test="vehicleNo != null and vehicleNo != '' ">
				AND A.VEHICLE_NO = #{vehicleNo jdbcType=VARCHAR}
			</if>
			<if test="status != null and status != '' ">
				AND A.STATUS = #{status jdbcType=VARCHAR}
			</if>
			<if test="signBeginTime != null and signBeginTime != '' ">
				<![CDATA[AND A.CREATE_TIME >= #{signBeginTime jdbcType=TIMESTAMP}]]>
			</if>
			<if test="signEndTime != null and signEndTime != '' ">
				<![CDATA[AND A.CREATE_TIME <= #{signEndTime jdbcType=TIMESTAMP}]]>
			</if>
		</where>
	</sql>
	<select id="querySignByDV"
		resultType="com.deppon.foss.module.pickup.order.api.shared.dto.PdaSignDto">
		select /*模块：接送货-查询解除司机签到-查询车辆和司机是否已绑定*/
		A.ID as id,
		A.DRIVER_NAME as driverName,
		A.DEVICE_NO as deviceNo,
		A.DRIVER_CODE as driverCode,
		A.VEHICLE_NO as vehicleNo,
		A.CREATE_TIME as createTime,
		A.STATUS as status,
		D.REGIONNAME regionName,
		C.EMP_PHONE as empPhon
		from pkp.t_srv_pda_sign A
		inner join bse.t_bas_own_truck tr on tr.VEHICLE_NO = A.VEHICLE_NO and
		tr.ACTIVE ='Y'
		left JOIN BSE.T_BAS_OWNDRIVER C ON C.EMP_CODE = A.DRIVER_CODE
		and C.ACTIVE = 'Y'
		join (select distinct A.VEHICLE_NO,
		to_char(LISTAGG(B.REGION_NAME, ',') WITHIN GROUP(order BY A.VEHICLE_NO) over(partition BY
		A.VEHICLE_NO)) regionName
		from (SELECT DISTINCT A.VEHICLE_NO
		FROM pkp.t_srv_pda_sign A
		<include refid="where_querySignBy1" />
		) A
		LEFT JOIN BSE.T_BAS_REGION_VEHICLE B ON B.VEHICLE_NO =
		A.VEHICLE_NO
		and B.ACTIVE = 'Y') D on A.VEHICLE_NO =
		D.VEHICLE_NO
		<include refid="where_querySignBy" />
	</select>
	<!-- add by 329757 查询外请车签到信息 -->
	<select id="querySignByDVForLeased"
		resultType="com.deppon.foss.module.pickup.order.api.shared.dto.PdaSignDto">
		select /*模块：接送货-查询解除司机签到-查询外请车车辆和司机是否已绑定*/
		A.ID as id,
		A.DRIVER_NAME as driverName,
		A.DEVICE_NO as deviceNo,
		A.DRIVER_CODE as driverCode,
		A.VEHICLE_NO as vehicleNo,
		A.CREATE_TIME as createTime,
		A.STATUS as status,
		D.REGIONNAME regionName,
		C.DRIVER_PHONE as empPhon
		from pkp.t_srv_pda_sign A
		inner join  BSE.T_BAS_LEASED_TRUCK tr on tr.VEHICLE_NO = A.VEHICLE_NO and
		tr.ACTIVE ='Y'
		left JOIN BSE.T_BAS_LEASED_DRIVER C ON C.VEHICLE_NO = A.VEHICLE_NO
		and C.ACTIVE = 'Y'
		join (select distinct A.VEHICLE_NO,
		to_char(LISTAGG(B.REGION_NAME, ',') WITHIN GROUP(order BY A.VEHICLE_NO) over(partition BY
		A.VEHICLE_NO)) regionName
		from (SELECT DISTINCT A.VEHICLE_NO
		FROM pkp.t_srv_pda_sign A
		<where>
			<if test="driverName !=null and driverName != '' ">
				AND A.DRIVER_NAME = #{driverName jdbcType=VARCHAR}
			</if>
			<if test="driverCode != null and driverCode != '' ">
				AND A.DRIVER_CODE = #{driverCode jdbcType=VARCHAR}
			</if>
			<if test="empPhone != null and empPhone != '' ">
				AND C.DRIVER_PHONE = #{empPhone jdbcType=VARCHAR}
			</if>
			<if test="deviceNo != null and deviceNo != '' ">
				AND A.DEVICE_NO = #{deviceNo jdbcType=VARCHAR}
			</if>
			<if test="vehicleNo != null and vehicleNo != '' ">
				AND A.VEHICLE_NO = #{vehicleNo jdbcType=VARCHAR}
			</if>
			<if test="status != null and status != '' ">
				AND A.STATUS = #{status jdbcType=VARCHAR}
			</if>
			<if test="signBeginTime != null and signBeginTime != '' ">
				<![CDATA[AND A.CREATE_TIME >= #{signBeginTime jdbcType=TIMESTAMP}]]>
			</if>
			<if test="signEndTime != null and signEndTime != '' ">
				<![CDATA[AND A.CREATE_TIME <= #{signEndTime jdbcType=TIMESTAMP}]]>
			</if>
		</where>
		) A
		LEFT JOIN BSE.T_BAS_REGION_VEHICLE B ON B.VEHICLE_NO =
		A.VEHICLE_NO
		and B.ACTIVE = 'Y') D on A.VEHICLE_NO =
		D.VEHICLE_NO
		<where>
			<if test="driverName !=null and driverName != '' ">
				AND A.DRIVER_NAME = #{driverName jdbcType=VARCHAR}
			</if>
			<if test="driverCode != null and driverCode != '' ">
				AND A.DRIVER_CODE = #{driverCode jdbcType=VARCHAR}
			</if>
			<if test="empPhone != null and empPhone != '' ">
				AND C.DRIVER_PHONE = #{empPhone jdbcType=VARCHAR}
			</if>
			<if test="deviceNo != null and deviceNo != '' ">
				AND A.DEVICE_NO = #{deviceNo jdbcType=VARCHAR}
			</if>
			<if test="vehicleNo != null and vehicleNo != '' ">
				AND A.VEHICLE_NO = #{vehicleNo jdbcType=VARCHAR}
			</if>
			<if test="status != null and status != '' ">
				AND A.STATUS = #{status jdbcType=VARCHAR}
			</if>
			<if test="signBeginTime != null and signBeginTime != '' ">
				<![CDATA[AND A.CREATE_TIME >= #{signBeginTime jdbcType=TIMESTAMP}]]>
			</if>
			<if test="signEndTime != null and signEndTime != '' ">
				<![CDATA[AND A.CREATE_TIME <= #{signEndTime jdbcType=TIMESTAMP}]]>
			</if>
		</where>
	</select>
	<!--根据司机工号获得司机电话 14.8.13 AUTO-224-->
	<select id="queryPhoneByDriverCode" resultType="java.lang.Object">
		select C.EMP_PHONE 
		FROM BSE.T_BAS_OWNDRIVER C 
		WHERE C.ACTIVE = 'Y'
		AND C.EMP_CODE = #{driverCode,jdbcType=VARCHAR}
	</select>
	<select id="querySignedInfoCount" resultType="java.lang.Long">
		select
		/*模块：接送货-查询解除司机签到-查询签到总数*/
		count(distinct A.ID)
		FROM pkp.t_srv_pda_sign A
		LEFT JOIN BSE.T_BAS_REGION_VEHICLE B ON B.VEHICLE_NO = A.VEHICLE_NO and
		B.ACTIVE = #{active,jdbcType=VARCHAR}
		LEFT JOIN BSE.T_BAS_OWNDRIVER C
		ON C.EMP_CODE = A.DRIVER_CODE and C.ACTIVE =
		#{active,jdbcType=VARCHAR}
		inner join bse.t_bas_own_truck tr on
		tr.VEHICLE_NO = A.VEHICLE_NO and tr.ACTIVE =
		#{active,jdbcType=VARCHAR}
		<include refid="where_querySignBy" />
	</select>
	<!--add  by 329757  查询出外请车签到信息的总条数 -->
	<select id="querySignedInfoCountForLeased" resultType="java.lang.Long">
		select
		/*模块：接送货-查询解除外请车司机签到-查询签到总数*/
		count(distinct A.ID)
		FROM pkp.t_srv_pda_sign A
		LEFT JOIN BSE.T_BAS_REGION_VEHICLE B ON B.VEHICLE_NO = A.VEHICLE_NO and
		B.ACTIVE = #{active,jdbcType=VARCHAR}
		LEFT JOIN BSE.T_BAS_LEASED_DRIVER D
		ON D.VEHICLE_NO = A.VEHICLE_NO and D.ACTIVE =
		#{active,jdbcType=VARCHAR}
		inner join  BSE.T_BAS_LEASED_TRUCK lt on
		lt.VEHICLE_NO = A.VEHICLE_NO and lt.ACTIVE =
		#{active,jdbcType=VARCHAR}
		<include refid="where_querySignBy2" />
	</select>

	<!-- 校验三者唯一 -->
	<select id="querySignCountByDV" resultType="int">
		SELECT /*模块：接送货-查询解除司机签到-校验三者是否唯一*/
		COUNT(*)
		FROM pkp.t_srv_pda_sign t
		<where>
			<if test="deviceNo != null and deviceNo != '' ">
				and device_no = #{deviceNo jdbcType=VARCHAR}
			</if>
			<if test="driverCode != null and driverCode != '' ">
				and driver_code = #{driverCode jdbcType=VARCHAR}
			</if>
			<if test="vehicleNo != null and vehicleNo != '' ">
				and vehicle_no = #{vehicleNo jdbcType=VARCHAR}
			</if>
			<if test="status != null and status != '' ">
				and status = #{status jdbcType=VARCHAR}
			</if>
		</where>
	</select>
	
	<!-- zxy 20140718 AUTO-170 查询签到数据 -->
	<select id="querySignEntityByDV" resultMap="BaseResultMap" 
	 parameterType="com.deppon.foss.module.pickup.order.api.shared.domain.PdaSignEntity">
		SELECT /*模块：接送货-查询解除司机签到-校验三者是否唯一*/
		<include refid="Base_Column_List" />
		FROM pkp.t_srv_pda_sign t
		<where>
			<if test="deviceNo != null and deviceNo != '' ">
				and device_no = #{deviceNo jdbcType=VARCHAR}
			</if>
			<if test="driverCode != null and driverCode != '' ">
				and driver_code = #{driverCode jdbcType=VARCHAR}
			</if>
			<if test="vehicleNo != null and vehicleNo != '' ">
				and vehicle_no = #{vehicleNo jdbcType=VARCHAR}
			</if>
			<if test="status != null and status != '' ">
				and status = #{status jdbcType=VARCHAR}
			</if>
		</where>
	</select>
	<!--14.7.16 根据司机 车牌号查询id -->
	<select id="querySignIdByDV" resultType="java.lang.String">
		SELECT t.id
		FROM pkp.t_srv_pda_sign t
		<where>
			<if test="driverCode != null and driverCode != '' ">
				AND driver_code = #{driverCode,jdbcType=VARCHAR}
			</if>
			<if test="vehicleNo != null and vehicleNo != '' ">
				AND vehicle_no= #{vehicleNo,jdbcType=VARCHAR}
			</if>
			<if test="originStatus != null and originStatus != '' ">
				and status = #{originStatus,jdbcType=VARCHAR}
			</if>
			<!-- liding add for NCI -->
			<if test="userType != null and userType != '' ">
				and USER_TYPE = #{userType,jdbcType=VARCHAR}
			</if>
		</where>
	</select>
	<update id="updateStatusByDv">
		UPDATE /*模块：接送货-查询解除司机签到-根据司机和车辆更新状态*/pkp.t_srv_pda_sign
		<set>
			<if test="unbundler != null">
				UNBUNDLER = #{unbundler,jdbcType=VARCHAR},
			</if>
			<if test="unbundlerCode != null">
				UNBUNDLER_CODE = #{unbundlerCode,jdbcType=VARCHAR},
			</if>
			<if test="unbundleReason != null">
				UNBUNDLE_REASON = #{unbundleReason,jdbcType=VARCHAR},
			</if>
			<if test="unbundleTime != null">
				UNBUNDLE_TIME = #{unbundleTime,jdbcType=TIMESTAMP},
			</if>
			<if test="status != null">
				STATUS = #{status,jdbcType=CHAR},
			</if>
		</set>
		<where>
			<if test="driverCode != null and driverCode != '' ">
				AND driver_code = #{driverCode,jdbcType=VARCHAR}
			</if>
			<if test="vehicleNo != null and vehicleNo != '' ">
				AND vehicle_no= #{vehicleNo,jdbcType=VARCHAR}
			</if>
			and STATUS = #{originStatus,jdbcType=VARCHAR}
			<!-- liding add for NCI -->
			and USER_TYPE = #{userType,jdbcType=VARCHAR}
		</where>
	</update>

	<update id="updateUnbundle">
		UPDATE /*模块：接送货-查询解除司机签到-更新为已解绑*/pkp.t_srv_pda_sign
		<set>
			<if test="status != null">
				STATUS = #{status,jdbcType=CHAR},
			</if>
		</set>
		<where>
			<![CDATA[ CREATE_TIME > sysdate - 1.5
			and CREATE_TIME < sysdate ]]>
			<if test="userType != null and userType != '' ">
				AND USER_TYPE= #{userType,jdbcType=VARCHAR}
			</if>
			<if test="originStatus != null and originStatus != '' ">
				AND STATUS= #{originStatus,jdbcType=VARCHAR}
			</if>
		</where>
	</update>
	<!-- 查询可用所属区域的快递员 -->
	<select id="queryUsedUser" resultMap="OwnTruckResultMap">
		SELECT EV.VEHICLE_NO,/*模块：接送货-查询处理小件订单-查询可用所属区域的快递员*/
		PS.DRIVER_CODE,
		PS.DRIVER_NAME,
		EV.MOBILE_PHONE DRIVER_MOBILE,
		'Y' ISPDABUNDLE,
		EV.VEHICLE_LENGHT_CODE VEHICLE_LENGTH,
		EV.ORG_CODE REGION_CODE,
		ORG.NAME REGION_NAME
		FROM BSE.T_BAS_EXPRESS_VEHICLE EV,
		PKP.T_SRV_PDA_SIGN PS,
		BSE.T_BAS_ORG ORG,
		(SELECT DISTINCT EV.VEHICLE_NO AS VEHICLE_NO
		FROM BSE.T_BAS_EXPRESS_VEHICLE EV,
		BSE.T_BAS_EXPRESS_EMP_DISTRICT EE
		WHERE EV.EMP_CODE = EE.EMP_CODE
		AND EE.ACTIVE = #{active,jdbcType=VARCHAR}
		AND EV.ACTIVE = #{active,jdbcType=VARCHAR}
		<if
			test="expressOrderNewCountyCodes != null and expressOrderNewCountyCodes.size() > 0">
			AND EE.DISTRICT_CODE in
			<foreach collection="expressOrderNewCountyCodes" item="item"
				index="index" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if
			test="expressOrderNewCountyCodes == null or expressOrderNewCountyCodes.size() == 0">
			<if
				test="expressOrderCountyCodes != null and expressOrderCountyCodes.size() > 0">
				AND EE.DISTRICT_CODE in
				<foreach collection="expressOrderCountyCodes" item="item"
					index="index" open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
		</if>
		) TMP
		<where>
			EV.VEHICLE_NO = TMP.VEHICLE_NO
			AND EV.ACTIVE = #{active,jdbcType=VARCHAR}
			AND EV.EMP_CODE = PS.DRIVER_CODE
			AND EV.ORG_CODE = ORG.CODE(+)
			AND ORG.ACTIVE = #{active,jdbcType=VARCHAR}
			AND PS.STATUS = #{bundleStatus,jdbcType=VARCHAR}
			AND PS.USER_TYPE = #{pdaSignUserType,jdbcType=VARCHAR}
		</where>
	</select>
	<!-- 查询所属区域的快递员 -->
	<select id="queryAllUsedUser" resultMap="OwnTruckResultMap">
		SELECT EV.VEHICLE_NO,/*模块：接送货-查询处理小件订单-查询所属区域的快递员*/
		EV.EMP_CODE AS DRIVER_CODE,
		BS.EMP_NAME AS DRIVER_NAME,
		EV.MOBILE_PHONE DRIVER_MOBILE,
		'N' ISPDABUNDLE,
		EV.VEHICLE_LENGHT_CODE VEHICLE_LENGTH,
		EV.ORG_CODE REGION_CODE,
		ORG.NAME REGION_NAME
		FROM BSE.T_BAS_EXPRESS_VEHICLE EV,
		BSE.T_BAS_ORG ORG,
		(SELECT DISTINCT EV.VEHICLE_NO AS VEHICLE_NO
		FROM BSE.T_BAS_EXPRESS_VEHICLE EV,
		BSE.T_BAS_EXPRESS_EMP_DISTRICT EE
		WHERE EV.EMP_CODE = EE.EMP_CODE
		AND EE.ACTIVE = #{active,jdbcType=VARCHAR}
		AND EV.ACTIVE = #{active,jdbcType=VARCHAR}
		<if test="vehicleNo != null and vehicleNo != ''">
			AND EV.VEHICLE_NO = #{vehicleNo,jdbcType=CHAR}
		</if>
		<if test="vehicleType != null and vehicleType != ''">
			AND EV.VEHICLE_LENGHT_CODE = #{vehicleType,jdbcType=CHAR}
		</if>
		<if test="driverCode != null and driverCode != ''">
			AND EV.EMP_CODE = #{driverCode,jdbcType=CHAR}
		</if>
		<if test="driverMobile != null and driverMobile != ''">
			AND EV.MOBILE_PHONE = #{driverMobile,jdbcType=CHAR}
		</if>
		<if
			test="expressOrderNewCountyCodes != null and expressOrderNewCountyCodes.size() > 0">
			AND EE.DISTRICT_CODE in
			<foreach collection="expressOrderNewCountyCodes" item="item"
				index="index" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if
			test="expressOrderNewCountyCodes == null or expressOrderNewCountyCodes.size() == 0">
			<if
				test="expressOrderCountyCodes != null and expressOrderCountyCodes.size() >= 0">
				AND EE.DISTRICT_CODE in
				<foreach collection="expressOrderCountyCodes" item="item"
					index="index" open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
		</if>
		) TMP,
		BSE.T_BAS_USER BS
		WHERE EV.VEHICLE_NO = TMP.VEHICLE_NO
		AND EV.ORG_CODE = ORG.CODE(+)
		AND ORG.ACTIVE = #{active,jdbcType=VARCHAR}
		AND EV.EMP_CODE = BS.EMP_CODE(+)
		AND BS.ACTIVE = #{active,jdbcType=VARCHAR}
		AND EV.ACTIVE = #{active,jdbcType=VARCHAR}
	</select>
	<!-- 查询所属区域的快递员 -->
	<select id="queryAllUserCount" resultType="java.lang.Long">
		SELECT count(1)/*模块：接送货-查询处理小件订单-查询所属区域的快递员count*/
		FROM BSE.T_BAS_EXPRESS_VEHICLE EV,
		BSE.T_BAS_ORG ORG,
		(SELECT DISTINCT EV.VEHICLE_NO AS VEHICLE_NO
		FROM BSE.T_BAS_EXPRESS_VEHICLE EV,
		BSE.T_BAS_EXPRESS_EMP_DISTRICT EE
		WHERE EV.EMP_CODE = EE.EMP_CODE
		AND EE.ACTIVE = #{active,jdbcType=VARCHAR}
		AND EV.ACTIVE = #{active,jdbcType=VARCHAR}
		<if test="vehicleNo != null and vehicleNo != ''">
			AND EV.VEHICLE_NO = #{vehicleNo,jdbcType=CHAR}
		</if>
		<if test="vehicleType != null and vehicleType != ''">
			AND EV.VEHICLE_LENGHT_CODE = #{vehicleType,jdbcType=CHAR}
		</if>
		<if test="driverCode != null and driverCode != ''">
			AND EV.EMP_CODE = #{driverCode,jdbcType=CHAR}
		</if>
		<if test="driverMobile != null and driverMobile != ''">
			AND EV.MOBILE_PHONE = #{driverMobile,jdbcType=CHAR}
		</if>
		<if
			test="expressOrderNewCountyCodes != null and expressOrderNewCountyCodes.size() > 0">
			AND EE.DISTRICT_CODE in
			<foreach collection="expressOrderNewCountyCodes" item="item"
				index="index" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if
			test="expressOrderNewCountyCodes == null or expressOrderNewCountyCodes.size() == 0">
			<if
				test="expressOrderCountyCodes != null and expressOrderCountyCodes.size() >= 0">
				AND EE.DISTRICT_CODE in
				<foreach collection="expressOrderCountyCodes" item="item"
					index="index" open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
		</if>
		) TMP,
		BSE.T_BAS_USER BS
		WHERE EV.VEHICLE_NO = TMP.VEHICLE_NO
		AND EV.ORG_CODE = ORG.CODE(+)
		AND ORG.ACTIVE = #{active,jdbcType=VARCHAR}
		AND EV.EMP_CODE = BS.EMP_CODE(+)
		AND BS.ACTIVE = #{active,jdbcType=VARCHAR}
		AND EV.ACTIVE = #{active,jdbcType=VARCHAR}
	</select>

	<sql id="where_queryExpressSignBy">
		<where>
			<if test="driverName !=null and driverName != '' ">
				AND A.DRIVER_NAME = #{driverName jdbcType=VARCHAR}
			</if>
			<if test="driverCode != null and driverCode != '' ">
				AND A.DRIVER_CODE = #{driverCode jdbcType=VARCHAR}
			</if>
			<if test="empPhone != null and empPhone != '' ">
				AND B.MOBILE_PHONE = #{empPhone jdbcType=VARCHAR}
			</if>
			<if test="deviceNo != null and deviceNo != '' ">
				AND A.DEVICE_NO = #{deviceNo jdbcType=VARCHAR}
			</if>
			<if test="vehicleNo != null and vehicleNo != '' ">
				AND A.VEHICLE_NO = #{vehicleNo jdbcType=VARCHAR}
			</if>
			<if test="status != null and status != '' ">
				AND A.STATUS = #{status jdbcType=VARCHAR}
			</if>
			<if test="signBeginTime != null and signBeginTime != '' ">
				<![CDATA[AND A.CREATE_TIME >= #{signBeginTime jdbcType=TIMESTAMP}]]>
			</if>
			<if test="signEndTime != null and signEndTime != '' ">
				<![CDATA[AND A.CREATE_TIME <= #{signEndTime jdbcType=TIMESTAMP}]]>
			</if>

			and A.USER_TYPE = 'COURIER'
		</where>
	</sql>
	<sql id="where_queryExpressSignBy1">
		<if
			test="expressOrderCountyCodes != null and expressOrderCountyCodes.size > 0">
			and C.DISTRICT_CODE in
			<foreach collection="expressOrderCountyCodes" open="(" close=")"
				separator="," item="county">
				<if test="county !=null and county != ''">
        	      <![CDATA[	#{county, jdbcType=VARCHAR} ]]>
				</if>
			</foreach>
		</if>
	</sql>
	<!-- liding add start-->
	<sql id="where_querySalesPartmentSignBy">
		<where>
			<if test="driverName !=null and driverName != '' ">
				AND A.DRIVER_NAME = #{driverName jdbcType=VARCHAR}
			</if>
			<if test="driverCode != null and driverCode != '' ">
				AND A.DRIVER_CODE = #{driverCode jdbcType=VARCHAR}
			</if>
			<if test="empPhone != null and empPhone != '' ">
				AND B.MOBILE_PHONE = #{empPhone jdbcType=VARCHAR}
			</if>
			<if test="deviceNo != null and deviceNo != '' ">
				AND A.DEVICE_NO = #{deviceNo jdbcType=VARCHAR}
			</if>
			<if test="vehicleNo != null and vehicleNo != '' ">
				AND A.VEHICLE_NO = #{vehicleNo jdbcType=VARCHAR}
			</if>
			<if test="status != null and status != '' ">
				AND A.STATUS = #{status jdbcType=VARCHAR}
			</if>
			<if test="signBeginTime != null and signBeginTime != '' ">
				<![CDATA[AND A.CREATE_TIME >= #{signBeginTime jdbcType=TIMESTAMP}]]>
			</if>
			<if test="signEndTime != null and signEndTime != '' ">
				<![CDATA[AND A.CREATE_TIME <= #{signEndTime jdbcType=TIMESTAMP}]]>
			</if>
			<if test="userType != null and userType != '' ">
				AND A.USER_TYPE = #{userType jdbcType=VARCHAR}
			</if>
		</where>
	</sql>
	<!-- liding add end -->

	<select id="queryExpressSignedInfoCount" resultType="java.lang.Long">
		select
		/*模块：接送货-查询解除快递员签到-查询签到总数*/
		count(distinct A.ID)
		FROM pkp.t_srv_pda_sign A
		inner JOIN BSE.t_Bas_Express_Vehicle B
		ON A.DRIVER_CODE = B.EMP_CODE
		and a.vehicle_no = b.vehicle_no
		and B.Active = #{active, jdbcType=VARCHAR}
		inner join (select distinct C.Emp_Code from bse.t_bas_express_emp_district
		C
		where c.active = #{active, jdbcType=VARCHAR}
		<include refid="where_queryExpressSignBy1" />
		) tmp
		on b.emp_code = tmp.emp_code
		<include refid="where_queryExpressSignBy" />
	</select>

	<select id="queryExpressSignByDVByPage"
		resultType="com.deppon.foss.module.pickup.order.api.shared.dto.PdaSignDto">
		select /*模块：接送货-查询解除快递员签到-查询车辆和司机是否已绑定*/
		A.ID as id,
		A.DRIVER_NAME as driverName,
		A.DEVICE_NO as deviceNo,
		A.DRIVER_CODE as driverCode,
		A.VEHICLE_NO as vehicleNo,
		A.CREATE_TIME as createTime,
		A.STATUS as status,
		--D.name regionName,
		B.MOBILE_PHONE as empPhone
		FROM pkp.t_srv_pda_sign A
		inner JOIN BSE.t_Bas_Express_Vehicle B
		ON A.DRIVER_CODE = B.EMP_CODE
		and a.vehicle_no = b.vehicle_no
		and B.Active = #{active, jdbcType=VARCHAR}
		inner join (select distinct C.Emp_Code from bse.t_bas_express_emp_district
		C
		where c.active = #{active, jdbcType=VARCHAR}
		<include refid="where_queryExpressSignBy1" />
		) tmp
		on b.emp_code = tmp.emp_code
		--left join bse.t_bas_district D
		-- on C.DISTRICT_CODE = D.Code
		-- and d.active = 'Y'
		<include refid="where_queryExpressSignBy" />
	</select>
	
	<!--根据快递员工号查询  -->
	<select id="queryExpressDriverByDistirct" resultMap="OwnTruckResultMap"
		parameterType="String">
		select distinct/*模块：接送货-PDA接口-查询同一点部所有可用快递员集合*/
 		b.vehicle_no   as VEHICLE_NO,
 		b.emp_code     AS DRIVER_CODE,
 		we.emp_name    AS DRIVER_NAME,
 		b.mobile_phone DRIVER_MOBILE
  		from BSE.T_BAS_COURIER_SCHEDULE A
  			LEFT JOIN BSE.T_BAS_EXPRESS_VEHICLE B on A.COURIER_CODE = B.EMP_CODE and a.active = b.active and b.active = 'Y'
 		INNER JOIN PKP.T_SRV_EMPLOYEEWORKSTATUS WE ON WE.EMP_CODE = b.EMP_CODE AND WE.ACTIVE = 'Y' 
 		where a.express_part_code in
          			(select a.express_part_code from BSE.T_BAS_COURIER_SCHEDULE A
         				where <![CDATA[ A.SCHEDULE_DATE >= trunc(sysdate) ]]>
           				 and a.courier_code = #{driverCode, jdbcType=VARCHAR}
            			and a.ACTIVE = 'Y')
   			<![CDATA[ and A.SCHEDULE_DATE >= trunc(sysdate) ]]>
   			and a.active = 'Y'
   			and a.plan_type = 'WORK'
   			and a.courier_code != #{driverCode, jdbcType=VARCHAR}
	</select>
	<!-- 2014.7.15 gcl AUTO-165 查询收派小区的所有有效快递员 -->
	<select id="queryExpressDriverBySmallZone" resultMap="OwnTruckResultMap"
		parameterType="String">
		select
 		b.vehicle_no   as VEHICLE_NO,
 		b.emp_code     AS DRIVER_CODE,
 		we.emp_name    AS DRIVER_NAME,
 		b.mobile_phone DRIVER_MOBILE
  		from BSE.T_BAS_COURIER_SCHEDULE A
  			LEFT JOIN BSE.T_BAS_EXPRESS_VEHICLE B on A.COURIER_CODE = B.EMP_CODE and a.active = b.active and b.active = 'Y'
 		INNER JOIN PKP.T_SRV_EMPLOYEEWORKSTATUS WE ON WE.EMP_CODE = b.EMP_CODE AND WE.ACTIVE = 'Y' AND WE.WORK_STATUS = 'OPEN'
 		where a.small_regions_code in (#{smallZone, jdbcType=VARCHAR})
   			<![CDATA[ and A.SCHEDULE_DATE >= trunc(sysdate) ]]>
   			and a.active = 'Y'
	</select>
	<select id="queryExpressVehicleNoByCourier" resultMap="OwnTruckResultMap"
		parameterType="String"> 
			SELECT/*模块：接送货-PDA接口-查询快递员对应的车牌号*/
				EV.VEHICLE_NO,
				EV.EMP_CODE AS DRIVER_CODE,
				em.EMP_NAME AS DRIVER_NAME,
				EV.MOBILE_PHONE DRIVER_MOBILE
				FROM BSE.T_BAS_EXPRESS_VEHICLE EV /*14.7.11 gcl 从员工表中获得姓名*/
				left join bse.t_bas_employee em on em.emp_code = ev.emp_code and em.active = 'Y'
			WHERE EV.EMP_CODE =  #{driverCode, jdbcType=VARCHAR}
				AND EV.ACTIVE = 'Y'
	</select>
	
	
	<!--快递员签到工号集合查询-根据所属的收派小区编码  -->
	<!--  
	<select id="queryExpressDriverBySignDto" resultMap="CourierResultMap"
		parameterType="com.deppon.foss.module.pickup.order.api.shared.dto.CourierQueryDto">
		SELECT EV.VEHICLE_NO ,/*模块：接送货-快递工作状态表-根据选择的收派大区||收派小区||快递员集合编码*/
    		   PS.DRIVER_CODE,
    		   PS.DRIVER_NAME,
    	       tmp.BIG_REGION_CODE,
    	       tmp.BIG_REGION_NAME,
               tmp.SMALL_REGION_NAME,
               tmp.SMALL_REGION_CODE
        FROM BSE.T_BAS_EXPRESS_VEHICLE EV,
        PKP.T_SRV_PDA_SIGN PS,
        (select distinct EV.VEHICLE_NO,
    			be.region_code BIG_REGION_CODE,be.region_name BIG_REGION_NAME, 
    			se.region_code SMALL_REGION_CODE,se.region_name SMALL_REGION_NAME 
     			from BSE.T_BAS_EXPRESS_EMP_DISTRICT EE
     			inner join  BSE.T_BAS_EXPRESS_VEHICLE EV on  EV.EMP_CODE = EE.EMP_CODE
           			and ev.active = 'Y'
     			left join bse.t_bas_express_smallzone se on ee.district_code = se.countycode
           			and se.active = 'Y'
     			left join bse.t_bas_express_bigzone be on ee.district_code = be.countycode   
          			and be.active = 'Y'   
      				where ee.active = 'Y'
      				<if test="courierCode != null and courierCode != '' ">
						AND ev.emp_code = #{courierCode jdbcType=VARCHAR}
					</if>
					<if test="bigZoneCodes != null and bigZoneCodes.size() > 0">
						AND be.region_code in
						<foreach collection="bigZoneCodes" item="item" index="index"
								open="(" separator="," close=")">
							#{item}
						</foreach>
					</if>
					<if test="smallZoneCodes != null and smallZoneCodes.size() > 0">
						AND se.region_code in
						<foreach collection="smallZoneCodes" item="item" index="index"
								open="(" separator="," close=")">
							#{item}
						</foreach>
					</if>
   		) TMP
		where  EV.VEHICLE_NO = TMP.VEHICLE_NO
      	AND EV.ACTIVE = 'Y'
      	AND EV.EMP_CODE = PS.DRIVER_CODE
      	AND PS.STATUS = 'BUNDLE'
      	AND PS.USER_TYPE = 'COURIER'
	</select> 
	-->
	<!--快递员签到工号集合查询-根据所属的收派小区编码  -->
	<!--zxy 20140703 AUTO-96 查询条件BE.ID修改成BE.VIRTUAL_CODE = SE.BIGZONECODE -->
	<select id="queryExpressDriverBySignDto" resultMap="CourierResultMap"
		parameterType="com.deppon.foss.module.pickup.order.api.shared.dto.CourierQueryDto">
		SELECT DISTINCT PS.VEHICLE_NO AS VEHICLE_NO, 
	        PS.DRIVER_CODE AS DRIVER_CODE,
	        PS.DRIVER_NAME AS DRIVER_NAME,
	        BE.REGION_CODE AS BIG_REGION_CODE,
	        BE.REGION_NAME AS BIG_REGION_NAME,
	        BS.SMALL_REGIONS_CODE AS SMALL_REGION_CODE,
	        BS.SMALL_REGIONS_NAME AS SMALL_REGION_NAME,
	        DECODE(BS.COURIER_NATURE,'FIXED','定区','MOTORIZED','机动',BS.COURIER_NATURE) AS  COURIER_TYPE  
	        FROM BSE.T_BAS_COURIER_SCHEDULE  BS
	    INNER JOIN  PKP.T_SRV_PDA_SIGN PS ON BS.COURIER_CODE = PS.DRIVER_CODE
	    inner join pkp.t_srv_employeeworkstatus ws on bs.courier_code=ws.emp_code <!--14.7.18 gcl AUTO-177-->
	    INNER JOIN  (SELECT DISTINCT EV.VEHICLE_NO AS VEHICLE_NO,
         					EV.EMP_CODE AS DRIVER_CODE 
   					 FROM BSE.T_BAS_EXPRESS_VEHICLE EV, BSE.T_BAS_EXPRESS_EMP_DISTRICT  EE
   					 WHERE EV.EMP_CODE = EE.EMP_CODE AND EE.ACTIVE = 'Y' AND EV.ACTIVE = 'Y'
   					 <if test="expressOrderNewCountyCodes != null and expressOrderNewCountyCodes.size() > 0">
						AND EE.DISTRICT_CODE IN
						<foreach collection="expressOrderNewCountyCodes" item="item"
							index="index" open="(" separator="," close=")">
							#{item}
						</foreach>
					</if>
					<if test="expressOrderNewCountyCodes == null or expressOrderNewCountyCodes.size() == 0">
						<if test="expressOrderCountyCodes != null and expressOrderCountyCodes.size() >= 0">
							AND EE.DISTRICT_CODE IN
							<foreach collection="expressOrderCountyCodes" item="item"
									index="index" open="(" separator="," close=")">
								#{item}
							</foreach>
						</if>
					</if>
  									) TMP ON TMP.DRIVER_CODE = PS.DRIVER_CODE AND PS.VEHICLE_NO = TMP.VEHICLE_NO
	    LEFT JOIN  BSE.T_BAS_EXPRESS_SMALLZONE SE ON SE.REGION_CODE = BS.SMALL_REGIONS_CODE
	          AND SE.ACTIVE = 'Y'
	    LEFT JOIN BSE.T_BAS_EXPRESS_BIGZONE BE ON BE.VIRTUAL_CODE = SE.BIGZONECODE
	          AND BE.ACTIVE = 'Y'
	 	WHERE BS.ACTIVE = 'Y'   
	 		<![CDATA[ and bs.SCHEDULE_DATE >= TO_DATE(TRUNC(SYSDATE) + 0 / 24)]]>
   			<![CDATA[ and bs.SCHEDULE_DATE < TO_DATE(TRUNC(SYSDATE) + 24 / 24)]]>/*14.7.4 gcl 只查询当天快递员排班记录*/
	       	  AND PS.STATUS = 'BUNDLE'
	      	  AND PS.USER_TYPE = 'COURIER'
	      	  and ws.businessarea='EXPRESS_ORDER'
   			  and ws.active='Y'
   			  <if test="recieveOrderStatus != null and recieveOrderStatus != ''"><!-- 14.10.14 gcl 添加接收状态 查询条件 -->
					AND ws.WORK_STATUS = #{recieveOrderStatus,jdbcType=VARCHAR}
			   </if>
	      	  <if test="courierCode != null and courierCode != '' ">
						AND BS.COURIER_CODE = #{courierCode jdbcType=VARCHAR}
			  </if>
	      	  <if test="bigZoneCodes != null and bigZoneCodes.size() > 0">
						AND BE.REGION_CODE IN
						<foreach collection="bigZoneCodes" item="item" index="index"
								open="(" separator="," close=")">
							#{item}
						</foreach>
			  </if>
			  <if test="partCodes != null and partCodes.size() > 0"><!--14.9.12 gcl 点部机构下快递员 DEFECT-4331 -->
						AND exists  (select 1 FROM BSE.T_BAS_EMPLOYEE E
                    WHERE bs.courier_code=e.emp_code
                          and E.ACTIVE = 'Y' and exists (SELECT 1
                          FROM BSE.T_BAS_ORG O
                         WHERE E.UNIFIELD_CODE = O.UNIFIED_CODE
                           AND O.ACTIVE = 'Y'
                        AND O.EXPRESS_PART = 'Y') AND e.ORG_CODE IN 
						<foreach collection="partCodes" item="item" index="index"
								open="(" separator="," close=")">
							#{item}
						</foreach>
						)
			  </if>
			  <if test="smallZoneCodes != null and smallZoneCodes.size() > 0">
						AND SE.REGION_CODE IN
						<foreach collection="smallZoneCodes" item="item" index="index"
								open="(" separator="," close=")">
							#{item}
						</foreach>
			  </if>
	</select>
	
	<!--零担司机签到司机当天记录统计集合查询 -->
	<select id="queryDriverBySignDay" resultMap="DriverResultMap"
		parameterType="com.deppon.foss.module.pickup.order.api.shared.dto.DriverQueryDto">
		SELECT TT.VEHICLE_NO,
			       TT.DRIVER_CODE,
			       TT.DRIVER_NAME,
			       TT.VEHICLE_LENGTH,
			       TT.WORK_STATUS,
			       TT.REGION_NAME,
			       TT.REGION_CODE,
			       TBW.SIGN_WAYBILL_TOTAL,
			       TBW.DELIVER_WAYBILL_TOTAL,
			       TOD.RECEIVE_ORDER_TOTAL,
			       TOD.RECEIVE_WAYBILL_ORDER_TOTAL
			  FROM (SELECT DISTINCT PS.VEHICLE_NO,
			                        PS.DRIVER_CODE,
			                        PS.DRIVER_NAME,
			                        VT.VEHICLE_LENGTH_NAME AS VEHICLE_LENGTH,
			                        DECODE(EM.WORK_STATUS,'STOP','暂停','OPEN','开启',EM.WORK_STATUS) AS WORK_STATUS,
			                        RV.REGION_NAME,
			                        RV.REGION_CODE
			          FROM PKP.T_SRV_PDA_SIGN PS
			          INNER JOIN PKP.T_SRV_EMPLOYEEWORKSTATUS EM ON EM.EMP_CODE = PS.DRIVER_CODE
			                AND EM.ACTIVE = 'Y'
			          INNER JOIN BSE.T_BAS_OWN_TRUCK TK
			            ON TK.VEHICLE_NO = PS.VEHICLE_NO
			           AND TK.ACTIVE = 'Y'
			          LEFT JOIN BSE.T_BAS_VEHICLE_TYPE_LENGTH VT
			            ON VT.VEHICLE_LENGTH_CODE = TK.VEHICLE_LENGHT_CODE
			           AND VT.ACTIVE = 'Y'
			          LEFT JOIN BSE.T_BAS_REGION_VEHICLE RV
			            ON RV.VEHICLE_NO = PS.VEHICLE_NO
			           AND RV.ACTIVE = 'Y'
			         WHERE PS.USER_TYPE = 'DRIVER'
			           AND PS.STATUS = 'BUNDLE'
			           <if test="driverCode != null and driverCode != ''">
							AND PS.DRIVER_CODE = #{driverCode,jdbcType=CHAR}
					   </if>
			           <if test="vehicleNo != null and vehicleNo != ''">
							AND PS.VEHICLE_NO = #{vehicleNo,jdbcType=CHAR}
					   </if>
					   <if test="recieveOrderStatus != null and recieveOrderStatus != ''">
							AND EM.WORK_STATUS = #{recieveOrderStatus,jdbcType=CHAR}
					   </if>
			           <if test="regionZoneList != null and regionZoneList.size() > 0">
							AND RV.REGION_CODE IN
							<foreach collection="regionZoneList" item="item" index="index"
								open="(" separator="," close=")">
								#{item}
							</foreach>  
			  		   </if>
			  		   <if test="fleetCodeList != null and fleetCodeList.size() > 0">
							AND TK.ORG_ID IN
							<foreach collection="fleetCodeList" item="item" index="index"
								open="(" separator="," close=")">
								#{item}
							</foreach>  
			  		   </if>
			           ) TT
			  LEFT JOIN (SELECT BILL.DRIVER_CODE AS DRIVER_CODE,
			                    SUM(DECODE(BILL.STATUS,
			                               'CONFIRMED',
			                               1,
			                               'PDA_DOWNLOADED',
			                               1,
			                               'SIGNINFO_CONFIRMED',
			                               1,
			                               0)) AS DELIVER_WAYBILL_TOTAL,
			                    SUM(DECODE(BILL.STATUS, 'SIGNINFO_CONFIRMED', 1, 0)) AS SIGN_WAYBILL_TOTAL
			               FROM PKP.T_SRV_DELIVERBILL BILL
			              INNER JOIN PKP.T_SRV_DELIVERBILL_DETAIL DETAIL
			                 ON BILL.ID = DETAIL.T_SRV_DELIVERBILL_ID
			              WHERE
			              <![CDATA[ BILL.IS_EXPRESS <> 'Y']]>
			              <![CDATA[  AND BILL.SUBMIT_TIME >= TO_DATE(TRUNC(SYSDATE - 1))]]>
			              <![CDATA[  AND BILL.SUBMIT_TIME < TO_DATE(TRUNC(SYSDATE))]]>
			              GROUP BY BILL.DRIVER_CODE) TBW
			    ON TBW.DRIVER_CODE = TT.DRIVER_CODE
			
			  LEFT JOIN (SELECT ORDERS.DRIVER_CODE AS DRIVER_CODE,
			                    SUM(DECODE(ORDERS.ORDER_STATUS,
			                               'PDA_ACCEPT',
			                               1,
			                               'PICKUPING',
			                               1,
			                               0)) AS RECEIVE_ORDER_TOTAL,
			                    SUM(DECODE(ORDERS.ORDER_STATUS, 'WAYBILL', 1, 0)) AS RECEIVE_WAYBILL_ORDER_TOTAL
			               FROM PKP.T_SRV_DISPATCH_ORDER ORDERS
			              WHERE 
			              <![CDATA[ ORDERS.ORDER_VEHICLE_TIME >= TO_DATE(TRUNC(SYSDATE - 1))]]>
			              <![CDATA[  AND ORDERS.ORDER_VEHICLE_TIME < TO_DATE(TRUNC(SYSDATE))]]>
			              AND ORDERS.PRODUCT_CODE not in 
			              <foreach collection="productCodes" item="item" index="index"
								open="(" separator="," close=")">
								#{item}
						  </foreach>
			              
			              GROUP BY ORDERS.DRIVER_CODE) TOD
			    ON TOD.DRIVER_CODE = TT.DRIVER_CODE
	</select>
	
	<!--零担司机签到司机当天记录统计集合查询 -->
	<select id="queryDriverBySignDayCount" resultType="java.lang.Long"
		parameterType="com.deppon.foss.module.pickup.order.api.shared.dto.DriverQueryDto">
		SELECT COUNT(1)
			  FROM (SELECT DISTINCT PS.VEHICLE_NO,
			                        PS.DRIVER_CODE,
			                        PS.DRIVER_NAME,
			                        VT.VEHICLE_LENGTH_NAME AS VEHICLE_LENGTH,
			                        DECODE(EM.WORK_STATUS,'STOP','暂停','OPEN','开启',EM.WORK_STATUS) AS WORK_STATUS,
			                        RV.REGION_NAME,
			                        RV.REGION_CODE
			          FROM PKP.T_SRV_PDA_SIGN PS
			          INNER JOIN PKP.T_SRV_EMPLOYEEWORKSTATUS EM ON EM.EMP_CODE = PS.DRIVER_CODE
			                AND EM.ACTIVE = 'Y'
			          INNER JOIN BSE.T_BAS_OWN_TRUCK TK
			            ON TK.VEHICLE_NO = PS.VEHICLE_NO
			           AND TK.ACTIVE = 'Y'
			          LEFT JOIN BSE.T_BAS_VEHICLE_TYPE_LENGTH VT
			            ON VT.VEHICLE_LENGTH_CODE = TK.VEHICLE_LENGHT_CODE
			           AND VT.ACTIVE = 'Y'
			          LEFT JOIN BSE.T_BAS_REGION_VEHICLE RV
			            ON RV.VEHICLE_NO = PS.VEHICLE_NO
			           AND RV.ACTIVE = 'Y'
			         WHERE PS.USER_TYPE = 'DRIVER'
			           AND PS.STATUS = 'BUNDLE'
			           <if test="driverCode != null and driverCode != ''">
							AND PS.DRIVER_CODE = #{driverCode,jdbcType=CHAR}
					   </if>
			           <if test="vehicleNo != null and vehicleNo != ''">
							AND PS.VEHICLE_NO = #{vehicleNo,jdbcType=CHAR}
					   </if>
					    <if test="recieveOrderStatus != null and recieveOrderStatus != ''">
							AND EM.WORK_STATUS = #{recieveOrderStatus,jdbcType=CHAR}
					   </if>
			           <if test="regionZoneList != null and regionZoneList.size() > 0">
							AND RV.REGION_CODE IN
							<foreach collection="regionZoneList" item="item" index="index"
								open="(" separator="," close=")">
								#{item}
							</foreach>  
			  		   </if>
			  		   <if test="fleetCodeList != null and fleetCodeList.size() > 0">
							AND TK.ORG_ID IN
							<foreach collection="fleetCodeList" item="item" index="index"
								open="(" separator="," close=")">
								#{item}
							</foreach>  
			  		   </if>
			           ) TT
			  LEFT JOIN (SELECT BILL.DRIVER_CODE AS DRIVER_CODE,
			                    SUM(DECODE(BILL.STATUS,
			                               'CONFIRMED',
			                               1,
			                               'PDA_DOWNLOADED',
			                               1,
			                               'SIGNINFO_CONFIRMED',
			                               1,
			                               0)) AS DELIVER_WAYBILL_TOTAL,
			                    SUM(DECODE(BILL.STATUS, 'SIGNINFO_CONFIRMED', 1, 0)) AS SIGN_WAYBILL_TOTAL
			               FROM PKP.T_SRV_DELIVERBILL BILL
			              INNER JOIN PKP.T_SRV_DELIVERBILL_DETAIL DETAIL
			                 ON BILL.ID = DETAIL.T_SRV_DELIVERBILL_ID
			              WHERE
			              <![CDATA[ BILL.IS_EXPRESS <> 'Y']]>
			              <![CDATA[  AND BILL.SUBMIT_TIME >= TO_DATE(TRUNC(SYSDATE - 1))]]>
			              <![CDATA[  AND BILL.SUBMIT_TIME < TO_DATE(TRUNC(SYSDATE))]]>
			              GROUP BY BILL.DRIVER_CODE) TBW
			    ON TBW.DRIVER_CODE = TT.DRIVER_CODE
			
			  LEFT JOIN (SELECT ORDERS.DRIVER_CODE AS DRIVER_CODE,
			                    SUM(DECODE(ORDERS.ORDER_STATUS,
			                               'PDA_ACCEPT',
			                               1,
			                               'PICKUPING',
			                               1,
			                               0)) AS RECEIVE_ORDER_TOTAL,
			                    SUM(DECODE(ORDERS.ORDER_STATUS, 'WAYBILL', 1, 0)) AS RECEIVE_WAYBILL_ORDER_TOTAL
			               FROM PKP.T_SRV_DISPATCH_ORDER ORDERS
			              WHERE 
			              <![CDATA[ ORDERS.ORDER_VEHICLE_TIME >= TO_DATE(TRUNC(SYSDATE - 1))]]>
			              <![CDATA[  AND ORDERS.ORDER_VEHICLE_TIME < TO_DATE(TRUNC(SYSDATE))]]>
			              AND ORDERS.PRODUCT_CODE not in 
			              <foreach collection="productCodes" item="item" index="index"
								open="(" separator="," close=")">
								#{item}
						  </foreach>
			              GROUP BY ORDERS.DRIVER_CODE) TOD
			    ON TOD.DRIVER_CODE = TT.DRIVER_CODE
	</select>
	<!-- liding add -->
	<select id="querySalesPartmentSignedInfoCount" resultType="java.lang.Long">
		select
		/*模块：接送货-查询解除快递员签到-查询签到总数*/
		count(distinct A.ID)
		FROM pkp.t_srv_pda_sign A
		LEFT JOIN BSE.T_BAS_EMPLOYEE B
		ON A.DRIVER_CODE = B.EMP_CODE
		and B.Active = 'Y'
		<include refid="where_querySalesPartmentSignBy" />
	</select>
	<select id="querySalesPartmentSignByDVByPage"
		resultType="com.deppon.foss.module.pickup.order.api.shared.dto.PdaSignDto">
		select /*模块：接送货-查询解除POS机签到*/
		A.ID as id,
		A.DRIVER_NAME as driverName,
		A.DEVICE_NO as deviceNo,
		A.DRIVER_CODE as driverCode,
		A.VEHICLE_NO as vehicleNo,
		A.CREATE_TIME as createTime,
		A.STATUS as status,
		--D.name regionName,
		B.MOBILE_PHONE as empPhone,
		C.VALUE_NAME as memberPosition
		FROM pkp.t_srv_pda_sign A
		inner JOIN BSE.T_BAS_EMPLOYEE B
		ON A.DRIVER_CODE = B.EMP_CODE
		and B.Active = #{active, jdbcType=VARCHAR}
		inner join BSE.T_BAS_DATA_POSTION_DEGREE C
		ON C.VALUE_CODE = B.TITLE
		AND C.ACTIVE = B.ACTIVE 
		And c.active = #{active, jdbcType=VARCHAR}
		<include refid="where_querySalesPartmentSignBy" />
	</select>
	<!--liding add 提供给结算的接口，获取签到的车牌号 -->
	<select id="queryVehicleNoByContidion"
		resultType="java.lang.String">
		select /*模块：接送货-查询签到表中的车牌号*/
		A.VEHICLE_NO
		FROM pkp.t_srv_pda_sign A
				WHERE A.DRIVER_CODE = #{driverCode jdbcType=VARCHAR}
				AND A.STATUS = 'BUNDLE'
				AND A.USER_TYPE !='NCI_USER'
		AND ROWNUM = 1
	</select>
	
	<select id="querySettleStatus" parameterType="java.util.Map" resultType="java.lang.String">
		select  /*根据运单号查询有效的实际承运表结清状态*/
		F.SETTLE_STATUS
		from PKP.T_SRV_ACTUAL_FREIGHT F
		where WAYBILL_NO = #{waybillNo,jdbcType=VARCHAR}
	</select>
	
</mapper>