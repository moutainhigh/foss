<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.deppon.foss.module.pickup.waybill.todoAction">

	<resultMap id="TodoActionDtoMap"
		type="com.deppon.foss.module.pickup.waybill.shared.dto.TodoActionDto">
		<id property="waybillRfcId" column="ID" jdbcType="VARCHAR" />
		<result property="waybillNo" column="WAYBILL_NO" jdbcType="VARCHAR" />
		<result property="status" column="is_printed" jdbcType="VARCHAR" />
		<result property="darftOrgName" column="DRAFT_ORG_NAME" jdbcType="VARCHAR" />		
		<result property="operateOrgName" column="operate_org_name" jdbcType="VARCHAR" />
		<result property="rfcInfo" column="CHANGE_ITEMS" jdbcType="VARCHAR" />
		<result property="darfter" column="DRAFTER" jdbcType="VARCHAR" />
		<result property="operateTime" column="OPERATE_TIME" jdbcType="TIMESTAMP" />
		<result property="startOrgCode" column="RECEIVE_ORG_CODE" jdbcType="VARCHAR" />
		<result property="startOrgName" column="RECEIVE_ORG_NAME" jdbcType="VARCHAR" />
		<result property="targetOrgCode" column="CUSTOMER_PICKUP_ORG_CODE" jdbcType="VARCHAR" />
		<result property="targetOrgName" column="CUSTOMER_PICKUP_ORG_NAME" jdbcType="VARCHAR" />
		<result property="weight" column="GOODS_WEIGHT_TOTAL" jdbcType="DECIMAL" />
		<result property="volume" column="GOODS_VOLUME_TOTAL" jdbcType="DECIMAL" />
		<result property="goodsQtyTotal" column="GOODS_QTY_TOTAL" jdbcType="NUMERIC" />
		<result property="paperNum" column="PAPER_NUM" jdbcType="NUMERIC" />
		<result property="woodNum" column="WOOD_NUM" jdbcType="NUMERIC" />
		<result property="fibreNum" column="FIBRE_NUM" jdbcType="NUMERIC" />
		<result property="salverNum" column="SALVER_NUM" jdbcType="NUMERIC" />
		<result property="membraneNum" column="MEMBRANE_NUM" jdbcType="NUMERIC" />
		<result property="otherPackage" column="OTHER_PACKAGE" jdbcType="VARCHAR" />
		<result property="goodsPackage" column="GOODS_PACKAGE" jdbcType="VARCHAR" />
		<result property="isDestiChage" column="IS_CHANGE_DESTINATION" jdbcType="VARCHAR"/>
	</resultMap>
  
  
	<resultMap id="TodoActionDtoMap2"
		type="com.deppon.foss.module.pickup.waybill.shared.dto.TodoActionDto">
		<id property="waybillRfcId" column="ID" jdbcType="VARCHAR" />
		<result property="waybillNo" column="WAYBILL_NO" jdbcType="VARCHAR" />
		<result property="status" column="is_printed" jdbcType="VARCHAR" />
		<result property="darftOrgName" column="DRAFT_ORG_NAME" jdbcType="VARCHAR" />		
		<result property="operateOrgName" column="operate_org_name" jdbcType="VARCHAR" />
		<result property="rfcInfo" column="CHANGE_ITEMS" jdbcType="VARCHAR" />
		<result property="darfter" column="DRAFTER" jdbcType="VARCHAR" />
		<result property="operateTime" column="OPERATE_TIME" jdbcType="TIMESTAMP" />
		<result property="startOrgCode" column="RECEIVE_ORG_CODE" jdbcType="VARCHAR" />
		<result property="startOrgName" column="RECEIVE_ORG_NAME" jdbcType="VARCHAR" />
		<result property="targetOrgCode" column="CUSTOMER_PICKUP_ORG_CODE" jdbcType="VARCHAR" />
		<result property="targetOrgName" column="CUSTOMER_PICKUP_ORG_NAME" jdbcType="VARCHAR" />
		<result property="weight" column="GOODS_WEIGHT_TOTAL" jdbcType="DECIMAL" />
		<result property="volume" column="GOODS_VOLUME_TOTAL" jdbcType="DECIMAL" />
		<result property="goodsQtyTotal" column="GOODS_QTY_TOTAL" jdbcType="NUMERIC" />
		<result property="paperNum" column="PAPER_NUM" jdbcType="NUMERIC" />
		<result property="woodNum" column="WOOD_NUM" jdbcType="NUMERIC" />
		<result property="fibreNum" column="FIBRE_NUM" jdbcType="NUMERIC" />
		<result property="salverNum" column="SALVER_NUM" jdbcType="NUMERIC" />
		<result property="membraneNum" column="MEMBRANE_NUM" jdbcType="NUMERIC" />
		<result property="otherPackage" column="OTHER_PACKAGE" jdbcType="VARCHAR" />
		<result property="goodsPackage" column="GOODS_PACKAGE" jdbcType="VARCHAR" />
    	<result property="handlerOverNo" column="HANDOVER_NO" jdbcType="VARCHAR" />
		<result property="loadNo" column="VEHICLEASSEMBLE_NO" jdbcType="VARCHAR" />	
		<result property="isDestiChage" column="IS_CHANGE_DESTINATION" jdbcType="VARCHAR"/>
		<collection property="changeDetail" 
			ofType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcChangeDetailEntity"
			column="WAYBILL_RFC_ID">
			<id column="SUBID" property="id" jdbcType="VARCHAR" />
			<result column="RFC_ITEMS" property="rfcItems" jdbcType="VARCHAR" />
			<result column="BEFORE_RFCINFO" property="beforeRfcInfo" jdbcType="VARCHAR" />
			<result column="AFTER_RFCINFO" property="afterRfcInfo" jdbcType="VARCHAR" />
			<result column="RFC_ITEMS_NAME" property="rfcItemsName" jdbcType="VARCHAR" />
		</collection>  
    
    
    
    
	</resultMap>
  
	<resultMap id="LabeledGoodTodoEntityMap"
		type="com.deppon.foss.module.pickup.waybill.shared.domain.LabeledGoodTodoEntity">
		<id property="id" column="T_SRV_LABELEDGOOD_TODO_ID" jdbcType="VARCHAR" />
		<result property="labeledGoodId" column="t_srv_labeled_good_id" jdbcType="VARCHAR" />
		<result property="waybillRfcId" column="T_SRV_WAYBILL_RFC_ID" jdbcType="VARCHAR" />
		<result property="serialNo" column="SERIAL_NO" jdbcType="VARCHAR" />
		<result property="printed" column="IS_PRINTED" jdbcType="CHAR" />
		<result property="waybillRfcId" column="T_SRV_WAYBILL_RFC_ID" jdbcType="VARCHAR" />
		<result property="printTime" column="PRINT_TIME" jdbcType="TIMESTAMP" />
		<result property="remindTime" column="REMIND_TIME" jdbcType="TIMESTAMP" />
	</resultMap>
    
	<resultMap id="LabeledGoodTodoDtoMap"
		type="com.deppon.foss.module.pickup.waybill.shared.dto.LabeledGoodTodoDto">
		<id property="waybillNo" column="WAYBILL_NO" jdbcType="VARCHAR" />
		<result property="darftOrgName" column="DRAFT_ORG_NAME" jdbcType="VARCHAR" />
		<result property="darftTime" column="DRAFT_TIME" jdbcType="TIMESTAMP" />
		<result property="operateTime" column="OPERATE_TIME" jdbcType="TIMESTAMP" />
		<result property="darfter" column="DRAFTER" jdbcType="VARCHAR" />
		<result property="operator" column="OPERATOR" jdbcType="VARCHAR" />
		<result property="todooperator" column="TODO_OPERATOR" jdbcType="VARCHAR" />
		<result property="status" column="STATUS" jdbcType="VARCHAR" />
		<result property="todooperateTime" column="TODO_OPERATE_TIME" jdbcType="TIMESTAMP" />
		<collection property="waybillRfcChangeDetailEntityList" resultMap="WaybillRfcChangeDetailEntityMap"/>
		<collection property="labeledGoodTodoEntityList" resultMap="LabeledGoodTodoEntityMap"/>
	</resultMap>
    
	<resultMap id="WaybillRfcChangeDetailEntityMap"
		type="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcChangeDetailEntity">
		<id property="id" column="DETAIL_ID" jdbcType="VARCHAR" />
		<result property="waybillRfcId" column="T_SRV_WAYBILL_RFC_ID" jdbcType="VARCHAR" />
		<result property="rfcItems" column="RFC_ITEMS" jdbcType="VARCHAR" />
		<result property="beforeRfcInfo" column="BEFORE_RFCINFO" jdbcType="VARCHAR" />
		<result property="afterRfcInfo" column="AFTER_RFCINFO" jdbcType="VARCHAR" />
	</resultMap>
  
	<sql id="from_Where">
     from PKP.T_SRV_WAYBILLRFC rfc 
        inner join PKP.T_SRV_LABELEDGOOD_TODO todo 
        on rfc.id = todo.T_SRV_WAYBILL_RFC_ID
        inner join PKP.T_SRV_WAYBILL wnew 
        on wnew.ID= rfc.NEW_VERSION_WAYBILL_ID
        <if test=" lastLoadOrgCode != null  and lastLoadOrgCode != ''  ">
          INNER JOIN PKP.T_SRV_WAYBILL wb 
          ON wb.ID = rfc.old_version_waybill_id
		</if>
      <if  test=" handlerOverNo != null  and handlerOverNo != ''  ">
       		INNER JOIN TFR.T_OPT_HANDOVERBILL_DETAIL hd
       		on hd.waybill_no= rfc.waybill_no
       </if>
       
       <if  test=" loadNo != null  and loadNo != ''  ">
       		INNER JOIN TFR.T_OPT_HANDOVERBILL_DETAIL hd2 on hd2.waybill_no= rfc.waybill_no 
       		INNER JOIN TFR.T_OPT_HANDOVERBILL hb         on hb.HANDOVER_NO = hd2.HANDOVER_NO 
			inner join tfr.t_opt_vehicleassemble_detail vd on vd.handover_no = hb.handover_no 
			INNER JOIN TFR.T_OPT_VEHICLEASSEMBLEBILL vb on vb.id=vd.VEHICLEASSEMBLEBILL_ID       		
       </if>
        where
        rfc.STATUS= #{rfcStatus,jdbcType=VARCHAR}
        <if test=" isPrinted == ''  ">
			<![CDATA[and todo.IS_PRINTED != 'D' ]]>
		</if>
      <![CDATA[   and todo.STATUS = 'Y' ]]> 
       
		<choose>
			<when test="waybillNo != null and waybillNo != ''">
			<![CDATA[ 
				and wnew.WAYBILL_NO = #{waybillNo,jdbcType=VARCHAR}
			]]> 
			<if test=" currentDept != null  and currentDept != ''  ">
         		<![CDATA[  and todo.handle_org_code in ( #{currentDept,jdbcType=VARCHAR},#{handleOrgCode,jdbcType=VARCHAR} ) ]]> 
            </if>
			</when>
			<otherwise>
       			<if test=" currentDept != null  and currentDept != ''  ">
         			<![CDATA[  and todo.handle_org_code in ( #{currentDept,jdbcType=VARCHAR},#{handleOrgCode,jdbcType=VARCHAR} ) ]]> 
        		</if>
				<if test=" remainTimeBegin != null  and remainTimeBegin != ''  ">
				<![CDATA[and todo.REMIND_TIME >= #{remainTimeBegin,jdbcType=TIMESTAMP} ]]>
				</if>
				<if test=" remainTimeEnd != null  and remainTimeEnd != ''  ">
				<![CDATA[and todo.REMIND_TIME <= #{remainTimeEnd,jdbcType=TIMESTAMP} ]]>
				</if>
				<if test=" operateTimeBegin != null  and operateTimeBegin != ''  ">
				<![CDATA[and rfc.operate_time >= #{operateTimeBegin,jdbcType=TIMESTAMP} ]]>
				</if>
				<if test=" operateTimeEnd != null  and operateTimeEnd != ''  ">
				<![CDATA[and rfc.operate_time <= #{operateTimeEnd,jdbcType=TIMESTAMP} ]]>
				</if>
				<if test=" handlerOverNo != null  and handlerOverNo != ''  ">
				<![CDATA[and hd.HANDOVER_NO = #{handlerOverNo,jdbcType=VARCHAR} ]]>
				</if>
				<if  test=" loadNo != null  and loadNo != ''  ">
				<![CDATA[and vb.VEHICLEASSEMBLE_NO = #{loadNo,jdbcType=VARCHAR} ]]>
				</if>
				<if test=" isPrinted != null  and isPrinted != ''  ">
				<![CDATA[and todo.IS_PRINTED in ( #{isPrinted,jdbcType=VARCHAR} ) ]]>
				</if>
				<if test=" darftOrgCode != null and darftOrgCode != ''  ">
				<![CDATA[and DRAFT_ORG_CODE = #{darftOrgCode,jdbcType=VARCHAR} ]]>
				</if>
				<if test=" lastLoadOrgCode != null  and lastLoadOrgCode != ''  ">
		          and (wb.last_load_org_code = #{lastLoadOrgCode,jdbcType=VARCHAR} or wb.create_org_code = #{lastLoadOrgCode,jdbcType=VARCHAR})
				</if>
				<if test=" operateOrgCode != null  and operateOrgCode != ''  ">
				<![CDATA[and RFC.OPERATE_ORG_CODE = #{operateOrgCode,jdbcType=VARCHAR} ]]>
				</if>
				<if test=" isDestiChage != null  and isDestiChage != ''  ">
				<![CDATA[and RFC.IS_CHANGE_DESTINATION = #{isDestiChage,jdbcType=VARCHAR} ]]>	
				</if>
			</otherwise>
		</choose>
		ORDER BY WNEW.CUSTOMER_PICKUP_ORG_CODE
	</sql>
  
  
	<select id="queryTodoActionsByConditionAll" resultMap="TodoActionDtoMap2" parameterType="com.deppon.foss.module.pickup.waybill.shared.dto.TodoConditionDto">
    select /*模块：接送货-运单-根据查询条件获取待办事项*/
    distinct
    rfc.ID,
    wnew.WAYBILL_NO,
    rfc.DRAFT_ORG_NAME,
    rfc.CHANGE_ITEMS,
    rfc.DRAFTER,
    rfc.OPERATE_TIME,
    rfc.IS_CHANGE_DESTINATION,
    decode(rfc.operate_org_name,'-','更改自动受理',rfc.operate_org_name) operate_org_name,
    todo.is_printed,
    wnew.RECEIVE_ORG_CODE,
    wnew.RECEIVE_ORG_NAME,
    wnew.CUSTOMER_PICKUP_ORG_CODE,
    wnew.CUSTOMER_PICKUP_ORG_NAME,
    wnew.GOODS_WEIGHT_TOTAL,
    wnew.GOODS_VOLUME_TOTAL,
    wnew.GOODS_QTY_TOTAL,
    wnew.PAPER_NUM,
    wnew.WOOD_NUM,
    wnew.FIBRE_NUM,
    wnew.SALVER_NUM,
    wnew.MEMBRANE_NUM,
    wnew.OTHER_PACKAGE,
    wnew.GOODS_PACKAGE,
      changedetail.ID AS SUBID,
      changedetail.RFC_ITEMS AS RFC_ITEMS,
      changedetail.BEFORE_RFCINFO AS BEFORE_RFCINFO,
      changedetail.AFTER_RFCINFO  AS AFTER_RFCINFO,
      changedetail.RFC_ITEMS_NAME AS RFC_ITEMS_NAME
    	<include refid="from_Where"/>
	</select>
  

	<select id="queryTodoActionsByCondition" resultMap="TodoActionDtoMap" parameterType="com.deppon.foss.module.pickup.waybill.shared.dto.TodoConditionDto">
    select /*模块：接送货-运单-根据查询条件获取待办事项*/
    distinct
    rfc.ID,
    wnew.WAYBILL_NO,
    rfc.DRAFT_ORG_NAME,
    rfc.CHANGE_ITEMS,
    rfc.DRAFTER,
    rfc.OPERATE_TIME,
    rfc.IS_CHANGE_DESTINATION,
    decode(rfc.operate_org_name,'-','更改自动受理',rfc.operate_org_name) operate_org_name,
    todo.is_printed,
    wnew.RECEIVE_ORG_CODE,
    wnew.RECEIVE_ORG_NAME,
    wnew.CUSTOMER_PICKUP_ORG_CODE,
    wnew.CUSTOMER_PICKUP_ORG_NAME,
    wnew.GOODS_WEIGHT_TOTAL,
    wnew.GOODS_VOLUME_TOTAL,
    wnew.GOODS_QTY_TOTAL,
    wnew.PAPER_NUM,
    wnew.WOOD_NUM,
    wnew.FIBRE_NUM,
    wnew.SALVER_NUM,
    wnew.MEMBRANE_NUM,
    wnew.GOODS_PACKAGE,
    wnew.OTHER_PACKAGE  
		<include refid="from_Where"/>
	</select>



	<select id="queryGoodsInfoCount" resultType="Long" parameterType="com.deppon.foss.module.pickup.waybill.shared.dto.TodoConditionDto">
         select /*模块：接送货-运单-获得待办事项总条数*/
         count(distinct rfc.ID) 
		<include refid="from_Where"/>
	</select>

	<select id="queryTodoAction" resultMap="LabeledGoodTodoDtoMap" parameterType="java.util.Map">
	<![CDATA[ 
		select /*模块：接送货-运单-查询待办事项详情*/
		rfc.id as T_SRV_WAYBILL_RFC_ID,
		detail.id as DETAIL_ID,
		labeled.id as T_SRV_LABELEDGOOD_TODO_ID,
		labeled.t_srv_labeled_good_id as t_srv_labeled_good_id,
		wnew.WAYBILL_NO AS WAYBILL_NO,
		DRAFT_ORG_NAME,
		DRAFT_TIME,
		rfc.OPERATE_TIME,
		DRAFTER,
		rfc.OPERATOR,
		RFC_ITEMS_NAME AS RFC_ITEMS,
		BEFORE_RFCINFO,
		AFTER_RFCINFO,
		SERIAL_NO,
		IS_PRINTED,
		PRINT_TIME,
		labeled.OPERATOR as TODO_OPERATOR,
		labeled.OPERATE_TIME as TODO_OPERATE_TIME,
		labeled.STATUS,
		labeled.REMIND_TIME as REMIND_TIME
		from PKP.T_SRV_WAYBILLRFC rfc
		inner join PKP.T_SRV_WAYBILLRFC_CHANGEDETAIL detail on rfc.id = detail.WAYBILL_RFC_ID
		inner join PKP.T_SRV_LABELEDGOOD_TODO labeled on rfc.id = labeled.t_srv_waybill_rfc_id
		inner join PKP.T_SRV_WAYBILL wnew  on wnew.id= rfc.NEW_VERSION_WAYBILL_ID

	]]>
		<if test=" lastLoadOrgCode != null  and lastLoadOrgCode != ''  ">
          INNER JOIN PKP.T_SRV_WAYBILL wb 
          ON wb.id = rfc.old_version_waybill_id
		</if>
		<if test=" currentDept != null  and currentDept != ''  ">
         	<![CDATA[  and labeled.handle_org_code in ( #{currentDept,jdbcType=VARCHAR},#{deptCode,jdbcType=VARCHAR} ) ]]> 
        </if>
	<![CDATA[  
		 where rfc.id = #{waybillRfcId,jdbcType=VARCHAR} 
		 and labeled.STATUS=#{status,jdbcType=VARCHAR} 
	]]> 
         order by labeled.SERIAL_NO
	</select>
  
	<update id="updateLabeledPringStatus">

        update PKP.T_SRV_LABELEDGOOD_TODO 
		<set>
          IS_PRINTED = #{isPrinted,jdbcType=CHAR} ,
			<if test="printTime != null and printTime != '' ">
            PRINT_TIME = #{printTime,jdbcType=TIMESTAMP} ,
			</if>
			<if test="operator != null and operator != '' ">
            OPERATOR = #{operator,jdbcType=VARCHAR} ,
			</if>
			<if test="operatorCode != null and operatorCode != '' ">
             OPERATOR_CODE = #{operatorCode,jdbcType=VARCHAR} ,
			</if>
			<if test="operatorTime != null and operatorTime != '' ">
            OPERATE_TIME = #{operatorTime,jdbcType=TIMESTAMP}
			</if>
		</set>
        where ID = #{id,jdbcType=VARCHAR}
	</update>
	
	<update id="updateLabeledPringStatusBatch"  parameterType="java.util.Map">

        update PKP.T_SRV_LABELEDGOOD_TODO 
		<set>
          IS_PRINTED = #{isPrinted,jdbcType=CHAR} ,
			<if test="printTime != null and printTime != '' ">
            PRINT_TIME = #{printTime,jdbcType=TIMESTAMP} ,
			</if>
			<if test="operator != null and operator != '' ">
            OPERATOR = #{operator,jdbcType=VARCHAR} ,
			</if>
			<if test="operatorCode != null and operatorCode != '' ">
             OPERATOR_CODE = #{operatorCode,jdbcType=VARCHAR} ,
			</if>
			<if test="operatorTime != null and operatorTime != '' ">
            OPERATE_TIME = #{operatorTime,jdbcType=TIMESTAMP}
			</if>
		</set>        
        <choose>
			<when test="labeledGoodList!= null and labeledGoodList.size>0">
				where id in
				<foreach collection="labeledGoodList" open="(" close=")" separator=","
					item="labeledGoodId">
					<if test="labeledGoodId!=null and labeledGoodId != ''">
		    	      <![CDATA[	#{labeledGoodId,jdbcType=VARCHAR} ]]>
		            </if>
				</foreach>
			</when>
			<otherwise>
				where id =''
			</otherwise>
		</choose>
	</update>
	
    
    
	<select id="selectById"  resultMap="LabeledGoodTodoEntityMap" parameterType="java.lang.String">
      SELECT 
        ID AS T_SRV_LABELEDGOOD_TODO_ID, T_SRV_TODO_ACTION_ID, SERIAL_NO, IS_PRINTED, T_SRV_WAYBILL_RFC_ID, PRINT_TIME
       FROM  PKP.T_SRV_LABELEDGOOD_TODO t where t.ID = #{id,jdbcType=VARCHAR}
	</select>
    
	<update id="updateLabeledHandleStatusAndTime">
	<![CDATA[ 
		update PKP.T_SRV_LABELEDGOOD_TODO 
		set 
		  STATUS = #{status,jdbcType=VARCHAR},
		  OPERATE_TIME = #{operateTime,jdbcType=TIMESTAMP}
		where t_Srv_Waybill_Rfc_Id = #{waybillRfcId,jdbcType=VARCHAR}
		 and handle_org_code = #{deptCode,jdbcType=VARCHAR}
	]]> 
	</update>
    
	<update id="updateLabeledHandleStatus">
	<![CDATA[ 
		update pkp.T_SRV_LABELEDGOOD_TODO 
		set 
		  STATUS = #{status,jdbcType=VARCHAR}
		where t_Srv_Waybill_Rfc_Id = #{waybillRfcId,jdbcType=VARCHAR}
		 and handle_org_code = #{deptCode,jdbcType=VARCHAR}
	]]> 
	</update>
  
	<update id="updateProcessingStatus">
	<![CDATA[ 
		update PKP.T_SRV_TODO_ACTION 
		set STATUS = #{confirmStatus,jdbcType=VARCHAR} 
		where ID = #{id,jdbcType=VARCHAR}
	]]> 
	</update>

	<select id="queryTodoActionNoPrintCount" resultType="Long">
      SELECT /*模块：接送货-运单-查询未打印的待办条数*/
      COUNT(1)
        FROM pkp.t_srv_labeledgood_todo t1
        where 
        t1.t_Srv_Waybill_Rfc_Id = #{waybillRfcId,jdbcType=VARCHAR}
        and t1.is_printed = #{isPrinted,jdbcType=VARCHAR}
        and t1.handle_org_code = #{handleOrgCode,jdbcType=VARCHAR}
	</select>
	<update id="updateLabeledStatusByWaybillNum" parameterType="java.util.Map" >
    update PKP.T_SRV_LABELEDGOOD_TODO  todo set todo.status='Y' ,todo.is_printed='Y'
    
    where todo.t_srv_waybill_rfc_id  in
    (select id from pkp.t_srv_waybillrfc w 
    where w.waybill_no=#{waybillNum,jdbcType=VARCHAR}
    ) 
		<if test="serials!= null">
        and SERIAL_NO in
			<foreach collection="serials" item="serialNo"
				index="index" open="(" separator="," close=")"> #{serialNo,
          jdbcType=VARCHAR}
			</foreach>
		</if>
	</update>
	
	<resultMap type="com.deppon.foss.module.pickup.waybill.shared.dto.ExceptMsgActionDto" id="exceptMsgMap">
		<id property="waybillRfcId" column="ID" jdbcType="VARCHAR" />
		<result property="waybillNo" column="WAYBILL_NO" jdbcType="VARCHAR" />
		<result property="darftOrgName" column="DRAFT_ORG_NAME" jdbcType="VARCHAR" />
		<result property="rfcInfo" column="CHANGE_ITEMS" jdbcType="VARCHAR" />
		<result property="darfter" column="DRAFTER" jdbcType="VARCHAR" />
		<result property="todoOperateTime" column="OPERATE_TIME" jdbcType="TIMESTAMP" />
	</resultMap>
	
	<!-- 查询异常数量 -->
	<select id="queryLabelGoodTodoExceptMsgCount" resultType="Long" parameterType="com.deppon.foss.module.pickup.waybill.shared.dto.ExceptMsgConditionDto">
		select /*模块：接送货-运单-根据查询异常待办数据异常数量*/
		count(distinct rfc.ID)
		<include refid="from_Where_ExceptMsg"/>
	</select>
	
	<!-- 查询所有的异常信息 -->
	<select id="queryLabelGoodTodoExceptMsg" resultMap="exceptMsgMap" parameterType="com.deppon.foss.module.pickup.waybill.shared.dto.ExceptMsgConditionDto">
		select /*模块：接送货-运单-根据查询条件获取待办事项*/
		    distinct
		    rfc.ID,
		    wnew.WAYBILL_NO,
		    rfc.DRAFT_ORG_NAME,
		    rfc.CHANGE_ITEMS,
		    rfc.DRAFTER,
		    rfc.OPERATE_TIME
		<include refid="from_Where_ExceptMsg"/>
	</select>
	
	<!-- 更新代办事项 -->
	<update id="updateLabelGoodsTodo" parameterType="java.util.Map">
		update /*模块：接送货-运单-根据待办受理部门条件更新异常待办事项*/
		pkp.t_srv_labeledgood_todo todo
		   set todo.status = 'N', todo.exception_msg = 'N'
		   <choose>
		   	<when test="waybillRfcId != null and waybillRfcId != ''">
		   		where todo.t_srv_waybill_rfc_id = #{waybillRfcId,jdbcType=VARCHAR}
		   	</when>
		   	<otherwise>
		   		where todo.t_srv_waybill_rfc_id = ''
		   	</otherwise>
		   </choose>
		   and todo.exception_msg != 'N'
	</update>
	
	<!-- 更新代办事项 -->
	<update id="updatePendTodoLabelGood" parameterType="java.util.Map">
		update  /*模块：接送货-运单-根据只根据待办受理部门条件更新异常待办事项详情*/
		pkp.t_srv_pending_todo  set fail_reason='' 
		<choose>
			<when test="pendTodoIdList!= null and pendTodoIdList.size>0">
				where id in
				<foreach collection="pendTodoIdList" open="(" close=")" separator=","
					item="pendTodoId">
					<if test="pendTodoId!=null and pendTodoId != ''">
		    	      <![CDATA[	#{pendTodoId,jdbcType=VARCHAR} ]]>
		            </if>
				</foreach>
			</when>
			<otherwise>
				where id =''
			</otherwise>
		</choose>
		
		
	</update>
	
	<!-- 未生成代办Dto、PendingMsgActionDto -->
	<resultMap type="com.deppon.foss.module.pickup.waybill.shared.dto.PendingMsgActionDto" id="pendTodoExceptionResultMap">
		<id property="pendTodoId" column="pendTodoId" jdbcType="VARCHAR" />
		<result property="waybillNo" column="WAYBILL_NO" jdbcType="VARCHAR" />
		<result property="darftOrgName" column="draft_org_name" jdbcType="VARCHAR" />
		<result property="pendOperateTime" column="draft_time" jdbcType="TIMESTAMP" />
		<result property="failReason" column="fail_reason" jdbcType="VARCHAR" />
		<result property="changeItem" column="change_items" jdbcType="VARCHAR" />
	</resultMap>
	
	<!-- 查询所有未生成代办 -->
	<select id="queryPendTodoException" resultMap="pendTodoExceptionResultMap" parameterType="com.deppon.foss.module.pickup.waybill.shared.dto.PendingMsgConditionDto">
		select /*模块：接送货-运单-根据查询条件获取未生成待办事项*/
			   distinct todo.id as pendTodoId,
		       rfc.waybill_no     as waybill_no,
		       rfc.draft_org_name as draft_org_name,
		       rfc.draft_time     as draft_time,
		       rfc.change_items   as change_items,
		       todo.fail_reason   as fail_reason
		  from pkp.t_srv_pending_todo todo
		 inner join pkp.t_srv_waybillrfc rfc on rfc.id = todo.waybillrfc_id
		 inner join bse.t_bas_org o on o.code = rfc.draft_org_code and o.active='Y'
		 where todo.fail_reason is not null 
		 <if test="rfcStatus != null and rfcStatus != '' ">
           and rfc.status =  #{rfcStatus,jdbcType=VARCHAR} 
		</if>
		<choose>
			<when test="waybillNo != null and waybillNo != '' ">
				and rfc.waybill_no = #{waybillNo,jdbcType=VARCHAR} 
			</when>
			<otherwise>
				<if test="darftOrgCode != null and darftOrgCode != '' ">
		            and rfc.drafter_code = #{darftOrgCode,jdbcType=VARCHAR} 
				</if>
				<if test="pendOperateTimeBegin != null and pendOperateTimeBegin != '' ">
		           <![CDATA[  and rfc.operate_time >= #{pendOperateTimeBegin,jdbcType=TIMESTAMP}]]> 
				</if>
				<if test="pendOperateTimeEnd != null and pendOperateTimeEnd != '' ">
		           <![CDATA[  and rfc.operate_time <= #{pendOperateTimeEnd,jdbcType=TIMESTAMP} ]]> 
				</if>
				<if test="keyWord != null and keyWord !=''">
					<![CDATA[AND todo.FAIL_REASON LIKE '%'||#{keyWord}||'%']]>
				</if>
			</otherwise>
		</choose>
	</select>
	
	<select id="queryPendTodoExceptionCount" resultType="Long">
		select /*模块：接送货-运单-根据查询条件获取未生成待办事项*/
			count(1)
		  from pkp.t_srv_pending_todo todo
		 inner join pkp.t_srv_waybillrfc rfc
		    on rfc.id = todo.waybillrfc_id
		 where todo.fail_reason is not null
		 <if test="rfcStatus != null and rfcStatus != '' ">
            and rfc.status =  #{rfcStatus,jdbcType=VARCHAR} 
		</if>
		<choose>
			<when test="waybillNoList!= null and waybillNoList.size>0">
				 and rfc.waybill_no in
				<foreach collection="waybillNoList" open="(" close=")" separator="," item="waybillNo">
					<if test="waybillNo != null and waybillNo != ''">
			    	      <![CDATA[	#{waybillNo,jdbcType=VARCHAR} ]]>
			        </if>
				</foreach>
			</when>
			<otherwise>
				<if test="darftOrgCode != null and darftOrgCode != '' ">
		            and rfc.drafter_code = #{darftOrgCode,jdbcType=VARCHAR} 
				</if>
				<if test="pendOperateTimeBegin != null and pendOperateTimeBegin != '' ">
		           <![CDATA[  and rfc.operate_time >= #{pendOperateTimeBegin,jdbcType=TIMESTAMP}]]> 
				</if>
				<if test="pendOperateTimeEnd != null and pendOperateTimeEnd != '' ">
		           <![CDATA[  and rfc.operate_time <= #{pendOperateTimeEnd,jdbcType=TIMESTAMP} ]]> 
				</if>
				<if test="keyWord != null and keyWord !=''">
					<![CDATA[AND todo.FAIL_REASON LIKE '%'||#{keyWord}||'%']]>
				</if>
			</otherwise>
		</choose>
	</select>
	
	<!-- 查询异常的SQL语句 -->
	  <sql id="from_Where_ExceptMsg">
	     from PKP.T_SRV_WAYBILLRFC rfc 
	        inner join PKP.T_SRV_LABELEDGOOD_TODO todo 
	        on rfc.id = todo.T_SRV_WAYBILL_RFC_ID
	        inner join PKP.T_SRV_WAYBILL wnew 
	        on wnew.id= rfc.NEW_VERSION_WAYBILL_ID
	        <choose>
	        	<when test="waybillNoList == null">
					left JOIN TFR.T_OPT_HANDOVERBILL_DETAIL hd2 on hd2.waybill_no= rfc.waybill_no 
			        left JOIN TFR.T_OPT_HANDOVERBILL hb         on hb.HANDOVER_NO = hd2.HANDOVER_NO 
			        left join tfr.t_opt_vehicleassemble_detail vd on vd.handover_no = hb.handover_no 
			        left JOIN TFR.T_OPT_VEHICLEASSEMBLEBILL vb on vb.id=vd.VEHICLEASSEMBLEBILL_ID
				</when>
	        </choose>
	        where
	        <![CDATA[ rfc.STATUS= #{rfcStatus,jdbcType=VARCHAR} ]]>         
		    <choose>
		    	<when test="waybillNoList!= null and waybillNoList.size>0">
					and wnew.WAYBILL_NO in
					<foreach collection="waybillNoList" open="(" close=")" separator=","
						item="waybillNo">
						<if test="waybillNo != null and waybillNo != ''">
				    	      <![CDATA[	#{waybillNo,jdbcType=VARCHAR} ]]>
				        </if>
					</foreach>
				</when>
			    <otherwise>
			    	<![CDATA[ and todo.STATUS = 'N' and todo.exception_msg <> 'N' ]]>
				    <if test=" handlerOverNo != null  and handlerOverNo != ''  ">
						<![CDATA[and hb.HANDOVER_NO = #{handlerOverNo,jdbcType=VARCHAR} ]]>
					</if>
					<if test=" loadNo != null  and loadNo != ''  ">
						<![CDATA[and vb.VEHICLEASSEMBLE_NO = #{loadNo,jdbcType=VARCHAR} ]]>
					</if>
					<if test=" todoOperateTimeBegin != null  and todoOperateTimeBegin != ''  ">
			        	<![CDATA[and rfc.operate_time >= #{todoOperateTimeBegin,jdbcType=TIMESTAMP} ]]>
			        </if>
			        <if test=" todoOperateTimeEnd != null  and todoOperateTimeEnd != ''  ">
			        	<![CDATA[and rfc.operate_time <= #{todoOperateTimeEnd,jdbcType=TIMESTAMP} ]]>
			        </if>
				    <if test=" darftOrgCode != null and darftOrgCode != ''  ">
				    	<![CDATA[and DRAFT_ORG_CODE = #{darftOrgCode,jdbcType=VARCHAR} ]]>
				    </if>
				    <if test="inStockOrgCode != null and inStockOrgCode !=''">
						<![CDATA[AND ( todo.EXCEPTION_MSG LIKE '%'||#{inStockOrgCode}||'%'  or todo.EXCEPTION_MSG LIKE '%'||#{inStockOrgName}||'%' )]]>
					</if>	
					<if test="keyWord != null and keyWord !=''">
						<![CDATA[AND todo.EXCEPTION_MSG LIKE '%'||#{keyWord}||'%']]>
					</if>
		      </otherwise>
	    </choose>    
  </sql>
  
  <resultMap type="com.deppon.foss.module.pickup.waybill.shared.dto.LabelGoodTodoDto" id="labelGoodTodoExceptMsg">
  	<id property="labelGoodId" column="id" jdbcType="VARCHAR" />
		<result property="waybillRfcId" column="waybillRfcId" jdbcType="VARCHAR" />
		<result property="serialNo" column="serial_no" jdbcType="VARCHAR" />
		<result property="exceptionMsg" column="exception_msg" jdbcType="VARCHAR" />
		<result property="waybillNo" column="waybill_no" jdbcType="VARCHAR" />
  </resultMap>
  
  <select id="queryLabelGoodTodo" resultMap="labelGoodTodoExceptMsg" parameterType="java.util.Map">
  	<![CDATA[
	 select /*模块：接送货-运单-根据只根据待办受理部门条件获取异常待办事项详情*/
	 todo.id            as id,
	 todo.serial_no     as serial_no,
	 todo.exception_msg as exception_msg,
	 rfc.waybill_no     as waybill_no,
	 rfc.id             as waybillRfcId
	  from pkp.t_srv_labeledgood_todo todo
	 inner join pkp.t_srv_waybillrfc rfc
	    on rfc.id = todo.t_srv_waybill_rfc_id
	 where rfc.id = #{waybillRfcId,jdbcType=VARCHAR}
	   and todo.EXCEPTION_MSG <> 'N'
	 order by todo.serial_no]]>
  </select>
  
  <select id="queryGoodsInfoWithHandleOrgCount" resultType="Long" 
  parameterType="com.deppon.foss.module.pickup.waybill.shared.dto.TodoConditionDto">
  	select /*模块：接送货-运单-根据只根据待办受理部门条件获取待办事项条数*/
    count(distinct rfc.ID)
		<include refid="new_from_Where"/>
  </select>
  
  <select id="queryTodoActionsByConditionWithHandleOrg" resultMap="TodoActionDtoMap"
  parameterType="com.deppon.foss.module.pickup.waybill.shared.dto.TodoConditionDto">
  	select /*模块：接送货-运单-根据只根据待办受理部门条件获取待办事项*/
    distinct
    rfc.ID,
	todo.handle_org_code handle_org_code,
    wnew.WAYBILL_NO,
    rfc.DRAFT_ORG_NAME,
    rfc.CHANGE_ITEMS,
    rfc.DRAFTER,
    rfc.OPERATE_TIME,
    decode(rfc.operate_org_name,'-','更改自动受理',rfc.operate_org_name) operate_org_name,
    todo.is_printed,
    wnew.RECEIVE_ORG_CODE,
    wnew.RECEIVE_ORG_NAME,
    wnew.CUSTOMER_PICKUP_ORG_CODE,
    wnew.CUSTOMER_PICKUP_ORG_NAME,
    wnew.GOODS_WEIGHT_TOTAL,
    wnew.GOODS_VOLUME_TOTAL,
    wnew.GOODS_QTY_TOTAL,
    wnew.PAPER_NUM,
    wnew.WOOD_NUM,
    wnew.FIBRE_NUM,
    wnew.SALVER_NUM,
    wnew.MEMBRANE_NUM,
    wnew.GOODS_PACKAGE,
    wnew.OTHER_PACKAGE
		<include refid="new_from_Where"/>
  </select>
  
  <sql id="new_from_Where">
     from PKP.T_SRV_WAYBILLRFC rfc 
        inner join PKP.T_SRV_LABELEDGOOD_TODO todo 
        on rfc.id = todo.T_SRV_WAYBILL_RFC_ID
        inner join PKP.T_SRV_WAYBILL wnew 
        on wnew.id= rfc.NEW_VERSION_WAYBILL_ID
		<if test=" lastLoadOrgCode != null  and lastLoadOrgCode != ''  ">
          INNER JOIN PKP.T_SRV_WAYBILL wb 
          ON wb.id = rfc.old_version_waybill_id
		</if>
		       
		 left JOIN TFR.T_OPT_HANDOVERBILL_DETAIL hd
           on hd.waybill_no= rfc.waybill_no
           left JOIN TFR.T_OPT_HANDOVERBILL_DETAIL hd2 on hd2.waybill_no= rfc.waybill_no 
           left JOIN TFR.T_OPT_HANDOVERBILL hb         on hb.HANDOVER_NO = hd2.HANDOVER_NO 
      left join tfr.t_opt_vehicleassemble_detail vd on vd.handover_no = hb.handover_no 
      left JOIN TFR.T_OPT_VEHICLEASSEMBLEBILL vb on vb.id=vd.VEHICLEASSEMBLEBILL_ID
      
        where
        rfc.STATUS= #{rfcStatus,jdbcType=VARCHAR}
        and todo.STATUS = 'Y'  
		<choose>
			<when test="waybillNo != null and waybillNo != ''">
			<![CDATA[ 
				and wnew.WAYBILL_NO = #{waybillNo,jdbcType=VARCHAR}
			]]> 
			</when>
			<otherwise>
				<if test=" remainTimeBegin != null  and remainTimeBegin != ''  ">
				<![CDATA[and todo.REMIND_TIME >= #{remainTimeBegin,jdbcType=TIMESTAMP} ]]>
				</if>
				<if test=" remainTimeEnd != null  and remainTimeEnd != ''  ">
				<![CDATA[and todo.REMIND_TIME <= #{remainTimeEnd,jdbcType=TIMESTAMP} ]]>
				</if>
				<if test=" operateTimeBegin != null  and operateTimeBegin != ''  ">
				<![CDATA[and rfc.operate_time >= #{operateTimeBegin,jdbcType=TIMESTAMP} ]]>
				</if>
				<if test=" operateTimeEnd != null  and operateTimeEnd != ''  ">
				<![CDATA[and rfc.operate_time <= #{operateTimeEnd,jdbcType=TIMESTAMP} ]]>
				</if>
				<if test=" handlerOverNo != null  and handlerOverNo != ''  ">
				<![CDATA[and hd.HANDOVER_NO = #{handlerOverNo,jdbcType=VARCHAR} ]]>
				</if>
				<if  test=" loadNo != null  and loadNo != ''  ">
				<![CDATA[and vb.VEHICLEASSEMBLE_NO = #{loadNo,jdbcType=VARCHAR} ]]>
				</if>
				<if test=" darftOrgCode != null  and darftOrgCode != ''  ">
		           <![CDATA[and rfc.DRAFT_ORG_CODE = #{darftOrgCode,jdbcType=VARCHAR} ]]>
				</if>
				<if test=" isPrinted != null  and isPrinted != ''  ">
				<![CDATA[and todo.IS_PRINTED = #{isPrinted,jdbcType=VARCHAR} ]]>
				</if>
				<if test=" operateOrgCode != null and operateOrgCode != ''  ">
				<![CDATA[and rfc.OPERATE_ORG_CODE = #{operateOrgCode,jdbcType=VARCHAR} ]]>
				</if>
			</otherwise>
		</choose>		
	</sql>
	
	<update id="updateExceptMsgBatchStatus"  parameterType="java.util.Map">
		 update PKP.T_SRV_LABELEDGOOD_TODO 
		<set>
          IS_PRINTED = #{isPrint,jdbcType=CHAR} ,
		  PRINT_TIME = #{printTime,jdbcType=CHAR} ,
		  STATUS = #{status,jdbcType=CHAR} ,
		  EXCEPTION_MSG = #{exceptMsg,jdbcType=CHAR} ,
		  HANDLE_ORG_CODE = #{handleOrgCode,jdbcType=CHAR} ,
		  HANDLE_ORG_NAME = #{handleOrgName,jdbcType=CHAR} ,
		  NEED_RESTOCK = #{needRestock,jdbcType=CHAR} ,
		</set>        
        <choose>
			<when test="waybillRfcIdList!= null and waybillRfcIdList.size>0">
				where T_SRV_WAYBILL_RFC_ID in
				<foreach collection="waybillRfcIdList" open="(" close=")" separator=","
					item="waybillRfcId">
					<if test="waybillRfcId!=null and waybillRfcId != ''">
		    	      <![CDATA[	#{waybillRfcId,jdbcType=VARCHAR} ]]>
		            </if>
				</foreach>
			</when>
			<otherwise>
				where id =''
			</otherwise>
		</choose>
	</update>
	
	
	<resultMap id="latestHandoverDtoMap"
		type="com.deppon.foss.module.pickup.waybill.shared.dto.LatestHandOverDto">
		<result property="serialNo" column="serialNo" jdbcType="VARCHAR" />
		<result property="waybillNo" column="waybillNo" jdbcType="VARCHAR" />
		<result property="serialNo" column="serialNo" jdbcType="VARCHAR" />
		<result property="productName" column="productName" jdbcType="VARCHAR" />
		<result property="receiveCustomerName" column="receiveCustomerName" jdbcType="VARCHAR" />
		<result property="customerPickUpOrgName" column="customerPickUpOrgName" jdbcType="VARCHAR" />
		<result property="handoverBillNo" column="handoverBillNo" jdbcType="VARCHAR" />
		<result property="vehicleAssembleNo" column="vehicleAssembleNo" jdbcType="VARCHAR" />
		<result property="isInstock" column="isInstock" jdbcType="VARCHAR" />
	</resultMap>
	<!---->
	<select id="queryLatestHandoverDto" resultMap="latestHandoverDtoMap" parameterType="com.deppon.foss.module.pickup.waybill.shared.dto.TodoConditionDto">
		SELECT lab.waybill_no waybillNo,
			       lab.serial_no serialNo,
			       p.name productName,
			       decode(s.org_code, #{handleOrgCode, jdbcType=VARCHAR}, 'Y',
		       					 #{currentDept, jdbcType=VARCHAR}, 'Y',
			       <if test="lastLoadOrgCode!=null and lastLoadOrgCode != ''">
			    	  #{lastLoadOrgCode, jdbcType=VARCHAR}, 'Y',
			       </if>
		        	'N') isInstock,
			       receive.name receiveCustomerName,
			       w.CUSTOMER_PICKUP_ORG_name customerPickUpOrgName,
			       hs.handoverbill_no handoverBillNo,
			       v.vehicleassemble_no vehicleAssembleNo
			  FROM pkp.t_srv_labeled_good lab
			  left join TFR.T_OPT_STOCK S on lab.waybill_no = S.waybill_no
			                             and lab.serial_no = s.serial_no
			                             and lab.active = 'Y'
			  left JOIN PKP.T_SRV_WAYBILL W ON W.WAYBILL_NO = lab.WAYBILL_NO
			                               and w.active = 'Y'
			  left join pkp.t_srv_product p on p.code = w.product_code
			                               and p.active = 'Y'
			  left join bse.t_bas_org receive on receive.code = w.receive_org_code
			                                 and receive.active = 'Y'
			  left join (select max(h.create_time) createTime, H.SERIAL_NO, H.WAYBILL_NO
			               FROM pkp.t_srv_labeled_good l
			               JOIN TFR.T_OPT_HANDOVERBILL_SERIALNO H ON H.WAYBILL_NO =
			                                                              #{waybillNo, jdbcType=VARCHAR}
			                                                          AND H.WAYBILL_NO = l.WAYBILL_NO
			                                                          AND H.SERIAL_NO =
			                                                              l.SERIAL_NO
			                                                          and l.active='Y'
			              group by H.SERIAL_NO, H.WAYBILL_NO) hhs on lab.WAYBILL_NO =
			                                                  hhs.WAYBILL_NO
			                                              AND lab.SERIAL_NO =
			                                                  hhs.SERIAL_NO
			  LEFT JOIN TFR.T_OPT_HANDOVERBILL_SERIALNO HS ON HS.WAYBILL_NO =
			                                                  hhs.WAYBILL_NO
			                                              AND HS.SERIAL_NO =
			                                                  hhs.SERIAL_NO
			                                              and hhs.createTime =
			                                                  hs.create_time
			  LEFT JOIN tfr.t_opt_vehicleassemble_detail d ON d.handover_no =
			                                                  hs.handoverbill_no
			  LEFT JOIN tfr.t_opt_vehicleassemblebill v ON v.id =
			                                               d.vehicleassemblebill_id
			WHERE lab.waybill_no = #{waybillNo, jdbcType=VARCHAR} and lab.active='Y'
	</select>
		
	<update id="updateAllNotPrintLabeledBatch"  parameterType="java.util.Map">

        update PKP.T_SRV_LABELEDGOOD_TODO 
		<set>
          IS_PRINTED = #{isPrinted,jdbcType=CHAR} ,
			<if test="printTime != null and printTime != '' ">
            PRINT_TIME = #{printTime,jdbcType=TIMESTAMP} ,
			</if>
			<if test="operator != null and operator != '' ">
            OPERATOR = #{operator,jdbcType=VARCHAR} ,
			</if>
			<if test="operatorCode != null and operatorCode != '' ">
             OPERATOR_CODE = #{operatorCode,jdbcType=VARCHAR} ,
			</if>
			<if test="operatorTime != null and operatorTime != '' ">
            OPERATE_TIME = #{operatorTime,jdbcType=TIMESTAMP}
			</if>
		</set>        
        <choose>
			<when test="labelGoodsIdList!= null and labelGoodsIdList.size>0">
				where T_SRV_LABELED_GOOD_ID in
				<foreach collection="labelGoodsIdList" open="(" close=")" separator=","
					item="labeledGoodId">
					<if test="labeledGoodId!=null and labeledGoodId != ''">
		    	      <![CDATA[	#{labeledGoodId,jdbcType=VARCHAR} ]]>
		            </if>
				</foreach>
				<if test=" status != null  and status != ''  ">
		         	and STATUS=#{status,jdbcType=VARCHAR}
		        </if>
		        <if test=" isPrint != null  and isPrint != ''  ">
		         	and IS_PRINTED=#{isPrint,jdbcType=VARCHAR}
		        </if>
			</when>
			<otherwise>
				where T_SRV_LABELED_GOOD_ID =''
			</otherwise>
		</choose>
	</update>
	
	<update id="updateTodoByHandoverBillNo" parameterType="java.util.Map">
		UPDATE PKP.T_SRV_LABELEDGOOD_TODO TODO SET 
		<if test="handleOrgName !=null and handleOrgName != ''">
  	      <![CDATA[	TODO.HANDLE_ORG_NAME=#{handleOrgName,jdbcType=VARCHAR}, ]]>
        </if>
        <if test="handleOrgCode !=null and handleOrgCode != ''">
  	      <![CDATA[	TODO.HANDLE_ORG_CODE=#{handleOrgCode,jdbcType=VARCHAR}, ]]>
        </if>
        <if test="remindTime !=null and remindTime != ''">
  	      <![CDATA[	TODO.REMIND_TIME=#{remindTime,jdbcType=TIMESTAMP}, ]]>
        </if>
        TODO.STATUS='Y',TODO.EXCEPTION_MSG='N' WHERE TODO.T_SRV_LABELED_GOOD_ID IN
       <if test="serilalIdList !=null and serilalIdList.size() >0 ">
       		<foreach collection="serilalIdList" open="(" close=")" separator="," item="serilalId">
				<if test="serilalId !=null and serilalId != ''">
	    	      <![CDATA[	#{serilalId,jdbcType=VARCHAR} ]]>
	            </if>
			</foreach>
       </if>		       
		AND TODO.EXCEPTION_MSG = 'N' AND TODO.STATUS = 'N'
	</update>
	
	<select id="selectMaxCountHandoverSerialNo" resultType="java.lang.String" parameterType="java.util.Map">
		SELECT G.ID FROM PKP.T_SRV_LABELED_GOOD G LEFT JOIN TFR.T_OPT_HANDOVERBILL_SERIALNO SER 
		ON SER.WAYBILL_NO=G.WAYBILL_NO AND G.SERIAL_NO=SER.SERIAL_NO AND G.ACTIVE='Y' WHERE SER.HANDOVERBILL_NO 
		IN <foreach collection="handoverBillNoList" open="(" close=")" separator="," item="handoverBillNo">
			<if test="handoverBillNo !=null and handoverBillNo != ''">
    	      <![CDATA[	#{handoverBillNo,jdbcType=VARCHAR} ]]>
            </if>
		</foreach>
	</select>
	
	<select id="queryWaybillInfoForWvhNotSigned" resultType="com.deppon.foss.module.pickup.waybill.shared.dto.PickupToDoMsgDto" parameterType="java.util.Map">
    	SELECT W.WAYBILL_NO noDealData, W.RECEIVE_ORG_CODE receiveOrgCode,'pkp.notsignbil' businessType FROM PKP.T_SRV_WAYBILL W JOIN PKP.T_SRV_ACTUAL_FREIGHT AC ON W.WAYBILL_NO = AC.WAYBILL_NO
 		WHERE AC.STATUS NOT IN ('OBSOLETE', 'ABORTED') AND W.ACTIVE = 'Y'
 		<if test="orgCode != null and orgCode != ''">
 			AND (W.RECEIVE_ORG_CODE = #{orgCode,jdbcType=VARCHAR} AND W.IS_PASS_OWN_DEPARTMENT NOT IN ('Y')
    		 OR (W.CUSTOMER_PICKUP_ORG_CODE = #{orgCode,jdbcType=VARCHAR} AND W.IS_PASS_OWN_DEPARTMENT = 'Y'))
 		</if>
 		<if test="productCode != null and productCode != ''">
 			AND W.PRODUCT_CODE = #{productCode,jdbcType=VARCHAR}
 		</if> 
       <if test="days != null and days.size()>0">
        AND 
        <foreach collection="days" item="day" index="index" open="(" separator="OR" close=")"> 
          TRUNC(W.BILL_TIME) = TRUNC(SYSDATE - #{day,jdbcType=DECIMAL})
        </foreach>
       </if>
       AND NOT EXISTS (SELECT 1 FROM PKP.T_SRV_WAYBILL_SIGN_RESULT S WHERE S.WAYBILL_NO = W.WAYBILL_NO)
  </select>
</mapper>