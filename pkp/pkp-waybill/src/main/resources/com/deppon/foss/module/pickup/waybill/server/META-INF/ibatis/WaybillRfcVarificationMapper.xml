<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.deppon.foss.pkp.waybillRfcVarificationMapper">
	<!-- 更改单受理 -->
	<resultMap
		type="com.deppon.foss.module.pickup.waybill.shared.dto.WaybillRfcChangeDto"
		id="WaybillRfcVarifiDtoResultMap">
		<result column="ID" property="changeBillId" jdbcType="VARCHAR" />
		<result column="WAYBILL_NO" property="waybillNumber" jdbcType="VARCHAR" />
		<result column="PROCESSSTATUS" property="dealStauts" jdbcType="VARCHAR" />
		<result column="RFC_SOURCE" property="rfcSource" jdbcType="VARCHAR" />
		<result column="RFC_REASON" property="rfcReason" jdbcType="VARCHAR" />
		<result column="DRAFT_ORG_NAME" property="applyDeptName" jdbcType="VARCHAR" />
		<result column="DRAFT_ORG_CODE" property="applyDeptCode" jdbcType="VARCHAR" />
		<result column="DRAFTER" property="applyPerson" jdbcType="VARCHAR" />
		<result column="OPERATE_ORG_NAME" property="handleDeptName"	jdbcType="VARCHAR" />
		<result column="OPERATE_ORG_CODE" property="handleDeptCode"	jdbcType="VARCHAR" />
		<result column="OPERATOR" property="handlePerson" jdbcType="VARCHAR" />
		<result column="DRAFT_TIME" property="applyTime" jdbcType="TIMESTAMP" />
		<result column="OPERATE_TIME" property="handleTime" jdbcType="TIMESTAMP" />
		<result column="NOTES" property="handleNotes" jdbcType="VARCHAR"/>
		<result column="RFC_TYPE" property="rfcType" jdbcType="VARCHAR"/>
	</resultMap>
	<!-- 更改单审核 -->
	<resultMap type="com.deppon.foss.module.pickup.waybill.shared.dto.WaybillRfcChangeDto" id="WaybillRfcCheckDtoResultMap">
		<result column="ID" property="changeBillId" jdbcType="VARCHAR" />
		<result column="WAYBILL_NO" property="waybillNumber" jdbcType="VARCHAR" />
		<result column="CHECKSTATUS" property="dealStauts" jdbcType="VARCHAR" />
		<result column="RFC_TYPE" property="rfcType" jdbcType="VARCHAR" />
		<result column="RFC_REASON" property="rfcReason" jdbcType="VARCHAR" />
		<result column="DRAFT_ORG_NAME" property="applyDeptName" jdbcType="VARCHAR" />
		<result column="DRAFT_ORG_CODE" property="applyDeptCode" jdbcType="VARCHAR" />
		<result column="DRAFTER" property="applyPerson" jdbcType="VARCHAR" />
		<result column="OPERATE_ORG_NAME" property="handleDeptName"	jdbcType="VARCHAR" />
		<result column="OPERATE_ORG_CODE" property="handleDeptCode"	jdbcType="VARCHAR" />
		<result column="OPERATOR" property="handlePerson" jdbcType="VARCHAR" />
		<result column="DRAFT_TIME" property="applyTime" jdbcType="TIMESTAMP" />
		<result column="OPERATE_TIME" property="handleTime" jdbcType="TIMESTAMP" />
		<result column="NOTES" property="checkNotes" jdbcType="VARCHAR"/>
		<result column ="CHECKPERSON" property="checkPerson" jdbcType="VARCHAR"/>
		<result column="CHECKPERSONCODE" property="checkPersonCode" jdbcType="VARCHAR"/>
		<result column="CHECKTIME" property="checkDate" jdbcType="TIMESTAMP"/>
		<result column="RFC_TYPE" property="rfcType" jdbcType="VARCHAR"/>
	</resultMap>
	<!-- 更改单受理审核 -->
		<resultMap
		type="com.deppon.foss.module.pickup.waybill.shared.dto.WaybillRfcChangeDto"
		id="WaybillRfcVarifiDtoCheckAndProResultMap">
		<result column="ID" property="changeBillId" jdbcType="VARCHAR" />
		<result column="WAYBILL_NO" property="waybillNumber" jdbcType="VARCHAR" />
		<result column="PROCESSSTATUS" property="dealStauts" jdbcType="VARCHAR" />
		<result column="CHECKSTATUS" property="checkStatus" jdbcType="VARCHAR"/>
		<result column="RFC_SOURCE" property="rfcSource" jdbcType="VARCHAR" />
		<result column="RFC_REASON" property="rfcReason" jdbcType="VARCHAR" />
		<result column="NEW_VERSION_WAYBILL_ID" property="newWaybillId" jdbcType="VARCHAR" />
		<result column="DRAFT_ORG_NAME" property="applyDeptName" jdbcType="VARCHAR" />
		<result column="DRAFT_ORG_CODE" property="applyDeptCode" jdbcType="VARCHAR" />
		<result column="DRAFTER" property="applyPerson" jdbcType="VARCHAR" />
		<result column="OPERATE_ORG_NAME" property="handleDeptName"	jdbcType="VARCHAR" />
		<result column="OPERATE_ORG_CODE" property="handleDeptCode"	jdbcType="VARCHAR" />
		<result column="HANDLEPERSON" property="handlePerson" jdbcType="VARCHAR" />
		<result column="DRAFT_TIME" property="applyTime" jdbcType="TIMESTAMP" />
		<result column="PROCESS_TIME" property="handleTime" jdbcType="TIMESTAMP" />
		<result column="HANDLENOTES" property="handleNotes" jdbcType="VARCHAR"/>
		<result column="CHECKNOTES" property="checkNotes" jdbcType="VARCHAR"/>
		<result column="CHECKPERSON" property="checkPerson" jdbcType="VARCHAR"/>
		<result column="CHECKPERSONCODE" property="checkPersonCode" jdbcType="VARCHAR"/>
		<result column="CHECKDATE" property="checkDate" jdbcType="VARCHAR"/>
		<result column="RFC_TYPE" property="rfcType" jdbcType="VARCHAR"/>
	</resultMap>
	<!-- 更改单打印查询ResultMap -->
	<resultMap type="com.deppon.foss.module.pickup.waybill.shared.dto.WaybillRfcPrintDto" id="waybillRfcPrintResultMap">
		<result column="WAYBILLNO" property="waybillNo" jdbcType="VARCHAR"/>
		<result column="RFCREASON" property="rfcReason" jdbcType="VARCHAR"/>
		<result column="APPLYDEPT" property="applyDept" jdbcType="VARCHAR"/>
		<result column="APPLYPERSON" property="applyPerson" jdbcType="VARCHAR"/>
		<result column="APPLYTIME" property="applyTime" jdbcType="TIMESTAMP"/>
		<result column="GOODSNAME" property="goodsName" jdbcType="VARCHAR"/>
		<result column="PACK" property="pack" jdbcType="VARCHAR"/>
		<result column="RFCTYPE" property="rfcType" jdbcType="VARCHAR"/>
		<result column="PRODUCTCODE" property="productCode" jdbcType="VARCHAR"/>
		<result column="CUSTOMERPICKUPORGCODE" property="customerPickupOrgCode" jdbcType="VARCHAR"/>
		<result column="TARGETORGCODE" property="targetOrgCode" jdbcType="VARCHAR"/>
		<result column="PIECES" property="pieces" jdbcType="DECIMAL"/>
		<result column="WEIGHT" property="weight" jdbcType="DECIMAL"/>
		<result column="VOLUME" property="volume" jdbcType="DECIMAL"/>
		<result column="DIMENSION" property="dimension" jdbcType="CLOB"  typeHandler="org.apache.ibatis.type.ClobTypeHandler"/>
		<collection property="changeList"
					ofType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcChangeDetailEntity"
					resultMap="WaybillRfcChangeDetailResultMap"></collection>
	</resultMap>
	<!-- 更改打印查询 -->
	<sql id="waybillRfc_printInfo_select">
		SELECT /*模块：接送货-运单-更改打印查询*/
		WAYBILL.WAYBILL_NO WAYBILLNO,
		WAYBILLRFC.RFC_REASON RFCREASON,
		WAYBILLRFC.DRAFT_ORG_NAME APPLYDEPT,
		WAYBILLRFC.DRAFTER APPLYPERSON,
		WAYBILLRFC.DRAFT_TIME APPLYTIME,
		WAYBILLRFC.RFC_TYPE RFCTYPE,
		WAYBILL.GOODS_NAME GOODSNAME,
		WAYBILL.GOODS_PACKAGE PACK,
		WAYBILL.GOODS_QTY_TOTAL PIECES,
		WAYBILL.GOODS_WEIGHT_TOTAL WEIGHT,
		WAYBILL.GOODS_VOLUME_TOTAL VOLUME,
		WAYBILL.GOODS_SIZE DIMENSION,
		WAYBILL.CUSTOMER_PICKUP_ORG_NAME CUSTOMERPICKUPORGCODE,
       	WAYBILL.TARGET_ORG_CODE TARGETORGCODE,
       	WAYBILL.PRODUCT_CODE PRODUCTCODE,
		CDETAIL.ID DETAIL_ID,
		CDETAIL.WAYBILL_RFC_ID DETAIL_WAYBILL_RFC_ID,
		CDETAIL.RFC_ITEMS DETAIL_RFC_ITEMS,
		CDETAIL.BEFORE_RFCINFO DETAIL_BEFORE_RFCINFO,
		CDETAIL.AFTER_RFCINFO DETAIL_AFTER_RFCINFO,
		CDETAIL.VISIABLE DETAIL_VISIABLE,
		CDETAIL.RFC_ITEMS_NAME DETAIL_RFC_ITEMS_NAME
	</sql>
	
	<!-- 审核受理状态查询 -->
	<sql id="waybillRfcCheckAndPro_columns_list_select">
		SELECT /*模块：接送货-运单-审核受理状态查询*/
		WAYBILLRFC.ID ID,
		WAYBILLRFC.WAYBILL_NO WAYBILL_NO,
		WAYBILLRFC.RFC_SOURCE RFC_SOURCE,
		WAYBILLRFC.RFC_REASON RFC_REASON,
		WAYBILLRFC.DRAFT_ORG_NAME DRAFT_ORG_NAME,
		WAYBILLRFC.DRAFT_ORG_CODE DRAFT_ORG_CODE,
		WAYBILLRFC.DRAFTER DRAFTER,
		WAYBILLRFC.DRAFT_TIME DRAFT_TIME,
		WAYBILLRFC.RFC_TYPE RFC_TYPE,
		WAYBILLRFC.NEW_VERSION_WAYBILL_ID NEW_VERSION_WAYBILL_ID,
		HISCHECK.NOTES CHECKNOTES,
		HISCHECK.STATUS CHECKSTATUS,
		HISCHECK.OPERATE_TIME CHECKDATE,
		HISCHECK.OPERATOR CHECKPERSON,
		HISPROCESS.STATUS PROCESSSTATUS,
		HISCHECK.OPERATOR_CODE CHECKPERSONCODE,
		HISPROCESS.NOTES HANDLENOTES,
		HISPROCESS.OPERATOR HANDLEPERSON,
		HISPROCESS.OPERATOR_CODE HANDLEPERSONCODE,
		HISPROCESS.OPERATE_TIME PROCESS_TIME,
		HISPROCESS.OPERATE_ORG_NAME OPERATE_ORG_NAME,
		HISPROCESS.OPERATE_ORG_CODE OPERATE_ORG_CODE
	</sql>
	
	<sql id="waybillRfc_printInfo_from">
		FROM PKP.T_SRV_WAYBILLRFC WAYBILLRFC
		JOIN PKP.T_SRV_WAYBILL WAYBILL ON WAYBILLRFC.New_Version_Waybill_Id= WAYBILL.Id
		LEFT JOIN PKP.T_SRV_WAYBILLRFC_CHANGEDETAIL CDETAIL ON CDETAIL.WAYBILL_RFC_ID = WAYBILLRFC.ID
	</sql>
	<!-- 审核受理from -->
	<sql id="waybillRfcChkAndPro_columns_list_from">
		FROM PKP.T_SRV_WAYBILLRFC WAYBILLRFC
  		LEFT JOIN PKP.T_SRV_WAYBILLRFC_ACTIONHISTORY HISCHECK  ON HISCHECK.WAYBILL_RFC_ID = WAYBILLRFC.ID 
			AND HISCHECK.STATUS in
			<foreach collection="checkStatusList" item="status" open="(" close=")"
				separator=",">
				#{status}
			</foreach>
  		LEFT JOIN PKP.T_SRV_WAYBILLRFC_ACTIONHISTORY HISPROCESS ON HISPROCESS.WAYBILL_RFC_ID = WAYBILLRFC.ID 
			AND HISPROCESS.STATUS in
			<foreach collection="dealStatusList" item="status" open="(" close=")"
				separator=",">
				#{status}
			</foreach>
	</sql>
	<!-- 审核受理_productCode+from -->
	<sql id="waybillRfcChkAndPro_columns_product_list_from">
		FROM PKP.T_SRV_WAYBILLRFC WAYBILLRFC
		inner join pkp.t_srv_waybill waybill on waybill.id=WAYBILLRFC.Old_Version_Waybill_Id
  		LEFT JOIN PKP.T_SRV_WAYBILLRFC_ACTIONHISTORY HISCHECK  ON HISCHECK.WAYBILL_RFC_ID = WAYBILLRFC.ID 
			AND HISCHECK.STATUS in
			<foreach collection="checkStatusList" item="status" open="(" close=")"
				separator=",">
				#{status}
			</foreach>
  		LEFT JOIN PKP.T_SRV_WAYBILLRFC_ACTIONHISTORY HISPROCESS ON HISPROCESS.WAYBILL_RFC_ID = WAYBILLRFC.ID 
			AND HISPROCESS.STATUS in
			<foreach collection="dealStatusList" item="status" open="(" close=")"
				separator=",">
				#{status}
			</foreach>
		LEFT JOIN BSE.T_BAS_SATELLITEDEPT_SALESDEPT satellite on WAYBILLRFC.DRAFT_ORG_CODE=satellite.satellitedept_code and satellite.active='Y' 
	</sql>
	<!-- 更改明细ResultMap -->
	<resultMap type="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcChangeDetailEntity" 
		id="WaybillRfcChangeDetailResultMap">
			<result column="DETAIL_ID" property="id" jdbcType="VARCHAR"/>
			<result column="DETAIL_WAYBILL_RFC_ID" property="waybillRfcId" jdbcType="VARCHAR"/>
			<result column="DETAIL_RFC_ITEMS" property="rfcItems" jdbcType="VARCHAR"/>
			<result column="DETAIL_BEFORE_RFCINFO" property="beforeRfcInfo" jdbcType="VARCHAR"/>
			<result column="DETAIL_AFTER_RFCINFO" property="afterRfcInfo" jdbcType="VARCHAR"/>
			<result column="DETAIL_VISIABLE" property="visiable" jdbcType="VARCHAR"/>
			<result column="DETAIL_RFC_ITEMS_NAME" property="rfcItemsName" jdbcType="VARCHAR"/>
	</resultMap>
	
	<resultMap id="TodoActionEntityMap"
		type="com.deppon.foss.module.pickup.waybill.shared.domain.TodoActionEntity">
		<id property="waybillRfcId" column="ID" jdbcType="VARCHAR" />
		<result property="waybillNo" column="WAYBILL_NO" jdbcType="VARCHAR" />
		<result property="status" column="STATUS" jdbcType="VARCHAR" />
		<result property="darftOrgName" column="DRAFT_ORG_NAME" jdbcType="VARCHAR" />
		<result property="rfcInfo" column="RFC_INFO" jdbcType="VARCHAR" />
		<result property="darfter" column="DRAFTER" jdbcType="VARCHAR" />
		<result property="operateTime" column="OPERATE_TIME" jdbcType="TIMESTAMP" />
	</resultMap>
	
	<sql id="waybillRfcChange_columns_list_select">
		SELECT /*模块：接送货-运单-更改单变更*/
		WAYBILLRFC.ID ID,
		WAYBILLRFC.WAYBILL_NO WAYBILL_NO,
		WAYBILLRFC.STATUS PROCESSSTATUS,
		WAYBILLRFC.RFC_SOURCE RFC_SOURCE,
		WAYBILLRFC.RFC_REASON RFC_REASON,
		WAYBILLRFC.DRAFT_ORG_NAME DRAFT_ORG_NAME,
		WAYBILLRFC.DRAFT_ORG_CODE DRAFT_ORG_CODE,
		WAYBILLRFC.DRAFTER DRAFTER,
		WAYBILLRFC.OPERATE_ORG_NAME	OPERATE_ORG_NAME,
		WAYBILLRFC.OPERATE_ORG_CODE OPERATE_ORG_CODE,
		WAYBILLRFC.OPERATOR OPERATOR,
		WAYBILLRFC.DRAFT_TIME DRAFT_TIME,
		WAYBILLRFC.OPERATE_TIME OPERATE_TIME,
		WAYBILLRFC.NOTES NOTES,
		WAYBILLRFC.RFC_TYPE RFC_TYPE
	</sql>
	
	<!-- 更改单审核 -->
	<sql id="waybillRfcCheck_columns_list_select">
		SELECT /*模块：接送货-运单-更改单审核*/
		WAYBILLRFC.ID ID,
		WAYBILLRFC.WAYBILL_NO WAYBILL_NO,
		HIS.STATUS CHECKSTATUS,
		WAYBILLRFC.RFC_TYPE RFC_TYPE,
		WAYBILLRFC.RFC_REASON RFC_REASON,
		WAYBILLRFC.DRAFT_ORG_NAME DRAFT_ORG_NAME,
		WAYBILLRFC.DRAFT_ORG_CODE DRAFT_ORG_CODE,
		WAYBILLRFC.DRAFTER DRAFTER,
		WAYBILLRFC.OPERATE_ORG_NAME OPERATE_ORG_NAME,
		WAYBILLRFC.OPERATE_ORG_CODE OPERATE_ORG_CODE,
		WAYBILLRFC.OPERATOR OPERATOR,
		WAYBILLRFC.DRAFT_TIME DRAFT_TIME,
		WAYBILLRFC.OPERATE_TIME OPERATE_TIME,
		HIS.NOTES NOTES,
		WAYBILLRFC.RFC_TYPE RFC_TYPE,
		HIS.OPERATOR CHECKPERSON,
		HIS.OPERATOR_CODE CHECKPERSONCODE,
		HIS.OPERATE_TIME CHECKTIME
	</sql>
	

	<sql id="waybillRfcChange_columns_list_from">
		FROM pkp.T_SRV_WAYBILLRFC WAYBILLRFC
  		LEFT  JOIN PKP.T_SRV_WAYBILL WAYBILL ON WAYBILLRFC.OLD_VERSION_WAYBILL_ID = WAYBILL.ID
	</sql>
	
	<sql id="waybillRfcCheck_columns_list_from">
		FROM pkp.T_SRV_WAYBILLRFC WAYBILLRFC 
 		LEFT JOIN PKP.T_SRV_WAYBILLRFC_ACTIONHISTORY HIS   ON HIS.WAYBILL_RFC_ID = WAYBILLRFC.ID 
 		<if test="fixedStatusList!=null and fixedStatusList.size() &gt; 0">
			<![CDATA[
				AND HIS.STATUS IN
			 ]]>
			 <foreach collection="fixedStatusList" item="status" open="(" close=")" separator=",">
				#{status}
			 </foreach>
		</if>
		LEFT JOIN BSE.T_BAS_SATELLITEDEPT_SALESDEPT satellite on WAYBILLRFC.DRAFT_ORG_CODE=satellite.satellitedept_code and satellite.active='Y' 
	</sql>
	<sql id="waybillRfcChange_columns_list_where">
		WHERE 1=1
		<!-- 限制悟空开的单子，在FOSS更改单审核查265475 -->
		      AND   (waybillrfc.is_ecs != 'Y' or waybillrfc.is_ecs is null)
		<choose>
			<when test="waybillNumber!=null and waybillNumber!=''">
			 	<![CDATA[
			 		AND waybillrfc.waybill_no=#{waybillNumber,jdbcType=VARCHAR}
			 	]]>
			</when>
			<otherwise>
				<if test="startDate!=null and endDate!=null">
			 		<![CDATA[ 
			 			AND WAYBILLRFC.DRAFT_TIME >= #{startDate,jdbcType=TIMESTAMP}
			 			AND WAYBILLRFC.DRAFT_TIME <= #{endDate,jdbcType=TIMESTAMP}
			 		]]>
				</if>
				<if test="statusList!=null and statusList.size() &gt; 0">
			 		<![CDATA[
			 			AND WAYBILLRFC.STATUS IN
					 ]]>
					 <foreach collection="statusList" item="status" open="(" close=")" separator=",">
			 			#{status}
					 </foreach>
				</if>
			</otherwise>
		</choose>
		<choose>
		    <when test="isExpress != 1">
		    <![CDATA[
						AND WAYBILL.IS_EXPRESS !='Y'
				]]>
		    </when>
		    <otherwise>
				<![CDATA[
				    AND WAYBILL.IS_EXPRESS = 'Y'
					]]>
				</otherwise>
		</choose> 
		<choose>
			<when test="deptCode!=null and deptCode!=''">
					AND ( WAYBILL.LAST_LOAD_ORG_CODE = #{deptCode,jdbcType=VARCHAR}
					<if test="parentDeptCodes!=null and parentDeptCodes.size() &gt; 0">
						<![CDATA[
						OR WAYBILL.LAST_LOAD_ORG_CODE  IN
						 ]]>
					 <foreach collection="parentDeptCodes" item="deptCodes" open="(" close=")" separator=",">
			 			#{deptCodes}
					 </foreach>
					</if>
					) AND WAYBILLRFC.IS_LABOUR_HANDLE='N'
			</when>
			<otherwise>
				<![CDATA[
					AND 1 = 2
				]]>
			</otherwise>
		</choose>
	</sql>

	<!-- 变更受理查询 -->
	<select id="queryWaybillRfcVarifyDto" resultMap="WaybillRfcVarifiDtoResultMap"
		parameterType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcCondition">				       
		<include refid="waybillRfcChange_columns_list_select" />
		<include refid="waybillRfcChange_columns_list_from" />
		<include refid="waybillRfcChange_columns_list_where" />
	</select>

	<!-- 更改单凭证ResultMap -->
	<resultMap
		type="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcProofEntity"
		id="WaybillRfcVarificationProofResultMap">
		<result column="ID" property="id" jdbcType="VARCHAR"/>
		<result column="WAYBILL_RFC_ID" property="waybillRfcId" jdbcType="VARCHAR"/>
		<result column="RFCPROOF_NAME" property="rfcProofName" jdbcType="VARCHAR"/>
		<result column="RFCPROOF_PATH" property="rfcProofPath" jdbcType="VARCHAR"/>
		<result column="RFCPROOF_SIZE" property="rfcProofSize" jdbcType="VARCHAR"/>
	</resultMap>

	<sql id="waybillRfcProof_list_select">
		SELECT /*模块：接送货-运单-更改单凭证*/
		       PROOF.ID ID,
		       PROOF.WAYBILL_RFC_ID WAYBILL_RFC_ID,
		       PROOF.RFCPROOF_NAME RFCPROOF_NAME,
		       PROOF.RFCPROOF_PATH RFCPROOF_PATH,
		       PROOF.RFCPROOF_SIZE RFCPROOF_SIZE
	</sql>
	<select id="queryWayBillRfcProofByRfcId" parameterType="String"
		resultMap="WaybillRfcVarificationProofResultMap">
		<include refid="waybillRfcProof_list_select"/>
		<![CDATA[
			FROM pkp.T_SRV_WAYBILLRFC_PROOF PROOF
			WHERE  PROOF.WAYBILL_RFC_ID = #{waybillRfcId,jdbcType=VARCHAR}
		]]>
	</select>
	<select id="queryWayBillRfcChangeDetailByRfcId" parameterType="String"
		resultMap="WaybillRfcChangeDetailResultMap">
	SELECT /*模块：接送货-运单-根据变更单号查询变更明细*/
		DETAIL.ID DETAIL_ID,
        DETAIL.WAYBILL_RFC_ID DETAIL_WAYBILL_RFC_ID,
        DETAIL.RFC_ITEMS DETAIL_RFC_ITEMS,
        DETAIL.BEFORE_RFCINFO DETAIL_BEFORE_RFCINFO,
        DETAIL.AFTER_RFCINFO DETAIL_AFTER_RFCINFO,
        DETAIL.VISIABLE DETAIL_VISIABLE,
        DETAIL.RFC_ITEMS_NAME DETAIL_RFC_ITEMS_NAME
    FROM PKP.T_SRV_WAYBILLRFC_CHANGEDETAIL DETAIL
	WHERE  DETAIL.WAYBILL_RFC_ID = #{waybillRfcId,jdbcType=VARCHAR}
	</select>
  
  <!-- 变更审核查询 -->
	<select id="queryWaybillRfcCheckDto" parameterType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcCondition" resultMap="WaybillRfcCheckDtoResultMap">
		<include refid="waybillRfcCheck_columns_list_select"/>
		<include refid="waybillRfcCheck_columns_list_from"/>
		<where>
				<!-- 限制悟空开的单子，在FOSS更改单变更审核查询265475 -->
		       (WAYBILLRFC.is_ecs != 'Y' or WAYBILLRFC.is_ecs is null)
			<choose>
				<when test="waybillNumber!=null and waybillNumber!=''">
			 	<![CDATA[
			 	 and	WAYBILLRFC.WAYBILL_NO=#{waybillNumber,jdbcType=VARCHAR}
			 		
			 	]]>
				</when>
				<otherwise>
				<if test="startDate!=null and endDate!=null ">
			 		<![CDATA[ 
			 			AND WAYBILLRFC.DRAFT_TIME >= #{startDate,jdbcType=TIMESTAMP}
			 			AND WAYBILLRFC.DRAFT_TIME <= #{endDate,jdbcType=TIMESTAMP} 
			 		]]>
				</if>
				<if test="statusList!=null and statusList.size() &gt; 0">
					 <![CDATA[
					 	AND WAYBILLRFC.STATUS IN
					 ]]>
					 <foreach collection="statusList" item="status" open="(" close=")" separator=",">
					 	#{status,jdbcType=VARCHAR}
					 </foreach>
				</if>
			</otherwise>
			</choose>
<!-- 			<choose>
				<when test="isExpress!='Y'">
					<![CDATA[
						AND WAY.IS_EXPRESS !='Y'
					]]>
				</when>
				<otherwise>
					<![CDATA[
				AND WAY.IS_EXPRESS = #{isExpress,jdbcType=VARCHAR}
					]]>
				</otherwise>
			</choose> -->
			<choose>
				<when test="deptCode!=null and deptCode!=''">
					<![CDATA[
						AND (WAYBILLRFC.DRAFT_ORG_CODE = #{deptCode,jdbcType=VARCHAR} 
						or satellite.salesdept_code=#{deptCode,jdbcType=VARCHAR})
					]]>
				</when>
				<otherwise>
					<![CDATA[
						AND 1 = 2
					]]>
				</otherwise>
			</choose>
		</where>
	</select>
	
	<!-- 审核受理状态查询 -->
	<select id="queryWaybillRfcChkAndPro" 
		parameterType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcCondition" 
		resultMap="WaybillRfcVarifiDtoCheckAndProResultMap">
		<include refid="waybillRfcCheckAndPro_columns_list_select"/>
		<include refid="waybillRfcChkAndPro_columns_list_from"/>
		<where>
		       <!-- 限制悟空开的单子，在FOSS审核受理状态查询 265475-->
		           (WAYBILLRFC.is_ecs != 'Y' or WAYBILLRFC.is_ecs is null)
			<choose>
				<when test="waybillNumber!=null and waybillNumber!=''">
					 AND   WAYBILLRFC.WAYBILL_NO = #{waybillNumber,jdbcType=VARCHAR} 
					<if test="deptCode!=null and deptCode!=''">
						AND WAYBILLRFC.DRAFT_ORG_CODE = #{deptCode,jdbcType=VARCHAR}
					</if>
				</when>
				<otherwise>
					<if test="startDate!=null and endDate!=null">
						AND  WAYBILLRFC.Draft_Time BETWEEN #{startDate,jdbcType=TIMESTAMP} AND #{endDate,jdbcType=TIMESTAMP}
					</if>
					<if test="deptCode!=null and deptCode!=''">
						AND WAYBILLRFC.DRAFT_ORG_CODE = #{deptCode,jdbcType=VARCHAR}
					</if>
					<if test="checkStatus!=null and checkStatus!=''">
						<if test="isCheckStatusIsPreAduit">
							AND HISCHECK.status is null
						</if>
						<if test="!isCheckStatusIsPreAduit">
							AND HISCHECK.status =#{checkStatus,jdbcType=VARCHAR}
						</if>
					</if>
					<if test="dealStatus!=null and dealStatus!=''">
						<if test="isDealStatusIsPreAccecpt">
							AND HISPROCESS.status is null
						</if>
						<if test="!isDealStatusIsPreAccecpt">
							AND HISPROCESS.status =#{dealStatus,jdbcType=VARCHAR}
						</if>
					</if>
				</otherwise>
			</choose>
		</where>
	</select>
	
	<!-- 审核受理状态查询 -->
	<select id="queryWaybillRfcCargoVarificationDto" 
		parameterType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcCondition" 
		resultMap="WaybillRfcVarifiDtoCheckAndProResultMap">
		<include refid="waybillRfcCheckAndPro_columns_list_select"/>
		<include refid="waybillRfcChkAndPro_columns_product_list_from"/><!--waybillRfcChkAndPro_columns_product_list_from-->
		<where>
			<choose>
				<when test="waybillNumber!=null and waybillNumber!=''">
					WAYBILLRFC.WAYBILL_NO = #{waybillNumber,jdbcType=VARCHAR} 
					<if test="deptCode!=null and deptCode!=''">
						AND (WAYBILLRFC.DRAFT_ORG_CODE = #{deptCode,jdbcType=VARCHAR} 
						or satellite.salesdept_code=#{deptCode,jdbcType=VARCHAR})
					</if>
				</when>
				<otherwise>
					<if test="startDate!=null and endDate!=null">
						AND  WAYBILLRFC.Draft_Time BETWEEN #{startDate,jdbcType=TIMESTAMP} AND #{endDate,jdbcType=TIMESTAMP}
					</if>
					<if test="deptCode!=null and deptCode!=''">
						AND (WAYBILLRFC.DRAFT_ORG_CODE = #{deptCode,jdbcType=VARCHAR} 
						or satellite.salesdept_code=#{deptCode,jdbcType=VARCHAR})
					</if>
					<if test="checkStatus!=null and checkStatus!=''">
						<if test="isCheckStatusIsPreAduit">
							AND HISCHECK.status is null
						</if>
						<if test="!isCheckStatusIsPreAduit">
							AND HISCHECK.status =#{checkStatus,jdbcType=VARCHAR}
						</if>
					</if>
					<if test="dealStatus!=null and dealStatus!=''">
						<if test="isDealStatusIsPreAccecpt">
							AND HISPROCESS.status is null
						</if>
						<if test="!isDealStatusIsPreAccecpt">
							AND HISPROCESS.status =#{dealStatus,jdbcType=VARCHAR}
						</if>
					</if>
				</otherwise>
			</choose>
			<if test="productCodeList!= null and productCodeList.size>0">
				and waybill.product_code in
				<foreach collection="productCodeList" open="(" close=")" separator=","
					item="productCode">
					<if test="productCode!=null and productCode != ''">
		    	      <![CDATA[	#{productCode,jdbcType=VARCHAR} ]]>
		            </if>
				</foreach>
			</if>
		</where>
	</select>
	
	<!-- 更改单打印查询 -->
	<select id="queryWaybillRfcPrintDto" parameterType="String" resultMap="waybillRfcPrintResultMap">
		<include refid="waybillRfc_printInfo_select"/>
		<include refid="waybillRfc_printInfo_from"/>
		<where>
			WAYBILL.ACTIVE = 'Y' AND WAYBILL.WAYBILL_NO = #{waybillNo,jdbcType=VARCHAR}
		</where>
	</select>
	<!-- 更改单打印查询 -->
	<select id="queryWaybillRfcPrintDtoByRfcid" parameterType="String" resultMap="waybillRfcPrintResultMap">
		<include refid="waybillRfc_printInfo_select"/>
		<include refid="waybillRfc_printInfo_from"/>
		<where>
			WAYBILLRFC.ID = #{rfcId,jdbcType=VARCHAR}
		</where>
	</select>
	
	<!-- 新增更改代理主记录 -->
	<insert id="addWayBillRfcAgent" parameterType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcAgentEntity">
		INSERT INTO PKP.T_SRV_WAYBILLRFC_AGENT(ID, ENTRUSTEMPCODE, STATUS,
				 VALIDTIME, OVERDUETIME, AGENTREASON,ENTRUSTEMPNAME,ACTIVE, TYPE)
		VALUES(#{id,jdbcType=VARCHAR},#{entrustEmpCode,jdbcType=VARCHAR},#{status,jdbcType=VARCHAR},
		       #{validTime,jdbcType=TIMESTAMP},#{overdueTime,jdbcType=TIMESTAMP},
		       #{agentReason,jdbcType=VARCHAR},#{entrustEmpName,jdbcType=VARCHAR},#{active,jdbcType=VARCHAR},#{type,jdbcType=VARCHAR})
	</insert>
	
	<!-- 新增更改代理 -->
	<insert id="WaybillRfcAgentPersonEntity" parameterType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcAgentPersonEntity">
		INSERT INTO PKP.T_SRV_WAYBILLRFC_AGENT_EMPLIST(ID,PARENTID,AGENTEMPCODE,AGENTEMPNAME)
		VALUES(#{id,jdbcType=VARCHAR},#{parentId,jdbcType=VARCHAR},#{agentEmpCode,jdbcType=VARCHAR},#{agentEmpName,jdbcType=VARCHAR})
	</insert>
	<!-- 代理数据分RM -->
	<resultMap type="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcAgentPersonEntity" id="WaybillRfcAgentPersonRM">
		<result column="EMPID" property="id" jdbcType="VARCHAR"/>
		<result column="PARENTID" property="parentId" jdbcType="VARCHAR"/>
		<result column="AGENTEMPCODE" property="agentEmpCode" jdbcType="VARCHAR"/>
		<result column="AGENTEMPNAME" property="agentEmpName" jdbcType="VARCHAR"/>
	</resultMap>
	<!-- 审核代理主数据 -->
	<resultMap type="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcAgentEntity" id="WaybillRfcAgentRM">
		<result column="ID" property="id" jdbcType="VARCHAR"/>
		<result column="ENTRUSTEMPNAME" property="entrustEmpName" jdbcType="VARCHAR"/>
		<result column="ENTRUSTEMPCODE" property="entrustEmpCode" jdbcType="VARCHAR"/>
		<result column="STATUS" property="status" jdbcType="VARCHAR"/>
		<result column="VALIDTIME" property="validTime" jdbcType="TIMESTAMP"/>
		<result column="OVERDUETIME" property="overdueTime" jdbcType="TIMESTAMP"/>
		<result column="AGENTREASON" property="agentReason" jdbcType="VARCHAR"/>
        <result column="ACTIVE" property="active" jdbcType="VARCHAR"/>
		<collection property="agentEmpList" ofType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcAgentPersonEntity" 
					resultMap="WaybillRfcAgentPersonRM"/>
	</resultMap>
	<!-- 审核代理查询字段 -->
	<sql id="waybillRfcAgent_select_column">
		WAYBILLAGENT.ID ID,
		WAYBILLAGENT.ENTRUSTEMPNAME ENTRUSTEMPNAME,
		WAYBILLAGENT.ENTRUSTEMPCODE ENTRUSTEMPCODE,
		WAYBILLAGENT.STATUS STATUS,
		WAYBILLAGENT.VALIDTIME VALIDTIME,
		WAYBILLAGENT.OVERDUETIME OVERDUETIME,
		WAYBILLAGENT.AGENTREASON AGENTREASON,
		AGENTEMP.ID EMPID,
		AGENTEMP.PARENTID PARENTID,
		AGENTEMP.AGENTEMPCODE AGENTEMPCODE,
		AGENTEMP.AGENTEMPNAME AGENTEMPNAME,
        AGENTEMP.ACTIVE ACTIVE
	</sql>
	
    <!-- 查询更改该代理对象 -->
    <select id="queryWaybillRfcAgent" parameterType="com.deppon.foss.module.pickup.waybill.shared.dto.WaybillRfcQueryAgentConDto" 
            resultMap="WaybillRfcAgentRM">
        SELECT /*模块：接送货-运单-查询更改该代理对象*/
        <include refid="waybillRfcAgent_select_column"/>          
       FROM PKP.T_SRV_WAYBILLRFC_AGENT WAYBILLAGENT
       JOIN PKP.T_SRV_WAYBILLRFC_AGENT_EMPLIST AGENTEMP ON WAYBILLAGENT.ID = AGENTEMP.PARENTID
       WHERE WAYBILLAGENT.ENTRUSTEMPCODE = #{currentEmpCode,jdbcType=VARCHAR}
             AND WAYBILLAGENT.ACTIVE = #{active,jdbcType=VARCHAR}
             <if test="status!=null and status!=''">
                 AND WAYBILLAGENT.STATUS = #{status,jdbcType=VARCHAR}
             </if>
             <if test="agentCode!=null and agentCode!=''">
				AND WAYBILLAGENT.ID IN
				(SELECT AGE.PARENTID
				FROM PKP.T_SRV_WAYBILLRFC_AGENT_EMPLIST AGE
				WHERE AGE.AGENTEMPCODE = #{agentCode,jdbcType=VARCHAR})
             </if>
                 AND (
                 (WAYBILLAGENT.VALIDTIME between #{beginDate,jdbcType=TIMESTAMP} and #{endDate,jdbcType=TIMESTAMP})
                 OR
                 (#{beginDate,jdbcType=TIMESTAMP} between WAYBILLAGENT.VALIDTIME and WAYBILLAGENT.OVERDUETIME)
                 )
                 
               <if test="type!=null  and type!=''">
 		    	AND WAYBILLAGENT.TYPE = #{type,jdbcType=VARCHAR} 
 		    </if>
 		     <if test="type==null  or type==''">
 		    	AND WAYBILLAGENT.TYPE IS NULL
 		    </if>   
                 
                 
                 
    </select>
	<!-- 根据Id查询审核代理对象 -->
	<select id="queryWaybillRfcAgentById" parameterType="String" resultMap="WaybillRfcAgentRM">
		SELECT /*模块：接送货-运单-根据Id查询审核代理对象*/
		<include refid="waybillRfcAgent_select_column"/>
		FROM PKP.T_SRV_WAYBILLRFC_AGENT WAYBILLAGENT
	    JOIN PKP.T_SRV_WAYBILLRFC_AGENT_EMPLIST AGENTEMP ON WAYBILLAGENT.ID = AGENTEMP.PARENTID
	    WHERE WAYBILLAGENT.ID = #{id,jdbcType=VARCHAR}
	</select>
	<!-- 删除代理人实体 -->
	<delete id="deleteWaybillRfcAgentPerson" parameterType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcAgentPersonEntity">
		DELETE FROM PKP.T_SRV_WAYBILLRFC_AGENT_EMPLIST EMP WHERE EMP.ID = #{id,jdbcType=VARCHAR}
	</delete>
	<!-- 删除代理实体 -->
	<delete id="deleteWaybillRfcAgent" parameterType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcAgentEntity">
    	DELETE FROM PKP.T_SRV_WAYBILLRFC_AGENT AG WHERE AG.ID = #{id,jdbcType=VARCHAR}
	</delete>
	<!-- 更新代理人实体-->
	<update id="updateWaybillRfcAgentPerson" parameterType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcAgentPersonEntity">
 	   UPDATE PKP.T_SRV_WAYBILLRFC_AGENT_EMPLIST T
 	   		<set>
 	   			<if test="parentId!=null">
         			T.PARENTID = #{parentId,jdbcType=VARCHAR},
 	   			</if>
 	   			<if test="agentEmpCode!=null">
		            T.AGENTEMPCODE = #{agentEmpCode,jdbcType=VARCHAR},
 	   			</if>
 	   			<if test="agentEmpName!=null">
		            T.AGENTEMPNAME = #{agentEmpName,jdbcType=VARCHAR},
 	   			</if>
 	   			<if test="active!=null">
 	   				T.ACTIVE = #{active,jdbcType=VARCHAR},
 	   			</if>
 	   		</set>
       WHERE T.ID = #{id,jdbcType=VARCHAR}
	</update>
	<update id="updateWaybillRfcAgent" parameterType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcAgentEntity">
       update pkp.t_srv_waybillrfc_agent ag
       		<set>
       			<if test="entrustEmpCode!=null">
       				AG.ENTRUSTEMPCODE = #{entrustEmpCode,jdbcType=VARCHAR},
       			</if>
       			<if test="status!=null">
       				ag.status         = #{status,jdbcType=VARCHAR},
       			</if>
       			<if test="validTime!=null">
	                ag.validtime      = #{validTime,jdbcType=TIMESTAMP},
       			</if>
       			<if test="overdueTime!=null">
	                ag.overduetime    = #{overdueTime,jdbcType=TIMESTAMP},
       			</if>
       			<if test="agentReason!=null">
              	    ag.agentreason    = #{agentReason,jdbcType=VARCHAR},
       			</if>
       			<if test="entrustEmpName!=null">
              		ag.entrustempname = #{entrustEmpName,jdbcType=VARCHAR},
       			</if>
                <if test="active!=null">
                    ag.active = #{active,jdbcType=VARCHAR},
                </if>
               
                
       		</set>
        where ag.id = #{id,jdbcType=VARCHAR}
	</update>
	<!-- 根据工号查询代理权限列表 -->
	<select id="queryAuthorityListByAgentCode" parameterType="com.deppon.foss.module.pickup.waybill.shared.dto.WaybillRfcQueryAgentConDto" 
	        resultType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillRfcAgentEntity">
	     SELECT /*模块：接送货-运单-根据工号查询代理权限列表*/
	      <include refid="waybillRfcAgent_select_column"/>
	      <![CDATA[
		       FROM PKP.T_SRV_WAYBILLRFC_AGENT WAYBILLAGENT
	  		   JOIN PKP.T_SRV_WAYBILLRFC_AGENT_EMPLIST AGENTEMP ON WAYBILLAGENT.ID = AGENTEMP.PARENTID
	 		   WHERE AGENTEMP.AGENTEMPCODE = #{agentCode,jdbcType=VARCHAR} 
	 		   AND WAYBILLAGENT.VALIDTIME <= #{currentDate,jdbcType=TIMESTAMP}
	 		   AND WAYBILLAGENT.OVERDUETIME >= #{currentDate,jdbcType=TIMESTAMP}
	 		   AND WAYBILLAGENT.STATUS = #{status,jdbcType=VARCHAR} 
	 		   /*AND WAYBILLAGENT.ACTIVE = 'Y'*/
 		   ]]>
 		    <if test="type!=null  and type!=''">
 		    	AND WAYBILLAGENT.TYPE = #{type,jdbcType=VARCHAR} 
 		    </if>
 		     <if test="type==null  or type==''">
 		    	AND WAYBILLAGENT.TYPE IS NULL
 		    </if>
	</select>

	<!-- 判断是否重复授权 -->
	    <select id="queryWaybillRfcAgentByCondition" parameterType="java.util.Map" resultType="String">
        SELECT /*模块：接送货-运单-判断是否重复授权*/
        DISTINCT
        LIST.AGENTEMPNAME
        FROM PKP.T_SRV_WAYBILLRFC_AGENT WAYBILLAGENT,
        PKP.T_SRV_WAYBILLRFC_AGENT_EMPLIST LIST
        WHERE  WAYBILLAGENT.id = LIST.PARENTID
        AND LIST.AGENTEMPCODE in
			<foreach collection="currentEmpCodes" item="empCode" open="(" close=")"
				separator=",">
				#{empCode}
			</foreach>
        	AND WAYBILLAGENT.STATUS = #{status,jdbcType=VARCHAR}
       		AND WAYBILLAGENT.ACTIVE = #{active,jdbcType=VARCHAR}
                AND 
                <![CDATA[
                ((
                WAYBILLAGENT.VALIDTIME >= #{validTime,jdbcType=TIMESTAMP}
                AND WAYBILLAGENT.VALIDTIME <= #{overDueTime,jdbcType=TIMESTAMP}
                )
                OR
                (
                 WAYBILLAGENT.VALIDTIME <= #{validTime,jdbcType=TIMESTAMP}
                AND WAYBILLAGENT.OVERDUETIME >= #{validTime,jdbcType=TIMESTAMP}
                ))
                ]]> 
                
           <if test="type != null and type != ''">
            AND WAYBILLAGENT.TYPE= #{type,jdbcType=VARCHAR}
           </if>
           <if test="type == null or type == ''">
            AND WAYBILLAGENT.TYPE IS NULL
           </if>
           
    </select>
    <!-- 客户开户银行 -->
	<resultMap id="cusAccountResultMap"
		type="com.deppon.foss.module.base.baseinfo.api.shared.domain.CusAccountEntity">
		<id column="ID" property="id" jdbcType="VARCHAR" />
		<result column="OTHER_BRANCH_BANK_NAME" property="otherBranchBankName"
			jdbcType="VARCHAR" />
		<result column="ACCOUNT_NO" property="accountNo" jdbcType="VARCHAR" />
		<result column="ACCOUNT_NAME" property="accountName" jdbcType="VARCHAR" />
		<result column="CITY_CODE" property="cityCode" jdbcType="VARCHAR" />
		<result column="PROV_CODE" property="provCode" jdbcType="VARCHAR" />
		<result column="BANK_CODE" property="bankCode" jdbcType="VARCHAR" />
		<result column="MOBILE_PHONE" property="mobilePhone" jdbcType="VARCHAR" />
		<result column="CUSTOMER" property="customer" jdbcType="VARCHAR" />
		<result column="DEFAULT_ACCOUNT" property="defaultAccount"
			jdbcType="CHAR" />
		<result column="BRANCH_BANK_CODE" property="branchBankCode"
			jdbcType="VARCHAR" />
		<result column="NOTES" property="notes" jdbcType="VARCHAR" />
		<result column="CREATE_TIME" property="createDate" jdbcType="TIMESTAMP" />
		<result column="MODIFY_TIME" property="modifyDate" jdbcType="TIMESTAMP" />
		<result column="ACTIVE" property="active" jdbcType="CHAR" />
		<result column="CREATE_USER_CODE" property="createUser"
			jdbcType="VARCHAR" />
		<result column="MODIFY_USER_CODE" property="modifyUser"
			jdbcType="VARCHAR" />
		<result column="VIRTUAL_CODE" property="virtualCode" jdbcType="VARCHAR" />
		<result column="ACCOUNTNATURE" property="accountNature"
			jdbcType="VARCHAR" />
		<result column="CRM_ID" property="crmId" jdbcType="DECIMAL" />
		<result column="CITYNAME" property="cityName" jdbcType="VARCHAR" />
		<result column="PROVINCENAME" property="provinceName" jdbcType="VARCHAR" />
		<result column="OPENING_BANK_NAME" property="openingBankName"
			jdbcType="VARCHAR" />
		<result column="BRANCH_BANK_NAME" property="branchBankName"
			jdbcType="VARCHAR" />
		<!-- BELONGCUSTOM 字段重命名为：CRM_CUS_ID 实体属性 belongCustom 未作更改-->
		<result column="CRM_CUS_ID" property="belongCustom" jdbcType="DECIMAL" />
		<result column="FINANCELINKMAN" property="financeLinkman"
			jdbcType="VARCHAR" />
		<result column="ACCOUNTUSE" property="accountUse" jdbcType="VARCHAR" />
	</resultMap>
<!-- 数据字段 -->
	<sql id="cusAccount_Column_List">
		A.ID AS ID, A.OTHER_BRANCH_BANK_NAME AS OTHER_BRANCH_BANK_NAME, A.ACCOUNT_NO AS ACCOUNT_NO, A.ACCOUNT_NAME AS ACCOUNT_NAME,
		A.CITY_CODE AS CITY_CODE,
		A.PROV_CODE AS PROV_CODE, A.BANK_CODE AS BANK_CODE,
		A.MOBILE_PHONE AS MOBILE_PHONE, A.CUSTOMER AS CUSTOMER,
		A.DEFAULT_ACCOUNT AS DEFAULT_ACCOUNT, A.BRANCH_BANK_CODE AS BRANCH_BANK_CODE, A.NOTES AS NOTES, A.CREATE_TIME AS CREATE_TIME,
		A.MODIFY_TIME AS MODIFY_TIME,
		A.ACTIVE AS ACTIVE, A.CREATE_USER_CODE AS CREATE_USER_CODE, A.MODIFY_USER_CODE AS MODIFY_USER_CODE, A.VIRTUAL_CODE AS VIRTUAL_CODE,
		A.ACCOUNTNATURE AS ACCOUNTNATURE,A.CRM_ID AS CRM_ID,A.CITYNAME AS CITYNAME, A.PROVINCENAME AS PROVINCENAME, A.OPENING_BANK_NAME AS OPENING_BANK_NAME,
		A.BRANCH_BANK_NAME AS BRANCH_BANK_NAME,A.CRM_CUS_ID AS CRM_CUS_ID, A.FINANCELINKMAN AS FINANCELINKMAN,A.ACCOUNTUSE AS ACCOUNTUSE
	</sql>

<!-- 数据字段 -->
	<sql id="cusNonFixedAccount_Column_List">
		C.ID AS ID, C.OTHER_BRANCH_BANK_NAME AS OTHER_BRANCH_BANK_NAME, C.ACCOUNT_NO AS ACCOUNT_NO,C.ACCOUNT_NAME AS ACCOUNT_NAME,
		C.CITY_CODE AS CITY_CODE,C.PROV_CODE AS PROV_CODE,C.BANK_CODE AS BANK_CODE,C.MOBILE_PHONE AS MOBILE_PHONE,C.CUSTOMER AS CUSTOMER,
		C.DEFAULT_ACCOUNT AS DEFAULT_ACCOUNT,C.BRANCH_BANK_CODE AS BRANCH_BANK_CODE,C.NOTES AS NOTES,C.CREATE_TIME AS CREATE_TIME,
		C.MODIFY_TIME AS MODIFY_TIME,C.ACTIVE AS ACTIVE,C.CREATE_USER_CODE AS CREATE_USER_CODE,C.MODIFY_USER_CODE AS MODIFY_USER_CODE,null AS VIRTUAL_CODE,
		C.ACCOUNTNATURE AS ACCOUNTNATURE,C.CRM_ID AS CRM_ID,C.CITYNAME AS CITYNAME,C.PROVINCENAME AS PROVINCENAME,C.OPENING_BANK_NAME AS OPENING_BANK_NAME,
		C.BRANCH_BANK_NAME AS BRANCH_BANK_NAME,C.NONCUST_CRM_ID AS CRM_CUS_ID,null AS FINANCELINKMAN,null AS ACCOUNTUSE
	</sql>
<!-- 验证客户开户银行信息是否存在 -->
	<select id="queryCusAccountByWaybillInfo" parameterType="map"
		resultMap="cusAccountResultMap">
		<![CDATA[
			SELECT /*模块：接送货-运单-验证客户开户银行信息是否存在*/
		]]>
		<include refid="cusAccount_Column_List" />
		<![CDATA[
  			FROM BSE.T_BAS_CUSTOMER C	
  			INNER JOIN BSE.T_BAS_CUS_ACCOUNT A ON A.CRM_CUS_ID = C.CRM_CUS_ID 
		]]>
		<where>
			A.ACTIVE = C.ACTIVE 
			<if test="accountName != null and accountName != ''">
				AND A.ACCOUNT_NAME = #{accountName,jdbcType=VARCHAR}
			</if>
			<if test="accountCode != null and accountCode != ''">
				AND A.ACCOUNT_NO = #{accountCode,jdbcType=VARCHAR}
			</if>
			<if test="accountBank != null and accountBank != ''">
				AND A.OPENING_BANK_NAME = #{accountBank,jdbcType=VARCHAR}
			</if>
			<if test="active != null and active != ''">
				AND A.active = #{active,jdbcType=VARCHAR}
			</if>
			<if test="custCode != null and custCode != ''">
				AND C.CODE = #{custCode,jdbcType=VARCHAR}
			</if>
		</where>
		<!-- CRM优化，作废散客表，因此不需要再查询散客表
		union all
		
		<![CDATA[
			SELECT
		]]>
		<include refid="cusNonFixedAccount_Column_List" />
		<![CDATA[
			FROM BSE.T_BAS_NONFIXED_CUSTOMER N
			INNER JOIN BSE.T_BAS_NONFIXED_ACCOUNT C ON N.CRM_ID = C.NONCUST_CRM_ID

		]]>
		<where>
			N.ACTIVE = C.ACTIVE
			<if test="accountName != null and accountName != ''">
				AND C.ACCOUNT_NAME = #{accountName,jdbcType=VARCHAR}
			</if>
			<if test="accountCode != null and accountCode != ''">
				AND C.ACCOUNT_NO = #{accountCode,jdbcType=VARCHAR}
			</if>
			<if test="accountBank != null and accountBank != ''">
				AND C.OPENING_BANK_NAME = #{accountBank,jdbcType=VARCHAR}
			</if>
			<if test="active != null and active != ''">
				AND C.active = #{active,jdbcType=VARCHAR}
			</if>
			<if test="custCode != null and custCode != ''">
				AND N.custcode = #{custCode,jdbcType=VARCHAR}
			</if>
		</where>
		 -->
	</select>	
	
	<select id="queryCusAccountByCreateTime" parameterType="map"
		resultMap="cusAccountResultMap">
		select * from (
			<![CDATA[
				SELECT /*模块：接送货-运单-获取客户最后一次开户银行信息*/
			]]>
			<include refid="cusAccount_Column_List" />
			<![CDATA[
	  			FROM BSE.T_BAS_CUSTOMER C	
	  			INNER JOIN BSE.T_BAS_CUS_ACCOUNT A ON A.CRM_CUS_ID = C.CRM_CUS_ID 
			]]>
			<where>				
				<if test="accountName != null and accountName != ''">
					AND A.ACCOUNT_NAME = #{accountName,jdbcType=VARCHAR}
				</if>
				<if test="accountCode != null and accountCode != ''">
					AND A.ACCOUNT_NO = #{accountCode,jdbcType=VARCHAR}
				</if>
				<if test="accountBank != null and accountBank != ''">
					AND A.OPENING_BANK_NAME = #{accountBank,jdbcType=VARCHAR}
				</if>				
				<if test="custCode != null and custCode != ''">
					AND C.CODE = #{custCode,jdbcType=VARCHAR}
				</if>
			</where>
			 ORDER BY A.CREATE_TIME DESC
		) where ROWNUM = 1
	</select>
	
	<!-- 根据运单号更新客户编码 -->
	<update id="updateCustomerCodeByWaybillId" parameterType="com.deppon.foss.module.pickup.waybill.shared.domain.WaybillEntity">
 	   UPDATE PKP.T_SRV_WAYBILL T
 	   		<set>
 	   			<if test="deliveryCustomerCode!=null">
         			T.DELIVERY_CUSTOMER_CODE = #{deliveryCustomerCode,jdbcType=VARCHAR},
 	   			</if>
 	   			<if test="receiveCustomerCode!=null">
		            T.RECEIVE_CUSTOMER_CODE = #{receiveCustomerCode,jdbcType=VARCHAR},
 	   			</if> 	   			
 	   		</set>
       WHERE T.ID = #{id,jdbcType=VARCHAR}
	</update>
	
	<!-- 根据运单ID获取改单类型 -->
	<select id="queryWaybillRfcTypeById" parameterType="java.lang.String"
		resultMap="WaybillRfcVarifiDtoResultMap">
		select  /*模块：接送货-运单-更改单变更信息*/
				WAYBILLRFC.ID ID,
				WAYBILLRFC.WAYBILL_NO WAYBILL_NO,
				WAYBILLRFC.STATUS PROCESSSTATUS,
				WAYBILLRFC.RFC_SOURCE RFC_SOURCE,
				WAYBILLRFC.RFC_REASON RFC_REASON,
				WAYBILLRFC.DRAFT_ORG_NAME DRAFT_ORG_NAME,
				WAYBILLRFC.DRAFT_ORG_CODE DRAFT_ORG_CODE,
				WAYBILLRFC.DRAFTER DRAFTER,
				WAYBILLRFC.OPERATE_ORG_NAME	OPERATE_ORG_NAME,
				WAYBILLRFC.OPERATE_ORG_CODE OPERATE_ORG_CODE,
				WAYBILLRFC.OPERATOR OPERATOR,
				WAYBILLRFC.DRAFT_TIME DRAFT_TIME,
				WAYBILLRFC.OPERATE_TIME OPERATE_TIME,
				WAYBILLRFC.NOTES NOTES,
				WAYBILLRFC.RFC_TYPE RFC_TYPE
		  from pkp.t_srv_waybillrfc WAYBILLRFC 
		 where WAYBILLRFC.new_version_waybill_id = #{wayBill_id,jdbcType=VARCHAR}
	</select>
</mapper>