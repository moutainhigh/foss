<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="foss.pkp.WaybillInfoForQmsMapper">
	<resultMap id="waybillInfoResultMap"
		type="com.deppon.foss.module.pickup.waybill.shared.dto.WaybillInfoDto">
		<result column="WAYBILL_NO" property="waybillNo" jdbcType="VARCHAR" />
		<result column="TRANSPORT_TYPE" property="transportType"
			jdbcType="VARCHAR" />
		<result column="PRODUCT_CODE" property="productCode" jdbcType="VARCHAR" />
		<result column="DELIVERY_CUSTOMER_CONTACT" property="deliveryCustomerName"
			jdbcType="VARCHAR" />
		<result column="DELIVERY_CUSTOMER_PHONE" property="deliveryCustomerPhone"
			jdbcType="VARCHAR" />
		<result column="DELIVERY_CUSTOMER_MOBILEPHONE" property="deliveryCustomerMobilephone"
			jdbcType="VARCHAR" />
		<result column="RECEIVE_ORG_CODE" property="deliveryCustomerCityCode"
			jdbcType="VARCHAR" />
		<result column="DELIVERY_CUSTOMER_ADDRESS" property="deliveryCustomerAddress"
			jdbcType="VARCHAR" />
		<result column="RECEIVE_CUSTOMER_CONTACT" property="receiveCustomerName"
			jdbcType="VARCHAR" />
		<result column="RECEIVE_CUSTOMER_PHONE" property="receiveCustomerPhone"
			jdbcType="VARCHAR" />
		<result column="RECEIVE_CUSTOMER_MOBILEPHONE" property="receiveCustomerMobilephone"
			jdbcType="VARCHAR" />
		<result column="TARGET_ORG_CODE" property="targetOrgCode"
			jdbcType="VARCHAR" />
		<result column="RECEIVE_CUSTOMER_ADDRESS" property="receiveCustomerAddress"
			jdbcType="VARCHAR" />
		<result column="GOODS_NAME" property="goodsName" jdbcType="VARCHAR" />
		<result column="GOODS_QTY_TOTAL" property="goodsQtyTotal"
			jdbcType="NUMERIC" />
		<result column="GOODS_WEIGHT_TOTAL" property="goodsWeightTotal"
			jdbcType="DECIMAL" />
		<result column="GOODS_VOLUME_TOTAL" property="goodsVolumeTotal"
			jdbcType="DECIMAL" />
		<result column="TOTAL_FEE" property="totalFee" jdbcType="DECIMAL" />
		<result column="PAID_METHOD" property="paidMethod" jdbcType="VARCHAR" />
		<result column="PRE_PAY_AMOUNT" property="prePayAmount"
			jdbcType="DECIMAL" />
		<result column="TO_PAY_AMOUNT" property="toPayAmount" jdbcType="DECIMAL" />
		<result column="REFUND_TYPE" property="refundType" jdbcType="VARCHAR" />
		<result column="COD_AMOUNT" property="codAmount" jdbcType="DECIMAL" />
		<result column="COD_FEE" property="codFee" jdbcType="DECIMAL" />
		<result column="RECEIVE_METHOD" property="receiveMethod"
			jdbcType="VARCHAR" />
		<result column="PICKUP_FEE" property="pickupFee" jdbcType="DECIMAL" />
		<result column="DELIVERY_GOODS_FEE" property="deliveryGoodsFee"
			jdbcType="DECIMAL" />
		<result column="PACKAGE_FEE" property="packageFee" jdbcType="DECIMAL" />
		<result column="SERVICE_FEE" property="serviceFee" jdbcType="DECIMAL" />
		<result column="TRANSPORT_FEE" property="transportFee"
			jdbcType="DECIMAL" />
		<result column="RECEIVE_ORG_CODE" property="receiveOrgCode"
			jdbcType="VARCHAR" />
		<result column="CUSTOMER_PICKUP_ORG_CODE" property="customerPickupOrgCode"
			jdbcType="VARCHAR" />
		<result column="SIGN_SITUATION" property="signSituation"
			jdbcType="VARCHAR" />
		<result column="DELIVERYMAN_NAME" property="deliverymanName"
			jdbcType="VARCHAR" />
		<result column="SIGN_TIME" property="signTime" jdbcType="TIMESTAMP" />
		<result column="SIGN_NOTE" property="signNote" jdbcType="VARCHAR" />
		<result column="ORDER_NO" property="orderNo" jdbcType="VARCHAR" />
		<result column="INSURANCE_AMOUNT" property="insuranceAmount"
			jdbcType="DECIMAL" />
		<result column="INSURANCE_FEE" property="insuranceFee"
			jdbcType="DECIMAL" />
		<result column="GOODS_PACKAGE" property="goodsPackage"
			jdbcType="VARCHAR" />
		<result column="ACTIVE" property="active" jdbcType="VARCHAR" />
		<result column="OTHER_FEE" property="otherFee" jdbcType="DECIMAL" />
		<result column="OUTER_NOTES" property="outerNotes" jdbcType="VARCHAR" typeHandler="org.apache.ibatis.type.ClobTypeHandler"/>
		<result column="DELIVERY_CUSTOMER_CODE" property="deliveryCustomerCode"
			jdbcType="VARCHAR" />
		<result column="RECEIVE_CUSTOMER_CODE" property="receiveCustomerCode"
			jdbcType="VARCHAR" />
		<result column="SETTLE_STATUS" property="settleStatus"
			jdbcType="VARCHAR" />
		<result column="RETURN_BILL_TYPE" property="returnBillType"
			jdbcType="VARCHAR" />
		<result column="TRANSPORTATION_REMARK" property="transportationRemark" jdbcType="VARCHAR" typeHandler="org.apache.ibatis.type.ClobTypeHandler"/>  
		<result column="BILL_TIME" property="billTime" jdbcType="TIMESTAMP" />
		<result column="LOAD_ORG_CODE" property="loadOrgCode" jdbcType="VARCHAR" />
		<result column="DELIVERY_CUSTOMER_PROV_CODE" property="deliveryCustomerProvCode"
			jdbcType="VARCHAR" />
		<result column="DELIVERY_CUSTOMER_CITY_CODE" property="deliveryCustomerCityCode1"  
			jdbcType="VARCHAR" />
		<result column="DELIVERY_CUSTOMER_DIST_CODE" property="deliveryCustomerDistCode"  
			jdbcType="VARCHAR" />
		<result column="RECEIVE_CUSTOMER_PROV_CODE" property="receiveCustomerProvCode"
			jdbcType="VARCHAR" />
		<result column="RECEIVE_CUSTOMER_CITY_CODE" property="receiveCustomerCityCode"
			jdbcType="VARCHAR" />
		<result column="RECEIVE_CUSTOMER_DIST_CODE" property="receiveCustomerDistCode"
			jdbcType="VARCHAR" />
		<result column="PICKUP_TO_DOOR" property="pickupToDoor"
			jdbcType="VARCHAR" />
		<result column="NOTIFICATION_RESULT" property="notificationResult"
			jdbcType="VARCHAR" />
			
		<result column="EXPRESS_EMP_CODE" property="startExpressEmpCode"
			jdbcType="VARCHAR" />
		<result column="EXPRESS_EMP_NAME" property="startExpressEmpName"
			jdbcType="VARCHAR" />
		<result column="EXPRESS_ORG_CODE" property="startExpressOrgCode"
			jdbcType="VARCHAR" />
		<result column="EXPRESS_ORG_NAME" property="startExpressOrgName"
			jdbcType="VARCHAR" />
		<result column="RECEIVE_CUSTOMER_ADDRESS_NOTE" property="receiveCustomerAddressNote"
			jdbcType="VARCHAR" />
		<result column="DELIVERY_CUSTOMER_ADDRESS_NOTE" property="deliveryCustomerAddressNote"
			jdbcType="VARCHAR" />
		<result column="OPERATION_ORG_NAME" property="complementOperationOrgName"
			jdbcType="VARCHAR" />
		<result column="OPERATION_ORG_CODE" property="complementOperationOrgCode"
			jdbcType="VARCHAR" />	
        
        <result column="PRINCIPAL_ORG_NAME" property="principalOrgName" jdbcType="VARCHAR" />	
        <result column="PRINCIPAL_ORG_CODE" property="principalOrgCode" jdbcType="VARCHAR" />	
		

		<!-- 增加大客户字段 -->
		<result column="DELIVERY_BIG_CUSTOMER" property="isBigDeliverCustomer" 
			jdbcType="CHAR"/>
		<!-- 增加俩个字段：返货类型和原运单号 -->
		<result column="RETURN_TYPE" property="returnType" jdbcType="VARCHAR"/>
		<result column="ORIGINAL_WAYBILL_NO" property="originalWaybillNo" jdbcType="VARCHAR"/>
		
		<!-- XULIXIN增加 -->
		<result column="PICKUP_CENTRALIZED" property="pickupCentralized" jdbcType="VARCHAR"/>
		<result column="CREATE_USER_CODE" property="createUserCode" jdbcType="VARCHAR"/>
		<result column="CREATE_USER_NAME" property="createUserName" jdbcType="VARCHAR" />
		<result column="CREATE_USER_DEPT_NAME" property="createUserDeptName" jdbcType="VARCHAR" />
		<result column="CREATE_ORG_CODE" property="createOrgCode" jdbcType="VARCHAR"/>
		<result column="CREATE_ORG_NAME" property="createOrgName" jdbcType="VARCHAR" />
		<result column="CREATE_ORG_PRINCIPAL_CODE" property="createOrgPrincipalCode" jdbcType="VARCHAR"/>
		<result column="CREATE_ORG_PRINCIPAL_NAME" property="createOrgPrincipalName" jdbcType="VARCHAR" />
		<result column="DRIVER_CODE" property="driverCode" jdbcType="VARCHAR"/>
		<result column="DRIVER_NAME" property="driverName" jdbcType="VARCHAR"/>
		<result column="LICENSE_PLATE_NUM" property="licensePlateNum" jdbcType="VARCHAR"/>
		
		<result column="DRIVER_ORG_CODE" property="driverOrgCode" jdbcType="VARCHAR"/>
		<result column="DRIVER_ORG_NAME" property="driverOrgName" jdbcType="VARCHAR"/>

	    <result column="MODIFY_TIME" property="modifyTime" jdbcType="VARCHAR"/>
	    
	    <result column="EXP_CREATE_TIME" property="expCreateTime" jdbcType="VARCHAR"/>
	    <result column="EXP_MODIFY_TIME" property="expModifyTime" jdbcType="VARCHAR"/>
	    <result column="EXP_BILL_TIME" property="expBillTime" jdbcType="VARCHAR"/>
	    
	    <result column="EXP_ARRIVE_ORG_CODE" property="expArriveOrgCode" jdbcType="VARCHAR"/>
	    <result column="EXP_ARRIVE_ORG_NAME" property="expArriveOrgName" jdbcType="VARCHAR"/>
	    <result column="PENDING_TYPE" property="pendingType" jdbcType="VARCHAR"/>
	    
	    <result column="MODIFY_USER_CODE" property="modifyUserCode" jdbcType="VARCHAR"/>
	    <result column="MODIFY_USER_NAME" property="modifyUserName" jdbcType="VARCHAR"/>
	    <result column="MODIFY_ORG_CODE" property="modifyOrgCode" jdbcType="VARCHAR"/>
	    <result column="MODIFY_ORG_NAME" property="modifyOrgName" jdbcType="VARCHAR"/>
	    <result column="GOODS_SIZE" property="goodsSize" jdbcType="VARCHAR" typeHandler="org.apache.ibatis.type.ClobTypeHandler"/> 
    
		<result column="IS_EXPRESS" property="isExpress" jdbcType="VARCHAR"/>
		<!-- 273279/liding add start 
		DN201512110012 新增字段[是否快递集中补录],[开单快递员]-->
		<result column="IS_EXPRESS_FOCUS" property="isExpressFocus" jdbcType="VARCHAR" />
		<result column="BILLING_COURIER" property="billingCourier" jdbcType="VARCHAR" />
		<!-- 273279/liding add end-->
		<collection property="waybillChargeCostDto" resultMap="WaybillChargeCostMap" />
	</resultMap>
	
	<resultMap id="WaybillChargeCostMap"
		type="com.deppon.foss.module.pickup.waybill.shared.dto.WaybillChargeCostDto">
		<result column="PRICING_ENTRY_CODE" property="costType"
			jdbcType="VARCHAR" />
		<result column="NAME" property="costName" jdbcType="VARCHAR" />
		<result column="AMOUNT" property="costMoney" jdbcType="DECIMAL" />
	</resultMap>
	
	<select id="queryWaybillInfo"
		parameterType="com.deppon.foss.module.pickup.waybill.shared.dto.WaybillQueryInfoDto"
		resultMap="waybillInfoResultMap">
		select  /*模块：接送货-运单-根据运单集合返回运单详细信息*/
		w.waybill_no ,
		w.transport_type ,
		w.product_code,
		w.delivery_customer_name ,
		w.delivery_customer_contact,
		w.delivery_customer_phone ,
		w.delivery_customer_mobilephone ,
		w.delivery_big_customer ,<!-- 增加发货客户为大客户 -->
		w.receive_org_code ,
		w.delivery_customer_address ,
		w.receive_customer_name ,
		w.receive_customer_contact,
		w.receive_customer_phone ,
		w.receive_customer_mobilephone,
		w.target_org_code,
		w.receive_customer_address,
		w.goods_name,
		w.goods_qty_total,
		w.goods_weight_total,
		w.goods_volume_total,
		w.total_fee/100 as total_fee,
		w.paid_method,
		w.pre_pay_amount/100 as pre_pay_amount,
		w.to_pay_amount/100 as to_pay_amount,
		w.refund_type,
		w.cod_amount/100 as cod_amount,
		w.cod_fee/100 as cod_fee,
		w.receive_method,
		w.pickup_fee/100 as pickup_fee,
		w.delivery_goods_fee/100 as delivery_goods_fee,
		w.package_fee/100 as package_fee,
		w.service_fee/100 as service_fee,
		w.transport_fee/100 as transport_fee,
		w.receive_org_code,
		w.customer_pickup_org_code,
		r.sign_situation,
		r.deliveryman_name,
		r.sign_time,
		r.sign_note,
		w.order_no,
		w.insurance_amount/100 as insurance_amount,
		w.insurance_fee/100 as insurance_fee,
		w.goods_package,
		w.active,
		w.other_fee/100 as other_fee,
		w.outer_notes,
		w.delivery_customer_code,
		w.receive_customer_code,
		f.settle_status,
		w.return_bill_type,
		w.transportation_remark,
		w.goods_package,
		w.bill_time,
		w.load_org_code ,
		w.delivery_customer_prov_code ,
		w.delivery_customer_city_code ,
		w.delivery_customer_dist_code,
		w.receive_customer_prov_code ,
		w.receive_customer_city_code ,
		w.receive_customer_dist_code,
		w.pickup_to_door,
		
		w.PICKUP_CENTRALIZED,
		w.CREATE_USER_CODE,
		w.CREATE_USER_NAME,
		w.CREATE_USER_DEPT_NAME,
		
		bso.unified_code as CREATE_ORG_CODE,
		bso.name as CREATE_ORG_NAME,
		w.DRIVER_CODE,
		bsoDriver.UNIFIED_CODE as DRIVER_ORG_CODE,
		bsoDriver.NAME as DRIVER_ORG_NAME,
		bsem2.emp_name as DRIVER_NAME,
		w.IS_EXPRESS,
		w.license_plate_num  as LICENSE_PLATE_NUM,
		
		
		w.MODIFY_TIME,
	    bsem3.emp_code as MODIFY_USER_CODE,
	    bsem3.emp_name as MODIFY_USER_NAME,
	    mbso.UNIFIED_CODE as MODIFY_ORG_CODE,
	    mbso.NAME as MODIFY_ORG_NAME,
	    w.GOODS_SIZE,
	    w.PENDING_TYPE,
		
		exp.EXPRESS_EMP_CODE ,
		exp.EXPRESS_EMP_NAME,
		exp.EXPRESS_ORG_CODE,
		exp.EXPRESS_ORG_NAME,
		exp.CREATE_TIME as EXP_CREATE_TIME,
		exp.MODIFY_TIME as EXP_MODIFY_TIME,
		exp.BILL_TIME   as EXP_BILL_TIME,
		expbso.UNIFIED_CODE as EXP_ARRIVE_ORG_CODE,
		expbso.NAME         as EXP_ARRIVE_ORG_NAME,
		
		
		F.RECEIVE_CUSTOMER_ADDRESS_NOTE AS RECEIVE_CUSTOMER_ADDRESS_NOTE,
		F.DELIVERY_CUSTOMER_ADDRESS_NOTE AS DELIVERY_CUSTOMER_ADDRESS_NOTE,
		f.notification_result,
		d.pricing_entry_code,
		e.name,
		d.amount/100 as amount,
		
		tcg.OPERATION_ORG_NAME,
		tcg.OPERATION_ORG_CODE,
		bso.name as PRINCIPAL_ORG_NAME,
		bso.UNIFIED_CODE as PRINCIPAL_ORG_CODE,
		bso.PRINCIPAL_NO as CREATE_ORG_PRINCIPAL_CODE,
		bsem.emp_name as CREATE_ORG_PRINCIPAL_NAME,
		
		wr.RETURN_TYPE,  <!-- 添加新字段，返货类型 -->
		wr.ORIGINAL_WAYBILL_NO,  <!-- 添加新字段，原运单号 -->
		<!-- 273279/liding add start -->
        f.IS_EXPRESS_FOCUS, 	<!-- 添加新字段，是否快递集中录单 -->
        bsem4.emp_name || exp.EXPRESS_EMP_CODE as BILLING_COURIER <!-- 添加新字段，开单快递员 -->
        <!-- 273279/liding add end -->
		
		from pkp.t_srv_waybill w
		left join pkp.t_srv_waybill_charge_detail d on d.waybill_no = w.waybill_no and d.active = 'Y'
		left join pkp.t_srv_waybill_return wr on wr.waybill_no = w.waybill_no
		left join pkp.t_srv_pricing_entry e on e.code = d.pricing_entry_code and e.active = 'Y'
		left join pkp.t_srv_waybill_sign_result r on r.waybill_no = w.waybill_no and r.active = 'Y'
		inner join pkp.t_srv_actual_freight f on f.waybill_no = w.waybill_no
		left join pkp.T_SRV_WAYBILL_EXPRESS exp on exp.WAYBILL_ID = w.ID
		
		left join bse.t_bas_org expbso on expbso.code=exp.CUSTOMER_PICKUP_ORG_CODE and expbso.active='Y'
		
		left join (select tc.* from tfr.t_opt_complement_log tc where tc.operation_time=(
		select max(operation_time) from tfr.t_opt_complement_log where waybill_no=tc.waybill_no))tcg 
		on tcg.waybill_no = w.waybill_no
		left join bse.t_bas_org bso on bso.code=w.CREATE_ORG_CODE and bso.active='Y'
		left join bse.t_bas_org mbso on mbso.code=w.MODIFY_ORG_CODE and mbso.active='Y'
		left join bse.t_bas_employee bsem on bsem.emp_code=bso.PRINCIPAL_NO and bsem.active='Y'
		left join bse.t_bas_employee bsem2 on bsem2.emp_code=w.DRIVER_CODE and bsem2.active='Y'
		left join bse.t_bas_employee bsem3 on bsem3.emp_code=w.MODIFY_USER_CODE and bsem3.active='Y'
		<!-- 273279/liding add start 
		DN201512110012 新增字段[开单快递员]关联表-->
		left join bse.t_bas_employee bsem4 on bsem4.emp_code=exp.EXPRESS_EMP_CODE and bsem4.active='Y'
		<!-- 273279/liding add end 
		DN201512110012 新增字段[开单快递员]关联表-->
		left join bse.t_bas_org bsoDriver on bsem2.unifield_code=bsoDriver.unified_code and bsem2.active='Y'
		where w.waybill_no in
		<foreach collection="waybillList" open="(" close=")"
			separator="," item="waybillNo">
			<if test="waybillNo!=null and waybillNo != ''">
    	      <![CDATA[	#{waybillNo,jdbcType=VARCHAR} ]]>
			</if>
		</foreach>
		<if test="state!=null and state!= ''">
			and w.active =  <![CDATA[#{state,jdbcType=VARCHAR}]]>
		</if>
	</select>
	
	<select id="getIsExpressByWayBillNo" resultType="java.lang.String"
		parameterType="java.lang.String">
		select
		 IS_EXPRESS
		from PKP.T_SRV_WAYBILL
		where waybill_no = #{waybillNo,jdbcType=VARCHAR}
		and active ='Y'
	</select>
	
	<select id="getWoodenPackageOrgCode" resultType="java.lang.String"
		parameterType="java.lang.String">
		select 
		wo.unified_code woodenPackageOrgCode 
		from pkp.t_srv_wooden_requirements_pg p
		left join bse.t_bas_org wo on wo.code = p.package_org_code 
		
		where p.waybill_no = #{waybillNo,jdbcType=VARCHAR}
		and wo.active = 'Y'
	</select>
</mapper>