<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="foss.stl.FreightDiscountDao" >
	<resultMap id="FreightResultMap" type="com.deppon.foss.module.settlement.common.api.shared.domain.BillPayableEntity" >
		<id column="ID" property="id" jdbcType="VARCHAR" />
		<result column="PAYABLE_NO" property="payableNo" jdbcType="VARCHAR" />
		<result column="WAYBILL_NO" property="waybillNo" jdbcType="VARCHAR" />
		<result column="WAYBILL_ID" property="waybillId" jdbcType="VARCHAR" />
		<result column="PAYMENT_NO" property="paymentNo" jdbcType="VARCHAR" />
		<result column="CREATE_TYPE" property="createType" jdbcType="VARCHAR" />
		<result column="BILL_TYPE" property="billType" jdbcType="VARCHAR" />
		<result column="SOURCE_BILL_NO" property="sourceBillNo" jdbcType="VARCHAR" />
		<result column="SOURCE_BILL_TYPE" property="sourceBillType" jdbcType="VARCHAR" />
		<result column="COD_TYPE" property="codType" jdbcType="VARCHAR" />
		<result column="PAYABLE_ORG_CODE" property="payableOrgCode" jdbcType="VARCHAR" />
		<result column="PAYABLE_ORG_NAME" property="payableOrgName" jdbcType="VARCHAR" />
		<result column="PAYABLE_COM_CODE" property="payableComCode" jdbcType="VARCHAR" />
		<result column="PAYABLE_COM_NAME" property="payableComName" jdbcType="VARCHAR" />
		<result column="ORIG_ORG_CODE" property="origOrgCode" jdbcType="VARCHAR" />
		<result column="ORIG_ORG_NAME" property="origOrgName" jdbcType="VARCHAR" />
		<result column="DEST_ORG_CODE" property="destOrgCode" jdbcType="VARCHAR" />
		<result column="DEST_ORG_NAME" property="destOrgName" jdbcType="VARCHAR" />
		<result column="CUSTOMER_CODE" property="customerCode" jdbcType="VARCHAR" />
		<result column="CUSTOMER_NAME" property="customerName" jdbcType="VARCHAR" />
		<result column="AMOUNT" property="amount" jdbcType="DECIMAL" />
		<result column="VERIFY_AMOUNT" property="verifyAmount" jdbcType="DECIMAL" />
		<result column="UNVERIFY_AMOUNT" property="unverifyAmount" jdbcType="DECIMAL" />
		<result column="CURRENCY_CODE" property="currencyCode" jdbcType="VARCHAR" />
		<result column="PRODUCT_CODE" property="productCode" jdbcType="VARCHAR" />
		<result column="PRODUCT_ID" property="productId" jdbcType="VARCHAR" />
		<result column="ACCOUNT_DATE" property="accountDate" jdbcType="TIMESTAMP" />
		<result column="BUSINESS_DATE" property="businessDate" jdbcType="TIMESTAMP" />
		<result column="SIGN_DATE" property="signDate" jdbcType="TIMESTAMP" />
		<result column="EFFECTIVE_DATE" property="effectiveDate" jdbcType="TIMESTAMP" />
		<result column="CREATE_USER_NAME" property="createUserName" jdbcType="VARCHAR" />
		<result column="CREATE_USER_CODE" property="createUserCode" jdbcType="VARCHAR" />
		<result column="CREATE_ORG_CODE" property="createOrgCode" jdbcType="VARCHAR" />
		<result column="CREATE_ORG_NAME" property="createOrgName" jdbcType="VARCHAR" />
		<result column="ACTIVE" property="active" jdbcType="CHAR" />
		<result column="IS_RED_BACK" property="isRedBack" jdbcType="CHAR" />
		<result column="IS_INIT" property="isInit" jdbcType="CHAR" />
		<result column="VERSION_NO" property="versionNo" jdbcType="DECIMAL" />
		<result column="EFFECTIVE_STATUS" property="effectiveStatus" jdbcType="CHAR" />
		<result column="EFFECTIVE_USER_NAME" property="effectiveUserName" jdbcType="VARCHAR" />
		<result column="EFFECTIVE_USER_CODE" property="effectiveUserCode" jdbcType="VARCHAR" />
		<result column="FROZEN_STATUS" property="frozenStatus" jdbcType="CHAR" />
		<result column="FROZEN_TIME" property="frozenTime" jdbcType="TIMESTAMP" />
		<result column="FROZEN_USER_NAME" property="frozenUserName" jdbcType="VARCHAR" />
		<result column="FROZEN_USER_CODE" property="frozenUserCode" jdbcType="VARCHAR" />
		<result column="PAY_STATUS" property="payStatus" jdbcType="CHAR" />
		<result column="STATEMENT_BILL_NO" property="statementBillNo" jdbcType="VARCHAR" />
		<result column="CUSTOMER_CONTACT" property="customerContact" jdbcType="VARCHAR" />
		<result column="CUSTOMER_CONTACT_NAME" property="customerContactName" jdbcType="VARCHAR" />
		<result column="CUSTOMER_PHONE" property="customerPhone" jdbcType="VARCHAR" />
		<result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" />
		<result column="MODIFY_TIME" property="modifyTime" jdbcType="TIMESTAMP" />
		<result column="MODIFY_USER_NAME" property="modifyUserName" jdbcType="VARCHAR" />
		<result column="MODIFY_USER_CODE" property="modifyUserCode" jdbcType="VARCHAR" />
		<result column="WORKFLOW_NO" property="workflowNo" jdbcType="VARCHAR" />
		<result column="LGDRIVER_CODE" property="lgdriverCode" jdbcType="VARCHAR" />
		<result column="LGDRIVER_NAME" property="lgdriverName" jdbcType="VARCHAR" />
		<result column="PAYER_TYPE" property="payerType" jdbcType="VARCHAR" />
		<result column="PAYABLE_TYPE" property="payableType" jdbcType="VARCHAR" />
		<result column="DELIVER_FEE" property="deliverFee" jdbcType="DECIMAL" />
		<result column="OUTGOING_FEE" property="outgoingFee" jdbcType="DECIMAL" />
		<result column="AUDIT_USER_CODE" property="auditUserCode" jdbcType="VARCHAR" />
		<result column="AUDIT_USER_NAME" property="auditUserName" jdbcType="VARCHAR" />
		<result column="AUDIT_DATE" property="auditDate" jdbcType="TIMESTAMP" />
		<result column="APPROVE_STATUS" property="approveStatus" jdbcType="VARCHAR" />
		<result column="NOTES" property="notes" jdbcType="VARCHAR" />
		<result column="PAYEE_NAME" property="payeeName" jdbcType="VARCHAR" />
		<result column="BANK_HQ_CODE" property="bankHqCode" jdbcType="VARCHAR" />
		<result column="BANK_HQ_NAME" property="bankHqName" jdbcType="VARCHAR" />
		<result column="ACCOUNT_NO" property="accountNo" jdbcType="VARCHAR" />
		<result column="PROVINCE_CODE" property="provinceCode" jdbcType="VARCHAR" />
		<result column="PROVINCE_NAME" property="provinceName" jdbcType="VARCHAR" />
		<result column="CITY_CODE" property="cityCode" jdbcType="VARCHAR" />
		<result column="CITY_NAME" property="cityName" jdbcType="VARCHAR" />
		<result column="BANK_BRANCH_CODE" property="bankBranchCode" jdbcType="VARCHAR" />
		<result column="BANK_BRANCH_NAME" property="bankBranchName" jdbcType="VARCHAR" />
		<result column="PAYMENT_NOTES" property="paymentNotes" jdbcType="VARCHAR" />
		<result column="PAYMENT_AMOUNT" property="paymentAmount" jdbcType="DECIMAL" />
		<result column="LAST_PAYMENT_TIME" property="lastPaymentTime" jdbcType="TIMESTAMP" /><!-- 最后付款日期 -->
		<result column="PAYMENT_CATEGORIES" property="paymentCategories" jdbcType="VARCHAR" /><!-- 支付类别 -->
		<result column="IS_WRITEOFF" property="isWriteoff" jdbcType="CHAR" /><!-- 是否核销 -->
		<result column="ACCOUNT_TYPE" property="accountType" jdbcType="VARCHAR" /><!-- 账户类型-->
		<result column="COD_AGENCY_FEE" property="codAgencyFee" jdbcType="DECIMAL" />
		<result column="EXTERNAL_INSURANCE_FEE" property="externalInsuranceFee" jdbcType="DECIMAL" />
		<result column="EXPRESS_ORIG_ORG_CODE" property="expressOrigOrgCode" jdbcType="VARCHAR" />
		<result column="EXPRESS_ORIG_ORG_NAME" property="expressOrigOrgName" jdbcType="VARCHAR" />
		<result column="EXPRESS_DEST_ORG_CODE" property="expressDestOrgCode" jdbcType="VARCHAR" />
		<result column="EXPRESS_DEST_ORG_NAME" property="expressDestOrgName" jdbcType="VARCHAR" />
		<result column="INVOICE_MARK" property="invoiceMark" jdbcType="VARCHAR" /> 
		<result column="COSTDEPT_CODE" property="costDeptCode" jdbcType="VARCHAR" /> 
		<result column="COSTDEPT_NAME" property="costDeptName" jdbcType="VARCHAR" /> 
		<result column="COST_DATE" property="costDate" jdbcType="TIMESTAMP" /> 
		<result column="VEHICLE_NO" property="vehicleNo" jdbcType="VARCHAR" /> 
		<result column="DRIVER_NAME" property="driverName" jdbcType="VARCHAR" /> 
		<result column="DRIVER_PHONE" property="driverPhone" jdbcType="VARCHAR" /> 
		<result column="RENTCAR_USE_TYPE" property="rentCarUseType" jdbcType="VARCHAR" /> 
		<result column="COST_TYPE" property="costType" jdbcType="VARCHAR" />
		<result column="VAT_INVOICE" property="vatInvoice" jdbcType="VARCHAR" />
		<result column="TAXPAYER_NUMBER" property="taxpayerNumber" jdbcType="VARCHAR" />
		<result column="TAX_AMOUNT" property="taxAmount" jdbcType="VARCHAR" />
		<result column="TAX" property="tax" jdbcType="VARCHAR" />
		<result column="BUSINESS_OF_DATE" property="businessOfDate" jdbcType="TIMESTAMP" />
		<result column="ACCRUED_STATE" property="accruedState" jdbcType="VARCHAR" />
		<result column="WITHHOLDING_STATUS" property="withholdingStatus" jdbcType="VARCHAR" />
		<result column="UNIFIED_SETTLEMENT" property="unifiedSettlement" jdbcType="VARCHAR"/>
		<result column="CONTRACT_ORG_CODE" property="contractOrgCode" jdbcType="VARCHAR"/>
		<result column="CONTRACT_ORG_NAME" property="contractOrgName" jdbcType="VARCHAR"/>
		<result column="PAYMENT_WORKFLOW_NO" property="paymentWorkflowNo" jdbcType="VARCHAR"/>
		<result column="PAYMENT_TRANSFER" property="paymentTransfer" jdbcType="VARCHAR"/>
	</resultMap>
  
	<sql id="Freight_Column_List" >
    	ID, PAYABLE_NO, WAYBILL_NO, WAYBILL_ID, PAYMENT_NO, CREATE_TYPE, BILL_TYPE, SOURCE_BILL_NO, SOURCE_BILL_TYPE,COD_TYPE,
    	PAYABLE_ORG_CODE, PAYABLE_ORG_NAME, PAYABLE_COM_CODE, PAYABLE_COM_NAME, ORIG_ORG_CODE, 
		ORIG_ORG_NAME, DEST_ORG_CODE, DEST_ORG_NAME, CUSTOMER_CODE, CUSTOMER_NAME, AMOUNT/100 AMOUNT, 
		VERIFY_AMOUNT/100 VERIFY_AMOUNT, UNVERIFY_AMOUNT/100 UNVERIFY_AMOUNT, CURRENCY_CODE,PRODUCT_CODE,PRODUCT_ID, ACCOUNT_DATE, BUSINESS_DATE, SIGN_DATE, 
		EFFECTIVE_DATE, CREATE_USER_NAME, CREATE_USER_CODE, CREATE_ORG_CODE, CREATE_ORG_NAME, 
		ACTIVE, IS_RED_BACK, IS_INIT, VERSION_NO, EFFECTIVE_STATUS, EFFECTIVE_USER_NAME, 
		EFFECTIVE_USER_CODE, FROZEN_STATUS, FROZEN_TIME, FROZEN_USER_NAME, FROZEN_USER_CODE, 
		PAY_STATUS, STATEMENT_BILL_NO,  CUSTOMER_CONTACT, 
		CUSTOMER_CONTACT_NAME, CUSTOMER_PHONE, CREATE_TIME, MODIFY_TIME, 
		MODIFY_USER_NAME, MODIFY_USER_CODE, 
		WORKFLOW_NO, LGDRIVER_CODE, LGDRIVER_NAME, PAYER_TYPE, PAYABLE_TYPE, DELIVER_FEE/100 DELIVER_FEE, 
		OUTGOING_FEE/100 OUTGOING_FEE, AUDIT_USER_CODE, AUDIT_USER_NAME, AUDIT_DATE, APPROVE_STATUS, NOTES
		,PAYEE_NAME,BANK_HQ_CODE,BANK_HQ_NAME,ACCOUNT_NO,PROVINCE_CODE,PROVINCE_NAME,
		CITY_CODE,CITY_NAME,BANK_BRANCH_CODE,BANK_BRANCH_NAME,PAYMENT_NOTES,PAYMENT_AMOUNT/100 PAYMENT_AMOUNT
		,LAST_PAYMENT_TIME,PAYMENT_CATEGORIES,IS_WRITEOFF,ACCOUNT_TYPE,COD_AGENCY_FEE,EXTERNAL_INSURANCE_FEE,
		EXPRESS_ORIG_ORG_CODE,EXPRESS_ORIG_ORG_NAME,EXPRESS_DEST_ORG_CODE,EXPRESS_DEST_ORG_NAME,INVOICE_MARK,
		UNIFIED_SETTLEMENT,CONTRACT_ORG_CODE,CONTRACT_ORG_NAME
	</sql>

	<select id="queryCustomerContract" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*)
		  FROM BSE.T_BAS_CUS_LTDISCOUNTAFTER T
		<![CDATA[
		 WHERE TRUNC(T.EFFECTIVE_TIME, 'MM') <= TRUNC(#{businessDate, jdbcType=TIMESTAMP}, 'MM')
		   AND (T.FAILURE_TIME > #{businessDate, jdbcType=VARCHAR}
		    OR T.FAILURE_TIME IS NULL)
		   AND T.CUSTOMER_CODE = #{customerCode, jdbcType=VARCHAR}
		]]>
	</select>

	<select id="queryDiscountPayableBill" parameterType="java.util.Map" resultMap="FreightResultMap">
		SELECT <include refid="Freight_Column_List" />
		  FROM STL.T_STL_BILL_PAYABLE P
		 WHERE P.ACTIVE = 'Y'
		   AND P.BILL_TYPE = 'FDC'
		   AND P.WAYBILL_NO = #{wayblllNo,jdbcType=VARCHAR}
	</select>

	<select id="queryCustomerDiscountRate" parameterType="java.util.Map" resultType="int">
		SELECT COUNT(*)
		  FROM STL.T_STL_DISCOUNT_RATE_FREIGHT RF
		 WHERE TRUNC(RF.EFFECT_MONTH, 'MM') = TRUNC(#{businessDate,jdbcType=TIMESTAMP}, 'MM')
		   AND RF.CUSTOMER_CODE = #{customerCode, jdbcType=VARCHAR}
		   AND RF.ACTIVE = 'Y'
	</select>
	<!-- 331556 fanjingwei 2016-07-20 德邦E家项目增加精准包裹三级产品 code为PCP -->
	<insert id="createFreightDiscountPayableBill" parameterType="java.util.Map">
		INSERT INTO STL.T_STL_BILL_PAYABLE
			(ID,
	         PAYABLE_NO,
	         WAYBILL_NO,
	         WAYBILL_ID,
	         PAYMENT_NO,
	         CREATE_TYPE,
	         BILL_TYPE,
	         SOURCE_BILL_NO,
	         SOURCE_BILL_TYPE,
	         PRODUCT_CODE,
	         PAYABLE_ORG_CODE,
	         PAYABLE_ORG_NAME,
	         PAYABLE_COM_CODE,
	         PAYABLE_COM_NAME,
	         ORIG_ORG_CODE,
	         ORIG_ORG_NAME,
	         DEST_ORG_CODE,
	         DEST_ORG_NAME,
	         CUSTOMER_CODE,
	         CUSTOMER_NAME,
	         AMOUNT,
	         VERIFY_AMOUNT,
	         UNVERIFY_AMOUNT,
	         CURRENCY_CODE,
	         PRODUCT_ID,
	         ACCOUNT_DATE,
	         BUSINESS_DATE,
	         EFFECTIVE_DATE,
	         ACTIVE,
	         IS_RED_BACK,
	         IS_INIT,
	         VERSION_NO,
	         EFFECTIVE_STATUS,
	         PAY_STATUS,
	         STATEMENT_BILL_NO,
	         CREATE_TIME,
	         MODIFY_TIME,
	         APPROVE_STATUS,
	         IS_DISABLE)
	        (SELECT SYS_GUID(),
	                'YF1' || LPAD(STL.SQ_YF1.NEXTVAL, 9, '0') PAYABLE_NO,
	                RE.WAYBILL_NO WAYBILL_NO,
	                RE.WAYBILL_ID WAYBILL_ID,
	                'N/A' PAYMENT_NO,
	                'A' CREATE_TYPE,
	                'FDC' BILL_TYPE,
	                RE.WAYBILL_NO SOURCE_BILL_NO,
	                'W' SOURCE_BILL_TYPE,
	                RE.PRODUCT_CODE PRODUCT_CODE,
	                RE.DUNNING_ORG_CODE PAYABLE_ORG_CODE,
	                RE.DUNNING_ORG_NAME PAYABLE_ORG_NAME,
	                FO.CODE PAYABLE_COM_CODE,
	                FO.NAME PAYABLE_COM_NAME,
	                RE.ORIG_ORG_CODE ORIG_ORG_CODE,
	                RE.ORIG_ORG_NAME ORIG_ORG_NAME,
	                RE.DEST_ORG_CODE DEST_ORG_CODE,
	                RE.DEST_ORG_NAME DEST_ORG_NAME,
	                RE.CUSTOMER_CODE CUSTOMER_CODE,
	                RE.CUSTOMER_NAME CUSTOMER_NAME,
	                WB.TRANSPORT_FEE -
	                GREATEST(WB.TRANSPORT_FEE * DR.TRANSPORT_RATE,
	                         NVL(AF.MIN_TRANSPORT_FEE, 0)) AMOUNT,
	                0 VERIFY_AMOUNT,
	                WB.TRANSPORT_FEE -
	                GREATEST(WB.TRANSPORT_FEE * DR.TRANSPORT_RATE,
	                         NVL(AF.MIN_TRANSPORT_FEE, 0)) UNVERIFY_AMOUNT,
	                RE.CURRENCY_CODE CURRENCY_CODE,
	                RE.PRODUCT_ID PRODUCT_ID,
	                SYSDATE ACCOUNT_DATE,
	                #{payableBusinessDate,jdbcType=TIMESTAMP} BUSINESS_DATE,
	                SYSDATE EFFECTIVE_DATE,
	                'Y' ACTIVE,
	                'N' IS_RED_BACK,
	                'N' IS_INIT,
	                '1' VERSION_NO,
	                'Y' EFFECTIVE_STATUS,
	                'N' PAY_STATUS,
	                'N/A' STATEMENT_BILL_NO,
	                SYSDATE CREATE_TIME,
	                SYSDATE MODIFY_TIME,
	                'AA' APPROVE_STATUS,
	                'N' IS_DISABLE
	           FROM STL.T_STL_BILL_RECEIVABLE RE
	          INNER JOIN STL.T_STL_DISCOUNT_RATE_FREIGHT DR
	             ON DR.CUSTOMER_CODE = RE.CUSTOMER_CODE
	          INNER JOIN PKP.T_SRV_WAYBILL WB
	             ON WB.WAYBILL_NO = RE.WAYBILL_NO
	            AND WB.ACTIVE = 'Y'
	          INNER JOIN PKP.T_SRV_ACTUAL_FREIGHT AF
             	 ON AF.WAYBILL_NO = WB.WAYBILL_NO
	          INNER JOIN BSE.T_BAS_ORG O
	             ON O.CODE = RE.DUNNING_ORG_CODE
	            AND O.ACTIVE = 'Y'
	          INNER JOIN BSE.T_BAS_FIN_ORG FO
	             ON FO.CODE = O.SUBSIDIARY_CODE
	            AND FO.ACTIVE = 'Y'
	          WHERE RE.PRODUCT_CODE IN ('FLF', 'FSF', 'LRF', 'PLF', 'SRF','PCP') 
	            AND RE.BILL_TYPE = 'OR'
	            AND RE.ACTIVE = 'Y'
	            AND WB.PRODUCT_CODE IN ('FLF', 'FSF', 'LRF', 'PLF', 'SRF','PCP')
            	AND WB.PAID_METHOD IN ('DT', 'CT')
	            AND TRUNC(DR.EFFECT_MONTH, 'MM') = TRUNC(RE.BUSINESS_DATE, 'MM')
	            AND RE.CUSTOMER_CODE = WB.DELIVERY_CUSTOMER_CODE
	            AND RE.PAYMENT_TYPE IN ('DT', 'CT')
	            AND DR.ACTIVE = 'Y'
	            AND WB.TRANSPORT_FEE -
	                GREATEST(WB.TRANSPORT_FEE * DR.TRANSPORT_RATE,
	                         NVL(AF.MIN_TRANSPORT_FEE, 0)) > 0
	            AND RE.CUSTOMER_CODE = #{customerCode, jdbcType=VARCHAR}
	            AND RE.WAYBILL_NO = #{waybillNo,jdbcType=VARCHAR}
	            AND WB.WAYBILL_NO = #{waybillNo,jdbcType=VARCHAR})
	</insert>
</mapper>