<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
	"-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="foss.stl.CustomerStatementDao">
	<resultMap id="CustomerStatementDResultMap"
		type="com.deppon.foss.module.settlement.writeoff.api.shared.domain.CustomerStatementDEntity">
		<id column="ID" property="id" jdbcType="VARCHAR" />
		<result column="STATEMENT_BILL_NO" property="statementBillNo" jdbcType="VARCHAR" />
		<result column="SOURCE_BILL_NO" property="sourceBillNo" jdbcType="VARCHAR" />
		<result column="ORIG_SOURCE_BILL_NO" property="origSourceBillNo" jdbcType="VARCHAR" />
		<result column="WAYBILL_NO" property="waybillNo" jdbcType="VARCHAR" />
		<result column="BILL_TYPE" property="billType" jdbcType="VARCHAR" />
		<result column="AMOUNT" property="amount" jdbcType="DECIMAL" />
		<result column="VERIFY_AMOUNT" property="verifyAmount" jdbcType="DECIMAL" />
		<result column="UNVERIFY_AMOUNT" property="unverifyAmount" jdbcType="DECIMAL" />
		<result column="ORG_CODE" property="orgCode" jdbcType="VARCHAR" />
		<result column="ORG_NAME" property="orgName" jdbcType="VARCHAR" />
		<result column="ORIG_ORG_CODE" property="origOrgCode" jdbcType="VARCHAR" />
		<result column="ORIG_ORG_NAME" property="origOrgName" jdbcType="VARCHAR" />
		<result column="DEST_ORG_CODE" property="destOrgCode" jdbcType="VARCHAR" />
		<result column="DEST_ORG_NAME" property="destOrgName" jdbcType="VARCHAR" />
		<result column="CUSTOMER_CODE" property="customerCode" jdbcType="VARCHAR" />
		<result column="CUSTOMER_NAME" property="customerName" jdbcType="VARCHAR" />
		<result column="DEPT_REGION_CODE" property="deptRegionCode" jdbcType="VARCHAR" />
		<result column="ARRV_REGION_CODE" property="arrvRegionCode" jdbcType="VARCHAR" />
		<result column="CUSTOMER_PICKUP_ORG_NAME" property="customerPickupOrgName" jdbcType="VARCHAR" />
		<result column="QTY" property="qty" jdbcType="DECIMAL" />
		<result column="BILLING_VOLUME" property="billingVolume" jdbcType="DECIMAL" />
		<result column="BILL_WEIGHT" property="billWeight" jdbcType="DECIMAL" />
		<result column="GOODS_NAME" property="goodsName" jdbcType="VARCHAR" />
		<result column="DELIVERY_CUSTOMER_CODE" property="deliveryCustomerCode" jdbcType="VARCHAR" />
		<result column="DELIVERY_CUSTOMER_NAME" property="deliveryCustomerName" jdbcType="VARCHAR" />
		<result column="RECEIVE_CUSTOMER_CODE" property="receiveCustomerCode" jdbcType="VARCHAR" />
		<result column="RECEIVE_CUSTOMER_NAME" property="receiveCustomerName" jdbcType="VARCHAR" />
		<result column="PAYMENT_TYPE" property="paymentType" jdbcType="VARCHAR" />
		<result column="RECEIVE_METHOD" property="receiveMethod" jdbcType="VARCHAR" />
		<result column="PRODUCT_CODE" property="productCode" jdbcType="VARCHAR" />
		<result column="INSURANCE_FEE" property="insuranceFee" jdbcType="DECIMAL" />
		<result column="TRANSPORT_FEE" property="transportFee" jdbcType="DECIMAL" />
		<result column="PACKAGING_FEE" property="packagingFee" jdbcType="DECIMAL" />
		<result column="DELIVER_FEE" property="deliverFee" jdbcType="DECIMAL" />
		<result column="COD_FEE" property="codFee" jdbcType="DECIMAL" />
		<result column="OTHER_FEE" property="otherFee" jdbcType="DECIMAL" />
		<result column="VALUE_ADD_FEE" property="valueAddFee" jdbcType="DECIMAL" />
		<result column="PROMOTIONS_FEE" property="promotionsFee" jdbcType="DECIMAL" />
		<result column="IS_DELETE" property="isDelete" jdbcType="CHAR" />
		<result column="DISABLE_TIME" property="disableTime" jdbcType="TIMESTAMP" />
		<result column="BUSINESS_DATE" property="businessDate" jdbcType="TIMESTAMP" />
		<result column="ACCOUNT_DATE" property="accountDate" jdbcType="TIMESTAMP" />
		<result column="SIGN_DATE" property="signDate" jdbcType="TIMESTAMP" />
		<result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" />
		<result column="NOTES" property="notes" jdbcType="VARCHAR" />
		<result column="PICKUP_FEE" property="pickupFee" jdbcType="DECIMAL" />
		<result column="AUDIT_STATUS" property="auditStatus" jdbcType="VARCHAR" />
		<result column="BILL_PARENT_TYPE" property="billParentType" jdbcType="VARCHAR" />
		<result column="VERSION_NO" property="versionNo" jdbcType="VARCHAR" />
		<result column="UNIT_PRICE" property="unitPrice" jdbcType="DECIMAL" />
		<result column="INSURANCE_AMOUNT" property="insuranceAmount" jdbcType="DECIMAL" />
		<result column="DELIVERY_CUSTOMER_CONTACT" property="deliveryCustomerContact" jdbcType="VARCHAR" />
		<result column="UNIFIED_SETTLEMENT" property="unifiedSettlement" jdbcType="VARCHAR" />
	</resultMap>
	<resultMap id="CustomerStatementResultMap" 
		type="com.deppon.foss.module.settlement.writeoff.api.shared.domain.CustomerStatementEntity" >
	    <result column="ID" property="id" jdbcType="VARCHAR" />
	    <result column="STATEMENT_BILL_NO" property="statementBillNo" jdbcType="VARCHAR" />
	    <result column="CREATE_ORG_CODE" property="createOrgCode" jdbcType="VARCHAR" />
	    <result column="CREATE_ORG_NAME" property="createOrgName" jdbcType="VARCHAR" />
	    <result column="COMPANY_CODE" property="companyCode" jdbcType="VARCHAR" />
	    <result column="COMPANY_NAME" property="companyName" jdbcType="VARCHAR" />
	    <result column="UNIFIED_CODE" property="unifiedCode" jdbcType="VARCHAR" />
	    <result column="CUSTOMER_CODE" property="customerCode" jdbcType="VARCHAR" />
	    <result column="CUSTOMER_NAME" property="customerName" jdbcType="VARCHAR" />
	    <result column="BILL_TYPE" property="billType" jdbcType="VARCHAR" />
	    <result column="PERIOD_AMOUNT" property="periodAmount" jdbcType="DECIMAL" />
	    <result column="PERIOD_REC_AMOUNT" property="periodRecAmount" jdbcType="DECIMAL" />
	    <result column="PERIOD_PAY_AMOUNT" property="periodPayAmount" jdbcType="DECIMAL" />
	    <result column="PERIOD_UNVERIFY_REC_AMOUNT" property="periodUnverifyRecAmount" jdbcType="DECIMAL" />
	    <result column="PERIOD_UNVERIFY_PAY_AMOUNT" property="periodUnverifyPayAmount" jdbcType="DECIMAL" />
	    <result column="PERIOD_BEGIN_DATE" property="periodBeginDate" jdbcType="TIMESTAMP" />
	    <result column="PERIOD_END_DATE" property="periodEndDate" jdbcType="TIMESTAMP" />
	    <result column="UNPAID_AMOUNT" property="unpaidAmount" jdbcType="DECIMAL" />
	    <result column="SETTLE_NUM" property="settleNum" jdbcType="DECIMAL" />
	    <result column="CREATE_USER_CODE" property="createUserCode" jdbcType="VARCHAR" />
	    <result column="CREATE_USER_NAME" property="createUserName" jdbcType="VARCHAR" />
	    <result column="BUSINESS_DATE" property="businessDate" jdbcType="TIMESTAMP" />
	    <result column="CREATE_TIME" property="createTime" jdbcType="TIMESTAMP" />
	    <result column="MODIFY_USER_CODE" property="modifyUserCode" jdbcType="VARCHAR" />
	    <result column="MODIFY_USER_NAME" property="modifyUserName" jdbcType="VARCHAR" />
	    <result column="CONFIRM_USER_CODE" property="confirmUserCode" jdbcType="VARCHAR" />
	    <result column="CONFIRM_USER_NAME" property="confirmUserName" jdbcType="VARCHAR" />
	    <result column="CONFIRM_TIME" property="confirmTime" jdbcType="TIMESTAMP" />
	    <result column="MODIFY_TIME" property="modifyTime" jdbcType="TIMESTAMP" />
	    <result column="UNLOCK_TIME" property="unlockTime" jdbcType="TIMESTAMP" />
	    <result column="CONFIRM_STATUS" property="confirmStatus" jdbcType="VARCHAR" />
	    <result column="COMPANY_ACCOUNT_BANK_NO" property="companyAccountBankNo" jdbcType="VARCHAR" />
	    <result column="ACCOUNT_USER_NAME" property="accountUserName" jdbcType="VARCHAR" />
	    <result column="BANK_BRANCH_NAME" property="bankBranchName" jdbcType="VARCHAR" />
	    <result column="NOTES" property="notes" jdbcType="VARCHAR" />
	    <result column="VERSION_NO" property="versionNo" jdbcType="DECIMAL" />
	    <result column="INVOICE_STATUS" property="invoiceStatus" jdbcType="VARCHAR" />
	    <result column="APPLY_INVOICE" property="applyInvoice" jdbcType="VARCHAR" />
	    <result column="UNIFIED_SETTLEMENT" property="unifiedSettlement" jdbcType="VARCHAR" />
	</resultMap>
	<sql id="CustomerD_Column_List" >
	    ID, STATEMENT_BILL_NO, SOURCE_BILL_NO, ORIG_SOURCE_BILL_NO, WAYBILL_NO, BILL_TYPE, AMOUNT/100 AMOUNT, VERIFY_AMOUNT/100 VERIFY_AMOUNT, 
	    UNVERIFY_AMOUNT/100 UNVERIFY_AMOUNT, ORG_CODE, ORG_NAME,ORIG_ORG_CODE, ORIG_ORG_NAME, DEST_ORG_CODE, DEST_ORG_NAME, CUSTOMER_CODE, 
	    CUSTOMER_NAME, DEPT_REGION_CODE, ARRV_REGION_CODE, CUSTOMER_PICKUP_ORG_NAME, QTY, 
	    BILLING_VOLUME,BILL_WEIGHT, GOODS_NAME, DELIVERY_CUSTOMER_CODE, DELIVERY_CUSTOMER_NAME, RECEIVE_CUSTOMER_CODE,
	    RECEIVE_CUSTOMER_NAME,PAYMENT_TYPE,RECEIVE_METHOD, PRODUCT_CODE,
	    INSURANCE_FEE/100 INSURANCE_FEE, TRANSPORT_FEE/100 TRANSPORT_FEE, PACKAGING_FEE/100 PACKAGING_FEE, 
	    DELIVER_FEE/100 DELIVER_FEE,COD_FEE/100 COD_FEE, OTHER_FEE/100 OTHER_FEE, VALUE_ADD_FEE/100 VALUE_ADD_FEE, PROMOTIONS_FEE/100 PROMOTIONS_FEE,
	    IS_DELETE, DISABLE_TIME, BUSINESS_DATE, ACCOUNT_DATE, SIGN_DATE,
	    CREATE_TIME, NOTES,PICKUP_FEE/100 PICKUP_FEE,AUDIT_STATUS,BILL_PARENT_TYPE,UNIT_PRICE/100 UNIT_PRICE,INSURANCE_AMOUNT/100 INSURANCE_AMOUNT,
	    DELIVERY_CUSTOMER_CONTACT
	</sql>
	<sql id="Customer_Column_List" >
	    ID, STATEMENT_BILL_NO, CREATE_ORG_CODE, CREATE_ORG_NAME, COMPANY_CODE, COMPANY_NAME, 
	    UNIFIED_CODE, CUSTOMER_CODE, CUSTOMER_NAME, BILL_TYPE, 
	    PERIOD_AMOUNT/100 PERIOD_AMOUNT, PERIOD_REC_AMOUNT/100 PERIOD_REC_AMOUNT, PERIOD_PAY_AMOUNT/100 PERIOD_PAY_AMOUNT, 
	    PERIOD_UNVERIFY_REC_AMOUNT/100 PERIOD_UNVERIFY_REC_AMOUNT, 
	    PERIOD_UNVERIFY_PAY_AMOUNT/100 PERIOD_UNVERIFY_PAY_AMOUNT, PERIOD_BEGIN_DATE, PERIOD_END_DATE, 
	    UNPAID_AMOUNT/100 UNPAID_AMOUNT, SETTLE_NUM, CREATE_USER_CODE, 
	    CREATE_USER_NAME, BUSINESS_DATE, CREATE_TIME, MODIFY_USER_CODE, MODIFY_USER_NAME, 
	    CONFIRM_USER_CODE, CONFIRM_USER_NAME, CONFIRM_TIME, MODIFY_TIME, UNLOCK_TIME, CONFIRM_STATUS, 
	    COMPANY_ACCOUNT_BANK_NO, ACCOUNT_USER_NAME, BANK_BRANCH_NAME, NOTES, VERSION_NO,INVOICE_STATUS,
	    APPLY_INVOICE,UNIFIED_SETTLEMENT
	</sql>
	<!-- 查询应收单字段 -->
	<sql id="Query_Receivable_Column_List">
		SELECT /*结算-核销-查询应收单*/
		REC.RECEIVABLE_NO SOURCE_BILL_NO, REC.ID ID, REC.STATEMENT_BILL_NO STATEMENT_BILL_NO,
		REC.SOURCE_BILL_NO ORIG_SOURCE_BILL_NO,
		REC.WAYBILL_NO WAYBILL_NO, '10.YS' BILL_PARENT_TYPE,
		REC.BILL_TYPE BILL_TYPE,
		REC.AMOUNT/100 AMOUNT, REC.VERIFY_AMOUNT/100 VERIFY_AMOUNT, REC.APPROVE_STATUS
		AUDIT_STATUS, REC.UNVERIFY_AMOUNT/100 UNVERIFY_AMOUNT,
		REC.DUNNING_ORG_CODE ORG_CODE, REC.DUNNING_ORG_NAME ORG_NAME,
		REC.ORIG_ORG_CODE ORIG_ORG_CODE, REC.ORIG_ORG_NAME ORIG_ORG_NAME,
		REC.DEST_ORG_CODE DEST_ORG_CODE, REC.DEST_ORG_NAME DEST_ORG_NAME,
		REC.CUSTOMER_CODE CUSTOMER_CODE, REC.CUSTOMER_NAME CUSTOMER_NAME,
		NULL DEPT_REGION_CODE, REC.TARGET_ORG_CODE ARRV_REGION_CODE,
		REC.CUSTOMER_PICKUP_ORG_CODE CUSTOMER_PICKUP_ORG_NAME,
		REC.GOODS_QTY_TOTAL QTY, REC.GOODS_VOLUME_TOTAL BILLING_VOLUME,
		REC.BILL_WEIGHT BILL_WEIGHT, REC.GOODS_NAME GOODS_NAME,
		REC.DELIVERY_CUSTOMER_CODE DELIVERY_CUSTOMER_CODE,
		REC.DELIVERY_CUSTOMER_NAME DELIVERY_CUSTOMER_NAME,
		REC.RECEIVE_CUSTOMER_CODE RECEIVE_CUSTOMER_CODE,
		REC.RECEIVE_CUSTOMER_NAME RECEIVE_CUSTOMER_NAME, REC.PAYMENT_TYPE
		PAYMENT_TYPE, REC.RECEIVE_METHOD RECEIVE_METHOD,
		REC.PRODUCT_CODE PRODUCT_CODE, REC.INSURANCE_FEE/100 INSURANCE_FEE,
		REC.TRANSPORT_FEE/100 TRANSPORT_FEE,
		REC.PACKAGING_FEE/100 PACKAGING_FEE, REC.delivery_goods_fee/100 DELIVER_FEE,
		REC.COD_FEE/100 COD_FEE,
		REC.OTHER_FEE/100 OTHER_FEE, REC.VALUE_ADD_FEE/100 VALUE_ADD_FEE,
		REC.PROMOTIONS_FEE/100 PROMOTIONS_FEE,
		REC.PICKUP_FEE/100 PICKUP_FEE, NULL IS_DELETE, NULL DISABLE_TIME, REC.BUSINESS_DATE
		BUSINESS_DATE, REC.ACCOUNT_DATE ACCOUNT_DATE,
		REC.CONREVEN_DATE SIGN_DATE, REC.CREATE_TIME CREATE_TIME, REC.NOTES NOTES,
		REC.VERSION_NO VERSION_NO,
		W.UNIT_PRICE/100 UNITPRICE, W.INSURANCE_AMOUNT/100
		INSURANCEAMOUNT,W.DELIVERY_CUSTOMER_CONTACT
		DELIVERYCUSTOMERCONTACT,REC.UNIFIED_SETTLEMENT UNIFIED_SETTLEMENT
		FROM STL.T_STL_BILL_RECEIVABLE REC
		LEFT JOIN PKP.T_SRV_WAYBILL W ON
		W.WAYBILL_NO = REC.WAYBILL_NO AND W.ACTIVE = 'Y' 
	</sql>

	<!-- 按客户查询应收单 -->
	<select id="queryCustomerStatementDByCustomer"
		parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto"
		resultMap="CustomerStatementDResultMap">
		<include refid="Query_Receivable_Column_List"/>
		<where>
			REC.UNVERIFY_AMOUNT > 0
		    AND REC.ACTIVE='Y'
		    <!-- 进入大客户对账单的，应收单类型（不含代收货款）：开单月结、临时欠款、网上支付产生的应收单、出库为月结和临时欠款产生的应收单、小票应收单，到付结转临欠/月结后形成的应收单 -->
		    <!-- 始发应收、小票应收、到达应收(已挂客户的） --> 
		    AND REC.BILL_TYPE IN ('OR','DR','RR')
			AND (REC.STATEMENT_BILL_NO = 'N/A' OR REC.STATEMENT_BILL_NO IS NULL)
			AND REC.DUNNING_ORG_CODE = #{orgCode,jdbcType=VARCHAR}
		  <![CDATA[
		   AND REC.BUSINESS_DATE>=#{periodBeginDate,jdbcType=TIMESTAMP} 
		   AND REC.BUSINESS_DATE<#{periodEndDate,jdbcType=TIMESTAMP}
		  ]]>
			<if test="customerCode!=null and customerCode!='' ">
				AND REC.CUSTOMER_CODE = #{customerCode,jdbcType=VARCHAR}
			</if>
			<!-- 单字符自动转化成数字，所以必须转化成string，否则报NumberFormatException -->
			<if test='receivableUnified == "Y"'>
				AND
				REC.UNIFIED_SETTLEMENT=#{receivableUnified,jdbcType=VARCHAR}
			</if>
			<if test="receivableUnified == 'N'.toString()">
				AND
				(REC.UNIFIED_SETTLEMENT=#{receivableUnified,jdbcType=VARCHAR} OR
				REC.UNIFIED_SETTLEMENT IS NULL)
			</if>
		</where>
	</select>
	<!-- 按客户查询应收单总行数 -->
	<select id="countCustomerStatementDByCustomer"
		parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto"
		resultType="Integer">
		select count(*) FROM STL.T_STL_BILL_RECEIVABLE REC
		LEFT JOIN PKP.T_SRV_WAYBILL W ON
		W.WAYBILL_NO = REC.WAYBILL_NO AND W.ACTIVE = 'Y' 
		<where>
			REC.UNVERIFY_AMOUNT > 0
			AND REC.ACTIVE='Y'
			<!-- 始发应收、小票应收、到达应收(已挂客户的） --> 
		    AND REC.BILL_TYPE IN ('OR','DR','RR')
			AND (REC.STATEMENT_BILL_NO = 'N/A' OR REC.STATEMENT_BILL_NO IS NULL)
			AND REC.DUNNING_ORG_CODE = #{orgCode,jdbcType=VARCHAR}
		  <![CDATA[
		   AND REC.BUSINESS_DATE>=#{periodBeginDate,jdbcType=TIMESTAMP} 
		   AND REC.BUSINESS_DATE<#{periodEndDate,jdbcType=TIMESTAMP}
		  ]]>
			<if test="customerCode!=null and customerCode!='' ">
				AND REC.CUSTOMER_CODE = #{customerCode,jdbcType=VARCHAR}
			</if>
			<!-- 单字符自动转化成数字，所以必须转化成string，否则报NumberFormatException -->
			<!-- 是否统一结算 -->
			<if test='receivableUnified == "Y"'>
				AND
				REC.UNIFIED_SETTLEMENT=#{receivableUnified,jdbcType=VARCHAR}
			</if>
			<if test="receivableUnified == 'N'.toString()">
				AND
				(REC.UNIFIED_SETTLEMENT=#{receivableUnified,jdbcType=VARCHAR} OR
				REC.UNIFIED_SETTLEMENT IS NULL)
			</if>
		</where>
	</select>
	<!-- 按来源单号查询应收单 -->
	<select id="queryCustomerStatementDByNumber" 
	    parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto" 
	    resultMap="CustomerStatementDResultMap">
		<include refid="Query_Receivable_Column_List"/>
		<where>
			REC.UNVERIFY_AMOUNT > 0
			AND REC.ACTIVE='Y'
			<!-- 始发应收、小票应收、到达应收(已挂客户的） --> 
		    AND REC.BILL_TYPE IN ('OR','DR','RR')
			<![CDATA[AND (REC.CUSTOMER_CODE IS NOT NULL OR REC.CUSTOMER_CODE<>'')]]>
			AND (REC.STATEMENT_BILL_NO = 'N/A' OR REC.STATEMENT_BILL_NO IS NULL)
			AND REC.DUNNING_ORG_CODE = #{orgCode,jdbcType=VARCHAR}
			AND REC.SOURCE_BILL_NO IN 
			<foreach collection="numbers" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
			<!-- 单字符自动转化成数字，所以必须转化成string，否则报NumberFormatException -->
			<if test='receivableUnified == "Y"'>
				AND
				REC.UNIFIED_SETTLEMENT=#{receivableUnified,jdbcType=VARCHAR}
			</if>
			<if test="receivableUnified == 'N'.toString()">
				AND
				(REC.UNIFIED_SETTLEMENT=#{receivableUnified,jdbcType=VARCHAR} OR
				REC.UNIFIED_SETTLEMENT IS NULL)
			</if>
		</where>
	</select>
	<!-- 按客户保存对账单明细 -->
	<insert id="customerStatementDSaveByCustomer"
	    parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto">
	    insert into stl.t_stl_statement_of_account_d
		  (ID,
		   STATEMENT_BILL_NO,
		   SOURCE_BILL_NO,
		   WAYBILL_NO,
		   BILL_PARENT_TYPE,
		   BILL_TYPE,
		   AUDIT_STATUS,
		   AMOUNT,
		   VERIFY_AMOUNT,
		   UNVERIFY_AMOUNT,
		   ORG_CODE,
		   ORG_NAME,
		   ORIG_ORG_CODE,
		   ORIG_ORG_NAME,
		   DEST_ORG_CODE,
		   DEST_ORG_NAME,
		   CUSTOMER_CODE,
		   CUSTOMER_NAME,
		   ARRV_REGION_CODE,
		   CUSTOMER_PICKUP_ORG_NAME,
		   QTY,
		   BILLING_VOLUME,
		   BILL_WEIGHT,
		   GOODS_NAME,
		   DELIVERY_CUSTOMER_CODE,
		   DELIVERY_CUSTOMER_NAME,
		   RECEIVE_CUSTOMER_CODE,
		   RECEIVE_CUSTOMER_NAME,
		   PAYMENT_TYPE,
		   RECEIVE_METHOD,
		   PRODUCT_CODE,
		   INSURANCE_FEE,
		   TRANSPORT_FEE,
		   PACKAGING_FEE,
		   DELIVER_FEE,
		   PICKUP_FEE,
		   COD_FEE,
		   OTHER_FEE,
		   VALUE_ADD_FEE,
		   PROMOTIONS_FEE,
		   IS_DELETE,
		   BUSINESS_DATE,
		   ACCOUNT_DATE,
		   SIGN_DATE,
		   CREATE_TIME,
		   ORIG_SOURCE_BILL_NO,
		   UNIT_PRICE,
		   INSURANCE_AMOUNT,
		   DELIVERY_CUSTOMER_CONTACT)
		  SELECT sys_guid() id,
		         #{statementBillNo,jdbcType=VARCHAR} STATEMENT_BILL_NO,
		         REC.RECEIVABLE_NO SOURCE_BILL_NO,
		         REC.Waybill_No WAYBILL_NO,
		         '10.YS' BILL_PARENT_TYPE,
		         REC.BILL_TYPE BILL_TYPE,
		         REC.APPROVE_STATUS AUDIT_STATUS,
		         rec.amount AMOUNT,
		         rec.verify_amount VERIFY_AMOUNT,
		         rec.UNVERIFY_AMOUNT UNVERIFY_AMOUNT,
		         rec.dunning_org_code ORG_CODE,
		         rec.dunning_org_name ORG_NAME,
		         rec.orig_org_code ORIG_ORG_CODE,
		         rec.orig_org_name ORIG_ORG_NAME,
		         rec.dest_org_code DEST_ORG_CODE,
		         rec.dest_org_name DEST_ORG_NAME,
		         rec.customer_code CUSTOMER_CODE,
		         rec.customer_name CUSTOMER_NAME,
		         REC.TARGET_ORG_CODE ARRV_REGION_CODE,
		         REC.CUSTOMER_PICKUP_ORG_CODE CUSTOMER_PICKUP_ORG_NAME,
		         REC.GOODS_QTY_TOTAL QTY,
		         REC.GOODS_VOLUME_TOTAL BILLING_VOLUME,
		         REC.BILL_WEIGHT BILL_WEIGHT,
		         REC.GOODS_NAME GOODS_NAME,
		         REC.DELIVERY_CUSTOMER_CODE DELIVERY_CUSTOMER_CODE,
		         REC.DELIVERY_CUSTOMER_NAME DELIVERY_CUSTOMER_NAME,
		         REC.RECEIVE_CUSTOMER_CODE RECEIVE_CUSTOMER_CODE,
		         REC.RECEIVE_CUSTOMER_NAME RECEIVE_CUSTOMER_NAME,
		         REC.PAYMENT_TYPE PAYMENT_TYPE,
		         REC.RECEIVE_METHOD RECEIVE_METHOD,
		         rec.product_code product_code,
		         REC.INSURANCE_FEE  INSURANCE_FEE,
		         REC.TRANSPORT_FEE  TRANSPORT_FEE,
		         REC.PACKAGING_FEE  PACKAGING_FEE,
		         REC.delivery_goods_fee  DELIVER_FEE,
		         REC.PICKUP_FEE  PICKUP_FEE,
		         REC.COD_FEE  COD_FEE,
		         REC.OTHER_FEE  OTHER_FEE,
		         REC.VALUE_ADD_FEE  VALUE_ADD_FEE,
		         REC.PROMOTIONS_FEE  PROMOTIONS_FEE,
		         'N' IS_DELETE,
		         REC.BUSINESS_DATE BUSINESS_DATE,
		         REC.ACCOUNT_DATE ACCOUNT_DATE,
		         REC.CONREVEN_DATE SIGN_DATE,
		         SYSDATE CREATE_TIME,
		         REC.SOURCE_BILL_NO ORIG_SOURCE_BILL_NO,
		         W.UNIT_PRICE  UNIT_PRICE,
		         W.INSURANCE_AMOUNT  INSURANCE_AMOUNT,
		         W.DELIVERY_CUSTOMER_CONTACT DELIVERY_CUSTOMER_CONTACT
		    FROM STL.T_STL_BILL_RECEIVABLE REC
		    LEFT JOIN PKP.T_SRV_WAYBILL W
		      ON W.WAYBILL_NO = REC.WAYBILL_NO
		     AND W.ACTIVE = 'Y'
		<where>
			REC.UNVERIFY_AMOUNT > 0
			AND REC.ACTIVE='Y'
			<!-- 始发应收、小票应收、到达应收(已挂客户的） --> 
		    AND REC.BILL_TYPE IN ('OR','DR','RR')
			AND (REC.STATEMENT_BILL_NO = 'N/A' OR REC.STATEMENT_BILL_NO IS NULL)
			AND REC.DUNNING_ORG_CODE = #{orgCode,jdbcType=VARCHAR}
		  <![CDATA[
		   AND REC.BUSINESS_DATE>=#{periodBeginDate,jdbcType=TIMESTAMP} 
		   AND REC.BUSINESS_DATE<#{periodEndDate,jdbcType=TIMESTAMP}
		  ]]>
			<if test="customerCode!=null and customerCode!='' ">
				AND REC.CUSTOMER_CODE = #{customerCode,jdbcType=VARCHAR}
			</if>
			<!-- 单字符自动转化成数字，所以必须转化成string，否则报NumberFormatException -->
			<if test='receivableUnified == "Y"'>
				AND
				REC.UNIFIED_SETTLEMENT=#{receivableUnified,jdbcType=VARCHAR}
			</if>
			<if test="receivableUnified == 'N'.toString()">
				AND
				(REC.UNIFIED_SETTLEMENT=#{receivableUnified,jdbcType=VARCHAR} OR
				REC.UNIFIED_SETTLEMENT IS NULL)
			</if>
		</where>
	</insert>
	<!-- 按来源单号保存对账单明细 -->
	<insert id="customerStatementDSaveByNumber" 
	    parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto">
	    insert into stl.t_stl_statement_of_account_d
		  (ID,
		   STATEMENT_BILL_NO,
		   SOURCE_BILL_NO,
		   WAYBILL_NO,
		   BILL_PARENT_TYPE,
		   BILL_TYPE,
		   AUDIT_STATUS,
		   AMOUNT,
		   VERIFY_AMOUNT,
		   UNVERIFY_AMOUNT,
		   ORG_CODE,
		   ORG_NAME,
		   ORIG_ORG_CODE,
		   ORIG_ORG_NAME,
		   DEST_ORG_CODE,
		   DEST_ORG_NAME,
		   CUSTOMER_CODE,
		   CUSTOMER_NAME,
		   ARRV_REGION_CODE,
		   CUSTOMER_PICKUP_ORG_NAME,
		   QTY,
		   BILLING_VOLUME,
		   BILL_WEIGHT,
		   GOODS_NAME,
		   DELIVERY_CUSTOMER_CODE,
		   DELIVERY_CUSTOMER_NAME,
		   RECEIVE_CUSTOMER_CODE,
		   RECEIVE_CUSTOMER_NAME,
		   PAYMENT_TYPE,
		   RECEIVE_METHOD,
		   PRODUCT_CODE,
		   INSURANCE_FEE,
		   TRANSPORT_FEE,
		   PACKAGING_FEE,
		   DELIVER_FEE,
		   PICKUP_FEE,
		   COD_FEE,
		   OTHER_FEE,
		   VALUE_ADD_FEE,
		   PROMOTIONS_FEE,
		   IS_DELETE,
		   BUSINESS_DATE,
		   ACCOUNT_DATE,
		   SIGN_DATE,
		   CREATE_TIME,
		   ORIG_SOURCE_BILL_NO,
		   UNIT_PRICE,
		   INSURANCE_AMOUNT,
		   DELIVERY_CUSTOMER_CONTACT)
		  SELECT sys_guid() id,
		         #{statementBillNo,jdbcType=VARCHAR} STATEMENT_BILL_NO,
		         REC.RECEIVABLE_NO SOURCE_BILL_NO,
		         REC.Waybill_No WAYBILL_NO,
		         '10.YS' BILL_PARENT_TYPE,
		         REC.BILL_TYPE BILL_TYPE,
		         REC.APPROVE_STATUS AUDIT_STATUS,
		         rec.amount AMOUNT,
		         rec.verify_amount VERIFY_AMOUNT,
		         rec.UNVERIFY_AMOUNT UNVERIFY_AMOUNT,
		         rec.dunning_org_code ORG_CODE,
		         rec.dunning_org_name ORG_NAME,
		         rec.orig_org_code ORIG_ORG_CODE,
		         rec.orig_org_name ORIG_ORG_NAME,
		         rec.dest_org_code DEST_ORG_CODE,
		         rec.dest_org_name DEST_ORG_NAME,
		         rec.customer_code CUSTOMER_CODE,
		         rec.customer_name CUSTOMER_NAME,
		         REC.TARGET_ORG_CODE ARRV_REGION_CODE,
		         REC.CUSTOMER_PICKUP_ORG_CODE CUSTOMER_PICKUP_ORG_NAME,
		         REC.GOODS_QTY_TOTAL QTY,
		         REC.GOODS_VOLUME_TOTAL BILLING_VOLUME,
		         REC.BILL_WEIGHT BILL_WEIGHT,
		         REC.GOODS_NAME GOODS_NAME,
		         REC.DELIVERY_CUSTOMER_CODE DELIVERY_CUSTOMER_CODE,
		         REC.DELIVERY_CUSTOMER_NAME DELIVERY_CUSTOMER_NAME,
		         REC.RECEIVE_CUSTOMER_CODE RECEIVE_CUSTOMER_CODE,
		         REC.RECEIVE_CUSTOMER_NAME RECEIVE_CUSTOMER_NAME,
		         REC.PAYMENT_TYPE PAYMENT_TYPE,
		         REC.RECEIVE_METHOD RECEIVE_METHOD,
		         rec.product_code product_code,
		         REC.INSURANCE_FEE  INSURANCE_FEE,
		         REC.TRANSPORT_FEE  TRANSPORT_FEE,
		         REC.PACKAGING_FEE  PACKAGING_FEE,
		         REC.delivery_goods_fee  DELIVER_FEE,
		         REC.PICKUP_FEE  PICKUP_FEE,
		         REC.COD_FEE  COD_FEE,
		         REC.OTHER_FEE  OTHER_FEE,
		         REC.VALUE_ADD_FEE  VALUE_ADD_FEE,
		         REC.PROMOTIONS_FEE  PROMOTIONS_FEE,
		         'N' IS_DELETE,
		         REC.BUSINESS_DATE BUSINESS_DATE,
		         REC.ACCOUNT_DATE ACCOUNT_DATE,
		         REC.CONREVEN_DATE SIGN_DATE,
		         SYSDATE CREATE_TIME,
		         REC.SOURCE_BILL_NO ORIG_SOURCE_BILL_NO,
		         W.UNIT_PRICE  UNIT_PRICE,
		         W.INSURANCE_AMOUNT  INSURANCE_AMOUNT,
		         W.DELIVERY_CUSTOMER_CONTACT DELIVERY_CUSTOMER_CONTACT
		    FROM STL.T_STL_BILL_RECEIVABLE REC
		    LEFT JOIN PKP.T_SRV_WAYBILL W
		      ON W.WAYBILL_NO = REC.WAYBILL_NO
		     AND W.ACTIVE = 'Y'
		<where>
			REC.UNVERIFY_AMOUNT > 0
			AND REC.ACTIVE='Y'
			<!-- 始发应收、小票应收、到达应收(已挂客户的） --> 
		    AND REC.BILL_TYPE IN ('OR','DR','RR')
			<![CDATA[AND (REC.CUSTOMER_CODE IS NOT NULL OR REC.CUSTOMER_CODE<>'')]]>
			AND (REC.STATEMENT_BILL_NO = 'N/A' OR REC.STATEMENT_BILL_NO IS NULL)
			AND REC.DUNNING_ORG_CODE = #{orgCode,jdbcType=VARCHAR}
			AND REC.SOURCE_BILL_NO IN 
			<foreach collection="numbers" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
			<!-- 单字符自动转化成数字，所以必须转化成string，否则报NumberFormatException -->
			<if test='receivableUnified == "Y"'>
				AND
				REC.UNIFIED_SETTLEMENT=#{receivableUnified,jdbcType=VARCHAR}
			</if>
			<if test="receivableUnified == 'N'.toString()">
				AND
				(REC.UNIFIED_SETTLEMENT=#{receivableUnified,jdbcType=VARCHAR} OR
				REC.UNIFIED_SETTLEMENT IS NULL)
			</if>
		</where>
	</insert>
	<!-- 按对账单单号保存对账单 -->
	<insert id="customerStatementSaveByStatementBillNo"
	    parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto">
		INSERT INTO STL.T_STL_STATEMENT_OF_ACCOUNT
		  (ID,
		   STATEMENT_BILL_NO,
		   CREATE_ORG_CODE,
		   CREATE_ORG_NAME,
		   COMPANY_CODE,
		   COMPANY_NAME,
		   UNIFIED_CODE,
		   CUSTOMER_CODE,
		   CUSTOMER_NAME,
		   BILL_TYPE,
		   BEGIN_PERIOD_AMOUNT,
		   BEGIN_PERIOD_REC_AMOUNT,
		   BEGIN_PERIOD_PAY_AMOUNT,
		   BEGIN_PERIOD_PRE_AMOUNT,
		   BEGIN_PERIOD_ADV_AMOUNT,
		   PERIOD_AMOUNT,
		   PERIOD_REC_AMOUNT,
		   PERIOD_PAY_AMOUNT,
		   PERIOD_PRE_AMOUNT,
		   PERIOD_ADV_AMOUNT,
		   PERIOD_UNVERIFY_REC_AMOUNT,
		   PERIOD_UNVERIFY_PAY_AMOUNT,
		   PERIOD_UNVERIFY_PRE_AMOUNT,
		   PERIOD_UNVERIFY_ADV_AMOUNT,
		   PERIOD_BEGIN_DATE,
		   PERIOD_END_DATE,
		   UNPAID_AMOUNT,
		   SETTLE_NUM,
		   CREATE_USER_CODE,
		   CREATE_USER_NAME,
		   BUSINESS_DATE,
		   CREATE_TIME,
		   CONFIRM_STATUS,
		   COMPANY_ACCOUNT_BANK_NO,
		   ACCOUNT_USER_NAME,
		   BANK_BRANCH_NAME,
		   VERSION_NO,
		   CURRENCY_CODE,
		   APPLY_INVOICE,
		   CUSTOMER_TYPE,
		   UNIFIED_SETTLEMENT)
		  SELECT SYS_GUID() ID,
		         SD.STATEMENT_BILL_NO STATEMENT_BILL_NO,
		         #{orgCode,jdbcType=VARCHAR} CREATE_ORG_CODE,
		         #{orgName,jdbcType=VARCHAR} CREATE_ORG_NAME,
		         F.CODE COMPANY_CODE,
		         F.NAME COMPANY_NAME,
		         #{unifiedCode,jdbcType=VARCHAR} UNIFIED_CODE,
		         SD.CUSTOMER_CODE CUSTOMER_CODE,
		         SD.CUSTOMER_NAME CUSTOMER_NAME,
		         'CA' BILL_TYPE,
		         0 BEGIN_PERIOD_AMOUNT,
				 0 BEGIN_PERIOD_REC_AMOUNT,
				 0 BEGIN_PERIOD_PAY_AMOUNT,
				 0 BEGIN_PERIOD_PRE_AMOUNT,
				 0 BEGIN_PERIOD_ADV_AMOUNT,
		         SUM(SD.UNVERIFY_AMOUNT) PERIOD_AMOUNT,
		         SUM(SD.UNVERIFY_AMOUNT) PERIOD_REC_AMOUNT,
		         0 PERIOD_PAY_AMOUNT,
				 0 PERIOD_PRE_AMOUNT,
				 0 PERIOD_ADV_AMOUNT,
		         SUM(SD.UNVERIFY_AMOUNT) PERIOD_UNVERIFY_REC_AMOUNT,
		         0 PERIOD_UNVERIFY_PAY_AMOUNT,
				 0 PERIOD_UNVERIFY_PRE_AMOUNT,
				 0 PERIOD_UNVERIFY_ADV_AMOUNT,
		         MIN(SD.BUSINESS_DATE) PERIOD_BEGIN_DATE,
		         MAX(SD.BUSINESS_DATE) PERIOD_END_DATE,
		         SUM(SD.UNVERIFY_AMOUNT) UNPAID_AMOUNT,
		         0 SETTLE_NUM,
		         #{empCode,jdbcType=VARCHAR} CREATE_USER_CODE,
		         #{empName,jdbcType=VARCHAR} CREATE_USER_NAME,
		         SYSDATE BUSINESS_DATE,
		         SYSDATE CREATE_TIME,
		         'N' CONFIRM_STATUS,
		         #{companyAccountBankNo,jdbcType=VARCHAR} COMPANY_ACCOUNT_BANK_NO,
		         #{accountUserName,jdbcType=VARCHAR} ACCOUNT_USER_NAME,
		         #{bankBranchName,jdbcType=VARCHAR} BANK_BRANCH_NAME,
		         1 VERSION_NO,
		         'RMB' CURRENCY_CODE,
		         'N' APPLY_INVOICE,
		         'LC' CUSTOMER_TYPE,
		         #{receivableUnified,jdbcType=VARCHAR} UNIFIED_SETTLEMENT
		    FROM STL.T_STL_STATEMENT_OF_ACCOUNT_D SD
		   INNER JOIN BSE.T_BAS_ORG O
		      ON O.CODE = SD.ORG_CODE
		      AND O.ACTIVE = 'Y'
		   INNER JOIN BSE.T_BAS_FIN_ORG F
		      ON F.CODE = O.SUBSIDIARY_CODE
		      AND F.ACTIVE = 'Y'
		   WHERE SD.STATEMENT_BILL_NO = #{statementBillNo,jdbcType=VARCHAR}
		     AND SD.IS_DELETE = 'N'
		   GROUP BY SD.STATEMENT_BILL_NO,
		            F.CODE,
		            F.NAME,
		            SD.CUSTOMER_CODE,
		            SD.CUSTOMER_NAME
	</insert>
	
	<!-- 按客户查询对账单 -->
	<select id="queryCustomerStatementByCustomer"
		parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto"
		resultMap="CustomerStatementResultMap">
		select
			<include refid="Customer_Column_List" />
		  from STL.T_STL_STATEMENT_OF_ACCOUNT AC
		<where>
			 AC.CUSTOMER_TYPE = 'LC'
	 	  <![CDATA[AND AC.BUSINESS_DATE>=#{periodBeginDate} AND AC.BUSINESS_DATE<#{periodEndDate}]]>
			<if test="customerCode!=null and customerCode!='' ">
				and AC.CUSTOMER_CODE = #{customerCode,jdbcType=VARCHAR}
			</if>
			<if test="confirmStatus!=null and confirmStatus!=''">
				and AC.CONFIRM_STATUS = #{confirmStatus,jdbcType=VARCHAR}
			</if>
			<if	test="settleStatus!=null and settleStatus!='' and settleStatus==statementSettleStatus">
				and AC.UNPAID_AMOUNT = 0
			</if>
			<if	test="settleStatus!=null and settleStatus!='' and settleStatus==statementUnSettleStatus">
				and AC.UNPAID_AMOUNT !=0
			</if>
			<if test="empCode!=null and empCode!=''">
			AND EXISTS (
			    SELECT 1
             FROM BSE.MV_BAS_USER_ORG_AUTH_VIEW W
            WHERE W.EMP_CODE = #{empCode,jdbcType=VARCHAR}
              AND W.ORG_CODE = AC.CREATE_ORG_CODE)
            </if>
		</where>
	</select>
	
	<select id="countCustomerStatementByCustomer"
		parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto"
		resultType="Integer">
		select count(*)
		  from STL.T_STL_STATEMENT_OF_ACCOUNT AC
		<where>
			 AC.CUSTOMER_TYPE = 'LC'
	 	  <![CDATA[AND AC.BUSINESS_DATE>=#{periodBeginDate} AND AC.BUSINESS_DATE<#{periodEndDate}]]>
			<if test="customerCode!=null and customerCode!='' ">
				and AC.CUSTOMER_CODE = #{customerCode,jdbcType=VARCHAR}
			</if>
			<if test="confirmStatus!=null and confirmStatus!=''">
				and AC.CONFIRM_STATUS = #{confirmStatus,jdbcType=VARCHAR}
			</if>
			<if	test="settleStatus!=null and settleStatus!='' and settleStatus==statementSettleStatus">
				and AC.UNPAID_AMOUNT = 0
			</if>
			<if	test="settleStatus!=null and settleStatus!='' and settleStatus==statementUnSettleStatus">
				and AC.UNPAID_AMOUNT !=0
			</if>
			<if test="empCode!=null and empCode!=''">
			AND EXISTS (
			    SELECT 1
             FROM BSE.MV_BAS_USER_ORG_AUTH_VIEW W
            WHERE W.EMP_CODE = #{empCode,jdbcType=VARCHAR}
              AND W.ORG_CODE = AC.CREATE_ORG_CODE)
            </if>
		</where>
	</select>
	
	<!-- 按对账单号查询对账单 -->
	<select id="queryCustomerStatementByNumber" 
	    parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto" 
	    resultMap="CustomerStatementResultMap">
		select
			<include refid="Customer_Column_List" />
		  from STL.T_STL_STATEMENT_OF_ACCOUNT AC
		 WHERE AC.STATEMENT_BILL_NO IN
		  <foreach collection="numbers" index="index" item="item" open="(" separator="," close=")">
           #{item}
          </foreach>
          AND AC.CUSTOMER_TYPE = 'LC'
          <if test="empCode!=null and empCode!=''">
			AND EXISTS (
			    SELECT 1
             FROM BSE.MV_BAS_USER_ORG_AUTH_VIEW W
            WHERE W.EMP_CODE = #{empCode,jdbcType=VARCHAR}
              AND W.ORG_CODE = AC.CREATE_ORG_CODE)
            </if>
	</select>
	
	<!-- 按对账单单号查询对账单明细 -->
	<select id="queryCustomerDByStatementBillNo" 
	    parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto" 
	    resultMap="CustomerStatementDResultMap">
	    SELECT 
	    	<include refid="CustomerD_Column_List" />
	      FROM STL.T_STL_STATEMENT_OF_ACCOUNT_D D
	     WHERE D.STATEMENT_BILL_NO = #{statementBillNo,jdbcType=VARCHAR}
	       AND D.IS_DELETE = 'N'
	</select>
	
	<!-- 按对账单单号查询对账单明细总条数 -->
	<select id="countCustomerDByStatementBillNo" 
	    parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto" 
	    resultType="Integer">
	    SELECT COUNT(*) COUNT
	      FROM STL.T_STL_STATEMENT_OF_ACCOUNT_D D
	     WHERE D.STATEMENT_BILL_NO = #{statementBillNo,jdbcType=VARCHAR}
	       AND D.IS_DELETE = 'N'
	</select>
	
	<!-- 按对账单单号查询核销单 -->
	<select id="queryWriteoffBillByStatementBillNo" parameterType="String" resultType="Integer">
	    SELECT COUNT(W.ID) COUNT
		  FROM STL.T_STL_BILL_WRITEOFF W
		 WHERE W.STATEMENT_BILL_NO = #{statementBillNo,jdbcType=VARCHAR}
		   AND W.ACTIVE = 'Y'
	</select>
	
	<!-- 确认或反确认对账单 -->
	<update id="confirmOrUnConfirmStatement" 
	    parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto">
	    UPDATE STL.T_STL_STATEMENT_OF_ACCOUNT A
		   SET A.MODIFY_USER_CODE  = #{empCode,jdbcType=VARCHAR},
		       A.MODIFY_USER_NAME  = #{empName,jdbcType=VARCHAR},
		       A.MODIFY_TIME       = SYSDATE,
		       A.CONFIRM_USER_CODE = #{confirmUserCode,jdbcType=VARCHAR},
		       A.CONFIRM_USER_NAME = #{confirmUserName,jdbcType=VARCHAR},
		       A.CONFIRM_TIME      = #{confirmTime,jdbcType=TIMESTAMP},
		       A.CONFIRM_STATUS    = #{confirmStatus,jdbcType=VARCHAR},
		       A.VERSION_NO        = A.VERSION_NO + 1
		 WHERE A.STATEMENT_BILL_NO = #{statementBillNo,jdbcType=VARCHAR}
	</update>
	
	<!-- 更新应收单 -->
	<update id="customerRecUpdateByStatementBillNo"
	    parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto">
		UPDATE STL.T_STL_BILL_RECEIVABLE R
		   SET R.STATEMENT_BILL_NO = #{statementBillNo,jdbcType=VARCHAR},
		       R.MODIFY_TIME       = SYSDATE,
		       R.MODIFY_USER_CODE  = #{empCode,jdbcType=VARCHAR},
		       R.MODIFY_USER_NAME  = #{empName,jdbcType=VARCHAR},
		       R.VERSION_NO        = R.VERSION_NO + 1
		 WHERE R.ACTIVE = 'Y'
		 <!-- 始发应收、小票应收、到达应收(已挂客户的) --> 
		   AND R.BILL_TYPE IN ('OR','DR','RR')
		   AND (R.STATEMENT_BILL_NO = 'N/A' OR R.STATEMENT_BILL_NO IS NULL)
		   AND R.RECEIVABLE_NO IN (SELECT D.SOURCE_BILL_NO
		                            FROM STL.T_STL_STATEMENT_OF_ACCOUNT_D D
		                           WHERE D.STATEMENT_BILL_NO = #{statementBillNo,jdbcType=VARCHAR}
		                             AND D.IS_DELETE = 'N'
		                             AND D.BILL_PARENT_TYPE = '10.YS')
	</update>
	
    <!-- 更新对账单 -->
	<update id="customerStatementUpdateByStatementBillNo"
	    parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto">
	    UPDATE STL.T_STL_STATEMENT_OF_ACCOUNT W
		   SET W.PERIOD_AMOUNT    = #{periodAmount,jdbcType=DECIMAL} * 100,
		       W.UNPAID_AMOUNT    = #{unpaidAmount,jdbcType=DECIMAL} * 100,
		       W.MODIFY_USER_CODE = #{empCode,jdbcType=VARCHAR},
		       W.MODIFY_USER_NAME = #{empName,jdbcType=VARCHAR},
		       W.MODIFY_TIME      = SYSDATE,
		       W.VERSION_NO       = W.VERSION_NO + 1
		 WHERE W.STATEMENT_BILL_NO = #{statementBillNo,jdbcType=VARCHAR}
	</update>
	
	<!-- 查询删除对账单明细 -->
	<select id="queryDelCustomerStatementD" 
	    parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto" 
	    resultMap="CustomerStatementDResultMap">
	    SELECT 
	    	<include refid="CustomerD_Column_List" />
	      FROM STL.T_STL_STATEMENT_OF_ACCOUNT_D D
	     WHERE D.STATEMENT_BILL_NO = #{statementBillNo,jdbcType=VARCHAR}  
	       AND D.IS_DELETE = 'N'
	      AND D.SOURCE_BILL_NO IN (SELECT REC.RECEIVABLE_NO 
                                     FROM STL.T_STL_BILL_RECEIVABLE REC 
                                     <!-- 这里的来源单号是运单号 -->
                                    WHERE REC.ACTIVE = 'Y'
                                    AND REC.SOURCE_BILL_NO IN 
                            <foreach collection="numbers" index="index" item="item" open="(" separator="," close=")">
	                            #{item}
	                        </foreach>)            
	</select>
	
	<!-- 根据应收单号插入对账单明细 -->
	<insert id="addCustomerStatementDByNumber"
	 parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto">
	    insert into stl.t_stl_statement_of_account_d
		  (ID,
		   STATEMENT_BILL_NO,
		   SOURCE_BILL_NO,
		   WAYBILL_NO,
		   BILL_PARENT_TYPE,
		   BILL_TYPE,
		   AUDIT_STATUS,
		   AMOUNT,
		   VERIFY_AMOUNT,
		   UNVERIFY_AMOUNT,
		   ORG_CODE,
		   ORG_NAME,
		   ORIG_ORG_CODE,
		   ORIG_ORG_NAME,
		   DEST_ORG_CODE,
		   DEST_ORG_NAME,
		   CUSTOMER_CODE,
		   CUSTOMER_NAME,
		   ARRV_REGION_CODE,
		   CUSTOMER_PICKUP_ORG_NAME,
		   QTY,
		   BILLING_VOLUME,
		   BILL_WEIGHT,
		   GOODS_NAME,
		   DELIVERY_CUSTOMER_CODE,
		   DELIVERY_CUSTOMER_NAME,
		   RECEIVE_CUSTOMER_CODE,
		   RECEIVE_CUSTOMER_NAME,
		   PAYMENT_TYPE,
		   RECEIVE_METHOD,
		   PRODUCT_CODE,
		   INSURANCE_FEE,
		   TRANSPORT_FEE,
		   PACKAGING_FEE,
		   DELIVER_FEE,
		   PICKUP_FEE,
		   COD_FEE,
		   OTHER_FEE,
		   VALUE_ADD_FEE,
		   PROMOTIONS_FEE,
		   IS_DELETE,
		   BUSINESS_DATE,
		   ACCOUNT_DATE,
		   SIGN_DATE,
		   CREATE_TIME,
		   ORIG_SOURCE_BILL_NO,
		   UNIT_PRICE,
		   INSURANCE_AMOUNT,
		   DELIVERY_CUSTOMER_CONTACT)
		  SELECT sys_guid() id,
		         #{statementBillNo,jdbcType=VARCHAR} STATEMENT_BILL_NO,
		         REC.RECEIVABLE_NO SOURCE_BILL_NO,
		         REC.Waybill_No WAYBILL_NO,
		         '10.YS' BILL_PARENT_TYPE,
		         REC.BILL_TYPE BILL_TYPE,
		         REC.APPROVE_STATUS AUDIT_STATUS,
		         rec.amount AMOUNT,
		         rec.verify_amount VERIFY_AMOUNT,
		         rec.UNVERIFY_AMOUNT UNVERIFY_AMOUNT,
		         rec.dunning_org_code ORG_CODE,
		         rec.dunning_org_name ORG_NAME,
		         rec.orig_org_code ORIG_ORG_CODE,
		         rec.orig_org_name ORIG_ORG_NAME,
		         rec.dest_org_code DEST_ORG_CODE,
		         rec.dest_org_name DEST_ORG_NAME,
		         rec.customer_code CUSTOMER_CODE,
		         rec.customer_name CUSTOMER_NAME,
		         REC.TARGET_ORG_CODE ARRV_REGION_CODE,
		         REC.CUSTOMER_PICKUP_ORG_CODE CUSTOMER_PICKUP_ORG_NAME,
		         REC.GOODS_QTY_TOTAL QTY,
		         REC.GOODS_VOLUME_TOTAL BILLING_VOLUME,
		         REC.BILL_WEIGHT BILL_WEIGHT,
		         REC.GOODS_NAME GOODS_NAME,
		         REC.DELIVERY_CUSTOMER_CODE DELIVERY_CUSTOMER_CODE,
		         REC.DELIVERY_CUSTOMER_NAME DELIVERY_CUSTOMER_NAME,
		         REC.RECEIVE_CUSTOMER_CODE RECEIVE_CUSTOMER_CODE,
		         REC.RECEIVE_CUSTOMER_NAME RECEIVE_CUSTOMER_NAME,
		         REC.PAYMENT_TYPE PAYMENT_TYPE,
		         REC.RECEIVE_METHOD RECEIVE_METHOD,
		         rec.product_code product_code,
		         REC.INSURANCE_FEE  INSURANCE_FEE,
		         REC.TRANSPORT_FEE  TRANSPORT_FEE,
		         REC.PACKAGING_FEE  PACKAGING_FEE,
		         REC.delivery_goods_fee  DELIVER_FEE,
		         REC.PICKUP_FEE  PICKUP_FEE,
		         REC.COD_FEE  COD_FEE,
		         REC.OTHER_FEE  OTHER_FEE,
		         REC.VALUE_ADD_FEE  VALUE_ADD_FEE,
		         REC.PROMOTIONS_FEE  PROMOTIONS_FEE,
		         'N' IS_DELETE,
		         REC.BUSINESS_DATE BUSINESS_DATE,
		         REC.ACCOUNT_DATE ACCOUNT_DATE,
		         REC.CONREVEN_DATE SIGN_DATE,
		         SYSDATE CREATE_TIME,
		         REC.SOURCE_BILL_NO ORIG_SOURCE_BILL_NO,
		         W.UNIT_PRICE  UNIT_PRICE,
		         W.INSURANCE_AMOUNT  INSURANCE_AMOUNT,
		         W.DELIVERY_CUSTOMER_CONTACT DELIVERY_CUSTOMER_CONTACT
		    FROM STL.T_STL_BILL_RECEIVABLE REC
		    LEFT JOIN PKP.T_SRV_WAYBILL W
		      ON W.WAYBILL_NO = REC.WAYBILL_NO
		     AND W.ACTIVE = 'Y'
		<where>
			REC.UNVERIFY_AMOUNT > 0
			AND REC.ACTIVE='Y'
			<!-- 始发应收、小票应收、到达应收(已挂客户的） --> 
		    AND REC.BILL_TYPE IN ('OR','DR','RR')
			<![CDATA[AND (REC.CUSTOMER_CODE IS NOT NULL OR REC.CUSTOMER_CODE<>'')]]>
			AND (REC.STATEMENT_BILL_NO = 'N/A' OR REC.STATEMENT_BILL_NO IS NULL)
			AND REC.DUNNING_ORG_CODE = #{orgCode,jdbcType=VARCHAR}
			AND REC.RECEIVABLE_NO IN 
            <foreach collection="numbers" index="index" item="item" open="(" separator="," close=")">
	             #{item}
	        </foreach>                
			<!-- 单字符自动转化成数字，所以必须转化成string，否则报NumberFormatException -->
			<if test='receivableUnified == "Y"'>
				AND
				REC.UNIFIED_SETTLEMENT=#{receivableUnified,jdbcType=VARCHAR}
			</if>
			<if test="receivableUnified == 'N'.toString()">
				AND
				(REC.UNIFIED_SETTLEMENT=#{receivableUnified,jdbcType=VARCHAR} OR
				REC.UNIFIED_SETTLEMENT IS NULL)
			</if>
		</where>
	</insert>
	
	<!-- 按对账单单号更新应收单 -->
	<update id="updateRecStatementBillNo"
	    parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto">
		UPDATE STL.T_STL_BILL_RECEIVABLE R
		   SET R.STATEMENT_BILL_NO = 'N/A',
		       R.MODIFY_TIME       = SYSDATE,
		       R.MODIFY_USER_CODE  = #{empCode,jdbcType=VARCHAR},
		       R.MODIFY_USER_NAME  = #{empName,jdbcType=VARCHAR},
		       R.VERSION_NO        = R.VERSION_NO + 1
		 WHERE R.ACTIVE = 'Y'
		   AND R.STATEMENT_BILL_NO = #{statementBillNo,jdbcType=VARCHAR}
		   <if test="numbers!=null and numbers.size>0">
		   AND R.RECEIVABLE_NO IN 
		    <foreach collection="numbers" index="index" item="item" open="(" separator="," close=")">
	         #{item}
	        </foreach>
	       </if>
	</update>
	
	<!-- 按单号删除对账单明细 -->
	<update id="delCustomerStatementD"
	    parameterType="com.deppon.foss.module.settlement.writeoff.api.shared.dto.CustomerStatementDto">
	    UPDATE STL.T_STL_STATEMENT_OF_ACCOUNT_D AD
           SET AD.IS_DELETE = 'Y', AD.DISABLE_TIME = SYSDATE
         WHERE AD.STATEMENT_BILL_NO = #{statementBillNo,jdbcType=VARCHAR}
           AND AD.IS_DELETE = 'N'
            <if test="numbers!=null and numbers.size>0">
            <!-- 这里的来源单号是应收单号 -->
           AND AD.SOURCE_BILL_NO IN 
               <foreach collection="numbers" index="index" item="item" open="(" separator="," close=")">
	               #{item}
	           </foreach>             
	        </if>
	</update>
</mapper>